{"version":3,"file":"select-context.service.js","sourceRoot":"","sources":["../../../../../../../libs/select-context-widget-ang/src/lib/select-context-widget/services/select-context.service.ts"],"names":[],"mappings":"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","sourcesContent":["import { Injectable } from '@angular/core';\nimport { HttpResponse, HttpErrorResponse } from '@angular/common/http';\nimport {\n  UserContextHttpService,\n  ServiceAgreementHttpService,\n  Serviceagreementpartialitem as ServiceAgreement,\n  GetUserContextServiceAgreementsRequestParams as RequestParams,\n} from '@backbase/data-ang/accesscontrol';\nimport { Observable, BehaviorSubject, of, combineLatest } from 'rxjs';\nimport { switchMap, catchError, map, tap, scan } from 'rxjs/operators';\n\nimport { parseError, SelectContextError } from '../select-context-error';\nimport { SelectContextWidgetPropertiesService, WidgetProperties } from './select-context-widget-properties.service';\n\nexport {\n  Serviceagreementpartialitem as ServiceAgreement,\n  GetUserContextServiceAgreementsRequestParams as RequestParams,\n} from '@backbase/data-ang/accesscontrol';\n\nconst initialParams: RequestParams = {\n  from: 0,\n  size: 7,\n};\n\nexport interface Data {\n  items: ServiceAgreement[];\n  totalCount: number;\n  params: RequestParams;\n}\n\n@Injectable()\nexport class SelectContextService {\n  constructor(\n    private readonly userContextService: UserContextHttpService,\n    private readonly serviceAgreementService: ServiceAgreementHttpService,\n    private readonly widgetPropertiesService: SelectContextWidgetPropertiesService,\n  ) {}\n\n  readonly params = new BehaviorSubject<RequestParams>(initialParams);\n  readonly loading = new BehaviorSubject<boolean>(true);\n  readonly error = new BehaviorSubject<SelectContextError | undefined>(undefined);\n\n  readonly serviceAgreements: Observable<Data> = combineLatest([\n    this.params,\n    this.widgetPropertiesService.properties,\n  ]).pipe(\n    map(([params, { pageSize }]: [RequestParams, WidgetProperties]): RequestParams => ({ ...params, size: pageSize })),\n    tap(() => this.loading.next(true)),\n    switchMap((params: RequestParams) => this.loadServiceAgreements(params)),\n    scan((acc: Data, curr: Data) => this.mergeResults(acc, curr)),\n    catchError((error: SelectContextError) => {\n      this.error.next(error);\n      return of({ items: [], totalCount: 0, params: this.params.value });\n    }),\n    tap(() => this.loading.next(false)),\n  );\n\n  readonly currentContext: Observable<ServiceAgreement | undefined> = this.serviceAgreementService\n    .getServiceAgreementContext()\n    .pipe(catchError(() => of(undefined)));\n\n  private loadServiceAgreements(params: RequestParams): Observable<Data> {\n    return this.userContextService.getUserContextServiceAgreements(params, 'response').pipe(\n      map((response: HttpResponse<ServiceAgreement[]>) => {\n        const items = response.body || [];\n        return {\n          items,\n          totalCount: parseInt(response.headers.get('x-total-count') || '0', 10) || items.length,\n          params,\n        };\n      }),\n      catchError((error: HttpErrorResponse) => {\n        throw parseError(error);\n      }),\n    );\n  }\n\n  private mergeResults(acc: Data, curr: Data): Data {\n    return {\n      totalCount: curr.totalCount || curr.items.length,\n      items: curr.params.from === 0 ? curr.items : [...acc.items, ...curr.items],\n      params: curr.params,\n    };\n  }\n\n  search(query: string) {\n    this.params.next({\n      from: 0,\n      size: this.params.value.size,\n      ...(query ? { query } : {}),\n    });\n  }\n\n  loadMore() {\n    this.params.next({\n      ...this.params.value,\n      from: (this.params.value.from || 0) + 1,\n    });\n  }\n\n  select(serviceAgreement: ServiceAgreement) {\n    return this.userContextService.postUserContext({\n      userContextPOST: {\n        serviceAgreementId: serviceAgreement.id,\n      },\n    });\n  }\n}\n"]}