import { Injectable, InjectionToken } from '@angular/core';
import { CommunicationDefinition, serializerDeserializer } from '@backbase/communication-property';
import { ReplaySubject } from 'rxjs';
import { concatMap, filter, first, map } from 'rxjs/operators';
import { ӨRootContainerService } from '../../../models/root-container.service';
import { ӨItemNavigationService } from '../../item-navigation.service';
import { createPipelineProcessorConfig } from '../pipeline-registry';
import { asyncScheduler } from 'rxjs';
import * as i0 from "@angular/core";
const TAG = 'memory';
/**
 * @deprecated Will be removed in v7.0.0
 * Memory Communication Transport
 *
 * Can be used to configure communication using Memory.
 *
 * @usageNotes
 *
 * Pass some data to widget-b via an in memory store
 *
 * ```json
 * {
 *   "name": "widget-a",
 *   "properties": {
 *     "output.myOutput": Memory.toProperty("myGroupName")
 *   }
 * },
 * {
 *   "name": "widget-b",
 *   "properties": {
 *     "input.myInput": Memory.toProperty("myGroupName")
 *   }
 * }
 * ```
 */
export class Memory {
    /**
     * Generate a serialized communication configuration suitable for use as a Widget Input or Output property value.
     *
     * @param group The name of the communication group to which the Input/Output belongs
     */
    static toProperty(group) {
        return serializerDeserializer.toProperty(new CommunicationDefinition(TAG, group));
    }
}
/**
 * @deprecated Will be removed in v7.0.0
 * Storage service to retain the values for each communication group that is using the Memory transport
 */
export class MemoryStorageService {
    constructor() {
        this.storage = new Map();
    }
    getSubject(group) {
        if (!this.storage.has(group)) {
            this.storage.set(group, new ReplaySubject(1));
        } // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
        return this.storage.get(group);
    }
    /**
     * Get an Observable of the values being communicated to the given group
     *
     * @param group The name of the communication group
     */
    get(group) {
        return this.getSubject(group)
            .asObservable()
            .pipe(map(item => {
            const localValue = item.value;
            if (typeof item.value === 'object' && item.value['_clearPayload'] === true) {
                item.value = undefined;
            }
            return localValue;
        }));
    }
    /**
     * Communicate some value to members of the given communication group
     *
     * @param group The name of the communication group
     * @param value The value to communicate
     */
    set(group, value) {
        this.getSubject(group).next({ value });
    }
}
MemoryStorageService.ɵprov = i0.ɵɵdefineInjectable({ factory: function MemoryStorageService_Factory() { return new MemoryStorageService(); }, token: MemoryStorageService, providedIn: "root" });
MemoryStorageService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root',
            },] }
];
export const createMemory = (itemNavigation, rootModel, storage) => {
    return {
        source: (group) => () => storage.get(group),
        sink: (group) => (stdin) => {
            const commonAncestorItem = getItemFormCommunicationGroup(group, rootModel);
            return stdin
                .pipe(concatMap(data => commonAncestorItem.pipe(map(item => [data, item.name]))))
                .subscribe(([data, name]) => {
                asyncScheduler.schedule(() => {
                    storage.set(group, data);
                });
                itemNavigation.navigateToItem(name, {});
            });
        },
    };
};
/**
 * @deprecated Will be removed in v7.0.0
 */
export const memoryProcessorConfig = createPipelineProcessorConfig(TAG, {
    provide: new InjectionToken('Memory pipeline handler'),
    useFactory: createMemory,
    deps: [ӨItemNavigationService, ӨRootContainerService, MemoryStorageService],
});
function getItemFormCommunicationGroup(group, rootModel) {
    const communicationDefinition = new CommunicationDefinition(TAG, group);
    const commonAncestorItem = rootModel.commonAncestor(communicationDefinition).pipe(first(), filter((item) => {
        if (item === undefined) {
            console.warn(`No Inputs configured to receive in memory value for communication group "${group}"`);
            return false;
        }
        return true;
    }));
    return commonAncestorItem;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVtb3J5LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvYmFja2Jhc2UvZm91bmRhdGlvbi1hbmcvY29yZS9zcmMvYmFja2Jhc2UtY29yZS9jb21tdW5pY2F0aW9uL3BpcGVzL2hhbmRsZXJzL21lbW9yeS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLGNBQWMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzRCxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSxrQ0FBa0MsQ0FBQztBQUNuRyxPQUFPLEVBQWMsYUFBYSxFQUFXLE1BQU0sTUFBTSxDQUFDO0FBQzFELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMvRCxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSx3Q0FBd0MsQ0FBQztBQUUvRSxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUV2RSxPQUFPLEVBQUUsNkJBQTZCLEVBQTJCLE1BQU0sc0JBQXNCLENBQUM7QUFDOUYsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLE1BQU0sQ0FBQzs7QUF3QnRDLE1BQU0sR0FBRyxHQUFhLFFBQVEsQ0FBQztBQUUvQjs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBd0JHO0FBQ0gsTUFBTSxPQUFPLE1BQU07SUFDakI7Ozs7T0FJRztJQUNILE1BQU0sQ0FBQyxVQUFVLENBQUMsS0FBYTtRQUM3QixPQUFPLHNCQUFzQixDQUFDLFVBQVUsQ0FBQyxJQUFJLHVCQUF1QixDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDO0lBQ3BGLENBQUM7Q0FDRjtBQUVEOzs7R0FHRztBQUlILE1BQU0sT0FBTyxvQkFBb0I7SUFIakM7UUFJbUIsWUFBTyxHQUFHLElBQUksR0FBRyxF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LEdBQUcsSUFBSSx1QkFBdUIsQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDeEUsTUFBTSxrQkFBa0IsR0FBRyxTQUFTLENBQUMsY0FBYyxDQUFDLHVCQUF1QixDQUFDLENBQUMsSUFBSSxDQUMvRSxLQUFLLEVBQUUsRUFDUCxNQUFNLENBQUMsQ0FBQyxJQUFJLEVBQXFCLEVBQUU7UUFDakMsSUFBSSxJQUFJLEtBQUssU0FBUyxFQUFFO1lBQ3RCLE9BQU8sQ0FBQyxJQUFJLENBQUMsNEVBQTRFLEtBQUssR0FBRyxDQUFDLENBQUM7WUFDbkcsT0FBTyxLQUFLLENBQUM7U0FDZDtRQUNELE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQyxDQUFDLENBQ0gsQ0FBQztJQUNGLE9BQU8sa0JBQWtCLENBQUM7QUFDNUIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEluamVjdGlvblRva2VuIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBDb21tdW5pY2F0aW9uRGVmaW5pdGlvbiwgc2VyaWFsaXplckRlc2VyaWFsaXplciB9IGZyb20gJ0BiYWNrYmFzZS9jb21tdW5pY2F0aW9uLXByb3BlcnR5JztcbmltcG9ydCB7IE9ic2VydmFibGUsIFJlcGxheVN1YmplY3QsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGNvbmNhdE1hcCwgZmlsdGVyLCBmaXJzdCwgbWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsg06hSb290Q29udGFpbmVyU2VydmljZSB9IGZyb20gJy4uLy4uLy4uL21vZGVscy9yb290LWNvbnRhaW5lci5zZXJ2aWNlJztcbmltcG9ydCB7IEl0ZW1Nb2RlbCB9IGZyb20gJy4uLy4uLy4uL21vZGVscy9pdGVtLW1vZGVsJztcbmltcG9ydCB7INOoSXRlbU5hdmlnYXRpb25TZXJ2aWNlIH0gZnJvbSAnLi4vLi4vaXRlbS1uYXZpZ2F0aW9uLnNlcnZpY2UnO1xuaW1wb3J0IHsgUGlwZWxpbmVTaW5rLCBQaXBlbGluZVNvdXJjZSwgU2luaywgU291cmNlIH0gZnJvbSAnLi4vcGlwZWxpbmUtaW50ZXJmYWNlJztcbmltcG9ydCB7IGNyZWF0ZVBpcGVsaW5lUHJvY2Vzc29yQ29uZmlnLCBQaXBlbGluZVByb2Nlc3NvckNvbmZpZyB9IGZyb20gJy4uL3BpcGVsaW5lLXJlZ2lzdHJ5JztcbmltcG9ydCB7IGFzeW5jU2NoZWR1bGVyIH0gZnJvbSAncnhqcyc7XG5cbi8qKlxuICogQGRlcHJlY2F0ZWQgV2lsbCBiZSByZW1vdmVkIGluIHY3LjAuMFxuICogVXNlIGEgc2VydmljZSB0byBzdG9yZSBkYXRhIGFuZCBwYXNzIGl0IGJldHdlZW4gd2lkZ2V0cy5cbiAqXG4gKiBgYGBcbiAqIFsgQ29tcG9uZW50IE91dHB1dCBdIC0+IFsgTWVtb3J5IFN0b3JlIF1cbiAqIFsgTWVtb3J5IFN0b3JlIF0gLT4gWyBDb21wb25lbnQgSW5wdXQgXVxuICogYGBgXG4gKlxuICogU2VlIGBNZW1vcnlgIGZvciBjb25maWd1cmF0aW9uLlxuICovXG5leHBvcnQgaW50ZXJmYWNlIE1lbW9yeVN0b3JlPFQ+IGV4dGVuZHMgUGlwZWxpbmVTb3VyY2U8VCB8IHVuZGVmaW5lZD4sIFBpcGVsaW5lU2luazxUPiB7XG4gIC8qKlxuICAgKiBAcGFyYW0gZ3JvdXAgVGhlIG5hbWUgY29tbXVuaWNhdGlvbiBncm91cCB0byBjb25uZWN0IHZpYSB0aGUgc3RvcmVcbiAgICovXG4gIHNvdXJjZTogKGdyb3VwOiBzdHJpbmcpID0+IFNvdXJjZTxUIHwgdW5kZWZpbmVkPjtcbiAgLyoqXG4gICAqIEBwYXJhbSBncm91cCBUaGUgbmFtZSBjb21tdW5pY2F0aW9uIGdyb3VwIHRvIGNvbm5lY3QgdmlhIHRoZSBzdG9yZVxuICAgKi9cbiAgc2luazogKGdyb3VwOiBzdHJpbmcpID0+IFNpbms8VD47XG59XG5cbmNvbnN0IFRBRzogJ21lbW9yeScgPSAnbWVtb3J5JztcblxuLyoqXG4gKiBAZGVwcmVjYXRlZCBXaWxsIGJlIHJlbW92ZWQgaW4gdjcuMC4wXG4gKiBNZW1vcnkgQ29tbXVuaWNhdGlvbiBUcmFuc3BvcnRcbiAqXG4gKiBDYW4gYmUgdXNlZCB0byBjb25maWd1cmUgY29tbXVuaWNhdGlvbiB1c2luZyBNZW1vcnkuXG4gKlxuICogQHVzYWdlTm90ZXNcbiAqXG4gKiBQYXNzIHNvbWUgZGF0YSB0byB3aWRnZXQtYiB2aWEgYW4gaW4gbWVtb3J5IHN0b3JlXG4gKlxuICogYGBganNvblxuICoge1xuICogICBcIm5hbWVcIjogXCJ3aWRnZXQtYVwiLFxuICogICBcInByb3BlcnRpZXNcIjoge1xuICogICAgIFwib3V0cHV0Lm15T3V0cHV0XCI6IE1lbW9yeS50b1Byb3BlcnR5KFwibXlHcm91cE5hbWVcIilcbiAqICAgfVxuICogfSxcbiAqIHtcbiAqICAgXCJuYW1lXCI6IFwid2lkZ2V0LWJcIixcbiAqICAgXCJwcm9wZXJ0aWVzXCI6IHtcbiAqICAgICBcImlucHV0Lm15SW5wdXRcIjogTWVtb3J5LnRvUHJvcGVydHkoXCJteUdyb3VwTmFtZVwiKVxuICogICB9XG4gKiB9XG4gKiBgYGBcbiAqL1xuZXhwb3J0IGNsYXNzIE1lbW9yeSB7XG4gIC8qKlxuICAgKiBHZW5lcmF0ZSBhIHNlcmlhbGl6ZWQgY29tbXVuaWNhdGlvbiBjb25maWd1cmF0aW9uIHN1aXRhYmxlIGZvciB1c2UgYXMgYSBXaWRnZXQgSW5wdXQgb3IgT3V0cHV0IHByb3BlcnR5IHZhbHVlLlxuICAgKlxuICAgKiBAcGFyYW0gZ3JvdXAgVGhlIG5hbWUgb2YgdGhlIGNvbW11bmljYXRpb24gZ3JvdXAgdG8gd2hpY2ggdGhlIElucHV0L091dHB1dCBiZWxvbmdzXG4gICAqL1xuICBzdGF0aWMgdG9Qcm9wZXJ0eShncm91cDogc3RyaW5nKTogc3RyaW5nIHtcbiAgICByZXR1cm4gc2VyaWFsaXplckRlc2VyaWFsaXplci50b1Byb3BlcnR5KG5ldyBDb21tdW5pY2F0aW9uRGVmaW5pdGlvbihUQUcsIGdyb3VwKSk7XG4gIH1cbn1cblxuLyoqXG4gKiBAZGVwcmVjYXRlZCBXaWxsIGJlIHJlbW92ZWQgaW4gdjcuMC4wXG4gKiBTdG9yYWdlIHNlcnZpY2UgdG8gcmV0YWluIHRoZSB2YWx1ZXMgZm9yIGVhY2ggY29tbXVuaWNhdGlvbiBncm91cCB0aGF0IGlzIHVzaW5nIHRoZSBNZW1vcnkgdHJhbnNwb3J0XG4gKi9cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnLFxufSlcbmV4cG9ydCBjbGFzcyBNZW1vcnlTdG9yYWdlU2VydmljZSB7XG4gIHByaXZhdGUgcmVhZG9ubHkgc3RvcmFnZSA9IG5ldyBNYXA8XG4gICAgc3RyaW5nLFxuICAgIFN1YmplY3Q8e1xuICAgICAgdmFsdWU6IGFueTtcbiAgICB9PlxuICA+KCk7XG4gIHByaXZhdGUgZ2V0U3ViamVjdChncm91cDogc3RyaW5nKSB7XG4gICAgaWYgKCF0aGlzLnN0b3JhZ2UuaGFzKGdyb3VwKSkge1xuICAgICAgdGhpcy5zdG9yYWdlLnNldChncm91cCwgbmV3IFJlcGxheVN1YmplY3QoMSkpO1xuICAgIH0gLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1ub24tbnVsbC1hc3NlcnRpb25cbiAgICByZXR1cm4gdGhpcy5zdG9yYWdlLmdldChncm91cCkhO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBhbiBPYnNlcnZhYmxlIG9mIHRoZSB2YWx1ZXMgYmVpbmcgY29tbXVuaWNhdGVkIHRvIHRoZSBnaXZlbiBncm91cFxuICAgKlxuICAgKiBAcGFyYW0gZ3JvdXAgVGhlIG5hbWUgb2YgdGhlIGNvbW11bmljYXRpb24gZ3JvdXBcbiAgICovXG4gIGdldDxUPihncm91cDogc3RyaW5nKTogT2JzZXJ2YWJsZTxUPiB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0U3ViamVjdChncm91cClcbiAgICAgIC5hc09ic2VydmFibGUoKVxuICAgICAgLnBpcGUoXG4gICAgICAgIG1hcChpdGVtID0+IHtcbiAgICAgICAgICBjb25zdCBsb2NhbFZhbHVlID0gaXRlbS52YWx1ZTtcbiAgICAgICAgICBpZiAodHlwZW9mIGl0ZW0udmFsdWUgPT09ICdvYmplY3QnICYmIGl0ZW0udmFsdWVbJ19jbGVhclBheWxvYWQnXSA9PT0gdHJ1ZSkge1xuICAgICAgICAgICAgaXRlbS52YWx1ZSA9IHVuZGVmaW5lZDtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIGxvY2FsVmFsdWU7XG4gICAgICAgIH0pLFxuICAgICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDb21tdW5pY2F0ZSBzb21lIHZhbHVlIHRvIG1lbWJlcnMgb2YgdGhlIGdpdmVuIGNvbW11bmljYXRpb24gZ3JvdXBcbiAgICpcbiAgICogQHBhcmFtIGdyb3VwIFRoZSBuYW1lIG9mIHRoZSBjb21tdW5pY2F0aW9uIGdyb3VwXG4gICAqIEBwYXJhbSB2YWx1ZSBUaGUgdmFsdWUgdG8gY29tbXVuaWNhdGVcbiAgICovXG4gIHNldDxUPihncm91cDogc3RyaW5nLCB2YWx1ZTogVCk6IHZvaWQge1xuICAgIHRoaXMuZ2V0U3ViamVjdChncm91cCkubmV4dCh7IHZhbHVlIH0pO1xuICB9XG59XG5cbmV4cG9ydCBjb25zdCBjcmVhdGVNZW1vcnkgPSA8VD4oXG4gIGl0ZW1OYXZpZ2F0aW9uOiDTqEl0ZW1OYXZpZ2F0aW9uU2VydmljZSxcbiAgcm9vdE1vZGVsOiDTqFJvb3RDb250YWluZXJTZXJ2aWNlLFxuICBzdG9yYWdlOiBNZW1vcnlTdG9yYWdlU2VydmljZSxcbik6IE1lbW9yeVN0b3JlPFQ+ID0+IHtcbiAgcmV0dXJuIHtcbiAgICBzb3VyY2U6IDxVIGV4dGVuZHMgVD4oZ3JvdXA6IHN0cmluZykgPT4gKCk6IE9ic2VydmFibGU8VSB8IHVuZGVmaW5lZD4gPT4gc3RvcmFnZS5nZXQoZ3JvdXApLFxuICAgIHNpbms6IDxVIGV4dGVuZHMgVD4oZ3JvdXA6IHN0cmluZykgPT4gKHN0ZGluOiBPYnNlcnZhYmxlPFU+KSA9PiB7XG4gICAgICBjb25zdCBjb21tb25BbmNlc3Rvckl0ZW0gPSBnZXRJdGVtRm9ybUNvbW11bmljYXRpb25Hcm91cChncm91cCwgcm9vdE1vZGVsKTtcbiAgICAgIHJldHVybiBzdGRpblxuICAgICAgICAucGlwZShjb25jYXRNYXAoZGF0YSA9PiBjb21tb25BbmNlc3Rvckl0ZW0ucGlwZShtYXAoaXRlbSA9PiBbZGF0YSwgaXRlbS5uYW1lXSBhcyBjb25zdCkpKSlcbiAgICAgICAgLnN1YnNjcmliZSgoW2RhdGEsIG5hbWVdKSA9PiB7XG4gICAgICAgICAgYXN5bmNTY2hlZHVsZXIuc2NoZWR1bGUoKCkgPT4ge1xuICAgICAgICAgICAgc3RvcmFnZS5zZXQoZ3JvdXAsIGRhdGEpO1xuICAgICAgICAgIH0pO1xuICAgICAgICAgIGl0ZW1OYXZpZ2F0aW9uLm5hdmlnYXRlVG9JdGVtKG5hbWUsIHt9KTtcbiAgICAgICAgfSk7XG4gICAgfSxcbiAgfTtcbn07XG4vKipcbiAqIEBkZXByZWNhdGVkIFdpbGwgYmUgcmVtb3ZlZCBpbiB2Ny4wLjBcbiAqL1xuZXhwb3J0IGNvbnN0IG1lbW9yeVByb2Nlc3NvckNvbmZpZzogUGlwZWxpbmVQcm9jZXNzb3JDb25maWcgPSBjcmVhdGVQaXBlbGluZVByb2Nlc3NvckNvbmZpZyhUQUcsIHtcbiAgcHJvdmlkZTogbmV3IEluamVjdGlvblRva2VuKCdNZW1vcnkgcGlwZWxpbmUgaGFuZGxlcicpLFxuICB1c2VGYWN0b3J5OiBjcmVhdGVNZW1vcnksXG4gIGRlcHM6IFvTqEl0ZW1OYXZpZ2F0aW9uU2VydmljZSwg06hSb290Q29udGFpbmVyU2VydmljZSwgTWVtb3J5U3RvcmFnZVNlcnZpY2VdLFxufSk7XG5cbmZ1bmN0aW9uIGdldEl0ZW1Gb3JtQ29tbXVuaWNhdGlvbkdyb3VwKGdyb3VwOiBzdHJpbmcsIHJvb3RNb2RlbDog06hSb290Q29udGFpbmVyU2VydmljZSkge1xuICBjb25zdCBjb21tdW5pY2F0aW9uRGVmaW5pdGlvbiA9IG5ldyBDb21tdW5pY2F0aW9uRGVmaW5pdGlvbihUQUcsIGdyb3VwKTtcbiAgY29uc3QgY29tbW9uQW5jZXN0b3JJdGVtID0gcm9vdE1vZGVsLmNvbW1vbkFuY2VzdG9yKGNvbW11bmljYXRpb25EZWZpbml0aW9uKS5waXBlKFxuICAgIGZpcnN0KCksXG4gICAgZmlsdGVyKChpdGVtKTogaXRlbSBpcyBJdGVtTW9kZWwgPT4ge1xuICAgICAgaWYgKGl0ZW0gPT09IHVuZGVmaW5lZCkge1xuICAgICAgICBjb25zb2xlLndhcm4oYE5vIElucHV0cyBjb25maWd1cmVkIHRvIHJlY2VpdmUgaW4gbWVtb3J5IHZhbHVlIGZvciBjb21tdW5pY2F0aW9uIGdyb3VwIFwiJHtncm91cH1cImApO1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9KSxcbiAgKTtcbiAgcmV0dXJuIGNvbW1vbkFuY2VzdG9ySXRlbTtcbn1cbiJdfQ==