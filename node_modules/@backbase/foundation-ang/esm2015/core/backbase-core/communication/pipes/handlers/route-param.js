import { InjectionToken } from '@angular/core';
import { ActivatedRoute } from '@angular/router';
import { CommunicationDefinition, serializerDeserializer } from '@backbase/communication-property';
import { combineLatest } from 'rxjs';
import { filter, first, map } from 'rxjs/operators';
import { ӨRootContainerService } from '../../../models/root-container.service';
import { ӨItemNavigationService } from '../../item-navigation.service';
import { createPipelineProcessorConfig } from '../pipeline-registry';
/**
 * @deprecated Will be removed in v7.0.0
 * Pipeable operator for normalizing value to `RouteParams`.
 *
 * @param paramNameArg
 */
export const routeParams = (paramNameArg) => (stdin) => stdin.pipe(map((payload) => (paramNameArg ? { [paramNameArg]: `${payload}` } : {})));
const TAG = 'route-param';
/**
 * @deprecated Will be removed in v7.0.0
 * RouteParam Communication Transport
 *
 * Can be used to configure communication using RouteParam.
 *
 * @usageNotes
 *
 * Store some 2-way bound state to the router as "paramName"
 *
 * ```json
 * {
 *   "name": "widget-a",
 *   "properties": {
 *     "output.myOutput": RouteParam.toProperty("paramName"),
 *     "input.myInput": RouteParam.toProperty("paramName")
 *   }
 * }
 * ```
 *
 * Navigate to widget-b and pass data via route-param
 *
 * ```json
 * {
 *   "name": "widget-a",
 *   "properties": {
 *     "output.myOutput": RouteParam.toProperty("inputName")
 *   }
 * },
 * {
 *   "name": "widget-b",
 *   "properties": {
 *     "input.myInput": RouteParam.toProperty("inputName")
 *   }
 * }
 * ```
 */
export class RouteParam {
    /**
     * Generate a serialized communication configuration suitable for use as a Widget Input or Output property value.
     *
     * @param group The name of the communication group to which the Input/Output belongs
     */
    static toProperty(group) {
        return serializerDeserializer.toProperty(new CommunicationDefinition(TAG, group));
    }
}
const getActivatedRouteParam = (paramName) => (activatedRoute) => activatedRoute.paramMap.pipe(filter(Boolean), map((params) => params.get(paramName)), map(param => (param === null ? undefined : param)));
const ɵ0 = getActivatedRouteParam;
const walkRoutePath = (activatedRoute) => {
    if (!activatedRoute.parent) {
        return [activatedRoute];
    }
    return [activatedRoute, ...walkRoutePath(activatedRoute.parent)];
};
const ɵ1 = walkRoutePath;
/**
 * @deprecated Will be removed in v7.0.0
 */
export const getRouteParam = (activatedRoute, group) => {
    const activatedRoutes = walkRoutePath(activatedRoute);
    const allParams$ = activatedRoutes.map(getActivatedRouteParam(group));
    return combineLatest(allParams$).pipe(map(allParams => allParams.find(v => v !== undefined)));
};
/**
 * @deprecated Will be removed in v7.0.0
 */
export const createRouteParams = (activatedRoute, itemNavigation, rootModel) => ({
    source: (group) => () => getRouteParam(activatedRoute, group).pipe(map(deserialize)),
    sink: (group) => {
        return stdin => {
            stdin.pipe(map(serialize), routeParams(group)).subscribe(params => {
                rootModel
                    .commonAncestor(new CommunicationDefinition(TAG, group))
                    .pipe(first())
                    .subscribe(commonAncestor => {
                    if (commonAncestor === undefined) {
                        return console.warn('No Inputs configured to receive route param');
                    }
                    itemNavigation.navigateToItem(commonAncestor.name, params);
                });
            });
        };
    },
});
/**
 * @deprecated Will be removed in v7.0.0
 */
export const routeParamsProcessorConfig = createPipelineProcessorConfig(TAG, {
    provide: new InjectionToken('Route param pipeline handler'),
    useFactory: createRouteParams,
    deps: [ActivatedRoute, ӨItemNavigationService, ӨRootContainerService],
});
function serialize(outputValue) {
    return typeof outputValue === 'string' ? outputValue : `"${JSON.stringify(outputValue)}"`;
}
function deserialize(payload) {
    if (payload === undefined) {
        return undefined;
    }
    // not serialized
    if (!(payload.startsWith('"') && payload.endsWith('"'))) {
        return payload;
    }
    // actually attempt to deserialize
    try {
        return JSON.parse(payload.substr(1, payload.length - 2));
    }
    catch (_) {
        return payload;
    }
}
export { ɵ0, ɵ1 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm91dGUtcGFyYW0uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9iYWNrYmFzZS9mb3VuZGF0aW9uLWFuZy9jb3JlL3NyYy9iYWNrYmFzZS1jb3JlL2NvbW11bmljYXRpb24vcGlwZXMvaGFuZGxlcnMvcm91dGUtcGFyYW0udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMvQyxPQUFPLEVBQUUsY0FBYyxFQUFZLE1BQU0saUJBQWlCLENBQUM7QUFDM0QsT0FBTyxFQUFFLHVCQUF1QixFQUFFLHNCQUFzQixFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFDbkcsT0FBTyxFQUFjLGFBQWEsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNqRCxPQUFPLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUVwRCxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSx3Q0FBd0MsQ0FBQztBQUMvRSxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUV2RSxPQUFPLEVBQUUsNkJBQTZCLEVBQTJCLE1BQU0sc0JBQXNCLENBQUM7QUFrQzlGOzs7OztHQUtHO0FBQ0gsTUFBTSxDQUFDLE1BQU0sV0FBVyxHQUFHLENBQUMsWUFBb0IsRUFBRSxFQUFFLENBQUMsQ0FBQyxLQUFxQyxFQUFFLEVBQUUsQ0FDN0YsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxPQUEyQixFQUFFLEVBQUUsQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLFlBQVksQ0FBQyxFQUFFLEdBQUcsT0FBTyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBRTNHLE1BQU0sR0FBRyxHQUFrQixhQUFhLENBQUM7QUFFekM7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QztRQUNMLENBQUMsQ0FBQztJQUNKLENBQUM7Q0FDRixDQUFDLENBQUM7QUFDSDs7R0FFRztBQUNILE1BQU0sQ0FBQyxNQUFNLDBCQUEwQixHQUE0Qiw2QkFBNkIsQ0FBQyxHQUFHLEVBQUU7SUFDcEcsT0FBTyxFQUFFLElBQUksY0FBYyxDQUFDLDhCQUE4QixDQUFDO0lBQzNELFVBQVUsRUFBRSxpQkFBaUI7SUFDN0IsSUFBSSxFQUFFLENBQUMsY0FBYyxFQUFFLHNCQUFzQixFQUFFLHFCQUFxQixDQUFDO0NBQ3RFLENBQUMsQ0FBQztBQUVILFNBQVMsU0FBUyxDQUE4QixXQUFjO0lBQzVELE9BQU8sT0FBTyxXQUFXLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDO0FBQzVGLENBQUM7QUFFRCxTQUFTLFdBQVcsQ0FBQyxPQUEyQjtJQUM5QyxJQUFJLE9BQU8sS0FBSyxTQUFTLEVBQUU7UUFDekIsT0FBTyxTQUFTLENBQUM7S0FDbEI7SUFFRCxpQkFBaUI7SUFDakIsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsSUFBSSxPQUFPLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUU7UUFDdkQsT0FBTyxPQUFPLENBQUM7S0FDaEI7SUFFRCxrQ0FBa0M7SUFDbEMsSUFBSTtRQUNGLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxPQUFPLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7S0FDMUQ7SUFBQyxPQUFPLENBQUMsRUFBRTtRQUNWLE9BQU8sT0FBTyxDQUFDO0tBQ2hCO0FBQ0gsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGlvblRva2VuIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBBY3RpdmF0ZWRSb3V0ZSwgUGFyYW1NYXAgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHsgQ29tbXVuaWNhdGlvbkRlZmluaXRpb24sIHNlcmlhbGl6ZXJEZXNlcmlhbGl6ZXIgfSBmcm9tICdAYmFja2Jhc2UvY29tbXVuaWNhdGlvbi1wcm9wZXJ0eSc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBjb21iaW5lTGF0ZXN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBmaWx0ZXIsIGZpcnN0LCBtYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7INOoUm9vdENvbnRhaW5lclNlcnZpY2UgfSBmcm9tICcuLi8uLi8uLi9tb2RlbHMvcm9vdC1jb250YWluZXIuc2VydmljZSc7XG5pbXBvcnQgeyDTqEl0ZW1OYXZpZ2F0aW9uU2VydmljZSB9IGZyb20gJy4uLy4uL2l0ZW0tbmF2aWdhdGlvbi5zZXJ2aWNlJztcbmltcG9ydCB7IFBpcGVsaW5lU2luaywgUGlwZWxpbmVTb3VyY2UsIFNpbmssIFNvdXJjZSB9IGZyb20gJy4uL3BpcGVsaW5lLWludGVyZmFjZSc7XG5pbXBvcnQgeyBjcmVhdGVQaXBlbGluZVByb2Nlc3NvckNvbmZpZywgUGlwZWxpbmVQcm9jZXNzb3JDb25maWcgfSBmcm9tICcuLi9waXBlbGluZS1yZWdpc3RyeSc7XG5cbi8qKlxuICogQGRlcHJlY2F0ZWQgV2lsbCBiZSByZW1vdmVkIGluIHY3LjAuMFxuICovXG5leHBvcnQgaW50ZXJmYWNlIFJvdXRlUGFyYW1zIHtcbiAgW2tleTogc3RyaW5nXTogYW55O1xufVxuXG4vKipcbiAqIEBkZXByZWNhdGVkIFdpbGwgYmUgcmVtb3ZlZCBpbiB2Ny4wLjBcbiAqIFVzZSB0aGUgcm91dGVyIHRvIHN0b3JlIGRhdGEuXG4gKlxuICogYGBgXG4gKiBbIENvbXBvbmVudCBPdXRwdXQgXSAtPiBbIFJvdXRlIFN0b3JlIF1cbiAqIFsgUm91dGUgU3RvcmUgXSAtPiBbIENvbXBvbmVudCBJbnB1dCBdXG4gKiBgYGBcbiAqXG4gKiBTZWUgYFJvdXRlUGFyYW1gIGZvciBjb25maWd1cmF0aW9uLlxuICpcbiAqIE5vdGU6IHlvdSBjYW4gdXNlIGEgc2luZ2xlIG91dHB1dCB0byBzYXZlIG11bHRpcGxlIHBhcmFtc1xuICogdG8gYSBzdG9yZSBieSB1c2luZyBgUm91dGVQYXJhbXNNdWx0aVNpbmtgLlxuICovXG5leHBvcnQgaW50ZXJmYWNlIFJvdXRlUGFyYW1zU3RvcmU8VCBleHRlbmRzIFJvdXRlUGFyYW1QYXlsb2FkPiBleHRlbmRzIFBpcGVsaW5lU291cmNlPFQgfCB1bmRlZmluZWQ+LCBQaXBlbGluZVNpbms8VD4ge1xuICAvKipcbiAgICogQHBhcmFtIHBhcmFtTmFtZSBUaGUgbmFtZSBvZiB0aGUgcGFyYW0gdG8gc2F2ZSBpbiB0aGUgcm91dGVcbiAgICovXG4gIHNvdXJjZTogKGdyb3VwOiBzdHJpbmcpID0+IFNvdXJjZTxUIHwgdW5kZWZpbmVkPjtcbiAgLyoqXG4gICAqIEBwYXJhbSBwYXJhbU5hbWUgVGhlIG5hbWUgb2YgdGhlIHBhcmFtIHRvIHJlYWQgZnJvbSB0aGUgcm91dGVcbiAgICovXG4gIHNpbms6IChncm91cDogc3RyaW5nKSA9PiBTaW5rPFQ+O1xufVxuXG4vKipcbiAqIEBkZXByZWNhdGVkIFdpbGwgYmUgcmVtb3ZlZCBpbiB2Ny4wLjBcbiAqIFBpcGVhYmxlIG9wZXJhdG9yIGZvciBub3JtYWxpemluZyB2YWx1ZSB0byBgUm91dGVQYXJhbXNgLlxuICpcbiAqIEBwYXJhbSBwYXJhbU5hbWVBcmdcbiAqL1xuZXhwb3J0IGNvbnN0IHJvdXRlUGFyYW1zID0gKHBhcmFtTmFtZUFyZzogc3RyaW5nKSA9PiAoc3RkaW46IE9ic2VydmFibGU8c3RyaW5nIHwgdW5kZWZpbmVkPikgPT5cbiAgc3RkaW4ucGlwZShtYXAoKHBheWxvYWQ6IHN0cmluZyB8IHVuZGVmaW5lZCkgPT4gKHBhcmFtTmFtZUFyZyA/IHsgW3BhcmFtTmFtZUFyZ106IGAke3BheWxvYWR9YCB9IDoge30pKSk7XG5cbmNvbnN0IFRBRzogJ3JvdXRlLXBhcmFtJyA9ICdyb3V0ZS1wYXJhbSc7XG5cbi8qKlxuICogQGRlcHJlY2F0ZWQgV2lsbCBiZSByZW1vdmVkIGluIHY3LjAuMFxuICogUm91dGVQYXJhbSBDb21tdW5pY2F0aW9uIFRyYW5zcG9ydFxuICpcbiAqIENhbiBiZSB1c2VkIHRvIGNvbmZpZ3VyZSBjb21tdW5pY2F0aW9uIHVzaW5nIFJvdXRlUGFyYW0uXG4gKlxuICogQHVzYWdlTm90ZXNcbiAqXG4gKiBTdG9yZSBzb21lIDItd2F5IGJvdW5kIHN0YXRlIHRvIHRoZSByb3V0ZXIgYXMgXCJwYXJhbU5hbWVcIlxuICpcbiAqIGBgYGpzb25cbiAqIHtcbiAqICAgXCJuYW1lXCI6IFwid2lkZ2V0LWFcIixcbiAqICAgXCJwcm9wZXJ0aWVzXCI6IHtcbiAqICAgICBcIm91dHB1dC5teU91dHB1dFwiOiBSb3V0ZVBhcmFtLnRvUHJvcGVydHkoXCJwYXJhbU5hbWVcIiksXG4gKiAgICAgXCJpbnB1dC5teUlucHV0XCI6IFJvdXRlUGFyYW0udG9Qcm9wZXJ0eShcInBhcmFtTmFtZVwiKVxuICogICB9XG4gKiB9XG4gKiBgYGBcbiAqXG4gKiBOYXZpZ2F0ZSB0byB3aWRnZXQtYiBhbmQgcGFzcyBkYXRhIHZpYSByb3V0ZS1wYXJhbVxuICpcbiAqIGBgYGpzb25cbiAqIHtcbiAqICAgXCJuYW1lXCI6IFwid2lkZ2V0LWFcIixcbiAqICAgXCJwcm9wZXJ0aWVzXCI6IHtcbiAqICAgICBcIm91dHB1dC5teU91dHB1dFwiOiBSb3V0ZVBhcmFtLnRvUHJvcGVydHkoXCJpbnB1dE5hbWVcIilcbiAqICAgfVxuICogfSxcbiAqIHtcbiAqICAgXCJuYW1lXCI6IFwid2lkZ2V0LWJcIixcbiAqICAgXCJwcm9wZXJ0aWVzXCI6IHtcbiAqICAgICBcImlucHV0Lm15SW5wdXRcIjogUm91dGVQYXJhbS50b1Byb3BlcnR5KFwiaW5wdXROYW1lXCIpXG4gKiAgIH1cbiAqIH1cbiAqIGBgYFxuICovXG5leHBvcnQgY2xhc3MgUm91dGVQYXJhbSB7XG4gIC8qKlxuICAgKiBHZW5lcmF0ZSBhIHNlcmlhbGl6ZWQgY29tbXVuaWNhdGlvbiBjb25maWd1cmF0aW9uIHN1aXRhYmxlIGZvciB1c2UgYXMgYSBXaWRnZXQgSW5wdXQgb3IgT3V0cHV0IHByb3BlcnR5IHZhbHVlLlxuICAgKlxuICAgKiBAcGFyYW0gZ3JvdXAgVGhlIG5hbWUgb2YgdGhlIGNvbW11bmljYXRpb24gZ3JvdXAgdG8gd2hpY2ggdGhlIElucHV0L091dHB1dCBiZWxvbmdzXG4gICAqL1xuICBzdGF0aWMgdG9Qcm9wZXJ0eShncm91cDogc3RyaW5nKTogc3RyaW5nIHtcbiAgICByZXR1cm4gc2VyaWFsaXplckRlc2VyaWFsaXplci50b1Byb3BlcnR5KG5ldyBDb21tdW5pY2F0aW9uRGVmaW5pdGlvbihUQUcsIGdyb3VwKSk7XG4gIH1cbn1cblxuY29uc3QgZ2V0QWN0aXZhdGVkUm91dGVQYXJhbSA9IChwYXJhbU5hbWU6IHN0cmluZykgPT4gKFxuICBhY3RpdmF0ZWRSb3V0ZTogQWN0aXZhdGVkUm91dGUsXG4pOiBPYnNlcnZhYmxlPHN0cmluZyB8IHVuZGVmaW5lZD4gPT5cbiAgYWN0aXZhdGVkUm91dGUucGFyYW1NYXAucGlwZShcbiAgICBmaWx0ZXI8UGFyYW1NYXA+KEJvb2xlYW4pLFxuICAgIG1hcCgocGFyYW1zOiBQYXJhbU1hcCkgPT4gcGFyYW1zLmdldChwYXJhbU5hbWUpKSxcbiAgICBtYXAocGFyYW0gPT4gKHBhcmFtID09PSBudWxsID8gdW5kZWZpbmVkIDogcGFyYW0pKSxcbiAgKTtcblxuY29uc3Qgd2Fsa1JvdXRlUGF0aCA9IChhY3RpdmF0ZWRSb3V0ZTogQWN0aXZhdGVkUm91dGUpOiBBcnJheTxBY3RpdmF0ZWRSb3V0ZT4gPT4ge1xuICBpZiAoIWFjdGl2YXRlZFJvdXRlLnBhcmVudCkge1xuICAgIHJldHVybiBbYWN0aXZhdGVkUm91dGVdO1xuICB9XG4gIHJldHVybiBbYWN0aXZhdGVkUm91dGUsIC4uLndhbGtSb3V0ZVBhdGgoYWN0aXZhdGVkUm91dGUucGFyZW50KV07XG59O1xuLyoqXG4gKiBAZGVwcmVjYXRlZCBXaWxsIGJlIHJlbW92ZWQgaW4gdjcuMC4wXG4gKi9cbmV4cG9ydCB0eXBlIFJvdXRlUGFyYW1QYXlsb2FkID1cbiAgfCBzdHJpbmdcbiAgfCB7XG4gICAgICBba2V5OiBzdHJpbmddOiBzdHJpbmcgfCBudW1iZXI7XG4gICAgfTtcbi8qKlxuICogQGRlcHJlY2F0ZWQgV2lsbCBiZSByZW1vdmVkIGluIHY3LjAuMFxuICovXG5leHBvcnQgY29uc3QgZ2V0Um91dGVQYXJhbSA9IChhY3RpdmF0ZWRSb3V0ZTogQWN0aXZhdGVkUm91dGUsIGdyb3VwOiBzdHJpbmcpOiBPYnNlcnZhYmxlPHN0cmluZyB8IHVuZGVmaW5lZD4gPT4ge1xuICBjb25zdCBhY3RpdmF0ZWRSb3V0ZXM6IEFycmF5PEFjdGl2YXRlZFJvdXRlPiA9IHdhbGtSb3V0ZVBhdGgoYWN0aXZhdGVkUm91dGUpO1xuICBjb25zdCBhbGxQYXJhbXMkOiBBcnJheTxPYnNlcnZhYmxlPHN0cmluZyB8IHVuZGVmaW5lZD4+ID0gYWN0aXZhdGVkUm91dGVzLm1hcChnZXRBY3RpdmF0ZWRSb3V0ZVBhcmFtKGdyb3VwKSk7XG5cbiAgcmV0dXJuIGNvbWJpbmVMYXRlc3QoYWxsUGFyYW1zJCkucGlwZShtYXAoYWxsUGFyYW1zID0+IGFsbFBhcmFtcy5maW5kKHYgPT4gdiAhPT0gdW5kZWZpbmVkKSkpO1xufTtcbi8qKlxuICogQGRlcHJlY2F0ZWQgV2lsbCBiZSByZW1vdmVkIGluIHY3LjAuMFxuICovXG5leHBvcnQgY29uc3QgY3JlYXRlUm91dGVQYXJhbXMgPSA8VCBleHRlbmRzIFJvdXRlUGFyYW1QYXlsb2FkID0gc3RyaW5nPihcbiAgYWN0aXZhdGVkUm91dGU6IEFjdGl2YXRlZFJvdXRlLFxuICBpdGVtTmF2aWdhdGlvbjog06hJdGVtTmF2aWdhdGlvblNlcnZpY2UsXG4gIHJvb3RNb2RlbDog06hSb290Q29udGFpbmVyU2VydmljZSxcbik6IFJvdXRlUGFyYW1zU3RvcmU8VD4gPT4gKHtcbiAgc291cmNlOiAoZ3JvdXA6IHN0cmluZykgPT4gKCkgPT4gZ2V0Um91dGVQYXJhbShhY3RpdmF0ZWRSb3V0ZSwgZ3JvdXApLnBpcGUobWFwKGRlc2VyaWFsaXplKSksXG4gIHNpbms6IChncm91cDogc3RyaW5nKSA9PiB7XG4gICAgcmV0dXJuIHN0ZGluID0+IHtcbiAgICAgIHN0ZGluLnBpcGUobWFwKHNlcmlhbGl6ZSksIHJvdXRlUGFyYW1zKGdyb3VwKSkuc3Vic2NyaWJlKHBhcmFtcyA9PiB7XG4gICAgICAgIHJvb3RNb2RlbFxuICAgICAgICAgIC5jb21tb25BbmNlc3RvcihuZXcgQ29tbXVuaWNhdGlvbkRlZmluaXRpb24oVEFHLCBncm91cCkpXG4gICAgICAgICAgLnBpcGUoZmlyc3QoKSlcbiAgICAgICAgICAuc3Vic2NyaWJlKGNvbW1vbkFuY2VzdG9yID0+IHtcbiAgICAgICAgICAgIGlmIChjb21tb25BbmNlc3RvciA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgIHJldHVybiBjb25zb2xlLndhcm4oJ05vIElucHV0cyBjb25maWd1cmVkIHRvIHJlY2VpdmUgcm91dGUgcGFyYW0nKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGl0ZW1OYXZpZ2F0aW9uLm5hdmlnYXRlVG9JdGVtKGNvbW1vbkFuY2VzdG9yLm5hbWUsIHBhcmFtcyk7XG4gICAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICB9O1xuICB9LFxufSk7XG4vKipcbiAqIEBkZXByZWNhdGVkIFdpbGwgYmUgcmVtb3ZlZCBpbiB2Ny4wLjBcbiAqL1xuZXhwb3J0IGNvbnN0IHJvdXRlUGFyYW1zUHJvY2Vzc29yQ29uZmlnOiBQaXBlbGluZVByb2Nlc3NvckNvbmZpZyA9IGNyZWF0ZVBpcGVsaW5lUHJvY2Vzc29yQ29uZmlnKFRBRywge1xuICBwcm92aWRlOiBuZXcgSW5qZWN0aW9uVG9rZW4oJ1JvdXRlIHBhcmFtIHBpcGVsaW5lIGhhbmRsZXInKSxcbiAgdXNlRmFjdG9yeTogY3JlYXRlUm91dGVQYXJhbXMsXG4gIGRlcHM6IFtBY3RpdmF0ZWRSb3V0ZSwg06hJdGVtTmF2aWdhdGlvblNlcnZpY2UsINOoUm9vdENvbnRhaW5lclNlcnZpY2VdLFxufSk7XG5cbmZ1bmN0aW9uIHNlcmlhbGl6ZTxUIGV4dGVuZHMgUm91dGVQYXJhbVBheWxvYWQ+KG91dHB1dFZhbHVlOiBUKTogc3RyaW5nIHtcbiAgcmV0dXJuIHR5cGVvZiBvdXRwdXRWYWx1ZSA9PT0gJ3N0cmluZycgPyBvdXRwdXRWYWx1ZSA6IGBcIiR7SlNPTi5zdHJpbmdpZnkob3V0cHV0VmFsdWUpfVwiYDtcbn1cblxuZnVuY3Rpb24gZGVzZXJpYWxpemUocGF5bG9hZDogc3RyaW5nIHwgdW5kZWZpbmVkKSB7XG4gIGlmIChwYXlsb2FkID09PSB1bmRlZmluZWQpIHtcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG5cbiAgLy8gbm90IHNlcmlhbGl6ZWRcbiAgaWYgKCEocGF5bG9hZC5zdGFydHNXaXRoKCdcIicpICYmIHBheWxvYWQuZW5kc1dpdGgoJ1wiJykpKSB7XG4gICAgcmV0dXJuIHBheWxvYWQ7XG4gIH1cblxuICAvLyBhY3R1YWxseSBhdHRlbXB0IHRvIGRlc2VyaWFsaXplXG4gIHRyeSB7XG4gICAgcmV0dXJuIEpTT04ucGFyc2UocGF5bG9hZC5zdWJzdHIoMSwgcGF5bG9hZC5sZW5ndGggLSAyKSk7XG4gIH0gY2F0Y2ggKF8pIHtcbiAgICByZXR1cm4gcGF5bG9hZDtcbiAgfVxufVxuIl19