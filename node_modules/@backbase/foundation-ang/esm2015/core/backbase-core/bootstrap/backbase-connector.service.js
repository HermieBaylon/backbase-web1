import { Injectable, NgZone } from '@angular/core';
import { debounceTime, mapTo, publishReplay, take } from 'rxjs/operators';
import { propertiesByPrefix } from '../../web-sdk/properties';
import { AppConfigService } from '../models/app-config.service';
import { isArrayOfStrings } from '../models/array';
import { filterChildren } from '../models/item-model-utils';
import { ӨRootContainerService } from '../models/root-container.service';
import { ItemLifecycleService } from '../rendering/item-lifecycle.service';
/**
 * @deprecated Will be removed in v7.0.0
 */
export const isRootContainerItem = (item) => !item.properties || !item.properties.classId;
/**
 * @deprecated Will be removed in v7.0.0
 */
export class BackbaseConnector {
    /**
     * BackbaseConnectorService constructor
     * @param zone NgZone to be used for manipulations with an item
     * @param componentInjectors Backbase core components injector service to handle the model
     */
    constructor(zone, appConfig, rootContainer, lifeCycle) {
        this.zone = zone;
        this.appConfig = appConfig;
        this.rootContainer = rootContainer;
        this.lifeCycle = lifeCycle;
    }
    filterItem(item) {
        const features = propertiesByPrefix(this.appConfig.prefix, item.properties);
        this.appConfig.setConfig(features);
        return filterChildren(item, child => {
            const itemFeatures = child.properties.features;
            return (!itemFeatures ||
                !isArrayOfStrings(itemFeatures) ||
                itemFeatures.some(requiredFeature => features[requiredFeature] !== false));
        });
    }
    /**
     * Bootstrap function to be called on page model initialization,
     * and when new item added to the model (dropped on the page).
     * @param item Item to bootstrap
     * @param itemLocation Location of the item
     */
    bootstrap(item, itemLocation) {
        return this.zone.run(() => {
            let event;
            if (isRootContainerItem(item)) {
                event = this.lifeCycle.whenCreate(undefined).pipe(publishReplay(1));
            }
            else {
                event = this.lifeCycle.fromItem(item.name).pipe(publishReplay(1));
            }
            event.connect();
            const itemToInsert = this.rootContainer.isBootstrapped() ? item : this.filterItem(item);
            this.rootContainer.insertItem(itemToInsert, itemLocation);
            return event.pipe(take(1), mapTo(true)).toPromise();
        });
    }
    /**
     * Update function will be called when properties are changed for
     * one of the existing items on a page.
     * @param item Updated item
     * @param itemLocation Location of the item
     * @param changes Object which contains only changed properties and their values
     */
    update(item, _, itemProperties) {
        return this.zone.run(() => {
            this.rootContainer.updateItem(item.name, itemProperties);
            return this.lifeCycle.fromItem(item.name).pipe(take(1), mapTo(undefined)).toPromise();
        });
    }
    /**
     * Remove function will be called when existing item is removed from the page.
     * @param item Item to remove
     * @param itemLocation Location of the item
     */
    remove(item, itemLocation) {
        return this.zone.run(() => {
            this.rootContainer.removeItem(item.name, itemLocation);
            return this.lifeCycle.whenRemove().pipe(debounceTime(20), take(1), mapTo(undefined)).toPromise();
        });
    }
}
BackbaseConnector.decorators = [
    { type: Injectable }
];
BackbaseConnector.ctorParameters = () => [
    { type: NgZone },
    { type: AppConfigService },
    { type: ӨRootContainerService },
    { type: ItemLifecycleService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFja2Jhc2UtY29ubmVjdG9yLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9iYWNrYmFzZS9mb3VuZGF0aW9uLWFuZy9jb3JlL3NyYy9iYWNrYmFzZS1jb3JlL2Jvb3RzdHJhcC9iYWNrYmFzZS1jb25uZWN0b3Iuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUduRCxPQUFPLEVBQUUsWUFBWSxFQUFFLEtBQUssRUFBRSxhQUFhLEVBQUUsSUFBSSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDMUUsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDOUQsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFDaEUsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDbkQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBQzVELE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLGtDQUFrQyxDQUFDO0FBQ3pFLE9BQU8sRUFBRSxvQkFBb0IsRUFBa0IsTUFBTSxxQ0FBcUMsQ0FBQztBQUMzRjs7R0FFRztBQUNILE1BQU0sQ0FBQyxNQUFNLG1CQUFtQixHQUFHLENBQUMsSUFBVSxFQUFXLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQztBQUV6Rzs7R0FFRztBQUVILE1BQU0sT0FBTyxpQkFBaUI7SUFDNUI7Ozs7T0FJRztJQUNILFlBQ21CLElBQVksRUFDWixTQUEyQixFQUMzQixhQUFvQyxFQUNwQyxTQUErQjtRQUgvQixTQUFJLEdBQUosSUFBSSxDQUFRO1FBQ1osY0FBUyxHQUFULFNBQVMsQ0FBa0I7UUFDM0Is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SSxDQUFDLFlBQVksQ0FBQyxFQUFFLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsU0FBUyxFQUFFLENBQUM7UUFDbkcsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDOzs7WUF4RUYsVUFBVTs7O1lBbEJVLE1BQU07WUFLbEIsZ0JBQWdCO1lBR2hCLHFCQUFxQjtZQUNyQixvQkFBb0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBOZ1pvbmUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEl0ZW0sIEl0ZW1Mb2NhdGlvbiwgUHJvcGVydGllcywgUHJvcGVydHksIFJlbmRlcmluZ1N0cmF0ZWd5IH0gZnJvbSAnQGJhY2tiYXNlL2ZvdW5kYXRpb24tYW5nL3dlYi1zZGsnO1xuaW1wb3J0IHsgQ29ubmVjdGFibGVPYnNlcnZhYmxlLCBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBkZWJvdW5jZVRpbWUsIG1hcFRvLCBwdWJsaXNoUmVwbGF5LCB0YWtlIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgcHJvcGVydGllc0J5UHJlZml4IH0gZnJvbSAnLi4vLi4vd2ViLXNkay9wcm9wZXJ0aWVzJztcbmltcG9ydCB7IEFwcENvbmZpZ1NlcnZpY2UgfSBmcm9tICcuLi9tb2RlbHMvYXBwLWNvbmZpZy5zZXJ2aWNlJztcbmltcG9ydCB7IGlzQXJyYXlPZlN0cmluZ3MgfSBmcm9tICcuLi9tb2RlbHMvYXJyYXknO1xuaW1wb3J0IHsgZmlsdGVyQ2hpbGRyZW4gfSBmcm9tICcuLi9tb2RlbHMvaXRlbS1tb2RlbC11dGlscyc7XG5pbXBvcnQgeyDTqFJvb3RDb250YWluZXJTZXJ2aWNlIH0gZnJvbSAnLi4vbW9kZWxzL3Jvb3QtY29udGFpbmVyLnNlcnZpY2UnO1xuaW1wb3J0IHsgSXRlbUxpZmVjeWNsZVNlcnZpY2UsIExpZmVjeWNsZUV2ZW50IH0gZnJvbSAnLi4vcmVuZGVyaW5nL2l0ZW0tbGlmZWN5Y2xlLnNlcnZpY2UnO1xuLyoqXG4gKiBAZGVwcmVjYXRlZCBXaWxsIGJlIHJlbW92ZWQgaW4gdjcuMC4wXG4gKi9cbmV4cG9ydCBjb25zdCBpc1Jvb3RDb250YWluZXJJdGVtID0gKGl0ZW06IEl0ZW0pOiBib29sZWFuID0+ICFpdGVtLnByb3BlcnRpZXMgfHwgIWl0ZW0ucHJvcGVydGllcy5jbGFzc0lkO1xuXG4vKipcbiAqIEBkZXByZWNhdGVkIFdpbGwgYmUgcmVtb3ZlZCBpbiB2Ny4wLjBcbiAqL1xuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEJhY2tiYXNlQ29ubmVjdG9yIGltcGxlbWVudHMgUmVuZGVyaW5nU3RyYXRlZ3kge1xuICAvKipcbiAgICogQmFja2Jhc2VDb25uZWN0b3JTZXJ2aWNlIGNvbnN0cnVjdG9yXG4gICAqIEBwYXJhbSB6b25lIE5nWm9uZSB0byBiZSB1c2VkIGZvciBtYW5pcHVsYXRpb25zIHdpdGggYW4gaXRlbVxuICAgKiBAcGFyYW0gY29tcG9uZW50SW5qZWN0b3JzIEJhY2tiYXNlIGNvcmUgY29tcG9uZW50cyBpbmplY3RvciBzZXJ2aWNlIHRvIGhhbmRsZSB0aGUgbW9kZWxcbiAgICovXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgem9uZTogTmdab25lLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgYXBwQ29uZmlnOiBBcHBDb25maWdTZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgcm9vdENvbnRhaW5lcjog06hSb290Q29udGFpbmVyU2VydmljZSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGxpZmVDeWNsZTogSXRlbUxpZmVjeWNsZVNlcnZpY2UsXG4gICkge31cblxuICBwcml2YXRlIGZpbHRlckl0ZW0oaXRlbTogSXRlbSk6IEl0ZW0ge1xuICAgIGNvbnN0IGZlYXR1cmVzID0gcHJvcGVydGllc0J5UHJlZml4KHRoaXMuYXBwQ29uZmlnLnByZWZpeCwgaXRlbS5wcm9wZXJ0aWVzKTtcbiAgICB0aGlzLmFwcENvbmZpZy5zZXRDb25maWcoZmVhdHVyZXMpO1xuICAgIHJldHVybiBmaWx0ZXJDaGlsZHJlbihpdGVtLCBjaGlsZCA9PiB7XG4gICAgICBjb25zdCBpdGVtRmVhdHVyZXM6IFByb3BlcnR5ID0gY2hpbGQucHJvcGVydGllcy5mZWF0dXJlcztcbiAgICAgIHJldHVybiAoXG4gICAgICAgICFpdGVtRmVhdHVyZXMgfHxcbiAgICAgICAgIWlzQXJyYXlPZlN0cmluZ3MoaXRlbUZlYXR1cmVzKSB8fFxuICAgICAgICBpdGVtRmVhdHVyZXMuc29tZShyZXF1aXJlZEZlYXR1cmUgPT4gZmVhdHVyZXNbcmVxdWlyZWRGZWF0dXJlXSAhPT0gZmFsc2UpXG4gICAgICApO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEJvb3RzdHJhcCBmdW5jdGlvbiB0byBiZSBjYWxsZWQgb24gcGFnZSBtb2RlbCBpbml0aWFsaXphdGlvbixcbiAgICogYW5kIHdoZW4gbmV3IGl0ZW0gYWRkZWQgdG8gdGhlIG1vZGVsIChkcm9wcGVkIG9uIHRoZSBwYWdlKS5cbiAgICogQHBhcmFtIGl0ZW0gSXRlbSB0byBib290c3RyYXBcbiAgICogQHBhcmFtIGl0ZW1Mb2NhdGlvbiBMb2NhdGlvbiBvZiB0aGUgaXRlbVxuICAgKi9cbiAgYm9vdHN0cmFwKGl0ZW06IEl0ZW0sIGl0ZW1Mb2NhdGlvbjogSXRlbUxvY2F0aW9uKTogUHJvbWlzZTxib29sZWFuIHwgdm9pZD4ge1xuICAgIHJldHVybiB0aGlzLnpvbmUucnVuKCgpID0+IHtcbiAgICAgIGxldCBldmVudDogT2JzZXJ2YWJsZTxMaWZlY3ljbGVFdmVudD47XG4gICAgICBpZiAoaXNSb290Q29udGFpbmVySXRlbShpdGVtKSkge1xuICAgICAgICBldmVudCA9IHRoaXMubGlmZUN5Y2xlLndoZW5DcmVhdGUodW5kZWZpbmVkKS5waXBlKHB1Ymxpc2hSZXBsYXkoMSkpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZXZlbnQgPSB0aGlzLmxpZmVDeWNsZS5mcm9tSXRlbShpdGVtLm5hbWUpLnBpcGUocHVibGlzaFJlcGxheSgxKSk7XG4gICAgICB9XG4gICAgICAoZXZlbnQgYXMgQ29ubmVjdGFibGVPYnNlcnZhYmxlPExpZmVjeWNsZUV2ZW50PikuY29ubmVjdCgpO1xuICAgICAgY29uc3QgaXRlbVRvSW5zZXJ0ID0gdGhpcy5yb290Q29udGFpbmVyLmlzQm9vdHN0cmFwcGVkKCkgPyBpdGVtIDogdGhpcy5maWx0ZXJJdGVtKGl0ZW0pO1xuICAgICAgdGhpcy5yb290Q29udGFpbmVyLmluc2VydEl0ZW0oaXRlbVRvSW5zZXJ0LCBpdGVtTG9jYXRpb24pO1xuICAgICAgcmV0dXJuIGV2ZW50LnBpcGUodGFrZSgxKSwgbWFwVG8odHJ1ZSkpLnRvUHJvbWlzZSgpO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFVwZGF0ZSBmdW5jdGlvbiB3aWxsIGJlIGNhbGxlZCB3aGVuIHByb3BlcnRpZXMgYXJlIGNoYW5nZWQgZm9yXG4gICAqIG9uZSBvZiB0aGUgZXhpc3RpbmcgaXRlbXMgb24gYSBwYWdlLlxuICAgKiBAcGFyYW0gaXRlbSBVcGRhdGVkIGl0ZW1cbiAgICogQHBhcmFtIGl0ZW1Mb2NhdGlvbiBMb2NhdGlvbiBvZiB0aGUgaXRlbVxuICAgKiBAcGFyYW0gY2hhbmdlcyBPYmplY3Qgd2hpY2ggY29udGFpbnMgb25seSBjaGFuZ2VkIHByb3BlcnRpZXMgYW5kIHRoZWlyIHZhbHVlc1xuICAgKi9cbiAgdXBkYXRlKGl0ZW06IEl0ZW0sIF86IEl0ZW1Mb2NhdGlvbiwgaXRlbVByb3BlcnRpZXM6IFBhcnRpYWw8UHJvcGVydGllcz4pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICByZXR1cm4gdGhpcy56b25lLnJ1bigoKSA9PiB7XG4gICAgICB0aGlzLnJvb3RDb250YWluZXIudXBkYXRlSXRlbShpdGVtLm5hbWUsIGl0ZW1Qcm9wZXJ0aWVzKTtcbiAgICAgIHJldHVybiB0aGlzLmxpZmVDeWNsZS5mcm9tSXRlbShpdGVtLm5hbWUpLnBpcGUodGFrZSgxKSwgbWFwVG8odW5kZWZpbmVkKSkudG9Qcm9taXNlKCk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlIGZ1bmN0aW9uIHdpbGwgYmUgY2FsbGVkIHdoZW4gZXhpc3RpbmcgaXRlbSBpcyByZW1vdmVkIGZyb20gdGhlIHBhZ2UuXG4gICAqIEBwYXJhbSBpdGVtIEl0ZW0gdG8gcmVtb3ZlXG4gICAqIEBwYXJhbSBpdGVtTG9jYXRpb24gTG9jYXRpb24gb2YgdGhlIGl0ZW1cbiAgICovXG4gIHJlbW92ZShpdGVtOiBJdGVtLCBpdGVtTG9jYXRpb246IEl0ZW1Mb2NhdGlvbik6IFByb21pc2U8dm9pZD4ge1xuICAgIHJldHVybiB0aGlzLnpvbmUucnVuKCgpID0+IHtcbiAgICAgIHRoaXMucm9vdENvbnRhaW5lci5yZW1vdmVJdGVtKGl0ZW0ubmFtZSwgaXRlbUxvY2F0aW9uKTtcbiAgICAgIHJldHVybiB0aGlzLmxpZmVDeWNsZS53aGVuUmVtb3ZlKCkucGlwZShkZWJvdW5jZVRpbWUoMjApLCB0YWtlKDEpLCBtYXBUbyh1bmRlZmluZWQpKS50b1Byb21pc2UoKTtcbiAgICB9KTtcbiAgfVxufVxuIl19