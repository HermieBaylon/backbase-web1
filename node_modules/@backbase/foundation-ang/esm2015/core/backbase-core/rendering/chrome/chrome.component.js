import { Component, HostBinding, Input, ViewChild, ViewContainerRef, } from '@angular/core';
import { ItemLifecycleService } from '../item-lifecycle.service';
import { ItemInjectorService } from '../item-injector.service';
import { ReplaySubject, Subject } from 'rxjs';
import { shareReplay, takeUntil, pairwise, startWith, withLatestFrom, last, switchMap, map } from 'rxjs/operators';
import { ItemLoaderService } from '../item-loader.service';
import { CombinedComponentFactoryResolver } from '../combined-component-factory-resolver';
/**
 * ChromeComponent represents "chrome element" and
 * implements dynamic components rendering
 */
export class ChromeComponent {
    /**
     * ChromeComponent constructor
     * @param componentFactoryResolver Factory which allows chrome component to resolve items
     * @param injectors Injectors map
     * @param components Components Registry Service
     */
    constructor(itemLifecycle, itemInjector, itemLoader, componentFactoryLoader) {
        this.itemLifecycle = itemLifecycle;
        this.itemInjector = itemInjector;
        this.itemLoader = itemLoader;
        this.componentFactoryLoader = componentFactoryLoader;
        this.gc$ = new Subject();
        this.itemValue = new ReplaySubject(1);
        this.component$ = this.itemValue.pipe(switchMap(item => this.createComponent(item)), shareReplay(1));
        this.componentItemModelTuple = this.component$.pipe(withLatestFrom(this.itemValue), map(([ref, item]) => ref === undefined ? [undefined, undefined] : [ref, item]), startWith([undefined, undefined]));
    }
    /**
     * Setter (Input) for an item to be bootstrapped
     * @param item Actual item to be bootstrapped
     */
    set item(item) {
        this.name = item.value.name;
        this.itemValue.next(item);
    }
    ngOnInit() {
        // Insert component on create
        this.componentItemModelTuple
            .pipe(pairwise(), takeUntil(this.gc$))
            .subscribe(([[oldComponent, oldItemValue], [component, item]]) => {
            if (!this.vcRef || !component || !item) {
                return;
            }
            if (oldComponent && oldItemValue) {
                this.itemLifecycle.onRemove(oldItemValue, oldComponent);
            }
            this.vcRef.clear();
            this.vcRef.insert(component.hostView);
            this.itemLifecycle.onCreate(item, component);
            component.changeDetectorRef.markForCheck();
        });
    }
    ngOnDestroy() {
        // Cleanup on destroy
        this.componentItemModelTuple.pipe(takeUntil(this.gc$), last()).subscribe(([component, item]) => {
            if (item && component) {
                this.itemLifecycle.onRemove(item, component);
            }
        });
        this.gc$.next();
        this.gc$.complete();
    }
    /**
     * inner helper function which creates components
     * @param item item to be created
     */
    createComponent(item) {
        return this.itemLoader
            .loadComponent(item.value.ɵclassId)
            .then(() => this.componentFactoryLoader.resolveComponentFactory(item.value.ɵclassId))
            .then(componentFactory => {
            // FIXME: @deprecated parentInjector (no replacement)
            const injector = this.itemInjector.createInjector(this.vcRef && this.vcRef.parentInjector, item);
            // Create the component
            return componentFactory.create(injector);
        });
    }
}
ChromeComponent.decorators = [
    { type: Component, args: [{
                selector: 'bb-chrome',
                template: ` <ng-container #vc></ng-container> `
            },] }
];
ChromeComponent.ctorParameters = () => [
    { type: ItemLifecycleService },
    { type: ItemInjectorService },
    { type: ItemLoaderService },
    { type: CombinedComponentFactoryResolver }
];
ChromeComponent.propDecorators = {
    vcRef: [{ type: ViewChild, args: ['vc', { read: ViewContainerRef, static: true },] }],
    name: [{ type: HostBinding, args: ['attr.data-chrome',] }],
    item: [{ type: Input }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hyb21lLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL2JhY2tiYXNlL2ZvdW5kYXRpb24tYW5nL2NvcmUvc3JjL2JhY2tiYXNlLWNvcmUvcmVuZGVyaW5nL2Nocm9tZS9jaHJvbWUuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTCxTQUFTLEVBRVQsV0FBVyxFQUNYLEtBQUssRUFDTCxTQUFTLEVBQ1QsZ0JBQWdCLEdBR2pCLE1BQU0sZUFBZSxDQUFDO0FBSXZCLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQ2pFLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQy9ELE9BQU8sRUFBRSxhQUFhLEVBQWMsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzFELE9BQU8sRUFBRSxXQUFXLEVBQUUsU0FBUyxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsY0FBYyxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDbkgsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDM0QsT0FBTyxFQUFFLGdDQUFnQyxFQUFFLE1BQU0sd0NBQXdDLENBQUM7QUFJMUY7OztHQUdHO0FBS0gsTUFBTSxPQUFPLGVBQWU7SUFzQzFCOzs7OztPQUtHO0lBQ0gsWUFDbUIsYUFBbUMsRUFDbkMsWUFBaUMsRUFDakMsVUFBNkIsRUFDN0Isc0JBQXdEO1FBSHhELGtCQUFhLEdBQWIsYUFBYSxDQUFzQjtRQUNuQyxpQkFBWSxHQUFaLFlBQVksQ0FBcUI7UUFDakMsZUFBVSxHQUFWLFVBQVUsQ0FBbUI7UUFDN0IsMkJBQXNCLEdBQXRCLHNCQUFzQixDQUFrQztRQXpDMUQsUUFBRyxHQUFHLElBQUksT0FBTyxFQUFRLENBQUM7UUFDMUIs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QUFDLHNCQUFzQixDQUFDLHVCQUF1QixDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUM7YUFDcEYsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEVBQUU7WUFDdkIscURBQXFEO1lBQ3JELE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxLQUFLLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxjQUFjLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFFakcsdUJBQXVCO1lBQ3ZCLE9BQU8sZ0JBQWdCLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQzNDLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQzs7O1lBckdGLFNBQVMsU0FBQztnQkFDVCxRQUFRLEVBQUUsV0FBVztnQkFDckIsUUFBUSxFQUFFLHFDQUFxQzthQUNoRDs7O1lBaEJRLG9CQUFvQjtZQUNwQixtQkFBbUI7WUFHbkIsaUJBQWlCO1lBQ2pCLGdDQUFnQzs7O29CQWdCdEMsU0FBUyxTQUFDLElBQUksRUFBRSxFQUFFLElBQUksRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFO21CQXNCeEQsV0FBVyxTQUFDLGtCQUFrQjttQkFNOUIsS0FBSyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENvbXBvbmVudCxcbiAgQ29tcG9uZW50UmVmLFxuICBIb3N0QmluZGluZyxcbiAgSW5wdXQsXG4gIFZpZXdDaGlsZCxcbiAgVmlld0NvbnRhaW5lclJlZixcbiAgT25Jbml0LFxuICBPbkRlc3Ryb3ksXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG5pbXBvcnQgeyBJdGVtTW9kZWwgfSBmcm9tICcuLi8uLi9tb2RlbHMvaXRlbS1tb2RlbCc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlVHJlZSB9IGZyb20gJy4uLy4uL21vZGVscy90cmVlJztcbmltcG9ydCB7IEl0ZW1MaWZlY3ljbGVTZXJ2aWNlIH0gZnJvbSAnLi4vaXRlbS1saWZlY3ljbGUuc2VydmljZSc7XG5pbXBvcnQgeyBJdGVtSW5qZWN0b3JTZXJ2aWNlIH0gZnJvbSAnLi4vaXRlbS1pbmplY3Rvci5zZXJ2aWNlJztcbmltcG9ydCB7IFJlcGxheVN1YmplY3QsIE9ic2VydmFibGUsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IHNoYXJlUmVwbGF5LCB0YWtlVW50aWwsIHBhaXJ3aXNlLCBzdGFydFdpdGgsIHdpdGhMYXRlc3RGcm9tLCBsYXN0LCBzd2l0Y2hNYXAsIG1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEl0ZW1Mb2FkZXJTZXJ2aWNlIH0gZnJvbSAnLi4vaXRlbS1sb2FkZXIuc2VydmljZSc7XG5pbXBvcnQgeyBDb21iaW5lZENvbXBvbmVudEZhY3RvcnlSZXNvbHZlciB9IGZyb20gJy4uL2NvbWJpbmVkLWNvbXBvbmVudC1mYWN0b3J5LXJlc29sdmVyJztcblxuZXhwb3J0IHR5cGUgQ29tcG9uZW50SXRlbU1vZGVsVHVwbGUgPSBbQ29tcG9uZW50UmVmPGFueT4sIE9ic2VydmFibGVUcmVlPEl0ZW1Nb2RlbD5dO1xuXG4vKipcbiAqIENocm9tZUNvbXBvbmVudCByZXByZXNlbnRzIFwiY2hyb21lIGVsZW1lbnRcIiBhbmRcbiAqIGltcGxlbWVudHMgZHluYW1pYyBjb21wb25lbnRzIHJlbmRlcmluZ1xuICovXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdiYi1jaHJvbWUnLFxuICB0ZW1wbGF0ZTogYCA8bmctY29udGFpbmVyICN2Yz48L25nLWNvbnRhaW5lcj4gYCxcbn0pXG5leHBvcnQgY2xhc3MgQ2hyb21lQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3kge1xuICAvKipcbiAgICogUmVwcmVzZW50cyBhIGNvbnRhaW5lciB3aGVyZSBWaWV3IGNhbiBiZSBhdHRhY2hlZFxuICAgKi9cbiAgQFZpZXdDaGlsZCgndmMnLCB7IHJlYWQ6IFZpZXdDb250YWluZXJSZWYsIHN0YXRpYzogdHJ1ZSB9KVxuICB2Y1JlZjogVmlld0NvbnRhaW5lclJlZiB8IHVuZGVmaW5lZDtcblxuICBwcml2YXRlIHJlYWRvbmx5IGdjJCA9IG5ldyBTdWJqZWN0PHZvaWQ+KCk7XG4gIHByaXZhdGUgcmVhZG9ubHkgaXRlbVZhbHVlID0gbmV3IFJlcGxheVN1YmplY3Q8T2JzZXJ2YWJsZVRyZWU8SXRlbU1vZGVsPj4oMSk7XG4gIHByaXZhdGUgcmVhZG9ubHkgY29tcG9uZW50JDogT2JzZXJ2YWJsZTxDb21wb25lbnRSZWY8YW55Pj4gPSB0aGlzLml0ZW1WYWx1ZS5waXBlKFxuICAgIHN3aXRjaE1hcChpdGVtID0+IHRoaXMuY3JlYXRlQ29tcG9uZW50KGl0ZW0pKSxcbiAgICBzaGFyZVJlcGxheSgxKSxcbiAgKTtcbiAgcHJpdmF0ZSByZWFkb25seSBjb21wb25lbnRJdGVtTW9kZWxUdXBsZTogT2JzZXJ2YWJsZTxcbiAgICBDb21wb25lbnRJdGVtTW9kZWxUdXBsZSB8IFt1bmRlZmluZWQsIHVuZGVmaW5lZF1cbiAgPiA9IHRoaXMuY29tcG9uZW50JC5waXBlKFxuICAgIHdpdGhMYXRlc3RGcm9tKHRoaXMuaXRlbVZhbHVlKSxcbiAgICBtYXAoKFtyZWYsIGl0ZW1dKTogQ29tcG9uZW50SXRlbU1vZGVsVHVwbGUgfCBbdW5kZWZpbmVkLCB1bmRlZmluZWRdID0+XG4gICAgICByZWYgPT09IHVuZGVmaW5lZCA/IFt1bmRlZmluZWQsIHVuZGVmaW5lZF0gOiBbcmVmLCBpdGVtXSxcbiAgICApLFxuICAgIHN0YXJ0V2l0aDxDb21wb25lbnRJdGVtTW9kZWxUdXBsZSB8IFt1bmRlZmluZWQsIHVuZGVmaW5lZF0+KFt1bmRlZmluZWQsIHVuZGVmaW5lZF0pLFxuICApO1xuXG4gIC8qKlxuICAgKiBkYXRhLWNocm9tZSBhdHRyaWJ1dGUgaW5zdHJ1Y3RzIENYUCB0byB1c2UgdGhpcyBjb21wb25lbnQgYXMgZHJvcCB0YXJnZXQgYXJlYVxuICAgKi9cbiAgQEhvc3RCaW5kaW5nKCdhdHRyLmRhdGEtY2hyb21lJykgbmFtZTogc3RyaW5nIHwgdW5kZWZpbmVkO1xuXG4gIC8qKlxuICAgKiBTZXR0ZXIgKElucHV0KSBmb3IgYW4gaXRlbSB0byBiZSBib290c3RyYXBwZWRcbiAgICogQHBhcmFtIGl0ZW0gQWN0dWFsIGl0ZW0gdG8gYmUgYm9vdHN0cmFwcGVkXG4gICAqL1xuICBASW5wdXQoKVxuICBzZXQgaXRlbShpdGVtOiBPYnNlcnZhYmxlVHJlZTxJdGVtTW9kZWw+KSB7XG4gICAgdGhpcy5uYW1lID0gaXRlbS52YWx1ZS5uYW1lO1xuICAgIHRoaXMuaXRlbVZhbHVlLm5leHQoaXRlbSk7XG4gIH1cblxuICAvKipcbiAgICogQ2hyb21lQ29tcG9uZW50IGNvbnN0cnVjdG9yXG4gICAqIEBwYXJhbSBjb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIgRmFjdG9yeSB3aGljaCBhbGxvd3MgY2hyb21lIGNvbXBvbmVudCB0byByZXNvbHZlIGl0ZW1zXG4gICAqIEBwYXJhbSBpbmplY3RvcnMgSW5qZWN0b3JzIG1hcFxuICAgKiBAcGFyYW0gY29tcG9uZW50cyBDb21wb25lbnRzIFJlZ2lzdHJ5IFNlcnZpY2VcbiAgICovXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgaXRlbUxpZmVjeWNsZTogSXRlbUxpZmVjeWNsZVNlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSBpdGVtSW5qZWN0b3I6IEl0ZW1JbmplY3RvclNlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSBpdGVtTG9hZGVyOiBJdGVtTG9hZGVyU2VydmljZSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNvbXBvbmVudEZhY3RvcnlMb2FkZXI6IENvbWJpbmVkQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLFxuICApIHt9XG5cbiAgbmdPbkluaXQoKSB7XG4gICAgLy8gSW5zZXJ0IGNvbXBvbmVudCBvbiBjcmVhdGVcbiAgICB0aGlzLmNvbXBvbmVudEl0ZW1Nb2RlbFR1cGxlXG4gICAgICAucGlwZShwYWlyd2lzZSgpLCB0YWtlVW50aWwodGhpcy5nYyQpKVxuICAgICAgLnN1YnNjcmliZSgoW1tvbGRDb21wb25lbnQsIG9sZEl0ZW1WYWx1ZV0sIFtjb21wb25lbnQsIGl0ZW1dXSkgPT4ge1xuICAgICAgICBpZiAoIXRoaXMudmNSZWYgfHwgIWNvbXBvbmVudCB8fCAhaXRlbSkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBpZiAob2xkQ29tcG9uZW50ICYmIG9sZEl0ZW1WYWx1ZSkge1xuICAgICAgICAgIHRoaXMuaXRlbUxpZmVjeWNsZS5vblJlbW92ZShvbGRJdGVtVmFsdWUsIG9sZENvbXBvbmVudCk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnZjUmVmLmNsZWFyKCk7XG4gICAgICAgIHRoaXMudmNSZWYuaW5zZXJ0KGNvbXBvbmVudC5ob3N0Vmlldyk7XG4gICAgICAgIHRoaXMuaXRlbUxpZmVjeWNsZS5vbkNyZWF0ZShpdGVtLCBjb21wb25lbnQpO1xuICAgICAgICBjb21wb25lbnQuY2hhbmdlRGV0ZWN0b3JSZWYubWFya0ZvckNoZWNrKCk7XG4gICAgICB9KTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIC8vIENsZWFudXAgb24gZGVzdHJveVxuICAgIHRoaXMuY29tcG9uZW50SXRlbU1vZGVsVHVwbGUucGlwZSh0YWtlVW50aWwodGhpcy5nYyQpLCBsYXN0KCkpLnN1YnNjcmliZSgoW2NvbXBvbmVudCwgaXRlbV0pID0+IHtcbiAgICAgIGlmIChpdGVtICYmIGNvbXBvbmVudCkge1xuICAgICAgICB0aGlzLml0ZW1MaWZlY3ljbGUub25SZW1vdmUoaXRlbSwgY29tcG9uZW50KTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHRoaXMuZ2MkLm5leHQoKTtcbiAgICB0aGlzLmdjJC5jb21wbGV0ZSgpO1xuICB9XG5cbiAgLyoqXG4gICAqIGlubmVyIGhlbHBlciBmdW5jdGlvbiB3aGljaCBjcmVhdGVzIGNvbXBvbmVudHNcbiAgICogQHBhcmFtIGl0ZW0gaXRlbSB0byBiZSBjcmVhdGVkXG4gICAqL1xuICBwcml2YXRlIGNyZWF0ZUNvbXBvbmVudChpdGVtOiBPYnNlcnZhYmxlVHJlZTxJdGVtTW9kZWw+KTogUHJvbWlzZTxDb21wb25lbnRSZWY8YW55Pj4ge1xuICAgIHJldHVybiB0aGlzLml0ZW1Mb2FkZXJcbiAgICAgIC5sb2FkQ29tcG9uZW50KGl0ZW0udmFsdWUuybVjbGFzc0lkKVxuICAgICAgLnRoZW4oKCkgPT4gdGhpcy5jb21wb25lbnRGYWN0b3J5TG9hZGVyLnJlc29sdmVDb21wb25lbnRGYWN0b3J5KGl0ZW0udmFsdWUuybVjbGFzc0lkKSlcbiAgICAgIC50aGVuKGNvbXBvbmVudEZhY3RvcnkgPT4ge1xuICAgICAgICAvLyBGSVhNRTogQGRlcHJlY2F0ZWQgcGFyZW50SW5qZWN0b3IgKG5vIHJlcGxhY2VtZW50KVxuICAgICAgICBjb25zdCBpbmplY3RvciA9IHRoaXMuaXRlbUluamVjdG9yLmNyZWF0ZUluamVjdG9yKHRoaXMudmNSZWYgJiYgdGhpcy52Y1JlZi5wYXJlbnRJbmplY3RvciwgaXRlbSk7XG5cbiAgICAgICAgLy8gQ3JlYXRlIHRoZSBjb21wb25lbnRcbiAgICAgICAgcmV0dXJuIGNvbXBvbmVudEZhY3RvcnkuY3JlYXRlKGluamVjdG9yKTtcbiAgICAgIH0pO1xuICB9XG59XG4iXX0=