import { Injectable } from '@angular/core';
import { serializerDeserializer } from '@backbase/communication-property';
import { BehaviorSubject, Subject, of as observableOf, merge, combineLatest } from 'rxjs';
import { map, filter, pluck, shareReplay, switchMap } from 'rxjs/operators';
import { isContainer } from './item-model-utils';
import { ItemModel } from '../models/item-model';
import { ObservableTree } from '../models/tree';
import * as i0 from "@angular/core";
export const ROOT_COMPONENT_CLASS_ID = 'RootComponent';
const DEFAULT_ROOT_NAME = 'bb-root-empty';
export const isInsert = (update) => !!(update.item && update.itemLocation);
export const isPropertyUpdate = (update) => !!(update.name && update.properties);
export const isRemovalUpdate = (update) => !!(update && 'parentName' in update && 'index' in update);
class CommunicationInputs {
    constructor(properties) {
        this.properties = properties;
    }
    static fromProperties(properties) {
        return new CommunicationInputs(new Map(Object.entries(properties)
            .filter((property) => typeof property[1] === 'string')
            .map(([propertyName, propertyValue]) => [propertyName, serializerDeserializer.fromProperty(propertyValue)])
            .filter((property) => property[1] !== undefined)));
    }
    hasInputFor(communicationDefinition) {
        return (Array.from(this.properties.values()).find(candidate => communicationDefinition.equals(candidate)) !== undefined);
    }
}
/**
 * The root container is basically the page model, but we don't assume that the
 * angular app is the entire page. It could just be a subset of the page model,
 * hence we call it "root container"
 *
 * @internal
 */
export class ӨRootContainerService {
    constructor() {
        // The websdk commands mapped to observables.
        this.propertyUpdates = new Subject();
        this.inserts = new Subject();
        this.removals = new Subject();
        this.modelUpdates = merge(this.propertyUpdates, this.inserts, this.removals);
        this.defaultValue = {
            name: DEFAULT_ROOT_NAME,
            properties: { classId: ROOT_COMPONENT_CLASS_ID },
            children: [],
        };
        this.rootContainerItem = new BehaviorSubject(this.defaultValue);
        this.model = this.rootContainerItem.pipe(filter(container => !this.isDefaultContainer(container.name)), // skip the empty state
        map(c => this.createInitialModelState(c)), shareReplay(1));
    }
    createInitialModelState({ name, properties, children }) {
        const initialRootContainerProperties = Object.assign(Object.assign({}, properties), { classId: ROOT_COMPONENT_CLASS_ID });
        return this.createModelStateNode({
            name,
            properties: initialRootContainerProperties,
            children,
        });
    }
    createModelStateNode(item) {
        // Filter property updates to just the updates for this item.
        const propertyUpdates = this.propertyUpdates.pipe(filter(update => update.name === item.name), pluck('properties'));
        // Recursively create the children.
        const childNodes = isContainer(item)
            ? item.children.map(this.createModelStateNode.bind(this))
            : [];
        let insertions;
        let removals;
        if (isContainer(item)) {
            // Filter container updates for this item (inserts and removes)
            insertions = this.inserts.pipe(filter(insert => !!insert.itemLocation && insert.itemLocation.parentName === item.name), map(insert => ({
                item: this.createModelStateNode(insert.item),
                index: insert.itemLocation ? insert.itemLocation.index : 0,
            })));
            removals = this.removals.pipe(filter((removal) => !!removal && removal.parentName === item.name), pluck('index'));
        }
        else {
            insertions = observableOf();
            removals = observableOf();
        }
        // Create the node itself.
        return new ObservableTree(new ItemModel(item.name, item.properties, propertyUpdates), childNodes, insertions, removals);
    }
    get rootName() {
        return this.rootContainerItem.getValue().name;
    }
    isDefaultContainer(name) {
        return name === DEFAULT_ROOT_NAME;
    }
    isBootstrapped() {
        return !this.isDefaultContainer(this.rootName);
    }
    updateItem(name, properties) {
        this.propertyUpdates.next({ name, properties: properties });
    }
    insertItem(item, itemLocation) {
        if (!this.isBootstrapped()) {
            this.rootContainerItem.next(item);
        }
        else {
            this.inserts.next({ item, itemLocation });
        }
    }
    removeItem(itemName, itemLocation) {
        if (this.rootName === itemName) {
            this.rootContainerItem.next(this.defaultValue);
        }
        else {
            this.removals.next(itemLocation);
        }
    }
    filter(predicate) {
        return this.model.pipe(switchMap(model => model.filter(predicate)));
    }
    getCommunicationGroupItems(groupDefinition) {
        return this.filter((item) => CommunicationInputs.fromProperties(item.ɵinputProperties).hasInputFor(groupDefinition)).pipe(map(nodes => nodes.map(node => node.value)));
    }
    // The only case where there will not be a common ancestor (i.e. return `undefined`) is if there are
    // no items with inputs in the communication group.
    commonAncestor(groupDefinition) {
        return combineLatest([
            this.model.pipe(switchMap(model => model.toTree())),
            this.getCommunicationGroupItems(groupDefinition),
        ]).pipe(map(([tree, [first, ...items]]) => {
            let lowest = first;
            for (const item of items) {
                const newLowest = tree.lowestCommonAncestor(lowest, item);
                if (newLowest === undefined) {
                    return undefined;
                }
                else {
                    lowest = newLowest;
                }
            }
            return lowest;
        }));
    }
}
ӨRootContainerService.ɵprov = i0.ɵɵdefineInjectable({ factory: function ӨRootContainerService_Factory() { return new ӨRootContainerService(); }, token: ӨRootContainerService, providedIn: "root" });
ӨRootContainerService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root',
            },] }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm9vdC1jb250YWluZXIuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL2JhY2tiYXNlL2ZvdW5kYXRpb24tYW5nL2NvcmUvc3JjL2JhY2tiYXNlLWNvcmUvbW9kZWxzL3Jvb3QtY29udGFpbmVyLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQTJCLHNCQUFzQixFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFDbkcsT0FBTyxFQUFjLGVBQWUsRUFBRSxPQUFPLEVBQUUsRUFBRSxJQUFJLFlBQVksRUFBRSxLQUFLLEVBQUUsYUFBYSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3RHLE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxXQUFXLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFNUUsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ2pELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUNqRCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7O0FBRWhELE1BQU0sQ0FBQyxNQUFNLHVCQUF1QixHQUFHLGVBQWUsQ0FBQztBQUN2RCxNQUFNLGlCQUFpQixHQUFHLGVBQWUsQ0FBQztBQWExQyxNQUFNLENBQUMsTUFBTSxRQUFRLEdBQUcsQ0FBQyxNQUFtQixFQUEwQixFQUFFLENBQ3RFLENBQUMsQ0FBQyxDQUFFLE1BQXVCLENBQUMsSUFBSSxJQUFLLE1BQXVCLENBQUMsWUFBWSxDQUFDLENBQUM7QUFFN0UsTUFBTSxDQUFDLE1BQU0sZ0JBQWdCLEdBQUcsQ0FBQyxNQUFtQixFQUE0QixFQUFFLENBQ2hGLENBQUMsQ0FBQyxDQUFFLE1BQXlCLENBQUMsSUFBSSxJQUFLLE1BQXlC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QyxFQUFFLEVBQUU7WUFDaEMsSUFBSSxNQUFNLEdBQTBCLEtBQUssQ0FBQztZQUMxQyxLQUFLLE1BQU0sSUFBSSxJQUFJLEtBQUssRUFBRTtnQkFDeEIsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLG9CQUFvQixDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQztnQkFDMUQsSUFBSSxTQUFTLEtBQUssU0FBUyxFQUFFO29CQUMzQixPQUFPLFNBQVMsQ0FBQztpQkFDbEI7cUJBQU07b0JBQ0wsTUFBTSxHQUFHLFNBQVMsQ0FBQztpQkFDcEI7YUFDRjtZQUNELE9BQU8sTUFBTSxDQUFDO1FBQ2hCLENBQUMsQ0FBQyxDQUNILENBQUM7SUFDSixDQUFDOzs7O1lBakpGLFVBQVUsU0FBQztnQkFDVixVQUFVLEVBQUUsTUFBTTthQUNuQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IENvbW11bmljYXRpb25EZWZpbml0aW9uLCBzZXJpYWxpemVyRGVzZXJpYWxpemVyIH0gZnJvbSAnQGJhY2tiYXNlL2NvbW11bmljYXRpb24tcHJvcGVydHknO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgQmVoYXZpb3JTdWJqZWN0LCBTdWJqZWN0LCBvZiBhcyBvYnNlcnZhYmxlT2YsIG1lcmdlLCBjb21iaW5lTGF0ZXN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBtYXAsIGZpbHRlciwgcGx1Y2ssIHNoYXJlUmVwbGF5LCBzd2l0Y2hNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBJdGVtTG9jYXRpb24sIEl0ZW0sIFByb3BlcnRpZXMsIENvbnRhaW5lciB9IGZyb20gJ0BiYWNrYmFzZS9mb3VuZGF0aW9uLWFuZy93ZWItc2RrJztcbmltcG9ydCB7IGlzQ29udGFpbmVyIH0gZnJvbSAnLi9pdGVtLW1vZGVsLXV0aWxzJztcbmltcG9ydCB7IEl0ZW1Nb2RlbCB9IGZyb20gJy4uL21vZGVscy9pdGVtLW1vZGVsJztcbmltcG9ydCB7IE9ic2VydmFibGVUcmVlIH0gZnJvbSAnLi4vbW9kZWxzL3RyZWUnO1xuXG5leHBvcnQgY29uc3QgUk9PVF9DT01QT05FTlRfQ0xBU1NfSUQgPSAnUm9vdENvbXBvbmVudCc7XG5jb25zdCBERUZBVUxUX1JPT1RfTkFNRSA9ICdiYi1yb290LWVtcHR5JztcblxuZXhwb3J0IGludGVyZmFjZSBJbnNlcnRVcGRhdGUge1xuICBpdGVtOiBJdGVtO1xuICBpdGVtTG9jYXRpb246IEl0ZW1Mb2NhdGlvbjtcbn1cbmV4cG9ydCBpbnRlcmZhY2UgUHJvcGVydHlVcGRhdGUge1xuICBuYW1lOiBzdHJpbmc7XG4gIHByb3BlcnRpZXM6IFByb3BlcnRpZXM7XG59XG5leHBvcnQgdHlwZSBSZW1vdmFsVXBkYXRlID0gSXRlbUxvY2F0aW9uO1xuZXhwb3J0IHR5cGUgTW9kZWxVcGRhdGUgPSBJbnNlcnRVcGRhdGUgfCBQcm9wZXJ0eVVwZGF0ZSB8IFJlbW92YWxVcGRhdGU7XG5cbmV4cG9ydCBjb25zdCBpc0luc2VydCA9ICh1cGRhdGU6IE1vZGVsVXBkYXRlKTogdXBkYXRlIGlzIEluc2VydFVwZGF0ZSA9PlxuICAhISgodXBkYXRlIGFzIEluc2VydFVwZGF0ZSkuaXRlbSAmJiAodXBkYXRlIGFzIEluc2VydFVwZGF0ZSkuaXRlbUxvY2F0aW9uKTtcblxuZXhwb3J0IGNvbnN0IGlzUHJvcGVydHlVcGRhdGUgPSAodXBkYXRlOiBNb2RlbFVwZGF0ZSk6IHVwZGF0ZSBpcyBQcm9wZXJ0eVVwZGF0ZSA9PlxuICAhISgodXBkYXRlIGFzIFByb3BlcnR5VXBkYXRlKS5uYW1lICYmICh1cGRhdGUgYXMgUHJvcGVydHlVcGRhdGUpLnByb3BlcnRpZXMpO1xuXG5leHBvcnQgY29uc3QgaXNSZW1vdmFsVXBkYXRlID0gKHVwZGF0ZTogTW9kZWxVcGRhdGUpOiB1cGRhdGUgaXMgRXhjbHVkZTxSZW1vdmFsVXBkYXRlLCB1bmRlZmluZWQ+ID0+XG4gICEhKHVwZGF0ZSAmJiAncGFyZW50TmFtZScgaW4gdXBkYXRlICYmICdpbmRleCcgaW4gdXBkYXRlKTtcblxuY2xhc3MgQ29tbXVuaWNhdGlvbklucHV0cyB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgcHJvcGVydGllczogTWFwPHN0cmluZywgQ29tbXVuaWNhdGlvbkRlZmluaXRpb24+KSB7fVxuXG4gIHN0YXRpYyBmcm9tUHJvcGVydGllcyhwcm9wZXJ0aWVzOiBQcm9wZXJ0aWVzKTogQ29tbXVuaWNhdGlvbklucHV0cyB7XG4gICAgcmV0dXJuIG5ldyBDb21tdW5pY2F0aW9uSW5wdXRzKFxuICAgICAgbmV3IE1hcChcbiAgICAgICAgT2JqZWN0LmVudHJpZXMocHJvcGVydGllcylcbiAgICAgICAgICAuZmlsdGVyKChwcm9wZXJ0eSk6IHByb3BlcnR5IGlzIFtzdHJpbmcsIHN0cmluZ10gPT4gdHlwZW9mIHByb3BlcnR5WzFdID09PSAnc3RyaW5nJylcbiAgICAgICAgICAubWFwKChbcHJvcGVydHlOYW1lLCBwcm9wZXJ0eVZhbHVlXSkgPT4gW3Byb3BlcnR5TmFtZSwgc2VyaWFsaXplckRlc2VyaWFsaXplci5mcm9tUHJvcGVydHkocHJvcGVydHlWYWx1ZSldKVxuICAgICAgICAgIC5maWx0ZXIoKHByb3BlcnR5KTogcHJvcGVydHkgaXMgW3N0cmluZywgQ29tbXVuaWNhdGlvbkRlZmluaXRpb25dID0+IHByb3BlcnR5WzFdICE9PSB1bmRlZmluZWQpLFxuICAgICAgKSxcbiAgICApO1xuICB9XG5cbiAgaGFzSW5wdXRGb3IoY29tbXVuaWNhdGlvbkRlZmluaXRpb246IENvbW11bmljYXRpb25EZWZpbml0aW9uKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIChcbiAgICAgIEFycmF5LmZyb20odGhpcy5wcm9wZXJ0aWVzLnZhbHVlcygpKS5maW5kKGNhbmRpZGF0ZSA9PiBjb21tdW5pY2F0aW9uRGVmaW5pdGlvbi5lcXVhbHMoY2FuZGlkYXRlKSkgIT09IHVuZGVmaW5lZFxuICAgICk7XG4gIH1cbn1cblxuLyoqXG4gKiBUaGUgcm9vdCBjb250YWluZXIgaXMgYmFzaWNhbGx5IHRoZSBwYWdlIG1vZGVsLCBidXQgd2UgZG9uJ3QgYXNzdW1lIHRoYXQgdGhlXG4gKiBhbmd1bGFyIGFwcCBpcyB0aGUgZW50aXJlIHBhZ2UuIEl0IGNvdWxkIGp1c3QgYmUgYSBzdWJzZXQgb2YgdGhlIHBhZ2UgbW9kZWwsXG4gKiBoZW5jZSB3ZSBjYWxsIGl0IFwicm9vdCBjb250YWluZXJcIlxuICpcbiAqIEBpbnRlcm5hbFxuICovXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290Jyxcbn0pXG5leHBvcnQgY2xhc3Mg06hSb290Q29udGFpbmVyU2VydmljZSB7XG4gIC8vIFRoZSB3ZWJzZGsgY29tbWFuZHMgbWFwcGVkIHRvIG9ic2VydmFibGVzLlxuICBwcml2YXRlIHJlYWRvbmx5IHByb3BlcnR5VXBkYXRlcyA9IG5ldyBTdWJqZWN0PFByb3BlcnR5VXBkYXRlPigpO1xuICBwcml2YXRlIHJlYWRvbmx5IGluc2VydHMgPSBuZXcgU3ViamVjdDxJbnNlcnRVcGRhdGU+KCk7XG4gIHByaXZhdGUgcmVhZG9ubHkgcmVtb3ZhbHMgPSBuZXcgU3ViamVjdDxSZW1vdmFsVXBkYXRlPigpO1xuXG4gIHB1YmxpYyByZWFkb25seSBtb2RlbFVwZGF0ZXM6IE9ic2VydmFibGU8TW9kZWxVcGRhdGU+ID0gbWVyZ2UodGhpcy5wcm9wZXJ0eVVwZGF0ZXMsIHRoaXMuaW5zZXJ0cywgdGhpcy5yZW1vdmFscyk7XG5cbiAgcHJpdmF0ZSByZWFkb25seSBkZWZhdWx0VmFsdWU6IENvbnRhaW5lciA9IHtcbiAgICBuYW1lOiBERUZBVUxUX1JPT1RfTkFNRSxcbiAgICBwcm9wZXJ0aWVzOiB7IGNsYXNzSWQ6IFJPT1RfQ09NUE9ORU5UX0NMQVNTX0lEIH0sXG4gICAgY2hpbGRyZW46IFtdLFxuICB9O1xuXG4gIHByaXZhdGUgcmVhZG9ubHkgcm9vdENvbnRhaW5lckl0ZW0gPSBuZXcgQmVoYXZpb3JTdWJqZWN0PENvbnRhaW5lcj4odGhpcy5kZWZhdWx0VmFsdWUpO1xuXG4gIHB1YmxpYyBtb2RlbDogT2JzZXJ2YWJsZTxPYnNlcnZhYmxlVHJlZTxJdGVtTW9kZWw+PiA9IHRoaXMucm9vdENvbnRhaW5lckl0ZW0ucGlwZShcbiAgICBmaWx0ZXIoY29udGFpbmVyID0+ICF0aGlzLmlzRGVmYXVsdENvbnRhaW5lcihjb250YWluZXIubmFtZSkpLCAvLyBza2lwIHRoZSBlbXB0eSBzdGF0ZVxuICAgIG1hcChjID0+IHRoaXMuY3JlYXRlSW5pdGlhbE1vZGVsU3RhdGUoYykpLFxuICAgIHNoYXJlUmVwbGF5KDEpLFxuICApO1xuXG4gIHByaXZhdGUgY3JlYXRlSW5pdGlhbE1vZGVsU3RhdGUoeyBuYW1lLCBwcm9wZXJ0aWVzLCBjaGlsZHJlbiB9OiBDb250YWluZXIpOiBPYnNlcnZhYmxlVHJlZTxJdGVtTW9kZWw+IHtcbiAgICBjb25zdCBpbml0aWFsUm9vdENvbnRhaW5lclByb3BlcnRpZXMgPSB7XG4gICAgICAuLi5wcm9wZXJ0aWVzLFxuICAgICAgY2xhc3NJZDogUk9PVF9DT01QT05FTlRfQ0xBU1NfSUQsXG4gICAgfTtcbiAgICByZXR1cm4gdGhpcy5jcmVhdGVNb2RlbFN0YXRlTm9kZSh7XG4gICAgICBuYW1lLFxuICAgICAgcHJvcGVydGllczogaW5pdGlhbFJvb3RDb250YWluZXJQcm9wZXJ0aWVzLFxuICAgICAgY2hpbGRyZW4sXG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZU1vZGVsU3RhdGVOb2RlKGl0ZW06IEl0ZW0pOiBPYnNlcnZhYmxlVHJlZTxJdGVtTW9kZWw+IHtcbiAgICAvLyBGaWx0ZXIgcHJvcGVydHkgdXBkYXRlcyB0byBqdXN0IHRoZSB1cGRhdGVzIGZvciB0aGlzIGl0ZW0uXG4gICAgY29uc3QgcHJvcGVydHlVcGRhdGVzOiBPYnNlcnZhYmxlPFByb3BlcnRpZXM+ID0gdGhpcy5wcm9wZXJ0eVVwZGF0ZXMucGlwZShcbiAgICAgIGZpbHRlcih1cGRhdGUgPT4gdXBkYXRlLm5hbWUgPT09IGl0ZW0ubmFtZSksXG4gICAgICBwbHVjaygncHJvcGVydGllcycpLFxuICAgICk7XG5cbiAgICAvLyBSZWN1cnNpdmVseSBjcmVhdGUgdGhlIGNoaWxkcmVuLlxuICAgIGNvbnN0IGNoaWxkTm9kZXM6IEFycmF5PE9ic2VydmFibGVUcmVlPEl0ZW1Nb2RlbD4+ID0gaXNDb250YWluZXIoaXRlbSlcbiAgICAgID8gaXRlbS5jaGlsZHJlbi5tYXAodGhpcy5jcmVhdGVNb2RlbFN0YXRlTm9kZS5iaW5kKHRoaXMpKVxuICAgICAgOiBbXTtcblxuICAgIGxldCBpbnNlcnRpb25zOiBPYnNlcnZhYmxlPHtcbiAgICAgIGl0ZW06IE9ic2VydmFibGVUcmVlPEl0ZW1Nb2RlbD47XG4gICAgICBpbmRleDogbnVtYmVyO1xuICAgIH0+O1xuICAgIGxldCByZW1vdmFsczogT2JzZXJ2YWJsZTxudW1iZXI+O1xuXG4gICAgaWYgKGlzQ29udGFpbmVyKGl0ZW0pKSB7XG4gICAgICAvLyBGaWx0ZXIgY29udGFpbmVyIHVwZGF0ZXMgZm9yIHRoaXMgaXRlbSAoaW5zZXJ0cyBhbmQgcmVtb3ZlcylcbiAgICAgIGluc2VydGlvbnMgPSB0aGlzLmluc2VydHMucGlwZShcbiAgICAgICAgZmlsdGVyKGluc2VydCA9PiAhIWluc2VydC5pdGVtTG9jYXRpb24gJiYgaW5zZXJ0Lml0ZW1Mb2NhdGlvbi5wYXJlbnROYW1lID09PSBpdGVtLm5hbWUpLFxuICAgICAgICBtYXAoaW5zZXJ0ID0+ICh7XG4gICAgICAgICAgaXRlbTogdGhpcy5jcmVhdGVNb2RlbFN0YXRlTm9kZShpbnNlcnQuaXRlbSksXG4gICAgICAgICAgaW5kZXg6IGluc2VydC5pdGVtTG9jYXRpb24gPyBpbnNlcnQuaXRlbUxvY2F0aW9uLmluZGV4IDogMCxcbiAgICAgICAgfSkpLFxuICAgICAgKTtcblxuICAgICAgcmVtb3ZhbHMgPSB0aGlzLnJlbW92YWxzLnBpcGUoXG4gICAgICAgIGZpbHRlcigocmVtb3ZhbDogSXRlbUxvY2F0aW9uKTogYm9vbGVhbiA9PiAhIXJlbW92YWwgJiYgcmVtb3ZhbC5wYXJlbnROYW1lID09PSBpdGVtLm5hbWUpLFxuICAgICAgICBwbHVjaygnaW5kZXgnKSxcbiAgICAgICk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGluc2VydGlvbnMgPSBvYnNlcnZhYmxlT2YoKTtcbiAgICAgIHJlbW92YWxzID0gb2JzZXJ2YWJsZU9mKCk7XG4gICAgfVxuXG4gICAgLy8gQ3JlYXRlIHRoZSBub2RlIGl0c2VsZi5cbiAgICByZXR1cm4gbmV3IE9ic2VydmFibGVUcmVlPEl0ZW1Nb2RlbD4oXG4gICAgICBuZXcgSXRlbU1vZGVsKGl0ZW0ubmFtZSwgaXRlbS5wcm9wZXJ0aWVzLCBwcm9wZXJ0eVVwZGF0ZXMpLFxuICAgICAgY2hpbGROb2RlcyxcbiAgICAgIGluc2VydGlvbnMsXG4gICAgICByZW1vdmFscyxcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXQgcm9vdE5hbWUoKSB7XG4gICAgcmV0dXJuIHRoaXMucm9vdENvbnRhaW5lckl0ZW0uZ2V0VmFsdWUoKS5uYW1lO1xuICB9XG5cbiAgcHJpdmF0ZSBpc0RlZmF1bHRDb250YWluZXIobmFtZTogc3RyaW5nKSB7XG4gICAgcmV0dXJuIG5hbWUgPT09IERFRkFVTFRfUk9PVF9OQU1FO1xuICB9XG5cbiAgaXNCb290c3RyYXBwZWQoKSB7XG4gICAgcmV0dXJuICF0aGlzLmlzRGVmYXVsdENvbnRhaW5lcih0aGlzLnJvb3ROYW1lKTtcbiAgfVxuXG4gIHVwZGF0ZUl0ZW0obmFtZTogc3RyaW5nLCBwcm9wZXJ0aWVzOiBQYXJ0aWFsPFByb3BlcnRpZXM+KSB7XG4gICAgdGhpcy5wcm9wZXJ0eVVwZGF0ZXMubmV4dCh7IG5hbWUsIHByb3BlcnRpZXM6IHByb3BlcnRpZXMgYXMgUHJvcGVydGllcyB9KTtcbiAgfVxuXG4gIGluc2VydEl0ZW0oaXRlbTogSXRlbSwgaXRlbUxvY2F0aW9uOiBJdGVtTG9jYXRpb24pIHtcbiAgICBpZiAoIXRoaXMuaXNCb290c3RyYXBwZWQoKSkge1xuICAgICAgdGhpcy5yb290Q29udGFpbmVySXRlbS5uZXh0KGl0ZW0gYXMgQ29udGFpbmVyKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5pbnNlcnRzLm5leHQoeyBpdGVtLCBpdGVtTG9jYXRpb24gfSk7XG4gICAgfVxuICB9XG5cbiAgcmVtb3ZlSXRlbShpdGVtTmFtZTogc3RyaW5nLCBpdGVtTG9jYXRpb246IEl0ZW1Mb2NhdGlvbikge1xuICAgIGlmICh0aGlzLnJvb3ROYW1lID09PSBpdGVtTmFtZSkge1xuICAgICAgdGhpcy5yb290Q29udGFpbmVySXRlbS5uZXh0KHRoaXMuZGVmYXVsdFZhbHVlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5yZW1vdmFscy5uZXh0KGl0ZW1Mb2NhdGlvbik7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBmaWx0ZXIocHJlZGljYXRlOiAodmFsdWU6IEl0ZW1Nb2RlbCkgPT4gYm9vbGVhbik6IE9ic2VydmFibGU8QXJyYXk8T2JzZXJ2YWJsZVRyZWU8SXRlbU1vZGVsPj4+IHtcbiAgICByZXR1cm4gdGhpcy5tb2RlbC5waXBlKHN3aXRjaE1hcChtb2RlbCA9PiBtb2RlbC5maWx0ZXIocHJlZGljYXRlKSkpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRDb21tdW5pY2F0aW9uR3JvdXBJdGVtcyhncm91cERlZmluaXRpb246IENvbW11bmljYXRpb25EZWZpbml0aW9uKTogT2JzZXJ2YWJsZTxBcnJheTxJdGVtTW9kZWw+PiB7XG4gICAgcmV0dXJuIHRoaXMuZmlsdGVyKChpdGVtOiBJdGVtTW9kZWwpID0+XG4gICAgICBDb21tdW5pY2F0aW9uSW5wdXRzLmZyb21Qcm9wZXJ0aWVzKGl0ZW0uybVpbnB1dFByb3BlcnRpZXMpLmhhc0lucHV0Rm9yKGdyb3VwRGVmaW5pdGlvbiksXG4gICAgKS5waXBlKG1hcChub2RlcyA9PiBub2Rlcy5tYXAobm9kZSA9PiBub2RlLnZhbHVlKSkpO1xuICB9XG5cbiAgLy8gVGhlIG9ubHkgY2FzZSB3aGVyZSB0aGVyZSB3aWxsIG5vdCBiZSBhIGNvbW1vbiBhbmNlc3RvciAoaS5lLiByZXR1cm4gYHVuZGVmaW5lZGApIGlzIGlmIHRoZXJlIGFyZVxuICAvLyBubyBpdGVtcyB3aXRoIGlucHV0cyBpbiB0aGUgY29tbXVuaWNhdGlvbiBncm91cC5cbiAgY29tbW9uQW5jZXN0b3IoZ3JvdXBEZWZpbml0aW9uOiBDb21tdW5pY2F0aW9uRGVmaW5pdGlvbik6IE9ic2VydmFibGU8SXRlbU1vZGVsIHwgdW5kZWZpbmVkPiB7XG4gICAgcmV0dXJuIGNvbWJpbmVMYXRlc3QoW1xuICAgICAgdGhpcy5tb2RlbC5waXBlKHN3aXRjaE1hcChtb2RlbCA9PiBtb2RlbC50b1RyZWUoKSkpLFxuICAgICAgdGhpcy5nZXRDb21tdW5pY2F0aW9uR3JvdXBJdGVtcyhncm91cERlZmluaXRpb24pLFxuICAgIF0pLnBpcGUoXG4gICAgICBtYXAoKFt0cmVlLCBbZmlyc3QsIC4uLml0ZW1zXV0pID0+IHtcbiAgICAgICAgbGV0IGxvd2VzdDogSXRlbU1vZGVsIHwgdW5kZWZpbmVkID0gZmlyc3Q7XG4gICAgICAgIGZvciAoY29uc3QgaXRlbSBvZiBpdGVtcykge1xuICAgICAgICAgIGNvbnN0IG5ld0xvd2VzdCA9IHRyZWUubG93ZXN0Q29tbW9uQW5jZXN0b3IobG93ZXN0LCBpdGVtKTtcbiAgICAgICAgICBpZiAobmV3TG93ZXN0ID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGxvd2VzdCA9IG5ld0xvd2VzdDtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGxvd2VzdDtcbiAgICAgIH0pLFxuICAgICk7XG4gIH1cbn1cbiJdfQ==