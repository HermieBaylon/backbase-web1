import { ContentChildren, Directive, ElementRef, Input, Renderer2, Optional, } from '@angular/core';
import { RouterLinkDirective, RouterLinkWithHrefDirective } from './router-link.directive';
import { Router, NavigationEnd } from '@angular/router';
/**
 *
 * @description
 *
 * Lets you add a CSS class and `aria-current` attribute to an element when the link's route becomes active.
 *
 * This directive lets you add a CSS class and `aria-current` attribute to an element when the link's route
 * becomes active.
 *
 * Consider the following example:
 *
 * ```
 * <a bbRouterLink="/user/bob" bbRouterLinkActive="active-link">Bob</a>
 * ```
 *
 * When the url is either '/user' or '/user/bob', the active-link class will
 * be added to the `a` tag. If the url changes, the class Will be removed.
 *
 * You can set more than one class, as follows:
 *
 * ```
 * <a bbRouterLink="/user/bob" bbRouterLinkActive="class1 class2">Bob</a>
 * <a bbRouterLink="/user/bob" [bbRouterLinkActive]="['class1', 'class2']">Bob</a>
 * ```
 *
 * You can configure RouterLinkActive by passing `exact: true`. This will add the classes
 * only when the url matches the link exactly.
 *
 * ```
 * <a bbRouterLink="/user/bob" bbRouterLinkActive="active-link" [bbRouterLinkActiveOptions]="{exact:
 * true}">Bob</a>
 * ```
 *
 * You can configure RouterLinkActive to set `aria-current` attribute for all links. If option is defined,
 * value will be added to the active link and `aria-current="false"` to the other links.
 *
 * ```
 * <a bbRouterLink="/user/bob" bbRouterLinkActive="active-link" [bbRouterLinkActiveOptions]="{ariaCurrent: 'page'}">
 *  Bob
 * </a>
 * ```
 *
 * You can assign the RouterLinkActive instance to a template variable and directly check
 * the `isActive` status.
 * ```
 * <a bbRouterLink="/user/bob" bbRouterLinkActive #rla="bbRouterLinkActive">
 *   Bob {{ rla.isActive ? '(already open)' : ''}}
 * </a>
 * ```
 *
 * Finally, you can apply the RouterLinkActive directive to an ancestor of a RouterLink.
 *
 * ```
 * <div bbRouterLinkActive="active-link" [bbRouterLinkActiveOptions]="{exact: true}">
 *   <a bbRouterLink="/user/jim">Jim</a>
 *   <a bbRouterLink="/user/bob">Bob</a>
 * </div>
 * ```
 *
 * This will set the active-link class on the div tag if the url is either '/user/jim' or
 * '/user/bob'.
 *
 * @ngModule RouterModule
 *
 */
export class RouterLinkActiveDirective {
    constructor(router, element, renderer, link, linkWithHref) {
        this.router = router;
        this.element = element;
        this.renderer = renderer;
        this.link = link;
        this.linkWithHref = linkWithHref;
        this.classes = [];
        this.isActive = false;
        this.bbRouterLinkActiveOptions = {};
        this.subscription = router.events.subscribe((s) => {
            if (s instanceof NavigationEnd) {
                this.update();
            }
        });
    }
    ngAfterContentInit() {
        if (!this.links || !this.linksWithHrefs)
            return;
        this.links.changes.subscribe(_ => this.update());
        this.linksWithHrefs.changes.subscribe(_ => this.update());
        this.update();
    }
    set bbRouterLinkActive(data) {
        const classes = Array.isArray(data) ? data : data.split(' ');
        this.classes = classes.filter(c => !!c);
    }
    ngOnChanges() {
        this.update();
    }
    ngOnDestroy() {
        this.subscription.unsubscribe();
    }
    updateClasses(hasActiveLinks) {
        this.classes.forEach(c => {
            if (hasActiveLinks) {
                this.renderer.addClass(this.element.nativeElement, c);
            }
            else {
                this.renderer.removeClass(this.element.nativeElement, c);
            }
        });
    }
    updateAria(hasActiveLinks) {
        const ariaAttr = 'aria-current';
        if (this.bbRouterLinkActiveOptions.ariaCurrent) {
            this.renderer.setAttribute(this.element.nativeElement, ariaAttr, hasActiveLinks ? this.bbRouterLinkActiveOptions.ariaCurrent : 'false');
        }
        else {
            this.renderer.removeAttribute(this.element.nativeElement, ariaAttr);
        }
    }
    update() {
        if (!this.links || !this.linksWithHrefs || !this.router.navigated)
            return;
        this.hasActiveLinks().then(hasActiveLinks => {
            if (this.isActive !== hasActiveLinks) {
                this.isActive = hasActiveLinks;
                this.updateAria(hasActiveLinks);
                this.updateClasses(hasActiveLinks);
            }
        });
    }
    isLinkActive(router) {
        return (link) => link.urlTree.then(urlTree => router.isActive(urlTree, !!this.bbRouterLinkActiveOptions.exact));
    }
    hasActiveLinks() {
        if (!this.links || !this.linksWithHrefs)
            return Promise.resolve(false);
        return Promise.all([
            this.link ? this.isLinkActive(this.router)(this.link) : Promise.resolve(false),
            this.linkWithHref ? this.isLinkActive(this.router)(this.linkWithHref) : Promise.resolve(false),
            ...this.links.map(this.isLinkActive(this.router)),
            ...this.linksWithHrefs.map(this.isLinkActive(this.router)),
        ]).then((liveActives) => liveActives.some(a => a));
    }
}
RouterLinkActiveDirective.decorators = [
    { type: Directive, args: [{
                selector: '[bbRouterLinkActive]',
                exportAs: 'bbRouterLinkActive',
            },] }
];
RouterLinkActiveDirective.ctorParameters = () => [
    { type: Router },
    { type: ElementRef },
    { type: Renderer2 },
    { type: RouterLinkDirective, decorators: [{ type: Optional }] },
    { type: RouterLinkWithHrefDirective, decorators: [{ type: Optional }] }
];
RouterLinkActiveDirective.propDecorators = {
    links: [{ type: ContentChildren, args: [RouterLinkDirective, { descendants: true },] }],
    linksWithHrefs: [{ type: ContentChildren, args: [RouterLinkWithHrefDirective, { descendants: true },] }],
    bbRouterLinkActiveOptions: [{ type: Input }],
    bbRouterLinkActive: [{ type: Input }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm91dGVyLWxpbmstYWN0aXZlLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL2JhY2tiYXNlL2ZvdW5kYXRpb24tYW5nL2NvcmUvc3JjL2JhY2tiYXNlLWNvcmUvcm91dGluZy9kaXJlY3RpdmVzL3JvdXRlci1saW5rLWFjdGl2ZS5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUVMLGVBQWUsRUFDZixTQUFTLEVBQ1QsVUFBVSxFQUNWLEtBQUssRUFJTCxTQUFTLEVBQ1QsUUFBUSxHQUNULE1BQU0sZUFBZSxDQUFDO0FBRXZCLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSwyQkFBMkIsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQzNGLE9BQU8sRUFBRSxNQUFNLEVBQUUsYUFBYSxFQUFTLE1BQU0saUJBQWlCLENBQUM7QUFtQi9EOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBZ0VHO0FBS0gsTUFBTSxPQUFPLHlCQUF5QjtJQVlwQyxZQUNtQixNQUFjLEVBQ2QsT0FBbUIsRUFDbkIsUUFBbUIsRUFDUCxJQUEwQixFQUMxQixZQUEwQztRQUp0RCxXQUFNLEdBQU4sTUFBTSxDQUFRO1FBQ2QsWUFBTyxHQUFQLE9BQU8sQ0FBWTtRQUNuQixhQUFRLEdBQVIsUUFBUSxDQUFXO1FBQ1AsU0FBSSxHQUFKLElBQUksQ0FBc0I7UUFDMUIsaUJBQVksR0FBWixZQUFZLENBQThCO1FBWGpFLFlBQU8sR0FBa0IsRUFBRSxDQUFDO1FBRXBCLGFBQVEsR0FBWSxLQUFLLENBQUM7UUFFakMsOEJBQXlCLEdBQTRCLEVBQUUsQ0FBQztRQVMvRCxJQUFJLENBQUMsWUFBWSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBUSxFQUFFLEVBQUU7WUFDdkQsSUFBSSxD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LENBQUM7SUFDOUUsQ0FBQzs7O1lBakdGLFNBQVMsU0FBQztnQkFDVCxRQUFRLEVBQUUsc0JBQXNCO2dCQUNoQyxRQUFRLEVBQUUsb0JBQW9CO2FBQy9COzs7WUF2RlEsTUFBTTtZQVZiLFVBQVU7WUFLVixTQUFTO1lBSUYsbUJBQW1CLHVCQXlHdkIsUUFBUTtZQXpHaUIsMkJBQTJCLHVCQTBHcEQsUUFBUTs7O29CQWhCVixlQUFlLFNBQUMsbUJBQW1CLEVBQUUsRUFBRSxXQUFXLEVBQUUsSUFBSSxFQUFFOzZCQUUxRCxlQUFlLFNBQUMsMkJBQTJCLEVBQUUsRUFBRSxXQUFXLEVBQUUsSUFBSSxFQUFFO3dDQU9sRSxLQUFLO2lDQXVCTCxLQUFLIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQWZ0ZXJDb250ZW50SW5pdCxcbiAgQ29udGVudENoaWxkcmVuLFxuICBEaXJlY3RpdmUsXG4gIEVsZW1lbnRSZWYsXG4gIElucHV0LFxuICBPbkNoYW5nZXMsXG4gIE9uRGVzdHJveSxcbiAgUXVlcnlMaXN0LFxuICBSZW5kZXJlcjIsXG4gIE9wdGlvbmFsLFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgUm91dGVyTGlua0RpcmVjdGl2ZSwgUm91dGVyTGlua1dpdGhIcmVmRGlyZWN0aXZlIH0gZnJvbSAnLi9yb3V0ZXItbGluay5kaXJlY3RpdmUnO1xuaW1wb3J0IHsgUm91dGVyLCBOYXZpZ2F0aW9uRW5kLCBFdmVudCB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5cbi8qKlxuICogUm91dGVyIGxpbmsgb3B0aW9uc1xuICovXG5leHBvcnQgaW50ZXJmYWNlIFJvdXRlckxpbmtBY3RpdmVPcHRpb25zIHtcbiAgLyoqXG4gICAqIElmIGl0IGlzIGB0cnVlYCwgdGhlIGRpcmVjdGl2ZSB3aWxsIGFkZCB0aGUgY2xhc3NlcyBvbmx5IHdoZW4gdGhlIHVybCBtYXRjaGVzIHRoZSBsaW5rIGV4YWN0bHkuXG4gICAqIERlZmF1bHQ6IGBmYWxzZWBcbiAgICovXG4gIGV4YWN0PzogYm9vbGVhbjtcbiAgLyoqXG4gICAqIElmIGl0IGlzIGRlZmluZWQsIGFjdGl2ZSBsaW5rIHdpbGwgZ2V0IGBhcmlhLWN1cnJlbnRgIGF0dHJpYnV0ZSBzZXQgdG8gdGhlIHZhbHVlIHByb3ZpZGVkIGFuZCBhbGxcbiAgICogdGhlIG90aGVyIGxpbmtzIHdpbGwgZ2V0IGBhcmlhLWN1cnJlbnRgIHNldCB0byBgJ2ZhbHNlJ2AuXG4gICAqIERlZmF1bHQ6IGB1bmRlZmluZWRgXG4gICAqL1xuICBhcmlhQ3VycmVudD86IHN0cmluZztcbn1cblxuLyoqXG4gKlxuICogQGRlc2NyaXB0aW9uXG4gKlxuICogTGV0cyB5b3UgYWRkIGEgQ1NTIGNsYXNzIGFuZCBgYXJpYS1jdXJyZW50YCBhdHRyaWJ1dGUgdG8gYW4gZWxlbWVudCB3aGVuIHRoZSBsaW5rJ3Mgcm91dGUgYmVjb21lcyBhY3RpdmUuXG4gKlxuICogVGhpcyBkaXJlY3RpdmUgbGV0cyB5b3UgYWRkIGEgQ1NTIGNsYXNzIGFuZCBgYXJpYS1jdXJyZW50YCBhdHRyaWJ1dGUgdG8gYW4gZWxlbWVudCB3aGVuIHRoZSBsaW5rJ3Mgcm91dGVcbiAqIGJlY29tZXMgYWN0aXZlLlxuICpcbiAqIENvbnNpZGVyIHRoZSBmb2xsb3dpbmcgZXhhbXBsZTpcbiAqXG4gKiBgYGBcbiAqIDxhIGJiUm91dGVyTGluaz1cIi91c2VyL2JvYlwiIGJiUm91dGVyTGlua0FjdGl2ZT1cImFjdGl2ZS1saW5rXCI+Qm9iPC9hPlxuICogYGBgXG4gKlxuICogV2hlbiB0aGUgdXJsIGlzIGVpdGhlciAnL3VzZXInIG9yICcvdXNlci9ib2InLCB0aGUgYWN0aXZlLWxpbmsgY2xhc3Mgd2lsbFxuICogYmUgYWRkZWQgdG8gdGhlIGBhYCB0YWcuIElmIHRoZSB1cmwgY2hhbmdlcywgdGhlIGNsYXNzIFdpbGwgYmUgcmVtb3ZlZC5cbiAqXG4gKiBZb3UgY2FuIHNldCBtb3JlIHRoYW4gb25lIGNsYXNzLCBhcyBmb2xsb3dzOlxuICpcbiAqIGBgYFxuICogPGEgYmJSb3V0ZXJMaW5rPVwiL3VzZXIvYm9iXCIgYmJSb3V0ZXJMaW5rQWN0aXZlPVwiY2xhc3MxIGNsYXNzMlwiPkJvYjwvYT5cbiAqIDxhIGJiUm91dGVyTGluaz1cIi91c2VyL2JvYlwiIFtiYlJvdXRlckxpbmtBY3RpdmVdPVwiWydjbGFzczEnLCAnY2xhc3MyJ11cIj5Cb2I8L2E+XG4gKiBgYGBcbiAqXG4gKiBZb3UgY2FuIGNvbmZpZ3VyZSBSb3V0ZXJMaW5rQWN0aXZlIGJ5IHBhc3NpbmcgYGV4YWN0OiB0cnVlYC4gVGhpcyB3aWxsIGFkZCB0aGUgY2xhc3Nlc1xuICogb25seSB3aGVuIHRoZSB1cmwgbWF0Y2hlcyB0aGUgbGluayBleGFjdGx5LlxuICpcbiAqIGBgYFxuICogPGEgYmJSb3V0ZXJMaW5rPVwiL3VzZXIvYm9iXCIgYmJSb3V0ZXJMaW5rQWN0aXZlPVwiYWN0aXZlLWxpbmtcIiBbYmJSb3V0ZXJMaW5rQWN0aXZlT3B0aW9uc109XCJ7ZXhhY3Q6XG4gKiB0cnVlfVwiPkJvYjwvYT5cbiAqIGBgYFxuICpcbiAqIFlvdSBjYW4gY29uZmlndXJlIFJvdXRlckxpbmtBY3RpdmUgdG8gc2V0IGBhcmlhLWN1cnJlbnRgIGF0dHJpYnV0ZSBmb3IgYWxsIGxpbmtzLiBJZiBvcHRpb24gaXMgZGVmaW5lZCxcbiAqIHZhbHVlIHdpbGwgYmUgYWRkZWQgdG8gdGhlIGFjdGl2ZSBsaW5rIGFuZCBgYXJpYS1jdXJyZW50PVwiZmFsc2VcImAgdG8gdGhlIG90aGVyIGxpbmtzLlxuICpcbiAqIGBgYFxuICogPGEgYmJSb3V0ZXJMaW5rPVwiL3VzZXIvYm9iXCIgYmJSb3V0ZXJMaW5rQWN0aXZlPVwiYWN0aXZlLWxpbmtcIiBbYmJSb3V0ZXJMaW5rQWN0aXZlT3B0aW9uc109XCJ7YXJpYUN1cnJlbnQ6ICdwYWdlJ31cIj5cbiAqICBCb2JcbiAqIDwvYT5cbiAqIGBgYFxuICpcbiAqIFlvdSBjYW4gYXNzaWduIHRoZSBSb3V0ZXJMaW5rQWN0aXZlIGluc3RhbmNlIHRvIGEgdGVtcGxhdGUgdmFyaWFibGUgYW5kIGRpcmVjdGx5IGNoZWNrXG4gKiB0aGUgYGlzQWN0aXZlYCBzdGF0dXMuXG4gKiBgYGBcbiAqIDxhIGJiUm91dGVyTGluaz1cIi91c2VyL2JvYlwiIGJiUm91dGVyTGlua0FjdGl2ZSAjcmxhPVwiYmJSb3V0ZXJMaW5rQWN0aXZlXCI+XG4gKiAgIEJvYiB7eyBybGEuaXNBY3RpdmUgPyAnKGFscmVhZHkgb3BlbiknIDogJyd9fVxuICogPC9hPlxuICogYGBgXG4gKlxuICogRmluYWxseSwgeW91IGNhbiBhcHBseSB0aGUgUm91dGVyTGlua0FjdGl2ZSBkaXJlY3RpdmUgdG8gYW4gYW5jZXN0b3Igb2YgYSBSb3V0ZXJMaW5rLlxuICpcbiAqIGBgYFxuICogPGRpdiBiYlJvdXRlckxpbmtBY3RpdmU9XCJhY3RpdmUtbGlua1wiIFtiYlJvdXRlckxpbmtBY3RpdmVPcHRpb25zXT1cIntleGFjdDogdHJ1ZX1cIj5cbiAqICAgPGEgYmJSb3V0ZXJMaW5rPVwiL3VzZXIvamltXCI+SmltPC9hPlxuICogICA8YSBiYlJvdXRlckxpbms9XCIvdXNlci9ib2JcIj5Cb2I8L2E+XG4gKiA8L2Rpdj5cbiAqIGBgYFxuICpcbiAqIFRoaXMgd2lsbCBzZXQgdGhlIGFjdGl2ZS1saW5rIGNsYXNzIG9uIHRoZSBkaXYgdGFnIGlmIHRoZSB1cmwgaXMgZWl0aGVyICcvdXNlci9qaW0nIG9yXG4gKiAnL3VzZXIvYm9iJy5cbiAqXG4gKiBAbmdNb2R1bGUgUm91dGVyTW9kdWxlXG4gKlxuICovXG5ARGlyZWN0aXZlKHtcbiAgc2VsZWN0b3I6ICdbYmJSb3V0ZXJMaW5rQWN0aXZlXScsXG4gIGV4cG9ydEFzOiAnYmJSb3V0ZXJMaW5rQWN0aXZlJyxcbn0pXG5leHBvcnQgY2xhc3MgUm91dGVyTGlua0FjdGl2ZURpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uQ2hhbmdlcywgT25EZXN0cm95LCBBZnRlckNvbnRlbnRJbml0IHtcbiAgQENvbnRlbnRDaGlsZHJlbihSb3V0ZXJMaW5rRGlyZWN0aXZlLCB7IGRlc2NlbmRhbnRzOiB0cnVlIH0pXG4gIGxpbmtzOiBRdWVyeUxpc3Q8Um91dGVyTGlua0RpcmVjdGl2ZT4gfCB1bmRlZmluZWQ7XG4gIEBDb250ZW50Q2hpbGRyZW4oUm91dGVyTGlua1dpdGhIcmVmRGlyZWN0aXZlLCB7IGRlc2NlbmRhbnRzOiB0cnVlIH0pXG4gIGxpbmtzV2l0aEhyZWZzOiBRdWVyeUxpc3Q8Um91dGVyTGlua1dpdGhIcmVmRGlyZWN0aXZlPiB8IHVuZGVmaW5lZDtcblxuICBwcml2YXRlIGNsYXNzZXM6IEFycmF5PHN0cmluZz4gPSBbXTtcbiAgcHJpdmF0ZSByZWFkb25seSBzdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcbiAgcHVibGljIHJlYWRvbmx5IGlzQWN0aXZlOiBib29sZWFuID0gZmFsc2U7XG5cbiAgQElucHV0KCkgYmJSb3V0ZXJMaW5rQWN0aXZlT3B0aW9uczogUm91dGVyTGlua0FjdGl2ZU9wdGlvbnMgPSB7fTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IHJvdXRlcjogUm91dGVyLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgZWxlbWVudDogRWxlbWVudFJlZixcbiAgICBwcml2YXRlIHJlYWRvbmx5IHJlbmRlcmVyOiBSZW5kZXJlcjIsXG4gICAgQE9wdGlvbmFsKCkgcHJpdmF0ZSByZWFkb25seSBsaW5rPzogUm91dGVyTGlua0RpcmVjdGl2ZSxcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIHJlYWRvbmx5IGxpbmtXaXRoSHJlZj86IFJvdXRlckxpbmtXaXRoSHJlZkRpcmVjdGl2ZSxcbiAgKSB7XG4gICAgdGhpcy5zdWJzY3JpcHRpb24gPSByb3V0ZXIuZXZlbnRzLnN1YnNjcmliZSgoczogRXZlbnQpID0+IHtcbiAgICAgIGlmIChzIGluc3RhbmNlb2YgTmF2aWdhdGlvbkVuZCkge1xuICAgICAgICB0aGlzLnVwZGF0ZSgpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgbmdBZnRlckNvbnRlbnRJbml0KCk6IHZvaWQge1xuICAgIGlmICghdGhpcy5saW5rcyB8fCAhdGhpcy5saW5rc1dpdGhIcmVmcykgcmV0dXJuO1xuICAgIHRoaXMubGlua3MuY2hhbmdlcy5zdWJzY3JpYmUoXyA9PiB0aGlzLnVwZGF0ZSgpKTtcbiAgICB0aGlzLmxpbmtzV2l0aEhyZWZzLmNoYW5nZXMuc3Vic2NyaWJlKF8gPT4gdGhpcy51cGRhdGUoKSk7XG4gICAgdGhpcy51cGRhdGUoKTtcbiAgfVxuXG4gIEBJbnB1dCgpXG4gIHNldCBiYlJvdXRlckxpbmtBY3RpdmUoZGF0YTogQXJyYXk8c3RyaW5nPiB8IHN0cmluZykge1xuICAgIGNvbnN0IGNsYXNzZXMgPSBBcnJheS5pc0FycmF5KGRhdGEpID8gZGF0YSA6IGRhdGEuc3BsaXQoJyAnKTtcbiAgICB0aGlzLmNsYXNzZXMgPSBjbGFzc2VzLmZpbHRlcihjID0+ICEhYyk7XG4gIH1cblxuICBuZ09uQ2hhbmdlcygpOiB2b2lkIHtcbiAgICB0aGlzLnVwZGF0ZSgpO1xuICB9XG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIHRoaXMuc3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZUNsYXNzZXMoaGFzQWN0aXZlTGlua3M6IGJvb2xlYW4pIHtcbiAgICB0aGlzLmNsYXNzZXMuZm9yRWFjaChjID0+IHtcbiAgICAgIGlmIChoYXNBY3RpdmVMaW5rcykge1xuICAgICAgICB0aGlzLnJlbmRlcmVyLmFkZENsYXNzKHRoaXMuZWxlbWVudC5uYXRpdmVFbGVtZW50LCBjKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMucmVuZGVyZXIucmVtb3ZlQ2xhc3ModGhpcy5lbGVtZW50Lm5hdGl2ZUVsZW1lbnQsIGMpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVBcmlhKGhhc0FjdGl2ZUxpbmtzOiBib29sZWFuKSB7XG4gICAgY29uc3QgYXJpYUF0dHIgPSAnYXJpYS1jdXJyZW50JztcbiAgICBpZiAodGhpcy5iYlJvdXRlckxpbmtBY3RpdmVPcHRpb25zLmFyaWFDdXJyZW50KSB7XG4gICAgICB0aGlzLnJlbmRlcmVyLnNldEF0dHJpYnV0ZShcbiAgICAgICAgdGhpcy5lbGVtZW50Lm5hdGl2ZUVsZW1lbnQsXG4gICAgICAgIGFyaWFBdHRyLFxuICAgICAgICBoYXNBY3RpdmVMaW5rcyA/IHRoaXMuYmJSb3V0ZXJMaW5rQWN0aXZlT3B0aW9ucy5hcmlhQ3VycmVudCA6ICdmYWxzZScsXG4gICAgICApO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnJlbmRlcmVyLnJlbW92ZUF0dHJpYnV0ZSh0aGlzLmVsZW1lbnQubmF0aXZlRWxlbWVudCwgYXJpYUF0dHIpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgdXBkYXRlKCk6IHZvaWQge1xuICAgIGlmICghdGhpcy5saW5rcyB8fCAhdGhpcy5saW5rc1dpdGhIcmVmcyB8fCAhdGhpcy5yb3V0ZXIubmF2aWdhdGVkKSByZXR1cm47XG4gICAgdGhpcy5oYXNBY3RpdmVMaW5rcygpLnRoZW4oaGFzQWN0aXZlTGlua3MgPT4ge1xuICAgICAgaWYgKHRoaXMuaXNBY3RpdmUgIT09IGhhc0FjdGl2ZUxpbmtzKSB7XG4gICAgICAgICh0aGlzIGFzIGFueSkuaXNBY3RpdmUgPSBoYXNBY3RpdmVMaW5rcztcbiAgICAgICAgdGhpcy51cGRhdGVBcmlhKGhhc0FjdGl2ZUxpbmtzKTtcbiAgICAgICAgdGhpcy51cGRhdGVDbGFzc2VzKGhhc0FjdGl2ZUxpbmtzKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgaXNMaW5rQWN0aXZlKHJvdXRlcjogUm91dGVyKTogKGxpbms6IFJvdXRlckxpbmtEaXJlY3RpdmUgfCBSb3V0ZXJMaW5rV2l0aEhyZWZEaXJlY3RpdmUpID0+IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIHJldHVybiAobGluazogUm91dGVyTGlua0RpcmVjdGl2ZSB8IFJvdXRlckxpbmtXaXRoSHJlZkRpcmVjdGl2ZSk6IFByb21pc2U8Ym9vbGVhbj4gPT5cbiAgICAgIGxpbmsudXJsVHJlZS50aGVuKHVybFRyZWUgPT4gcm91dGVyLmlzQWN0aXZlKHVybFRyZWUsICEhdGhpcy5iYlJvdXRlckxpbmtBY3RpdmVPcHRpb25zLmV4YWN0KSk7XG4gIH1cblxuICBwcml2YXRlIGhhc0FjdGl2ZUxpbmtzKCk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIGlmICghdGhpcy5saW5rcyB8fCAhdGhpcy5saW5rc1dpdGhIcmVmcykgcmV0dXJuIFByb21pc2UucmVzb2x2ZShmYWxzZSk7XG4gICAgcmV0dXJuIFByb21pc2UuYWxsKFtcbiAgICAgIHRoaXMubGluayA/IHRoaXMuaXNMaW5rQWN0aXZlKHRoaXMucm91dGVyKSh0aGlzLmxpbmspIDogUHJvbWlzZS5yZXNvbHZlKGZhbHNlKSxcbiAgICAgIHRoaXMubGlua1dpdGhIcmVmID8gdGhpcy5pc0xpbmtBY3RpdmUodGhpcy5yb3V0ZXIpKHRoaXMubGlua1dpdGhIcmVmKSA6IFByb21pc2UucmVzb2x2ZShmYWxzZSksXG4gICAgICAuLi50aGlzLmxpbmtzLm1hcCh0aGlzLmlzTGlua0FjdGl2ZSh0aGlzLnJvdXRlcikpLFxuICAgICAgLi4udGhpcy5saW5rc1dpdGhIcmVmcy5tYXAodGhpcy5pc0xpbmtBY3RpdmUodGhpcy5yb3V0ZXIpKSxcbiAgICBdKS50aGVuKChsaXZlQWN0aXZlczogQXJyYXk8Ym9vbGVhbj4pOiBib29sZWFuID0+IGxpdmVBY3RpdmVzLnNvbWUoYSA9PiBhKSk7XG4gIH1cbn1cbiJdfQ==