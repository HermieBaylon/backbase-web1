import { Directive, ComponentFactoryResolver, ViewContainerRef, ChangeDetectorRef, Output, EventEmitter, } from '@angular/core';
import { RouterOutlet, ChildrenOutletContexts, Router, PRIMARY_OUTLET } from '@angular/router';
import { Subject } from 'rxjs';
import { takeUntil } from 'rxjs/operators';
import { RouterService } from '../navigation/router.service';
const OUTLET_IS_NOT_INITIALIZED_ERROR = 'Outlet is not instantiated';
/**
 * Includes the component associated with the current Route
 */
export class RouterOutletDirective {
    constructor(childrenOutletContexts, componentFactoryResolver, vcRef, cdRef, router, bbRouter) {
        this.childrenOutletContexts = childrenOutletContexts;
        this.componentFactoryResolver = componentFactoryResolver;
        this.vcRef = vcRef;
        this.cdRef = cdRef;
        this.router = router;
        this.bbRouter = bbRouter;
        this.destroy$ = new Subject();
        /**
         * A router outlet will emit an activate event any time a new component
         * is being instantiated.
         */
        // eslint-disable-next-line  @angular-eslint/no-output-rename
        this.activateEvents = new EventEmitter();
        /**
         * A router outlet will emit a deactivate event when the route component
         * is being destroyed.
         */
        // eslint-disable-next-line  @angular-eslint/no-output-rename
        this.deactivateEvents = new EventEmitter();
    }
    get name() {
        return this.nameValue || PRIMARY_OUTLET;
    }
    get isActivated() {
        return this.outlet ? this.outlet.isActivated : false;
    }
    get component() {
        if (!this.outlet) {
            throw new Error(OUTLET_IS_NOT_INITIALIZED_ERROR);
        }
        return this.outlet.component;
    }
    get activatedRoute() {
        if (!this.outlet) {
            throw new Error(OUTLET_IS_NOT_INITIALIZED_ERROR);
        }
        return this.outlet.activatedRoute;
    }
    get activatedRouteData() {
        if (!this.outlet) {
            return {};
        }
        return this.outlet.activatedRouteData;
    }
    destroy() {
        if (this.nameValue) {
            return this.removeOutletFromUrl()
                .then(() => this.router.navigate(['/']))
                .then(() => this.destroyChild());
        }
        else {
            return Promise.resolve();
        }
    }
    destroyChild() {
        if (this.outlet) {
            this.outlet.ngOnDestroy();
        }
    }
    removeOutletFromUrl() {
        // @todo: It's not possible to remove an outlet from the navigation.
        // @see: https://github.com/angular/angular/issues/15338 (this workaround is from there)
        return this.nameValue ? this.router.navigate([{ outlets: { [this.nameValue]: null } }]) : Promise.resolve(true);
    }
    ngOnInit() {
        this.bbRouter.outletName.pipe(takeUntil(this.destroy$)).subscribe(outletName => {
            this.destroy().then(() => {
                this.nameValue = outletName;
                this.outlet = new RouterOutlet(this.childrenOutletContexts, this.vcRef, this.componentFactoryResolver, this.name, this.cdRef);
                this.outlet.activateEvents.subscribe((event) => {
                    this.activateEvents.next(event);
                });
                this.outlet.deactivateEvents.subscribe((event) => {
                    this.deactivateEvents.next(event);
                });
                // Doesn't implement the `RouterOutlet` interface due to private members
                this.childrenOutletContexts.onChildOutletCreated(this.name, this);
                this.outlet.ngOnInit();
            });
        });
    }
    ngOnDestroy() {
        this.destroy$.next();
        this.destroy$.complete();
        this.destroyChild();
        this.childrenOutletContexts.onChildOutletDestroyed(this.name);
    }
    attach(ref, activatedRoute) {
        if (!this.outlet) {
            throw new Error(OUTLET_IS_NOT_INITIALIZED_ERROR);
        }
        return this.outlet.attach(ref, activatedRoute);
    }
    detach() {
        if (!this.outlet) {
            throw new Error(OUTLET_IS_NOT_INITIALIZED_ERROR);
        }
        return this.outlet.detach();
    }
    deactivate() {
        if (this.outlet) {
            this.outlet.deactivate();
        }
    }
    activateWith(activatedRoute, resolver) {
        if (!this.outlet) {
            throw new Error(OUTLET_IS_NOT_INITIALIZED_ERROR);
        }
        // Not sure how hacky this is - forcefully deactivating the outlet before reactivating it.
        this.outlet.deactivate();
        return this.outlet.activateWith(activatedRoute, resolver);
    }
}
RouterOutletDirective.decorators = [
    { type: Directive, args: [{
                // eslint-disable-next-line @angular-eslint/directive-selector
                selector: 'bb-router-outlet',
                exportAs: 'bbOutlet',
            },] }
];
RouterOutletDirective.ctorParameters = () => [
    { type: ChildrenOutletContexts },
    { type: ComponentFactoryResolver },
    { type: ViewContainerRef },
    { type: ChangeDetectorRef },
    { type: Router },
    { type: RouterService }
];
RouterOutletDirective.propDecorators = {
    activateEvents: [{ type: Output, args: ['activate',] }],
    deactivateEvents: [{ type: Output, args: ['deactivate',] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm91dGVyLW91dGxldC5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9iYWNrYmFzZS9mb3VuZGF0aW9uLWFuZy9jb3JlL3NyYy9iYWNrYmFzZS1jb3JlL3JvdXRpbmcvZGlyZWN0aXZlcy9yb3V0ZXItb3V0bGV0LmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0wsU0FBUyxFQUVULHdCQUF3QixFQUN4QixnQkFBZ0IsRUFDaEIsaUJBQWlCLEVBRWpCLE1BQU0sRUFFTixZQUFZLEdBQ2IsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLFlBQVksRUFBRSxzQkFBc0IsRUFBRSxNQUFNLEVBQUUsY0FBYyxFQUF3QixNQUFNLGlCQUFpQixDQUFDO0FBQ3JILE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDL0IsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzNDLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUU3RCxNQUFNLCtCQUErQixHQUFHLDRCQUE0QixDQUFDO0FBRXJFOztHQUVHO0FBTUgsTUFBTSxPQUFPLHFCQUFxQjtJQWdEaEMsWUFDbUIsc0JBQThDLEVBQzlDLHdCQUFrRCxFQUNsRCxLQUF1QixFQUN2QixLQUF3QixFQUN4QixNQUFjLEVBQ2QsUUFBdUI7UUFMdkIsMkJBQXNCLEdBQXRCLHNCQUFzQixDQUF3QjtRQUM5Qyw2QkFBd0IsR0FBeEIsd0JBQXdCLENBQTBCO1FBQ2xELFVBQUssR0FBTCxLQUFLLENBQWtCO1FBQ3ZCLFVBQUssR0FBTCxLQUFLLENBQW1CO1FBQ3hCLFdBQU0sR0FBTixNQUFNLENBQVE7UUFDZCxhQUFRLEdBQVIsUUFBUSxDQUFlO1FBbkR6QixhQUFRLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQztRQU0xQzs7O1dBR0c7UUFD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QyxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUM7SUFDOUIsQ0FBQztJQUVELFVBQVU7UUFDUixJQUFJLElBQUksQ0FBQyxNQUFNLEVBQUU7WUFDZixJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsRUFBRSxDQUFDO1NBQzFCO0lBQ0gsQ0FBQztJQUVELFlBQVksQ0FBQyxjQUE4QixFQUFFLFFBQXlDO1FBQ3BGLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFO1lBQ2hCLE1BQU0sSUFBSSxLQUFLLENBQUMsK0JBQStCLENBQUMsQ0FBQztTQUNsRDtRQUNELDBGQUEwRjtRQUMxRixJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsRUFBRSxDQUFDO1FBQ3pCLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsY0FBYyxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBQzVELENBQUM7OztZQWxKRixTQUFTLFNBQUM7Z0JBQ1QsOERBQThEO2dCQUM5RCxRQUFRLEVBQUUsa0JBQWtCO2dCQUM1QixRQUFRLEVBQUUsVUFBVTthQUNyQjs7O1lBZHNCLHNCQUFzQjtZQVIzQyx3QkFBd0I7WUFDeEIsZ0JBQWdCO1lBQ2hCLGlCQUFpQjtZQU00QixNQUFNO1lBRzVDLGFBQWE7Ozs2QkEwQm5CLE1BQU0sU0FBQyxVQUFVOytCQU9qQixNQUFNLFNBQUMsWUFBWSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIERpcmVjdGl2ZSxcbiAgT25EZXN0cm95LFxuICBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXG4gIFZpZXdDb250YWluZXJSZWYsXG4gIENoYW5nZURldGVjdG9yUmVmLFxuICBPbkluaXQsXG4gIE91dHB1dCxcbiAgQ29tcG9uZW50UmVmLFxuICBFdmVudEVtaXR0ZXIsXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgUm91dGVyT3V0bGV0LCBDaGlsZHJlbk91dGxldENvbnRleHRzLCBSb3V0ZXIsIFBSSU1BUllfT1VUTEVULCBEYXRhLCBBY3RpdmF0ZWRSb3V0ZSB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5pbXBvcnQgeyBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyB0YWtlVW50aWwgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBSb3V0ZXJTZXJ2aWNlIH0gZnJvbSAnLi4vbmF2aWdhdGlvbi9yb3V0ZXIuc2VydmljZSc7XG5cbmNvbnN0IE9VVExFVF9JU19OT1RfSU5JVElBTElaRURfRVJST1IgPSAnT3V0bGV0IGlzIG5vdCBpbnN0YW50aWF0ZWQnO1xuXG4vKipcbiAqIEluY2x1ZGVzIHRoZSBjb21wb25lbnQgYXNzb2NpYXRlZCB3aXRoIHRoZSBjdXJyZW50IFJvdXRlXG4gKi9cbkBEaXJlY3RpdmUoe1xuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQGFuZ3VsYXItZXNsaW50L2RpcmVjdGl2ZS1zZWxlY3RvclxuICBzZWxlY3RvcjogJ2JiLXJvdXRlci1vdXRsZXQnLFxuICBleHBvcnRBczogJ2JiT3V0bGV0Jyxcbn0pXG5leHBvcnQgY2xhc3MgUm91dGVyT3V0bGV0RGlyZWN0aXZlIGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3kge1xuICBwcml2YXRlIG91dGxldDogUm91dGVyT3V0bGV0IHwgdW5kZWZpbmVkO1xuICBwcml2YXRlIG5hbWVWYWx1ZTogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICBwcml2YXRlIHJlYWRvbmx5IGRlc3Ryb3kkID0gbmV3IFN1YmplY3QoKTtcblxuICBwcml2YXRlIGdldCBuYW1lKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMubmFtZVZhbHVlIHx8IFBSSU1BUllfT1VUTEVUO1xuICB9XG5cbiAgLyoqXG4gICAqIEEgcm91dGVyIG91dGxldCB3aWxsIGVtaXQgYW4gYWN0aXZhdGUgZXZlbnQgYW55IHRpbWUgYSBuZXcgY29tcG9uZW50XG4gICAqIGlzIGJlaW5nIGluc3RhbnRpYXRlZC5cbiAgICovXG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSAgQGFuZ3VsYXItZXNsaW50L25vLW91dHB1dC1yZW5hbWVcbiAgQE91dHB1dCgnYWN0aXZhdGUnKSBhY3RpdmF0ZUV2ZW50cyA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuXG4gIC8qKlxuICAgKiBBIHJvdXRlciBvdXRsZXQgd2lsbCBlbWl0IGEgZGVhY3RpdmF0ZSBldmVudCB3aGVuIHRoZSByb3V0ZSBjb21wb25lbnRcbiAgICogaXMgYmVpbmcgZGVzdHJveWVkLlxuICAgKi9cbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lICBAYW5ndWxhci1lc2xpbnQvbm8tb3V0cHV0LXJlbmFtZVxuICBAT3V0cHV0KCdkZWFjdGl2YXRlJykgZGVhY3RpdmF0ZUV2ZW50cyA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuXG4gIGdldCBpc0FjdGl2YXRlZCgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5vdXRsZXQgPyB0aGlzLm91dGxldC5pc0FjdGl2YXRlZCA6IGZhbHNlO1xuICB9XG5cbiAgZ2V0IGNvbXBvbmVudCgpOiBPYmplY3Qge1xuICAgIGlmICghdGhpcy5vdXRsZXQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihPVVRMRVRfSVNfTk9UX0lOSVRJQUxJWkVEX0VSUk9SKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMub3V0bGV0LmNvbXBvbmVudDtcbiAgfVxuXG4gIGdldCBhY3RpdmF0ZWRSb3V0ZSgpOiBBY3RpdmF0ZWRSb3V0ZSB7XG4gICAgaWYgKCF0aGlzLm91dGxldCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKE9VVExFVF9JU19OT1RfSU5JVElBTElaRURfRVJST1IpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5vdXRsZXQuYWN0aXZhdGVkUm91dGU7XG4gIH1cblxuICBnZXQgYWN0aXZhdGVkUm91dGVEYXRhKCk6IERhdGEge1xuICAgIGlmICghdGhpcy5vdXRsZXQpIHtcbiAgICAgIHJldHVybiB7fTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMub3V0bGV0LmFjdGl2YXRlZFJvdXRlRGF0YTtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgY2hpbGRyZW5PdXRsZXRDb250ZXh0czogQ2hpbGRyZW5PdXRsZXRDb250ZXh0cyxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNvbXBvbmVudEZhY3RvcnlSZXNvbHZlcjogQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgdmNSZWY6IFZpZXdDb250YWluZXJSZWYsXG4gICAgcHJpdmF0ZSByZWFkb25seSBjZFJlZjogQ2hhbmdlRGV0ZWN0b3JSZWYsXG4gICAgcHJpdmF0ZSByZWFkb25seSByb3V0ZXI6IFJvdXRlcixcbiAgICBwcml2YXRlIHJlYWRvbmx5IGJiUm91dGVyOiBSb3V0ZXJTZXJ2aWNlLFxuICApIHt9XG5cbiAgcHJpdmF0ZSBkZXN0cm95KCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmICh0aGlzLm5hbWVWYWx1ZSkge1xuICAgICAgcmV0dXJuIHRoaXMucmVtb3ZlT3V0bGV0RnJvbVVybCgpXG4gICAgICAgIC50aGVuKCgpID0+IHRoaXMucm91dGVyLm5hdmlnYXRlKFsnLyddKSlcbiAgICAgICAgLnRoZW4oKCkgPT4gdGhpcy5kZXN0cm95Q2hpbGQoKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGRlc3Ryb3lDaGlsZCgpIHtcbiAgICBpZiAodGhpcy5vdXRsZXQpIHtcbiAgICAgIHRoaXMub3V0bGV0Lm5nT25EZXN0cm95KCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSByZW1vdmVPdXRsZXRGcm9tVXJsKCk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIC8vIEB0b2RvOiBJdCdzIG5vdCBwb3NzaWJsZSB0byByZW1vdmUgYW4gb3V0bGV0IGZyb20gdGhlIG5hdmlnYXRpb24uXG4gICAgLy8gQHNlZTogaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXIvYW5ndWxhci9pc3N1ZXMvMTUzMzggKHRoaXMgd29ya2Fyb3VuZCBpcyBmcm9tIHRoZXJlKVxuICAgIHJldHVybiB0aGlzLm5hbWVWYWx1ZSA/IHRoaXMucm91dGVyLm5hdmlnYXRlKFt7IG91dGxldHM6IHsgW3RoaXMubmFtZVZhbHVlXTogbnVsbCB9IH1dKSA6IFByb21pc2UucmVzb2x2ZSh0cnVlKTtcbiAgfVxuXG4gIG5nT25Jbml0KCkge1xuICAgIHRoaXMuYmJSb3V0ZXIub3V0bGV0TmFtZS5waXBlKHRha2VVbnRpbCh0aGlzLmRlc3Ryb3kkKSkuc3Vic2NyaWJlKG91dGxldE5hbWUgPT4ge1xuICAgICAgdGhpcy5kZXN0cm95KCkudGhlbigoKSA9PiB7XG4gICAgICAgIHRoaXMubmFtZVZhbHVlID0gb3V0bGV0TmFtZTtcblxuICAgICAgICB0aGlzLm91dGxldCA9IG5ldyBSb3V0ZXJPdXRsZXQoXG4gICAgICAgICAgdGhpcy5jaGlsZHJlbk91dGxldENvbnRleHRzLFxuICAgICAgICAgIHRoaXMudmNSZWYsXG4gICAgICAgICAgdGhpcy5jb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXG4gICAgICAgICAgdGhpcy5uYW1lLFxuICAgICAgICAgIHRoaXMuY2RSZWYsXG4gICAgICAgICk7XG5cbiAgICAgICAgdGhpcy5vdXRsZXQuYWN0aXZhdGVFdmVudHMuc3Vic2NyaWJlKChldmVudDogYW55KSA9PiB7XG4gICAgICAgICAgdGhpcy5hY3RpdmF0ZUV2ZW50cy5uZXh0KGV2ZW50KTtcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMub3V0bGV0LmRlYWN0aXZhdGVFdmVudHMuc3Vic2NyaWJlKChldmVudDogYW55KSA9PiB7XG4gICAgICAgICAgdGhpcy5kZWFjdGl2YXRlRXZlbnRzLm5leHQoZXZlbnQpO1xuICAgICAgICB9KTtcblxuICAgICAgICAvLyBEb2Vzbid0IGltcGxlbWVudCB0aGUgYFJvdXRlck91dGxldGAgaW50ZXJmYWNlIGR1ZSB0byBwcml2YXRlIG1lbWJlcnNcbiAgICAgICAgdGhpcy5jaGlsZHJlbk91dGxldENvbnRleHRzLm9uQ2hpbGRPdXRsZXRDcmVhdGVkKHRoaXMubmFtZSwgdGhpcyBhcyBhbnkpO1xuXG4gICAgICAgIHRoaXMub3V0bGV0Lm5nT25Jbml0KCk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIHRoaXMuZGVzdHJveSQubmV4dCgpO1xuICAgIHRoaXMuZGVzdHJveSQuY29tcGxldGUoKTtcbiAgICB0aGlzLmRlc3Ryb3lDaGlsZCgpO1xuICAgIHRoaXMuY2hpbGRyZW5PdXRsZXRDb250ZXh0cy5vbkNoaWxkT3V0bGV0RGVzdHJveWVkKHRoaXMubmFtZSk7XG4gIH1cblxuICBhdHRhY2gocmVmOiBDb21wb25lbnRSZWY8YW55PiwgYWN0aXZhdGVkUm91dGU6IEFjdGl2YXRlZFJvdXRlKTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLm91dGxldCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKE9VVExFVF9JU19OT1RfSU5JVElBTElaRURfRVJST1IpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5vdXRsZXQuYXR0YWNoKHJlZiwgYWN0aXZhdGVkUm91dGUpO1xuICB9XG5cbiAgZGV0YWNoKCk6IENvbXBvbmVudFJlZjxhbnk+IHtcbiAgICBpZiAoIXRoaXMub3V0bGV0KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoT1VUTEVUX0lTX05PVF9JTklUSUFMSVpFRF9FUlJPUik7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLm91dGxldC5kZXRhY2goKTtcbiAgfVxuXG4gIGRlYWN0aXZhdGUoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMub3V0bGV0KSB7XG4gICAgICB0aGlzLm91dGxldC5kZWFjdGl2YXRlKCk7XG4gICAgfVxuICB9XG5cbiAgYWN0aXZhdGVXaXRoKGFjdGl2YXRlZFJvdXRlOiBBY3RpdmF0ZWRSb3V0ZSwgcmVzb2x2ZXI6IENvbXBvbmVudEZhY3RvcnlSZXNvbHZlciB8IG51bGwpIHtcbiAgICBpZiAoIXRoaXMub3V0bGV0KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoT1VUTEVUX0lTX05PVF9JTklUSUFMSVpFRF9FUlJPUik7XG4gICAgfVxuICAgIC8vIE5vdCBzdXJlIGhvdyBoYWNreSB0aGlzIGlzIC0gZm9yY2VmdWxseSBkZWFjdGl2YXRpbmcgdGhlIG91dGxldCBiZWZvcmUgcmVhY3RpdmF0aW5nIGl0LlxuICAgIHRoaXMub3V0bGV0LmRlYWN0aXZhdGUoKTtcbiAgICByZXR1cm4gdGhpcy5vdXRsZXQuYWN0aXZhdGVXaXRoKGFjdGl2YXRlZFJvdXRlLCByZXNvbHZlcik7XG4gIH1cbn1cbiJdfQ==