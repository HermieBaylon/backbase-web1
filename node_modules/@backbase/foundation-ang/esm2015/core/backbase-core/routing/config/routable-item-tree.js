import { combineTree } from '../../models/tree';
import { createRoutingStrategy } from '../strategies/routing-decorators';
import { propertiesByPrefix } from '../../../web-sdk/properties';
import { combineLatest, from, of } from 'rxjs';
import { map, startWith } from 'rxjs/operators';
import { JourneyComponent } from '../../rendering/chrome/journey.component';
const CUSTOM_DATA_PREFIX = 'route.data.custom.';
export var RouteModelProperty;
(function (RouteModelProperty) {
    /**
     * Each child of a RoutableContainer may have a property for "route",
     * else the route will be the index of the child plus 1.
     */
    RouteModelProperty["ROUTE"] = "route";
    /**
     * RoutableContainers and RoutableWidget can have an optional "outletName"
     * property to dynamically set the outlet name for the bb-router-outlet.
     */
    RouteModelProperty["OUTLET"] = "outletName";
    /**
     * `CanActivate` route guards can be added to generated child routes by including a
     * `route.canActivate` property in the child's model. These guards must be registered with the
     * `RouteGuardsRegistryService` via the `guards` option passed to `BackbaseCore.withConfig`.
     */
    RouteModelProperty["CAN_ACTIVATE"] = "route.canActivate";
    /**
     * `CanActivateChild` route guards can be added to generated routes by including a
     * `route.canActivateChild` property in the item's model. These guards must be registered with the
     * `RouteGuardsRegistryService` via the `guards` option passed to `BackbaseCore.withConfig`.
     */
    RouteModelProperty["CAN_ACTIVATE_CHILD"] = "route.canActivateChild";
    /**
     * RoutableContainer's can have a "disableDefault" property which will disable the
     * default behaviour of containers where an empty path route will be created to
     * redirect to the first child's route.
     */
    RouteModelProperty["DISABLE_DEFAULT"] = "disableDefault";
})(RouteModelProperty || (RouteModelProperty = {}));
const getRoutingStrategy = (itemRegistry, item) => {
    const loadModuleFunction = itemRegistry.getModuleLoader(item.ɵclassId);
    if (loadModuleFunction) {
        return of(createJourneyStrategy(item, loadModuleFunction));
    }
    const component = itemRegistry.getComponentValue(item.ɵclassId);
    if (component) {
        return of(createRoutingStrategy(component));
    }
    return from(itemRegistry.getComponent(item.ɵclassId)).pipe(map(createRoutingStrategy), startWith(undefined));
};
const ɵ0 = getRoutingStrategy;
const getCanActivateRouteGuards = (guardRegistry, guards) => guards
    .map(guardName => guardRegistry.canActivate.get(guardName))
    .filter((guard) => guard !== undefined);
const ɵ1 = getCanActivateRouteGuards;
const getCanActivateChildRouteGuards = (guardRegistry, guards) => guards
    .map(guardName => guardRegistry.canActivateChild.get(guardName))
    .filter((guard) => guard !== undefined);
const ɵ2 = getCanActivateChildRouteGuards;
const toRoutableItem = (item, routeGuards, routeProperties, routingStrategy) => {
    return {
        name: item.name,
        routingStrategy,
        route: routeProperties[RouteModelProperty.ROUTE],
        outlet: routeProperties[RouteModelProperty.OUTLET],
        canActivate: getCanActivateRouteGuards(routeGuards, (routeProperties[RouteModelProperty.CAN_ACTIVATE] || [])),
        canActivateChild: getCanActivateChildRouteGuards(routeGuards, (routeProperties[RouteModelProperty.CAN_ACTIVATE_CHILD] || [])),
        hasDefault: routingStrategy ? true !== routeProperties[RouteModelProperty.DISABLE_DEFAULT] : undefined,
        routeData: propertiesByPrefix(CUSTOM_DATA_PREFIX, routeProperties),
    };
};
const ɵ3 = toRoutableItem;
// @fixme: don't re-emit unless properties we care about change
const routableItem = (itemRegistry, routeGuards) => (item) => combineLatest([item.properties, getRoutingStrategy(itemRegistry, item)]).pipe(map(([routeProperties, routingStrategy]) => toRoutableItem(item, routeGuards, routeProperties, routingStrategy)));
const ɵ4 = routableItem;
function createJourneyStrategy(item, loadChildren) {
    return {
        getRoutes() {
            return [
                {
                    path: '',
                    component: JourneyComponent,
                    data: { item },
                    loadChildren,
                },
            ];
        },
    };
}
export const routableItemTree = (itemRegistry, routeGuards, modelTree) => combineTree(modelTree.map(routableItem(itemRegistry, routeGuards)));
export { ɵ0, ɵ1, ɵ2, ɵ3, ɵ4 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm91dGFibGUtaXRlbS10cmVlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvYmFja2Jhc2UvZm91bmRhdGlvbi1hbmcvY29yZS9zcmMvYmFja2Jhc2UtY29yZS9yb3V0aW5nL2NvbmZpZy9yb3V0YWJsZS1pdGVtLXRyZWUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFRLFdBQVcsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBRXRELE9BQU8sRUFBRSxxQkFBcUIsRUFBbUIsTUFBTSxrQ0FBa0MsQ0FBQztBQUMxRixPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQUVqRSxPQUFPLEVBQWMsYUFBYSxFQUFFLElBQUksRUFBRSxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDM0QsT0FBTyxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUtoRCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSwwQ0FBMEMsQ0FBQztBQUU1RSxNQUFNLGtCQUFrQixHQUFHLG9CQUFvQixDQUFDO0FBRWhELE1BQU0sQ0FBTixJQUFZLGtCQTZCWDtBQTdCRCxXQUFZLGtCQUFrQjtJQUM1Qjs7O09BR0c7SUFDSCxxQ0FBZSxDQUFBO0lBQ2Y7OztPQUdHO0lBQ0gsMkNBQXFCLENBQUE7SUFDckI7Ozs7T0FJRztJQUNILHdEQUFrQyxDQUFBO0lBQ2xDOzs7O09BSUc7SUFDSCxtRUFBNkMsQ0FBQTtJQUM3Qzs7OztPQUlHO0lBQ0gsd0RBQWtDLENBQUE7QUFDcEMsQ0FBQyxFQTdCVyxrQkFBa0IsS0FBbEIsa0JBQWtCLFFBNkI3QjtBQXVDRCxNQUFNLGtCQUFrQixHQUFHLENBQ3pCLFlBQWlDLEVBQ2pDLElBQWUsRUFDMEIsRUFBRTtJQUMzQyxNQUFNLGtCQUFrQixHQUFHLFlBQVksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FB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QUFTO1lBQ1AsT0FBTztnQkFDTDtvQkFDRSxJQUFJLEVBQUUsRUFBRTtvQkFDUixTQUFTLEVBQUUsZ0JBQWdCO29CQUMzQixJQUFJLEVBQUUsRUFBRSxJQUFJLEVBQUU7b0JBQ2QsWUFBWTtpQkFDYjthQUNGLENBQUM7UUFDSixDQUFDO0tBQ0YsQ0FBQztBQUNKLENBQUM7QUFFRCxNQUFNLENBQUMsTUFBTSxnQkFBZ0IsR0FBRyxDQUM5QixZQUFpQyxFQUNqQyxXQUF1QyxFQUN2QyxTQUEwQixFQUNNLEVBQUUsQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsWUFBWSxFQUFFLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFRyZWUsIGNvbWJpbmVUcmVlIH0gZnJvbSAnLi4vLi4vbW9kZWxzL3RyZWUnO1xuaW1wb3J0IHsgSXRlbU1vZGVsIH0gZnJvbSAnLi4vLi4vbW9kZWxzL2l0ZW0tbW9kZWwnO1xuaW1wb3J0IHsgY3JlYXRlUm91dGluZ1N0cmF0ZWd5LCBSb3V0aW5nU3RyYXRlZ3kgfSBmcm9tICcuLi9zdHJhdGVnaWVzL3JvdXRpbmctZGVjb3JhdG9ycyc7XG5pbXBvcnQgeyBwcm9wZXJ0aWVzQnlQcmVmaXggfSBmcm9tICcuLi8uLi8uLi93ZWItc2RrL3Byb3BlcnRpZXMnO1xuaW1wb3J0IHsgUm91dGVHdWFyZHNSZWdpc3RyeVNlcnZpY2UgfSBmcm9tICcuLi9ndWFyZHMvcm91dGUtZ3VhcmRzLXJlZ2lzdHJ5LnNlcnZpY2UnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgY29tYmluZUxhdGVzdCwgZnJvbSwgb2YgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IG1hcCwgc3RhcnRXaXRoIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgSXRlbVJlZ2lzdHJ5U2VydmljZSB9IGZyb20gJy4uLy4uL3JlbmRlcmluZy9pdGVtLXJlZ2lzdHJ5LnNlcnZpY2UnO1xuaW1wb3J0IHsgVHlwZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQ2FuQWN0aXZhdGUsIENhbkFjdGl2YXRlQ2hpbGQsIExvYWRDaGlsZHJlbkNhbGxiYWNrIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcbmltcG9ydCB7IFByb3BlcnRpZXMgfSBmcm9tICdAYmFja2Jhc2UvZm91bmRhdGlvbi1hbmcvd2ViLXNkayc7XG5pbXBvcnQgeyBKb3VybmV5Q29tcG9uZW50IH0gZnJvbSAnLi4vLi4vcmVuZGVyaW5nL2Nocm9tZS9qb3VybmV5LmNvbXBvbmVudCc7XG5cbmNvbnN0IENVU1RPTV9EQVRBX1BSRUZJWCA9ICdyb3V0ZS5kYXRhLmN1c3RvbS4nO1xuXG5leHBvcnQgZW51bSBSb3V0ZU1vZGVsUHJvcGVydHkge1xuICAvKipcbiAgICogRWFjaCBjaGlsZCBvZiBhIFJvdXRhYmxlQ29udGFpbmVyIG1heSBoYXZlIGEgcHJvcGVydHkgZm9yIFwicm91dGVcIixcbiAgICogZWxzZSB0aGUgcm91dGUgd2lsbCBiZSB0aGUgaW5kZXggb2YgdGhlIGNoaWxkIHBsdXMgMS5cbiAgICovXG4gIFJPVVRFID0gJ3JvdXRlJyxcbiAgLyoqXG4gICAqIFJvdXRhYmxlQ29udGFpbmVycyBhbmQgUm91dGFibGVXaWRnZXQgY2FuIGhhdmUgYW4gb3B0aW9uYWwgXCJvdXRsZXROYW1lXCJcbiAgICogcHJvcGVydHkgdG8gZHluYW1pY2FsbHkgc2V0IHRoZSBvdXRsZXQgbmFtZSBmb3IgdGhlIGJiLXJvdXRlci1vdXRsZXQuXG4gICAqL1xuICBPVVRMRVQgPSAnb3V0bGV0TmFtZScsXG4gIC8qKlxuICAgKiBgQ2FuQWN0aXZhdGVgIHJvdXRlIGd1YXJkcyBjYW4gYmUgYWRkZWQgdG8gZ2VuZXJhdGVkIGNoaWxkIHJvdXRlcyBieSBpbmNsdWRpbmcgYVxuICAgKiBgcm91dGUuY2FuQWN0aXZhdGVgIHByb3BlcnR5IGluIHRoZSBjaGlsZCdzIG1vZGVsLiBUaGVzZSBndWFyZHMgbXVzdCBiZSByZWdpc3RlcmVkIHdpdGggdGhlXG4gICAqIGBSb3V0ZUd1YXJkc1JlZ2lzdHJ5U2VydmljZWAgdmlhIHRoZSBgZ3VhcmRzYCBvcHRpb24gcGFzc2VkIHRvIGBCYWNrYmFzZUNvcmUud2l0aENvbmZpZ2AuXG4gICAqL1xuICBDQU5fQUNUSVZBVEUgPSAncm91dGUuY2FuQWN0aXZhdGUnLFxuICAvKipcbiAgICogYENhbkFjdGl2YXRlQ2hpbGRgIHJvdXRlIGd1YXJkcyBjYW4gYmUgYWRkZWQgdG8gZ2VuZXJhdGVkIHJvdXRlcyBieSBpbmNsdWRpbmcgYVxuICAgKiBgcm91dGUuY2FuQWN0aXZhdGVDaGlsZGAgcHJvcGVydHkgaW4gdGhlIGl0ZW0ncyBtb2RlbC4gVGhlc2UgZ3VhcmRzIG11c3QgYmUgcmVnaXN0ZXJlZCB3aXRoIHRoZVxuICAgKiBgUm91dGVHdWFyZHNSZWdpc3RyeVNlcnZpY2VgIHZpYSB0aGUgYGd1YXJkc2Agb3B0aW9uIHBhc3NlZCB0byBgQmFja2Jhc2VDb3JlLndpdGhDb25maWdgLlxuICAgKi9cbiAgQ0FOX0FDVElWQVRFX0NISUxEID0gJ3JvdXRlLmNhbkFjdGl2YXRlQ2hpbGQnLFxuICAvKipcbiAgICogUm91dGFibGVDb250YWluZXIncyBjYW4gaGF2ZSBhIFwiZGlzYWJsZURlZmF1bHRcIiBwcm9wZXJ0eSB3aGljaCB3aWxsIGRpc2FibGUgdGhlXG4gICAqIGRlZmF1bHQgYmVoYXZpb3VyIG9mIGNvbnRhaW5lcnMgd2hlcmUgYW4gZW1wdHkgcGF0aCByb3V0ZSB3aWxsIGJlIGNyZWF0ZWQgdG9cbiAgICogcmVkaXJlY3QgdG8gdGhlIGZpcnN0IGNoaWxkJ3Mgcm91dGUuXG4gICAqL1xuICBESVNBQkxFX0RFRkFVTFQgPSAnZGlzYWJsZURlZmF1bHQnLFxufVxuXG4vKipcbiAqIEBmaXhtZTogVGhpcyBpcyBhIHVuaW9uIG9mIHNvbWUgZGlmZmVyZW50IHR5cGVzLlxuICpcbiAqIGludGVyZmFjZSBOb25Sb3V0YWJsZSB7XG4gKiAgIG5hbWU6IHN0cmluZztcbiAqICAgcm91dGluZ1N0cmF0ZWd5OiB1bmRlZmluZWQ7XG4gKiB9XG4gKiBpbnRlcmZhY2UgUm91dGFibGVXaWRnZXQge1xuICogICBuYW1lOiBzdHJpbmc7XG4gKiAgIHJvdXRpbmdTdHJhdGVneTogUm91dGluZ1N0cmF0ZWd5O1xuICogICBvdXRsZXROYW1lPzogc3RyaW5nO1xuICogfVxuICogaW50ZXJmYWNlIFJvdXRhYmxlQ29udGFpbmVyIHtcbiAqICAgbmFtZTogc3RyaW5nO1xuICogICByb3V0aW5nU3RyYXRlZ3k6IFJvdXRpbmdTdHJhdGVneTtcbiAqICAgb3V0bGV0TmFtZT86IHN0cmluZztcbiAqICAgaGFzRGVmYXVsdDogYm9vbGVhbjtcbiAqIH1cbiAqIGludGVyZmFjZSBSb3V0YWJsZUNvbnRhaW5lckNoaWxkIGV4dGVuZHMgTm9uUm91dGFibGUgfCBSb3V0YWJsZVdpZGdldCB8IFJvdXRhYmxlQ29udGFpbmVyIHtcbiAqICAgcm91dGU/OiBzdHJpbmc7XG4gKiAgIHJvdXRlRGF0YTogUHJvcGVydGllcztcbiAqICAgY2FuQWN0aXZhdGU6IEFycmF5PENhbkFjdGl2YXRlPjtcbiAqICAgY2FuQWN0aXZhdGVDaGlsZDogQXJyYXk8Q2FuQWN0aXZhdGVDaGlsZD47XG4gKiB9XG4gKiB0eXBlIFJvdXRhYmxlSXRlbSA9IE5vblJvdXRhYmxlIHwgUm91dGFibGVXaWRnZXQgfCBSb3V0YWJsZUNvbnRhaW5lciB8IFJvdXRhYmxlQ29udGFpbmVyQ2hpbGRcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBSb3V0YWJsZUl0ZW0ge1xuICBuYW1lOiBzdHJpbmc7XG4gIHJvdXRpbmdTdHJhdGVneT86IFJvdXRpbmdTdHJhdGVneTtcbiAgaGFzRGVmYXVsdD86IGJvb2xlYW47XG4gIHJvdXRlPzogc3RyaW5nO1xuICBvdXRsZXQ/OiBzdHJpbmc7XG4gIGNhbkFjdGl2YXRlOiBBcnJheTxUeXBlPENhbkFjdGl2YXRlPj47XG4gIGNhbkFjdGl2YXRlQ2hpbGQ6IEFycmF5PFR5cGU8Q2FuQWN0aXZhdGVDaGlsZD4+O1xuICByb3V0ZURhdGE6IFByb3BlcnRpZXM7XG59XG5cbmNvbnN0IGdldFJvdXRpbmdTdHJhdGVneSA9IChcbiAgaXRlbVJlZ2lzdHJ5OiBJdGVtUmVnaXN0cnlTZXJ2aWNlLFxuICBpdGVtOiBJdGVtTW9kZWwsXG4pOiBPYnNlcnZhYmxlPFJvdXRpbmdTdHJhdGVneSB8IHVuZGVmaW5lZD4gPT4ge1xuICBjb25zdCBsb2FkTW9kdWxlRnVuY3Rpb24gPSBpdGVtUmVnaXN0cnkuZ2V0TW9kdWxlTG9hZGVyKGl0ZW0uybVjbGFzc0lkKTtcbiAgaWYgKGxvYWRNb2R1bGVGdW5jdGlvbikge1xuICAgIHJldHVybiBvZihjcmVhdGVKb3VybmV5U3RyYXRlZ3koaXRlbSwgbG9hZE1vZHVsZUZ1bmN0aW9uKSk7XG4gIH1cbiAgY29uc3QgY29tcG9uZW50ID0gaXRlbVJlZ2lzdHJ5LmdldENvbXBvbmVudFZhbHVlKGl0ZW0uybVjbGFzc0lkKTtcbiAgaWYgKGNvbXBvbmVudCkge1xuICAgIHJldHVybiBvZihjcmVhdGVSb3V0aW5nU3RyYXRlZ3koY29tcG9uZW50KSk7XG4gIH1cbiAgcmV0dXJuIGZyb20oaXRlbVJlZ2lzdHJ5LmdldENvbXBvbmVudChpdGVtLsm1Y2xhc3NJZCkpLnBpcGUobWFwKGNyZWF0ZVJvdXRpbmdTdHJhdGVneSksIHN0YXJ0V2l0aCh1bmRlZmluZWQpKTtcbn07XG5cbmNvbnN0IGdldENhbkFjdGl2YXRlUm91dGVHdWFyZHMgPSAoXG4gIGd1YXJkUmVnaXN0cnk6IFJvdXRlR3VhcmRzUmVnaXN0cnlTZXJ2aWNlLFxuICBndWFyZHM6IEFycmF5PHN0cmluZz4sXG4pOiBBcnJheTxUeXBlPENhbkFjdGl2YXRlPj4gPT5cbiAgZ3VhcmRzXG4gICAgLm1hcChndWFyZE5hbWUgPT4gZ3VhcmRSZWdpc3RyeS5jYW5BY3RpdmF0ZS5nZXQoZ3VhcmROYW1lKSlcbiAgICAuZmlsdGVyKChndWFyZCk6IGd1YXJkIGlzIFR5cGU8Q2FuQWN0aXZhdGU+ID0+IGd1YXJkICE9PSB1bmRlZmluZWQpO1xuXG5jb25zdCBnZXRDYW5BY3RpdmF0ZUNoaWxkUm91dGVHdWFyZHMgPSAoXG4gIGd1YXJkUmVnaXN0cnk6IFJvdXRlR3VhcmRzUmVnaXN0cnlTZXJ2aWNlLFxuICBndWFyZHM6IEFycmF5PHN0cmluZz4sXG4pOiBBcnJheTxUeXBlPENhbkFjdGl2YXRlQ2hpbGQ+PiA9PlxuICBndWFyZHNcbiAgICAubWFwKGd1YXJkTmFtZSA9PiBndWFyZFJlZ2lzdHJ5LmNhbkFjdGl2YXRlQ2hpbGQuZ2V0KGd1YXJkTmFtZSkpXG4gICAgLmZpbHRlcigoZ3VhcmQpOiBndWFyZCBpcyBUeXBlPENhbkFjdGl2YXRlQ2hpbGQ+ID0+IGd1YXJkICE9PSB1bmRlZmluZWQpO1xuXG5jb25zdCB0b1JvdXRhYmxlSXRlbSA9IChcbiAgaXRlbTogSXRlbU1vZGVsLFxuICByb3V0ZUd1YXJkczogUm91dGVHdWFyZHNSZWdpc3RyeVNlcnZpY2UsXG4gIHJvdXRlUHJvcGVydGllczogUHJvcGVydGllcyxcbiAgcm91dGluZ1N0cmF0ZWd5OiBSb3V0aW5nU3RyYXRlZ3kgfCB1bmRlZmluZWQsXG4pOiBSb3V0YWJsZUl0ZW0gPT4ge1xuICByZXR1cm4ge1xuICAgIG5hbWU6IGl0ZW0ubmFtZSxcbiAgICByb3V0aW5nU3RyYXRlZ3ksXG4gICAgcm91dGU6IHJvdXRlUHJvcGVydGllc1tSb3V0ZU1vZGVsUHJvcGVydHkuUk9VVEVdIGFzIHN0cmluZyB8IHVuZGVmaW5lZCxcbiAgICBvdXRsZXQ6IHJvdXRlUHJvcGVydGllc1tSb3V0ZU1vZGVsUHJvcGVydHkuT1VUTEVUXSBhcyBzdHJpbmcgfCB1bmRlZmluZWQsXG4gICAgY2FuQWN0aXZhdGU6IGdldENhbkFjdGl2YXRlUm91dGVHdWFyZHMoXG4gICAgICByb3V0ZUd1YXJkcyxcbiAgICAgIChyb3V0ZVByb3BlcnRpZXNbUm91dGVNb2RlbFByb3BlcnR5LkNBTl9BQ1RJVkFURV0gfHwgW10pIGFzIEFycmF5PHN0cmluZz4sXG4gICAgKSxcbiAgICBjYW5BY3RpdmF0ZUNoaWxkOiBnZXRDYW5BY3RpdmF0ZUNoaWxkUm91dGVHdWFyZHMoXG4gICAgICByb3V0ZUd1YXJkcyxcbiAgICAgIChyb3V0ZVByb3BlcnRpZXNbUm91dGVNb2RlbFByb3BlcnR5LkNBTl9BQ1RJVkFURV9DSElMRF0gfHwgW10pIGFzIEFycmF5PHN0cmluZz4sXG4gICAgKSxcbiAgICBoYXNEZWZhdWx0OiByb3V0aW5nU3RyYXRlZ3kgPyB0cnVlICE9PSByb3V0ZVByb3BlcnRpZXNbUm91dGVNb2RlbFByb3BlcnR5LkRJU0FCTEVfREVGQVVMVF0gOiB1bmRlZmluZWQsXG4gICAgcm91dGVEYXRhOiBwcm9wZXJ0aWVzQnlQcmVmaXgoQ1VTVE9NX0RBVEFfUFJFRklYLCByb3V0ZVByb3BlcnRpZXMpLFxuICB9O1xufTtcblxuLy8gQGZpeG1lOiBkb24ndCByZS1lbWl0IHVubGVzcyBwcm9wZXJ0aWVzIHdlIGNhcmUgYWJvdXQgY2hhbmdlXG5jb25zdCByb3V0YWJsZUl0ZW0gPSAoaXRlbVJlZ2lzdHJ5OiBJdGVtUmVnaXN0cnlTZXJ2aWNlLCByb3V0ZUd1YXJkczogUm91dGVHdWFyZHNSZWdpc3RyeVNlcnZpY2UpID0+IChcbiAgaXRlbTogSXRlbU1vZGVsLFxuKTogT2JzZXJ2YWJsZTxSb3V0YWJsZUl0ZW0+ID0+XG4gIGNvbWJpbmVMYXRlc3QoW2l0ZW0ucHJvcGVydGllcywgZ2V0Um91dGluZ1N0cmF0ZWd5KGl0ZW1SZWdpc3RyeSwgaXRlbSldKS5waXBlKFxuICAgIG1hcCgoW3JvdXRlUHJvcGVydGllcywgcm91dGluZ1N0cmF0ZWd5XSkgPT4gdG9Sb3V0YWJsZUl0ZW0oaXRlbSwgcm91dGVHdWFyZHMsIHJvdXRlUHJvcGVydGllcywgcm91dGluZ1N0cmF0ZWd5KSksXG4gICk7XG5cbmZ1bmN0aW9uIGNyZWF0ZUpvdXJuZXlTdHJhdGVneShpdGVtOiBJdGVtTW9kZWwsIGxvYWRDaGlsZHJlbjogTG9hZENoaWxkcmVuQ2FsbGJhY2spOiBSb3V0aW5nU3RyYXRlZ3kge1xuICByZXR1cm4ge1xuICAgIGdldFJvdXRlcygpIHtcbiAgICAgIHJldHVybiBbXG4gICAgICAgIHtcbiAgICAgICAgICBwYXRoOiAnJyxcbiAgICAgICAgICBjb21wb25lbnQ6IEpvdXJuZXlDb21wb25lbnQsXG4gICAgICAgICAgZGF0YTogeyBpdGVtIH0sXG4gICAgICAgICAgbG9hZENoaWxkcmVuLFxuICAgICAgICB9LFxuICAgICAgXTtcbiAgICB9LFxuICB9O1xufVxuXG5leHBvcnQgY29uc3Qgcm91dGFibGVJdGVtVHJlZSA9IChcbiAgaXRlbVJlZ2lzdHJ5OiBJdGVtUmVnaXN0cnlTZXJ2aWNlLFxuICByb3V0ZUd1YXJkczogUm91dGVHdWFyZHNSZWdpc3RyeVNlcnZpY2UsXG4gIG1vZGVsVHJlZTogVHJlZTxJdGVtTW9kZWw+LFxuKTogT2JzZXJ2YWJsZTxUcmVlPFJvdXRhYmxlSXRlbT4+ID0+IGNvbWJpbmVUcmVlKG1vZGVsVHJlZS5tYXAocm91dGFibGVJdGVtKGl0ZW1SZWdpc3RyeSwgcm91dGVHdWFyZHMpKSk7XG4iXX0=