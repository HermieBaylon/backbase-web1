import { Inject, Injectable, InjectionToken, NgModule, APP_INITIALIZER } from '@angular/core';
import { CommunicationDefinition, serializerDeserializer } from '@backbase/communication-property';
import { first, map } from 'rxjs/operators';
import { BackbaseCoreModule, ӨItemNavigationService, ӨRootContainerService, } from '@backbase/foundation-ang/core';
export function initIntents(intentBridgeService) {
    return intentBridgeService.handleIncomingIntent.bind(intentBridgeService);
}
export class IntentNavigation {
    go(url) {
        location.href = url;
    }
}
IntentNavigation.decorators = [
    { type: Injectable }
];
export class IntentStorage {
    get() {
        const storedIntent = sessionStorage.getItem(IntentStorage.STORE_KEY) || undefined;
        if (storedIntent === undefined) {
            return;
        }
        const intent = JSON.parse(storedIntent);
        if (!isAnIntent(intent)) {
            return;
        }
        return intent;
    }
    clear() {
        sessionStorage.removeItem(IntentStorage.STORE_KEY);
    }
    set(intent) {
        sessionStorage.setItem(IntentStorage.STORE_KEY, JSON.stringify(intent));
    }
}
IntentStorage.STORE_KEY = 'lib-bb-intent:navigated-intent';
IntentStorage.decorators = [
    { type: Injectable }
];
// Incoming
function isAnIntent(intent) {
    if (typeof intent !== 'object' || intent === null) {
        return false;
    }
    const assumedIntent = intent;
    const hasName = typeof assumedIntent.name === 'string';
    const hasParameters = typeof assumedIntent.parameters === 'object' && assumedIntent.parameters !== null;
    return hasName && hasParameters;
}
function intentHandler(guard, handle) {
    return intent => {
        if (!guard(intent)) {
            return undefined;
        }
        return handle(intent.parameters);
    };
}
export const INTENT_INCOMING_MAPPING = new InjectionToken('INTENT_INCOMING_MAPPING');
export class IntentBridgeService {
    constructor(rootModel, itemNavigation, store, handlers) {
        this.rootModel = rootModel;
        this.itemNavigation = itemNavigation;
        this.store = store;
        this.handlers = handlers;
    }
    handleIntentFromStorage(handlers) {
        const intent = this.store.get();
        if (!intent) {
            return;
        }
        for (const handle of handlers) {
            const handling = handle(intent);
            if (handling) {
                this.store.clear();
                return handling;
            }
        }
        return;
    }
    handleIncomingIntent() {
        this.handleIntentFromStorage(this.handlers.map(({ guard, group, extract }) => intentHandler(guard, parameters => {
            const params = { [group]: extract(parameters) };
            return this.rootModel
                .commonAncestor(new CommunicationDefinition('route-param', group))
                .pipe(first(), map(commonAncestor => {
                if (commonAncestor === undefined) {
                    return console.warn('No Inputs configured to receive route param');
                }
                this.itemNavigation.navigateToItem(commonAncestor.name, params);
            }))
                .toPromise();
        })));
    }
}
IntentBridgeService.decorators = [
    { type: Injectable }
];
IntentBridgeService.ctorParameters = () => [
    { type: ӨRootContainerService },
    { type: ӨItemNavigationService },
    { type: IntentStorage },
    { type: Array, decorators: [{ type: Inject, args: [INTENT_INCOMING_MAPPING,] }] }
];
// Outgoing
const TAG = 'intent';
/**
 * @deprecated Will be removed in v7.0.0
 * Intent Communication Transport
 *
 * Can be used in standalone development to configure communication using Intents.
 *
 * Note: This Transport does not currently support Input handling. Incoming Intents can be handled
 * by mapping them to a RouteParam by providing an `IncomingIntentMapping`
 */
export class IntentIO {
    /**
     * Generate a serialized communication configuration suitable for use as a Widget Output property value.
     *
     * @param group The name of the communication group to which the Output belongs
     */
    static toProperty(group) {
        return serializerDeserializer.toProperty(new CommunicationDefinition(TAG, group));
    }
}
export const INTENTS_OUTGOING_MAPPING = new InjectionToken('OutgoingIntentMapping');
export class IntentPipeline {
    constructor(navigator, storage, outgoingMappings) {
        this.navigator = navigator;
        this.storage = storage;
        this.outgoingMappings = outgoingMappings;
    }
    sink(group) {
        return (stdin) => {
            const creator = this.outgoingMappings.find(mapping => mapping.group === group);
            if (!creator) {
                return;
            }
            void stdin.subscribe((value) => {
                const parameters = creator.parameters(value);
                const intent = {
                    name: creator.intent,
                    parameters,
                };
                this.storage.set(intent);
                this.navigator.go(creator.targetUrl);
            });
        };
    }
}
export function createIntentPipeline(navigator, storage, creators) {
    return new IntentPipeline(navigator, storage, creators);
}
export const intentProcessorConfig = {
    name: TAG,
    provider: {
        provide: new InjectionToken('Intents pipeline handler'),
        useFactory: createIntentPipeline,
        deps: [IntentNavigation, IntentStorage, INTENTS_OUTGOING_MAPPING],
    },
};
/**
 * @deprecated Will be removed in v7.0.0
 */
export class IntentsBridgeModule {
    static forRoot(config) {
        return {
            ngModule: IntentsBridgeModule,
            providers: [
                {
                    provide: INTENTS_OUTGOING_MAPPING,
                    useValue: config.outgoing,
                },
                {
                    provide: INTENT_INCOMING_MAPPING,
                    useValue: config.incoming,
                },
                IntentBridgeService,
                {
                    provide: APP_INITIALIZER,
                    useFactory: initIntents,
                    deps: [IntentBridgeService],
                    multi: true,
                },
                IntentStorage,
                IntentNavigation,
            ],
        };
    }
}
IntentsBridgeModule.decorators = [
    { type: NgModule, args: [{
                imports: [
                    BackbaseCoreModule.withConfig({
                        pipelineProcessors: [intentProcessorConfig],
                    }),
                ],
            },] }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW50ZW50cy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL2JhY2tiYXNlL2ZvdW5kYXRpb24tYW5nL21pZ3JhdGlvbi9zcmMvaW50ZW50cy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxjQUFjLEVBQXVCLFFBQVEsRUFBRSxlQUFlLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDbkgsT0FBTyxFQUFFLHVCQUF1QixFQUFFLHNCQUFzQixFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFFbkcsT0FBTyxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUU1QyxPQUFPLEVBQ0wsa0JBQWtCLEVBSWxCLHNCQUFzQixFQUN0QixxQkFBcUIsR0FDdEIsTUFBTSwrQkFBK0IsQ0FBQztBQUV2QyxNQUFNLFVBQVUsV0FBVyxDQUFDLG1CQUF3QztJQUNsRSxPQUFPLG1CQUFtQixDQUFDLG9CQUFvQixDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO0FBQzVFLENBQUM7QUFnQkQsTUFBTSxPQUFPLGdCQUFnQjtJQUMzQixFQUFFLENBQUMsR0FBVztRQUNaLFFBQVEsQ0FBQyxJQUFJLEdBQUcsR0FBRyxDQUFDO0lBQ3RCLENBQUM7OztZQUpGLFVBQVU7O0FBUVgsTUFBTSxPQUFPLGFBQWE7SUFHeEIsR0FBRztRQUNELE1BQU0sWUFBWSxHQUF1QixjQUFjLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsSUFBSSxTQUFTLENBQUM7UUFDdEcsSUFBSSxZQUFZLEtBQUssU0FBUyxFQUFFO1lBQzlCLE9BQU87U0FDUjtRQUNELE1BQU0sTUFBTSxHQUFZLElBQUksQ0FBQyxLQUFLLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDakQsSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsRUFBRTtZQUN2QixPQUFPO1NBQ1I7UUFD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RSxPQUFPLEVBQUUsdUJBQXVCO29CQUNoQyxRQUFRLEVBQUUsTUFBTSxDQUFDLFFBQVE7aUJBQzFCO2dCQUNELG1CQUFtQjtnQkFDbkI7b0JBQ0UsT0FBTyxFQUFFLGVBQWU7b0JBQ3hCLFVBQVUsRUFBRSxXQUFXO29CQUN2QixJQUFJLEVBQUUsQ0FBQyxtQkFBbUIsQ0FBQztvQkFDM0IsS0FBSyxFQUFFLElBQUk7aUJBQ1o7Z0JBQ0QsYUFBYTtnQkFDYixnQkFBZ0I7YUFDakI7U0FDRixDQUFDO0lBQ0osQ0FBQzs7O1lBbENGLFFBQVEsU0FBQztnQkFDUixPQUFPLEVBQUU7b0JBQ1Asa0JBQWtCLENBQUMsVUFBVSxDQUFDO3dCQUM1QixrQkFBa0IsRUFBRSxDQUFDLHFCQUFxQixDQUFDO3FCQUM1QyxDQUFDO2lCQUNIO2FBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUsIEluamVjdGlvblRva2VuLCBNb2R1bGVXaXRoUHJvdmlkZXJzLCBOZ01vZHVsZSwgQVBQX0lOSVRJQUxJWkVSIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBDb21tdW5pY2F0aW9uRGVmaW5pdGlvbiwgc2VyaWFsaXplckRlc2VyaWFsaXplciB9IGZyb20gJ0BiYWNrYmFzZS9jb21tdW5pY2F0aW9uLXByb3BlcnR5JztcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGZpcnN0LCBtYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7XG4gIEJhY2tiYXNlQ29yZU1vZHVsZSxcbiAgUGlwZWxpbmVTaW5rLFxuICBTaW5rLFxuICBQaXBlbGluZVByb2Nlc3NvckNvbmZpZyxcbiAg06hJdGVtTmF2aWdhdGlvblNlcnZpY2UsXG4gINOoUm9vdENvbnRhaW5lclNlcnZpY2UsXG59IGZyb20gJ0BiYWNrYmFzZS9mb3VuZGF0aW9uLWFuZy9jb3JlJztcblxuZXhwb3J0IGZ1bmN0aW9uIGluaXRJbnRlbnRzKGludGVudEJyaWRnZVNlcnZpY2U6IEludGVudEJyaWRnZVNlcnZpY2UpIHtcbiAgcmV0dXJuIGludGVudEJyaWRnZVNlcnZpY2UuaGFuZGxlSW5jb21pbmdJbnRlbnQuYmluZChpbnRlbnRCcmlkZ2VTZXJ2aWNlKTtcbn1cblxuLyoqXG4gKiBAZGVwcmVjYXRlZCBXaWxsIGJlIHJlbW92ZWQgaW4gdjcuMC4wXG4gKiBBIFdBMiBjb21wYXRpYmxlIEludGVudFxuICpcbiAqIFRoaXMgaXMgdGhlIGludGVyb3BlcmFibGUgZm9ybWF0IHRoYXQgaXMgc3VwcG9ydGVkIGJ5IGJvdGggc2lkZXMgb2YgdGhlIGNvbW11bmljYXRpb25cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBJbnRlbnQ8VCBleHRlbmRzIG9iamVjdCA9IG9iamVjdD4ge1xuICAvKiogVGhlIG5hbWUgb2YgdGhlIEludGVudCB1c2VkIHRvIGlkZW50aWZ5IGl0ICovXG4gIG5hbWU6IHN0cmluZztcbiAgLyoqIEFueSBleHRyYSBkYXRhIGFzc29jaWF0ZWQgd2l0aCB0aGUgaW50ZW50IHRoYXQgY2FuIGJlIHVzZWQgYnkgdGhlIHJlY2VpdmluZyBzaWRlICovXG4gIHBhcmFtZXRlcnM6IFQ7XG59XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBJbnRlbnROYXZpZ2F0aW9uIHtcbiAgZ28odXJsOiBzdHJpbmcpIHtcbiAgICBsb2NhdGlvbi5ocmVmID0gdXJsO1xuICB9XG59XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBJbnRlbnRTdG9yYWdlIHtcbiAgc3RhdGljIFNUT1JFX0tFWSA9ICdsaWItYmItaW50ZW50Om5hdmlnYXRlZC1pbnRlbnQnO1xuXG4gIGdldCgpOiBJbnRlbnQgfCB1bmRlZmluZWQge1xuICAgIGNvbnN0IHN0b3JlZEludGVudDogc3RyaW5nIHwgdW5kZWZpbmVkID0gc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbShJbnRlbnRTdG9yYWdlLlNUT1JFX0tFWSkgfHwgdW5kZWZpbmVkO1xuICAgIGlmIChzdG9yZWRJbnRlbnQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBpbnRlbnQ6IHVua25vd24gPSBKU09OLnBhcnNlKHN0b3JlZEludGVudCk7XG4gICAgaWYgKCFpc0FuSW50ZW50KGludGVudCkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgcmV0dXJuIGludGVudDtcbiAgfVxuXG4gIGNsZWFyKCk6IHZvaWQge1xuICAgIHNlc3Npb25TdG9yYWdlLnJlbW92ZUl0ZW0oSW50ZW50U3RvcmFnZS5TVE9SRV9LRVkpO1xuICB9XG5cbiAgc2V0KGludGVudDogSW50ZW50KTogdm9pZCB7XG4gICAgc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbShJbnRlbnRTdG9yYWdlLlNUT1JFX0tFWSwgSlNPTi5zdHJpbmdpZnkoaW50ZW50KSk7XG4gIH1cbn1cblxuLy8gSW5jb21pbmdcblxuZnVuY3Rpb24gaXNBbkludGVudChpbnRlbnQ6IHVua25vd24pOiBpbnRlbnQgaXMgSW50ZW50IHtcbiAgaWYgKHR5cGVvZiBpbnRlbnQgIT09ICdvYmplY3QnIHx8IGludGVudCA9PT0gbnVsbCkge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuICBjb25zdCBhc3N1bWVkSW50ZW50ID0gaW50ZW50IGFzIEludGVudDtcbiAgY29uc3QgaGFzTmFtZSA9IHR5cGVvZiBhc3N1bWVkSW50ZW50Lm5hbWUgPT09ICdzdHJpbmcnO1xuICBjb25zdCBoYXNQYXJhbWV0ZXJzID0gdHlwZW9mIGFzc3VtZWRJbnRlbnQucGFyYW1ldGVycyA9PT0gJ29iamVjdCcgJiYgYXNzdW1lZEludGVudC5wYXJhbWV0ZXJzICE9PSBudWxsO1xuICByZXR1cm4gaGFzTmFtZSAmJiBoYXNQYXJhbWV0ZXJzO1xufVxuXG5mdW5jdGlvbiBpbnRlbnRIYW5kbGVyPFQgZXh0ZW5kcyBJbnRlbnQ+KFxuICBndWFyZDogKGludGVudDogSW50ZW50KSA9PiBpbnRlbnQgaXMgVCxcbiAgaGFuZGxlOiAodDogVFsncGFyYW1ldGVycyddKSA9PiBQcm9taXNlPHZvaWQ+LFxuKTogKGludGVudDogSW50ZW50KSA9PiB1bmRlZmluZWQgfCBQcm9taXNlPHZvaWQ+IHtcbiAgcmV0dXJuIGludGVudCA9PiB7XG4gICAgaWYgKCFndWFyZChpbnRlbnQpKSB7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cbiAgICByZXR1cm4gaGFuZGxlKGludGVudC5wYXJhbWV0ZXJzKTtcbiAgfTtcbn1cblxuLyoqXG4gKiBAZGVwcmVjYXRlZCBXaWxsIGJlIHJlbW92ZWQgaW4gdjcuMC4wXG4gKiBEZXNjcmliZSB0aGUgbWFwcGluZyBvZiBhbiBpbmNvbWluZyBJbnRlbnQgdG8gYSBSb3V0ZVBhcmFtIGNvbW11bmljYXRpb25cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBJbmNvbWluZ0ludGVudE1hcHBpbmc8SSBleHRlbmRzIEludGVudD4ge1xuICAvKipcbiAgICogRGV0ZXJtaW5lIGlmIHRoZSBpbmNvbWluZyBpbnRlbnQgY2FuIGJlIGhhbmRsZWQgYnkgdGhpcyBtYXBwZXJcbiAgICpcbiAgICogVGhpcyB3aWxsIGxpa2VseSBpbnZvbHZlIGNoZWNraW5nIHRoZSBuYW1lIG9mIHRoZSBpbnRlbnQgYW5kIHRoYXQgYW55IHJlcXVpcmVkIHBhcmFtZXRlcnMgd2VyZSBzZW50XG4gICAqL1xuICBndWFyZDogKGludGVudDogSSkgPT4gaW50ZW50IGlzIEk7XG4gIC8qKlxuICAgKiBFeHRyYWN0IHRoZSB2YWx1ZSBmcm9tIHRoZSBJbnRlbnRzIHBhcmFtZXRlcnMgdG8gYmUgcGFzc2VkIHRvIHRoZSBSb3V0ZVBhcmFtIGNvbW11bmljYXRpb24gZ3JvdXBcbiAgICovXG4gIGV4dHJhY3Q6IChwYXJhbWV0ZXJzOiBJWydwYXJhbWV0ZXJzJ10pID0+IHN0cmluZztcbiAgLyoqXG4gICAqIFRoZSBuYW1lIG9mIHRoZSBjb21tdW5pY2F0aW9uIGdyb3VwIHRoYXQgaXMgdGhlIHRhcmdldCBvZiB0aGUgcmVzdWx0aW5nIFJvdXRlUGFyYW0gY29tbXVuaWNhdGlvblxuICAgKi9cbiAgZ3JvdXA6IHN0cmluZztcbn1cblxuZXhwb3J0IGNvbnN0IElOVEVOVF9JTkNPTUlOR19NQVBQSU5HID0gbmV3IEluamVjdGlvblRva2VuKCdJTlRFTlRfSU5DT01JTkdfTUFQUElORycpO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgSW50ZW50QnJpZGdlU2VydmljZSB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgcm9vdE1vZGVsOiDTqFJvb3RDb250YWluZXJTZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgaXRlbU5hdmlnYXRpb246INOoSXRlbU5hdmlnYXRpb25TZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgc3RvcmU6IEludGVudFN0b3JhZ2UsXG4gICAgQEluamVjdChJTlRFTlRfSU5DT01JTkdfTUFQUElORykgcHJpdmF0ZSByZWFkb25seSBoYW5kbGVyczogQXJyYXk8SW5jb21pbmdJbnRlbnRNYXBwaW5nPEludGVudDxhbnk+Pj4sXG4gICkge31cblxuICBwcml2YXRlIGhhbmRsZUludGVudEZyb21TdG9yYWdlKGhhbmRsZXJzOiBBcnJheTwoaW50ZW50OiBJbnRlbnQpID0+IHVuZGVmaW5lZCB8IFByb21pc2U8dm9pZD4+KSB7XG4gICAgY29uc3QgaW50ZW50ID0gdGhpcy5zdG9yZS5nZXQoKTtcbiAgICBpZiAoIWludGVudCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGZvciAoY29uc3QgaGFuZGxlIG9mIGhhbmRsZXJzKSB7XG4gICAgICBjb25zdCBoYW5kbGluZyA9IGhhbmRsZShpbnRlbnQpO1xuICAgICAgaWYgKGhhbmRsaW5nKSB7XG4gICAgICAgIHRoaXMuc3RvcmUuY2xlYXIoKTtcbiAgICAgICAgcmV0dXJuIGhhbmRsaW5nO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm47XG4gIH1cblxuICBoYW5kbGVJbmNvbWluZ0ludGVudCgpOiB2b2lkIHtcbiAgICB0aGlzLmhhbmRsZUludGVudEZyb21TdG9yYWdlKFxuICAgICAgdGhpcy5oYW5kbGVycy5tYXAoKHsgZ3VhcmQsIGdyb3VwLCBleHRyYWN0IH0pID0+XG4gICAgICAgIGludGVudEhhbmRsZXIoZ3VhcmQsIHBhcmFtZXRlcnMgPT4ge1xuICAgICAgICAgIGNvbnN0IHBhcmFtcyA9IHsgW2dyb3VwXTogZXh0cmFjdChwYXJhbWV0ZXJzKSB9O1xuICAgICAgICAgIHJldHVybiB0aGlzLnJvb3RNb2RlbFxuICAgICAgICAgICAgLmNvbW1vbkFuY2VzdG9yKG5ldyBDb21tdW5pY2F0aW9uRGVmaW5pdGlvbigncm91dGUtcGFyYW0nLCBncm91cCkpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgZmlyc3QoKSxcbiAgICAgICAgICAgICAgbWFwKGNvbW1vbkFuY2VzdG9yID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoY29tbW9uQW5jZXN0b3IgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbnNvbGUud2FybignTm8gSW5wdXRzIGNvbmZpZ3VyZWQgdG8gcmVjZWl2ZSByb3V0ZSBwYXJhbScpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0aGlzLml0ZW1OYXZpZ2F0aW9uLm5hdmlnYXRlVG9JdGVtKGNvbW1vbkFuY2VzdG9yLm5hbWUsIHBhcmFtcyk7XG4gICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgKVxuICAgICAgICAgICAgLnRvUHJvbWlzZSgpO1xuICAgICAgICB9KSxcbiAgICAgICksXG4gICAgKTtcbiAgfVxufVxuXG4vLyBPdXRnb2luZ1xuXG5jb25zdCBUQUcgPSAnaW50ZW50JztcblxuLyoqXG4gKiBAZGVwcmVjYXRlZCBXaWxsIGJlIHJlbW92ZWQgaW4gdjcuMC4wXG4gKiBJbnRlbnQgQ29tbXVuaWNhdGlvbiBUcmFuc3BvcnRcbiAqXG4gKiBDYW4gYmUgdXNlZCBpbiBzdGFuZGFsb25lIGRldmVsb3BtZW50IHRvIGNvbmZpZ3VyZSBjb21tdW5pY2F0aW9uIHVzaW5nIEludGVudHMuXG4gKlxuICogTm90ZTogVGhpcyBUcmFuc3BvcnQgZG9lcyBub3QgY3VycmVudGx5IHN1cHBvcnQgSW5wdXQgaGFuZGxpbmcuIEluY29taW5nIEludGVudHMgY2FuIGJlIGhhbmRsZWRcbiAqIGJ5IG1hcHBpbmcgdGhlbSB0byBhIFJvdXRlUGFyYW0gYnkgcHJvdmlkaW5nIGFuIGBJbmNvbWluZ0ludGVudE1hcHBpbmdgXG4gKi9cbmV4cG9ydCBjbGFzcyBJbnRlbnRJTyB7XG4gIC8qKlxuICAgKiBHZW5lcmF0ZSBhIHNlcmlhbGl6ZWQgY29tbXVuaWNhdGlvbiBjb25maWd1cmF0aW9uIHN1aXRhYmxlIGZvciB1c2UgYXMgYSBXaWRnZXQgT3V0cHV0IHByb3BlcnR5IHZhbHVlLlxuICAgKlxuICAgKiBAcGFyYW0gZ3JvdXAgVGhlIG5hbWUgb2YgdGhlIGNvbW11bmljYXRpb24gZ3JvdXAgdG8gd2hpY2ggdGhlIE91dHB1dCBiZWxvbmdzXG4gICAqL1xuICBzdGF0aWMgdG9Qcm9wZXJ0eShncm91cDogc3RyaW5nKTogc3RyaW5nIHtcbiAgICByZXR1cm4gc2VyaWFsaXplckRlc2VyaWFsaXplci50b1Byb3BlcnR5KG5ldyBDb21tdW5pY2F0aW9uRGVmaW5pdGlvbihUQUcsIGdyb3VwKSk7XG4gIH1cbn1cblxuZXhwb3J0IGNvbnN0IElOVEVOVFNfT1VUR09JTkdfTUFQUElORyA9IG5ldyBJbmplY3Rpb25Ub2tlbignT3V0Z29pbmdJbnRlbnRNYXBwaW5nJyk7XG5cbi8qKlxuICogQGRlcHJlY2F0ZWQgV2lsbCBiZSByZW1vdmVkIGluIHY3LjAuMFxuICogRGVzY3JpYmUgdGhlIG1hcHBpbmcgb2YgYW4gT3V0cHV0IHRvIGFuIEludGVudFxuICovXG5leHBvcnQgaW50ZXJmYWNlIE91dGdvaW5nSW50ZW50TWFwcGluZzxPdXRwdXQsIEkgZXh0ZW5kcyBJbnRlbnQ+IHtcbiAgLyoqIFRoZSBuYW1lIG9mIHRoZSBjb21tdW5pY2F0aW9uIGdyb3VwIHRhcmdldGVkIGJ5IHRoZSBpbnRlbnQgb3V0cHV0ICovXG4gIGdyb3VwOiBzdHJpbmc7XG4gIC8qKiBUaGUgVVJMIG9uIHdoaWNoIHRoZSB0YXJnZXQgaXMgaG9zdGVkICovXG4gIHRhcmdldFVybDogc3RyaW5nO1xuICAvKiogVGhlIG5hbWUgb2YgdGhlIGludGVudCB0aGF0IHdpbGwgYmUgY3JlYXRlZCBmcm9tIHRoZSBlbWl0dGVkIG91dHB1dCB2YWx1ZSAqL1xuICBpbnRlbnQ6IElbJ25hbWUnXTtcbiAgLyoqIENyZWF0ZSB0aGUgaW50ZW50IHBhcmFtZXRlcnMgYmFzZWQgb24gdGhlIGVtaXR0ZWQgb3V0cHV0IHZhbHVlICovXG4gIHBhcmFtZXRlcnM6IChvdXRwdXQ6IE91dHB1dCkgPT4gSVsncGFyYW1ldGVycyddO1xufVxuXG5leHBvcnQgY2xhc3MgSW50ZW50UGlwZWxpbmU8T3V0cHV0PiBpbXBsZW1lbnRzIFBpcGVsaW5lU2luazxPdXRwdXQ+IHtcbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBuYXZpZ2F0b3I6IEludGVudE5hdmlnYXRpb24sXG4gICAgcHJpdmF0ZSByZWFkb25seSBzdG9yYWdlOiBJbnRlbnRTdG9yYWdlLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgb3V0Z29pbmdNYXBwaW5nczogQXJyYXk8T3V0Z29pbmdJbnRlbnRNYXBwaW5nPE91dHB1dCwgSW50ZW50Pj4sXG4gICkge31cblxuICBzaW5rKGdyb3VwOiBzdHJpbmcpOiBTaW5rPE91dHB1dD4ge1xuICAgIHJldHVybiAoc3RkaW46IE9ic2VydmFibGU8T3V0cHV0Pik6IHZvaWQgPT4ge1xuICAgICAgY29uc3QgY3JlYXRvciA9IHRoaXMub3V0Z29pbmdNYXBwaW5ncy5maW5kKG1hcHBpbmcgPT4gbWFwcGluZy5ncm91cCA9PT0gZ3JvdXApO1xuICAgICAgaWYgKCFjcmVhdG9yKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIHZvaWQgc3RkaW4uc3Vic2NyaWJlKCh2YWx1ZTogT3V0cHV0KSA9PiB7XG4gICAgICAgIGNvbnN0IHBhcmFtZXRlcnMgPSBjcmVhdG9yLnBhcmFtZXRlcnModmFsdWUpO1xuICAgICAgICBjb25zdCBpbnRlbnQ6IEludGVudCA9IHtcbiAgICAgICAgICBuYW1lOiBjcmVhdG9yLmludGVudCxcbiAgICAgICAgICBwYXJhbWV0ZXJzLFxuICAgICAgICB9O1xuICAgICAgICB0aGlzLnN0b3JhZ2Uuc2V0KGludGVudCk7XG4gICAgICAgIHRoaXMubmF2aWdhdG9yLmdvKGNyZWF0b3IudGFyZ2V0VXJsKTtcbiAgICAgIH0pO1xuICAgIH07XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZUludGVudFBpcGVsaW5lPE91dHB1dD4oXG4gIG5hdmlnYXRvcjogSW50ZW50TmF2aWdhdGlvbixcbiAgc3RvcmFnZTogSW50ZW50U3RvcmFnZSxcbiAgY3JlYXRvcnM6IEFycmF5PE91dGdvaW5nSW50ZW50TWFwcGluZzxPdXRwdXQsIEludGVudD4+LFxuKSB7XG4gIHJldHVybiBuZXcgSW50ZW50UGlwZWxpbmUobmF2aWdhdG9yLCBzdG9yYWdlLCBjcmVhdG9ycyk7XG59XG5cbmV4cG9ydCBjb25zdCBpbnRlbnRQcm9jZXNzb3JDb25maWc6IFBpcGVsaW5lUHJvY2Vzc29yQ29uZmlnPCdpbnRlbnQnPiA9IHtcbiAgbmFtZTogVEFHLFxuICBwcm92aWRlcjoge1xuICAgIHByb3ZpZGU6IG5ldyBJbmplY3Rpb25Ub2tlbignSW50ZW50cyBwaXBlbGluZSBoYW5kbGVyJyksXG4gICAgdXNlRmFjdG9yeTogY3JlYXRlSW50ZW50UGlwZWxpbmUsXG4gICAgZGVwczogW0ludGVudE5hdmlnYXRpb24sIEludGVudFN0b3JhZ2UsIElOVEVOVFNfT1VUR09JTkdfTUFQUElOR10sXG4gIH0sXG59O1xuXG4vKipcbiAqIEBkZXByZWNhdGVkIFdpbGwgYmUgcmVtb3ZlZCBpbiB2Ny4wLjBcbiAqL1xuQE5nTW9kdWxlKHtcbiAgaW1wb3J0czogW1xuICAgIEJhY2tiYXNlQ29yZU1vZHVsZS53aXRoQ29uZmlnKHtcbiAgICAgIHBpcGVsaW5lUHJvY2Vzc29yczogW2ludGVudFByb2Nlc3NvckNvbmZpZ10sXG4gICAgfSksXG4gIF0sXG59KVxuZXhwb3J0IGNsYXNzIEludGVudHNCcmlkZ2VNb2R1bGUge1xuICBzdGF0aWMgZm9yUm9vdChjb25maWc6IHtcbiAgICBpbmNvbWluZzogQXJyYXk8SW5jb21pbmdJbnRlbnRNYXBwaW5nPEludGVudDxhbnk+Pj47XG4gICAgb3V0Z29pbmc6IEFycmF5PE91dGdvaW5nSW50ZW50TWFwcGluZzxhbnksIGFueT4+O1xuICB9KTogTW9kdWxlV2l0aFByb3ZpZGVyczxJbnRlbnRzQnJpZGdlTW9kdWxlPiB7XG4gICAgcmV0dXJuIHtcbiAgICAgIG5nTW9kdWxlOiBJbnRlbnRzQnJpZGdlTW9kdWxlLFxuICAgICAgcHJvdmlkZXJzOiBbXG4gICAgICAgIHtcbiAgICAgICAgICBwcm92aWRlOiBJTlRFTlRTX09VVEdPSU5HX01BUFBJTkcsXG4gICAgICAgICAgdXNlVmFsdWU6IGNvbmZpZy5vdXRnb2luZyxcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIHByb3ZpZGU6IElOVEVOVF9JTkNPTUlOR19NQVBQSU5HLFxuICAgICAgICAgIHVzZVZhbHVlOiBjb25maWcuaW5jb21pbmcsXG4gICAgICAgIH0sXG4gICAgICAgIEludGVudEJyaWRnZVNlcnZpY2UsXG4gICAgICAgIHtcbiAgICAgICAgICBwcm92aWRlOiBBUFBfSU5JVElBTElaRVIsXG4gICAgICAgICAgdXNlRmFjdG9yeTogaW5pdEludGVudHMsXG4gICAgICAgICAgZGVwczogW0ludGVudEJyaWRnZVNlcnZpY2VdLFxuICAgICAgICAgIG11bHRpOiB0cnVlLFxuICAgICAgICB9LFxuICAgICAgICBJbnRlbnRTdG9yYWdlLFxuICAgICAgICBJbnRlbnROYXZpZ2F0aW9uLFxuICAgICAgXSxcbiAgICB9O1xuICB9XG59XG4iXX0=