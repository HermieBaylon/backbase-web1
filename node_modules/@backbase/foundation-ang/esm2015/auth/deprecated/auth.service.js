import { forwardRef, Inject, Injectable, Optional } from '@angular/core';
import { LOGOUT, REAUTHENTICATE, SESSION, ɵAUTH_EVENTS, } from '@backbase/foundation-ang/web-sdk';
import { BehaviorSubject, merge } from 'rxjs';
import { distinctUntilChanged, filter, map, mapTo, pluck, switchMap } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "@backbase/foundation-ang/web-sdk";
/**
 * @deprecated Will be removed in v7.0.0
 */
export class AuthService {
}
AuthService.ɵprov = i0.ɵɵdefineInjectable({ factory: function AuthService_Factory() { return new AuthServiceImpl(i0.ɵɵinject(i1.LOGOUT, 8), i0.ɵɵinject(i1.REAUTHENTICATE, 8), i0.ɵɵinject(i1.SESSION, 8), i0.ɵɵinject(i1.ɵAUTH_EVENTS, 8)); }, token: AuthService, providedIn: "root" });
AuthService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root',
                // eslint-disable-next-line  no-use-before-define, @typescript-eslint/no-use-before-define
                useClass: forwardRef(() => AuthServiceImpl), // Default implementation (allows mocking / replacing)
            },] }
];
export class AuthServiceImpl {
    constructor(logoutService, reauthenticateService, sessionService, authEvents) {
        this.accessTokenSubject = new BehaviorSubject(undefined);
        this.isLoadingSubject = new BehaviorSubject(true);
        /**
         * The current access token for the session, or `undefined` if there is no session.
         *
         * The first token will be emitted after the session is initialised. So if the user is logged
         * in already then the first emission will be an access token.
         *
         * This is a hot observable, so subscribing to it won't trigger anything.
         *
         * The latest value will be replayed to late subscribers.
         */
        this.accessToken = this.isLoadingSubject.pipe(filter(loading => !loading), distinctUntilChanged(), switchMap(() => this.accessTokenSubject));
        /**
         * Track whether the current user is authenticated.
         *
         * This is a hot observable, so subscribing to it won't trigger anything.
         *
         * The latest value will be replayed to late subscribers.
         */
        this.isAuthenticated = this.accessToken.pipe(map(token => !!token));
        if (!logoutService || !reauthenticateService || !sessionService || !authEvents) {
            throw new Error('In order to use the @backbase/foundation-ang/auth, please include *either* the ' +
                'WebSdkModule.forRoot(...) in your AppModule (for CDN deployment) or WebSdkApiModule ' +
                '(for CX deployment)');
        }
        this.logoutService = logoutService;
        this.reauthenticateService = reauthenticateService;
        this.sessionService = sessionService;
        this.authEvents = authEvents;
        this.handleAuthEvents();
    }
    /**
     * Redirect the user to the login page.
     *
     * @param loginOptions
     */
    login(loginOptions) {
        this.logoutService.goToLoginPage(loginOptions === null || loginOptions === void 0 ? void 0 : loginOptions.redirectUri);
    }
    /**
     * Log out the current user.
     *
     * @param logoutOptions
     */
    logout(logoutOptions) {
        return this.logoutService.logout(logoutOptions === null || logoutOptions === void 0 ? void 0 : logoutOptions.redirectUri);
    }
    /**
     * Register a set of callbacks that will be called as the user's session gets close to expiring.
     *
     * @param countdown
     */
    registerSessionCountdown(countdown) {
        this.sessionService.registerCountdown(countdown);
    }
    /**
     * Return the time to live (TTL) in seconds of the user's session.
     *
     * Returns -1 if the TTL can't be determined.
     */
    timeToLive() {
        return this.sessionService.timeToLive();
    }
    /**
     * Returns whether the user is being impersonated.
     * @returns true if the user is being impersonated.
     */
    isImpersonated() {
        return this.sessionService.isImpersonated;
    }
    /**
     * Reauthenticate the current user.
     *
     * This can be used when the backend responds with a 401 and the current user needs to
     * reauthenticate.
     *
     * @usageNotes
     *
     * You can use this service to create an interceptor which will automatically redirect the
     * user when the backend responds with a 401. Useful when the backend responds with a challenge
     * (eg: for step-up multifactor authentication):
     *
     * ```
     * import { HttpEvent, HttpHandler, HttpInterceptor, HttpRequest, HttpResponse } from '@angular/common/http';
     * import { from, Observable } from 'rxjs';
     * import { catchError, first, mapTo } from 'rxjs/operators';
     * import { AuthService } from '@backbase/foundation-ang/auth';
     *
     * export class ReauthenticateInterceptor implements HttpInterceptor {
     *   constructor(private readonly authService: AuthService) {}
     *   intercept(request: HttpRequest<any>, next: HttpHandler): Observable<HttpEvent<any>> {
     *     return next.handle(request).pipe(
     *       // When any HTTP request fails (you could check status & headers here to only catch some failures).
     *       catchError(error => {
     *         // Retreive the challenge from the server's response.
     *         const challenge: { scope: string; acrValues: string } = (error.error.challenges || []).find(
     *           c => c.scope !== undefined,
     *         );
     *         // Reauthenticate the user with the requested scope & acr values and redirect back to here.
     *         return from(
     *           this.authService.reauthenticate({
     *             scope: challenge.scope,
     *             acrValues: challenge.acrValues,
     *             redirect: true,
     *             redirectUri: location.href,
     *           }),
     *           // Retry the orignal request
     *         ).pipe(first(), mapTo(new HttpResponse({ body: error.error.data })));
     *       }),
     *     );
     *   }
     * }
     * ```
     *
     * @param reauthenticateOptions
     */
    reauthenticate(reauthenticateOptions) {
        return this.reauthenticateService.reauthenticate(reauthenticateOptions.scope, reauthenticateOptions.acrValues, reauthenticateOptions);
    }
    /**
     * Refreshes the session.
     */
    refresh() {
        return this.sessionService.refresh();
    }
    handleAuthEvents() {
        merge(this.authEvents.success.pipe(pluck('currentAccessToken')), this.authEvents.init.pipe(pluck('currentAccessToken')), this.authEvents.end.pipe(mapTo(undefined)), this.authEvents.error.pipe(mapTo(undefined)))
            .pipe(distinctUntilChanged((t1, t2) => (t1 === null || t1 === void 0 ? void 0 : t1.raw) === (t2 === null || t2 === void 0 ? void 0 : t2.raw)))
            .subscribe(token => {
            this.accessTokenSubject.next(token);
            this.isLoadingSubject.next(false);
        });
    }
}
AuthServiceImpl.ctorParameters = () => [
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [LOGOUT,] }] },
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [REAUTHENTICATE,] }] },
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [SESSION,] }] },
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [ɵAUTH_EVENTS,] }] }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvYmFja2Jhc2UvZm91bmRhdGlvbi1hbmcvYXV0aC9zcmMvZGVwcmVjYXRlZC9hdXRoLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN6RSxPQUFPLEVBQ0wsTUFBTSxFQUVOLGNBQWMsRUFFZCxPQUFPLEVBRVAsWUFBWSxHQUViLE1BQU0sa0NBQWtDLENBQUM7QUFDMUMsT0FBTyxFQUFFLGVBQWUsRUFBYyxLQUFLLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDMUQsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQzs7O0FBK0Y1Rjs7R0FFRztBQU1ILE1BQU0sT0FBZ0IsV0FBVzs7OztZQUxoQyxVQUFVLFNBQUM7Z0JBQ1YsVUFBVSxFQUFFLE1BQU07Z0JBQ2xCLDBGQUEwRjtnQkFDMUYsUUFBUSxFQUFFLFVBQVUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxlQUFlLENBQUMsRUFBRSxzREFBc0Q7YUFDcEc7O0FBYUQsTUFBTSxPQUFPLGVBQWU7SUFrQzFCLFlBQzhCLGFBQTZCLEVBQ3JCLHFCQUE2QyxFQUNwRCxjQUErQixFQUMxQixVQUF3QjtRQWhDM0MsdUJBQWtCLEdBQUcsSUFBSSxlQUFlLENBQTBCLFNBQVMsQ0FBQyxDQUFDO1FBQzdFLHFCQUFnQixHQUFHLElBQUksZUFBZSxDQUFVLElBQUksQ0FBQyxDQUFDO1FBRXZFOzs7Ozs7Ozs7V0FTRztRQUNhLGdCQUFXLEdBQXdDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQzNGLE1BQU0sQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFD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QUFHLENBQUEsQ0FBQyxDQUFDO2FBQzNELFNBQVMsQ0FBQyxLQUFLLENBQUMsRUFBRTtZQUNqQixJQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ3BDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDcEMsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDOzs7NENBMUlFLFFBQVEsWUFBSSxNQUFNLFNBQUMsTUFBTTs0Q0FDekIsUUFBUSxZQUFJLE1BQU0sU0FBQyxjQUFjOzRDQUNqQyxRQUFRLFlBQUksTUFBTSxTQUFDLE9BQU87NENBQzFCLFFBQVEsWUFBSSxNQUFNLFNBQUMsWUFBWSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGZvcndhcmRSZWYsIEluamVjdCwgSW5qZWN0YWJsZSwgT3B0aW9uYWwgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7XG4gIExPR09VVCxcbiAgTG9nb3V0U2VydmljZSxcbiAgUkVBVVRIRU5USUNBVEUsXG4gIFJlYXV0aGVudGljYXRlU2VydmljZSxcbiAgU0VTU0lPTixcbiAgU2Vzc2lvblNlcnZpY2UsXG4gIMm1QVVUSF9FVkVOVFMsXG4gIMm1QXV0aEV2ZW50cyxcbn0gZnJvbSAnQGJhY2tiYXNlL2ZvdW5kYXRpb24tYW5nL3dlYi1zZGsnO1xuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0LCBPYnNlcnZhYmxlLCBtZXJnZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZGlzdGluY3RVbnRpbENoYW5nZWQsIGZpbHRlciwgbWFwLCBtYXBUbywgcGx1Y2ssIHN3aXRjaE1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuLyoqXG4gKiBAZGVwcmVjYXRlZCBXaWxsIGJlIHJlbW92ZWQgaW4gdjcuMC4wXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgQWNjZXNzVG9rZW4ge1xuICByYXc6IHN0cmluZztcbiAgcGFyc2VkOiBhbnk7XG59XG5cbi8qKlxuICogQGludGVybmFsXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgQXV0aFN1Y2Nlc3NQYXlsb2FkIHtcbiAgY3VycmVudEFjY2Vzc1Rva2VuOiBBY2Nlc3NUb2tlbjtcbn1cblxuLyoqXG4gKiBAZGVwcmVjYXRlZCBXaWxsIGJlIHJlbW92ZWQgaW4gdjcuMC4wXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgTG9naW5PcHRpb25zIHtcbiAgLyoqXG4gICAqIFVybCBmb3IgcmVkaXJlY3RpbmcgdG8gYWZ0ZXIgbG9naW4gaXMgZG9uZSB3aXRoIHRoZSBhdXRob3Jpc2F0aW9uIHJlc3VsdC5cbiAgICovXG4gIHJlZGlyZWN0VXJpPzogc3RyaW5nO1xufVxuXG4vKipcbiAqIEBkZXByZWNhdGVkIFdpbGwgYmUgcmVtb3ZlZCBpbiB2Ny4wLjBcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBMb2dvdXRPcHRpb25zIHtcbiAgLyoqXG4gICAqIFVybCBmb3IgcmVkaXJlY3RpbmcgdG8gYWZ0ZXIgbG9nb3V0IGlzIGRvbmUuXG4gICAqL1xuICByZWRpcmVjdFVyaT86IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBSZWF1dGhlbnRpY2F0ZU9wdGlvbnMge1xuICAvKlxuICAgKiBUaGUgc2NvcGUgdG8gdXNlIGZvciB0aGUgcmVhdXRoZW50aWNhdGlvbiByZXF1ZXN0LlxuICAgKlxuICAgKiBGb3IgZXhhbXBsZSwgdGhlIHNjb3BlIGNhbiBiZSByZXR1cm5lZCBieSB0aGUgc2VydmVyIHdoZW4gY2hhbGxlbmdpbmcgYSByZXF1ZXN0IGZvciBhIHJlc291cmNlLCBzdWNoXG4gICAqIGFzIHJlcXVpcmluZyBtdWx0aWZhY3RvciBhdXRoZW50aWNhdGlvbi5cbiAgICovXG4gIHNjb3BlOiBzdHJpbmc7XG4gIC8qKlxuICAgKiBUaGUgYWNyIChBdXRoZW50aWNhdGlvbiBDb250ZXh0IENsYXNzIFJlZmVyZW5jZSkgY2xhaW0gYW5kIGFzc29jaWF0ZWQgYWNyX3ZhbHVlcyByZXF1ZXN0IHBhcmFtZXRlclxuICAgKiBhcmUgZGVmaW5lZCBieSB0aGUgT3BlbklEIENvbm5lY3QgQ29yZSAxLjAgc3BlY2lmaWNhdGlvbi5cbiAgICpcbiAgICogVGhlIHZhbHVlIHByb3ZpZGVkIGhlcmUgaXMgdXNlZCBhcyB0aGUgYGFjcl92YWx1ZXNgIGluIHRoZSByZWF1dGhlbnRpY2F0aW9uIHJlcXVlc3QuXG4gICAqXG4gICAqIEZvciBleGFtcGxlLCB0aGUgYWNyVmFsdWVzIG1heSBiZSByZXR1cm5lZCBieSB0aGUgc2VydmVyIHdoZW4gY2hhbGxlbmdpbmcgYSByZXF1ZXN0IGZvciBhIHJlc291cmNlLCBzdWNoXG4gICAqIGFzIHJlcXVpcmluZyBtdWx0aWZhY3RvciBhdXRoZW50aWNhdGlvbi5cbiAgICovXG4gIGFjclZhbHVlczogc3RyaW5nO1xuICAvKipcbiAgICogV2hldGhlciB0byByZWRpcmVjdCB0aGUgdXNlciBvciBwZXJmb3JtIGEgcmVxdWVzdC5cbiAgICovXG4gIHJlZGlyZWN0PzogYm9vbGVhbjtcbiAgLyoqXG4gICAqIFVybCB0byByZXR1cm4gdG8gZm9sbG93aW5nIHJlYXV0aGVudGljYXRpb24gcmVkaXJlY3QuXG4gICAqL1xuICByZWRpcmVjdFVyaT86IHN0cmluZztcbn1cblxuLyoqXG4gKiBAZGVwcmVjYXRlZCBXaWxsIGJlIHJlbW92ZWQgaW4gdjcuMC4wXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgQ291bnRkb3duT3B0aW9ucyB7XG4gIC8qKlxuICAgKiBDb25maWd1cmVzIHdoZW4gdGhlIGNvdW50ZG93biB3aWxsIHN0YXJ0LlxuICAgKlxuICAgKiBUaGUgY291bnRkb3duIHdpbGwgYHN0YXJ0YCBvbmNlIHRoZSBUVEwgZXF1YWxzIChvciBpcyBsZXNzIHRoYW4pIHRoZSBgZHVyYXRpb25gLlxuICAgKi9cbiAgZHVyYXRpb24/OiBudW1iZXI7XG4gIC8qKlxuICAgKiBDYWxsZWQgb25jZSB0aGUgY291bnRkb3duIGJlZ2lucyAod2hlbiBgVFRMIDwgZHVyYXRpb25gKS5cbiAgICovXG4gIHN0YXJ0OiAoKSA9PiB2b2lkO1xuICAvKipcbiAgICogQ2FsbGVkIG9uY2UgdGhlIHNlc3Npb24gaXMgcmVzZXQgKGFuZCBgVFRMID4gZHVyYXRpb25gKVxuICAgKi9cbiAgcmVzZXQ6ICgpID0+IHZvaWQ7XG4gIC8qKlxuICAgKiBDYWxsZWQgb25jZSB0aGUgc2Vzc2lvbiBleHBpcmVzIChUVEwgPSAwKVxuICAgKi9cbiAgZW5kOiAoKSA9PiB2b2lkO1xuICAvKipcbiAgICogQ2FsbGVkIGV2ZXJ5IHNlY29uZCBiZXR3ZWVuIGBzdGFydGAgYW5kIGBlbmRgLlxuICAgKlxuICAgKiBUaGUgYHJlbWFpbmluZ2AgcGFyYW0gaXMgdGhlIG51bWJlciBvZiBzZWNvbmRzIHJlbWFpbmluZyB1bnRpbCBUVEwgPSAwLlxuICAgKi9cbiAgdGljaz86IChyZW1haW5pbmc6IG51bWJlcikgPT4gdm9pZDtcbn1cblxuLyoqXG4gKiBAZGVwcmVjYXRlZCBXaWxsIGJlIHJlbW92ZWQgaW4gdjcuMC4wXG4gKi9cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnLFxuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgIG5vLXVzZS1iZWZvcmUtZGVmaW5lLCBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdXNlLWJlZm9yZS1kZWZpbmVcbiAgdXNlQ2xhc3M6IGZvcndhcmRSZWYoKCkgPT4gQXV0aFNlcnZpY2VJbXBsKSwgLy8gRGVmYXVsdCBpbXBsZW1lbnRhdGlvbiAoYWxsb3dzIG1vY2tpbmcgLyByZXBsYWNpbmcpXG59KVxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIEF1dGhTZXJ2aWNlIHtcbiAgYWJzdHJhY3QgcmVhZG9ubHkgYWNjZXNzVG9rZW46IE9ic2VydmFibGU8QWNjZXNzVG9rZW4gfCB1bmRlZmluZWQ+O1xuICBhYnN0cmFjdCByZWFkb25seSBpc0F1dGhlbnRpY2F0ZWQ6IE9ic2VydmFibGU8Ym9vbGVhbj47XG4gIGFic3RyYWN0IGxvZ2luKGxvZ2luT3B0aW9ucz86IExvZ2luT3B0aW9ucyk6IHZvaWQ7XG4gIGFic3RyYWN0IGxvZ291dChsb2dvdXRPcHRpb25zPzogTG9nb3V0T3B0aW9ucyk6IFByb21pc2U8dm9pZD47XG4gIGFic3RyYWN0IHJlYXV0aGVudGljYXRlKHJlYXV0aGVudGljYXRlT3B0aW9uczogUmVhdXRoZW50aWNhdGVPcHRpb25zKTogUHJvbWlzZTx2b2lkPjtcbiAgYWJzdHJhY3QgcmVnaXN0ZXJTZXNzaW9uQ291bnRkb3duKGNvdW50ZG93bjogQ291bnRkb3duT3B0aW9ucyk6IHZvaWQ7XG4gIGFic3RyYWN0IHRpbWVUb0xpdmUoKTogbnVtYmVyO1xuICBhYnN0cmFjdCByZWZyZXNoKCk6IFByb21pc2U8dm9pZD47XG4gIGFic3RyYWN0IGlzSW1wZXJzb25hdGVkKCk6IGJvb2xlYW47XG59XG5cbmV4cG9ydCBjbGFzcyBBdXRoU2VydmljZUltcGwgaW1wbGVtZW50cyBBdXRoU2VydmljZSB7XG4gIHByaXZhdGUgcmVhZG9ubHkgbG9nb3V0U2VydmljZTogTG9nb3V0U2VydmljZTtcbiAgcHJpdmF0ZSByZWFkb25seSByZWF1dGhlbnRpY2F0ZVNlcnZpY2U6IFJlYXV0aGVudGljYXRlU2VydmljZTtcbiAgcHJpdmF0ZSByZWFkb25seSBzZXNzaW9uU2VydmljZTogU2Vzc2lvblNlcnZpY2U7XG4gIHByaXZhdGUgcmVhZG9ubHkgYXV0aEV2ZW50czogybVBdXRoRXZlbnRzO1xuXG4gIHByaXZhdGUgcmVhZG9ubHkgYWNjZXNzVG9rZW5TdWJqZWN0ID0gbmV3IEJlaGF2aW9yU3ViamVjdDxBY2Nlc3NUb2tlbiB8IHVuZGVmaW5lZD4odW5kZWZpbmVkKTtcbiAgcHJpdmF0ZSByZWFkb25seSBpc0xvYWRpbmdTdWJqZWN0ID0gbmV3IEJlaGF2aW9yU3ViamVjdDxib29sZWFuPih0cnVlKTtcblxuICAvKipcbiAgICogVGhlIGN1cnJlbnQgYWNjZXNzIHRva2VuIGZvciB0aGUgc2Vzc2lvbiwgb3IgYHVuZGVmaW5lZGAgaWYgdGhlcmUgaXMgbm8gc2Vzc2lvbi5cbiAgICpcbiAgICogVGhlIGZpcnN0IHRva2VuIHdpbGwgYmUgZW1pdHRlZCBhZnRlciB0aGUgc2Vzc2lvbiBpcyBpbml0aWFsaXNlZC4gU28gaWYgdGhlIHVzZXIgaXMgbG9nZ2VkXG4gICAqIGluIGFscmVhZHkgdGhlbiB0aGUgZmlyc3QgZW1pc3Npb24gd2lsbCBiZSBhbiBhY2Nlc3MgdG9rZW4uXG4gICAqXG4gICAqIFRoaXMgaXMgYSBob3Qgb2JzZXJ2YWJsZSwgc28gc3Vic2NyaWJpbmcgdG8gaXQgd29uJ3QgdHJpZ2dlciBhbnl0aGluZy5cbiAgICpcbiAgICogVGhlIGxhdGVzdCB2YWx1ZSB3aWxsIGJlIHJlcGxheWVkIHRvIGxhdGUgc3Vic2NyaWJlcnMuXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgYWNjZXNzVG9rZW46IE9ic2VydmFibGU8QWNjZXNzVG9rZW4gfCB1bmRlZmluZWQ+ID0gdGhpcy5pc0xvYWRpbmdTdWJqZWN0LnBpcGUoXG4gICAgZmlsdGVyKGxvYWRpbmcgPT4gIWxvYWRpbmcpLFxuICAgIGRpc3RpbmN0VW50aWxDaGFuZ2VkKCksXG4gICAgc3dpdGNoTWFwKCgpID0+IHRoaXMuYWNjZXNzVG9rZW5TdWJqZWN0KSxcbiAgKTtcblxuICAvKipcbiAgICogVHJhY2sgd2hldGhlciB0aGUgY3VycmVudCB1c2VyIGlzIGF1dGhlbnRpY2F0ZWQuXG4gICAqXG4gICAqIFRoaXMgaXMgYSBob3Qgb2JzZXJ2YWJsZSwgc28gc3Vic2NyaWJpbmcgdG8gaXQgd29uJ3QgdHJpZ2dlciBhbnl0aGluZy5cbiAgICpcbiAgICogVGhlIGxhdGVzdCB2YWx1ZSB3aWxsIGJlIHJlcGxheWVkIHRvIGxhdGUgc3Vic2NyaWJlcnMuXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgaXNBdXRoZW50aWNhdGVkOiBPYnNlcnZhYmxlPGJvb2xlYW4+ID0gdGhpcy5hY2Nlc3NUb2tlbi5waXBlKG1hcCh0b2tlbiA9PiAhIXRva2VuKSk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgQE9wdGlvbmFsKCkgQEluamVjdChMT0dPVVQpIGxvZ291dFNlcnZpY2U/OiBMb2dvdXRTZXJ2aWNlLFxuICAgIEBPcHRpb25hbCgpIEBJbmplY3QoUkVBVVRIRU5USUNBVEUpIHJlYXV0aGVudGljYXRlU2VydmljZT86IFJlYXV0aGVudGljYXRlU2VydmljZSxcbiAgICBAT3B0aW9uYWwoKSBASW5qZWN0KFNFU1NJT04pIHNlc3Npb25TZXJ2aWNlPzogU2Vzc2lvblNlcnZpY2UsXG4gICAgQE9wdGlvbmFsKCkgQEluamVjdCjJtUFVVEhfRVZFTlRTKSBhdXRoRXZlbnRzPzogybVBdXRoRXZlbnRzLFxuICApIHtcbiAgICBpZiAoIWxvZ291dFNlcnZpY2UgfHwgIXJlYXV0aGVudGljYXRlU2VydmljZSB8fCAhc2Vzc2lvblNlcnZpY2UgfHwgIWF1dGhFdmVudHMpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgJ0luIG9yZGVyIHRvIHVzZSB0aGUgQGJhY2tiYXNlL2ZvdW5kYXRpb24tYW5nL2F1dGgsIHBsZWFzZSBpbmNsdWRlICplaXRoZXIqIHRoZSAnICtcbiAgICAgICAgICAnV2ViU2RrTW9kdWxlLmZvclJvb3QoLi4uKSBpbiB5b3VyIEFwcE1vZHVsZSAoZm9yIENETiBkZXBsb3ltZW50KSBvciBXZWJTZGtBcGlNb2R1bGUgJyArXG4gICAgICAgICAgJyhmb3IgQ1ggZGVwbG95bWVudCknLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICB0aGlzLmxvZ291dFNlcnZpY2UgPSBsb2dvdXRTZXJ2aWNlO1xuICAgIHRoaXMucmVhdXRoZW50aWNhdGVTZXJ2aWNlID0gcmVhdXRoZW50aWNhdGVTZXJ2aWNlO1xuICAgIHRoaXMuc2Vzc2lvblNlcnZpY2UgPSBzZXNzaW9uU2VydmljZTtcbiAgICB0aGlzLmF1dGhFdmVudHMgPSBhdXRoRXZlbnRzO1xuXG4gICAgdGhpcy5oYW5kbGVBdXRoRXZlbnRzKCk7XG4gIH1cblxuICAvKipcbiAgICogUmVkaXJlY3QgdGhlIHVzZXIgdG8gdGhlIGxvZ2luIHBhZ2UuXG4gICAqXG4gICAqIEBwYXJhbSBsb2dpbk9wdGlvbnNcbiAgICovXG4gIGxvZ2luKGxvZ2luT3B0aW9ucz86IExvZ2luT3B0aW9ucykge1xuICAgIHRoaXMubG9nb3V0U2VydmljZS5nb1RvTG9naW5QYWdlKGxvZ2luT3B0aW9ucz8ucmVkaXJlY3RVcmkpO1xuICB9XG5cbiAgLyoqXG4gICAqIExvZyBvdXQgdGhlIGN1cnJlbnQgdXNlci5cbiAgICpcbiAgICogQHBhcmFtIGxvZ291dE9wdGlvbnNcbiAgICovXG4gIGxvZ291dChsb2dvdXRPcHRpb25zPzogTG9nb3V0T3B0aW9ucyk6IFByb21pc2U8dm9pZD4ge1xuICAgIHJldHVybiB0aGlzLmxvZ291dFNlcnZpY2UubG9nb3V0KGxvZ291dE9wdGlvbnM/LnJlZGlyZWN0VXJpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZWdpc3RlciBhIHNldCBvZiBjYWxsYmFja3MgdGhhdCB3aWxsIGJlIGNhbGxlZCBhcyB0aGUgdXNlcidzIHNlc3Npb24gZ2V0cyBjbG9zZSB0byBleHBpcmluZy5cbiAgICpcbiAgICogQHBhcmFtIGNvdW50ZG93blxuICAgKi9cbiAgcmVnaXN0ZXJTZXNzaW9uQ291bnRkb3duKGNvdW50ZG93bjogQ291bnRkb3duT3B0aW9ucykge1xuICAgIHRoaXMuc2Vzc2lvblNlcnZpY2UucmVnaXN0ZXJDb3VudGRvd24oY291bnRkb3duKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm4gdGhlIHRpbWUgdG8gbGl2ZSAoVFRMKSBpbiBzZWNvbmRzIG9mIHRoZSB1c2VyJ3Mgc2Vzc2lvbi5cbiAgICpcbiAgICogUmV0dXJucyAtMSBpZiB0aGUgVFRMIGNhbid0IGJlIGRldGVybWluZWQuXG4gICAqL1xuICB0aW1lVG9MaXZlKCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuc2Vzc2lvblNlcnZpY2UudGltZVRvTGl2ZSgpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgd2hldGhlciB0aGUgdXNlciBpcyBiZWluZyBpbXBlcnNvbmF0ZWQuXG4gICAqIEByZXR1cm5zIHRydWUgaWYgdGhlIHVzZXIgaXMgYmVpbmcgaW1wZXJzb25hdGVkLlxuICAgKi9cbiAgaXNJbXBlcnNvbmF0ZWQoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuc2Vzc2lvblNlcnZpY2UuaXNJbXBlcnNvbmF0ZWQ7XG4gIH1cblxuICAvKipcbiAgICogUmVhdXRoZW50aWNhdGUgdGhlIGN1cnJlbnQgdXNlci5cbiAgICpcbiAgICogVGhpcyBjYW4gYmUgdXNlZCB3aGVuIHRoZSBiYWNrZW5kIHJlc3BvbmRzIHdpdGggYSA0MDEgYW5kIHRoZSBjdXJyZW50IHVzZXIgbmVlZHMgdG9cbiAgICogcmVhdXRoZW50aWNhdGUuXG4gICAqXG4gICAqIEB1c2FnZU5vdGVzXG4gICAqXG4gICAqIFlvdSBjYW4gdXNlIHRoaXMgc2VydmljZSB0byBjcmVhdGUgYW4gaW50ZXJjZXB0b3Igd2hpY2ggd2lsbCBhdXRvbWF0aWNhbGx5IHJlZGlyZWN0IHRoZVxuICAgKiB1c2VyIHdoZW4gdGhlIGJhY2tlbmQgcmVzcG9uZHMgd2l0aCBhIDQwMS4gVXNlZnVsIHdoZW4gdGhlIGJhY2tlbmQgcmVzcG9uZHMgd2l0aCBhIGNoYWxsZW5nZVxuICAgKiAoZWc6IGZvciBzdGVwLXVwIG11bHRpZmFjdG9yIGF1dGhlbnRpY2F0aW9uKTpcbiAgICpcbiAgICogYGBgXG4gICAqIGltcG9ydCB7IEh0dHBFdmVudCwgSHR0cEhhbmRsZXIsIEh0dHBJbnRlcmNlcHRvciwgSHR0cFJlcXVlc3QsIEh0dHBSZXNwb25zZSB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbiAgICogaW1wb3J0IHsgZnJvbSwgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuICAgKiBpbXBvcnQgeyBjYXRjaEVycm9yLCBmaXJzdCwgbWFwVG8gfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG4gICAqIGltcG9ydCB7IEF1dGhTZXJ2aWNlIH0gZnJvbSAnQGJhY2tiYXNlL2ZvdW5kYXRpb24tYW5nL2F1dGgnO1xuICAgKlxuICAgKiBleHBvcnQgY2xhc3MgUmVhdXRoZW50aWNhdGVJbnRlcmNlcHRvciBpbXBsZW1lbnRzIEh0dHBJbnRlcmNlcHRvciB7XG4gICAqICAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBhdXRoU2VydmljZTogQXV0aFNlcnZpY2UpIHt9XG4gICAqICAgaW50ZXJjZXB0KHJlcXVlc3Q6IEh0dHBSZXF1ZXN0PGFueT4sIG5leHQ6IEh0dHBIYW5kbGVyKTogT2JzZXJ2YWJsZTxIdHRwRXZlbnQ8YW55Pj4ge1xuICAgKiAgICAgcmV0dXJuIG5leHQuaGFuZGxlKHJlcXVlc3QpLnBpcGUoXG4gICAqICAgICAgIC8vIFdoZW4gYW55IEhUVFAgcmVxdWVzdCBmYWlscyAoeW91IGNvdWxkIGNoZWNrIHN0YXR1cyAmIGhlYWRlcnMgaGVyZSB0byBvbmx5IGNhdGNoIHNvbWUgZmFpbHVyZXMpLlxuICAgKiAgICAgICBjYXRjaEVycm9yKGVycm9yID0+IHtcbiAgICogICAgICAgICAvLyBSZXRyZWl2ZSB0aGUgY2hhbGxlbmdlIGZyb20gdGhlIHNlcnZlcidzIHJlc3BvbnNlLlxuICAgKiAgICAgICAgIGNvbnN0IGNoYWxsZW5nZTogeyBzY29wZTogc3RyaW5nOyBhY3JWYWx1ZXM6IHN0cmluZyB9ID0gKGVycm9yLmVycm9yLmNoYWxsZW5nZXMgfHwgW10pLmZpbmQoXG4gICAqICAgICAgICAgICBjID0+IGMuc2NvcGUgIT09IHVuZGVmaW5lZCxcbiAgICogICAgICAgICApO1xuICAgKiAgICAgICAgIC8vIFJlYXV0aGVudGljYXRlIHRoZSB1c2VyIHdpdGggdGhlIHJlcXVlc3RlZCBzY29wZSAmIGFjciB2YWx1ZXMgYW5kIHJlZGlyZWN0IGJhY2sgdG8gaGVyZS5cbiAgICogICAgICAgICByZXR1cm4gZnJvbShcbiAgICogICAgICAgICAgIHRoaXMuYXV0aFNlcnZpY2UucmVhdXRoZW50aWNhdGUoe1xuICAgKiAgICAgICAgICAgICBzY29wZTogY2hhbGxlbmdlLnNjb3BlLFxuICAgKiAgICAgICAgICAgICBhY3JWYWx1ZXM6IGNoYWxsZW5nZS5hY3JWYWx1ZXMsXG4gICAqICAgICAgICAgICAgIHJlZGlyZWN0OiB0cnVlLFxuICAgKiAgICAgICAgICAgICByZWRpcmVjdFVyaTogbG9jYXRpb24uaHJlZixcbiAgICogICAgICAgICAgIH0pLFxuICAgKiAgICAgICAgICAgLy8gUmV0cnkgdGhlIG9yaWduYWwgcmVxdWVzdFxuICAgKiAgICAgICAgICkucGlwZShmaXJzdCgpLCBtYXBUbyhuZXcgSHR0cFJlc3BvbnNlKHsgYm9keTogZXJyb3IuZXJyb3IuZGF0YSB9KSkpO1xuICAgKiAgICAgICB9KSxcbiAgICogICAgICk7XG4gICAqICAgfVxuICAgKiB9XG4gICAqIGBgYFxuICAgKlxuICAgKiBAcGFyYW0gcmVhdXRoZW50aWNhdGVPcHRpb25zXG4gICAqL1xuICByZWF1dGhlbnRpY2F0ZShyZWF1dGhlbnRpY2F0ZU9wdGlvbnM6IFJlYXV0aGVudGljYXRlT3B0aW9ucyk6IFByb21pc2U8dm9pZD4ge1xuICAgIHJldHVybiB0aGlzLnJlYXV0aGVudGljYXRlU2VydmljZS5yZWF1dGhlbnRpY2F0ZShcbiAgICAgIHJlYXV0aGVudGljYXRlT3B0aW9ucy5zY29wZSxcbiAgICAgIHJlYXV0aGVudGljYXRlT3B0aW9ucy5hY3JWYWx1ZXMsXG4gICAgICByZWF1dGhlbnRpY2F0ZU9wdGlvbnMsXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZWZyZXNoZXMgdGhlIHNlc3Npb24uXG4gICAqL1xuICByZWZyZXNoKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIHJldHVybiB0aGlzLnNlc3Npb25TZXJ2aWNlLnJlZnJlc2goKTtcbiAgfVxuXG4gIHByaXZhdGUgaGFuZGxlQXV0aEV2ZW50cygpIHtcbiAgICBtZXJnZShcbiAgICAgIHRoaXMuYXV0aEV2ZW50cy5zdWNjZXNzLnBpcGUocGx1Y2soJ2N1cnJlbnRBY2Nlc3NUb2tlbicpKSxcbiAgICAgIHRoaXMuYXV0aEV2ZW50cy5pbml0LnBpcGUocGx1Y2soJ2N1cnJlbnRBY2Nlc3NUb2tlbicpKSxcbiAgICAgIHRoaXMuYXV0aEV2ZW50cy5lbmQucGlwZShtYXBUbyh1bmRlZmluZWQpKSxcbiAgICAgIHRoaXMuYXV0aEV2ZW50cy5lcnJvci5waXBlKG1hcFRvKHVuZGVmaW5lZCkpLFxuICAgIClcbiAgICAgIC5waXBlKGRpc3RpbmN0VW50aWxDaGFuZ2VkKCh0MSwgdDIpID0+IHQxPy5yYXcgPT09IHQyPy5yYXcpKVxuICAgICAgLnN1YnNjcmliZSh0b2tlbiA9PiB7XG4gICAgICAgIHRoaXMuYWNjZXNzVG9rZW5TdWJqZWN0Lm5leHQodG9rZW4pO1xuICAgICAgICB0aGlzLmlzTG9hZGluZ1N1YmplY3QubmV4dChmYWxzZSk7XG4gICAgICB9KTtcbiAgfVxufVxuIl19