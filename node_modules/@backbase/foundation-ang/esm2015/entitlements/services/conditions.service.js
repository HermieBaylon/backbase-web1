import { Injectable, Inject, Optional } from '@angular/core';
import { of, forkJoin } from 'rxjs';
import { map, shareReplay } from 'rxjs/operators';
import { HttpClient } from '@angular/common/http';
import { ENTITLEMENTS_CONFIG } from './providers';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
import * as i2 from "./providers";
var LogicalOperator;
(function (LogicalOperator) {
    LogicalOperator["AND"] = "AND";
    LogicalOperator["OR"] = "OR";
    LogicalOperator["NOT"] = "NOT";
})(LogicalOperator || (LogicalOperator = {}));
export const SUMMARY_PERMISSIONS_PATH = '/accessgroups/users/permissions/summary';
export const DATA_ITEMS_PERMISSIONS_PATH = '/accessgroups/users/data-item-permissions';
export class ConditionsService {
    constructor(http, config) {
        var _a, _b, _c;
        this.http = http;
        this.config = config;
        this.createConditions = (stringDef) => {
            const splitBySpaces = stringDef
                .trim()
                .split(' ')
                .filter((spaced) => spaced !== '');
            return this.separateLogicalOperators(['AND'].concat(splitBySpaces));
        };
        const basePath = ((_a = this.config) === null || _a === void 0 ? void 0 : _a.accessControlBasePath) || '/access-control';
        const path = ((_b = this.config) === null || _b === void 0 ? void 0 : _b.accessControlPath) || `/client-api/v2${SUMMARY_PERMISSIONS_PATH}`;
        this.entitlements$ = this.http
            .get(`${basePath}${path}`)
            .pipe(map(EntitlementSummaryResponse => {
            if (EntitlementSummaryResponse.length && 'dataItem' in EntitlementSummaryResponse[0]) {
                return this.mapDataItemPermissions(EntitlementSummaryResponse);
            }
            else {
                return this.mapPermissionsSummary(EntitlementSummaryResponse);
            }
        }), shareReplay(1));
        this.forceResolved = ((_c = this.config) === null || _c === void 0 ? void 0 : _c.forceResolved) || false;
    }
    // map response of getUserPermissionsSummary to flat array of available entitlements
    mapPermissionsSummary(entitlementsData) {
        const entitlements = [];
        entitlementsData.forEach(entitlementData => {
            const availablePermissions = Object.entries(entitlementData.permissions).filter(([, value]) => value === true);
            availablePermissions.forEach(([privilege]) => {
                const entitlement = this.removeWhiteSpace({
                    resource: entitlementData.resource,
                    function: entitlementData.function,
                    privilege,
                });
                entitlements.push(entitlement);
            });
        });
        return entitlements;
    }
    // map response of getDataItemPermissionsContext to flat array of available entitlements
    // this endpoint can optionally be configured when needing data-item specific entitlements
    mapDataItemPermissions(entitlementsData) {
        const entitlements = [];
        entitlementsData.forEach(entitlementData => {
            entitlementData.permissions.forEach(permission => {
                permission.privileges.forEach(privilege => {
                    const entitlement = this.removeWhiteSpace({
                        dataItem: entitlementData.dataItem.id,
                        resource: permission.resource,
                        function: permission.businessFunction,
                        privilege,
                    });
                    entitlements.push(entitlement);
                });
            });
        });
        return entitlements;
    }
    resolveEntitlements(identifier) {
        if (this.forceResolved) {
            return Promise.resolve(true);
        }
        const conditions = this.createConditions(identifier);
        return this.resolveConditions(conditions).toPromise();
    }
    parseIdentifier(identifier) {
        const identifierArray = identifier.split('.').map((str) => str.trim());
        if (identifierArray.length < 3 || identifierArray.length > 4) {
            throw Error(`'${identifier}' is not valid entitlement identifier`);
        }
        if (identifierArray.length === 3) {
            return this.removeWhiteSpace({
                dataItem: undefined,
                resource: identifierArray[0],
                function: identifierArray[1],
                privilege: identifierArray[2],
            });
        }
        return this.removeWhiteSpace({
            dataItem: identifierArray[0],
            resource: identifierArray[1],
            function: identifierArray[2],
            privilege: identifierArray[3],
        });
    }
    resolveConditions(conditions) {
        if (conditions.length === 0) {
            return of(true);
        }
        const resolutions = conditions.map((condition) => this.resolveEntitlement(condition).pipe(map((value) => ({ value, logic: condition.logic }))));
        return forkJoin(resolutions).pipe(map(this.resolveResolutions));
    }
    resolveResolutions(resolutions) {
        return resolutions.reduce((final, resolution) => {
            if (resolution.logic === LogicalOperator.AND) {
                return final && resolution.value;
            }
            else if (resolution.logic === LogicalOperator.NOT) {
                return final && !resolution.value;
            }
            return final || resolution.value;
        }, true);
    }
    separateLogicalOperators(splitBySpaces) {
        const conditions = [];
        for (let i = 0; i < splitBySpaces.length; i += 2) {
            const logic = splitBySpaces[i];
            if (logic !== LogicalOperator.AND && logic !== LogicalOperator.OR) {
                throw Error(`'${logic}' is not valid logical operator`);
            }
            const identifier = splitBySpaces[i + 1];
            if (identifier.charAt(0) === '!') {
                conditions.push(Object.assign(Object.assign({}, this.parseIdentifier(identifier.substr(1))), { logic: LogicalOperator.NOT }));
            }
            else {
                conditions.push(Object.assign(Object.assign({}, this.parseIdentifier(identifier)), { logic }));
            }
        }
        return conditions;
    }
    removeWhiteSpace(item) {
        return Object.assign(Object.assign({}, item), { dataItem: item.dataItem ? item.dataItem.replace(/ /g, '') : undefined, resource: item.resource.replace(/ /g, ''), function: item.function.replace(/ /g, '') });
    }
    resolveEntitlement(entitlement) {
        return this.entitlements$.pipe(map(entitlements => entitlements.some(availableEntitlement => (entitlement.dataItem === undefined || availableEntitlement.dataItem === entitlement.dataItem) &&
            availableEntitlement.resource === entitlement.resource &&
            availableEntitlement.function === entitlement.function &&
            availableEntitlement.privilege === entitlement.privilege)));
    }
}
ConditionsService.ɵprov = i0.ɵɵdefineInjectable({ factory: function ConditionsService_Factory() { return new ConditionsService(i0.ɵɵinject(i1.HttpClient), i0.ɵɵinject(i2.ENTITLEMENTS_CONFIG, 8)); }, token: ConditionsService, providedIn: "root" });
ConditionsService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root',
            },] }
];
ConditionsService.ctorParameters = () => [
    { type: HttpClient },
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [ENTITLEMENTS_CONFIG,] }] }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29uZGl0aW9ucy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvYmFja2Jhc2UvZm91bmRhdGlvbi1hbmcvZW50aXRsZW1lbnRzL3NyYy9zZXJ2aWNlcy9jb25kaXRpb25zLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzdELE9BQU8sRUFBYyxFQUFFLEVBQUUsUUFBUSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ2hELE9BQU8sRUFBRSxHQUFHLEVBQUUsV0FBVyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDbEQsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ2xELE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLGFBQWEsQ0FBQzs7OztBQTJCbEQsSUFBSyxlQUlKO0FBSkQsV0FBSyxlQUFlO0lBQ2xCLDhCQUFXLENBQUE7SUFDWCw0QkFBUyxDQUFBO0lBQ1QsOEJBQVcsQ0FBQTtBQUNiLENBQUMsRUFKSSxlQUFlLEtBQWYsZUFBZSxRQUluQjtBQWlCRCxNQUFNLENBQUMsTUFBTSx3QkFBd0IsR0FBRyx5Q0FBeUMsQ0FBQztBQUNsRixNQUFNLENBQUMsTUFBTSwyQkFBMkIsR0FBRywyQ0FBMkMsQ0FBQztBQUt2RixNQUFNLE9BQU8saUJBQWlCO0lBSTVCLFlBQ21CLElBQWdCLEVBQ2dCLE1BQWlDOztRQURqRSxTQUFJLEdBQUosSUFBSSxDQUFZO1FBQ2dCLFdBQU0sR0FBTixNQUFNLENBQTJCO1FBOEo1RSxxQkFBZ0IsR0FBRyxDQUFDLFNBQWlCLEVBQW9CLEVBQUU7WUFDakUsTUFBTSxhQUFhLEdBQUcsU0FBUztpQkFDNUIsSUFBSSxFQUFFO2lCQUNOLEtBQUssQ0FBQyxHQUFHLENBQUM7aUJBQ1YsTUFBTSxDQUFDLENBQUMsTUFBYyxF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UUFBUSxFQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsSUFDekM7SUFDSixDQUFDO0lBV08sa0JBQWtCLENBQUMsV0FBd0I7UUFDakQsT0FBTyxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FDNUIsR0FBRyxDQUFDLFlBQVksQ0FBQyxFQUFFLENBQ2pCLFlBQVksQ0FBQyxJQUFJLENBQ2Ysb0JBQW9CLENBQUMsRUFBRSxDQUNyQixDQUFDLFdBQVcsQ0FBQyxRQUFRLEtBQUssU0FBUyxJQUFJLG9CQUFvQixDQUFDLFFBQVEsS0FBSyxXQUFXLENBQUMsUUFBUSxDQUFDO1lBQzlGLG9CQUFvQixDQUFDLFFBQVEsS0FBSyxXQUFXLENBQUMsUUFBUTtZQUN0RCxvQkFBb0IsQ0FBQyxRQUFRLEtBQUssV0FBVyxDQUFDLFFBQVE7WUFDdEQsb0JBQW9CLENBQUMsU0FBUyxLQUFLLFdBQVcsQ0FBQyxTQUFTLENBQzNELENBQ0YsQ0FDRixDQUFDO0lBQ0osQ0FBQzs7OztZQTVMRixVQUFVLFNBQUM7Z0JBQ1YsVUFBVSxFQUFFLE1BQU07YUFDbkI7OztZQXREUSxVQUFVOzRDQTZEZCxRQUFRLFlBQUksTUFBTSxTQUFDLG1CQUFtQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEluamVjdCwgT3B0aW9uYWwgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE9ic2VydmFibGUsIG9mLCBmb3JrSm9pbiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgbWFwLCBzaGFyZVJlcGxheSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEh0dHBDbGllbnQgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQgeyBFTlRJVExFTUVOVFNfQ09ORklHIH0gZnJvbSAnLi9wcm92aWRlcnMnO1xuXG50eXBlIERhdGFJdGVtRW50aXRsZW1lbnRSZXNwb25zZSA9IEFycmF5PHtcbiAgZGF0YUl0ZW06IHtcbiAgICBpZDogc3RyaW5nO1xuICAgIGRhdGF0eXBlOiBzdHJpbmc7XG4gIH07XG4gIHBlcm1pc3Npb25zOiB7XG4gICAgYnVzaW5lc3NGdW5jdGlvbjogc3RyaW5nO1xuICAgIHByaXZpbGVnZXM6IHN0cmluZ1tdO1xuICAgIHJlc291cmNlOiBzdHJpbmc7XG4gIH1bXTtcbn0+O1xuXG50eXBlIEVudGl0bGVtZW50U3VtbWFyeVJlc3BvbnNlID0gQXJyYXk8e1xuICByZXNvdXJjZTogc3RyaW5nO1xuICBmdW5jdGlvbjogc3RyaW5nO1xuICBwZXJtaXNzaW9uczogeyBba2V5OiBzdHJpbmddOiBib29sZWFuIH07XG59PjtcblxuaW50ZXJmYWNlIEVudGl0bGVtZW50IHtcbiAgZGF0YUl0ZW0/OiBzdHJpbmc7XG4gIHJlc291cmNlOiBzdHJpbmc7XG4gIGZ1bmN0aW9uOiBzdHJpbmc7XG4gIHByaXZpbGVnZTogc3RyaW5nO1xufVxuXG5lbnVtIExvZ2ljYWxPcGVyYXRvciB7XG4gIEFORCA9ICdBTkQnLFxuICBPUiA9ICdPUicsXG4gIE5PVCA9ICdOT1QnLFxufVxuXG5pbnRlcmZhY2UgQ29uZGl0aW9uIGV4dGVuZHMgRW50aXRsZW1lbnQge1xuICBsb2dpYzogTG9naWNhbE9wZXJhdG9yO1xufVxuXG5pbnRlcmZhY2UgUmVzb2x1dGlvbiB7XG4gIHZhbHVlOiBib29sZWFuO1xuICBsb2dpYzogTG9naWNhbE9wZXJhdG9yO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEVudGl0bGVtZW50c0NvbmZpZyB7XG4gIGZvcmNlUmVzb2x2ZWQ/OiBib29sZWFuO1xuICBhY2Nlc3NDb250cm9sQmFzZVBhdGg/OiBzdHJpbmc7XG4gIGFjY2Vzc0NvbnRyb2xQYXRoPzogc3RyaW5nO1xufVxuXG5leHBvcnQgY29uc3QgU1VNTUFSWV9QRVJNSVNTSU9OU19QQVRIID0gJy9hY2Nlc3Nncm91cHMvdXNlcnMvcGVybWlzc2lvbnMvc3VtbWFyeSc7XG5leHBvcnQgY29uc3QgREFUQV9JVEVNU19QRVJNSVNTSU9OU19QQVRIID0gJy9hY2Nlc3Nncm91cHMvdXNlcnMvZGF0YS1pdGVtLXBlcm1pc3Npb25zJztcblxuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCcsXG59KVxuZXhwb3J0IGNsYXNzIENvbmRpdGlvbnNTZXJ2aWNlIHtcbiAgcHJpdmF0ZSBmb3JjZVJlc29sdmVkOiBib29sZWFuO1xuICBwcml2YXRlIGVudGl0bGVtZW50cyQ6IE9ic2VydmFibGU8RW50aXRsZW1lbnRbXT47XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBodHRwOiBIdHRwQ2xpZW50LFxuICAgIEBPcHRpb25hbCgpIEBJbmplY3QoRU5USVRMRU1FTlRTX0NPTkZJRykgcHJpdmF0ZSBjb25maWc6IEVudGl0bGVtZW50c0NvbmZpZyB8IG51bGwsXG4gICkge1xuICAgIGNvbnN0IGJhc2VQYXRoID0gdGhpcy5jb25maWc/LmFjY2Vzc0NvbnRyb2xCYXNlUGF0aCB8fCAnL2FjY2Vzcy1jb250cm9sJztcbiAgICBjb25zdCBwYXRoID0gdGhpcy5jb25maWc/LmFjY2Vzc0NvbnRyb2xQYXRoIHx8IGAvY2xpZW50LWFwaS92MiR7U1VNTUFSWV9QRVJNSVNTSU9OU19QQVRIfWA7XG5cbiAgICB0aGlzLmVudGl0bGVtZW50cyQgPSB0aGlzLmh0dHBcbiAgICAgIC5nZXQ8RW50aXRsZW1lbnRTdW1tYXJ5UmVzcG9uc2UgfCBEYXRhSXRlbUVudGl0bGVtZW50UmVzcG9uc2U+KGAke2Jhc2VQYXRofSR7cGF0aH1gKVxuICAgICAgLnBpcGUoXG4gICAgICAgIG1hcChFbnRpdGxlbWVudFN1bW1hcnlSZXNwb25zZSA9PiB7XG4gICAgICAgICAgaWYgKEVudGl0bGVtZW50U3VtbWFyeVJlc3BvbnNlLmxlbmd0aCAmJiAnZGF0YUl0ZW0nIGluIEVudGl0bGVtZW50U3VtbWFyeVJlc3BvbnNlWzBdKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5tYXBEYXRhSXRlbVBlcm1pc3Npb25zKEVudGl0bGVtZW50U3VtbWFyeVJlc3BvbnNlIGFzIERhdGFJdGVtRW50aXRsZW1lbnRSZXNwb25zZSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLm1hcFBlcm1pc3Npb25zU3VtbWFyeShFbnRpdGxlbWVudFN1bW1hcnlSZXNwb25zZSBhcyBFbnRpdGxlbWVudFN1bW1hcnlSZXNwb25zZSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KSxcbiAgICAgICAgc2hhcmVSZXBsYXkoMSksXG4gICAgICApO1xuXG4gICAgdGhpcy5mb3JjZVJlc29sdmVkID0gdGhpcy5jb25maWc/LmZvcmNlUmVzb2x2ZWQgfHwgZmFsc2U7XG4gIH1cblxuICAvLyBtYXAgcmVzcG9uc2Ugb2YgZ2V0VXNlclBlcm1pc3Npb25zU3VtbWFyeSB0byBmbGF0IGFycmF5IG9mIGF2YWlsYWJsZSBlbnRpdGxlbWVudHNcbiAgcHJpdmF0ZSBtYXBQZXJtaXNzaW9uc1N1bW1hcnkoZW50aXRsZW1lbnRzRGF0YTogRW50aXRsZW1lbnRTdW1tYXJ5UmVzcG9uc2UpOiBFbnRpdGxlbWVudFtdIHtcbiAgICBjb25zdCBlbnRpdGxlbWVudHM6IEVudGl0bGVtZW50W10gPSBbXTtcblxuICAgIGVudGl0bGVtZW50c0RhdGEuZm9yRWFjaChlbnRpdGxlbWVudERhdGEgPT4ge1xuICAgICAgY29uc3QgYXZhaWxhYmxlUGVybWlzc2lvbnMgPSBPYmplY3QuZW50cmllcyhlbnRpdGxlbWVudERhdGEucGVybWlzc2lvbnMpLmZpbHRlcigoWywgdmFsdWVdKSA9PiB2YWx1ZSA9PT0gdHJ1ZSk7XG5cbiAgICAgIGF2YWlsYWJsZVBlcm1pc3Npb25zLmZvckVhY2goKFtwcml2aWxlZ2VdKSA9PiB7XG4gICAgICAgIGNvbnN0IGVudGl0bGVtZW50ID0gdGhpcy5yZW1vdmVXaGl0ZVNwYWNlKHtcbiAgICAgICAgICByZXNvdXJjZTogZW50aXRsZW1lbnREYXRhLnJlc291cmNlLFxuICAgICAgICAgIGZ1bmN0aW9uOiBlbnRpdGxlbWVudERhdGEuZnVuY3Rpb24sXG4gICAgICAgICAgcHJpdmlsZWdlLFxuICAgICAgICB9KTtcblxuICAgICAgICBlbnRpdGxlbWVudHMucHVzaChlbnRpdGxlbWVudCk7XG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIHJldHVybiBlbnRpdGxlbWVudHM7XG4gIH1cblxuICAvLyBtYXAgcmVzcG9uc2Ugb2YgZ2V0RGF0YUl0ZW1QZXJtaXNzaW9uc0NvbnRleHQgdG8gZmxhdCBhcnJheSBvZiBhdmFpbGFibGUgZW50aXRsZW1lbnRzXG4gIC8vIHRoaXMgZW5kcG9pbnQgY2FuIG9wdGlvbmFsbHkgYmUgY29uZmlndXJlZCB3aGVuIG5lZWRpbmcgZGF0YS1pdGVtIHNwZWNpZmljIGVudGl0bGVtZW50c1xuICBwcml2YXRlIG1hcERhdGFJdGVtUGVybWlzc2lvbnMoZW50aXRsZW1lbnRzRGF0YTogRGF0YUl0ZW1FbnRpdGxlbWVudFJlc3BvbnNlKTogRW50aXRsZW1lbnRbXSB7XG4gICAgY29uc3QgZW50aXRsZW1lbnRzOiBFbnRpdGxlbWVudFtdID0gW107XG5cbiAgICBlbnRpdGxlbWVudHNEYXRhLmZvckVhY2goZW50aXRsZW1lbnREYXRhID0+IHtcbiAgICAgIGVudGl0bGVtZW50RGF0YS5wZXJtaXNzaW9ucy5mb3JFYWNoKHBlcm1pc3Npb24gPT4ge1xuICAgICAgICBwZXJtaXNzaW9uLnByaXZpbGVnZXMuZm9yRWFjaChwcml2aWxlZ2UgPT4ge1xuICAgICAgICAgIGNvbnN0IGVudGl0bGVtZW50ID0gdGhpcy5yZW1vdmVXaGl0ZVNwYWNlKHtcbiAgICAgICAgICAgIGRhdGFJdGVtOiBlbnRpdGxlbWVudERhdGEuZGF0YUl0ZW0uaWQsXG4gICAgICAgICAgICByZXNvdXJjZTogcGVybWlzc2lvbi5yZXNvdXJjZSxcbiAgICAgICAgICAgIGZ1bmN0aW9uOiBwZXJtaXNzaW9uLmJ1c2luZXNzRnVuY3Rpb24sXG4gICAgICAgICAgICBwcml2aWxlZ2UsXG4gICAgICAgICAgfSk7XG5cbiAgICAgICAgICBlbnRpdGxlbWVudHMucHVzaChlbnRpdGxlbWVudCk7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gZW50aXRsZW1lbnRzO1xuICB9XG5cbiAgcmVzb2x2ZUVudGl0bGVtZW50cyhpZGVudGlmaWVyOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBpZiAodGhpcy5mb3JjZVJlc29sdmVkKSB7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHRydWUpO1xuICAgIH1cblxuICAgIGNvbnN0IGNvbmRpdGlvbnMgPSB0aGlzLmNyZWF0ZUNvbmRpdGlvbnMoaWRlbnRpZmllcik7XG5cbiAgICByZXR1cm4gdGhpcy5yZXNvbHZlQ29uZGl0aW9ucyhjb25kaXRpb25zKS50b1Byb21pc2UoKTtcbiAgfVxuXG4gIHByaXZhdGUgcGFyc2VJZGVudGlmaWVyKGlkZW50aWZpZXI6IHN0cmluZyk6IEVudGl0bGVtZW50IHtcbiAgICBjb25zdCBpZGVudGlmaWVyQXJyYXkgPSBpZGVudGlmaWVyLnNwbGl0KCcuJykubWFwKChzdHI6IHN0cmluZykgPT4gc3RyLnRyaW0oKSk7XG5cbiAgICBpZiAoaWRlbnRpZmllckFycmF5Lmxlbmd0aCA8IDMgfHwgaWRlbnRpZmllckFycmF5Lmxlbmd0aCA+IDQpIHtcbiAgICAgIHRocm93IEVycm9yKGAnJHtpZGVudGlmaWVyfScgaXMgbm90IHZhbGlkIGVudGl0bGVtZW50IGlkZW50aWZpZXJgKTtcbiAgICB9XG5cbiAgICBpZiAoaWRlbnRpZmllckFycmF5Lmxlbmd0aCA9PT0gMykge1xuICAgICAgcmV0dXJuIHRoaXMucmVtb3ZlV2hpdGVTcGFjZSh7XG4gICAgICAgIGRhdGFJdGVtOiB1bmRlZmluZWQsXG4gICAgICAgIHJlc291cmNlOiBpZGVudGlmaWVyQXJyYXlbMF0sXG4gICAgICAgIGZ1bmN0aW9uOiBpZGVudGlmaWVyQXJyYXlbMV0sXG4gICAgICAgIHByaXZpbGVnZTogaWRlbnRpZmllckFycmF5WzJdLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMucmVtb3ZlV2hpdGVTcGFjZSh7XG4gICAgICBkYXRhSXRlbTogaWRlbnRpZmllckFycmF5WzBdLFxuICAgICAgcmVzb3VyY2U6IGlkZW50aWZpZXJBcnJheVsxXSxcbiAgICAgIGZ1bmN0aW9uOiBpZGVudGlmaWVyQXJyYXlbMl0sXG4gICAgICBwcml2aWxlZ2U6IGlkZW50aWZpZXJBcnJheVszXSxcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgcmVzb2x2ZUNvbmRpdGlvbnMoY29uZGl0aW9uczogQXJyYXk8Q29uZGl0aW9uPik6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xuICAgIGlmIChjb25kaXRpb25zLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuIG9mKHRydWUpO1xuICAgIH1cblxuICAgIGNvbnN0IHJlc29sdXRpb25zID0gY29uZGl0aW9ucy5tYXAoKGNvbmRpdGlvbjogQ29uZGl0aW9uKSA9PlxuICAgICAgdGhpcy5yZXNvbHZlRW50aXRsZW1lbnQoY29uZGl0aW9uKS5waXBlKG1hcCgodmFsdWU6IGJvb2xlYW4pID0+ICh7IHZhbHVlLCBsb2dpYzogY29uZGl0aW9uLmxvZ2ljIH0pKSksXG4gICAgKTtcblxuICAgIHJldHVybiBmb3JrSm9pbihyZXNvbHV0aW9ucykucGlwZShtYXAodGhpcy5yZXNvbHZlUmVzb2x1dGlvbnMpKTtcbiAgfVxuXG4gIHByaXZhdGUgcmVzb2x2ZVJlc29sdXRpb25zKHJlc29sdXRpb25zOiBSZXNvbHV0aW9uW10pIHtcbiAgICByZXR1cm4gcmVzb2x1dGlvbnMucmVkdWNlKChmaW5hbDogYm9vbGVhbiwgcmVzb2x1dGlvbjogUmVzb2x1dGlvbikgPT4ge1xuICAgICAgaWYgKHJlc29sdXRpb24ubG9naWMgPT09IExvZ2ljYWxPcGVyYXRvci5BTkQpIHtcbiAgICAgICAgcmV0dXJuIGZpbmFsICYmIHJlc29sdXRpb24udmFsdWU7XG4gICAgICB9IGVsc2UgaWYgKHJlc29sdXRpb24ubG9naWMgPT09IExvZ2ljYWxPcGVyYXRvci5OT1QpIHtcbiAgICAgICAgcmV0dXJuIGZpbmFsICYmICFyZXNvbHV0aW9uLnZhbHVlO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gZmluYWwgfHwgcmVzb2x1dGlvbi52YWx1ZTtcbiAgICB9LCB0cnVlKTtcbiAgfVxuXG4gIHByaXZhdGUgc2VwYXJhdGVMb2dpY2FsT3BlcmF0b3JzKHNwbGl0QnlTcGFjZXM6IHN0cmluZ1tdKTogQXJyYXk8Q29uZGl0aW9uPiB7XG4gICAgY29uc3QgY29uZGl0aW9uczogQXJyYXk8Q29uZGl0aW9uPiA9IFtdO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzcGxpdEJ5U3BhY2VzLmxlbmd0aDsgaSArPSAyKSB7XG4gICAgICBjb25zdCBsb2dpYyA9IHNwbGl0QnlTcGFjZXNbaV07XG4gICAgICBpZiAobG9naWMgIT09IExvZ2ljYWxPcGVyYXRvci5BTkQgJiYgbG9naWMgIT09IExvZ2ljYWxPcGVyYXRvci5PUikge1xuICAgICAgICB0aHJvdyBFcnJvcihgJyR7bG9naWN9JyBpcyBub3QgdmFsaWQgbG9naWNhbCBvcGVyYXRvcmApO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBpZGVudGlmaWVyID0gc3BsaXRCeVNwYWNlc1tpICsgMV07XG4gICAgICBpZiAoaWRlbnRpZmllci5jaGFyQXQoMCkgPT09ICchJykge1xuICAgICAgICBjb25kaXRpb25zLnB1c2goe1xuICAgICAgICAgIC4uLnRoaXMucGFyc2VJZGVudGlmaWVyKGlkZW50aWZpZXIuc3Vic3RyKDEpKSxcbiAgICAgICAgICBsb2dpYzogTG9naWNhbE9wZXJhdG9yLk5PVCxcbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25kaXRpb25zLnB1c2goe1xuICAgICAgICAgIC4uLnRoaXMucGFyc2VJZGVudGlmaWVyKGlkZW50aWZpZXIpLFxuICAgICAgICAgIGxvZ2ljLFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gY29uZGl0aW9ucztcbiAgfVxuXG4gIHByaXZhdGUgcmVtb3ZlV2hpdGVTcGFjZTxUIGV4dGVuZHMgeyBkYXRhSXRlbT86IHN0cmluZzsgcmVzb3VyY2U6IHN0cmluZzsgZnVuY3Rpb246IHN0cmluZyB9PihpdGVtOiBUKTogVCB7XG4gICAgcmV0dXJuIHtcbiAgICAgIC4uLml0ZW0sXG4gICAgICBkYXRhSXRlbTogaXRlbS5kYXRhSXRlbSA/IGl0ZW0uZGF0YUl0ZW0ucmVwbGFjZSgvIC9nLCAnJykgOiB1bmRlZmluZWQsXG4gICAgICByZXNvdXJjZTogaXRlbS5yZXNvdXJjZS5yZXBsYWNlKC8gL2csICcnKSxcbiAgICAgIGZ1bmN0aW9uOiBpdGVtLmZ1bmN0aW9uLnJlcGxhY2UoLyAvZywgJycpLFxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUNvbmRpdGlvbnMgPSAoc3RyaW5nRGVmOiBzdHJpbmcpOiBBcnJheTxDb25kaXRpb24+ID0+IHtcbiAgICBjb25zdCBzcGxpdEJ5U3BhY2VzID0gc3RyaW5nRGVmXG4gICAgICAudHJpbSgpXG4gICAgICAuc3BsaXQoJyAnKVxuICAgICAgLmZpbHRlcigoc3BhY2VkOiBzdHJpbmcpID0+IHNwYWNlZCAhPT0gJycpO1xuXG4gICAgcmV0dXJuIHRoaXMuc2VwYXJhdGVMb2dpY2FsT3BlcmF0b3JzKFsnQU5EJ10uY29uY2F0KHNwbGl0QnlTcGFjZXMpKTtcbiAgfTtcblxuICBwcml2YXRlIHJlc29sdmVFbnRpdGxlbWVudChlbnRpdGxlbWVudDogRW50aXRsZW1lbnQpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcbiAgICByZXR1cm4gdGhpcy5lbnRpdGxlbWVudHMkLnBpcGUoXG4gICAgICBtYXAoZW50aXRsZW1lbnRzID0+XG4gICAgICAgIGVudGl0bGVtZW50cy5zb21lKFxuICAgICAgICAgIGF2YWlsYWJsZUVudGl0bGVtZW50ID0+XG4gICAgICAgICAgICAoZW50aXRsZW1lbnQuZGF0YUl0ZW0gPT09IHVuZGVmaW5lZCB8fCBhdmFpbGFibGVFbnRpdGxlbWVudC5kYXRhSXRlbSA9PT0gZW50aXRsZW1lbnQuZGF0YUl0ZW0pICYmXG4gICAgICAgICAgICBhdmFpbGFibGVFbnRpdGxlbWVudC5yZXNvdXJjZSA9PT0gZW50aXRsZW1lbnQucmVzb3VyY2UgJiZcbiAgICAgICAgICAgIGF2YWlsYWJsZUVudGl0bGVtZW50LmZ1bmN0aW9uID09PSBlbnRpdGxlbWVudC5mdW5jdGlvbiAmJlxuICAgICAgICAgICAgYXZhaWxhYmxlRW50aXRsZW1lbnQucHJpdmlsZWdlID09PSBlbnRpdGxlbWVudC5wcml2aWxlZ2UsXG4gICAgICAgICksXG4gICAgICApLFxuICAgICk7XG4gIH1cbn1cbiJdfQ==