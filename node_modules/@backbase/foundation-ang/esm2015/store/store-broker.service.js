import { Injectable, Injector, Inject } from '@angular/core';
import { ReducerManager as NgrxReducerManager, Store as NgrxStore } from '@ngrx/store';
import { Actions as NgrxActions, EffectSources as NgrxEffectsSources } from '@ngrx/effects';
import { Observable } from 'rxjs';
import { metaChannelReducer as createMetaChannelReducer } from './reducers';
import { createChannelAction } from './actions';
import { createMetaChannelEffects } from './effects';
import { filter, map } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "@ngrx/store";
import * as i2 from "@ngrx/effects";
/**
 * @deprecated Will be removed in v7.0.0
 */
export const InitializeStoreActionType = '[Backbase Reducer] INITIALIZE REDUCER';
/**
 * @deprecated Will be removed in v7.0.0
 * An `Action` that is dispatched to a `Store` when it is created to allow the store to initialize
 * its initial state
 */
export class InitializeStoreAction {
    constructor() {
        this.type = InitializeStoreActionType;
    }
}
/**
 * @deprecated Will be removed in v7.0.0
 * Stream operator to filter the `Actions` stream to only pass the `InitializeStoreAction`.
 * This can be used to write `Reducer`s or `Effect`s that are only run when their `Store` is
 * initially created.
 */
export const ofStoreInit = () => (source) => source.pipe(filter((action) => action.type === InitializeStoreActionType));
/**
 * @internal
 */
export class StoreBroker {
    constructor(superstore, actions, reducerManager, effectsSources, injector) {
        this.superstore = superstore;
        this.actions = actions;
        this.reducerManager = reducerManager;
        this.effectsSources = effectsSources;
        this.injector = injector;
        this.initializedStores = new Map();
    }
    initStore(storeName, reducer, effects, branchName, dispatchChannel, inputChannels = [], widgetInjector) {
        if (this.isStoreInitialized(branchName, storeName)) {
            return this.createStore(storeName, branchName, dispatchChannel);
        }
        const allInputChannels = [this.privateChannel(storeName, dispatchChannel), ...inputChannels];
        this.addReducer(storeName, branchName, reducer, allInputChannels);
        this.setStoreInitialized(branchName, storeName);
        const store = this.createStore(storeName, branchName, dispatchChannel);
        effects
            .map(token => (widgetInjector || this.injector).get(token))
            .forEach((effectInstance) => {
            this.addEffects(store, effectInstance, this.privateChannel(storeName, dispatchChannel), allInputChannels);
        });
        store.dispatch(new InitializeStoreAction());
        return store;
    }
    createStore(storeName, branchName, dispatchChannel) {
        return {
            select: (selector) => {
                return this.superstore.select(state => state[this.privateBranch(storeName, branchName)]).pipe(map(selector));
            },
            dispatch: (action) => {
                this.dispatchForStore(storeName, dispatchChannel, action);
            },
        };
    }
    /**
     * Dispatches an action scoped on a channel just for this store.
     */
    dispatchForStore(storeName, dispatchChannel, action) {
        this.dispatchOnChannel(this.privateChannel(storeName, dispatchChannel), action);
    }
    dispatchOnChannel(channel, action) {
        this.superstore.dispatch(createChannelAction(action, channel));
    }
    isStoreInitialized(branchName, storeName) {
        const storesInBranch = this.initializedStores.get(branchName);
        return !!(storesInBranch && storesInBranch.find(name => name === storeName));
    }
    setStoreInitialized(branchName, storeName) {
        let storesInBranch = this.initializedStores.get(branchName);
        if (storesInBranch === undefined) {
            storesInBranch = [];
            this.initializedStores.set(branchName, storesInBranch);
        }
        storesInBranch.push(storeName);
    }
    addReducer(storeName, branchName, reducer, inputChannels) {
        this.reducerManager.addFeature({
            key: this.privateBranch(storeName, branchName),
            reducers: createMetaChannelReducer(inputChannels)(reducer),
            reducerFactory: () => {
                throw new Error('No reducer factory');
            },
            metaReducers: [], //[createMetaChannelReducer(inputChannels)],
        });
    }
    addEffects(store, effects, dispatchChannel, listenChannels) {
        this.effectsSources.addEffects(createMetaChannelEffects(store, this.actions, effects, dispatchChannel, listenChannels));
    }
    privateBranch(storeName, branchName) {
        return `${storeName}/${branchName}`;
    }
    privateChannel(storeName, dispatchChannel) {
        return `${storeName}/${dispatchChannel}`;
    }
}
StoreBroker.ɵprov = i0.ɵɵdefineInjectable({ factory: function StoreBroker_Factory() { return new StoreBroker(i0.ɵɵinject(i1.Store), i0.ɵɵinject(i2.Actions), i0.ɵɵinject(i1.ReducerManager), i0.ɵɵinject(i2.EffectSources), i0.ɵɵinject(i0.INJECTOR)); }, token: StoreBroker, providedIn: "root" });
StoreBroker.decorators = [
    { type: Injectable, args: [{ providedIn: 'root' },] }
];
StoreBroker.ctorParameters = () => [
    { type: undefined, decorators: [{ type: Inject, args: [NgrxStore,] }] },
    { type: Observable, decorators: [{ type: Inject, args: [NgrxActions,] }] },
    { type: undefined, decorators: [{ type: Inject, args: [NgrxReducerManager,] }] },
    { type: undefined, decorators: [{ type: Inject, args: [NgrxEffectsSources,] }] },
    { type: Injector }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RvcmUtYnJva2VyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9iYWNrYmFzZS9mb3VuZGF0aW9uLWFuZy9zdG9yZS9zcmMvc3RvcmUtYnJva2VyLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzdELE9BQU8sRUFBRSxjQUFjLElBQUksa0JBQWtCLEVBQUUsS0FBSyxJQUFJLFNBQVMsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUN2RixPQUFPLEVBQUUsT0FBTyxJQUFJLFdBQVcsRUFBRSxhQUFhLElBQUksa0JBQWtCLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDNUYsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNsQyxPQUFPLEVBQVcsa0JBQWtCLElBQUksd0JBQXdCLEVBQWUsTUFBTSxZQUFZLENBQUM7QUFDbEcsT0FBTyxFQUFtQixtQkFBbUIsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUNqRSxPQUFPLEVBQUUsd0JBQXdCLEVBQXVELE1BQU0sV0FBVyxDQUFDO0FBRTFHLE9BQU8sRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7Ozs7QUFDN0M7O0dBRUc7QUFDSCxNQUFNLENBQUMsTUFBTSx5QkFBeUIsR0FBRyx1Q0FBdUMsQ0FBQztBQUNqRjs7OztHQUlHO0FBQ0gsTUFBTSxPQUFPLHFCQUFxQjtJQUFsQztRQUNXLFNBQUksR0FBRyx5QkFBeUIsQ0FBQztJQUM1QyxDQUFDO0NBQUE7QUFFRDs7Ozs7R0FLRztBQUNILE1BQU0sQ0FBQyxNQUFNLFdBQVcsR0FBRyxHQUFHLEVBQUUsQ0FBQyxDQUFDLE1BQTBCLEVBQXFDLEVBQUUsQ0FDakcsTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxNQUFNLEVBQW1D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RUFBRSw0Q0FBNEM7U0FDL0QsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVPLFVBQVUsQ0FDaEIsS0FBb0IsRUFDcEIsT0FBbUIsRUFDbkIsZUFBd0IsRUFDeEIsY0FBOEI7UUFFOUIsSUFBSSxDQUFDLGNBQWMsQ0FBQyxVQUFVLENBQzVCLHdCQUF3QixDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsT0FBTyxFQUFFLE9BQU8sRUFBRSxlQUFlLEVBQUUsY0FBYyxDQUFDLENBQ3hGLENBQUM7SUFDSixDQUFDO0lBRU8sYUFBYSxDQUFDLFNBQW9CLEVBQUUsVUFBc0I7UUFDaEUsT0FBTyxHQUFHLFNBQVMsSUFBSSxVQUFVLEVBQUUsQ0FBQztJQUN0QyxDQUFDO0lBRU8sY0FBYyxDQUFDLFNBQW9CLEVBQUUsZUFBd0I7UUFDbkUsT0FBTyxHQUFHLFNBQVMsSUFBSSxlQUFlLEVBQUUsQ0FBQztJQUMzQyxDQUFDOzs7O1lBcEhGLFVBQVUsU0FBQyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUU7Ozs0Q0FLN0IsTUFBTSxTQUFDLFNBQVM7WUE3RVosVUFBVSx1QkE4RWQsTUFBTSxTQUFDLFdBQVc7NENBQ2xCLE1BQU0sU0FBQyxrQkFBa0I7NENBQ3pCLE1BQU0sU0FBQyxrQkFBa0I7WUFuRlQsUUFBUSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEluamVjdG9yLCBJbmplY3QgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFJlZHVjZXJNYW5hZ2VyIGFzIE5ncnhSZWR1Y2VyTWFuYWdlciwgU3RvcmUgYXMgTmdyeFN0b3JlIH0gZnJvbSAnQG5ncngvc3RvcmUnO1xuaW1wb3J0IHsgQWN0aW9ucyBhcyBOZ3J4QWN0aW9ucywgRWZmZWN0U291cmNlcyBhcyBOZ3J4RWZmZWN0c1NvdXJjZXMgfSBmcm9tICdAbmdyeC9lZmZlY3RzJztcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IFJlZHVjZXIsIG1ldGFDaGFubmVsUmVkdWNlciBhcyBjcmVhdGVNZXRhQ2hhbm5lbFJlZHVjZXIsIE1ldGFSZWR1Y2VyIH0gZnJvbSAnLi9yZWR1Y2Vycyc7XG5pbXBvcnQgeyBBY3Rpb24sIENoYW5uZWwsIGNyZWF0ZUNoYW5uZWxBY3Rpb24gfSBmcm9tICcuL2FjdGlvbnMnO1xuaW1wb3J0IHsgY3JlYXRlTWV0YUNoYW5uZWxFZmZlY3RzLCBOZ3J4RWZmZWN0c0luc3RhbmNlLCBFZmZlY3RzSW5qZWN0aW9uVG9rZW4sIEVmZmVjdHMgfSBmcm9tICcuL2VmZmVjdHMnO1xuaW1wb3J0IHsgU2VsZWN0b3IgfSBmcm9tICcuL3NlbGVjdG9ycyc7XG5pbXBvcnQgeyBmaWx0ZXIsIG1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbi8qKlxuICogQGRlcHJlY2F0ZWQgV2lsbCBiZSByZW1vdmVkIGluIHY3LjAuMFxuICovXG5leHBvcnQgY29uc3QgSW5pdGlhbGl6ZVN0b3JlQWN0aW9uVHlwZSA9ICdbQmFja2Jhc2UgUmVkdWNlcl0gSU5JVElBTElaRSBSRURVQ0VSJztcbi8qKlxuICogQGRlcHJlY2F0ZWQgV2lsbCBiZSByZW1vdmVkIGluIHY3LjAuMFxuICogQW4gYEFjdGlvbmAgdGhhdCBpcyBkaXNwYXRjaGVkIHRvIGEgYFN0b3JlYCB3aGVuIGl0IGlzIGNyZWF0ZWQgdG8gYWxsb3cgdGhlIHN0b3JlIHRvIGluaXRpYWxpemVcbiAqIGl0cyBpbml0aWFsIHN0YXRlXG4gKi9cbmV4cG9ydCBjbGFzcyBJbml0aWFsaXplU3RvcmVBY3Rpb24gaW1wbGVtZW50cyBBY3Rpb24ge1xuICByZWFkb25seSB0eXBlID0gSW5pdGlhbGl6ZVN0b3JlQWN0aW9uVHlwZTtcbn1cblxuLyoqXG4gKiBAZGVwcmVjYXRlZCBXaWxsIGJlIHJlbW92ZWQgaW4gdjcuMC4wXG4gKiBTdHJlYW0gb3BlcmF0b3IgdG8gZmlsdGVyIHRoZSBgQWN0aW9uc2Agc3RyZWFtIHRvIG9ubHkgcGFzcyB0aGUgYEluaXRpYWxpemVTdG9yZUFjdGlvbmAuXG4gKiBUaGlzIGNhbiBiZSB1c2VkIHRvIHdyaXRlIGBSZWR1Y2VyYHMgb3IgYEVmZmVjdGBzIHRoYXQgYXJlIG9ubHkgcnVuIHdoZW4gdGhlaXIgYFN0b3JlYCBpc1xuICogaW5pdGlhbGx5IGNyZWF0ZWQuXG4gKi9cbmV4cG9ydCBjb25zdCBvZlN0b3JlSW5pdCA9ICgpID0+IChzb3VyY2U6IE9ic2VydmFibGU8QWN0aW9uPik6IE9ic2VydmFibGU8SW5pdGlhbGl6ZVN0b3JlQWN0aW9uPiA9PlxuICBzb3VyY2UucGlwZShmaWx0ZXIoKGFjdGlvbik6IGFjdGlvbiBpcyBJbml0aWFsaXplU3RvcmVBY3Rpb24gPT4gYWN0aW9uLnR5cGUgPT09IEluaXRpYWxpemVTdG9yZUFjdGlvblR5cGUpKTtcbi8qKlxuICogQGRlcHJlY2F0ZWQgV2lsbCBiZSByZW1vdmVkIGluIHY3LjAuMFxuICovXG5leHBvcnQgdHlwZSBCcmFuY2hOYW1lID0gc3RyaW5nO1xuLyoqXG4gKiBAZGVwcmVjYXRlZCBXaWxsIGJlIHJlbW92ZWQgaW4gdjcuMC4wXG4gKiBUaGUgbmFtZSBvZiB0aGUgc3RvcmUgdXNlZCB0byBzZWdyZWdhdGUgdGhlIFN0b3JlIHN0YXRlcyB3aXRoaW4gdGhlIGFwcGxpY2F0aW9uIHN0YXRlIGJyYW5jaC5cbiAqL1xuZXhwb3J0IHR5cGUgU3RvcmVOYW1lID0gc3RyaW5nO1xuXG4vKipcbiAqIEBkZXByZWNhdGVkIFdpbGwgYmUgcmVtb3ZlZCBpbiB2Ny4wLjBcbiAqIEEgU3RvcmUgdGhhdCBtYWludGFpbnMgaW50ZXJuYWwgc3RhdGUgd2hpY2ggY2FuIGJlIHF1ZXJpZWQgYW5kIGFjdGVkIHVwb24uXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgU3RvcmU8U3RhdGUsIFYgZXh0ZW5kcyBBY3Rpb24+IHtcbiAgLyoqXG4gICAqIERpc3BhdGNoIGFuIGFjdGlvbiB0byB0aGUgc3RvcmUuXG4gICAqIFRoaXMgbWF5IHJlc3VsdCBpbiBjaGFuZ2VzIGluIHN0YXRlIGFuZC9vciBleHRlcm5hbCBlZmZlY3RzLlxuICAgKi9cbiAgZGlzcGF0Y2g6IChhY3Rpb246IFYpID0+IHZvaWQ7XG5cbiAgLyoqXG4gICAqIFNlbGVjdCBhIHByb2plY3Rpb24gb2YgdGhlIGludGVybmFsIHN0YXRlLlxuICAgKi9cbiAgc2VsZWN0OiA8Uj4oc2VsZWN0b3I6IFNlbGVjdG9yPFN0YXRlLCBSPikgPT4gT2JzZXJ2YWJsZTxSPjtcbn1cbi8qKlxuICogQGRlcHJlY2F0ZWQgV2lsbCBiZSByZW1vdmVkIGluIHY3LjAuMFxuICovXG5leHBvcnQgaW50ZXJmYWNlIFJlZHVjZXJNYW5hZ2VyIHtcbiAgYWRkRmVhdHVyZTxULCBWIGV4dGVuZHMgQWN0aW9uPihmZWF0dXJlRGVmOiB7XG4gICAga2V5OiBzdHJpbmc7XG4gICAgcmVkdWNlcnM6IFJlZHVjZXI8VCwgVj47XG4gICAgcmVkdWNlckZhY3Rvcnk6ICgpID0+IG5ldmVyO1xuICAgIG1ldGFSZWR1Y2VyczogQXJyYXk8TWV0YVJlZHVjZXI8VCwgVj4+O1xuICB9KTogdm9pZDtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBFZmZlY3RTb3VyY2VzPFYgZXh0ZW5kcyBBY3Rpb24+IHtcbiAgYWRkRWZmZWN0cyhlZmZlY3RzOiBOZ3J4RWZmZWN0c0luc3RhbmNlPFY+KTogdm9pZDtcbn1cblxuLyoqXG4gKiBAaW50ZXJuYWxcbiAqL1xuQEluamVjdGFibGUoeyBwcm92aWRlZEluOiAncm9vdCcgfSlcbmV4cG9ydCBjbGFzcyBTdG9yZUJyb2tlciB7XG4gIHByaXZhdGUgcmVhZG9ubHkgaW5pdGlhbGl6ZWRTdG9yZXMgPSBuZXcgTWFwPEJyYW5jaE5hbWUsIEFycmF5PFN0b3JlTmFtZT4+KCk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgQEluamVjdChOZ3J4U3RvcmUpIHByaXZhdGUgcmVhZG9ubHkgc3VwZXJzdG9yZTogU3RvcmU8YW55LCBBY3Rpb24+LFxuICAgIEBJbmplY3QoTmdyeEFjdGlvbnMpIHByaXZhdGUgcmVhZG9ubHkgYWN0aW9uczogT2JzZXJ2YWJsZTxBY3Rpb24+LFxuICAgIEBJbmplY3QoTmdyeFJlZHVjZXJNYW5hZ2VyKSBwcml2YXRlIHJlYWRvbmx5IHJlZHVjZXJNYW5hZ2VyOiBSZWR1Y2VyTWFuYWdlcixcbiAgICBASW5qZWN0KE5ncnhFZmZlY3RzU291cmNlcykgcHJpdmF0ZSByZWFkb25seSBlZmZlY3RzU291cmNlczogRWZmZWN0U291cmNlczxhbnk+LFxuICAgIHByaXZhdGUgcmVhZG9ubHkgaW5qZWN0b3I6IEluamVjdG9yLFxuICApIHt9XG5cbiAgaW5pdFN0b3JlPFQsIFYgZXh0ZW5kcyBBY3Rpb24+KFxuICAgIHN0b3JlTmFtZTogU3RvcmVOYW1lLFxuICAgIHJlZHVjZXI6IFJlZHVjZXI8VCwgVj4sXG4gICAgZWZmZWN0czogQXJyYXk8RWZmZWN0c0luamVjdGlvblRva2VuPFY+PixcbiAgICBicmFuY2hOYW1lOiBCcmFuY2hOYW1lLFxuICAgIGRpc3BhdGNoQ2hhbm5lbDogQ2hhbm5lbCxcbiAgICBpbnB1dENoYW5uZWxzOiBBcnJheTxDaGFubmVsPiA9IFtdLFxuICAgIHdpZGdldEluamVjdG9yPzogSW5qZWN0b3IsXG4gICk6IFN0b3JlPFQsIFY+IHtcbiAgICBpZiAodGhpcy5pc1N0b3JlSW5pdGlhbGl6ZWQoYnJhbmNoTmFtZSwgc3RvcmVOYW1lKSkge1xuICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlU3RvcmUoc3RvcmVOYW1lLCBicmFuY2hOYW1lLCBkaXNwYXRjaENoYW5uZWwpO1xuICAgIH1cblxuICAgIGNvbnN0IGFsbElucHV0Q2hhbm5lbHMgPSBbdGhpcy5wcml2YXRlQ2hhbm5lbChzdG9yZU5hbWUsIGRpc3BhdGNoQ2hhbm5lbCksIC4uLmlucHV0Q2hhbm5lbHNdO1xuXG4gICAgdGhpcy5hZGRSZWR1Y2VyKHN0b3JlTmFtZSwgYnJhbmNoTmFtZSwgcmVkdWNlciwgYWxsSW5wdXRDaGFubmVscyk7XG5cbiAgICB0aGlzLnNldFN0b3JlSW5pdGlhbGl6ZWQoYnJhbmNoTmFtZSwgc3RvcmVOYW1lKTtcblxuICAgIGNvbnN0IHN0b3JlID0gdGhpcy5jcmVhdGVTdG9yZTxULCBWPihzdG9yZU5hbWUsIGJyYW5jaE5hbWUsIGRpc3BhdGNoQ2hhbm5lbCk7XG4gICAgZWZmZWN0c1xuICAgICAgLm1hcCh0b2tlbiA9PiAod2lkZ2V0SW5qZWN0b3IgfHwgdGhpcy5pbmplY3RvcikuZ2V0PEVmZmVjdHM8Vj4+KHRva2VuKSlcbiAgICAgIC5mb3JFYWNoKChlZmZlY3RJbnN0YW5jZTogRWZmZWN0czxWPikgPT4ge1xuICAgICAgICB0aGlzLmFkZEVmZmVjdHMoc3RvcmUsIGVmZmVjdEluc3RhbmNlLCB0aGlzLnByaXZhdGVDaGFubmVsKHN0b3JlTmFtZSwgZGlzcGF0Y2hDaGFubmVsKSwgYWxsSW5wdXRDaGFubmVscyk7XG4gICAgICB9KTtcblxuICAgIHN0b3JlLmRpc3BhdGNoKG5ldyBJbml0aWFsaXplU3RvcmVBY3Rpb24oKSBhcyBWKTtcblxuICAgIHJldHVybiBzdG9yZTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlU3RvcmU8VCwgViBleHRlbmRzIEFjdGlvbj4oXG4gICAgc3RvcmVOYW1lOiBTdG9yZU5hbWUsXG4gICAgYnJhbmNoTmFtZTogQnJhbmNoTmFtZSxcbiAgICBkaXNwYXRjaENoYW5uZWw6IENoYW5uZWwsXG4gICk6IFN0b3JlPFQsIFY+IHtcbiAgICByZXR1cm4ge1xuICAgICAgc2VsZWN0OiA8Uj4oc2VsZWN0b3I6IChzdGF0ZTogVCkgPT4gUik6IE9ic2VydmFibGU8Uj4gPT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5zdXBlcnN0b3JlLnNlbGVjdDxUPihzdGF0ZSA9PiBzdGF0ZVt0aGlzLnByaXZhdGVCcmFuY2goc3RvcmVOYW1lLCBicmFuY2hOYW1lKV0pLnBpcGUobWFwKHNlbGVjdG9yKSk7XG4gICAgICB9LFxuICAgICAgZGlzcGF0Y2g6IChhY3Rpb246IFYpID0+IHtcbiAgICAgICAgdGhpcy5kaXNwYXRjaEZvclN0b3JlKHN0b3JlTmFtZSwgZGlzcGF0Y2hDaGFubmVsLCBhY3Rpb24pO1xuICAgICAgfSxcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIERpc3BhdGNoZXMgYW4gYWN0aW9uIHNjb3BlZCBvbiBhIGNoYW5uZWwganVzdCBmb3IgdGhpcyBzdG9yZS5cbiAgICovXG4gIHByaXZhdGUgZGlzcGF0Y2hGb3JTdG9yZShzdG9yZU5hbWU6IFN0b3JlTmFtZSwgZGlzcGF0Y2hDaGFubmVsOiBDaGFubmVsLCBhY3Rpb246IEFjdGlvbikge1xuICAgIHRoaXMuZGlzcGF0Y2hPbkNoYW5uZWwodGhpcy5wcml2YXRlQ2hhbm5lbChzdG9yZU5hbWUsIGRpc3BhdGNoQ2hhbm5lbCksIGFjdGlvbik7XG4gIH1cblxuICBwcml2YXRlIGRpc3BhdGNoT25DaGFubmVsKGNoYW5uZWw6IENoYW5uZWwsIGFjdGlvbjogQWN0aW9uKSB7XG4gICAgdGhpcy5zdXBlcnN0b3JlLmRpc3BhdGNoKGNyZWF0ZUNoYW5uZWxBY3Rpb24oYWN0aW9uLCBjaGFubmVsKSk7XG4gIH1cblxuICBwcml2YXRlIGlzU3RvcmVJbml0aWFsaXplZChicmFuY2hOYW1lOiBCcmFuY2hOYW1lLCBzdG9yZU5hbWU6IFN0b3JlTmFtZSk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IHN0b3Jlc0luQnJhbmNoID0gdGhpcy5pbml0aWFsaXplZFN0b3Jlcy5nZXQoYnJhbmNoTmFtZSk7XG4gICAgcmV0dXJuICEhKHN0b3Jlc0luQnJhbmNoICYmIHN0b3Jlc0luQnJhbmNoLmZpbmQobmFtZSA9PiBuYW1lID09PSBzdG9yZU5hbWUpKTtcbiAgfVxuXG4gIHByaXZhdGUgc2V0U3RvcmVJbml0aWFsaXplZChicmFuY2hOYW1lOiBCcmFuY2hOYW1lLCBzdG9yZU5hbWU6IFN0b3JlTmFtZSkge1xuICAgIGxldCBzdG9yZXNJbkJyYW5jaCA9IHRoaXMuaW5pdGlhbGl6ZWRTdG9yZXMuZ2V0KGJyYW5jaE5hbWUpO1xuICAgIGlmIChzdG9yZXNJbkJyYW5jaCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICBzdG9yZXNJbkJyYW5jaCA9IFtdO1xuICAgICAgdGhpcy5pbml0aWFsaXplZFN0b3Jlcy5zZXQoYnJhbmNoTmFtZSwgc3RvcmVzSW5CcmFuY2gpO1xuICAgIH1cbiAgICBzdG9yZXNJbkJyYW5jaC5wdXNoKHN0b3JlTmFtZSk7XG4gIH1cblxuICBwcml2YXRlIGFkZFJlZHVjZXI8VCwgViBleHRlbmRzIEFjdGlvbj4oXG4gICAgc3RvcmVOYW1lOiBTdG9yZU5hbWUsXG4gICAgYnJhbmNoTmFtZTogQnJhbmNoTmFtZSxcbiAgICByZWR1Y2VyOiBSZWR1Y2VyPFQsIFY+LFxuICAgIGlucHV0Q2hhbm5lbHM6IEFycmF5PENoYW5uZWw+LFxuICApIHtcbiAgICB0aGlzLnJlZHVjZXJNYW5hZ2VyLmFkZEZlYXR1cmUoe1xuICAgICAga2V5OiB0aGlzLnByaXZhdGVCcmFuY2goc3RvcmVOYW1lLCBicmFuY2hOYW1lKSxcbiAgICAgIHJlZHVjZXJzOiBjcmVhdGVNZXRhQ2hhbm5lbFJlZHVjZXI8VCwgVj4oaW5wdXRDaGFubmVscykocmVkdWNlciksXG4gICAgICByZWR1Y2VyRmFjdG9yeTogKCkgPT4ge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIHJlZHVjZXIgZmFjdG9yeScpO1xuICAgICAgfSxcbiAgICAgIG1ldGFSZWR1Y2VyczogW10sIC8vW2NyZWF0ZU1ldGFDaGFubmVsUmVkdWNlcihpbnB1dENoYW5uZWxzKV0sXG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGFkZEVmZmVjdHM8ViBleHRlbmRzIEFjdGlvbj4oXG4gICAgc3RvcmU6IFN0b3JlPGFueSwgVj4sXG4gICAgZWZmZWN0czogRWZmZWN0czxWPixcbiAgICBkaXNwYXRjaENoYW5uZWw6IENoYW5uZWwsXG4gICAgbGlzdGVuQ2hhbm5lbHM6IEFycmF5PENoYW5uZWw+LFxuICApOiB2b2lkIHtcbiAgICB0aGlzLmVmZmVjdHNTb3VyY2VzLmFkZEVmZmVjdHMoXG4gICAgICBjcmVhdGVNZXRhQ2hhbm5lbEVmZmVjdHMoc3RvcmUsIHRoaXMuYWN0aW9ucywgZWZmZWN0cywgZGlzcGF0Y2hDaGFubmVsLCBsaXN0ZW5DaGFubmVscyksXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgcHJpdmF0ZUJyYW5jaChzdG9yZU5hbWU6IFN0b3JlTmFtZSwgYnJhbmNoTmFtZTogQnJhbmNoTmFtZSkge1xuICAgIHJldHVybiBgJHtzdG9yZU5hbWV9LyR7YnJhbmNoTmFtZX1gO1xuICB9XG5cbiAgcHJpdmF0ZSBwcml2YXRlQ2hhbm5lbChzdG9yZU5hbWU6IFN0b3JlTmFtZSwgZGlzcGF0Y2hDaGFubmVsOiBDaGFubmVsKSB7XG4gICAgcmV0dXJuIGAke3N0b3JlTmFtZX0vJHtkaXNwYXRjaENoYW5uZWx9YDtcbiAgfVxufVxuIl19