{"version":3,"file":"backbase-foundation-ang-migration.js","sources":["../../../../projects/backbase/foundation-ang/migration/src/intents.ts","../../../../projects/backbase/foundation-ang/migration/src/backbase-foundation-ang-migration.ts"],"names":[],"mappings":";;;;;;;AAcM,SAAU,WAAW,CAAC,mBAAwC,EAAA;AAAE,IACpE,OAAO,mBAAmB,CAAC,oBAAoB,CAAC,IAAI,CAAC,mBAAmB,CAAC,CAAC;AAC5E,CAAC;AACD,MAea,gBAAgB,CAAA;AAC3B,IAAA,EAAE,CAAC,GAAW,EAAA;AACZ,QAAA,QAAQ,CAAC,IAAI,GAAG,GAAG,CAAC;AACxB,KAAG;AACH;4CALC,UAAU,EAAA;;;;0BACX;AAAC,MAOY,aAAa,CAAA;AAAE,IAG1B,GAAG,GAAA;AACD,QAAA,MAAM,YAAY,GAAuB,cAAc,CAAC,OAAO,CAAC,aAAa,CAAC,SAAS,CAAC,IAAI,SAAS,CAAC;AAC1G,QAAI,IAAI,YAAY,KAAK,SAAS,EAAE;AACpC,YAAM,OAAO;AACR,SAAA;AACL,QAAI,MAAM,MAAM,GAAY,IAAI,CAAC,KAAK,CAAC,YAAY,CAAC,CAAC;AACjD,QAAA,IAAI,CAAC,UAAU,CAAC,MAAM,CAAC,EAAE;AAC7B,YAAM,OAAO;AACR,SAAA;AACD,QAAA,OAAO,MAAM,CAAC;AAClB,KAAG;AACH,IACE,KAAK,GAAA;AACH,QAAA,cAAc,CAAC,UAAU,CAAC,aAAa,CAAC,SAAS,CAAC,CAAC;AACvD,KAAG;AAED,IAAA,GAAG,CAAC,MAAc,EAAA;AAChB,QAAA,cAAc,CAAC,OAAO,CAAC,aAAa,CAAC,SAAS,EAAE,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,CAAC,CAAC;AAC5E,KAAG;AACH;;qHAAC;AArBQ,aAAS,CAAA,SAAA,GAAG,gCAAgC,CAAC;yCAFrD,UAAU,EAAA;;0BACX;AAwBA;AAEA,SAAS,UAAU,CAAC,MAAe,EAAA;AAAE,IACnC,IAAI,OAAO,MAAM,KAAK,QAAQ,IAAI,MAAM,KAAK,IAAI,EAAE;AACjD,QAAA,OAAO,KAAK,CAAC;AACd,KAAA;AACH,IAAE,MAAM,aAAa,GAAG,MAAgB,CAAC;AACzC,IAAE,MAAM,OAAO,GAAG,OAAO,aAAa,CAAC,IAAI,KAAK,QAAQ,CAAC;AACvD,IAAA,MAAM,aAAa,GAAG,OAAO,aAAa,CAAC,UAAU,KAAK,QAAQ,IAAI,aAAa,CAAC,UAAU,KAAK,IAAI,CAAC;AAC1G,IAAE,OAAO,OAAO,IAAI,aAAa,CAAC;AAClC,CAAC;AAED,SAAS,aAAa,CACpB,KAAsC,EACtC,MAA6C,EAAA;AAC/C,IACE,OAAO,MAAM,IAAG;AACd,QAAA,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,EAAE;AAClB,YAAA,OAAO,SAAS,CAAC;AAClB,SAAA;AACD,QAAA,OAAO,MAAM,CAAC,MAAM,CAAC,UAAU,CAAC,CAAC;AACnC,KAAC,CAAC;AACJ,CAAC;AACD,MAsBa,uBAAuB,GAAG,IAAI,cAAc,CAAC,yBAAyB,EAAE;AACrF,MAEa,mBAAmB,CAAA;AAC9B,IAAA,WAAA,CACmB,SAAgC,EAChC,cAAsC,EACtC,KAAoB,EACa,QAAmD,EAAA;AACzG,QAJqB,IAAS,CAAA,SAAA,GAAT,SAAS,CAAuB;AAAC,QACjC,IAAc,CAAA,cAAA,GAAd,cAAc,CAAwB;AAAC,QACvC,IAAK,CAAA,KAAA,GAAL,KAAK,CAAe;AAAC,QACY,IAAQ,CAAA,QAAA,GAAR,QAAQ,CAA2C;AAAC,KACpG;AAEI,IAAA,uBAAuB,CAAC,QAA8D,EAAA;AAAE,QAC9F,MAAM,MAAM,GAAG,IAAI,CAAC,KAAK,CAAC,GAAG,EAAE,CAAC;AACpC,QAAI,IAAI,CAAC,MAAM,EAAE;AACjB,YAAM,OAAO;AACR,SAAA;AAED,QAAA,KAAK,MAAM,MAAM,IAAI,QAAQ,EAAE;AAC7B,YAAA,MAAM,QAAQ,GAAG,MAAM,CAAC,MAAM,CAAC,CAAC;AAChC,YAAA,IAAI,QAAQ,EAAE;AACZ,gBAAA,IAAI,CAAC,KAAK,CAAC,KAAK,EAAE,CAAC;AACnB,gBAAA,OAAO,QAAQ,CAAC;AACjB,aAAA;AACF,SAAA;AACL,QAAI,OAAO;AACX,KAAG;AACH,IACE,oBAAoB,GAAA;AAAE,QACpB,IAAI,CAAC,uBAAuB,CAC1B,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,CAAC,EAAE,KAAK,EAAE,KAAK,EAAE,OAAO,EAAE,KAC1C,aAAa,CAAC,KAAK,EAAE,UAAU,IAAG;AAChC,YAAA,MAAM,MAAM,GAAG,EAAE,CAAC,KAAK,GAAG,OAAO,CAAC,UAAU,CAAC,EAAE,CAAC;AAC1D,YAAU,OAAO,IAAI,CAAC,SAAS;AAC/B,iBAAa,cAAc,CAAC,IAAI,uBAAuB,CAAC,aAAa,EAAE,KAAK,CAAC,CAAC;AAC9E,iBAAa,IAAI,CACH,KAAK,EAAE,EACP,GAAG,CAAC,cAAc,IAAG;AAAE,gBACrB,IAAI,cAAc,KAAK,SAAS,EAAE;AAChC,oBAAA,OAAO,OAAO,CAAC,IAAI,CAAC,6CAA6C,CAAC,CAAC;AACpE,iBAAA;AACjB,gBAAgB,IAAI,CAAC,cAAc,CAAC,cAAc,CAAC,cAAc,CAAC,IAAI,EAAE,MAAM,CAAC,CAAC;AAClE,aAAC,CAAC,CACH;AACA,iBAAA,SAAS,EAAE,CAAC;AACzB,SAAS,CAAC,CACH,CACF,CAAC;AACN,KAAG;AACH;+CA9CC,UAAU,EAAA;uIACX;AAAC;AACU,YArGT,qBAAqB,EAAA;AACvB,YAFE,sBAAsB,EAAA;AACxB,YAwG4B,aAAa,EAAA;AACzC,YAAgE,KAAK,EAAA,UAAA,EAAA,CAAA,EAAA,IAAA,EAAhE,MAAM,EAAA,IAAA,EAAA,CAAC,uBAAuB,EAAA,EAAA,CAAA,EAAA;AAAC;;;;;;kCAAE;AA0CtC;AAEA,MAAM,GAAG,GAAG,QAAQ,CAAC;AAErB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACG;AACA,MAAU,QAAQ,CAAA;AACnB;AACE;AAEH;AAAO;AACH;AACE,IAAL,OAAO,UAAU,CAAC,KAAa,EAAA;AAC7B,QAAA,OAAO,sBAAsB,CAAC,UAAU,CAAC,IAAI,uBAAuB,CAAC,GAAG,EAAE,KAAK,CAAC,CAAC,CAAC;AACtF,KAAG;AACF,CAAA;AACD,MACa,wBAAwB,GAAG,IAAI,cAAc,CAAC,uBAAuB,EAAE;AACpF,MAgBa,cAAc,CAAA;AACzB,IAAA,WAAA,CACmB,SAA2B,EAC3B,OAAsB,EACtB,gBAA8D,EAAA;AACnF,QAHqB,IAAS,CAAA,SAAA,GAAT,SAAS,CAAkB;AAAC,QAC5B,IAAO,CAAA,OAAA,GAAP,OAAO,CAAe;AAAC,QACvB,IAAgB,CAAA,gBAAA,GAAhB,gBAAgB,CAA8C;AAAC,KAC9E;AAEJ,IAAA,IAAI,CAAC,KAAa,EAAA;AAAE,QAClB,OAAO,CAAC,KAAyB,KAAU;AACzC,YAAA,MAAM,OAAO,GAAG,IAAI,CAAC,gBAAgB,CAAC,IAAI,CAAC,OAAO,IAAI,OAAO,CAAC,KAAK,KAAK,KAAK,CAAC,CAAC;AACrF,YAAM,IAAI,CAAC,OAAO,EAAE;AACpB,gBAAQ,OAAO;AACR,aAAA;AACD,YAAA,KAAK,KAAK,CAAC,SAAS,CAAC,CAAC,KAAa,KAAI;AAAE,gBACvC,MAAM,UAAU,GAAG,OAAO,CAAC,UAAU,CAAC,KAAK,CAAC,CAAC;AAC7C,gBAAA,MAAM,MAAM,GAAW;AAC/B,oBAAU,IAAI,EAAE,OAAO,CAAC,MAAM;AAC9B,oBAAU,UAAU;AACpB,iBAAS,CAAC;AACF,gBAAA,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC;AACjC,gBAAQ,IAAI,CAAC,SAAS,CAAC,EAAE,CAAC,OAAO,CAAC,SAAS,CAAC,CAAC;AACvC,aAAC,CAAC,CAAC;AACL,SAAC,CAAC;AACN,KAAG;AACF,CAAA;AACD,SACgB,oBAAoB,CAClC,SAA2B,EAC3B,OAAsB,EACtB,QAAsD,EAAA;AACxD,IACE,OAAO,IAAI,cAAc,CAAC,SAAS,EAAE,OAAO,EAAE,QAAQ,CAAC,CAAC;AAC1D,CAAC;AAEY,MAAA,qBAAqB,GAAsC;AACtE,IAAA,IAAI,EAAE,GAAG;AACT,IAAA,QAAQ,EAAE;AACR,QAAA,OAAO,EAAE,IAAI,cAAc,CAAC,0BAA0B,CAAC;AACvD,QAAA,UAAU,EAAE,oBAAoB;AAChC,QAAA,IAAI,EAAE,CAAC,gBAAgB,EAAE,aAAa,EAAE,wBAAwB,CAAC;AAClE,KAAA;AACH,EAAE;AAEF;AACA;AACG;AACA,MAOU,mBAAmB,CAAA;AAAE,IAChC,OAAO,OAAO,CAAC,MAGd,EAAA;AAAE,QACD,OAAO;AACL,YAAA,QAAQ,EAAE,mBAAmB;AAC7B,YAAA,SAAS,EAAE;AACT,gBAAA;AACE,oBAAA,OAAO,EAAE,wBAAwB;AAC3C,oBAAU,QAAQ,EAAE,MAAM,CAAC,QAAQ;AAC1B,iBAAA;AACD,gBAAA;AACE,oBAAA,OAAO,EAAE,uBAAuB;AAC1C,oBAAU,QAAQ,EAAE,MAAM,CAAC,QAAQ;AAC1B,iBAAA;AACT,gBAAQ,mBAAmB;AACnB,gBAAA;AACE,oBAAA,OAAO,EAAE,eAAe;AACxB,oBAAA,UAAU,EAAE,WAAW;AACjC,oBAAU,IAAI,EAAE,CAAC,mBAAmB,CAAC;AAC3B,oBAAA,KAAK,EAAE,IAAI;AACZ,iBAAA;AACT,gBAAQ,aAAa;AACrB,gBAAQ,gBAAgB;AACjB,aAAA;AACP,SAAK,CAAC;AACN,KAAG;AACH;mCAnCC,IAAA,EAAA,IAAA,EAAA,QAAQ,EAAC,IAAA,EAAA,CAAA,EACR,gBAAA,OAAO,EAAE;AACP,kBAAkB,CAAC,UAAU,CAAC,0BAC5B,kBAAkB,EAAE,CAAC;CAAqB,CAAC,uBAC5C,CAAC,EACH,iBAAA,EACF,aAAA,EAAA,EAAA;;;;;;;;;;;;;;;iKACA;AAAC;AC5PF;AACA;AACG;AAED;AAAC;AAEoP","sourcesContent":["import { Inject, Injectable, InjectionToken, ModuleWithProviders, NgModule, APP_INITIALIZER } from '@angular/core';\nimport { CommunicationDefinition, serializerDeserializer } from '@backbase/communication-property';\nimport { Observable } from 'rxjs';\nimport { first, map } from 'rxjs/operators';\n\nimport {\n  BackbaseCoreModule,\n  PipelineSink,\n  Sink,\n  PipelineProcessorConfig,\n  ӨItemNavigationService,\n  ӨRootContainerService,\n} from '@backbase/foundation-ang/core';\n\nexport function initIntents(intentBridgeService: IntentBridgeService) {\n  return intentBridgeService.handleIncomingIntent.bind(intentBridgeService);\n}\n\n/**\n * @deprecated Will be removed in v7.0.0\n * A WA2 compatible Intent\n *\n * This is the interoperable format that is supported by both sides of the communication\n */\nexport interface Intent<T extends object = object> {\n  /** The name of the Intent used to identify it */\n  name: string;\n  /** Any extra data associated with the intent that can be used by the receiving side */\n  parameters: T;\n}\n\n@Injectable()\nexport class IntentNavigation {\n  go(url: string) {\n    location.href = url;\n  }\n}\n\n@Injectable()\nexport class IntentStorage {\n  static STORE_KEY = 'lib-bb-intent:navigated-intent';\n\n  get(): Intent | undefined {\n    const storedIntent: string | undefined = sessionStorage.getItem(IntentStorage.STORE_KEY) || undefined;\n    if (storedIntent === undefined) {\n      return;\n    }\n    const intent: unknown = JSON.parse(storedIntent);\n    if (!isAnIntent(intent)) {\n      return;\n    }\n    return intent;\n  }\n\n  clear(): void {\n    sessionStorage.removeItem(IntentStorage.STORE_KEY);\n  }\n\n  set(intent: Intent): void {\n    sessionStorage.setItem(IntentStorage.STORE_KEY, JSON.stringify(intent));\n  }\n}\n\n// Incoming\n\nfunction isAnIntent(intent: unknown): intent is Intent {\n  if (typeof intent !== 'object' || intent === null) {\n    return false;\n  }\n  const assumedIntent = intent as Intent;\n  const hasName = typeof assumedIntent.name === 'string';\n  const hasParameters = typeof assumedIntent.parameters === 'object' && assumedIntent.parameters !== null;\n  return hasName && hasParameters;\n}\n\nfunction intentHandler<T extends Intent>(\n  guard: (intent: Intent) => intent is T,\n  handle: (t: T['parameters']) => Promise<void>,\n): (intent: Intent) => undefined | Promise<void> {\n  return intent => {\n    if (!guard(intent)) {\n      return undefined;\n    }\n    return handle(intent.parameters);\n  };\n}\n\n/**\n * @deprecated Will be removed in v7.0.0\n * Describe the mapping of an incoming Intent to a RouteParam communication\n */\nexport interface IncomingIntentMapping<I extends Intent> {\n  /**\n   * Determine if the incoming intent can be handled by this mapper\n   *\n   * This will likely involve checking the name of the intent and that any required parameters were sent\n   */\n  guard: (intent: I) => intent is I;\n  /**\n   * Extract the value from the Intents parameters to be passed to the RouteParam communication group\n   */\n  extract: (parameters: I['parameters']) => string;\n  /**\n   * The name of the communication group that is the target of the resulting RouteParam communication\n   */\n  group: string;\n}\n\nexport const INTENT_INCOMING_MAPPING = new InjectionToken('INTENT_INCOMING_MAPPING');\n\n@Injectable()\nexport class IntentBridgeService {\n  constructor(\n    private readonly rootModel: ӨRootContainerService,\n    private readonly itemNavigation: ӨItemNavigationService,\n    private readonly store: IntentStorage,\n    @Inject(INTENT_INCOMING_MAPPING) private readonly handlers: Array<IncomingIntentMapping<Intent<any>>>,\n  ) {}\n\n  private handleIntentFromStorage(handlers: Array<(intent: Intent) => undefined | Promise<void>>) {\n    const intent = this.store.get();\n    if (!intent) {\n      return;\n    }\n\n    for (const handle of handlers) {\n      const handling = handle(intent);\n      if (handling) {\n        this.store.clear();\n        return handling;\n      }\n    }\n    return;\n  }\n\n  handleIncomingIntent(): void {\n    this.handleIntentFromStorage(\n      this.handlers.map(({ guard, group, extract }) =>\n        intentHandler(guard, parameters => {\n          const params = { [group]: extract(parameters) };\n          return this.rootModel\n            .commonAncestor(new CommunicationDefinition('route-param', group))\n            .pipe(\n              first(),\n              map(commonAncestor => {\n                if (commonAncestor === undefined) {\n                  return console.warn('No Inputs configured to receive route param');\n                }\n                this.itemNavigation.navigateToItem(commonAncestor.name, params);\n              }),\n            )\n            .toPromise();\n        }),\n      ),\n    );\n  }\n}\n\n// Outgoing\n\nconst TAG = 'intent';\n\n/**\n * @deprecated Will be removed in v7.0.0\n * Intent Communication Transport\n *\n * Can be used in standalone development to configure communication using Intents.\n *\n * Note: This Transport does not currently support Input handling. Incoming Intents can be handled\n * by mapping them to a RouteParam by providing an `IncomingIntentMapping`\n */\nexport class IntentIO {\n  /**\n   * Generate a serialized communication configuration suitable for use as a Widget Output property value.\n   *\n   * @param group The name of the communication group to which the Output belongs\n   */\n  static toProperty(group: string): string {\n    return serializerDeserializer.toProperty(new CommunicationDefinition(TAG, group));\n  }\n}\n\nexport const INTENTS_OUTGOING_MAPPING = new InjectionToken('OutgoingIntentMapping');\n\n/**\n * @deprecated Will be removed in v7.0.0\n * Describe the mapping of an Output to an Intent\n */\nexport interface OutgoingIntentMapping<Output, I extends Intent> {\n  /** The name of the communication group targeted by the intent output */\n  group: string;\n  /** The URL on which the target is hosted */\n  targetUrl: string;\n  /** The name of the intent that will be created from the emitted output value */\n  intent: I['name'];\n  /** Create the intent parameters based on the emitted output value */\n  parameters: (output: Output) => I['parameters'];\n}\n\nexport class IntentPipeline<Output> implements PipelineSink<Output> {\n  constructor(\n    private readonly navigator: IntentNavigation,\n    private readonly storage: IntentStorage,\n    private readonly outgoingMappings: Array<OutgoingIntentMapping<Output, Intent>>,\n  ) {}\n\n  sink(group: string): Sink<Output> {\n    return (stdin: Observable<Output>): void => {\n      const creator = this.outgoingMappings.find(mapping => mapping.group === group);\n      if (!creator) {\n        return;\n      }\n      void stdin.subscribe((value: Output) => {\n        const parameters = creator.parameters(value);\n        const intent: Intent = {\n          name: creator.intent,\n          parameters,\n        };\n        this.storage.set(intent);\n        this.navigator.go(creator.targetUrl);\n      });\n    };\n  }\n}\n\nexport function createIntentPipeline<Output>(\n  navigator: IntentNavigation,\n  storage: IntentStorage,\n  creators: Array<OutgoingIntentMapping<Output, Intent>>,\n) {\n  return new IntentPipeline(navigator, storage, creators);\n}\n\nexport const intentProcessorConfig: PipelineProcessorConfig<'intent'> = {\n  name: TAG,\n  provider: {\n    provide: new InjectionToken('Intents pipeline handler'),\n    useFactory: createIntentPipeline,\n    deps: [IntentNavigation, IntentStorage, INTENTS_OUTGOING_MAPPING],\n  },\n};\n\n/**\n * @deprecated Will be removed in v7.0.0\n */\n@NgModule({\n  imports: [\n    BackbaseCoreModule.withConfig({\n      pipelineProcessors: [intentProcessorConfig],\n    }),\n  ],\n})\nexport class IntentsBridgeModule {\n  static forRoot(config: {\n    incoming: Array<IncomingIntentMapping<Intent<any>>>;\n    outgoing: Array<OutgoingIntentMapping<any, any>>;\n  }): ModuleWithProviders<IntentsBridgeModule> {\n    return {\n      ngModule: IntentsBridgeModule,\n      providers: [\n        {\n          provide: INTENTS_OUTGOING_MAPPING,\n          useValue: config.outgoing,\n        },\n        {\n          provide: INTENT_INCOMING_MAPPING,\n          useValue: config.incoming,\n        },\n        IntentBridgeService,\n        {\n          provide: APP_INITIALIZER,\n          useFactory: initIntents,\n          deps: [IntentBridgeService],\n          multi: true,\n        },\n        IntentStorage,\n        IntentNavigation,\n      ],\n    };\n  }\n}\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './public-api';\n\nexport {INTENTS_OUTGOING_MAPPING as ɵf,INTENT_INCOMING_MAPPING as ɵd,IntentBridgeService as ɵe,IntentNavigation as ɵb,IntentPipeline as ɵg,IntentStorage as ɵc,createIntentPipeline as ɵh,initIntents as ɵa,intentProcessorConfig as ɵi} from './intents';"]}