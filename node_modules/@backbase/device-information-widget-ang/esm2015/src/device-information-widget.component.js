import { Component, ViewChild, Input } from '@angular/core';
import { BehaviorSubject, Observable } from 'rxjs';
import { switchMap, first, tap, catchError } from 'rxjs/operators';
import { UserDeviceInformationService } from './services/user-device-information.service';
import { AdminDeviceInformationService } from './services/admin-device-information.service';
import { DeviceStatus, UpdateAction } from './models/device-management-types';
import { DeviceInformationPreferenceService } from './services/device-information-preference.service';
import * as i0 from "@angular/core";
import * as i1 from "./services/user-device-information.service";
import * as i2 from "./services/admin-device-information.service";
import * as i3 from "@backbase/ui-ang";
import * as i4 from "./services/device-information-preference.service";
import * as i5 from "./components/bb-device-information-ui/device-information.component";
import * as i6 from "@angular/common";
export class DeviceInformationWidgetComponent {
    constructor(userDataService, adminDataService, notificationService, preferenceService) {
        this.userDataService = userDataService;
        this.adminDataService = adminDataService;
        this.notificationService = notificationService;
        this.preferenceService = preferenceService;
        this.successHeader = '';
        this.successMessage = '';
        this.failureHeader = '';
        this.failureMessage = '';
        this.failurePermissionsMessage = '';
        this.updateActions = UpdateAction;
        this.refreshDevicesSubject = new BehaviorSubject(undefined);
        this.isLoadingSubject = new BehaviorSubject(false);
        this.isSavingSubject = new BehaviorSubject(false);
        this.errorSubject = new BehaviorSubject(undefined);
        this.dismissTimeout = 3000;
        this.isAdminWidget = false;
        this.isLoading = this.isLoadingSubject.asObservable();
        this.isSaving = this.isSavingSubject.asObservable();
        this.errorState = this.errorSubject.asObservable();
        this.devices = this.getDevicesObservable();
        this.onError = (err) => {
            this.notificationService.showNotification({
                header: this.failureHeader,
                message: this.getErrorMessage(err),
                messageContext: {
                    device: this.managedDevice,
                },
                modifier: 'error',
                ttl: this.dismissTimeout,
            });
            return new Observable();
        };
        this.onSuccess = () => {
            this.notificationService.showNotification({
                header: this.successHeader,
                headerContext: {
                    actionType: this.updateAction,
                },
                message: this.successMessage,
                messageContext: {
                    actionType: this.updateAction,
                    device: this.managedDevice,
                },
                modifier: 'success',
                ttl: this.dismissTimeout,
            });
            this.refreshDevicesSubject.next(undefined);
        };
    }
    set dbsUserId(inputUserId) {
        this.adminDataService.dbsUserIdInput = inputUserId;
    }
    /**
     * Sets the id for the user to get device information for.
     */
    get dbsUserId() {
        return this.adminDataService.dbsUserIdInput;
    }
    ngOnInit() {
        if (this.notificationDismissTime) {
            this.dismissTimeout = this.notificationDismissTime * 1000;
        }
        else {
            this.preferenceService
                .getTimeoutPreference()
                .pipe(first())
                .subscribe(time => (this.dismissTimeout = time * 1000));
        }
        if (typeof this.isAdmin === 'boolean') {
            this.isAdminWidget = this.isAdmin;
        }
        else {
            this.preferenceService
                .getAdminPreference()
                .pipe(first())
                .subscribe(adminPreference => (this.isAdminWidget = adminPreference));
        }
    }
    getFriendlyName(defaultValue, modifiedDevice) {
        const device = modifiedDevice || this.managedDevice;
        return device && device.friendlyName ? `'${device.friendlyName}'` : defaultValue;
    }
    getOldFriendlyName(defaultValue, modifiedDevice) {
        const device = modifiedDevice || this.managedDevice;
        return device && device.oldFriendlyName ? `'${device.oldFriendlyName}'` : defaultValue;
    }
    onSave(device) {
        this.isSavingSubject.next(true);
        this.updateAction = UpdateAction.Save;
        this.managedDevice = device;
        this.dataService
            .updateDevice(device.deviceId, {
            friendlyName: device.friendlyName,
        })
            .pipe(tap(() => this.isSavingSubject.next(false)), catchError((err) => {
            this.isSavingSubject.next(false);
            return this.onError(err);
        }))
            .subscribe(this.onSuccess);
    }
    onRemove(device) {
        this.updateAction = UpdateAction.Remove;
        this.managedDevice = device;
        this.dataService
            .removeDevice(device.deviceId)
            .pipe(catchError(this.onError))
            .subscribe(this.onSuccess);
    }
    onSuspend(device) {
        this.updateAction = UpdateAction.Suspend;
        this.managedDevice = device;
        this.updateDevice(device, DeviceStatus.DISABLED);
    }
    onRestore(device) {
        this.updateAction = UpdateAction.Restore;
        this.managedDevice = device;
        this.updateDevice(device, DeviceStatus.ENABLED);
    }
    getDevicesObservable() {
        return this.refreshDevicesSubject.pipe(switchMap(() => {
            this.errorSubject.next(undefined);
            this.isLoadingSubject.next(true);
            return this.dataService.getDevices();
        }), tap(() => {
            this.isLoadingSubject.next(false);
        }), catchError(error => {
            this.isLoadingSubject.next(false);
            this.errorSubject.next(error);
            return new Observable();
        }));
    }
    updateDevice(device, action) {
        this.dataService
            .updateDevice(device.deviceId, {
            status: action,
        })
            .pipe(catchError(this.onError))
            .subscribe(this.onSuccess);
    }
    getErrorMessage(error) {
        return (error.status === 403 ? this.failurePermissionsMessage : this.failureMessage);
    }
    get dataService() {
        return this.isAdminWidget ? this.adminDataService : this.userDataService;
    }
}
DeviceInformationWidgetComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.15", ngImport: i0, type: DeviceInformationWidgetComponent, deps: [{ token: i1.UserDeviceInformationService }, { token: i2.AdminDeviceInformationService }, { token: i3.NotificationService }, { token: i4.DeviceInformationPreferenceService }], target: i0.ɵɵFactoryTarget.Component });
DeviceInformationWidgetComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "12.0.0", version: "12.2.15", type: DeviceInformationWidgetComponent, selector: "bb-device-information-widget", inputs: { notificationDismissTime: ["dismissTimeout", "notificationDismissTime"], isAdmin: ["isAdminWidget", "isAdmin"], dbsUserId: "dbsUserId" }, providers: [DeviceInformationPreferenceService, UserDeviceInformationService, AdminDeviceInformationService], viewQueries: [{ propertyName: "successHeader", first: true, predicate: ["notificationSuccessHeader"], descendants: true }, { propertyName: "successMessage", first: true, predicate: ["notificationSuccessMessage"], descendants: true }, { propertyName: "failureHeader", first: true, predicate: ["notificationFailureHeader"], descendants: true }, { propertyName: "failureMessage", first: true, predicate: ["notificationFailureMessage"], descendants: true }, { propertyName: "failurePermissionsMessage", first: true, predicate: ["notificationPermissionsFailureMessage"], descendants: true }], ngImport: i0, template: "<bb-device-information-ui\n  [devices]=\"devices | async\"\n  [isLoading]=\"isLoading | async\"\n  [isSaving]=\"isSaving | async\"\n  [errorState]=\"errorState | async\"\n  (save)=\"onSave($event)\"\n  (remove)=\"onRemove($event)\"\n  (suspend)=\"onSuspend($event)\"\n  (restore)=\"onRestore($event)\"\n></bb-device-information-ui>\n\n<ng-template #notificationSuccessHeader let-actionType=\"actionType\">\n  <ng-container [ngSwitch]=\"actionType\">\n    <div *ngSwitchCase=\"updateActions.Restore\"\n      data-role=\"notification-header-restored\"\n      i18n=\"Notification restored header@@bb-device-information-widget.notification.header.restored\">\n      Device restored\n    </div>\n    <div *ngSwitchCase=\"updateActions.Suspend\" \n      data-role=\"notification-header-suspended\"\n      i18n=\"Notification suspended header@@bb-device-information-widget.notification.header.suspended\">\n      Device suspended\n    </div>\n    <div *ngSwitchCase=\"updateActions.Remove\"\n      data-role=\"notification-header-removed\"\n      i18n=\"Notification removed header@@bb-device-information-widget.notification.header.removed\">\n      Device removed\n    </div>\n    <div *ngSwitchCase=\"updateActions.Save\"\n      data-role=\"notification-header-saved\"\n      i18n=\"Notification saved header@@bb-device-information-widget.notification.header.saved\">\n      Device name changed\n    </div>\n  </ng-container>\n</ng-template>\n\n<ng-template #notificationSuccessMessage let-actionType=\"actionType\" let-device=\"device\">\n  <ng-container [ngSwitch]=\"actionType\">\n    <div *ngSwitchCase=\"updateActions.Restore\"\n      i18n=\"Notification restored message@@bb-device-information-widget.notification.message.restored\">\n      {{ getFriendlyName('Device', device) }} restored successfully.\n    </div>\n    <div *ngSwitchCase=\"updateActions.Suspend\"\n      i18n=\"Notification suspended message@@bb-device-information-widget.notification.message.suspended\">\n      {{ getFriendlyName('Device', device) }} suspended successfully.\n    </div>\n    <div *ngSwitchCase=\"updateActions.Remove\"\n      i18n=\"Notification removed message@@bb-device-information-widget.notification.message.removed\">\n      {{ getFriendlyName('Device', device) }} removed successfully.\n    </div>\n    <div *ngSwitchCase=\"updateActions.Save\"\n      i18n=\"Notification saved message@@bb-device-information-widget.notification.message.saved\">\n      {{ getFriendlyName('Device', device) }} name changed successfully.\n    </div>\n  </ng-container>\n</ng-template>\n\n<ng-template #notificationFailureHeader>\n  <div data-role=\"notification-header-failed\" i18n=\"Failure notification header@@bb-device-information-widget.notification.failure.header\">\n    Device update failed\n  </div>\n</ng-template>\n\n<ng-template #notificationFailureMessage let-device=\"device\">\n  <div i18n=\"Failure notification message@@bb-device-information-widget.notification.failure.message\">\n    Failed to update {{ getOldFriendlyName('device', device) }}.\n  </div>\n</ng-template>\n\n<ng-template #notificationPermissionsFailureMessage let-device=\"device\">\n  <div i18n=\"Permission failure notification message@@bb-device-information-widget.notification.permissions.failure.message\">\n    Insufficient permissions to update {{ getOldFriendlyName('device', device) }}.\n  </div>\n</ng-template>", components: [{ type: i5.DeviceInformationComponent, selector: "bb-device-information-ui", inputs: ["isSaving", "devices", "isLoading", "errorState"], outputs: ["save", "remove", "suspend", "restore"] }], directives: [{ type: i6.NgSwitch, selector: "[ngSwitch]", inputs: ["ngSwitch"] }, { type: i6.NgSwitchCase, selector: "[ngSwitchCase]", inputs: ["ngSwitchCase"] }], pipes: { "async": i6.AsyncPipe } });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.15", ngImport: i0, type: DeviceInformationWidgetComponent, decorators: [{
            type: Component,
            args: [{
                    selector: 'bb-device-information-widget',
                    templateUrl: './device-information-widget.component.html',
                    providers: [DeviceInformationPreferenceService, UserDeviceInformationService, AdminDeviceInformationService],
                }]
        }], ctorParameters: function () { return [{ type: i1.UserDeviceInformationService }, { type: i2.AdminDeviceInformationService }, { type: i3.NotificationService }, { type: i4.DeviceInformationPreferenceService }]; }, propDecorators: { successHeader: [{
                type: ViewChild,
                args: ['notificationSuccessHeader']
            }], successMessage: [{
                type: ViewChild,
                args: ['notificationSuccessMessage']
            }], failureHeader: [{
                type: ViewChild,
                args: ['notificationFailureHeader']
            }], failureMessage: [{
                type: ViewChild,
                args: ['notificationFailureMessage']
            }], failurePermissionsMessage: [{
                type: ViewChild,
                args: ['notificationPermissionsFailureMessage']
            }], notificationDismissTime: [{
                type: Input,
                args: ['dismissTimeout']
            }], isAdmin: [{
                type: Input,
                args: ['isAdminWidget']
            }], dbsUserId: [{
                type: Input
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGV2aWNlLWluZm9ybWF0aW9uLXdpZGdldC5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9saWJzL2RldmljZS1pbmZvcm1hdGlvbi13aWRnZXQvc3JjL2RldmljZS1pbmZvcm1hdGlvbi13aWRnZXQuY29tcG9uZW50LnRzIiwiLi4vLi4vLi4vLi4vLi4vbGlicy9kZXZpY2UtaW5mb3JtYXRpb24td2lkZ2V0L3NyYy9kZXZpY2UtaW5mb3JtYXRpb24td2lkZ2V0LmNvbXBvbmVudC5odG1sIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxTQUFTLEVBQWUsU0FBUyxFQUFVLEtBQUssRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNqRixPQUFPLEVBQUUsZUFBZSxFQUFFLFVBQVUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNuRCxPQUFPLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsVUFBVSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDbkUsT0FBTyxFQUFFLDRCQUE0QixFQUFFLE1BQU0sNENBQTRDLENBQUM7QUFDMUYsT0FBTyxFQUFFLDZCQUE2QixFQUFFLE1BQU0sNkNBQTZDLENBQUM7QUFDNUYsT0FBTyxFQUFVLFlBQVksRUFBRSxZQUFZLEVBQWtCLE1BQU0sa0NBQWtDLENBQUM7QUFFdEcsT0FBTyxFQUFFLGtDQUFrQyxFQUFFLE1BQU0sa0RBQWtELENBQUM7Ozs7Ozs7O0FBT3RHLE1BQU0sT0FBTyxnQ0FBZ0M7SUE2QzNDLFlBQ21CLGVBQTZDLEVBQzdDLGdCQUErQyxFQUMvQyxtQkFBd0MsRUFDeEMsaUJBQXFEO1FBSHJELG9CQUFlLEdBQWYsZUFBZSxDQUE4QjtRQUM3QyxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQStCO1FBQy9DLHdCQUFtQixHQUFuQixtQkFBbUIsQ0FBcUI7UUFDeEMsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUFvQztRQWhEaEMsa0JBQWEsR0FBOEIs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QUFDO0lBRUQsSUFBWSxXQUFXO1FBQ3JCLE9BQU8sSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDO0lBQzNFLENBQUM7OzhIQXpMVSxnQ0FBZ0M7a0hBQWhDLGdDQUFnQywwTUFGaEMsQ0FBQyxrQ0FBa0MsRUFBRSw0QkFBNEIsRUFBRSw2QkFBNkIsQ0FBQyxzbUJDYjlHLDJ6R0F5RWM7NEZEMURELGdDQUFnQztrQkFMNUMsU0FBUzttQkFBQztvQkFDVCxRQUFRLEVBQUUsOEJBQThCO29CQUN4QyxXQUFXLEVBQUUsNENBQTRDO29CQUN6RCxTQUFTLEVBQUUsQ0FBQyxrQ0FBa0MsRUFBRSw0QkFBNEIsRUFBRSw2QkFBNkIsQ0FBQztpQkFDN0c7a1BBRXlDLGFBQWE7c0JBQXBELFNBQVM7dUJBQUMsMkJBQTJCO2dCQUNHLGNBQWM7c0JBQXRELFNBQVM7dUJBQUMsNEJBQTRCO2dCQUNDLGFBQWE7c0JBQXBELFNBQVM7dUJBQUMsMkJBQTJCO2dCQUNHLGNBQWM7c0JBQXRELFNBQVM7dUJBQUMsNEJBQTRCO2dCQUNhLHlCQUF5QjtzQkFBNUUsU0FBUzt1QkFBQyx1Q0FBdUM7Z0JBTXpCLHVCQUF1QjtzQkFBL0MsS0FBSzt1QkFBQyxnQkFBZ0I7Z0JBTUMsT0FBTztzQkFBOUIsS0FBSzt1QkFBQyxlQUFlO2dCQUdsQixTQUFTO3NCQURaLEtBQUsiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBIdHRwRXJyb3JSZXNwb25zZSB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7IENvbXBvbmVudCwgVGVtcGxhdGVSZWYsIFZpZXdDaGlsZCwgT25Jbml0LCBJbnB1dCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0LCBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBzd2l0Y2hNYXAsIGZpcnN0LCB0YXAsIGNhdGNoRXJyb3IgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBVc2VyRGV2aWNlSW5mb3JtYXRpb25TZXJ2aWNlIH0gZnJvbSAnLi9zZXJ2aWNlcy91c2VyLWRldmljZS1pbmZvcm1hdGlvbi5zZXJ2aWNlJztcbmltcG9ydCB7IEFkbWluRGV2aWNlSW5mb3JtYXRpb25TZXJ2aWNlIH0gZnJvbSAnLi9zZXJ2aWNlcy9hZG1pbi1kZXZpY2UtaW5mb3JtYXRpb24uc2VydmljZSc7XG5pbXBvcnQgeyBEZXZpY2UsIERldmljZVN0YXR1cywgVXBkYXRlQWN0aW9uLCBNb2RpZmllZERldmljZSB9IGZyb20gJy4vbW9kZWxzL2RldmljZS1tYW5hZ2VtZW50LXR5cGVzJztcbmltcG9ydCB7IE5vdGlmaWNhdGlvblNlcnZpY2UgfSBmcm9tICdAYmFja2Jhc2UvdWktYW5nJztcbmltcG9ydCB7IERldmljZUluZm9ybWF0aW9uUHJlZmVyZW5jZVNlcnZpY2UgfSBmcm9tICcuL3NlcnZpY2VzL2RldmljZS1pbmZvcm1hdGlvbi1wcmVmZXJlbmNlLnNlcnZpY2UnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdiYi1kZXZpY2UtaW5mb3JtYXRpb24td2lkZ2V0JyxcbiAgdGVtcGxhdGVVcmw6ICcuL2RldmljZS1pbmZvcm1hdGlvbi13aWRnZXQuY29tcG9uZW50Lmh0bWwnLFxuICBwcm92aWRlcnM6IFtEZXZpY2VJbmZvcm1hdGlvblByZWZlcmVuY2VTZXJ2aWNlLCBVc2VyRGV2aWNlSW5mb3JtYXRpb25TZXJ2aWNlLCBBZG1pbkRldmljZUluZm9ybWF0aW9uU2VydmljZV0sXG59KVxuZXhwb3J0IGNsYXNzIERldmljZUluZm9ybWF0aW9uV2lkZ2V0Q29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0IHtcbiAgQFZpZXdDaGlsZCgnbm90aWZpY2F0aW9uU3VjY2Vzc0hlYWRlcicpIHN1Y2Nlc3NIZWFkZXI6IFRlbXBsYXRlUmVmPGFueT4gfCBzdHJpbmcgPSAnJztcbiAgQFZpZXdDaGlsZCgnbm90aWZpY2F0aW9uU3VjY2Vzc01lc3NhZ2UnKSBzdWNjZXNzTWVzc2FnZTogVGVtcGxhdGVSZWY8YW55PiB8IHN0cmluZyA9ICcnO1xuICBAVmlld0NoaWxkKCdub3RpZmljYXRpb25GYWlsdXJlSGVhZGVyJykgZmFpbHVyZUhlYWRlcjogVGVtcGxhdGVSZWY8YW55PiB8IHN0cmluZyA9ICcnO1xuICBAVmlld0NoaWxkKCdub3RpZmljYXRpb25GYWlsdXJlTWVzc2FnZScpIGZhaWx1cmVNZXNzYWdlOiBUZW1wbGF0ZVJlZjxhbnk+IHwgc3RyaW5nID0gJyc7XG4gIEBWaWV3Q2hpbGQoJ25vdGlmaWNhdGlvblBlcm1pc3Npb25zRmFpbHVyZU1lc3NhZ2UnKSBmYWlsdXJlUGVybWlzc2lvbnNNZXNzYWdlOiBUZW1wbGF0ZVJlZjxhbnk+IHwgc3RyaW5nID0gJyc7XG5cbiAgLyoqXG4gICAqIFRpbWUgdG8gbGl2ZSBmb3IgdGhlIHN1Y2Nlc3Mgbm90aWZpY2F0aW9uIG1lc3NhZ2UgaW4gc2Vjb25kc1xuICAgKi9cbiAgLyogdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWlucHV0LXJlbmFtZSAqL1xuICBASW5wdXQoJ2Rpc21pc3NUaW1lb3V0Jykgbm90aWZpY2F0aW9uRGlzbWlzc1RpbWU6IG51bWJlciB8IHVuZGVmaW5lZDtcblxuICAvKipcbiAgICogU2V0IHRoZSB1c2VyIHR5cGUgb2YgdGhlIHdpZGdldCB0byBjaGFuZ2UgaXQncyBiZWhhdmlvdXJcbiAgICovXG4gIC8qIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1pbnB1dC1yZW5hbWUgKi9cbiAgQElucHV0KCdpc0FkbWluV2lkZ2V0JykgaXNBZG1pbjogYm9vbGVhbiB8IHVuZGVmaW5lZDtcblxuICBASW5wdXQoKVxuICBzZXQgZGJzVXNlcklkKGlucHV0VXNlcklkOiBzdHJpbmcpIHtcbiAgICB0aGlzLmFkbWluRGF0YVNlcnZpY2UuZGJzVXNlcklkSW5wdXQgPSBpbnB1dFVzZXJJZDtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXRzIHRoZSBpZCBmb3IgdGhlIHVzZXIgdG8gZ2V0IGRldmljZSBpbmZvcm1hdGlvbiBmb3IuXG4gICAqL1xuICBnZXQgZGJzVXNlcklkKCkge1xuICAgIHJldHVybiB0aGlzLmFkbWluRGF0YVNlcnZpY2UuZGJzVXNlcklkSW5wdXQ7XG4gIH1cblxuICB1cGRhdGVBY3Rpb25zID0gVXBkYXRlQWN0aW9uO1xuICB1cGRhdGVBY3Rpb246IFVwZGF0ZUFjdGlvbiB8IHVuZGVmaW5lZDtcbiAgcHJpdmF0ZSBtYW5hZ2VkRGV2aWNlOiBNb2RpZmllZERldmljZSB8IHVuZGVmaW5lZDtcbiAgcHJpdmF0ZSByZWFkb25seSByZWZyZXNoRGV2aWNlc1N1YmplY3QgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PHZvaWQ+KHVuZGVmaW5lZCk7XG4gIHByaXZhdGUgcmVhZG9ubHkgaXNMb2FkaW5nU3ViamVjdCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8Ym9vbGVhbj4oZmFsc2UpO1xuICBwcml2YXRlIHJlYWRvbmx5IGlzU2F2aW5nU3ViamVjdCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8Ym9vbGVhbj4oZmFsc2UpO1xuICBwcml2YXRlIHJlYWRvbmx5IGVycm9yU3ViamVjdCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8RXJyb3IgfCB1bmRlZmluZWQ+KHVuZGVmaW5lZCk7XG4gIHByaXZhdGUgZGlzbWlzc1RpbWVvdXQgPSAzMDAwO1xuICBwcml2YXRlIGlzQWRtaW5XaWRnZXQgPSBmYWxzZTtcbiAgcmVhZG9ubHkgaXNMb2FkaW5nID0gdGhpcy5pc0xvYWRpbmdTdWJqZWN0LmFzT2JzZXJ2YWJsZSgpO1xuICByZWFkb25seSBpc1NhdmluZyA9IHRoaXMuaXNTYXZpbmdTdWJqZWN0LmFzT2JzZXJ2YWJsZSgpO1xuICByZWFkb25seSBlcnJvclN0YXRlID0gdGhpcy5lcnJvclN1YmplY3QuYXNPYnNlcnZhYmxlKCk7XG4gIHJlYWRvbmx5IGRldmljZXMgPSB0aGlzLmdldERldmljZXNPYnNlcnZhYmxlKCk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSB1c2VyRGF0YVNlcnZpY2U6IFVzZXJEZXZpY2VJbmZvcm1hdGlvblNlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSBhZG1pbkRhdGFTZXJ2aWNlOiBBZG1pbkRldmljZUluZm9ybWF0aW9uU2VydmljZSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IG5vdGlmaWNhdGlvblNlcnZpY2U6IE5vdGlmaWNhdGlvblNlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSBwcmVmZXJlbmNlU2VydmljZTogRGV2aWNlSW5mb3JtYXRpb25QcmVmZXJlbmNlU2VydmljZSxcbiAgKSB7fVxuXG4gIG5nT25Jbml0KCk6IHZvaWQge1xuICAgIGlmICh0aGlzLm5vdGlmaWNhdGlvbkRpc21pc3NUaW1lKSB7XG4gICAgICB0aGlzLmRpc21pc3NUaW1lb3V0ID0gdGhpcy5ub3RpZmljYXRpb25EaXNtaXNzVGltZSAqIDEwMDA7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMucHJlZmVyZW5jZVNlcnZpY2VcbiAgICAgICAgLmdldFRpbWVvdXRQcmVmZXJlbmNlKClcbiAgICAgICAgLnBpcGUoZmlyc3QoKSlcbiAgICAgICAgLnN1YnNjcmliZSh0aW1lID0+ICh0aGlzLmRpc21pc3NUaW1lb3V0ID0gdGltZSAqIDEwMDApKTtcbiAgICB9XG5cbiAgICBpZiAodHlwZW9mIHRoaXMuaXNBZG1pbiA9PT0gJ2Jvb2xlYW4nKSB7XG4gICAgICB0aGlzLmlzQWRtaW5XaWRnZXQgPSB0aGlzLmlzQWRtaW47XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMucHJlZmVyZW5jZVNlcnZpY2VcbiAgICAgICAgLmdldEFkbWluUHJlZmVyZW5jZSgpXG4gICAgICAgIC5waXBlKGZpcnN0KCkpXG4gICAgICAgIC5zdWJzY3JpYmUoYWRtaW5QcmVmZXJlbmNlID0+ICh0aGlzLmlzQWRtaW5XaWRnZXQgPSBhZG1pblByZWZlcmVuY2UpKTtcbiAgICB9XG4gIH1cblxuICBnZXRGcmllbmRseU5hbWUoZGVmYXVsdFZhbHVlOiBzdHJpbmcsIG1vZGlmaWVkRGV2aWNlPzogTW9kaWZpZWREZXZpY2UpIHtcbiAgICBjb25zdCBkZXZpY2UgPSBtb2RpZmllZERldmljZSB8fCB0aGlzLm1hbmFnZWREZXZpY2U7XG4gICAgcmV0dXJuIGRldmljZSAmJiBkZXZpY2UuZnJpZW5kbHlOYW1lID8gYCcke2RldmljZS5mcmllbmRseU5hbWV9J2AgOiBkZWZhdWx0VmFsdWU7XG4gIH1cblxuICBnZXRPbGRGcmllbmRseU5hbWUoZGVmYXVsdFZhbHVlOiBzdHJpbmcsIG1vZGlmaWVkRGV2aWNlPzogTW9kaWZpZWREZXZpY2UpIHtcbiAgICBjb25zdCBkZXZpY2UgPSBtb2RpZmllZERldmljZSB8fCB0aGlzLm1hbmFnZWREZXZpY2U7XG4gICAgcmV0dXJuIGRldmljZSAmJiBkZXZpY2Uub2xkRnJpZW5kbHlOYW1lID8gYCcke2RldmljZS5vbGRGcmllbmRseU5hbWV9J2AgOiBkZWZhdWx0VmFsdWU7XG4gIH1cblxuICBvblNhdmUoZGV2aWNlOiBNb2RpZmllZERldmljZSkge1xuICAgIHRoaXMuaXNTYXZpbmdTdWJqZWN0Lm5leHQodHJ1ZSk7XG4gICAgdGhpcy51cGRhdGVBY3Rpb24gPSBVcGRhdGVBY3Rpb24uU2F2ZTtcbiAgICB0aGlzLm1hbmFnZWREZXZpY2UgPSBkZXZpY2U7XG5cbiAgICB0aGlzLmRhdGFTZXJ2aWNlXG4gICAgICAudXBkYXRlRGV2aWNlKGRldmljZS5kZXZpY2VJZCwge1xuICAgICAgICBmcmllbmRseU5hbWU6IGRldmljZS5mcmllbmRseU5hbWUsXG4gICAgICB9KVxuICAgICAgLnBpcGUoXG4gICAgICAgIHRhcCgoKSA9PiB0aGlzLmlzU2F2aW5nU3ViamVjdC5uZXh0KGZhbHNlKSksXG4gICAgICAgIGNhdGNoRXJyb3IoKGVycjogSHR0cEVycm9yUmVzcG9uc2UpID0+IHtcbiAgICAgICAgICB0aGlzLmlzU2F2aW5nU3ViamVjdC5uZXh0KGZhbHNlKTtcbiAgICAgICAgICByZXR1cm4gdGhpcy5vbkVycm9yKGVycik7XG4gICAgICAgIH0pLFxuICAgICAgKVxuICAgICAgLnN1YnNjcmliZSh0aGlzLm9uU3VjY2Vzcyk7XG4gIH1cblxuICBvblJlbW92ZShkZXZpY2U6IERldmljZSkge1xuICAgIHRoaXMudXBkYXRlQWN0aW9uID0gVXBkYXRlQWN0aW9uLlJlbW92ZTtcbiAgICB0aGlzLm1hbmFnZWREZXZpY2UgPSBkZXZpY2U7XG4gICAgdGhpcy5kYXRhU2VydmljZVxuICAgICAgLnJlbW92ZURldmljZShkZXZpY2UuZGV2aWNlSWQpXG4gICAgICAucGlwZShjYXRjaEVycm9yKHRoaXMub25FcnJvcikpXG4gICAgICAuc3Vic2NyaWJlKHRoaXMub25TdWNjZXNzKTtcbiAgfVxuXG4gIG9uU3VzcGVuZChkZXZpY2U6IERldmljZSkge1xuICAgIHRoaXMudXBkYXRlQWN0aW9uID0gVXBkYXRlQWN0aW9uLlN1c3BlbmQ7XG4gICAgdGhpcy5tYW5hZ2VkRGV2aWNlID0gZGV2aWNlO1xuICAgIHRoaXMudXBkYXRlRGV2aWNlKGRldmljZSwgRGV2aWNlU3RhdHVzLkRJU0FCTEVEKTtcbiAgfVxuXG4gIG9uUmVzdG9yZShkZXZpY2U6IERldmljZSkge1xuICAgIHRoaXMudXBkYXRlQWN0aW9uID0gVXBkYXRlQWN0aW9uLlJlc3RvcmU7XG4gICAgdGhpcy5tYW5hZ2VkRGV2aWNlID0gZGV2aWNlO1xuICAgIHRoaXMudXBkYXRlRGV2aWNlKGRldmljZSwgRGV2aWNlU3RhdHVzLkVOQUJMRUQpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXREZXZpY2VzT2JzZXJ2YWJsZSgpIHtcbiAgICByZXR1cm4gdGhpcy5yZWZyZXNoRGV2aWNlc1N1YmplY3QucGlwZShcbiAgICAgIHN3aXRjaE1hcCgoKSA9PiB7XG4gICAgICAgIHRoaXMuZXJyb3JTdWJqZWN0Lm5leHQodW5kZWZpbmVkKTtcbiAgICAgICAgdGhpcy5pc0xvYWRpbmdTdWJqZWN0Lm5leHQodHJ1ZSk7XG4gICAgICAgIHJldHVybiB0aGlzLmRhdGFTZXJ2aWNlLmdldERldmljZXMoKTtcbiAgICAgIH0pLFxuICAgICAgdGFwKCgpID0+IHtcbiAgICAgICAgdGhpcy5pc0xvYWRpbmdTdWJqZWN0Lm5leHQoZmFsc2UpO1xuICAgICAgfSksXG4gICAgICBjYXRjaEVycm9yKGVycm9yID0+IHtcbiAgICAgICAgdGhpcy5pc0xvYWRpbmdTdWJqZWN0Lm5leHQoZmFsc2UpO1xuICAgICAgICB0aGlzLmVycm9yU3ViamVjdC5uZXh0KGVycm9yKTtcbiAgICAgICAgcmV0dXJuIG5ldyBPYnNlcnZhYmxlKCk7XG4gICAgICB9KSxcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVEZXZpY2UoZGV2aWNlOiBEZXZpY2UsIGFjdGlvbjogRGV2aWNlU3RhdHVzKSB7XG4gICAgdGhpcy5kYXRhU2VydmljZVxuICAgICAgLnVwZGF0ZURldmljZShkZXZpY2UuZGV2aWNlSWQsIHtcbiAgICAgICAgc3RhdHVzOiBhY3Rpb24sXG4gICAgICB9KVxuICAgICAgLnBpcGUoY2F0Y2hFcnJvcih0aGlzLm9uRXJyb3IpKVxuICAgICAgLnN1YnNjcmliZSh0aGlzLm9uU3VjY2Vzcyk7XG4gIH1cblxuICBwcml2YXRlIHJlYWRvbmx5IG9uRXJyb3IgPSAoZXJyOiBIdHRwRXJyb3JSZXNwb25zZSkgPT4ge1xuICAgIHRoaXMubm90aWZpY2F0aW9uU2VydmljZS5zaG93Tm90aWZpY2F0aW9uKHtcbiAgICAgIGhlYWRlcjogdGhpcy5mYWlsdXJlSGVhZGVyLFxuICAgICAgbWVzc2FnZTogdGhpcy5nZXRFcnJvck1lc3NhZ2UoZXJyKSxcbiAgICAgIG1lc3NhZ2VDb250ZXh0OiB7XG4gICAgICAgIGRldmljZTogdGhpcy5tYW5hZ2VkRGV2aWNlLFxuICAgICAgfSxcbiAgICAgIG1vZGlmaWVyOiAnZXJyb3InLFxuICAgICAgdHRsOiB0aGlzLmRpc21pc3NUaW1lb3V0LFxuICAgIH0pO1xuICAgIHJldHVybiBuZXcgT2JzZXJ2YWJsZSgpO1xuICB9O1xuXG4gIHByaXZhdGUgcmVhZG9ubHkgb25TdWNjZXNzID0gKCkgPT4ge1xuICAgIHRoaXMubm90aWZpY2F0aW9uU2VydmljZS5zaG93Tm90aWZpY2F0aW9uKHtcbiAgICAgIGhlYWRlcjogdGhpcy5zdWNjZXNzSGVhZGVyLFxuICAgICAgaGVhZGVyQ29udGV4dDoge1xuICAgICAgICBhY3Rpb25UeXBlOiB0aGlzLnVwZGF0ZUFjdGlvbixcbiAgICAgIH0sXG4gICAgICBtZXNzYWdlOiB0aGlzLnN1Y2Nlc3NNZXNzYWdlIGFzIFRlbXBsYXRlUmVmPGFueT4sXG4gICAgICBtZXNzYWdlQ29udGV4dDoge1xuICAgICAgICBhY3Rpb25UeXBlOiB0aGlzLnVwZGF0ZUFjdGlvbixcbiAgICAgICAgZGV2aWNlOiB0aGlzLm1hbmFnZWREZXZpY2UsXG4gICAgICB9LFxuICAgICAgbW9kaWZpZXI6ICdzdWNjZXNzJyxcbiAgICAgIHR0bDogdGhpcy5kaXNtaXNzVGltZW91dCxcbiAgICB9KTtcbiAgICB0aGlzLnJlZnJlc2hEZXZpY2VzU3ViamVjdC5uZXh0KHVuZGVmaW5lZCk7XG4gIH07XG5cbiAgcHJpdmF0ZSBnZXRFcnJvck1lc3NhZ2UoZXJyb3I6IEh0dHBFcnJvclJlc3BvbnNlKSB7XG4gICAgcmV0dXJuIChlcnJvci5zdGF0dXMgPT09IDQwMyA/IHRoaXMuZmFpbHVyZVBlcm1pc3Npb25zTWVzc2FnZSA6IHRoaXMuZmFpbHVyZU1lc3NhZ2UpIGFzIFRlbXBsYXRlUmVmPGFueT47XG4gIH1cblxuICBwcml2YXRlIGdldCBkYXRhU2VydmljZSgpOiBBZG1pbkRldmljZUluZm9ybWF0aW9uU2VydmljZSB8IFVzZXJEZXZpY2VJbmZvcm1hdGlvblNlcnZpY2Uge1xuICAgIHJldHVybiB0aGlzLmlzQWRtaW5XaWRnZXQgPyB0aGlzLmFkbWluRGF0YVNlcnZpY2UgOiB0aGlzLnVzZXJEYXRhU2VydmljZTtcbiAgfVxufVxuIiwiPGJiLWRldmljZS1pbmZvcm1hdGlvbi11aVxuICBbZGV2aWNlc109XCJkZXZpY2VzIHwgYXN5bmNcIlxuICBbaXNMb2FkaW5nXT1cImlzTG9hZGluZyB8IGFzeW5jXCJcbiAgW2lzU2F2aW5nXT1cImlzU2F2aW5nIHwgYXN5bmNcIlxuICBbZXJyb3JTdGF0ZV09XCJlcnJvclN0YXRlIHwgYXN5bmNcIlxuICAoc2F2ZSk9XCJvblNhdmUoJGV2ZW50KVwiXG4gIChyZW1vdmUpPVwib25SZW1vdmUoJGV2ZW50KVwiXG4gIChzdXNwZW5kKT1cIm9uU3VzcGVuZCgkZXZlbnQpXCJcbiAgKHJlc3RvcmUpPVwib25SZXN0b3JlKCRldmVudClcIlxuPjwvYmItZGV2aWNlLWluZm9ybWF0aW9uLXVpPlxuXG48bmctdGVtcGxhdGUgI25vdGlmaWNhdGlvblN1Y2Nlc3NIZWFkZXIgbGV0LWFjdGlvblR5cGU9XCJhY3Rpb25UeXBlXCI+XG4gIDxuZy1jb250YWluZXIgW25nU3dpdGNoXT1cImFjdGlvblR5cGVcIj5cbiAgICA8ZGl2ICpuZ1N3aXRjaENhc2U9XCJ1cGRhdGVBY3Rpb25zLlJlc3RvcmVcIlxuICAgICAgZGF0YS1yb2xlPVwibm90aWZpY2F0aW9uLWhlYWRlci1yZXN0b3JlZFwiXG4gICAgICBpMThuPVwiTm90aWZpY2F0aW9uIHJlc3RvcmVkIGhlYWRlckBAYmItZGV2aWNlLWluZm9ybWF0aW9uLXdpZGdldC5ub3RpZmljYXRpb24uaGVhZGVyLnJlc3RvcmVkXCI+XG4gICAgICBEZXZpY2UgcmVzdG9yZWRcbiAgICA8L2Rpdj5cbiAgICA8ZGl2ICpuZ1N3aXRjaENhc2U9XCJ1cGRhdGVBY3Rpb25zLlN1c3BlbmRcIiBcbiAgICAgIGRhdGEtcm9sZT1cIm5vdGlmaWNhdGlvbi1oZWFkZXItc3VzcGVuZGVkXCJcbiAgICAgIGkxOG49XCJOb3RpZmljYXRpb24gc3VzcGVuZGVkIGhlYWRlckBAYmItZGV2aWNlLWluZm9ybWF0aW9uLXdpZGdldC5ub3RpZmljYXRpb24uaGVhZGVyLnN1c3BlbmRlZFwiPlxuICAgICAgRGV2aWNlIHN1c3BlbmRlZFxuICAgIDwvZGl2PlxuICAgIDxkaXYgKm5nU3dpdGNoQ2FzZT1cInVwZGF0ZUFjdGlvbnMuUmVtb3ZlXCJcbiAgICAgIGRhdGEtcm9sZT1cIm5vdGlmaWNhdGlvbi1oZWFkZXItcmVtb3ZlZFwiXG4gICAgICBpMThuPVwiTm90aWZpY2F0aW9uIHJlbW92ZWQgaGVhZGVyQEBiYi1kZXZpY2UtaW5mb3JtYXRpb24td2lkZ2V0Lm5vdGlmaWNhdGlvbi5oZWFkZXIucmVtb3ZlZFwiPlxuICAgICAgRGV2aWNlIHJlbW92ZWRcbiAgICA8L2Rpdj5cbiAgICA8ZGl2ICpuZ1N3aXRjaENhc2U9XCJ1cGRhdGVBY3Rpb25zLlNhdmVcIlxuICAgICAgZGF0YS1yb2xlPVwibm90aWZpY2F0aW9uLWhlYWRlci1zYXZlZFwiXG4gICAgICBpMThuPVwiTm90aWZpY2F0aW9uIHNhdmVkIGhlYWRlckBAYmItZGV2aWNlLWluZm9ybWF0aW9uLXdpZGdldC5ub3RpZmljYXRpb24uaGVhZGVyLnNhdmVkXCI+XG4gICAgICBEZXZpY2UgbmFtZSBjaGFuZ2VkXG4gICAgPC9kaXY+XG4gIDwvbmctY29udGFpbmVyPlxuPC9uZy10ZW1wbGF0ZT5cblxuPG5nLXRlbXBsYXRlICNub3RpZmljYXRpb25TdWNjZXNzTWVzc2FnZSBsZXQtYWN0aW9uVHlwZT1cImFjdGlvblR5cGVcIiBsZXQtZGV2aWNlPVwiZGV2aWNlXCI+XG4gIDxuZy1jb250YWluZXIgW25nU3dpdGNoXT1cImFjdGlvblR5cGVcIj5cbiAgICA8ZGl2ICpuZ1N3aXRjaENhc2U9XCJ1cGRhdGVBY3Rpb25zLlJlc3RvcmVcIlxuICAgICAgaTE4bj1cIk5vdGlmaWNhdGlvbiByZXN0b3JlZCBtZXNzYWdlQEBiYi1kZXZpY2UtaW5mb3JtYXRpb24td2lkZ2V0Lm5vdGlmaWNhdGlvbi5tZXNzYWdlLnJlc3RvcmVkXCI+XG4gICAgICB7eyBnZXRGcmllbmRseU5hbWUoJ0RldmljZScsIGRldmljZSkgfX0gcmVzdG9yZWQgc3VjY2Vzc2Z1bGx5LlxuICAgIDwvZGl2PlxuICAgIDxkaXYgKm5nU3dpdGNoQ2FzZT1cInVwZGF0ZUFjdGlvbnMuU3VzcGVuZFwiXG4gICAgICBpMThuPVwiTm90aWZpY2F0aW9uIHN1c3BlbmRlZCBtZXNzYWdlQEBiYi1kZXZpY2UtaW5mb3JtYXRpb24td2lkZ2V0Lm5vdGlmaWNhdGlvbi5tZXNzYWdlLnN1c3BlbmRlZFwiPlxuICAgICAge3sgZ2V0RnJpZW5kbHlOYW1lKCdEZXZpY2UnLCBkZXZpY2UpIH19IHN1c3BlbmRlZCBzdWNjZXNzZnVsbHkuXG4gICAgPC9kaXY+XG4gICAgPGRpdiAqbmdTd2l0Y2hDYXNlPVwidXBkYXRlQWN0aW9ucy5SZW1vdmVcIlxuICAgICAgaTE4bj1cIk5vdGlmaWNhdGlvbiByZW1vdmVkIG1lc3NhZ2VAQGJiLWRldmljZS1pbmZvcm1hdGlvbi13aWRnZXQubm90aWZpY2F0aW9uLm1lc3NhZ2UucmVtb3ZlZFwiPlxuICAgICAge3sgZ2V0RnJpZW5kbHlOYW1lKCdEZXZpY2UnLCBkZXZpY2UpIH19IHJlbW92ZWQgc3VjY2Vzc2Z1bGx5LlxuICAgIDwvZGl2PlxuICAgIDxkaXYgKm5nU3dpdGNoQ2FzZT1cInVwZGF0ZUFjdGlvbnMuU2F2ZVwiXG4gICAgICBpMThuPVwiTm90aWZpY2F0aW9uIHNhdmVkIG1lc3NhZ2VAQGJiLWRldmljZS1pbmZvcm1hdGlvbi13aWRnZXQubm90aWZpY2F0aW9uLm1lc3NhZ2Uuc2F2ZWRcIj5cbiAgICAgIHt7IGdldEZyaWVuZGx5TmFtZSgnRGV2aWNlJywgZGV2aWNlKSB9fSBuYW1lIGNoYW5nZWQgc3VjY2Vzc2Z1bGx5LlxuICAgIDwvZGl2PlxuICA8L25nLWNvbnRhaW5lcj5cbjwvbmctdGVtcGxhdGU+XG5cbjxuZy10ZW1wbGF0ZSAjbm90aWZpY2F0aW9uRmFpbHVyZUhlYWRlcj5cbiAgPGRpdiBkYXRhLXJvbGU9XCJub3RpZmljYXRpb24taGVhZGVyLWZhaWxlZFwiIGkxOG49XCJGYWlsdXJlIG5vdGlmaWNhdGlvbiBoZWFkZXJAQGJiLWRldmljZS1pbmZvcm1hdGlvbi13aWRnZXQubm90aWZpY2F0aW9uLmZhaWx1cmUuaGVhZGVyXCI+XG4gICAgRGV2aWNlIHVwZGF0ZSBmYWlsZWRcbiAgPC9kaXY+XG48L25nLXRlbXBsYXRlPlxuXG48bmctdGVtcGxhdGUgI25vdGlmaWNhdGlvbkZhaWx1cmVNZXNzYWdlIGxldC1kZXZpY2U9XCJkZXZpY2VcIj5cbiAgPGRpdiBpMThuPVwiRmFpbHVyZSBub3RpZmljYXRpb24gbWVzc2FnZUBAYmItZGV2aWNlLWluZm9ybWF0aW9uLXdpZGdldC5ub3RpZmljYXRpb24uZmFpbHVyZS5tZXNzYWdlXCI+XG4gICAgRmFpbGVkIHRvIHVwZGF0ZSB7eyBnZXRPbGRGcmllbmRseU5hbWUoJ2RldmljZScsIGRldmljZSkgfX0uXG4gIDwvZGl2PlxuPC9uZy10ZW1wbGF0ZT5cblxuPG5nLXRlbXBsYXRlICNub3RpZmljYXRpb25QZXJtaXNzaW9uc0ZhaWx1cmVNZXNzYWdlIGxldC1kZXZpY2U9XCJkZXZpY2VcIj5cbiAgPGRpdiBpMThuPVwiUGVybWlzc2lvbiBmYWlsdXJlIG5vdGlmaWNhdGlvbiBtZXNzYWdlQEBiYi1kZXZpY2UtaW5mb3JtYXRpb24td2lkZ2V0Lm5vdGlmaWNhdGlvbi5wZXJtaXNzaW9ucy5mYWlsdXJlLm1lc3NhZ2VcIj5cbiAgICBJbnN1ZmZpY2llbnQgcGVybWlzc2lvbnMgdG8gdXBkYXRlIHt7IGdldE9sZEZyaWVuZGx5TmFtZSgnZGV2aWNlJywgZGV2aWNlKSB9fS5cbiAgPC9kaXY+XG48L25nLXRlbXBsYXRlPiJdfQ==