import { Injectable } from '@angular/core';
import { ReplaySubject, BehaviorSubject, of } from 'rxjs';
import { catchError, pluck, map, filter, distinctUntilChanged, tap, switchMap, shareReplay, take, } from 'rxjs/operators';
import { parseError } from './consent-request-error';
import * as i0 from "@angular/core";
import * as i1 from "@backbase/data-ang/consent";
import * as i2 from "@backbase/ui-ang/notification";
export class ConsentRequestService {
    constructor(consentReqService, consentHttpService, notification) {
        this.consentReqService = consentReqService;
        this.consentHttpService = consentHttpService;
        this.notification = notification;
        this.consentRequestId = new ReplaySubject(1);
        this.loading = new BehaviorSubject(true);
        this.error = new BehaviorSubject(undefined);
        this.saving = new BehaviorSubject(false);
        this.savingError = new BehaviorSubject(undefined);
        this.consentRequest = this.consentRequestId.pipe(filter((id) => !!id), distinctUntilChanged(), tap(() => this.loading.next(true)), switchMap((id) => this.loadConsentRequest(id)), tap(() => this.error.next(undefined)), catchError((error) => {
            this.error.next(error);
            return of(undefined);
        }), tap(() => this.loading.next(false)), shareReplay(1));
    }
    getConsentRequestFrom(consentRequestId) {
        consentRequestId.subscribe(this.consentRequestId);
    }
    /**
     * Function for allow consent request
     * @param account - accounts list
     * @param templateRef - template for notification
     */
    allowConsentRequest(account, templateRef) {
        return this.consentRequest.pipe(take(1), filter((consentRequest) => !!consentRequest), tap(() => this.saving.next(true)), switchMap((consentRequest) => this.allow(consentRequest, account)), tap(() => this.savingError.next(undefined)), catchError((error) => this.handleError(error, templateRef)), tap(() => this.saving.next(false)));
    }
    rejectConsentRequest(templateRef) {
        return this.consentRequest.pipe(take(1), filter((consentRequest) => consentRequest !== undefined), tap(() => this.saving.next(true)), switchMap((consentRequest) => this.reject(consentRequest)), tap(() => this.savingError.next(undefined)), catchError((error) => this.handleError(error, templateRef)), tap(() => this.saving.next(false)));
    }
    handleError(error, templateRef) {
        this.savingError.next(error);
        if (templateRef) {
            this.notification.showNotification({
                header: templateRef,
                message: '',
                modifier: 'error',
            });
        }
        return of({});
    }
    loadConsentRequest(id) {
        return this.consentReqService.getIdById({ id }, 'response').pipe(pluck('body'), catchError((error) => {
            throw parseError(error);
        }));
    }
    allow({ id: consentRequestId, allowConsentRedirectUrl: redirectUrl }, accounts) {
        return this.consentHttpService
            .postConsents({
            consentPost: {
                consentRequestId,
                accounts: accounts.map((account) => account.id),
            },
        }, 'response')
            .pipe(pluck('body'), map(() => ({ redirectUrl })), catchError((error) => {
            throw parseError(error);
        }));
    }
    reject({ id, rejectConsentRedirectUrl: redirectUrl }) {
        return this.consentReqService.postRejectById({ id }, 'response').pipe(map(() => ({ redirectUrl })), catchError((error) => {
            throw parseError(error);
        }));
    }
}
ConsentRequestService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.15", ngImport: i0, type: ConsentRequestService, deps: [{ token: i1.ConsentRequestsHttpService }, { token: i1.ConsentsHttpService }, { token: i2.NotificationService }], target: i0.ɵɵFactoryTarget.Injectable });
ConsentRequestService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "12.2.15", ngImport: i0, type: ConsentRequestService });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.15", ngImport: i0, type: ConsentRequestService, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.ConsentRequestsHttpService }, { type: i1.ConsentsHttpService }, { type: i2.NotificationService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29uc2VudC1yZXF1ZXN0LnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9saWJzL2NvbnNlbnQtcmVxdWVzdC13aWRnZXQtYW5nL3NyYy9jb25zZW50LXJlcXVlc3Qtd2lkZ2V0L2NvbnNlbnQtcmVxdWVzdC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQWUsTUFBTSxlQUFlLENBQUM7QUFFeEQsT0FBTyxFQUFjLGFBQWEsRUFBRSxlQUFlLEVBQUUsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3RFLE9BQU8sRUFDTCxVQUFVLEVBQ1YsS0FBSyxFQUNMLEdBQUcsRUFDSCxNQUFNLEVBQ04sb0JBQW9CLEVBQ3BCLEdBQUcsRUFDSCxTQUFTLEVBQ1QsV0FBVyxFQUNYLElBQUksR0FDTCxNQUFNLGdCQUFnQixDQUFDO0FBV3hCLE9BQU8sRUFBRSxVQUFVLEVBQXVCLE1BQU0seUJBQXlCLENBQUM7Ozs7QUFPMUUsTUFBTSxPQUFPLHFCQUFxQjtJQUNoQyxZQUNtQixpQkFBNkMsRUFDN0Msa0JBQXVDLEVBQ3ZDLFlBQWlDO1FBRmpDLHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBNEI7UUFDN0MsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFxQjtRQUN2QyxpQkFBWSxHQUFaLFlBQVksQ0FBcUI7UUFHbkMscUJBQWdCLEdBQUcsSUFBSSxhQUFhLENBQVMsQ0FBQyxDQUFDLENBQUM7UUFFeEQsWUFBTyxHQUFHLElBQUksZUFBZSxDQUFVLElBQUksQ0FBQyxDQUFDO1FBQzdDLFVBQUssR0FBRyxJQUFJLGVBQWUsQ0FBa0MsU0FBUyxDQUFDLENBQUM7UUFFeEUsV0FBTSxHQUFHLElBQUksZUFBZSxDQUFVLEtBQUssQ0FBQyxDQUFDO1FBQzdDLGdCQUFXLEdBQUcsSUFBSSxlQUFlLENBQWtDLFNBQVMsQ0FBQyxDQUFDO1FBRTlFLG1CQUFjLEdBQUcsSUFBSSxDQUFD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QUFDLEVBQzVCLFVBQVUsQ0FBQyxDQUFDLEtBQXdCLEVBQUUsRUFBRTtZQUN0QyxNQUFNLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUMxQixDQUFDLENBQUMsQ0FDSCxDQUFDO0lBQ04sQ0FBQztJQUVPLE1BQU0sQ0FBQyxFQUFFLEVBQUUsRUFBRSx3QkFBd0IsRUFBRSxXQUFXLEVBQWtCO1FBQzFFLE9BQU8sSUFBSSxDQUFDLGlCQUFpQixDQUFDLGNBQWMsQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLFVBQVUsQ0FBQyxDQUFDLElBQUksQ0FDbkUsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsRUFBRSxXQUFXLEVBQUUsQ0FBQyxDQUFDLEVBQzVCLFVBQVUsQ0FBQyxDQUFDLEtBQXdCLEVBQUUsRUFBRTtZQUN0QyxNQUFNLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUMxQixDQUFDLENBQUMsQ0FDSCxDQUFDO0lBQ0osQ0FBQzs7bUhBakhVLHFCQUFxQjt1SEFBckIscUJBQXFCOzRGQUFyQixxQkFBcUI7a0JBRGpDLFVBQVUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBUZW1wbGF0ZVJlZiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgSHR0cFJlc3BvbnNlLCBIdHRwRXJyb3JSZXNwb25zZSB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7IE9ic2VydmFibGUsIFJlcGxheVN1YmplY3QsIEJlaGF2aW9yU3ViamVjdCwgb2YgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7XG4gIGNhdGNoRXJyb3IsXG4gIHBsdWNrLFxuICBtYXAsXG4gIGZpbHRlcixcbiAgZGlzdGluY3RVbnRpbENoYW5nZWQsXG4gIHRhcCxcbiAgc3dpdGNoTWFwLFxuICBzaGFyZVJlcGxheSxcbiAgdGFrZSxcbn0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHtcbiAgQ29uc2VudFJlcXVlc3RzSHR0cFNlcnZpY2UsXG4gIENvbnNlbnRzSHR0cFNlcnZpY2UsXG4gIENvbnNlbnRSZXF1ZXN0LFxuICBJZGVudGlmaWVyLFxuICBBY2NvdW50LFxufSBmcm9tICdAYmFja2Jhc2UvZGF0YS1hbmcvY29uc2VudCc7XG5leHBvcnQgeyBDb25zZW50UmVxdWVzdCwgQWNjb3VudCwgVHBwIH0gZnJvbSAnQGJhY2tiYXNlL2RhdGEtYW5nL2NvbnNlbnQnO1xuXG5pbXBvcnQgeyBOb3RpZmljYXRpb25TZXJ2aWNlIH0gZnJvbSAnQGJhY2tiYXNlL3VpLWFuZy9ub3RpZmljYXRpb24nO1xuaW1wb3J0IHsgcGFyc2VFcnJvciwgQ29uc2VudFJlcXVlc3RFcnJvciB9IGZyb20gJy4vY29uc2VudC1yZXF1ZXN0LWVycm9yJztcblxuZXhwb3J0IGludGVyZmFjZSBSZWRpcmVjdFVybCB7XG4gIHJlZGlyZWN0VXJsPzogc3RyaW5nO1xufVxuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgQ29uc2VudFJlcXVlc3RTZXJ2aWNlIHtcbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBjb25zZW50UmVxU2VydmljZTogQ29uc2VudFJlcXVlc3RzSHR0cFNlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSBjb25zZW50SHR0cFNlcnZpY2U6IENvbnNlbnRzSHR0cFNlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSBub3RpZmljYXRpb246IE5vdGlmaWNhdGlvblNlcnZpY2UsXG4gICkge31cblxuICBwcml2YXRlIHJlYWRvbmx5IGNvbnNlbnRSZXF1ZXN0SWQgPSBuZXcgUmVwbGF5U3ViamVjdDxzdHJpbmc+KDEpO1xuXG4gIHJlYWRvbmx5IGxvYWRpbmcgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PGJvb2xlYW4+KHRydWUpO1xuICByZWFkb25seSBlcnJvciA9IG5ldyBCZWhhdmlvclN1YmplY3Q8Q29uc2VudFJlcXVlc3RFcnJvciB8IHVuZGVmaW5lZD4odW5kZWZpbmVkKTtcblxuICByZWFkb25seSBzYXZpbmcgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PGJvb2xlYW4+KGZhbHNlKTtcbiAgcmVhZG9ubHkgc2F2aW5nRXJyb3IgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PENvbnNlbnRSZXF1ZXN0RXJyb3IgfCB1bmRlZmluZWQ+KHVuZGVmaW5lZCk7XG5cbiAgcmVhZG9ubHkgY29uc2VudFJlcXVlc3QgPSB0aGlzLmNvbnNlbnRSZXF1ZXN0SWQucGlwZShcbiAgICBmaWx0ZXIoKGlkOiBzdHJpbmcpID0+ICEhaWQpLFxuICAgIGRpc3RpbmN0VW50aWxDaGFuZ2VkKCksXG4gICAgdGFwKCgpID0+IHRoaXMubG9hZGluZy5uZXh0KHRydWUpKSxcbiAgICBzd2l0Y2hNYXAoKGlkOiBzdHJpbmcpID0+IHRoaXMubG9hZENvbnNlbnRSZXF1ZXN0KGlkKSksXG4gICAgdGFwKCgpID0+IHRoaXMuZXJyb3IubmV4dCh1bmRlZmluZWQpKSxcbiAgICBjYXRjaEVycm9yKChlcnJvcjogQ29uc2VudFJlcXVlc3RFcnJvcikgPT4ge1xuICAgICAgdGhpcy5lcnJvci5uZXh0KGVycm9yKTtcbiAgICAgIHJldHVybiBvZih1bmRlZmluZWQpO1xuICAgIH0pLFxuICAgIHRhcCgoKSA9PiB0aGlzLmxvYWRpbmcubmV4dChmYWxzZSkpLFxuICAgIHNoYXJlUmVwbGF5KDEpLFxuICApO1xuXG4gIGdldENvbnNlbnRSZXF1ZXN0RnJvbShjb25zZW50UmVxdWVzdElkOiBPYnNlcnZhYmxlPHN0cmluZz4pIHtcbiAgICBjb25zZW50UmVxdWVzdElkLnN1YnNjcmliZSh0aGlzLmNvbnNlbnRSZXF1ZXN0SWQpO1xuICB9XG5cbiAgLyoqXG4gICAqIEZ1bmN0aW9uIGZvciBhbGxvdyBjb25zZW50IHJlcXVlc3RcbiAgICogQHBhcmFtIGFjY291bnQgLSBhY2NvdW50cyBsaXN0XG4gICAqIEBwYXJhbSB0ZW1wbGF0ZVJlZiAtIHRlbXBsYXRlIGZvciBub3RpZmljYXRpb25cbiAgICovXG4gIGFsbG93Q29uc2VudFJlcXVlc3QoYWNjb3VudDogQXJyYXk8QWNjb3VudD4sIHRlbXBsYXRlUmVmOiBUZW1wbGF0ZVJlZjxhbnk+IHwgc3RyaW5nKTogT2JzZXJ2YWJsZTxSZWRpcmVjdFVybD4ge1xuICAgIHJldHVybiB0aGlzLmNvbnNlbnRSZXF1ZXN0LnBpcGUoXG4gICAgICB0YWtlKDEpLFxuICAgICAgZmlsdGVyKChjb25zZW50UmVxdWVzdDogQ29uc2VudFJlcXVlc3QgfCB1bmRlZmluZWQpID0+ICEhY29uc2VudFJlcXVlc3QpLFxuICAgICAgdGFwKCgpID0+IHRoaXMuc2F2aW5nLm5leHQodHJ1ZSkpLFxuICAgICAgc3dpdGNoTWFwKChjb25zZW50UmVxdWVzdDogQ29uc2VudFJlcXVlc3QgfCB1bmRlZmluZWQpID0+IHRoaXMuYWxsb3coY29uc2VudFJlcXVlc3QgYXMgQ29uc2VudFJlcXVlc3QsIGFjY291bnQpKSxcbiAgICAgIHRhcCgoKSA9PiB0aGlzLnNhdmluZ0Vycm9yLm5leHQodW5kZWZpbmVkKSksXG4gICAgICBjYXRjaEVycm9yKChlcnJvcjogQ29uc2VudFJlcXVlc3RFcnJvcikgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnJvciwgdGVtcGxhdGVSZWYpKSxcbiAgICAgIHRhcCgoKSA9PiB0aGlzLnNhdmluZy5uZXh0KGZhbHNlKSksXG4gICAgKTtcbiAgfVxuXG4gIHJlamVjdENvbnNlbnRSZXF1ZXN0KHRlbXBsYXRlUmVmOiBUZW1wbGF0ZVJlZjxhbnk+IHwgc3RyaW5nKTogT2JzZXJ2YWJsZTxSZWRpcmVjdFVybD4ge1xuICAgIHJldHVybiB0aGlzLmNvbnNlbnRSZXF1ZXN0LnBpcGUoXG4gICAgICB0YWtlKDEpLFxuICAgICAgZmlsdGVyKChjb25zZW50UmVxdWVzdDogQ29uc2VudFJlcXVlc3QgfCB1bmRlZmluZWQpID0+IGNvbnNlbnRSZXF1ZXN0ICE9PSB1bmRlZmluZWQpLFxuICAgICAgdGFwKCgpID0+IHRoaXMuc2F2aW5nLm5leHQodHJ1ZSkpLFxuICAgICAgc3dpdGNoTWFwKChjb25zZW50UmVxdWVzdDogQ29uc2VudFJlcXVlc3QgfCB1bmRlZmluZWQpID0+IHRoaXMucmVqZWN0KGNvbnNlbnRSZXF1ZXN0IGFzIENvbnNlbnRSZXF1ZXN0KSksXG4gICAgICB0YXAoKCkgPT4gdGhpcy5zYXZpbmdFcnJvci5uZXh0KHVuZGVmaW5lZCkpLFxuICAgICAgY2F0Y2hFcnJvcigoZXJyb3I6IENvbnNlbnRSZXF1ZXN0RXJyb3IpID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyb3IsIHRlbXBsYXRlUmVmKSksXG4gICAgICB0YXAoKCkgPT4gdGhpcy5zYXZpbmcubmV4dChmYWxzZSkpLFxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGhhbmRsZUVycm9yKGVycm9yOiBDb25zZW50UmVxdWVzdEVycm9yLCB0ZW1wbGF0ZVJlZjogVGVtcGxhdGVSZWY8YW55PiB8IHN0cmluZykge1xuICAgIHRoaXMuc2F2aW5nRXJyb3IubmV4dChlcnJvcik7XG4gICAgaWYgKHRlbXBsYXRlUmVmKSB7XG4gICAgICB0aGlzLm5vdGlmaWNhdGlvbi5zaG93Tm90aWZpY2F0aW9uKHtcbiAgICAgICAgaGVhZGVyOiB0ZW1wbGF0ZVJlZixcbiAgICAgICAgbWVzc2FnZTogJycsXG4gICAgICAgIG1vZGlmaWVyOiAnZXJyb3InLFxuICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiBvZih7fSk7XG4gIH1cblxuICBwcml2YXRlIGxvYWRDb25zZW50UmVxdWVzdChpZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxDb25zZW50UmVxdWVzdD4ge1xuICAgIHJldHVybiB0aGlzLmNvbnNlbnRSZXFTZXJ2aWNlLmdldElkQnlJZCh7IGlkIH0sICdyZXNwb25zZScpLnBpcGUoXG4gICAgICBwbHVjazxIdHRwUmVzcG9uc2U8Q29uc2VudFJlcXVlc3Q+LCBDb25zZW50UmVxdWVzdD4oJ2JvZHknKSxcbiAgICAgIGNhdGNoRXJyb3I8Q29uc2VudFJlcXVlc3QsIG5ldmVyPigoZXJyb3I6IEh0dHBFcnJvclJlc3BvbnNlKSA9PiB7XG4gICAgICAgIHRocm93IHBhcnNlRXJyb3IoZXJyb3IpO1xuICAgICAgfSksXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgYWxsb3coXG4gICAgeyBpZDogY29uc2VudFJlcXVlc3RJZCwgYWxsb3dDb25zZW50UmVkaXJlY3RVcmw6IHJlZGlyZWN0VXJsIH06IENvbnNlbnRSZXF1ZXN0LFxuICAgIGFjY291bnRzOiBBY2NvdW50W10sXG4gICk6IE9ic2VydmFibGU8UmVkaXJlY3RVcmw+IHtcbiAgICByZXR1cm4gdGhpcy5jb25zZW50SHR0cFNlcnZpY2VcbiAgICAgIC5wb3N0Q29uc2VudHMoXG4gICAgICAgIHtcbiAgICAgICAgICBjb25zZW50UG9zdDoge1xuICAgICAgICAgICAgY29uc2VudFJlcXVlc3RJZCxcbiAgICAgICAgICAgIGFjY291bnRzOiBhY2NvdW50cy5tYXAoKGFjY291bnQ6IEFjY291bnQpID0+IGFjY291bnQuaWQpLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgICdyZXNwb25zZScsXG4gICAgICApXG4gICAgICAucGlwZShcbiAgICAgICAgcGx1Y2s8SHR0cFJlc3BvbnNlPElkZW50aWZpZXI+LCBJZGVudGlmaWVyPignYm9keScpLFxuICAgICAgICBtYXAoKCkgPT4gKHsgcmVkaXJlY3RVcmwgfSkpLFxuICAgICAgICBjYXRjaEVycm9yKChlcnJvcjogSHR0cEVycm9yUmVzcG9uc2UpID0+IHtcbiAgICAgICAgICB0aHJvdyBwYXJzZUVycm9yKGVycm9yKTtcbiAgICAgICAgfSksXG4gICAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSByZWplY3QoeyBpZCwgcmVqZWN0Q29uc2VudFJlZGlyZWN0VXJsOiByZWRpcmVjdFVybCB9OiBDb25zZW50UmVxdWVzdCk6IE9ic2VydmFibGU8UmVkaXJlY3RVcmw+IHtcbiAgICByZXR1cm4gdGhpcy5jb25zZW50UmVxU2VydmljZS5wb3N0UmVqZWN0QnlJZCh7IGlkIH0sICdyZXNwb25zZScpLnBpcGUoXG4gICAgICBtYXAoKCkgPT4gKHsgcmVkaXJlY3RVcmwgfSkpLFxuICAgICAgY2F0Y2hFcnJvcigoZXJyb3I6IEh0dHBFcnJvclJlc3BvbnNlKSA9PiB7XG4gICAgICAgIHRocm93IHBhcnNlRXJyb3IoZXJyb3IpO1xuICAgICAgfSksXG4gICAgKTtcbiAgfVxufVxuIl19