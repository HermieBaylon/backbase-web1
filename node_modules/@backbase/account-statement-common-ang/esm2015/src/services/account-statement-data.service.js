import { formatDate } from '@angular/common';
import { Inject, Injectable, LOCALE_ID } from '@angular/core';
import { of, throwError } from 'rxjs';
import { map, switchMap } from 'rxjs/operators';
import { EMPTY_RESPONSE_ERROR } from '../constants/errors';
import { HttpObserveType } from '../models/http-observe.model';
import * as i0 from "@angular/core";
import * as i1 from "@backbase/data-ang/arrangements";
import * as i2 from "@backbase/data-ang/account-statements";
import * as i3 from "@angular/common/http";
const getArrangementsRequiredParams = {
    businessFunction: 'Product Summary',
    resourceName: 'Product Summary',
    privilege: 'view',
};
const isNonNullableHttpResponse = (response) => 
// eslint-disable-next-line no-null/no-null
response.body !== null;
export class AccountStatementDataService {
    constructor(productSummaryHttpService, accountStatementsHttpService, http, locale) {
        this.productSummaryHttpService = productSummaryHttpService;
        this.accountStatementsHttpService = accountStatementsHttpService;
        this.http = http;
        this.locale = locale;
    }
    getAccounts(params) {
        return this.productSummaryHttpService
            .getArrangementsByBusinessFunction(Object.assign(Object.assign(Object.assign({}, getArrangementsRequiredParams), { favoriteFirst: true }), params), HttpObserveType.RESPONSE)
            .pipe(switchMap(response => (isNonNullableHttpResponse(response) ? of(response) : throwError(EMPTY_RESPONSE_ERROR))));
    }
    getAccountStatementsBusiness(params) {
        return this.accountStatementsHttpService
            .postAccountStatements(params, HttpObserveType.RESPONSE)
            .pipe(switchMap(response => isNonNullableHttpResponse(response) && Array.isArray(response.body)
            ? of(response)
            : throwError(EMPTY_RESPONSE_ERROR)));
    }
    loadAccounts() {
        return this.productSummaryHttpService
            .getArrangementsByBusinessFunction(getArrangementsRequiredParams, HttpObserveType.RESPONSE)
            .pipe(map(response => this.processAccountsRawData(response.body)));
    }
    loadCategories() {
        return this.accountStatementsHttpService.getCategories(HttpObserveType.RESPONSE).pipe(map(({ body }) => {
            // eslint-disable-next-line no-null/no-null
            if (body === null) {
                throw new Error('Response does not contain body');
            }
            return body.categories;
        }));
    }
    loadAccountStatements(params = {}) {
        return this.accountStatementsHttpService
            .getAccountStatements(this.formatAccountStatementsParams(params), HttpObserveType.RESPONSE)
            .pipe(map((response) => this.processAccountStatementsRawData(response)));
    }
    getAccountStatementDownloadUrl(uid) {
        return this.accountStatementsHttpService.downloadAccountStatementsUrl({ uid });
    }
    downloadFile(url) {
        return this.http.get(url, {
            responseType: 'arraybuffer',
            observe: 'response',
        });
    }
    processAccountsRawData(rawData) {
        return (rawData &&
            rawData.map((account) => ({
                id: account.id,
                name: account.bankAlias || account.name,
                identifier: account.IBAN || account.BBAN || account.productNumber,
                amount: account.availableBalance,
                currency: account.currency,
            })));
    }
    processAccountStatementsRawData(rawData) {
        const totalCount = (rawData && parseInt(String(rawData.headers.get('x-total-count')), 10)) || 0;
        return {
            data: rawData && rawData.body,
            totalCount,
        };
    }
    formatBookDate(date) {
        return formatDate(new Date(date), 'yyyy-MM-dd', this.locale);
    }
    formatAccountStatementsParams(params) {
        const { dateFrom, dateTo } = params;
        return Object.assign(Object.assign(Object.assign({}, params), (dateFrom && {
            dateFrom: this.formatBookDate(dateFrom),
        })), (dateTo && {
            dateTo: this.formatBookDate(dateTo),
        }));
    }
}
AccountStatementDataService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.15", ngImport: i0, type: AccountStatementDataService, deps: [{ token: i1.ProductSummaryHttpService }, { token: i2.AccountStatementHttpService }, { token: i3.HttpClient }, { token: LOCALE_ID }], target: i0.ɵɵFactoryTarget.Injectable });
AccountStatementDataService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "12.2.15", ngImport: i0, type: AccountStatementDataService });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.15", ngImport: i0, type: AccountStatementDataService, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.ProductSummaryHttpService }, { type: i2.AccountStatementHttpService }, { type: i3.HttpClient }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [LOCALE_ID]
                }] }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWNjb3VudC1zdGF0ZW1lbnQtZGF0YS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vbGlicy9hY2NvdW50LXN0YXRlbWVudC1jb21tb24tYW5nL3NyYy9zZXJ2aWNlcy9hY2NvdW50LXN0YXRlbWVudC1kYXRhLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBRTdDLE9BQU8sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQVM5RCxPQUFPLEVBQWMsRUFBRSxFQUFFLFVBQVUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNsRCxPQUFPLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ2hELE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBUTNELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQzs7Ozs7QUFHL0QsTUFBTSw2QkFBNkIsR0FBRztJQUNwQyxnQkFBZ0IsRUFBRSxpQkFBaUI7SUFDbkMsWUFBWSxFQUFFLGlCQUFpQjtJQUMvQixTQUFTLEVBQUUsTUFBTTtDQUNsQixDQUFDO0FBS0YsTUFBTSx5QkFBeUIsR0FBRyxDQUFJLFFBQXlCLEVBQTBDLEVBQUU7QUFDekcsMkNBQTJDO0FBQzNDLFFBQVEsQ0FBQyxJQUFJLEtBQUssSUFBSSxDQUFDO0FBR3pCLE1BQU0sT0FBTywyQkFBMkI7SUFDdEMsWUFDbUIseUJBQW9ELEVBQ3BELDRCQUF5RCxFQUN6RCxJQUFnQixFQUNHLE1BQWM7UUFIakMsOEJBQXlCLEdBQXpCLHlCQUF5QixDQUEyQjtRQUNwRCxpQ0FBNEIsR0FBNUIsNEJBQTRCLENBQTZCO1FBQ3pELFNBQUksR0FBSixJQUFJLENBQVk7UUFDRyxXQUFNLEdBQU4sTUFBTSxDQUFRO0lBQ2pELENBQUM7SUFFSixXQUFXLENBQUMsTUFBaUM7UUFDM0MsT0FBTyxJQUFJLENBQUMseUJBQXlCO2FBQ2xDLGlDQUFpQywrQ0FFM0IsNkJBQTZCLEtBQ2hDLGFBQWEsRUFBRSxJQUFXLEtBQ3ZCLE1BQU0sR0FFWCxlQUFlLENBQUMsUUFBUSxDQUN6QjthQUNBLElBQUksQ0FDSCxTQUFTLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDLHlCQUF5QixDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDLENBQUMsQ0FDL0csQ0FBQztJQUNOLENBQUM7SUFFRCw0QkFBNEIsQ0FDMUIsTUFBMEM7UUFFMUMsT0FBTyxJQUFJLENBQUMsNEJBQTRCO2FBQ3JDLHFCQUFxQixDQUFDLE1BQU0sRUFBRSxlQUFlLENBQUMsUUFBUSxDQUFDO2FBQ3ZELElBQUksQ0FDSCxTQUFTLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FDbkIseUJBQXlCLENBQUMsUUFBUSxDQUFDLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDO1lBQ2pFLENBQUMsQ0FBQyxFQUFFLENBQUMsUUFBUSxDQUFDO1lBQ2QsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxvQkFBb0IsQ0FBQyxDQUNyQyxDQUNGLENBQUM7SUFDTixDQUFDO0lBRUQsWUFBWTtRQUNWLE9BQU8sSUFBSSxDQUFDLHlCQUF5QjthQUNsQyxpQ0FBaUMsQ0FBQyw2QkFBNkIsRUFBRSxlQUFlLENBQUMsUUFBUSxDQUFDO2FBQzFGLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsc0JBQXNCLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUN2RSxDQUFDO0lBRUQsY0FBYztRQUNaLE9BQU8sSUFBSSxDQUFDLDRCQUE0QixDQUFDLGFBQWEsQ0FBQyxlQUFlLENBQUMsUUFBUSxDQUFDLENBQUMsSUFBSSxDQUNuRixHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksRUFBRSxFQUFFLEVBQUU7WUFDZiwyQ0FBMkM7WUFDM0MsSUFBSSxJQUFJLEtBQUssSUFBSSxFQUFFO2dCQUNqQixNQUFNLElBQUksS0FBSyxDQUFDLGdDQUFnQyxDQUFDLENBQUM7YUFDbkQ7WUFDRCxPQUFPLElBQUksQ0FBQyxVQUFVLENBQUM7UUFDekIsQ0FBQyxDQUFDLENBQ0gsQ0FBQztJQUNKLENBQUM7SUFFRCxxQkFBcUIsQ0FBQyxTQUF1QyxFQUFFO1FBQzdELE9BQU8sSUFBSSxDQUFDLDRCQUE0QjthQUNyQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsNkJBQTZCLENBQUMsTUFBTSxDQUFDLEVBQUUsZUFBZSxDQUFDLFFBQVEsQ0FBQzthQUMxRixJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsUUFBMEMsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLCtCQUErQixDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUMvRyxDQUFDO0lBRUQsOEJBQThCLENBQUMsR0FBVztRQUN4QyxPQUFPLElBQUksQ0FBQyw0QkFBNEIsQ0FBQyw0QkFBNEIsQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7SUFDakYsQ0FBQztJQUVELFlBQVksQ0FBQyxHQUFXO1FBQ3RCLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFO1lBQ3hCLFlBQVksRUFBRSxhQUFhO1lBQzNCLE9BQU8sRUFBRSxVQUFVO1NBQ3BCLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFTyxzQkFBc0IsQ0FBQyxPQUF5QztRQUN0RSxPQUFPLENBQ0wsT0FBTztZQUNQLE9BQU8sQ0FBQyxHQUFHLENBQ1QsQ0FBQyxPQUEyQixFQUFFLEVBQUUsQ0FDOUIsQ0FBQztnQkFDQyxFQUFFLEVBQUUsT0FBTyxDQUFDLEVBQUU7Z0JBQ2QsSUFBSSxFQUFFLE9BQU8sQ0FBQyxTQUFTLElBQUksT0FBTyxDQUFDLElBQUk7Z0JBQ3ZDLFVBQVUsRUFBRSxPQUFPLENBQUMsSUFBSSxJQUFJLE9BQU8sQ0FBQyxJQUFJLElBQUksT0FBTyxDQUFDLGFBQWE7Z0JBQ2pFLE1BQU0sRUFBRSxPQUFPLENBQUMsZ0JBQWdCO2dCQUNoQyxRQUFRLEVBQUUsT0FBTyxDQUFDLFFBQVE7YUFDWCxDQUFBLENBQ3BCLENBQ0YsQ0FBQztJQUNKLENBQUM7SUFFTywrQkFBK0IsQ0FDckMsT0FBZ0Q7UUFFaEQsTUFBTSxVQUFVLEdBQVcsQ0FBQyxPQUFPLElBQUksUUFBUSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFlLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRXhHLE9BQU87WUFDTCxJQUFJLEVBQUUsT0FBTyxJQUFJLE9BQU8sQ0FBQyxJQUFJO1lBQzdCLFVBQVU7U0FDWCxDQUFDO0lBQ0osQ0FBQztJQUVPLGNBQWMsQ0FBQyxJQUFZO1FBQ2pDLE9BQU8sVUFBVSxDQUFDLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLFlBQVksRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDL0QsQ0FBQztJQUVPLDZCQUE2QixDQUFDLE1BQW9DO1FBQ3hFLE1BQU0sRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLEdBQUcsTUFBTSxDQUFDO1FBQ3BDLHFEQUNLLE1BQU0sR0FDTixDQUFDLFFBQVEsSUFBSTtZQUNkLFFBQVEsRUFBRSxJQUFJLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQztTQUN4QyxDQUFDLEdBQ0MsQ0FBQyxNQUFNLElBQUk7WUFDWixNQUFNLEVBQUUsSUFBSSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUM7U0FDcEMsQ0FBQyxFQUNGO0lBQ0osQ0FBQzs7eUhBbEhVLDJCQUEyQixnSUFLNUIsU0FBUzs2SEFMUiwyQkFBMkI7NEZBQTNCLDJCQUEyQjtrQkFEdkMsVUFBVTs7MEJBTU4sTUFBTTsyQkFBQyxTQUFTIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZm9ybWF0RGF0ZSB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5pbXBvcnQgeyBIdHRwQ2xpZW50LCBIdHRwUmVzcG9uc2UgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUsIExPQ0FMRV9JRCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtcbiAgQWNjb3VudFN0YXRlbWVudCxcbiAgQWNjb3VudFN0YXRlbWVudEh0dHBTZXJ2aWNlLFxuICBQb3N0QWNjb3VudFN0YXRlbWVudHNSZXF1ZXN0UGFyYW1zLFxufSBmcm9tICdAYmFja2Jhc2UvZGF0YS1hbmcvYWNjb3VudC1zdGF0ZW1lbnRzJztcblxuaW1wb3J0IHsgUHJvZHVjdFN1bW1hcnlIdHRwU2VydmljZSwgUHJvZHVjdFN1bW1hcnlJdGVtIH0gZnJvbSAnQGJhY2tiYXNlL2RhdGEtYW5nL2FycmFuZ2VtZW50cyc7XG5cbmltcG9ydCB7IE9ic2VydmFibGUsIG9mLCB0aHJvd0Vycm9yIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBtYXAsIHN3aXRjaE1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEVNUFRZX1JFU1BPTlNFX0VSUk9SIH0gZnJvbSAnLi4vY29uc3RhbnRzL2Vycm9ycyc7XG5cbmltcG9ydCB7XG4gIEFjY291bnRTdGF0ZW1lbnRHZXRSZXFQYXJhbXMsXG4gIENhdGVnb3JpZXMsXG4gIFByb2NjZXNzZWRBY2NvdW50U3RhdGVtZW50c1Jhd0RhdGEsXG59IGZyb20gJy4uL21vZGVscy9hY2NvdW50LXN0YXRlbWVudCc7XG5pbXBvcnQgeyBBY2NvdW50c0dldFJlcXVlc3RQYXJhbXMgfSBmcm9tICcuLi9tb2RlbHMvYWNjb3VudHMubW9kZWwnO1xuaW1wb3J0IHsgSHR0cE9ic2VydmVUeXBlIH0gZnJvbSAnLi4vbW9kZWxzL2h0dHAtb2JzZXJ2ZS5tb2RlbCc7XG5pbXBvcnQgeyBBY2NvdW50SXRlbSwgQWNjb3VudHMgfSBmcm9tICcuLi9tb2RlbHMvcHJvZHVjdC1zdW1tYXJ5JztcblxuY29uc3QgZ2V0QXJyYW5nZW1lbnRzUmVxdWlyZWRQYXJhbXMgPSB7XG4gIGJ1c2luZXNzRnVuY3Rpb246ICdQcm9kdWN0IFN1bW1hcnknLFxuICByZXNvdXJjZU5hbWU6ICdQcm9kdWN0IFN1bW1hcnknLFxuICBwcml2aWxlZ2U6ICd2aWV3Jyxcbn07XG5cbmV4cG9ydCBpbnRlcmZhY2UgTm9uTnVsbGFibGVIdHRwUmVzcG9uc2U8VD4gZXh0ZW5kcyBIdHRwUmVzcG9uc2U8VD4ge1xuICBib2R5OiBUO1xufVxuY29uc3QgaXNOb25OdWxsYWJsZUh0dHBSZXNwb25zZSA9IDxUPihyZXNwb25zZTogSHR0cFJlc3BvbnNlPFQ+KTogcmVzcG9uc2UgaXMgTm9uTnVsbGFibGVIdHRwUmVzcG9uc2U8VD4gPT5cbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLW51bGwvbm8tbnVsbFxuICByZXNwb25zZS5ib2R5ICE9PSBudWxsO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgQWNjb3VudFN0YXRlbWVudERhdGFTZXJ2aWNlIHtcbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBwcm9kdWN0U3VtbWFyeUh0dHBTZXJ2aWNlOiBQcm9kdWN0U3VtbWFyeUh0dHBTZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgYWNjb3VudFN0YXRlbWVudHNIdHRwU2VydmljZTogQWNjb3VudFN0YXRlbWVudEh0dHBTZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgaHR0cDogSHR0cENsaWVudCxcbiAgICBASW5qZWN0KExPQ0FMRV9JRCkgcHJpdmF0ZSByZWFkb25seSBsb2NhbGU6IHN0cmluZyxcbiAgKSB7fVxuXG4gIGdldEFjY291bnRzKHBhcmFtcz86IEFjY291bnRzR2V0UmVxdWVzdFBhcmFtcyk6IE9ic2VydmFibGU8Tm9uTnVsbGFibGVIdHRwUmVzcG9uc2U8UHJvZHVjdFN1bW1hcnlJdGVtW10+PiB7XG4gICAgcmV0dXJuIHRoaXMucHJvZHVjdFN1bW1hcnlIdHRwU2VydmljZVxuICAgICAgLmdldEFycmFuZ2VtZW50c0J5QnVzaW5lc3NGdW5jdGlvbihcbiAgICAgICAge1xuICAgICAgICAgIC4uLmdldEFycmFuZ2VtZW50c1JlcXVpcmVkUGFyYW1zLFxuICAgICAgICAgIGZhdm9yaXRlRmlyc3Q6IHRydWUgYXMgYW55LFxuICAgICAgICAgIC4uLnBhcmFtcyxcbiAgICAgICAgfSxcbiAgICAgICAgSHR0cE9ic2VydmVUeXBlLlJFU1BPTlNFLFxuICAgICAgKVxuICAgICAgLnBpcGUoXG4gICAgICAgIHN3aXRjaE1hcChyZXNwb25zZSA9PiAoaXNOb25OdWxsYWJsZUh0dHBSZXNwb25zZShyZXNwb25zZSkgPyBvZihyZXNwb25zZSkgOiB0aHJvd0Vycm9yKEVNUFRZX1JFU1BPTlNFX0VSUk9SKSkpLFxuICAgICAgKTtcbiAgfVxuXG4gIGdldEFjY291bnRTdGF0ZW1lbnRzQnVzaW5lc3MoXG4gICAgcGFyYW1zOiBQb3N0QWNjb3VudFN0YXRlbWVudHNSZXF1ZXN0UGFyYW1zLFxuICApOiBPYnNlcnZhYmxlPE5vbk51bGxhYmxlSHR0cFJlc3BvbnNlPEFjY291bnRTdGF0ZW1lbnRbXT4+IHtcbiAgICByZXR1cm4gdGhpcy5hY2NvdW50U3RhdGVtZW50c0h0dHBTZXJ2aWNlXG4gICAgICAucG9zdEFjY291bnRTdGF0ZW1lbnRzKHBhcmFtcywgSHR0cE9ic2VydmVUeXBlLlJFU1BPTlNFKVxuICAgICAgLnBpcGUoXG4gICAgICAgIHN3aXRjaE1hcChyZXNwb25zZSA9PlxuICAgICAgICAgIGlzTm9uTnVsbGFibGVIdHRwUmVzcG9uc2UocmVzcG9uc2UpICYmIEFycmF5LmlzQXJyYXkocmVzcG9uc2UuYm9keSlcbiAgICAgICAgICAgID8gb2YocmVzcG9uc2UpXG4gICAgICAgICAgICA6IHRocm93RXJyb3IoRU1QVFlfUkVTUE9OU0VfRVJST1IpLFxuICAgICAgICApLFxuICAgICAgKTtcbiAgfVxuXG4gIGxvYWRBY2NvdW50cygpOiBPYnNlcnZhYmxlPEFjY291bnRzIHwgbnVsbD4ge1xuICAgIHJldHVybiB0aGlzLnByb2R1Y3RTdW1tYXJ5SHR0cFNlcnZpY2VcbiAgICAgIC5nZXRBcnJhbmdlbWVudHNCeUJ1c2luZXNzRnVuY3Rpb24oZ2V0QXJyYW5nZW1lbnRzUmVxdWlyZWRQYXJhbXMsIEh0dHBPYnNlcnZlVHlwZS5SRVNQT05TRSlcbiAgICAgIC5waXBlKG1hcChyZXNwb25zZSA9PiB0aGlzLnByb2Nlc3NBY2NvdW50c1Jhd0RhdGEocmVzcG9uc2UuYm9keSkpKTtcbiAgfVxuXG4gIGxvYWRDYXRlZ29yaWVzKCk6IE9ic2VydmFibGU8Q2F0ZWdvcmllcz4ge1xuICAgIHJldHVybiB0aGlzLmFjY291bnRTdGF0ZW1lbnRzSHR0cFNlcnZpY2UuZ2V0Q2F0ZWdvcmllcyhIdHRwT2JzZXJ2ZVR5cGUuUkVTUE9OU0UpLnBpcGUoXG4gICAgICBtYXAoKHsgYm9keSB9KSA9PiB7XG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1udWxsL25vLW51bGxcbiAgICAgICAgaWYgKGJvZHkgPT09IG51bGwpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Jlc3BvbnNlIGRvZXMgbm90IGNvbnRhaW4gYm9keScpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBib2R5LmNhdGVnb3JpZXM7XG4gICAgICB9KSxcbiAgICApO1xuICB9XG5cbiAgbG9hZEFjY291bnRTdGF0ZW1lbnRzKHBhcmFtczogQWNjb3VudFN0YXRlbWVudEdldFJlcVBhcmFtcyA9IHt9KTogT2JzZXJ2YWJsZTxQcm9jY2Vzc2VkQWNjb3VudFN0YXRlbWVudHNSYXdEYXRhPiB7XG4gICAgcmV0dXJuIHRoaXMuYWNjb3VudFN0YXRlbWVudHNIdHRwU2VydmljZVxuICAgICAgLmdldEFjY291bnRTdGF0ZW1lbnRzKHRoaXMuZm9ybWF0QWNjb3VudFN0YXRlbWVudHNQYXJhbXMocGFyYW1zKSwgSHR0cE9ic2VydmVUeXBlLlJFU1BPTlNFKVxuICAgICAgLnBpcGUobWFwKChyZXNwb25zZTogSHR0cFJlc3BvbnNlPEFjY291bnRTdGF0ZW1lbnRbXT4pID0+IHRoaXMucHJvY2Vzc0FjY291bnRTdGF0ZW1lbnRzUmF3RGF0YShyZXNwb25zZSkpKTtcbiAgfVxuXG4gIGdldEFjY291bnRTdGF0ZW1lbnREb3dubG9hZFVybCh1aWQ6IHN0cmluZykge1xuICAgIHJldHVybiB0aGlzLmFjY291bnRTdGF0ZW1lbnRzSHR0cFNlcnZpY2UuZG93bmxvYWRBY2NvdW50U3RhdGVtZW50c1VybCh7IHVpZCB9KTtcbiAgfVxuXG4gIGRvd25sb2FkRmlsZSh1cmw6IHN0cmluZyk6IE9ic2VydmFibGU8SHR0cFJlc3BvbnNlPEFycmF5QnVmZmVyPj4ge1xuICAgIHJldHVybiB0aGlzLmh0dHAuZ2V0KHVybCwge1xuICAgICAgcmVzcG9uc2VUeXBlOiAnYXJyYXlidWZmZXInLFxuICAgICAgb2JzZXJ2ZTogJ3Jlc3BvbnNlJyxcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgcHJvY2Vzc0FjY291bnRzUmF3RGF0YShyYXdEYXRhOiBBcnJheTxQcm9kdWN0U3VtbWFyeUl0ZW0+IHwgbnVsbCk6IEFjY291bnRzIHwgbnVsbCB7XG4gICAgcmV0dXJuIChcbiAgICAgIHJhd0RhdGEgJiZcbiAgICAgIHJhd0RhdGEubWFwKFxuICAgICAgICAoYWNjb3VudDogUHJvZHVjdFN1bW1hcnlJdGVtKSA9PlxuICAgICAgICAgICh7XG4gICAgICAgICAgICBpZDogYWNjb3VudC5pZCxcbiAgICAgICAgICAgIG5hbWU6IGFjY291bnQuYmFua0FsaWFzIHx8IGFjY291bnQubmFtZSxcbiAgICAgICAgICAgIGlkZW50aWZpZXI6IGFjY291bnQuSUJBTiB8fCBhY2NvdW50LkJCQU4gfHwgYWNjb3VudC5wcm9kdWN0TnVtYmVyLFxuICAgICAgICAgICAgYW1vdW50OiBhY2NvdW50LmF2YWlsYWJsZUJhbGFuY2UsXG4gICAgICAgICAgICBjdXJyZW5jeTogYWNjb3VudC5jdXJyZW5jeSxcbiAgICAgICAgICB9IGFzIEFjY291bnRJdGVtKSxcbiAgICAgIClcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBwcm9jZXNzQWNjb3VudFN0YXRlbWVudHNSYXdEYXRhKFxuICAgIHJhd0RhdGE6IEh0dHBSZXNwb25zZTxBY2NvdW50U3RhdGVtZW50W10+IHwgbnVsbCxcbiAgKTogUHJvY2Nlc3NlZEFjY291bnRTdGF0ZW1lbnRzUmF3RGF0YSB7XG4gICAgY29uc3QgdG90YWxDb3VudDogbnVtYmVyID0gKHJhd0RhdGEgJiYgcGFyc2VJbnQoU3RyaW5nKHJhd0RhdGEuaGVhZGVycy5nZXQoJ3gtdG90YWwtY291bnQnKSksIDEwKSkgfHwgMDtcblxuICAgIHJldHVybiB7XG4gICAgICBkYXRhOiByYXdEYXRhICYmIHJhd0RhdGEuYm9keSxcbiAgICAgIHRvdGFsQ291bnQsXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgZm9ybWF0Qm9va0RhdGUoZGF0ZTogc3RyaW5nKSB7XG4gICAgcmV0dXJuIGZvcm1hdERhdGUobmV3IERhdGUoZGF0ZSksICd5eXl5LU1NLWRkJywgdGhpcy5sb2NhbGUpO1xuICB9XG5cbiAgcHJpdmF0ZSBmb3JtYXRBY2NvdW50U3RhdGVtZW50c1BhcmFtcyhwYXJhbXM6IEFjY291bnRTdGF0ZW1lbnRHZXRSZXFQYXJhbXMpOiBBY2NvdW50U3RhdGVtZW50R2V0UmVxUGFyYW1zIHtcbiAgICBjb25zdCB7IGRhdGVGcm9tLCBkYXRlVG8gfSA9IHBhcmFtcztcbiAgICByZXR1cm4ge1xuICAgICAgLi4ucGFyYW1zLFxuICAgICAgLi4uKGRhdGVGcm9tICYmIHtcbiAgICAgICAgZGF0ZUZyb206IHRoaXMuZm9ybWF0Qm9va0RhdGUoZGF0ZUZyb20pLFxuICAgICAgfSksXG4gICAgICAuLi4oZGF0ZVRvICYmIHtcbiAgICAgICAgZGF0ZVRvOiB0aGlzLmZvcm1hdEJvb2tEYXRlKGRhdGVUbyksXG4gICAgICB9KSxcbiAgICB9O1xuICB9XG59XG4iXX0=