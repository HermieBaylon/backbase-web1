import { Injectable } from '@angular/core';
import { ReplaySubject, BehaviorSubject, of } from 'rxjs';
import { catchError, pluck, filter, distinctUntilChanged, tap, switchMap, shareReplay, take, map, } from 'rxjs/operators';
import { parseError } from './payment-request-error';
import * as i0 from "@angular/core";
import * as i1 from "@backbase/data-ang/consent";
import * as i2 from "@backbase/ui-ang/notification";
export class PaymentRequestService {
    constructor(consentDataHttpService, notification) {
        this.consentDataHttpService = consentDataHttpService;
        this.notification = notification;
        this.paymentRequestId = new ReplaySubject(1);
        this.loading = new BehaviorSubject(true);
        this.error = new BehaviorSubject(undefined);
        this.saving = new BehaviorSubject(false);
        this.savingError = new BehaviorSubject(undefined);
        this.paymentRequest = this.paymentRequestId.pipe(filter((id) => !!id), distinctUntilChanged(), tap(() => this.loading.next(true)), switchMap((id) => this.loadPaymentRequestRequest(id)), tap(() => this.error.next(undefined)), catchError((error) => {
            this.error.next(error);
            return of(undefined);
        }), tap(() => this.loading.next(false)), shareReplay(1));
    }
    getPaymentRequestFrom(paymentRequestId) {
        paymentRequestId.subscribe(this.paymentRequestId);
    }
    allowPaymentRequest(account, templateRef) {
        return this.paymentRequest.pipe(take(1), filter((paymentRequest) => !!paymentRequest), tap(() => this.saving.next(true)), switchMap((paymentRequest) => this.allow(paymentRequest, account)), tap(() => this.savingError.next(undefined)), catchError((error) => this.handleError(error, templateRef)), tap(() => this.saving.next(false)));
    }
    rejectPaymentRequest(templateRef) {
        return this.paymentRequest.pipe(take(1), filter((paymentRequest) => paymentRequest !== undefined), tap(() => this.saving.next(true)), switchMap((paymentRequest) => this.reject(paymentRequest)), tap(() => this.savingError.next(undefined)), catchError((error) => this.handleError(error, templateRef)), tap(() => this.saving.next(false)));
    }
    handleError(error, templateRef) {
        this.savingError.next(error);
        this.notification.showNotification({
            message: templateRef,
            modifier: 'error',
        });
        return of({});
    }
    loadPaymentRequestRequest(id) {
        return this.consentDataHttpService.getIdByIdgetPaymentRequestById({ id }, 'response').pipe(pluck('body'), catchError((error) => {
            throw parseError(error);
        }));
    }
    allow({ id, allowPaymentRedirectUrl: redirectUrl }, { id: accountId }) {
        return this.consentDataHttpService.postConfirmById({ id, paymentPost: { accountId } }).pipe(map(() => ({ redirectUrl })), catchError((error) => {
            throw parseError(error);
        }));
    }
    reject({ id, rejectPaymentRedirectUrl: redirectUrl }) {
        return this.consentDataHttpService.postRejectByIdpostReject({ id }).pipe(map(() => ({ redirectUrl })), catchError((error) => {
            throw parseError(error);
        }));
    }
}
PaymentRequestService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.15", ngImport: i0, type: PaymentRequestService, deps: [{ token: i1.PaymentRequestsHttpService }, { token: i2.NotificationService }], target: i0.ɵɵFactoryTarget.Injectable });
PaymentRequestService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "12.2.15", ngImport: i0, type: PaymentRequestService });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.15", ngImport: i0, type: PaymentRequestService, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.PaymentRequestsHttpService }, { type: i2.NotificationService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGF5bWVudC1yZXF1ZXN0LnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9saWJzL3BheW1lbnQtcmVxdWVzdC13aWRnZXQtYW5nL3NyYy9wYXltZW50LXJlcXVlc3Qtd2lkZ2V0L3BheW1lbnQtcmVxdWVzdC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQWUsTUFBTSxlQUFlLENBQUM7QUFFeEQsT0FBTyxFQUFjLGFBQWEsRUFBRSxlQUFlLEVBQUUsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3RFLE9BQU8sRUFDTCxVQUFVLEVBQ1YsS0FBSyxFQUNMLE1BQU0sRUFDTixvQkFBb0IsRUFDcEIsR0FBRyxFQUNILFNBQVMsRUFDVCxXQUFXLEVBQ1gsSUFBSSxFQUNKLEdBQUcsR0FDSixNQUFNLGdCQUFnQixDQUFDO0FBR3hCLE9BQU8sRUFBRSxVQUFVLEVBQXVCLE1BQU0seUJBQXlCLENBQUM7Ozs7QUFTMUUsTUFBTSxPQUFPLHFCQUFxQjtJQUNoQyxZQUNtQixzQkFBa0QsRUFDbEQsWUFBaUM7UUFEakMsMkJBQXNCLEdBQXRCLHNCQUFzQixDQUE0QjtRQUNsRCxpQkFBWSxHQUFaLFlBQVksQ0FBcUI7UUFHbkMscUJBQWdCLEdBQUcsSUFBSSxhQUFhLENBQVMsQ0FBQyxDQUFDLENBQUM7UUFFeEQsWUFBTyxHQUFHLElBQUksZUFBZSxDQUFVLElBQUksQ0FBQyxDQUFDO1FBQzdDLFVBQUssR0FBRyxJQUFJLGVBQWUsQ0FBa0MsU0FBUyxDQUFDLENBQUM7UUFFeEUsV0FBTSxHQUFHLElBQUksZUFBZSxDQUFVLEtBQUssQ0FBQyxDQUFDO1FBQzdDLGdCQUFXLEdBQUcsSUFBSSxlQUFlLENBQWtDLFNBQVMsQ0FBQyxDQUFDO1FBRTlFLG1CQUFjLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FDbEQsTUFBTSxDQUFDLENBQUMsRUFBVSxF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RUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FDdEUsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsRUFBRSxXQUFXLEVBQUUsQ0FBQyxDQUFDLEVBQzVCLFVBQVUsQ0FBQyxDQUFDLEtBQXdCLEVBQUUsRUFBRTtZQUN0QyxNQUFNLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUMxQixDQUFDLENBQUMsQ0FDSCxDQUFDO0lBQ0osQ0FBQzs7bUhBN0ZVLHFCQUFxQjt1SEFBckIscUJBQXFCOzRGQUFyQixxQkFBcUI7a0JBRGpDLFVBQVUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBUZW1wbGF0ZVJlZiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgSHR0cFJlc3BvbnNlLCBIdHRwRXJyb3JSZXNwb25zZSB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7IE9ic2VydmFibGUsIFJlcGxheVN1YmplY3QsIEJlaGF2aW9yU3ViamVjdCwgb2YgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7XG4gIGNhdGNoRXJyb3IsXG4gIHBsdWNrLFxuICBmaWx0ZXIsXG4gIGRpc3RpbmN0VW50aWxDaGFuZ2VkLFxuICB0YXAsXG4gIHN3aXRjaE1hcCxcbiAgc2hhcmVSZXBsYXksXG4gIHRha2UsXG4gIG1hcCxcbn0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgUGF5bWVudFJlcXVlc3RzSHR0cFNlcnZpY2UsIFBheW1lbnRSZXF1ZXN0LCBBY2NvdW50IH0gZnJvbSAnQGJhY2tiYXNlL2RhdGEtYW5nL2NvbnNlbnQnO1xuaW1wb3J0IHsgTm90aWZpY2F0aW9uU2VydmljZSB9IGZyb20gJ0BiYWNrYmFzZS91aS1hbmcvbm90aWZpY2F0aW9uJztcbmltcG9ydCB7IHBhcnNlRXJyb3IsIFBheW1lbnRSZXF1ZXN0RXJyb3IgfSBmcm9tICcuL3BheW1lbnQtcmVxdWVzdC1lcnJvcic7XG5cbmV4cG9ydCB7IFBheW1lbnRSZXF1ZXN0LCBBY2NvdW50LCBUcHAgfSBmcm9tICdAYmFja2Jhc2UvZGF0YS1hbmcvY29uc2VudCc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgUmVkaXJlY3RVcmwge1xuICByZWRpcmVjdFVybD86IHN0cmluZztcbn1cblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFBheW1lbnRSZXF1ZXN0U2VydmljZSB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgY29uc2VudERhdGFIdHRwU2VydmljZTogUGF5bWVudFJlcXVlc3RzSHR0cFNlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSBub3RpZmljYXRpb246IE5vdGlmaWNhdGlvblNlcnZpY2UsXG4gICkge31cblxuICBwcml2YXRlIHJlYWRvbmx5IHBheW1lbnRSZXF1ZXN0SWQgPSBuZXcgUmVwbGF5U3ViamVjdDxzdHJpbmc+KDEpO1xuXG4gIHJlYWRvbmx5IGxvYWRpbmcgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PGJvb2xlYW4+KHRydWUpO1xuICByZWFkb25seSBlcnJvciA9IG5ldyBCZWhhdmlvclN1YmplY3Q8UGF5bWVudFJlcXVlc3RFcnJvciB8IHVuZGVmaW5lZD4odW5kZWZpbmVkKTtcblxuICByZWFkb25seSBzYXZpbmcgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PGJvb2xlYW4+KGZhbHNlKTtcbiAgcmVhZG9ubHkgc2F2aW5nRXJyb3IgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PFBheW1lbnRSZXF1ZXN0RXJyb3IgfCB1bmRlZmluZWQ+KHVuZGVmaW5lZCk7XG5cbiAgcmVhZG9ubHkgcGF5bWVudFJlcXVlc3QgPSB0aGlzLnBheW1lbnRSZXF1ZXN0SWQucGlwZShcbiAgICBmaWx0ZXIoKGlkOiBzdHJpbmcpID0+ICEhaWQpLFxuICAgIGRpc3RpbmN0VW50aWxDaGFuZ2VkKCksXG4gICAgdGFwKCgpID0+IHRoaXMubG9hZGluZy5uZXh0KHRydWUpKSxcbiAgICBzd2l0Y2hNYXAoKGlkOiBzdHJpbmcpID0+IHRoaXMubG9hZFBheW1lbnRSZXF1ZXN0UmVxdWVzdChpZCkpLFxuICAgIHRhcCgoKSA9PiB0aGlzLmVycm9yLm5leHQodW5kZWZpbmVkKSksXG4gICAgY2F0Y2hFcnJvcigoZXJyb3I6IFBheW1lbnRSZXF1ZXN0RXJyb3IpID0+IHtcbiAgICAgIHRoaXMuZXJyb3IubmV4dChlcnJvcik7XG4gICAgICByZXR1cm4gb2YodW5kZWZpbmVkKTtcbiAgICB9KSxcbiAgICB0YXAoKCkgPT4gdGhpcy5sb2FkaW5nLm5leHQoZmFsc2UpKSxcbiAgICBzaGFyZVJlcGxheSgxKSxcbiAgKTtcblxuICBnZXRQYXltZW50UmVxdWVzdEZyb20ocGF5bWVudFJlcXVlc3RJZDogT2JzZXJ2YWJsZTxzdHJpbmc+KSB7XG4gICAgcGF5bWVudFJlcXVlc3RJZC5zdWJzY3JpYmUodGhpcy5wYXltZW50UmVxdWVzdElkKTtcbiAgfVxuXG4gIGFsbG93UGF5bWVudFJlcXVlc3QoYWNjb3VudDogQWNjb3VudCwgdGVtcGxhdGVSZWY6IFRlbXBsYXRlUmVmPGFueT4gfCBzdHJpbmcpOiBPYnNlcnZhYmxlPFJlZGlyZWN0VXJsPiB7XG4gICAgcmV0dXJuIHRoaXMucGF5bWVudFJlcXVlc3QucGlwZShcbiAgICAgIHRha2UoMSksXG4gICAgICBmaWx0ZXIoKHBheW1lbnRSZXF1ZXN0OiBQYXltZW50UmVxdWVzdCB8IHVuZGVmaW5lZCkgPT4gISFwYXltZW50UmVxdWVzdCksXG4gICAgICB0YXAoKCkgPT4gdGhpcy5zYXZpbmcubmV4dCh0cnVlKSksXG4gICAgICBzd2l0Y2hNYXAoKHBheW1lbnRSZXF1ZXN0OiBQYXltZW50UmVxdWVzdCB8IHVuZGVmaW5lZCkgPT4gdGhpcy5hbGxvdyhwYXltZW50UmVxdWVzdCBhcyBQYXltZW50UmVxdWVzdCwgYWNjb3VudCkpLFxuICAgICAgdGFwKCgpID0+IHRoaXMuc2F2aW5nRXJyb3IubmV4dCh1bmRlZmluZWQpKSxcbiAgICAgIGNhdGNoRXJyb3IoKGVycm9yOiBQYXltZW50UmVxdWVzdEVycm9yKSA9PiB0aGlzLmhhbmRsZUVycm9yKGVycm9yLCB0ZW1wbGF0ZVJlZikpLFxuICAgICAgdGFwKCgpID0+IHRoaXMuc2F2aW5nLm5leHQoZmFsc2UpKSxcbiAgICApO1xuICB9XG5cbiAgcmVqZWN0UGF5bWVudFJlcXVlc3QodGVtcGxhdGVSZWY6IFRlbXBsYXRlUmVmPGFueT4gfCBzdHJpbmcpOiBPYnNlcnZhYmxlPFJlZGlyZWN0VXJsPiB7XG4gICAgcmV0dXJuIHRoaXMucGF5bWVudFJlcXVlc3QucGlwZShcbiAgICAgIHRha2UoMSksXG4gICAgICBmaWx0ZXIoKHBheW1lbnRSZXF1ZXN0OiBQYXltZW50UmVxdWVzdCB8IHVuZGVmaW5lZCkgPT4gcGF5bWVudFJlcXVlc3QgIT09IHVuZGVmaW5lZCksXG4gICAgICB0YXAoKCkgPT4gdGhpcy5zYXZpbmcubmV4dCh0cnVlKSksXG4gICAgICBzd2l0Y2hNYXAoKHBheW1lbnRSZXF1ZXN0OiBQYXltZW50UmVxdWVzdCB8IHVuZGVmaW5lZCkgPT4gdGhpcy5yZWplY3QocGF5bWVudFJlcXVlc3QgYXMgUGF5bWVudFJlcXVlc3QpKSxcbiAgICAgIHRhcCgoKSA9PiB0aGlzLnNhdmluZ0Vycm9yLm5leHQodW5kZWZpbmVkKSksXG4gICAgICBjYXRjaEVycm9yKChlcnJvcjogUGF5bWVudFJlcXVlc3RFcnJvcikgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnJvciwgdGVtcGxhdGVSZWYpKSxcbiAgICAgIHRhcCgoKSA9PiB0aGlzLnNhdmluZy5uZXh0KGZhbHNlKSksXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgaGFuZGxlRXJyb3IoZXJyb3I6IFBheW1lbnRSZXF1ZXN0RXJyb3IsIHRlbXBsYXRlUmVmOiBUZW1wbGF0ZVJlZjxhbnk+IHwgc3RyaW5nKSB7XG4gICAgdGhpcy5zYXZpbmdFcnJvci5uZXh0KGVycm9yKTtcbiAgICB0aGlzLm5vdGlmaWNhdGlvbi5zaG93Tm90aWZpY2F0aW9uKHtcbiAgICAgIG1lc3NhZ2U6IHRlbXBsYXRlUmVmLFxuICAgICAgbW9kaWZpZXI6ICdlcnJvcicsXG4gICAgfSk7XG4gICAgcmV0dXJuIG9mKHt9KTtcbiAgfVxuXG4gIHByaXZhdGUgbG9hZFBheW1lbnRSZXF1ZXN0UmVxdWVzdChpZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxQYXltZW50UmVxdWVzdD4ge1xuICAgIHJldHVybiB0aGlzLmNvbnNlbnREYXRhSHR0cFNlcnZpY2UuZ2V0SWRCeUlkZ2V0UGF5bWVudFJlcXVlc3RCeUlkKHsgaWQgfSwgJ3Jlc3BvbnNlJykucGlwZShcbiAgICAgIHBsdWNrPEh0dHBSZXNwb25zZTxQYXltZW50UmVxdWVzdD4sIFBheW1lbnRSZXF1ZXN0PignYm9keScpLFxuICAgICAgY2F0Y2hFcnJvcjxQYXltZW50UmVxdWVzdCwgbmV2ZXI+KChlcnJvcjogSHR0cEVycm9yUmVzcG9uc2UpID0+IHtcbiAgICAgICAgdGhyb3cgcGFyc2VFcnJvcihlcnJvcik7XG4gICAgICB9KSxcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBhbGxvdyhcbiAgICB7IGlkLCBhbGxvd1BheW1lbnRSZWRpcmVjdFVybDogcmVkaXJlY3RVcmwgfTogUGF5bWVudFJlcXVlc3QsXG4gICAgeyBpZDogYWNjb3VudElkIH06IEFjY291bnQsXG4gICk6IE9ic2VydmFibGU8UmVkaXJlY3RVcmw+IHtcbiAgICByZXR1cm4gdGhpcy5jb25zZW50RGF0YUh0dHBTZXJ2aWNlLnBvc3RDb25maXJtQnlJZCh7IGlkLCBwYXltZW50UG9zdDogeyBhY2NvdW50SWQgfSB9KS5waXBlKFxuICAgICAgbWFwKCgpID0+ICh7IHJlZGlyZWN0VXJsIH0pKSxcbiAgICAgIGNhdGNoRXJyb3IoKGVycm9yOiBIdHRwRXJyb3JSZXNwb25zZSkgPT4ge1xuICAgICAgICB0aHJvdyBwYXJzZUVycm9yKGVycm9yKTtcbiAgICAgIH0pLFxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIHJlamVjdCh7IGlkLCByZWplY3RQYXltZW50UmVkaXJlY3RVcmw6IHJlZGlyZWN0VXJsIH06IFBheW1lbnRSZXF1ZXN0KTogT2JzZXJ2YWJsZTxSZWRpcmVjdFVybD4ge1xuICAgIHJldHVybiB0aGlzLmNvbnNlbnREYXRhSHR0cFNlcnZpY2UucG9zdFJlamVjdEJ5SWRwb3N0UmVqZWN0KHsgaWQgfSkucGlwZShcbiAgICAgIG1hcCgoKSA9PiAoeyByZWRpcmVjdFVybCB9KSksXG4gICAgICBjYXRjaEVycm9yKChlcnJvcjogSHR0cEVycm9yUmVzcG9uc2UpID0+IHtcbiAgICAgICAgdGhyb3cgcGFyc2VFcnJvcihlcnJvcik7XG4gICAgICB9KSxcbiAgICApO1xuICB9XG59XG4iXX0=