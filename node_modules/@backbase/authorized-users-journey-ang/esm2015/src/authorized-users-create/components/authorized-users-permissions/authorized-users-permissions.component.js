import { Component, Input } from '@angular/core';
import { AuthorizedPermissionLevel, } from '../../../common/model/authorized-users.model';
import { BaseAuthorizedUsersCreateStep } from '../authorized-users-create-common/base-authorized-users-create-step';
import * as i0 from "@angular/core";
import * as i1 from "./authorized-users-permissions-card.component";
import * as i2 from "@backbase/ui-ang/switch";
import * as i3 from "../../../common/components/permissions-table/permissions-table.component";
import * as i4 from "@angular/forms";
import * as i5 from "../../../common/utils/accessibility-keyboard.directive";
import * as i6 from "@angular/common";
import * as i7 from "@backbase/ui-ang/button";
export class AuthorizedUsersPermissionsComponent extends BaseAuthorizedUsersCreateStep {
    constructor() {
        super(...arguments);
        this.authorizedPermissionLevel = AuthorizedPermissionLevel;
        this._isCustomPermission = false;
    }
    get isCustomPermission() {
        return this._isCustomPermission;
    }
    set isCustomPermission(value) {
        this._isCustomPermission = value;
        this.generalLevel = undefined;
    }
    applyLevelToAccounts(generalLevel) {
        var _a;
        const permissions = (_a = this.authorizedUser.permissions) === null || _a === void 0 ? void 0 : _a.map((permission) => (Object.assign(Object.assign({}, permission), { level: generalLevel || AuthorizedPermissionLevel.VIEW_ONLY })));
        return Object.assign(Object.assign({}, this.authorizedUser), { permissions });
    }
    applyLevelToAccount(permission) {
        const permissions = [...(this.authorizedUser.permissions || [])];
        const index = permissions.findIndex((item) => item.account.id === permission.account.id);
        if (index !== -1) {
            permissions[index] = permission;
        }
        return Object.assign(Object.assign({}, this.authorizedUser), { permissions });
    }
    areTheSameLevel() {
        var _a, _b, _c, _d, _e;
        const level = ((_a = this.authorizedUser) === null || _a === void 0 ? void 0 : _a.permissions) && this.authorizedUser.permissions[0].level;
        const count = ((_c = (_b = this.authorizedUser) === null || _b === void 0 ? void 0 : _b.permissions) === null || _c === void 0 ? void 0 : _c.reduce((prev, curr) => (level === curr.level ? prev + 1 : prev), 0)) || -1;
        return count === ((_e = (_d = this.authorizedUser) === null || _d === void 0 ? void 0 : _d.permissions) === null || _e === void 0 ? void 0 : _e.length);
    }
    setGeneralLevel(level) {
        if (!this.isCustomPermission) {
            this.generalLevel = level;
            this.saveChanges(this.applyLevelToAccounts(this.generalLevel));
        }
    }
    apply() {
        this.goNext(this.authorizedUser);
    }
    updateAccount(permission) {
        this.saveChanges(this.applyLevelToAccount(permission));
    }
    disableCard(level) {
        var _a, _b, _c, _d;
        if (!((_a = this.authorizedUser) === null || _a === void 0 ? void 0 : _a.permissions)) {
            return false;
        }
        const allAccountsSelected = ((_c = (_b = this.authorizedUser) === null || _b === void 0 ? void 0 : _b.permissions) === null || _c === void 0 ? void 0 : _c.length) === ((_d = this.accounts) === null || _d === void 0 ? void 0 : _d.length);
        return !allAccountsSelected && !level.validate();
    }
    togglePermissionMode() {
        if (this.isCustomPermission && this.levelsConfig) {
            this.saveChanges(this.applyLevelToAccounts(this.levelsConfig[0].level));
        }
        else if (this.levelsConfig) {
            this.setGeneralLevel(this.levelsConfig[0].level);
        }
    }
    ngOnInit() {
        super.ngOnInit();
        if (this.areTheSameLevel()) {
            this.generalLevel = this.authorizedUser.permissions && this.authorizedUser.permissions[0].level;
        }
        else {
            this.isCustomPermission = true;
        }
    }
}
AuthorizedUsersPermissionsComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: AuthorizedUsersPermissionsComponent, deps: null, target: i0.ɵɵFactoryTarget.Component });
AuthorizedUsersPermissionsComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "12.0.0", version: "12.2.16", type: AuthorizedUsersPermissionsComponent, selector: "bb-authorized-users-permissions", inputs: { accounts: "accounts" }, usesInheritance: true, ngImport: i0, template: "<form #authorizedUsersPermissionsForm=\"ngForm\" data-role=\"user-permissions-form\">\n  <div class=\"bb-block bb-block--lg\" bbAuthorizedUsersAccessibilityKeyboard>\n    <h2 \n      data-role=\"user-permissions-header\"\n      i18n=\"user permissions selection header@@authorized.users.permissions.header\"\n    >\n      What permissions do you want to give?\n    </h2>\n    <p \n      class=\"bb-text-support text-small\" \n      data-role=\"user-permissions-subHeader\"\n      i18n=\"user permissions selection subHeader@@authorized.users.permissions.subHeader\"\n    >\n      Choose one permission for all selected accounts or different permissions for each account.\n    </p>\n  </div>\n\n  <div class=\"row bb-block bb-block--xl\">\n    <bb-authorized-users-permissions-card\n      *ngFor=\"let permissionLevel of levelsConfig\"\n      class=\"col-lg-4 bb-block bb-block--md-md-down\"\n      [title]=\"permissionLevel.title\"\n      [icon]=\"permissionLevel.icon\"\n      [name]=\"permissionLevel.level\"\n      [currentName]=\"generalLevel\"\n      [disabled]=\"disableCard(permissionLevel)\"\n      [permissionsConfig]=\"permissionsConfig?.permissions\"\n      [permissionsAssigned]=\"permissionLevel.permissionsAssigned\"\n      (click)=\"!disableCard(permissionLevel) && setGeneralLevel(permissionLevel.level)\"\n    >\n    </bb-authorized-users-permissions-card>\n  </div>\n\n  <div class=\"bb-stack bb-block bb-block--xl\">\n    <div class=\"bb-stack__item bb-stack__item--spacing-sm bb-stack__item--align-top\">\n      <bb-switch-ui\n        name=\"customPermissions\"\n        data-role=\"user-permissions-switch\"\n        aria-label=\"Choose different permissions for each account\"\n        [(ngModel)]=\"isCustomPermission\"\n        (click)=\"togglePermissionMode()\"\n      ></bb-switch-ui>\n    </div>\n    <div class=\"bb-stack__item\">\n      <label \n        class=\"bb-switch__label\" \n        data-role=\"user-permissions-switch-label\"\n      >\n        Choose different permissions for each account\n      </label>\n      <div\n        *ngIf=\"!enableAccountLevelFullAccessPermission\"\n        class=\"bb-text-support text-small\"\n        data-role=\"user-permissions-switch-description\"\n        i18n=\"Different permission selection subTitle@@authorized.users.different.permission.subTtitle\"\n      >\n        Keep in mind that you can only give Full Access permissions to all accounts at once.\n    </div>\n   </div>\n  </div>\n\n  <bb-authorized-users-permissions-levels-table\n    *ngIf=\"isCustomPermission\"\n    [isEditing]=\"true\"\n    [enableAccountLevelFullAccessPermission]=\"enableAccountLevelFullAccessPermission\"\n    [selectedAccounts]=\"authorizedUser.permissions\"\n    [levelsConfig]=\"levelsConfig\"\n    (updateAccount)=\"updateAccount($event)\"\n    data-role=\"user-permissions-table\"\n  ></bb-authorized-users-permissions-levels-table>\n\n  <div class=\"bb-button-bar\">    \n    <button \n      bbButton \n      data-role=\"user-permissions-continue-button\"\n      i18n=\"Continue button text@@authorized-users.create.permissions.continue.button\"\n      class=\"bb-button-bar__button\" \n      (click)=\"apply()\"\n    >Continue</button>\n    <button \n      bbButton \n      data-role=\"user-permissions-back-button\"\n      class=\"bb-button-bar__button\"\n      i18n=\"Back button text@@authorized-users.create.permissions.back.button\"\n      color=\"secondary\" \n      (click)=\"goBack()\"\n    >Back</button>\n    <button \n      bbButton \n      data-role=\"user-permissions-cancel-button\"\n      color=\"link\"\n      class=\"bb-button-bar__button bb-button-bar__button--across\"\n      i18n=\"Cancel button text@@authorized-users.create.permissions.cancel.button\"\n      (click)=\"abort()\"\n    >Cancel</button>\n  </div>\n</form>", components: [{ type: i1.AuthorizedUsersPermissionsCardComponent, selector: "bb-authorized-users-permissions-card", inputs: ["icon", "title", "name", "currentName", "permissionsConfig", "permissionsAssigned", "disabled"] }, { type: i2.SwitchComponent, selector: "bb-switch-ui", inputs: ["labelPosition"] }, { type: i3.AuthorizedUsersPermissionsLevelsTableComponent, selector: "bb-authorized-users-permissions-levels-table", inputs: ["selectedAccounts", "isEditing", "enableAccountLevelFullAccessPermission", "levelsConfig"], outputs: ["updateAccount"] }], directives: [{ type: i4.ɵNgNoValidate, selector: "form:not([ngNoForm]):not([ngNativeValidate])" }, { type: i4.NgControlStatusGroup, selector: "[formGroupName],[formArrayName],[ngModelGroup],[formGroup],form:not([ngNoForm]),[ngForm]" }, { type: i4.NgForm, selector: "form:not([ngNoForm]):not([formGroup]),ng-form,[ngForm]", inputs: ["ngFormOptions"], outputs: ["ngSubmit"], exportAs: ["ngForm"] }, { type: i5.AuthorizedUsersAccessibilityKeyboardDirective, selector: "[bbAuthorizedUsersAccessibilityKeyboard]" }, { type: i6.NgForOf, selector: "[ngFor][ngForOf]", inputs: ["ngForOf", "ngForTrackBy", "ngForTemplate"] }, { type: i4.NgControlStatus, selector: "[formControlName],[ngModel],[formControl]" }, { type: i4.NgModel, selector: "[ngModel]:not([formControlName]):not([formControl])", inputs: ["name", "disabled", "ngModel", "ngModelOptions"], outputs: ["ngModelChange"], exportAs: ["ngModel"] }, { type: i6.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { type: i7.ButtonDirective, selector: "button[bbButton]", inputs: ["type", "color", "buttonSize", "block", "circle"] }] });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: AuthorizedUsersPermissionsComponent, decorators: [{
            type: Component,
            args: [{
                    selector: 'bb-authorized-users-permissions',
                    templateUrl: 'authorized-users-permissions.component.html',
                }]
        }], propDecorators: { accounts: [{
                type: Input
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aG9yaXplZC11c2Vycy1wZXJtaXNzaW9ucy5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9saWJzL2F1dGhvcml6ZWQtdXNlcnMtam91cm5leS9zcmMvYXV0aG9yaXplZC11c2Vycy1jcmVhdGUvY29tcG9uZW50cy9hdXRob3JpemVkLXVzZXJzLXBlcm1pc3Npb25zL2F1dGhvcml6ZWQtdXNlcnMtcGVybWlzc2lvbnMuY29tcG9uZW50LnRzIiwiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vbGlicy9hdXRob3JpemVkLXVzZXJzLWpvdXJuZXkvc3JjL2F1dGhvcml6ZWQtdXNlcnMtY3JlYXRlL2NvbXBvbmVudHMvYXV0aG9yaXplZC11c2Vycy1wZXJtaXNzaW9ucy9hdXRob3JpemVkLXVzZXJzLXBlcm1pc3Npb25zLmNvbXBvbmVudC5odG1sIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFVLE1BQU0sZUFBZSxDQUFDO0FBRXpELE9BQU8sRUFFTCx5QkFBeUIsR0FFMUIsTUFBTSw4Q0FBOEMsQ0FBQztBQUN0RCxPQUFPLEVBQUUsNkJBQTZCLEVBQUUsTUFBTSxxRUFBcUUsQ0FBQzs7Ozs7Ozs7O0FBTXBILE1BQU0sT0FBTyxtQ0FBb0MsU0FBUSw2QkFBNkI7SUFKdEY7O1FBT0UsOEJBQXlCLEdBQUcseUJBQXlCLENBQUM7UUFHOUMsd0JBQW1CLEdBQUcsS0FBSyxDQUFDO0tBZ0ZyQztJQTlFQyxJQUFJLGtCQUFrQjtRQUNwQixPQUFPLElBQUksQ0FBQyxtQkFBbUIsQ0FBQztJQUNsQyxDQUFDO0lBRUQsSUFBSSxrQkFBa0IsQ0FBQyxLQUFLO1FBQzFCLElBQUksQ0FBQyxtQkFBbUIsR0FBRyxLQUFLLENBQUM7UUFDakMsSUFBSSxDQUFDLFlBQVksR0FBRyxTQUFTLENBQUM7SUFDaEMsQ0FBQztJQUVPLG9CQUFvQixDQUFDLFlBQW1E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LG9CQUFvQixDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztTQUN6RTthQUFNLElBQUksSUFBSSxDQUFDLFlBQVksRUFBRTtZQUM1QixJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDbEQ7SUFDSCxDQUFDO0lBRUQsUUFBUTtRQUNOLEtBQUssQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUVqQixJQUFJLElBQUksQ0FBQyxlQUFlLEVBQUUsRUFBRTtZQUMxQixJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsV0FBVyxJQUFJLElBQUksQ0FBQyxjQUFjLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQztTQUNqRzthQUFNO1lBQ0wsSUFBSSxDQUFDLGtCQUFrQixHQUFHLElBQUksQ0FBQztTQUNoQztJQUNILENBQUM7O2lJQXJGVSxtQ0FBbUM7cUhBQW5DLG1DQUFtQyxnSUNiaEQsZ3VIQWdHTzs0RkRuRk0sbUNBQW1DO2tCQUovQyxTQUFTO21CQUFDO29CQUNULFFBQVEsRUFBRSxpQ0FBaUM7b0JBQzNDLFdBQVcsRUFBRSw2Q0FBNkM7aUJBQzNEOzhCQUVVLFFBQVE7c0JBQWhCLEtBQUsiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIElucHV0LCBPbkluaXQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEFjY291bnQgfSBmcm9tICcuLi8uLi8uLi9jb21tb24vbW9kZWwvYWNjb3VudC5tb2RlbCc7XG5pbXBvcnQge1xuICBBdXRob3JpemVkUGVybWlzc2lvbixcbiAgQXV0aG9yaXplZFBlcm1pc3Npb25MZXZlbCxcbiAgTGV2ZWxVSUNvbmZpZ0hlYWRlcixcbn0gZnJvbSAnLi4vLi4vLi4vY29tbW9uL21vZGVsL2F1dGhvcml6ZWQtdXNlcnMubW9kZWwnO1xuaW1wb3J0IHsgQmFzZUF1dGhvcml6ZWRVc2Vyc0NyZWF0ZVN0ZXAgfSBmcm9tICcuLi9hdXRob3JpemVkLXVzZXJzLWNyZWF0ZS1jb21tb24vYmFzZS1hdXRob3JpemVkLXVzZXJzLWNyZWF0ZS1zdGVwJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYmItYXV0aG9yaXplZC11c2Vycy1wZXJtaXNzaW9ucycsXG4gIHRlbXBsYXRlVXJsOiAnYXV0aG9yaXplZC11c2Vycy1wZXJtaXNzaW9ucy5jb21wb25lbnQuaHRtbCcsXG59KVxuZXhwb3J0IGNsYXNzIEF1dGhvcml6ZWRVc2Vyc1Blcm1pc3Npb25zQ29tcG9uZW50IGV4dGVuZHMgQmFzZUF1dGhvcml6ZWRVc2Vyc0NyZWF0ZVN0ZXAgaW1wbGVtZW50cyBPbkluaXQge1xuICBASW5wdXQoKSBhY2NvdW50czogQWNjb3VudFtdIHwgdW5kZWZpbmVkO1xuXG4gIGF1dGhvcml6ZWRQZXJtaXNzaW9uTGV2ZWwgPSBBdXRob3JpemVkUGVybWlzc2lvbkxldmVsO1xuICBnZW5lcmFsTGV2ZWw6IEF1dGhvcml6ZWRQZXJtaXNzaW9uTGV2ZWwgfCB1bmRlZmluZWQ7XG5cbiAgcHJpdmF0ZSBfaXNDdXN0b21QZXJtaXNzaW9uID0gZmFsc2U7XG5cbiAgZ2V0IGlzQ3VzdG9tUGVybWlzc2lvbigpIHtcbiAgICByZXR1cm4gdGhpcy5faXNDdXN0b21QZXJtaXNzaW9uO1xuICB9XG5cbiAgc2V0IGlzQ3VzdG9tUGVybWlzc2lvbih2YWx1ZSkge1xuICAgIHRoaXMuX2lzQ3VzdG9tUGVybWlzc2lvbiA9IHZhbHVlO1xuICAgIHRoaXMuZ2VuZXJhbExldmVsID0gdW5kZWZpbmVkO1xuICB9XG5cbiAgcHJpdmF0ZSBhcHBseUxldmVsVG9BY2NvdW50cyhnZW5lcmFsTGV2ZWw6IEF1dGhvcml6ZWRQZXJtaXNzaW9uTGV2ZWwgfCB1bmRlZmluZWQpIHtcbiAgICBjb25zdCBwZXJtaXNzaW9ucyA9IHRoaXMuYXV0aG9yaXplZFVzZXIucGVybWlzc2lvbnM/Lm1hcCgocGVybWlzc2lvbikgPT4gKHtcbiAgICAgIC4uLnBlcm1pc3Npb24sXG4gICAgICBsZXZlbDogZ2VuZXJhbExldmVsIHx8IEF1dGhvcml6ZWRQZXJtaXNzaW9uTGV2ZWwuVklFV19PTkxZLFxuICAgIH0pKTtcblxuICAgIHJldHVybiB7IC4uLnRoaXMuYXV0aG9yaXplZFVzZXIsIHBlcm1pc3Npb25zIH07XG4gIH1cblxuICBwcml2YXRlIGFwcGx5TGV2ZWxUb0FjY291bnQocGVybWlzc2lvbjogQXV0aG9yaXplZFBlcm1pc3Npb24pIHtcbiAgICBjb25zdCBwZXJtaXNzaW9ucyA9IFsuLi4odGhpcy5hdXRob3JpemVkVXNlci5wZXJtaXNzaW9ucyB8fCBbXSldO1xuICAgIGNvbnN0IGluZGV4ID0gcGVybWlzc2lvbnMuZmluZEluZGV4KChpdGVtKSA9PiBpdGVtLmFjY291bnQuaWQgPT09IHBlcm1pc3Npb24uYWNjb3VudC5pZCk7XG5cbiAgICBpZiAoaW5kZXggIT09IC0xKSB7XG4gICAgICBwZXJtaXNzaW9uc1tpbmRleF0gPSBwZXJtaXNzaW9uO1xuICAgIH1cblxuICAgIHJldHVybiB7IC4uLnRoaXMuYXV0aG9yaXplZFVzZXIsIHBlcm1pc3Npb25zIH07XG4gIH1cblxuICBwcml2YXRlIGFyZVRoZVNhbWVMZXZlbCgpIHtcbiAgICBjb25zdCBsZXZlbCA9IHRoaXMuYXV0aG9yaXplZFVzZXI/LnBlcm1pc3Npb25zICYmIHRoaXMuYXV0aG9yaXplZFVzZXIucGVybWlzc2lvbnNbMF0ubGV2ZWw7XG4gICAgY29uc3QgY291bnQgPVxuICAgICAgdGhpcy5hdXRob3JpemVkVXNlcj8ucGVybWlzc2lvbnM/LnJlZHVjZSgocHJldiwgY3VycikgPT4gKGxldmVsID09PSBjdXJyLmxldmVsID8gcHJldiArIDEgOiBwcmV2KSwgMCkgfHwgLTE7XG5cbiAgICByZXR1cm4gY291bnQgPT09IHRoaXMuYXV0aG9yaXplZFVzZXI/LnBlcm1pc3Npb25zPy5sZW5ndGg7XG4gIH1cblxuICBzZXRHZW5lcmFsTGV2ZWwobGV2ZWw6IEF1dGhvcml6ZWRQZXJtaXNzaW9uTGV2ZWwpIHtcbiAgICBpZiAoIXRoaXMuaXNDdXN0b21QZXJtaXNzaW9uKSB7XG4gICAgICB0aGlzLmdlbmVyYWxMZXZlbCA9IGxldmVsO1xuICAgICAgdGhpcy5zYXZlQ2hhbmdlcyh0aGlzLmFwcGx5TGV2ZWxUb0FjY291bnRzKHRoaXMuZ2VuZXJhbExldmVsKSk7XG4gICAgfVxuICB9XG5cbiAgYXBwbHkoKSB7XG4gICAgdGhpcy5nb05leHQodGhpcy5hdXRob3JpemVkVXNlcik7XG4gIH1cblxuICB1cGRhdGVBY2NvdW50KHBlcm1pc3Npb246IEF1dGhvcml6ZWRQZXJtaXNzaW9uKSB7XG4gICAgdGhpcy5zYXZlQ2hhbmdlcyh0aGlzLmFwcGx5TGV2ZWxUb0FjY291bnQocGVybWlzc2lvbikpO1xuICB9XG5cbiAgZGlzYWJsZUNhcmQobGV2ZWw6IExldmVsVUlDb25maWdIZWFkZXI8Ym9vbGVhbltdPikge1xuICAgIGlmICghdGhpcy5hdXRob3JpemVkVXNlcj8ucGVybWlzc2lvbnMpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBjb25zdCBhbGxBY2NvdW50c1NlbGVjdGVkID0gdGhpcy5hdXRob3JpemVkVXNlcj8ucGVybWlzc2lvbnM/Lmxlbmd0aCA9PT0gdGhpcy5hY2NvdW50cz8ubGVuZ3RoO1xuICAgIHJldHVybiAhYWxsQWNjb3VudHNTZWxlY3RlZCAmJiAhbGV2ZWwudmFsaWRhdGUoKTtcbiAgfVxuXG4gIHRvZ2dsZVBlcm1pc3Npb25Nb2RlKCkge1xuICAgIGlmICh0aGlzLmlzQ3VzdG9tUGVybWlzc2lvbiAmJiB0aGlzLmxldmVsc0NvbmZpZykge1xuICAgICAgdGhpcy5zYXZlQ2hhbmdlcyh0aGlzLmFwcGx5TGV2ZWxUb0FjY291bnRzKHRoaXMubGV2ZWxzQ29uZmlnWzBdLmxldmVsKSk7XG4gICAgfSBlbHNlIGlmICh0aGlzLmxldmVsc0NvbmZpZykge1xuICAgICAgdGhpcy5zZXRHZW5lcmFsTGV2ZWwodGhpcy5sZXZlbHNDb25maWdbMF0ubGV2ZWwpO1xuICAgIH1cbiAgfVxuXG4gIG5nT25Jbml0KCkge1xuICAgIHN1cGVyLm5nT25Jbml0KCk7XG5cbiAgICBpZiAodGhpcy5hcmVUaGVTYW1lTGV2ZWwoKSkge1xuICAgICAgdGhpcy5nZW5lcmFsTGV2ZWwgPSB0aGlzLmF1dGhvcml6ZWRVc2VyLnBlcm1pc3Npb25zICYmIHRoaXMuYXV0aG9yaXplZFVzZXIucGVybWlzc2lvbnNbMF0ubGV2ZWw7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuaXNDdXN0b21QZXJtaXNzaW9uID0gdHJ1ZTtcbiAgICB9XG4gIH1cbn1cbiIsIjxmb3JtICNhdXRob3JpemVkVXNlcnNQZXJtaXNzaW9uc0Zvcm09XCJuZ0Zvcm1cIiBkYXRhLXJvbGU9XCJ1c2VyLXBlcm1pc3Npb25zLWZvcm1cIj5cbiAgPGRpdiBjbGFzcz1cImJiLWJsb2NrIGJiLWJsb2NrLS1sZ1wiIGJiQXV0aG9yaXplZFVzZXJzQWNjZXNzaWJpbGl0eUtleWJvYXJkPlxuICAgIDxoMiBcbiAgICAgIGRhdGEtcm9sZT1cInVzZXItcGVybWlzc2lvbnMtaGVhZGVyXCJcbiAgICAgIGkxOG49XCJ1c2VyIHBlcm1pc3Npb25zIHNlbGVjdGlvbiBoZWFkZXJAQGF1dGhvcml6ZWQudXNlcnMucGVybWlzc2lvbnMuaGVhZGVyXCJcbiAgICA+XG4gICAgICBXaGF0IHBlcm1pc3Npb25zIGRvIHlvdSB3YW50IHRvIGdpdmU/XG4gICAgPC9oMj5cbiAgICA8cCBcbiAgICAgIGNsYXNzPVwiYmItdGV4dC1zdXBwb3J0IHRleHQtc21hbGxcIiBcbiAgICAgIGRhdGEtcm9sZT1cInVzZXItcGVybWlzc2lvbnMtc3ViSGVhZGVyXCJcbiAgICAgIGkxOG49XCJ1c2VyIHBlcm1pc3Npb25zIHNlbGVjdGlvbiBzdWJIZWFkZXJAQGF1dGhvcml6ZWQudXNlcnMucGVybWlzc2lvbnMuc3ViSGVhZGVyXCJcbiAgICA+XG4gICAgICBDaG9vc2Ugb25lIHBlcm1pc3Npb24gZm9yIGFsbCBzZWxlY3RlZCBhY2NvdW50cyBvciBkaWZmZXJlbnQgcGVybWlzc2lvbnMgZm9yIGVhY2ggYWNjb3VudC5cbiAgICA8L3A+XG4gIDwvZGl2PlxuXG4gIDxkaXYgY2xhc3M9XCJyb3cgYmItYmxvY2sgYmItYmxvY2stLXhsXCI+XG4gICAgPGJiLWF1dGhvcml6ZWQtdXNlcnMtcGVybWlzc2lvbnMtY2FyZFxuICAgICAgKm5nRm9yPVwibGV0IHBlcm1pc3Npb25MZXZlbCBvZiBsZXZlbHNDb25maWdcIlxuICAgICAgY2xhc3M9XCJjb2wtbGctNCBiYi1ibG9jayBiYi1ibG9jay0tbWQtbWQtZG93blwiXG4gICAgICBbdGl0bGVdPVwicGVybWlzc2lvbkxldmVsLnRpdGxlXCJcbiAgICAgIFtpY29uXT1cInBlcm1pc3Npb25MZXZlbC5pY29uXCJcbiAgICAgIFtuYW1lXT1cInBlcm1pc3Npb25MZXZlbC5sZXZlbFwiXG4gICAgICBbY3VycmVudE5hbWVdPVwiZ2VuZXJhbExldmVsXCJcbiAgICAgIFtkaXNhYmxlZF09XCJkaXNhYmxlQ2FyZChwZXJtaXNzaW9uTGV2ZWwpXCJcbiAgICAgIFtwZXJtaXNzaW9uc0NvbmZpZ109XCJwZXJtaXNzaW9uc0NvbmZpZz8ucGVybWlzc2lvbnNcIlxuICAgICAgW3Blcm1pc3Npb25zQXNzaWduZWRdPVwicGVybWlzc2lvbkxldmVsLnBlcm1pc3Npb25zQXNzaWduZWRcIlxuICAgICAgKGNsaWNrKT1cIiFkaXNhYmxlQ2FyZChwZXJtaXNzaW9uTGV2ZWwpICYmIHNldEdlbmVyYWxMZXZlbChwZXJtaXNzaW9uTGV2ZWwubGV2ZWwpXCJcbiAgICA+XG4gICAgPC9iYi1hdXRob3JpemVkLXVzZXJzLXBlcm1pc3Npb25zLWNhcmQ+XG4gIDwvZGl2PlxuXG4gIDxkaXYgY2xhc3M9XCJiYi1zdGFjayBiYi1ibG9jayBiYi1ibG9jay0teGxcIj5cbiAgICA8ZGl2IGNsYXNzPVwiYmItc3RhY2tfX2l0ZW0gYmItc3RhY2tfX2l0ZW0tLXNwYWNpbmctc20gYmItc3RhY2tfX2l0ZW0tLWFsaWduLXRvcFwiPlxuICAgICAgPGJiLXN3aXRjaC11aVxuICAgICAgICBuYW1lPVwiY3VzdG9tUGVybWlzc2lvbnNcIlxuICAgICAgICBkYXRhLXJvbGU9XCJ1c2VyLXBlcm1pc3Npb25zLXN3aXRjaFwiXG4gICAgICAgIGFyaWEtbGFiZWw9XCJDaG9vc2UgZGlmZmVyZW50IHBlcm1pc3Npb25zIGZvciBlYWNoIGFjY291bnRcIlxuICAgICAgICBbKG5nTW9kZWwpXT1cImlzQ3VzdG9tUGVybWlzc2lvblwiXG4gICAgICAgIChjbGljayk9XCJ0b2dnbGVQZXJtaXNzaW9uTW9kZSgpXCJcbiAgICAgID48L2JiLXN3aXRjaC11aT5cbiAgICA8L2Rpdj5cbiAgICA8ZGl2IGNsYXNzPVwiYmItc3RhY2tfX2l0ZW1cIj5cbiAgICAgIDxsYWJlbCBcbiAgICAgICAgY2xhc3M9XCJiYi1zd2l0Y2hfX2xhYmVsXCIgXG4gICAgICAgIGRhdGEtcm9sZT1cInVzZXItcGVybWlzc2lvbnMtc3dpdGNoLWxhYmVsXCJcbiAgICAgID5cbiAgICAgICAgQ2hvb3NlIGRpZmZlcmVudCBwZXJtaXNzaW9ucyBmb3IgZWFjaCBhY2NvdW50XG4gICAgICA8L2xhYmVsPlxuICAgICAgPGRpdlxuICAgICAgICAqbmdJZj1cIiFlbmFibGVBY2NvdW50TGV2ZWxGdWxsQWNjZXNzUGVybWlzc2lvblwiXG4gICAgICAgIGNsYXNzPVwiYmItdGV4dC1zdXBwb3J0IHRleHQtc21hbGxcIlxuICAgICAgICBkYXRhLXJvbGU9XCJ1c2VyLXBlcm1pc3Npb25zLXN3aXRjaC1kZXNjcmlwdGlvblwiXG4gICAgICAgIGkxOG49XCJEaWZmZXJlbnQgcGVybWlzc2lvbiBzZWxlY3Rpb24gc3ViVGl0bGVAQGF1dGhvcml6ZWQudXNlcnMuZGlmZmVyZW50LnBlcm1pc3Npb24uc3ViVHRpdGxlXCJcbiAgICAgID5cbiAgICAgICAgS2VlcCBpbiBtaW5kIHRoYXQgeW91IGNhbiBvbmx5IGdpdmUgRnVsbCBBY2Nlc3MgcGVybWlzc2lvbnMgdG8gYWxsIGFjY291bnRzIGF0IG9uY2UuXG4gICAgPC9kaXY+XG4gICA8L2Rpdj5cbiAgPC9kaXY+XG5cbiAgPGJiLWF1dGhvcml6ZWQtdXNlcnMtcGVybWlzc2lvbnMtbGV2ZWxzLXRhYmxlXG4gICAgKm5nSWY9XCJpc0N1c3RvbVBlcm1pc3Npb25cIlxuICAgIFtpc0VkaXRpbmddPVwidHJ1ZVwiXG4gICAgW2VuYWJsZUFjY291bnRMZXZlbEZ1bGxBY2Nlc3NQZXJtaXNzaW9uXT1cImVuYWJsZUFjY291bnRMZXZlbEZ1bGxBY2Nlc3NQZXJtaXNzaW9uXCJcbiAgICBbc2VsZWN0ZWRBY2NvdW50c109XCJhdXRob3JpemVkVXNlci5wZXJtaXNzaW9uc1wiXG4gICAgW2xldmVsc0NvbmZpZ109XCJsZXZlbHNDb25maWdcIlxuICAgICh1cGRhdGVBY2NvdW50KT1cInVwZGF0ZUFjY291bnQoJGV2ZW50KVwiXG4gICAgZGF0YS1yb2xlPVwidXNlci1wZXJtaXNzaW9ucy10YWJsZVwiXG4gID48L2JiLWF1dGhvcml6ZWQtdXNlcnMtcGVybWlzc2lvbnMtbGV2ZWxzLXRhYmxlPlxuXG4gIDxkaXYgY2xhc3M9XCJiYi1idXR0b24tYmFyXCI+ICAgIFxuICAgIDxidXR0b24gXG4gICAgICBiYkJ1dHRvbiBcbiAgICAgIGRhdGEtcm9sZT1cInVzZXItcGVybWlzc2lvbnMtY29udGludWUtYnV0dG9uXCJcbiAgICAgIGkxOG49XCJDb250aW51ZSBidXR0b24gdGV4dEBAYXV0aG9yaXplZC11c2Vycy5jcmVhdGUucGVybWlzc2lvbnMuY29udGludWUuYnV0dG9uXCJcbiAgICAgIGNsYXNzPVwiYmItYnV0dG9uLWJhcl9fYnV0dG9uXCIgXG4gICAgICAoY2xpY2spPVwiYXBwbHkoKVwiXG4gICAgPkNvbnRpbnVlPC9idXR0b24+XG4gICAgPGJ1dHRvbiBcbiAgICAgIGJiQnV0dG9uIFxuICAgICAgZGF0YS1yb2xlPVwidXNlci1wZXJtaXNzaW9ucy1iYWNrLWJ1dHRvblwiXG4gICAgICBjbGFzcz1cImJiLWJ1dHRvbi1iYXJfX2J1dHRvblwiXG4gICAgICBpMThuPVwiQmFjayBidXR0b24gdGV4dEBAYXV0aG9yaXplZC11c2Vycy5jcmVhdGUucGVybWlzc2lvbnMuYmFjay5idXR0b25cIlxuICAgICAgY29sb3I9XCJzZWNvbmRhcnlcIiBcbiAgICAgIChjbGljayk9XCJnb0JhY2soKVwiXG4gICAgPkJhY2s8L2J1dHRvbj5cbiAgICA8YnV0dG9uIFxuICAgICAgYmJCdXR0b24gXG4gICAgICBkYXRhLXJvbGU9XCJ1c2VyLXBlcm1pc3Npb25zLWNhbmNlbC1idXR0b25cIlxuICAgICAgY29sb3I9XCJsaW5rXCJcbiAgICAgIGNsYXNzPVwiYmItYnV0dG9uLWJhcl9fYnV0dG9uIGJiLWJ1dHRvbi1iYXJfX2J1dHRvbi0tYWNyb3NzXCJcbiAgICAgIGkxOG49XCJDYW5jZWwgYnV0dG9uIHRleHRAQGF1dGhvcml6ZWQtdXNlcnMuY3JlYXRlLnBlcm1pc3Npb25zLmNhbmNlbC5idXR0b25cIlxuICAgICAgKGNsaWNrKT1cImFib3J0KClcIlxuICAgID5DYW5jZWw8L2J1dHRvbj5cbiAgPC9kaXY+XG48L2Zvcm0+Il19