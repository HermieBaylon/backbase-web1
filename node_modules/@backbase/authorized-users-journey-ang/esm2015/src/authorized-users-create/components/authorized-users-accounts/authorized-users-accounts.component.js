import { Component, Input } from '@angular/core';
import { DEFAULT_ACCOUNT_NUMBER_FORMAT } from '../../../common/constants';
import { AuthorizedPermissionLevel } from '../../../common/model/authorized-users.model';
import { BaseAuthorizedUsersCreateStep } from '../authorized-users-create-common/base-authorized-users-create-step';
import * as i0 from "@angular/core";
import * as i1 from "@backbase/ui-ang/alert";
import * as i2 from "@backbase/ui-ang/checkbox-group";
import * as i3 from "@backbase/ui-ang/input-checkbox";
import * as i4 from "@angular/forms";
import * as i5 from "../../../common/utils/accessibility-keyboard.directive";
import * as i6 from "@angular/common";
import * as i7 from "@backbase/ui-ang/button";
import * as i8 from "@backbase/ui-ang/payment-card-number-pipe";
export class AuthorizedUsersAccountsComponent extends BaseAuthorizedUsersCreateStep {
    constructor() {
        super(...arguments);
        this.model = {};
        this.productNumberFormat = DEFAULT_ACCOUNT_NUMBER_FORMAT;
        this.showError = false;
    }
    save() {
        if (this.hasAccounts()) {
            this.goNext({ permissions: this.cleanPermissions(this.createAuthorizedPermission()) });
        }
        else {
            this.showError = true;
        }
    }
    closeError() {
        this.showError = false;
    }
    cleanPermissions(permissions) {
        const fullAccessPermissions = permissions.filter((permission) => permission.level === AuthorizedPermissionLevel.FULL_ACCESS);
        if (fullAccessPermissions.length > 0 && fullAccessPermissions.length !== this.accounts.length) {
            return permissions.map((permission) => (Object.assign(Object.assign({}, permission), { level: AuthorizedPermissionLevel.VIEW_ONLY })));
        }
        else {
            return [...permissions];
        }
    }
    createAuthorizedPermission() {
        // Every member of the model has the account id as a key
        return Object.keys(this.model)
            .filter((accountId) => !!this.model[accountId])
            .map((accountId) => ({
            account: this.accounts.find((account) => account.id === accountId),
            level: this.setLevelToPermissionByAccount(accountId),
        }));
    }
    setLevelToPermissionByAccount(account) {
        if (this.authorizedUser.permissions) {
            const permission = this.authorizedUser.permissions.find((item) => item.account.id === account);
            return (permission === null || permission === void 0 ? void 0 : permission.level) ? permission.level : AuthorizedPermissionLevel.VIEW_ONLY;
        }
        else {
            return AuthorizedPermissionLevel.VIEW_ONLY;
        }
    }
    ngOnInit() {
        super.ngOnInit();
        this.setPresetPermissions(this.authorizedUser.permissions);
    }
    setPresetPermissions(permissions = []) {
        permissions.forEach((data) => {
            this.model[data.account.id] = true;
        });
    }
    hasAccounts() {
        return Object.keys(this.model).reduce((prev, curr) => (this.model[curr] ? prev + 1 : prev), 0) > 0;
    }
}
AuthorizedUsersAccountsComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: AuthorizedUsersAccountsComponent, deps: null, target: i0.ɵɵFactoryTarget.Component });
AuthorizedUsersAccountsComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "12.0.0", version: "12.2.16", type: AuthorizedUsersAccountsComponent, selector: "bb-authorized-users-accounts", inputs: { accounts: "accounts" }, usesInheritance: true, ngImport: i0, template: "<form \n  #authorizedUsersAccountForm=\"ngForm\" \n  (ngSubmit)=\"save()\" \n  data-role=\"user-accounts-form\"\n>\n  <div class=\"bb-block bb-block--xl\" bbAuthorizedUsersAccessibilityKeyboard>\n    <h2 \n      data-role=\"user-accounts-header\"\n      i18n=\"user accounts selection header@@authorized.users.accounts.header\"\n    >\n      Which accounts will they have access to?\n    </h2>\n    <p \n      class=\"bb-text-support text-small\" \n      data-role=\"user-accounts-subHeader\"\n      i18n=\"user accounts selection subHeader@@authorized.users.accounts.subHeader\"\n    >\n      You will be able to specify permissions for each account in the next step.\n    </p>\n  </div>\n  <bb-alert-ui \n    *ngIf=\"showError\" \n    data-role=\"user-accounts-error-message\"\n    title=\"You need to select at least one account in order to continue\"\n    i18n-title=\"Account Failed Notification|Message for a notification displayed when no accounts are selected@@authorized-users.create.accounts.notification.error\"\n    [dismissible]=\"true\"\n    (closed)=\"closeError()\"\n  ></bb-alert-ui>\n  <ul \n    ngModelGroup=\"list\" \n    class=\"bb-list\"\n  >\n    <li class=\"bb-block bb-block--lg\">\n      <bb-checkbox-group-ui \n        label=\"Select all my accounts\"\n        data-role=\"user-accounts-select-all\"\n      ></bb-checkbox-group-ui>\n    </li>\n    <li *ngFor=\"let item of accounts\" class=\"bb-block bb-block--lg\" data-role=\"user-accounts-list\">\n      <bb-input-checkbox-ui\n        name=\"{{item.id}}\"\n        [(ngModel)]=\"model[item.id]\"\n        data-role=\"user-accounts-account-checkbox\"\n      >\n        <span class=\"bb-stack__item--spacing-sm highlight\" data-role=\"user-accounts-account-name\">{{item.name}}</span>\n        <span *ngIf=\"item.displayNumber\" class=\"bb-text-support\" data-role=\"user-accounts-account-number\">\n          {{ item.displayNumber.slice(item.displayNumber.length-9, item.displayNumber.length) | paymentCardNumber: productNumberFormat }}\n        </span>\n      </bb-input-checkbox-ui>\n    </li>\n  </ul>\n\n  <div class=\"bb-button-bar\">    \n    <button \n      bbButton \n      data-role=\"user-accounts-continue-button\"\n      i18n=\"Continue button text@@authorized-users.create.accounts.continue.button\"\n      class=\"bb-button-bar__button\" \n      type=\"submit\"\n    >Continue</button>\n    <button \n      bbButton \n      data-role=\"user-accounts-back-button\"\n      class=\"bb-button-bar__button\"\n      i18n=\"Back button text@@authorized-users.create.accounts.back.button\"\n      color=\"secondary\" \n      *ngIf=\"!isFirstStep\"\n      (click)=\"goBack()\"\n    >Back</button>\n    <button \n      bbButton \n      data-role=\"user-accounts-cancel-button\"\n      color=\"link\"\n      class=\"bb-button-bar__button bb-button-bar__button--across\"\n      i18n=\"Cancel button text@@authorized-users.accounts.create.cancel.button\"\n      (click)=\"abort()\"\n    >Cancel</button>\n  </div>\n</form>\n", components: [{ type: i1.AlertComponent, selector: "bb-alert-ui", inputs: ["modifier", "dismissible", "title", "message"], outputs: ["close"] }, { type: i2.CheckboxGroupComponent, selector: "bb-checkbox-group-ui" }, { type: i3.InputCheckboxComponent, selector: "bb-input-checkbox-ui", inputs: ["indeterminate"], outputs: ["indeterminateChange"] }], directives: [{ type: i4.ɵNgNoValidate, selector: "form:not([ngNoForm]):not([ngNativeValidate])" }, { type: i4.NgControlStatusGroup, selector: "[formGroupName],[formArrayName],[ngModelGroup],[formGroup],form:not([ngNoForm]),[ngForm]" }, { type: i4.NgForm, selector: "form:not([ngNoForm]):not([formGroup]),ng-form,[ngForm]", inputs: ["ngFormOptions"], outputs: ["ngSubmit"], exportAs: ["ngForm"] }, { type: i5.AuthorizedUsersAccessibilityKeyboardDirective, selector: "[bbAuthorizedUsersAccessibilityKeyboard]" }, { type: i6.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { type: i4.NgModelGroup, selector: "[ngModelGroup]", inputs: ["ngModelGroup"], exportAs: ["ngModelGroup"] }, { type: i6.NgForOf, selector: "[ngFor][ngForOf]", inputs: ["ngForOf", "ngForTrackBy", "ngForTemplate"] }, { type: i4.NgControlStatus, selector: "[formControlName],[ngModel],[formControl]" }, { type: i4.NgModel, selector: "[ngModel]:not([formControlName]):not([formControl])", inputs: ["name", "disabled", "ngModel", "ngModelOptions"], outputs: ["ngModelChange"], exportAs: ["ngModel"] }, { type: i7.ButtonDirective, selector: "button[bbButton]", inputs: ["type", "color", "buttonSize", "block", "circle"] }], pipes: { "paymentCardNumber": i8.PaymentCardNumberPipe } });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: AuthorizedUsersAccountsComponent, decorators: [{
            type: Component,
            args: [{
                    selector: 'bb-authorized-users-accounts',
                    templateUrl: 'authorized-users-accounts.component.html',
                }]
        }], propDecorators: { accounts: [{
                type: Input
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aG9yaXplZC11c2Vycy1hY2NvdW50cy5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9saWJzL2F1dGhvcml6ZWQtdXNlcnMtam91cm5leS9zcmMvYXV0aG9yaXplZC11c2Vycy1jcmVhdGUvY29tcG9uZW50cy9hdXRob3JpemVkLXVzZXJzLWFjY291bnRzL2F1dGhvcml6ZWQtdXNlcnMtYWNjb3VudHMuY29tcG9uZW50LnRzIiwiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vbGlicy9hdXRob3JpemVkLXVzZXJzLWpvdXJuZXkvc3JjL2F1dGhvcml6ZWQtdXNlcnMtY3JlYXRlL2NvbXBvbmVudHMvYXV0aG9yaXplZC11c2Vycy1hY2NvdW50cy9hdXRob3JpemVkLXVzZXJzLWFjY291bnRzLmNvbXBvbmVudC5odG1sIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFVLE1BQU0sZUFBZSxDQUFDO0FBQ3pELE9BQU8sRUFBRSw2QkFBNkIsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBRTFFLE9BQU8sRUFBd0IseUJBQXlCLEVBQUUsTUFBTSw4Q0FBOEMsQ0FBQztBQUMvRyxPQUFPLEVBQUUsNkJBQTZCLEVBQUUsTUFBTSxxRUFBcUUsQ0FBQzs7Ozs7Ozs7OztBQU1wSCxNQUFNLE9BQU8sZ0NBQWlDLFNBQVEsNkJBQTZCO0lBSm5GOztRQU1FLFVBQUssR0FBK0IsRUFBRSxDQUFDO1FBRXZDLHdCQUFtQixHQUFHLDZCQUE2QixDQUFDO1FBQ3BELGNBQVMsR0FBRyxLQUFLLENBQUM7S0EwRG5CO0lBeERDLElBQUk7UUFDRixJQUFJLElBQUksQ0FBQyxXQUFXLEVBQUUsRUFBRTtZQUN0QixJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsV0FBVyxFQUFFLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsMEJBQTBCLEVBQUUsQ0FBQyxFQUFF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Q0FBQyxHQUFHLENBQUMsQ0FBQztJQUNyRyxDQUFDOzs4SEE5RFUsZ0NBQWdDO2tIQUFoQyxnQ0FBZ0MsNkhDVjdDLDg3RkErRUE7NEZEckVhLGdDQUFnQztrQkFKNUMsU0FBUzttQkFBQztvQkFDVCxRQUFRLEVBQUUsOEJBQThCO29CQUN4QyxXQUFXLEVBQUUsMENBQTBDO2lCQUN4RDs4QkFFVSxRQUFRO3NCQUFoQixLQUFLIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBJbnB1dCwgT25Jbml0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBERUZBVUxUX0FDQ09VTlRfTlVNQkVSX0ZPUk1BVCB9IGZyb20gJy4uLy4uLy4uL2NvbW1vbi9jb25zdGFudHMnO1xuaW1wb3J0IHsgQWNjb3VudCB9IGZyb20gJy4uLy4uLy4uL2NvbW1vbi9tb2RlbC9hY2NvdW50Lm1vZGVsJztcbmltcG9ydCB7IEF1dGhvcml6ZWRQZXJtaXNzaW9uLCBBdXRob3JpemVkUGVybWlzc2lvbkxldmVsIH0gZnJvbSAnLi4vLi4vLi4vY29tbW9uL21vZGVsL2F1dGhvcml6ZWQtdXNlcnMubW9kZWwnO1xuaW1wb3J0IHsgQmFzZUF1dGhvcml6ZWRVc2Vyc0NyZWF0ZVN0ZXAgfSBmcm9tICcuLi9hdXRob3JpemVkLXVzZXJzLWNyZWF0ZS1jb21tb24vYmFzZS1hdXRob3JpemVkLXVzZXJzLWNyZWF0ZS1zdGVwJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYmItYXV0aG9yaXplZC11c2Vycy1hY2NvdW50cycsXG4gIHRlbXBsYXRlVXJsOiAnYXV0aG9yaXplZC11c2Vycy1hY2NvdW50cy5jb21wb25lbnQuaHRtbCcsXG59KVxuZXhwb3J0IGNsYXNzIEF1dGhvcml6ZWRVc2Vyc0FjY291bnRzQ29tcG9uZW50IGV4dGVuZHMgQmFzZUF1dGhvcml6ZWRVc2Vyc0NyZWF0ZVN0ZXAgaW1wbGVtZW50cyBPbkluaXQge1xuICBASW5wdXQoKSBhY2NvdW50cyE6IEFjY291bnRbXTtcbiAgbW9kZWw6IHsgW2tleTogc3RyaW5nXTogYm9vbGVhbiB9ID0ge307XG5cbiAgcHJvZHVjdE51bWJlckZvcm1hdCA9IERFRkFVTFRfQUNDT1VOVF9OVU1CRVJfRk9STUFUO1xuICBzaG93RXJyb3IgPSBmYWxzZTtcblxuICBzYXZlKCkge1xuICAgIGlmICh0aGlzLmhhc0FjY291bnRzKCkpIHtcbiAgICAgIHRoaXMuZ29OZXh0KHsgcGVybWlzc2lvbnM6IHRoaXMuY2xlYW5QZXJtaXNzaW9ucyh0aGlzLmNyZWF0ZUF1dGhvcml6ZWRQZXJtaXNzaW9uKCkpIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnNob3dFcnJvciA9IHRydWU7XG4gICAgfVxuICB9XG5cbiAgY2xvc2VFcnJvcigpIHtcbiAgICB0aGlzLnNob3dFcnJvciA9IGZhbHNlO1xuICB9XG5cbiAgcHJpdmF0ZSBjbGVhblBlcm1pc3Npb25zKHBlcm1pc3Npb25zOiBBcnJheTxBdXRob3JpemVkUGVybWlzc2lvbj4pOiBBcnJheTxBdXRob3JpemVkUGVybWlzc2lvbj4ge1xuICAgIGNvbnN0IGZ1bGxBY2Nlc3NQZXJtaXNzaW9ucyA9IHBlcm1pc3Npb25zLmZpbHRlcihcbiAgICAgIChwZXJtaXNzaW9uKSA9PiBwZXJtaXNzaW9uLmxldmVsID09PSBBdXRob3JpemVkUGVybWlzc2lvbkxldmVsLkZVTExfQUNDRVNTLFxuICAgICk7XG4gICAgaWYgKGZ1bGxBY2Nlc3NQZXJtaXNzaW9ucy5sZW5ndGggPiAwICYmIGZ1bGxBY2Nlc3NQZXJtaXNzaW9ucy5sZW5ndGggIT09IHRoaXMuYWNjb3VudHMubGVuZ3RoKSB7XG4gICAgICByZXR1cm4gcGVybWlzc2lvbnMubWFwKChwZXJtaXNzaW9uKSA9PiAoeyAuLi5wZXJtaXNzaW9uLCBsZXZlbDogQXV0aG9yaXplZFBlcm1pc3Npb25MZXZlbC5WSUVXX09OTFkgfSkpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gWy4uLnBlcm1pc3Npb25zXTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUF1dGhvcml6ZWRQZXJtaXNzaW9uKCk6IEFycmF5PEF1dGhvcml6ZWRQZXJtaXNzaW9uPiB7XG4gICAgLy8gRXZlcnkgbWVtYmVyIG9mIHRoZSBtb2RlbCBoYXMgdGhlIGFjY291bnQgaWQgYXMgYSBrZXlcbiAgICByZXR1cm4gT2JqZWN0LmtleXModGhpcy5tb2RlbClcbiAgICAgIC5maWx0ZXIoKGFjY291bnRJZCkgPT4gISF0aGlzLm1vZGVsW2FjY291bnRJZF0pXG4gICAgICAubWFwKChhY2NvdW50SWQpID0+ICh7XG4gICAgICAgIGFjY291bnQ6IHRoaXMuYWNjb3VudHMuZmluZCgoYWNjb3VudCkgPT4gYWNjb3VudC5pZCA9PT0gYWNjb3VudElkKSEsXG4gICAgICAgIGxldmVsOiB0aGlzLnNldExldmVsVG9QZXJtaXNzaW9uQnlBY2NvdW50KGFjY291bnRJZCksXG4gICAgICB9KSk7XG4gIH1cblxuICBwcml2YXRlIHNldExldmVsVG9QZXJtaXNzaW9uQnlBY2NvdW50KGFjY291bnQ6IHN0cmluZyk6IEF1dGhvcml6ZWRQZXJtaXNzaW9uTGV2ZWwge1xuICAgIGlmICh0aGlzLmF1dGhvcml6ZWRVc2VyLnBlcm1pc3Npb25zKSB7XG4gICAgICBjb25zdCBwZXJtaXNzaW9uID0gdGhpcy5hdXRob3JpemVkVXNlci5wZXJtaXNzaW9ucy5maW5kKChpdGVtKSA9PiBpdGVtLmFjY291bnQuaWQgPT09IGFjY291bnQpO1xuICAgICAgcmV0dXJuIHBlcm1pc3Npb24/LmxldmVsID8gcGVybWlzc2lvbi5sZXZlbCA6IEF1dGhvcml6ZWRQZXJtaXNzaW9uTGV2ZWwuVklFV19PTkxZO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gQXV0aG9yaXplZFBlcm1pc3Npb25MZXZlbC5WSUVXX09OTFk7XG4gICAgfVxuICB9XG5cbiAgbmdPbkluaXQoKSB7XG4gICAgc3VwZXIubmdPbkluaXQoKTtcbiAgICB0aGlzLnNldFByZXNldFBlcm1pc3Npb25zKHRoaXMuYXV0aG9yaXplZFVzZXIucGVybWlzc2lvbnMpO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXRQcmVzZXRQZXJtaXNzaW9ucyhwZXJtaXNzaW9uczogQXV0aG9yaXplZFBlcm1pc3Npb25bXSA9IFtdKSB7XG4gICAgcGVybWlzc2lvbnMuZm9yRWFjaCgoZGF0YSkgPT4ge1xuICAgICAgdGhpcy5tb2RlbFtkYXRhLmFjY291bnQuaWRdID0gdHJ1ZTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgaGFzQWNjb3VudHMoKSB7XG4gICAgcmV0dXJuIE9iamVjdC5rZXlzKHRoaXMubW9kZWwpLnJlZHVjZSgocHJldiwgY3VycikgPT4gKHRoaXMubW9kZWxbY3Vycl0gPyBwcmV2ICsgMSA6IHByZXYpLCAwKSA+IDA7XG4gIH1cbn1cbiIsIjxmb3JtIFxuICAjYXV0aG9yaXplZFVzZXJzQWNjb3VudEZvcm09XCJuZ0Zvcm1cIiBcbiAgKG5nU3VibWl0KT1cInNhdmUoKVwiIFxuICBkYXRhLXJvbGU9XCJ1c2VyLWFjY291bnRzLWZvcm1cIlxuPlxuICA8ZGl2IGNsYXNzPVwiYmItYmxvY2sgYmItYmxvY2stLXhsXCIgYmJBdXRob3JpemVkVXNlcnNBY2Nlc3NpYmlsaXR5S2V5Ym9hcmQ+XG4gICAgPGgyIFxuICAgICAgZGF0YS1yb2xlPVwidXNlci1hY2NvdW50cy1oZWFkZXJcIlxuICAgICAgaTE4bj1cInVzZXIgYWNjb3VudHMgc2VsZWN0aW9uIGhlYWRlckBAYXV0aG9yaXplZC51c2Vycy5hY2NvdW50cy5oZWFkZXJcIlxuICAgID5cbiAgICAgIFdoaWNoIGFjY291bnRzIHdpbGwgdGhleSBoYXZlIGFjY2VzcyB0bz9cbiAgICA8L2gyPlxuICAgIDxwIFxuICAgICAgY2xhc3M9XCJiYi10ZXh0LXN1cHBvcnQgdGV4dC1zbWFsbFwiIFxuICAgICAgZGF0YS1yb2xlPVwidXNlci1hY2NvdW50cy1zdWJIZWFkZXJcIlxuICAgICAgaTE4bj1cInVzZXIgYWNjb3VudHMgc2VsZWN0aW9uIHN1YkhlYWRlckBAYXV0aG9yaXplZC51c2Vycy5hY2NvdW50cy5zdWJIZWFkZXJcIlxuICAgID5cbiAgICAgIFlvdSB3aWxsIGJlIGFibGUgdG8gc3BlY2lmeSBwZXJtaXNzaW9ucyBmb3IgZWFjaCBhY2NvdW50IGluIHRoZSBuZXh0IHN0ZXAuXG4gICAgPC9wPlxuICA8L2Rpdj5cbiAgPGJiLWFsZXJ0LXVpIFxuICAgICpuZ0lmPVwic2hvd0Vycm9yXCIgXG4gICAgZGF0YS1yb2xlPVwidXNlci1hY2NvdW50cy1lcnJvci1tZXNzYWdlXCJcbiAgICB0aXRsZT1cIllvdSBuZWVkIHRvIHNlbGVjdCBhdCBsZWFzdCBvbmUgYWNjb3VudCBpbiBvcmRlciB0byBjb250aW51ZVwiXG4gICAgaTE4bi10aXRsZT1cIkFjY291bnQgRmFpbGVkIE5vdGlmaWNhdGlvbnxNZXNzYWdlIGZvciBhIG5vdGlmaWNhdGlvbiBkaXNwbGF5ZWQgd2hlbiBubyBhY2NvdW50cyBhcmUgc2VsZWN0ZWRAQGF1dGhvcml6ZWQtdXNlcnMuY3JlYXRlLmFjY291bnRzLm5vdGlmaWNhdGlvbi5lcnJvclwiXG4gICAgW2Rpc21pc3NpYmxlXT1cInRydWVcIlxuICAgIChjbG9zZWQpPVwiY2xvc2VFcnJvcigpXCJcbiAgPjwvYmItYWxlcnQtdWk+XG4gIDx1bCBcbiAgICBuZ01vZGVsR3JvdXA9XCJsaXN0XCIgXG4gICAgY2xhc3M9XCJiYi1saXN0XCJcbiAgPlxuICAgIDxsaSBjbGFzcz1cImJiLWJsb2NrIGJiLWJsb2NrLS1sZ1wiPlxuICAgICAgPGJiLWNoZWNrYm94LWdyb3VwLXVpIFxuICAgICAgICBsYWJlbD1cIlNlbGVjdCBhbGwgbXkgYWNjb3VudHNcIlxuICAgICAgICBkYXRhLXJvbGU9XCJ1c2VyLWFjY291bnRzLXNlbGVjdC1hbGxcIlxuICAgICAgPjwvYmItY2hlY2tib3gtZ3JvdXAtdWk+XG4gICAgPC9saT5cbiAgICA8bGkgKm5nRm9yPVwibGV0IGl0ZW0gb2YgYWNjb3VudHNcIiBjbGFzcz1cImJiLWJsb2NrIGJiLWJsb2NrLS1sZ1wiIGRhdGEtcm9sZT1cInVzZXItYWNjb3VudHMtbGlzdFwiPlxuICAgICAgPGJiLWlucHV0LWNoZWNrYm94LXVpXG4gICAgICAgIG5hbWU9XCJ7e2l0ZW0uaWR9fVwiXG4gICAgICAgIFsobmdNb2RlbCldPVwibW9kZWxbaXRlbS5pZF1cIlxuICAgICAgICBkYXRhLXJvbGU9XCJ1c2VyLWFjY291bnRzLWFjY291bnQtY2hlY2tib3hcIlxuICAgICAgPlxuICAgICAgICA8c3BhbiBjbGFzcz1cImJiLXN0YWNrX19pdGVtLS1zcGFjaW5nLXNtIGhpZ2hsaWdodFwiIGRhdGEtcm9sZT1cInVzZXItYWNjb3VudHMtYWNjb3VudC1uYW1lXCI+e3tpdGVtLm5hbWV9fTwvc3Bhbj5cbiAgICAgICAgPHNwYW4gKm5nSWY9XCJpdGVtLmRpc3BsYXlOdW1iZXJcIiBjbGFzcz1cImJiLXRleHQtc3VwcG9ydFwiIGRhdGEtcm9sZT1cInVzZXItYWNjb3VudHMtYWNjb3VudC1udW1iZXJcIj5cbiAgICAgICAgICB7eyBpdGVtLmRpc3BsYXlOdW1iZXIuc2xpY2UoaXRlbS5kaXNwbGF5TnVtYmVyLmxlbmd0aC05LCBpdGVtLmRpc3BsYXlOdW1iZXIubGVuZ3RoKSB8IHBheW1lbnRDYXJkTnVtYmVyOiBwcm9kdWN0TnVtYmVyRm9ybWF0IH19XG4gICAgICAgIDwvc3Bhbj5cbiAgICAgIDwvYmItaW5wdXQtY2hlY2tib3gtdWk+XG4gICAgPC9saT5cbiAgPC91bD5cblxuICA8ZGl2IGNsYXNzPVwiYmItYnV0dG9uLWJhclwiPiAgICBcbiAgICA8YnV0dG9uIFxuICAgICAgYmJCdXR0b24gXG4gICAgICBkYXRhLXJvbGU9XCJ1c2VyLWFjY291bnRzLWNvbnRpbnVlLWJ1dHRvblwiXG4gICAgICBpMThuPVwiQ29udGludWUgYnV0dG9uIHRleHRAQGF1dGhvcml6ZWQtdXNlcnMuY3JlYXRlLmFjY291bnRzLmNvbnRpbnVlLmJ1dHRvblwiXG4gICAgICBjbGFzcz1cImJiLWJ1dHRvbi1iYXJfX2J1dHRvblwiIFxuICAgICAgdHlwZT1cInN1Ym1pdFwiXG4gICAgPkNvbnRpbnVlPC9idXR0b24+XG4gICAgPGJ1dHRvbiBcbiAgICAgIGJiQnV0dG9uIFxuICAgICAgZGF0YS1yb2xlPVwidXNlci1hY2NvdW50cy1iYWNrLWJ1dHRvblwiXG4gICAgICBjbGFzcz1cImJiLWJ1dHRvbi1iYXJfX2J1dHRvblwiXG4gICAgICBpMThuPVwiQmFjayBidXR0b24gdGV4dEBAYXV0aG9yaXplZC11c2Vycy5jcmVhdGUuYWNjb3VudHMuYmFjay5idXR0b25cIlxuICAgICAgY29sb3I9XCJzZWNvbmRhcnlcIiBcbiAgICAgICpuZ0lmPVwiIWlzRmlyc3RTdGVwXCJcbiAgICAgIChjbGljayk9XCJnb0JhY2soKVwiXG4gICAgPkJhY2s8L2J1dHRvbj5cbiAgICA8YnV0dG9uIFxuICAgICAgYmJCdXR0b24gXG4gICAgICBkYXRhLXJvbGU9XCJ1c2VyLWFjY291bnRzLWNhbmNlbC1idXR0b25cIlxuICAgICAgY29sb3I9XCJsaW5rXCJcbiAgICAgIGNsYXNzPVwiYmItYnV0dG9uLWJhcl9fYnV0dG9uIGJiLWJ1dHRvbi1iYXJfX2J1dHRvbi0tYWNyb3NzXCJcbiAgICAgIGkxOG49XCJDYW5jZWwgYnV0dG9uIHRleHRAQGF1dGhvcml6ZWQtdXNlcnMuYWNjb3VudHMuY3JlYXRlLmNhbmNlbC5idXR0b25cIlxuICAgICAgKGNsaWNrKT1cImFib3J0KClcIlxuICAgID5DYW5jZWw8L2J1dHRvbj5cbiAgPC9kaXY+XG48L2Zvcm0+XG4iXX0=