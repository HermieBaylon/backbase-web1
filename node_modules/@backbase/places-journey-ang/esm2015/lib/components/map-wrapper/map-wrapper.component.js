import { ChangeDetectionStrategy, Component, EventEmitter, Input, Output, ViewChild, } from '@angular/core';
import * as i0 from "@angular/core";
import * as i1 from "../bb-map-ui/map.component";
import * as i2 from "@angular/common";
export class MapWrapperComponent {
    constructor() {
        /**
         * API key need for the google maps to work.
         */
        this.apiKey = '';
        /**
         * Map config.
         */
        this.config = {};
        /**
         * Map zoom.
         */
        this.mapZoom = 0;
        /**
         * Latitude for the coordinates.
         */
        this.latitude = 0;
        /**
         * Longitude for the coordinates.
         */
        this.longitude = 0;
        /**
         * Info window should be displayed after clicking on marker.
         */
        this.enableInfoWindow = false;
        /**
         * Object to describe the map marker icon.
         */
        this.icons = {};
        /**
         * EventEmitter for triggering a update event.
         */
        this.update = new EventEmitter();
        /**
         * EventEmitter for place selection update event.
         */
        this.selected = new EventEmitter();
        /**
         * EventEmitter for triggering a locate event.
         */
        this.locate = new EventEmitter();
        /**
         * EventEmitter for triggering a mapReady event.
         */
        this.mapReady = new EventEmitter();
        this.markers = [];
    }
    set locations(locations) {
        this.places = locations;
        if (this.mapHelpers) {
            this.drawMarkers();
        }
    }
    set selectedPlaceId(id) {
        this.selectedId = id;
        if (this.mapHelpers) {
            this.drawMarkers();
        }
    }
    getInfoWindowContent(placeId) {
        const wrapperElement = this.template
            .nativeElement;
        const template = wrapperElement.querySelector(`div[data-place-id='${placeId}']`);
        return template ? template.innerHTML : '';
    }
    getDistance(bounds) {
        if (!bounds) {
            return 0;
        }
        return (google.maps.geometry.spherical.computeDistanceBetween(bounds.getNorthEast(), bounds.getSouthWest()) / 1000);
    }
    emitMapUpdate() {
        if (!this.mapHelpers) {
            return;
        }
        const center = this.mapHelpers.getCenter();
        this.update.emit({
            latitude: center.lat(),
            longitude: center.lng(),
            radius: Math.ceil(this.getDistance(this.mapHelpers.getBounds()) / 2),
        });
    }
    setCurrentLocationMarker(location) {
        if (!this.mapHelpers) {
            return;
        }
        this.mapHelpers.createMarker({
            position: location,
            clickable: false,
            icon: this.currentLocationIconOptions,
            locationId: '',
        });
    }
    markerClicklistener(marker, place) {
        const helpers = this.mapHelpers;
        if (this.enableInfoWindow) {
            if (this.infoWindow) {
                this.infoWindow.close();
            }
            const content = this.getInfoWindowContent(place.id);
            this.infoWindow = helpers.createInfoWindow({ content });
            helpers.openInfoWindow(this.infoWindow, marker);
        }
        if (this.mapHelpers) {
            if (marker.locationId === this.selectedId) {
                this.selected.emit({
                    id: '',
                    latitude: 0,
                    longitude: 0,
                });
            }
            else {
                this.selected.emit(this.places.find((location) => location.id === marker.locationId));
            }
        }
    }
    drawMarkers() {
        if (!Array.isArray(this.places)) {
            return;
        }
        // markers that are not needed anymore, should be cleared
        const placeIds = this.places.map((place) => place.id);
        const newMarkerList = [];
        this.markers.forEach((marker) => {
            if (placeIds.includes(marker.locationId)) {
                newMarkerList.push(marker);
            }
            else {
                // eslint-disable-next-line
                marker.setMap(null);
            }
        });
        this.markers = newMarkerList;
        // places markers on map
        this.places.forEach((place) => {
            let marker = this.markers.find((item) => item.locationId === place.id);
            if (marker === undefined) {
                marker = this.createMarker(place);
                this.markers.push(marker);
                marker.addListener('click', () => this.markerClicklistener(marker, place));
            }
            if (this.selectedId && placeIds.includes(this.selectedId)) {
                if (place.id === this.selectedId) {
                    marker.setOpacity(1);
                    marker.setIcon({
                        url: marker.getIcon().url,
                        scaledSize: new google.maps.Size(60, 60),
                    });
                }
                else {
                    marker.setOpacity(0.5);
                    marker.setIcon({
                        url: marker.getIcon().url,
                    });
                }
            }
            else {
                marker.setOpacity(1);
                marker.setIcon({
                    url: marker.getIcon().url,
                });
            }
        });
    }
    createMarker(place) {
        const helpers = this.mapHelpers;
        const position = {
            lat: place.latitude,
            lng: place.longitude,
        };
        // try to find place type icon or try to use fallback icon
        const defaultIcon = this.icons && Object.keys(this.icons).length
            ? this.icons[Object.keys(this.icons)[0]]
            : undefined;
        const iconUrl = place.placeType && this.icons && this.icons[place.placeType]
            ? this.icons[place.placeType]
            : defaultIcon;
        let marker = {
            position,
            locationId: place.id,
            title: $localize `:@@places.map.marker.title:map marker`,
        };
        // if there is no icon at all, use maps default pin
        if (iconUrl) {
            marker = Object.assign(Object.assign({}, marker), {
                icon: {
                    url: iconUrl,
                },
            });
        }
        return helpers.createMarker(marker);
    }
    /**
     * List of locations to be rendered.
     */
    get locations() {
        return this.places || [];
    }
    /**
     * Selected place id.
     */
    get selectedPlaceId() {
        return this.selectedId;
    }
    get options() {
        return {
            center: {
                lat: this.latitude,
                lng: this.longitude,
            },
            zoom: this.mapZoom,
            disableDefaultUI: true,
            zoomControl: true,
            styles: [
                {
                    featureType: 'poi',
                    stylers: [{ visibility: 'off' }],
                },
            ],
        };
    }
    setMapOptions(component) {
        this.mapHelpers = component.mapHelpers;
        this.mapHelpers.setMapOptions({
            mapTypeControlOptions: {
                mapTypeIds: [google.maps.MapTypeId.ROADMAP],
            },
        });
        this.mapHelpers.onMapEvent('idle', () => this.emitMapUpdate());
        this.currentLocationIconOptions = {
            path: google.maps.SymbolPath.CIRCLE,
            fillColor: '#4285F4',
            fillOpacity: 1,
            scale: 6,
            strokeColor: 'white',
            strokeWeight: 2,
        };
        if ('geolocation' in navigator) {
            const helpers = this.mapHelpers;
            navigator.geolocation.getCurrentPosition((location) => {
                const position = {
                    lat: location.coords.latitude,
                    lng: location.coords.longitude,
                };
                helpers.setCenter(position);
                this.setCurrentLocationMarker(position);
                this.locate.emit(position);
            });
        }
        // Everything set, emit that map is ready
        this.mapReady.emit();
    }
    ngOnChanges(changes) {
        if (!this.mapHelpers) {
            return;
        }
        if (changes.latitude || changes.longitude) {
            this.mapHelpers.setCenter({
                lat: changes.latitude ? changes.latitude.currentValue : this.latitude,
                lng: changes.longitude
                    ? changes.longitude.currentValue
                    : this.longitude,
            });
        }
    }
}
MapWrapperComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: MapWrapperComponent, deps: [], target: i0.ɵɵFactoryTarget.Component });
MapWrapperComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "12.0.0", version: "12.2.16", type: MapWrapperComponent, selector: "bb-map-wrapper", inputs: { apiKey: "apiKey", config: "config", mapZoom: "mapZoom", latitude: "latitude", longitude: "longitude", enableInfoWindow: "enableInfoWindow", icons: "icons", locations: "locations", selectedPlaceId: "selectedPlaceId" }, outputs: { update: "update", selected: "selected", locate: "locate", mapReady: "mapReady" }, viewQueries: [{ propertyName: "template", first: true, predicate: ["bbMapInfoWindowContent"], descendants: true }], usesOnChanges: true, ngImport: i0, template: "<bb-map-ui\n  [options]=\"this.options\"\n  [config]=\"this.config\"\n  (mapReady)=\"this.setMapOptions($event)\"\n></bb-map-ui>\n\n<div hidden #bbMapInfoWindowContent>\n  <div [attr.data-place-id]=\"place.id\" *ngFor=\"let place of this.places\">\n    <p class=\"bb-text-semi-bold\">{{ place.name }}</p>\n    <div>\n      {{ place.address?.addressLine1 }}, {{ place.address?.postalCode }}\n      {{ place.address?.addressLine2 }}\n    </div>\n  </div>\n</div>\n", components: [{ type: i1.MapComponent, selector: "bb-map-ui", inputs: ["options", "config"], outputs: ["mapReady"] }], directives: [{ type: i2.NgForOf, selector: "[ngFor][ngForOf]", inputs: ["ngForOf", "ngForTrackBy", "ngForTemplate"] }], changeDetection: i0.ChangeDetectionStrategy.OnPush });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: MapWrapperComponent, decorators: [{
            type: Component,
            args: [{
                    selector: 'bb-map-wrapper',
                    templateUrl: './map-wrapper.component.html',
                    changeDetection: ChangeDetectionStrategy.OnPush,
                }]
        }], propDecorators: { apiKey: [{
                type: Input
            }], config: [{
                type: Input
            }], mapZoom: [{
                type: Input
            }], latitude: [{
                type: Input
            }], longitude: [{
                type: Input
            }], enableInfoWindow: [{
                type: Input
            }], icons: [{
                type: Input
            }], locations: [{
                type: Input
            }], selectedPlaceId: [{
                type: Input
            }], update: [{
                type: Output
            }], selected: [{
                type: Output
            }], locate: [{
                type: Output
            }], mapReady: [{
                type: Output
            }], template: [{
                type: ViewChild,
                args: ['bbMapInfoWindowContent']
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFwLXdyYXBwZXIuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vbGlicy9wbGFjZXMtam91cm5leS9zcmMvbGliL2NvbXBvbmVudHMvbWFwLXdyYXBwZXIvbWFwLXdyYXBwZXIuY29tcG9uZW50LnRzIiwiLi4vLi4vLi4vLi4vLi4vLi4vLi4vbGlicy9wbGFjZXMtam91cm5leS9zcmMvbGliL2NvbXBvbmVudHMvbWFwLXdyYXBwZXIvbWFwLXdyYXBwZXIuY29tcG9uZW50Lmh0bWwiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNMLHVCQUF1QixFQUN2QixTQUFTLEVBRVQsWUFBWSxFQUNaLEtBQUssRUFFTCxNQUFNLEVBRU4sU0FBUyxHQUNWLE1BQU0sZUFBZSxDQUFDOzs7O0FBWXZCLE1BQU0sT0FBTyxtQkFBbUI7SUFMaEM7UUFNRTs7V0FFRztRQUNNLFdBQU0sR0FBRyxFQUFFLENBQUM7UUFDckI7O1dBRUc7UUFDTSxXQUFNLEdBQUcsRUFBRSxDQUFDO1FBQ3JCOztXQUVHO1FBQ00sWUFBTyxHQUFHLENBQUMsQ0FBQztRQUNyQjs7V0FFRztRQUNNLGFBQVEsR0FBRyxDQUFDLENBQUM7UUFDdEI7O1dBRUc7UUFDTSxjQUFTLEdBQUcsQ0FBQyxDQUFDO1FBQ3ZCOztXQUVHO1FBQ00scUJBQWdCLEdBQUcsS0FBSyxDQUFDO1FBQ2xDOztXQUVHO1FBQ00sVUFBSyxHQUF1QixFQUFFLENBQUM7UUFleEM7O1dBRUc7UUFDZ0IsV0FBTSxHQUN2QixJQUFJLFlBQVksRUFBbUIsQ0FBQztRQUN0Qzs7V0FFRztRQUNnQixhQUFRLEdBQ3pCLElBQUksWUFBWSxFQUFhLENBQUM7UUFDaEM7O1dBRUc7UUFDZ0IsV0FBTSxHQUN2QixJQUFJLFlBQVksRUFBNkIsQ0FBQztRQUNoRDs7V0FFRztRQUNnQixhQUFRLEdBQTRCLElBQUksWUFBWSxFQUFFLENBQUM7UUFXMUUsWUFBTyxHQUFhLEVBQUUsQ0FBQztLQWlReEI7SUE1U0MsSUFDSSxTQUFTLENBQUMsU0FBa0I7UUFDOUIsSUFBSSxDQUFDLE1BQU0sR0FBRyxTQUFTLENBQUM7UUFDeEIsSUFBSSxJQUFJLENBQUMsVUFBVSxFQUFFO1lBQ25CLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztTQUNwQjtJQUNILENBQUM7SUFDRCxJQUNJLGVBQWUsQ0FBQyxFQUFzQjtRQUN4QyxJQUFJLENBQUMsVUFBVSxHQUFHLEVBQUUsQ0FBQztRQUNyQixJQUFJLElBQUksQ0FBQyxVQUFVLEVBQUU7WUFDbkIsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO1NBQ3BCO0lBQ0gsQ0FBQztJQWdDTyxvQkFBb0IsQ0FBQyxPQUFlO1FBQzFDLE1BQU0sY0FBYyxHQUE2QixJQUFJLENBQUMsUUFBUzthQUM1RCxhQUFhLENBQUM7UUFDakIsTUFBTSxRQUFRLEdBQUcsY0FBYyxDQUFDLGFBQWEsQ0FDM0Msc0JBQXNCLE9BQU8sSUFBSSxDQUNsQyxDQUFDO1FBQ0YsT0FBTyxRQUFRLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztJQUM1QyxDQUFDO0lBRU8sV0FBVyxDQUNqQixNQUFtRDtRQUVuRCxJQUFJLENBQUMsTUFBTSxFQUFFO1lBQ1gsT0FBTyxDQUFDLENBQUM7U0FDVjtRQUVELE9BQU8sQ0FDTCxNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsc0JBQXNCLENBQ25ELE1BQU0sQ0FBQyxZQUFZLEVBQUUsRUFDckIsTUFBTSxDQUFDLFlBQVksRUFBRSxDQUN0QixHQUFHLElBQUksQ0FDVCxDQUFDO0lBQ0osQ0FBQztJQUVPLGFBQWE7UUFDbkIsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUU7WUFDcEIsT0FBTztTQUNSO1FBRUQsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxTQUFTLEVBQUUsQ0FBQztRQUUzQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQztZQUNmLFFBQVEsRUFBRSxNQUFNLENBQUMsR0FBRyxFQUFFO1lBQ3RCLFNBQVMsRUFBRSxNQUFNLENBQUMsR0FBRyxFQUFFO1lBQ3ZCLE1BQU0sRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUNyRSxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRU8sd0JBQXdCLENBQUMsUUFBbUM7UUFDbEUsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUU7WUFDcEIsT0FBTztTQUNSO1FBRUQsSUFBSSxDQUFDLFVBQVUsQ0FBQyxZQUFZLENBQUM7WUFDM0IsUUFBUSxFQUFFLFFBQVE7WUFDbEIsU0FBUyxFQUFFLEtBQUs7WUFDaEIsSUFBSSxFQUFFLElBQUksQ0FBQywwQkFBMEI7WUFDckMsVUFBVSxFQUFFLEVBQUU7U0FDZixDQUFDLENBQUM7SUFDTCxDQUFDO0lBRU8sbUJBQW1CLENBQUMsTUFBYyxFQUFFLEtBQWdCO1FBQzFELE1BQU0sT0FBTyxHQUFzQixJQUFJLENBQUMsVUFBVSxDQUFDO1FBRW5ELElBQUksSUFBSSxDQUFDLGdCQUFnQixFQUFFO1lBQ3pCLElBQUksSUFBSSxDQUFDLFVBQVUsRUFBRTtnQkFDbkIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLEVBQUUsQ0FBQzthQUN6QjtZQUVELE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDcEQsSUFBSSxDQUFDLFVBQVUsR0FBRyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsRUFBRSxPQUFPLEVBQUUsQ0FBQyxDQUFDO1lBQ3hELE9BQU8sQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxNQUFNLENBQUMsQ0FBQztTQUNqRDtRQUVELElBQUksSUFBSSxDQUFDLFVBQVUsRUFBRTtZQUNuQixJQUFJLE1BQU0sQ0FBQyxVQUFVLEtBQUssSUFBSSxDQUFDLFVBQVUsRUFBRTtnQkFDekMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUM7b0JBQ2pCLEVBQUUsRUFBRSxFQUFFO29CQUNOLFFBQVEsRUFBRSxDQUFDO29CQUNYLFNBQVMsRUFBRSxDQUFDO2lCQUNiLENBQUMsQ0FBQzthQUNKO2lCQUFNO2dCQUNMLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUNOLElBQUksQ0FBQyxNQUFPLENBQUMsSUFBSSxDQUN6QixDQUFDLFFBQVEsRUFBRSxFQUFFLENBQUMsUUFBUSxDQUFDLEVBQUUsS0FBSyxNQUFNLENBQUMsVUFBVSxDQUNoRCxDQUNGLENBQUM7YUFDSDtTQUNGO0lBQ0gsQ0FBQztJQUVPLFdBQVc7UUFDakIsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFO1lBQy9CLE9BQU87U0FDUjtRQUVELHlEQUF5RDtRQUN6RCxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ3RELE1BQU0sYUFBYSxHQUFhLEVBQUUsQ0FBQztRQUNuQyxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDLE1BQU0sRUFBRSxFQUFFO1lBQzlCLElBQUksUUFBUSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLEVBQUU7Z0JBQ3hDLGFBQWEsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7YUFDNUI7aUJBQU07Z0JBQ0wsMkJBQTJCO2dCQUMzQixNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO2FBQ3JCO1FBQ0gsQ0FBQyxDQUFDLENBQUM7UUFDSCxJQUFJLENBQUMsT0FBTyxHQUFHLGFBQWEsQ0FBQztRQUU3Qix3QkFBd0I7UUFDeEIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRTtZQUM1QixJQUFJLE1BQU0sR0FBdUIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQ2hELENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsVUFBVSxLQUFLLEtBQUssQ0FBQyxFQUFFLENBQ3ZDLENBQUM7WUFDRixJQUFJLE1BQU0sS0FBSyxTQUFTLEVBQUU7Z0JBQ3hCLE1BQU0sR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUNsQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztnQkFDMUIsTUFBTSxDQUFDLFdBQVcsQ0FBQyxPQUFPLEVBQUUsR0FBRyxFQUFFLENBQy9CLElBQUksQ0FBQyxtQkFBbUIsQ0FBUyxNQUFNLEVBQUUsS0FBSyxDQUFDLENBQ2hELENBQUM7YUFDSDtZQUVELElBQUksSUFBSSxDQUFDLFVBQVUsSUFBSSxRQUFRLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsRUFBRTtnQkFDekQsSUFBSSxLQUFLLENBQUMsRUFBRSxLQUFLLElBQUksQ0FBQyxVQUFVLEVBQUU7b0JBQ2hDLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQ3JCLE1BQU0sQ0FBQyxPQUFPLENBQUM7d0JBQ2IsR0FBRyxFQUFxQixNQUFNLENBQUMsT0FBTyxFQUFHLENBQUMsR0FBRzt3QkFDN0MsVUFBVSxFQUFFLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQztxQkFDekMsQ0FBQyxDQUFDO2lCQUNKO3FCQUFNO29CQUNMLE1BQU0sQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUM7b0JBQ3ZCLE1BQU0sQ0FBQyxPQUFPLENBQUM7d0JBQ2IsR0FBRyxFQUFxQixNQUFNLENBQUMsT0FBTyxFQUFHLENBQUMsR0FBRztxQkFDOUMsQ0FBQyxDQUFDO2lCQUNKO2FBQ0Y7aUJBQU07Z0JBQ0wsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDckIsTUFBTSxDQUFDLE9BQU8sQ0FBQztvQkFDYixHQUFHLEVBQXFCLE1BQU0sQ0FBQyxPQUFPLEVBQUcsQ0FBQyxHQUFHO2lCQUM5QyxDQUFDLENBQUM7YUFDSjtRQUNILENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVPLFlBQVksQ0FBQyxLQUFnQjtRQUNuQyxNQUFNLE9BQU8sR0FBc0IsSUFBSSxDQUFDLFVBQVUsQ0FBQztRQUVuRCxNQUFNLFFBQVEsR0FBRztZQUNmLEdBQUcsRUFBRSxLQUFLLENBQUMsUUFBUTtZQUNuQixHQUFHLEVBQUUsS0FBSyxDQUFDLFNBQVM7U0FDckIsQ0FBQztRQUVGLDBEQUEwRDtRQUMxRCxNQUFNLFdBQVcsR0FDZixJQUFJLENBQUMsS0FBSyxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLE1BQU07WUFDMUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDeEMsQ0FBQyxDQUFDLFNBQVMsQ0FBQztRQUNoQixNQUFNLE9BQU8sR0FDWCxLQUFLLENBQUMsU0FBUyxJQUFJLElBQUksQ0FBQyxLQUFLLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDO1lBQzFELENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUM7WUFDN0IsQ0FBQyxDQUFDLFdBQVcsQ0FBQztRQUVsQixJQUFJLE1BQU0sR0FBRztZQUNYLFFBQVE7WUFDUixVQUFVLEVBQUUsS0FBSyxDQUFDLEVBQUU7WUFDcEIsS0FBSyxFQUFFLFNBQVMsQ0FBQSx1Q0FBdUM7U0FDeEQsQ0FBQztRQUVGLG1EQUFtRDtRQUNuRCxJQUFJLE9BQU8sRUFBRTtZQUNYLE1BQU0sbUNBQ0QsTUFBTSxHQUNOO2dCQUNELElBQUksRUFBRTtvQkFDSixHQUFHLEVBQUUsT0FBTztpQkFDYjthQUNGLENBQ0YsQ0FBQztTQUNIO1FBRUQsT0FBTyxPQUFPLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ3RDLENBQUM7SUFFRDs7T0FFRztJQUNILElBQUksU0FBUztRQUNYLE9BQU8sSUFBSSxDQUFDLE1BQU0sSUFBSSxFQUFFLENBQUM7SUFDM0IsQ0FBQztJQUVEOztPQUVHO0lBQ0gsSUFBSSxlQUFlO1FBQ2pCLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQztJQUN6QixDQUFDO0lBRUQsSUFBSSxPQUFPO1FBQ1QsT0FBTztZQUNMLE1BQU0sRUFBRTtnQkFDTixHQUFHLEVBQUUsSUFBSSxDQUFDLFFBQVE7Z0JBQ2xCLEdBQUcsRUFBRSxJQUFJLENBQUMsU0FBUzthQUNwQjtZQUNELElBQUksRUFBRSxJQUFJLENBQUMsT0FBTztZQUNsQixnQkFBZ0IsRUFBRSxJQUFJO1lBQ3RCLFdBQVcsRUFBRSxJQUFJO1lBQ2pCLE1BQU0sRUFBRTtnQkFDTjtvQkFDRSxXQUFXLEVBQUUsS0FBSztvQkFDbEIsT0FBTyxFQUFFLENBQUMsRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFFLENBQUM7aUJBQ2pDO2FBQ0Y7U0FDRixDQUFDO0lBQ0osQ0FBQztJQUVELGFBQWEsQ0FBQyxTQUF1QjtRQUNuQyxJQUFJLENBQUMsVUFBVSxHQUFHLFNBQVMsQ0FBQyxVQUFVLENBQUM7UUFDdkMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxhQUFhLENBQUM7WUFDNUIscUJBQXFCLEVBQUU7Z0JBQ3JCLFVBQVUsRUFBRSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQzthQUM1QztTQUNGLENBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDLE1BQU0sRUFBRSxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUMsQ0FBQztRQUUvRCxJQUFJLENBQUMsMEJBQTBCLEdBQUc7WUFDaEMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU07WUFDbkMsU0FBUyxFQUFFLFNBQVM7WUFDcEIsV0FBVyxFQUFFLENBQUM7WUFDZCxLQUFLLEVBQUUsQ0FBQztZQUNSLFdBQVcsRUFBRSxPQUFPO1lBQ3BCLFlBQVksRUFBRSxDQUFDO1NBQ2hCLENBQUM7UUFFRixJQUFJLGFBQWEsSUFBSSxTQUFTLEVBQUU7WUFDOUIsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQztZQUNoQyxTQUFTLENBQUMsV0FBVyxDQUFDLGtCQUFrQixDQUFDLENBQUMsUUFBUSxFQUFFLEVBQUU7Z0JBQ3BELE1BQU0sUUFBUSxHQUFHO29CQUNmLEdBQUcsRUFBRSxRQUFRLENBQUMsTUFBTSxDQUFDLFFBQVE7b0JBQzdCLEdBQUcsRUFBRSxRQUFRLENBQUMsTUFBTSxDQUFDLFNBQVM7aUJBQy9CLENBQUM7Z0JBQ0YsT0FBTyxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsQ0FBQztnQkFDNUIsSUFBSSxDQUFDLHdCQUF3QixDQUFDLFFBQVEsQ0FBQyxDQUFDO2dCQUN4QyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUM3QixDQUFDLENBQUMsQ0FBQztTQUNKO1FBRUQseUNBQXlDO1FBQ3pDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDdkIsQ0FBQztJQUVELFdBQVcsQ0FBQyxPQUFzQjtRQUNoQyxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRTtZQUNwQixPQUFPO1NBQ1I7UUFFRCxJQUFJLE9BQU8sQ0FBQyxRQUFRLElBQUksT0FBTyxDQUFDLFNBQVMsRUFBRTtZQUN6QyxJQUFJLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQztnQkFDeEIsR0FBRyxFQUFFLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUTtnQkFDckUsR0FBRyxFQUFFLE9BQU8sQ0FBQyxTQUFTO29CQUNwQixDQUFDLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxZQUFZO29CQUNoQyxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVM7YUFDbkIsQ0FBQyxDQUFDO1NBQ0o7SUFDSCxDQUFDOztpSEF4VVUsbUJBQW1CO3FHQUFuQixtQkFBbUIsZ2dCQ3RCaEMsZ2RBZUE7NEZET2EsbUJBQW1CO2tCQUwvQixTQUFTO21CQUFDO29CQUNULFFBQVEsRUFBRSxnQkFBZ0I7b0JBQzFCLFdBQVcsRUFBRSw4QkFBOEI7b0JBQzNDLGVBQWUsRUFBRSx1QkFBdUIsQ0FBQyxNQUFNO2lCQUNoRDs4QkFLVSxNQUFNO3NCQUFkLEtBQUs7Z0JBSUcsTUFBTTtzQkFBZCxLQUFLO2dCQUlHLE9BQU87c0JBQWYsS0FBSztnQkFJRyxRQUFRO3NCQUFoQixLQUFLO2dCQUlHLFNBQVM7c0JBQWpCLEtBQUs7Z0JBSUcsZ0JBQWdCO3NCQUF4QixLQUFLO2dCQUlHLEtBQUs7c0JBQWIsS0FBSztnQkFFRixTQUFTO3NCQURaLEtBQUs7Z0JBUUYsZUFBZTtzQkFEbEIsS0FBSztnQkFVYSxNQUFNO3NCQUF4QixNQUFNO2dCQUtZLFFBQVE7c0JBQTFCLE1BQU07Z0JBS1ksTUFBTTtzQkFBeEIsTUFBTTtnQkFLWSxRQUFRO3NCQUExQixNQUFNO2dCQUU4QixRQUFRO3NCQUE1QyxTQUFTO3VCQUFDLHdCQUF3QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENoYW5nZURldGVjdGlvblN0cmF0ZWd5LFxuICBDb21wb25lbnQsXG4gIEVsZW1lbnRSZWYsXG4gIEV2ZW50RW1pdHRlcixcbiAgSW5wdXQsXG4gIE9uQ2hhbmdlcyxcbiAgT3V0cHV0LFxuICBTaW1wbGVDaGFuZ2VzLFxuICBWaWV3Q2hpbGQsXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgTWFwSGVscGVyc1NlcnZpY2UgfSBmcm9tICcuLi8uLi9jb21wb25lbnRzL2JiLW1hcC11aS9tYXAtaGVscGVycy5zZXJ2aWNlJztcbmltcG9ydCB7IE1hcENvbXBvbmVudCwgTWFya2VyIH0gZnJvbSAnLi4vLi4vY29tcG9uZW50cy9iYi1tYXAtdWkvbWFwLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBNYXJrZXJJY29ucywgUGxhY2UsIFBsYWNlSXRlbSB9IGZyb20gJy4uLy4uL21vZGVsL3BsYWNlLW1vZGVsJztcbmltcG9ydCB7IFBsYWNlc0dldFBhcmFtcyB9IGZyb20gJy4uLy4uL21vZGVsL3BsYWNlLXBhcmFtLW1vZGVsJztcblxuZGVjbGFyZSB2YXIgJGxvY2FsaXplOiBhbnk7XG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdiYi1tYXAtd3JhcHBlcicsXG4gIHRlbXBsYXRlVXJsOiAnLi9tYXAtd3JhcHBlci5jb21wb25lbnQuaHRtbCcsXG4gIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoLFxufSlcbmV4cG9ydCBjbGFzcyBNYXBXcmFwcGVyQ29tcG9uZW50IGltcGxlbWVudHMgT25DaGFuZ2VzIHtcbiAgLyoqXG4gICAqIEFQSSBrZXkgbmVlZCBmb3IgdGhlIGdvb2dsZSBtYXBzIHRvIHdvcmsuXG4gICAqL1xuICBASW5wdXQoKSBhcGlLZXkgPSAnJztcbiAgLyoqXG4gICAqIE1hcCBjb25maWcuXG4gICAqL1xuICBASW5wdXQoKSBjb25maWcgPSB7fTtcbiAgLyoqXG4gICAqIE1hcCB6b29tLlxuICAgKi9cbiAgQElucHV0KCkgbWFwWm9vbSA9IDA7XG4gIC8qKlxuICAgKiBMYXRpdHVkZSBmb3IgdGhlIGNvb3JkaW5hdGVzLlxuICAgKi9cbiAgQElucHV0KCkgbGF0aXR1ZGUgPSAwO1xuICAvKipcbiAgICogTG9uZ2l0dWRlIGZvciB0aGUgY29vcmRpbmF0ZXMuXG4gICAqL1xuICBASW5wdXQoKSBsb25naXR1ZGUgPSAwO1xuICAvKipcbiAgICogSW5mbyB3aW5kb3cgc2hvdWxkIGJlIGRpc3BsYXllZCBhZnRlciBjbGlja2luZyBvbiBtYXJrZXIuXG4gICAqL1xuICBASW5wdXQoKSBlbmFibGVJbmZvV2luZG93ID0gZmFsc2U7XG4gIC8qKlxuICAgKiBPYmplY3QgdG8gZGVzY3JpYmUgdGhlIG1hcCBtYXJrZXIgaWNvbi5cbiAgICovXG4gIEBJbnB1dCgpIGljb25zOiBNYXJrZXJJY29ucyB8IG51bGwgPSB7fTtcbiAgQElucHV0KClcbiAgc2V0IGxvY2F0aW9ucyhsb2NhdGlvbnM6IFBsYWNlW10pIHtcbiAgICB0aGlzLnBsYWNlcyA9IGxvY2F0aW9ucztcbiAgICBpZiAodGhpcy5tYXBIZWxwZXJzKSB7XG4gICAgICB0aGlzLmRyYXdNYXJrZXJzKCk7XG4gICAgfVxuICB9XG4gIEBJbnB1dCgpXG4gIHNldCBzZWxlY3RlZFBsYWNlSWQoaWQ6IHN0cmluZyB8IHVuZGVmaW5lZCkge1xuICAgIHRoaXMuc2VsZWN0ZWRJZCA9IGlkO1xuICAgIGlmICh0aGlzLm1hcEhlbHBlcnMpIHtcbiAgICAgIHRoaXMuZHJhd01hcmtlcnMoKTtcbiAgICB9XG4gIH1cbiAgLyoqXG4gICAqIEV2ZW50RW1pdHRlciBmb3IgdHJpZ2dlcmluZyBhIHVwZGF0ZSBldmVudC5cbiAgICovXG4gIEBPdXRwdXQoKSByZWFkb25seSB1cGRhdGU6IEV2ZW50RW1pdHRlcjxQbGFjZXNHZXRQYXJhbXM+ID1cbiAgICBuZXcgRXZlbnRFbWl0dGVyPFBsYWNlc0dldFBhcmFtcz4oKTtcbiAgLyoqXG4gICAqIEV2ZW50RW1pdHRlciBmb3IgcGxhY2Ugc2VsZWN0aW9uIHVwZGF0ZSBldmVudC5cbiAgICovXG4gIEBPdXRwdXQoKSByZWFkb25seSBzZWxlY3RlZDogRXZlbnRFbWl0dGVyPFBsYWNlSXRlbT4gPVxuICAgIG5ldyBFdmVudEVtaXR0ZXI8UGxhY2VJdGVtPigpO1xuICAvKipcbiAgICogRXZlbnRFbWl0dGVyIGZvciB0cmlnZ2VyaW5nIGEgbG9jYXRlIGV2ZW50LlxuICAgKi9cbiAgQE91dHB1dCgpIHJlYWRvbmx5IGxvY2F0ZTogRXZlbnRFbWl0dGVyPGdvb2dsZS5tYXBzLkxhdExuZ0xpdGVyYWw+ID1cbiAgICBuZXcgRXZlbnRFbWl0dGVyPGdvb2dsZS5tYXBzLkxhdExuZ0xpdGVyYWw+KCk7XG4gIC8qKlxuICAgKiBFdmVudEVtaXR0ZXIgZm9yIHRyaWdnZXJpbmcgYSBtYXBSZWFkeSBldmVudC5cbiAgICovXG4gIEBPdXRwdXQoKSByZWFkb25seSBtYXBSZWFkeTogRXZlbnRFbWl0dGVyPHVuZGVmaW5lZD4gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG5cbiAgQFZpZXdDaGlsZCgnYmJNYXBJbmZvV2luZG93Q29udGVudCcpIHRlbXBsYXRlOlxuICAgIHwgRWxlbWVudFJlZjxIVE1MRWxlbWVudD5cbiAgICB8IHVuZGVmaW5lZDtcblxuICBwcml2YXRlIGN1cnJlbnRMb2NhdGlvbkljb25PcHRpb25zOiBnb29nbGUubWFwcy5TeW1ib2wgfCB1bmRlZmluZWQ7XG4gIHByaXZhdGUgbWFwSGVscGVyczogTWFwSGVscGVyc1NlcnZpY2UgfCB1bmRlZmluZWQ7XG5cbiAgc2VsZWN0ZWRJZDogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICBwbGFjZXM6IFBsYWNlW10gfCB1bmRlZmluZWQ7XG4gIG1hcmtlcnM6IE1hcmtlcltdID0gW107XG4gIGluZm9XaW5kb3c6IGdvb2dsZS5tYXBzLkluZm9XaW5kb3cgfCB1bmRlZmluZWQ7XG4gIHByaXZhdGUgZ2V0SW5mb1dpbmRvd0NvbnRlbnQocGxhY2VJZDogc3RyaW5nKSB7XG4gICAgY29uc3Qgd3JhcHBlckVsZW1lbnQgPSAoPEVsZW1lbnRSZWY8SFRNTEVsZW1lbnQ+PnRoaXMudGVtcGxhdGUpXG4gICAgICAubmF0aXZlRWxlbWVudDtcbiAgICBjb25zdCB0ZW1wbGF0ZSA9IHdyYXBwZXJFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoXG4gICAgICBgZGl2W2RhdGEtcGxhY2UtaWQ9JyR7cGxhY2VJZH0nXWBcbiAgICApO1xuICAgIHJldHVybiB0ZW1wbGF0ZSA/IHRlbXBsYXRlLmlubmVySFRNTCA6ICcnO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXREaXN0YW5jZShcbiAgICBib3VuZHM6IGdvb2dsZS5tYXBzLkxhdExuZ0JvdW5kcyB8IG51bGwgfCB1bmRlZmluZWRcbiAgKTogbnVtYmVyIHtcbiAgICBpZiAoIWJvdW5kcykge1xuICAgICAgcmV0dXJuIDA7XG4gICAgfVxuXG4gICAgcmV0dXJuIChcbiAgICAgIGdvb2dsZS5tYXBzLmdlb21ldHJ5LnNwaGVyaWNhbC5jb21wdXRlRGlzdGFuY2VCZXR3ZWVuKFxuICAgICAgICBib3VuZHMuZ2V0Tm9ydGhFYXN0KCksXG4gICAgICAgIGJvdW5kcy5nZXRTb3V0aFdlc3QoKVxuICAgICAgKSAvIDEwMDBcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBlbWl0TWFwVXBkYXRlKCkge1xuICAgIGlmICghdGhpcy5tYXBIZWxwZXJzKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgY2VudGVyID0gdGhpcy5tYXBIZWxwZXJzLmdldENlbnRlcigpO1xuXG4gICAgdGhpcy51cGRhdGUuZW1pdCh7XG4gICAgICBsYXRpdHVkZTogY2VudGVyLmxhdCgpLFxuICAgICAgbG9uZ2l0dWRlOiBjZW50ZXIubG5nKCksXG4gICAgICByYWRpdXM6IE1hdGguY2VpbCh0aGlzLmdldERpc3RhbmNlKHRoaXMubWFwSGVscGVycy5nZXRCb3VuZHMoKSkgLyAyKSxcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgc2V0Q3VycmVudExvY2F0aW9uTWFya2VyKGxvY2F0aW9uOiBnb29nbGUubWFwcy5MYXRMbmdMaXRlcmFsKSB7XG4gICAgaWYgKCF0aGlzLm1hcEhlbHBlcnMpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLm1hcEhlbHBlcnMuY3JlYXRlTWFya2VyKHtcbiAgICAgIHBvc2l0aW9uOiBsb2NhdGlvbixcbiAgICAgIGNsaWNrYWJsZTogZmFsc2UsXG4gICAgICBpY29uOiB0aGlzLmN1cnJlbnRMb2NhdGlvbkljb25PcHRpb25zLFxuICAgICAgbG9jYXRpb25JZDogJycsXG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIG1hcmtlckNsaWNrbGlzdGVuZXIobWFya2VyOiBNYXJrZXIsIHBsYWNlOiBQbGFjZUl0ZW0pIHtcbiAgICBjb25zdCBoZWxwZXJzID0gPE1hcEhlbHBlcnNTZXJ2aWNlPnRoaXMubWFwSGVscGVycztcblxuICAgIGlmICh0aGlzLmVuYWJsZUluZm9XaW5kb3cpIHtcbiAgICAgIGlmICh0aGlzLmluZm9XaW5kb3cpIHtcbiAgICAgICAgdGhpcy5pbmZvV2luZG93LmNsb3NlKCk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGNvbnRlbnQgPSB0aGlzLmdldEluZm9XaW5kb3dDb250ZW50KHBsYWNlLmlkKTtcbiAgICAgIHRoaXMuaW5mb1dpbmRvdyA9IGhlbHBlcnMuY3JlYXRlSW5mb1dpbmRvdyh7IGNvbnRlbnQgfSk7XG4gICAgICBoZWxwZXJzLm9wZW5JbmZvV2luZG93KHRoaXMuaW5mb1dpbmRvdywgbWFya2VyKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5tYXBIZWxwZXJzKSB7XG4gICAgICBpZiAobWFya2VyLmxvY2F0aW9uSWQgPT09IHRoaXMuc2VsZWN0ZWRJZCkge1xuICAgICAgICB0aGlzLnNlbGVjdGVkLmVtaXQoe1xuICAgICAgICAgIGlkOiAnJyxcbiAgICAgICAgICBsYXRpdHVkZTogMCxcbiAgICAgICAgICBsb25naXR1ZGU6IDAsXG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5zZWxlY3RlZC5lbWl0KFxuICAgICAgICAgICg8UGxhY2VbXT50aGlzLnBsYWNlcykuZmluZChcbiAgICAgICAgICAgIChsb2NhdGlvbikgPT4gbG9jYXRpb24uaWQgPT09IG1hcmtlci5sb2NhdGlvbklkXG4gICAgICAgICAgKVxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZHJhd01hcmtlcnMoKSB7XG4gICAgaWYgKCFBcnJheS5pc0FycmF5KHRoaXMucGxhY2VzKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIG1hcmtlcnMgdGhhdCBhcmUgbm90IG5lZWRlZCBhbnltb3JlLCBzaG91bGQgYmUgY2xlYXJlZFxuICAgIGNvbnN0IHBsYWNlSWRzID0gdGhpcy5wbGFjZXMubWFwKChwbGFjZSkgPT4gcGxhY2UuaWQpO1xuICAgIGNvbnN0IG5ld01hcmtlckxpc3Q6IE1hcmtlcltdID0gW107XG4gICAgdGhpcy5tYXJrZXJzLmZvckVhY2goKG1hcmtlcikgPT4ge1xuICAgICAgaWYgKHBsYWNlSWRzLmluY2x1ZGVzKG1hcmtlci5sb2NhdGlvbklkKSkge1xuICAgICAgICBuZXdNYXJrZXJMaXN0LnB1c2gobWFya2VyKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZVxuICAgICAgICBtYXJrZXIuc2V0TWFwKG51bGwpO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHRoaXMubWFya2VycyA9IG5ld01hcmtlckxpc3Q7XG5cbiAgICAvLyBwbGFjZXMgbWFya2VycyBvbiBtYXBcbiAgICB0aGlzLnBsYWNlcy5mb3JFYWNoKChwbGFjZSkgPT4ge1xuICAgICAgbGV0IG1hcmtlcjogTWFya2VyIHwgdW5kZWZpbmVkID0gdGhpcy5tYXJrZXJzLmZpbmQoXG4gICAgICAgIChpdGVtKSA9PiBpdGVtLmxvY2F0aW9uSWQgPT09IHBsYWNlLmlkXG4gICAgICApO1xuICAgICAgaWYgKG1hcmtlciA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIG1hcmtlciA9IHRoaXMuY3JlYXRlTWFya2VyKHBsYWNlKTtcbiAgICAgICAgdGhpcy5tYXJrZXJzLnB1c2gobWFya2VyKTtcbiAgICAgICAgbWFya2VyLmFkZExpc3RlbmVyKCdjbGljaycsICgpID0+XG4gICAgICAgICAgdGhpcy5tYXJrZXJDbGlja2xpc3RlbmVyKDxNYXJrZXI+bWFya2VyLCBwbGFjZSlcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgaWYgKHRoaXMuc2VsZWN0ZWRJZCAmJiBwbGFjZUlkcy5pbmNsdWRlcyh0aGlzLnNlbGVjdGVkSWQpKSB7XG4gICAgICAgIGlmIChwbGFjZS5pZCA9PT0gdGhpcy5zZWxlY3RlZElkKSB7XG4gICAgICAgICAgbWFya2VyLnNldE9wYWNpdHkoMSk7XG4gICAgICAgICAgbWFya2VyLnNldEljb24oe1xuICAgICAgICAgICAgdXJsOiAoPGdvb2dsZS5tYXBzLkljb24+bWFya2VyLmdldEljb24oKSkudXJsLFxuICAgICAgICAgICAgc2NhbGVkU2l6ZTogbmV3IGdvb2dsZS5tYXBzLlNpemUoNjAsIDYwKSxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBtYXJrZXIuc2V0T3BhY2l0eSgwLjUpO1xuICAgICAgICAgIG1hcmtlci5zZXRJY29uKHtcbiAgICAgICAgICAgIHVybDogKDxnb29nbGUubWFwcy5JY29uPm1hcmtlci5nZXRJY29uKCkpLnVybCxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbWFya2VyLnNldE9wYWNpdHkoMSk7XG4gICAgICAgIG1hcmtlci5zZXRJY29uKHtcbiAgICAgICAgICB1cmw6ICg8Z29vZ2xlLm1hcHMuSWNvbj5tYXJrZXIuZ2V0SWNvbigpKS51cmwsXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVNYXJrZXIocGxhY2U6IFBsYWNlSXRlbSkge1xuICAgIGNvbnN0IGhlbHBlcnMgPSA8TWFwSGVscGVyc1NlcnZpY2U+dGhpcy5tYXBIZWxwZXJzO1xuXG4gICAgY29uc3QgcG9zaXRpb24gPSB7XG4gICAgICBsYXQ6IHBsYWNlLmxhdGl0dWRlLFxuICAgICAgbG5nOiBwbGFjZS5sb25naXR1ZGUsXG4gICAgfTtcblxuICAgIC8vIHRyeSB0byBmaW5kIHBsYWNlIHR5cGUgaWNvbiBvciB0cnkgdG8gdXNlIGZhbGxiYWNrIGljb25cbiAgICBjb25zdCBkZWZhdWx0SWNvbiA9XG4gICAgICB0aGlzLmljb25zICYmIE9iamVjdC5rZXlzKHRoaXMuaWNvbnMpLmxlbmd0aFxuICAgICAgICA/IHRoaXMuaWNvbnNbT2JqZWN0LmtleXModGhpcy5pY29ucylbMF1dXG4gICAgICAgIDogdW5kZWZpbmVkO1xuICAgIGNvbnN0IGljb25VcmwgPVxuICAgICAgcGxhY2UucGxhY2VUeXBlICYmIHRoaXMuaWNvbnMgJiYgdGhpcy5pY29uc1twbGFjZS5wbGFjZVR5cGVdXG4gICAgICAgID8gdGhpcy5pY29uc1twbGFjZS5wbGFjZVR5cGVdXG4gICAgICAgIDogZGVmYXVsdEljb247XG5cbiAgICBsZXQgbWFya2VyID0ge1xuICAgICAgcG9zaXRpb24sXG4gICAgICBsb2NhdGlvbklkOiBwbGFjZS5pZCxcbiAgICAgIHRpdGxlOiAkbG9jYWxpemVgOkBAcGxhY2VzLm1hcC5tYXJrZXIudGl0bGU6bWFwIG1hcmtlcmAsXG4gICAgfTtcblxuICAgIC8vIGlmIHRoZXJlIGlzIG5vIGljb24gYXQgYWxsLCB1c2UgbWFwcyBkZWZhdWx0IHBpblxuICAgIGlmIChpY29uVXJsKSB7XG4gICAgICBtYXJrZXIgPSB7XG4gICAgICAgIC4uLm1hcmtlcixcbiAgICAgICAgLi4ue1xuICAgICAgICAgIGljb246IHtcbiAgICAgICAgICAgIHVybDogaWNvblVybCxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfTtcbiAgICB9XG5cbiAgICByZXR1cm4gaGVscGVycy5jcmVhdGVNYXJrZXIobWFya2VyKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBMaXN0IG9mIGxvY2F0aW9ucyB0byBiZSByZW5kZXJlZC5cbiAgICovXG4gIGdldCBsb2NhdGlvbnMoKTogUGxhY2VbXSB7XG4gICAgcmV0dXJuIHRoaXMucGxhY2VzIHx8IFtdO1xuICB9XG5cbiAgLyoqXG4gICAqIFNlbGVjdGVkIHBsYWNlIGlkLlxuICAgKi9cbiAgZ2V0IHNlbGVjdGVkUGxhY2VJZCgpIHtcbiAgICByZXR1cm4gdGhpcy5zZWxlY3RlZElkO1xuICB9XG5cbiAgZ2V0IG9wdGlvbnMoKTogZ29vZ2xlLm1hcHMuTWFwT3B0aW9ucyB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGNlbnRlcjoge1xuICAgICAgICBsYXQ6IHRoaXMubGF0aXR1ZGUsXG4gICAgICAgIGxuZzogdGhpcy5sb25naXR1ZGUsXG4gICAgICB9LFxuICAgICAgem9vbTogdGhpcy5tYXBab29tLFxuICAgICAgZGlzYWJsZURlZmF1bHRVSTogdHJ1ZSwgLy8gYSB3YXkgdG8gcXVpY2tseSBoaWRlIGFsbCBjb250cm9sc1xuICAgICAgem9vbUNvbnRyb2w6IHRydWUsIC8vIGFsbG93IHpvb20gb25seVxuICAgICAgc3R5bGVzOiBbXG4gICAgICAgIHtcbiAgICAgICAgICBmZWF0dXJlVHlwZTogJ3BvaScsXG4gICAgICAgICAgc3R5bGVyczogW3sgdmlzaWJpbGl0eTogJ29mZicgfV0sXG4gICAgICAgIH0sXG4gICAgICBdLFxuICAgIH07XG4gIH1cblxuICBzZXRNYXBPcHRpb25zKGNvbXBvbmVudDogTWFwQ29tcG9uZW50KSB7XG4gICAgdGhpcy5tYXBIZWxwZXJzID0gY29tcG9uZW50Lm1hcEhlbHBlcnM7XG4gICAgdGhpcy5tYXBIZWxwZXJzLnNldE1hcE9wdGlvbnMoe1xuICAgICAgbWFwVHlwZUNvbnRyb2xPcHRpb25zOiB7XG4gICAgICAgIG1hcFR5cGVJZHM6IFtnb29nbGUubWFwcy5NYXBUeXBlSWQuUk9BRE1BUF0sXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgdGhpcy5tYXBIZWxwZXJzLm9uTWFwRXZlbnQoJ2lkbGUnLCAoKSA9PiB0aGlzLmVtaXRNYXBVcGRhdGUoKSk7XG5cbiAgICB0aGlzLmN1cnJlbnRMb2NhdGlvbkljb25PcHRpb25zID0ge1xuICAgICAgcGF0aDogZ29vZ2xlLm1hcHMuU3ltYm9sUGF0aC5DSVJDTEUsXG4gICAgICBmaWxsQ29sb3I6ICcjNDI4NUY0JyxcbiAgICAgIGZpbGxPcGFjaXR5OiAxLFxuICAgICAgc2NhbGU6IDYsXG4gICAgICBzdHJva2VDb2xvcjogJ3doaXRlJyxcbiAgICAgIHN0cm9rZVdlaWdodDogMixcbiAgICB9O1xuXG4gICAgaWYgKCdnZW9sb2NhdGlvbicgaW4gbmF2aWdhdG9yKSB7XG4gICAgICBjb25zdCBoZWxwZXJzID0gdGhpcy5tYXBIZWxwZXJzO1xuICAgICAgbmF2aWdhdG9yLmdlb2xvY2F0aW9uLmdldEN1cnJlbnRQb3NpdGlvbigobG9jYXRpb24pID0+IHtcbiAgICAgICAgY29uc3QgcG9zaXRpb24gPSB7XG4gICAgICAgICAgbGF0OiBsb2NhdGlvbi5jb29yZHMubGF0aXR1ZGUsXG4gICAgICAgICAgbG5nOiBsb2NhdGlvbi5jb29yZHMubG9uZ2l0dWRlLFxuICAgICAgICB9O1xuICAgICAgICBoZWxwZXJzLnNldENlbnRlcihwb3NpdGlvbik7XG4gICAgICAgIHRoaXMuc2V0Q3VycmVudExvY2F0aW9uTWFya2VyKHBvc2l0aW9uKTtcbiAgICAgICAgdGhpcy5sb2NhdGUuZW1pdChwb3NpdGlvbik7XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICAvLyBFdmVyeXRoaW5nIHNldCwgZW1pdCB0aGF0IG1hcCBpcyByZWFkeVxuICAgIHRoaXMubWFwUmVhZHkuZW1pdCgpO1xuICB9XG5cbiAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcykge1xuICAgIGlmICghdGhpcy5tYXBIZWxwZXJzKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKGNoYW5nZXMubGF0aXR1ZGUgfHwgY2hhbmdlcy5sb25naXR1ZGUpIHtcbiAgICAgIHRoaXMubWFwSGVscGVycy5zZXRDZW50ZXIoe1xuICAgICAgICBsYXQ6IGNoYW5nZXMubGF0aXR1ZGUgPyBjaGFuZ2VzLmxhdGl0dWRlLmN1cnJlbnRWYWx1ZSA6IHRoaXMubGF0aXR1ZGUsXG4gICAgICAgIGxuZzogY2hhbmdlcy5sb25naXR1ZGVcbiAgICAgICAgICA/IGNoYW5nZXMubG9uZ2l0dWRlLmN1cnJlbnRWYWx1ZVxuICAgICAgICAgIDogdGhpcy5sb25naXR1ZGUsXG4gICAgICB9KTtcbiAgICB9XG4gIH1cbn1cbiIsIjxiYi1tYXAtdWlcbiAgW29wdGlvbnNdPVwidGhpcy5vcHRpb25zXCJcbiAgW2NvbmZpZ109XCJ0aGlzLmNvbmZpZ1wiXG4gIChtYXBSZWFkeSk9XCJ0aGlzLnNldE1hcE9wdGlvbnMoJGV2ZW50KVwiXG4+PC9iYi1tYXAtdWk+XG5cbjxkaXYgaGlkZGVuICNiYk1hcEluZm9XaW5kb3dDb250ZW50PlxuICA8ZGl2IFthdHRyLmRhdGEtcGxhY2UtaWRdPVwicGxhY2UuaWRcIiAqbmdGb3I9XCJsZXQgcGxhY2Ugb2YgdGhpcy5wbGFjZXNcIj5cbiAgICA8cCBjbGFzcz1cImJiLXRleHQtc2VtaS1ib2xkXCI+e3sgcGxhY2UubmFtZSB9fTwvcD5cbiAgICA8ZGl2PlxuICAgICAge3sgcGxhY2UuYWRkcmVzcz8uYWRkcmVzc0xpbmUxIH19LCB7eyBwbGFjZS5hZGRyZXNzPy5wb3N0YWxDb2RlIH19XG4gICAgICB7eyBwbGFjZS5hZGRyZXNzPy5hZGRyZXNzTGluZTIgfX1cbiAgICA8L2Rpdj5cbiAgPC9kaXY+XG48L2Rpdj5cbiJdfQ==