import { Injectable, Inject } from '@angular/core';
import { HttpResponseType, PaginationType } from '../../model/types';
import { BehaviorSubject, combineLatest, of, ReplaySubject } from 'rxjs';
import { catchError, distinctUntilChanged, map, scan, switchMap, take, tap } from 'rxjs/operators';
import { PUBSUB } from '@backbase/foundation-ang/web-sdk';
import { parseError,
/* eslint-enable */
 } from '../../errors/accounts-overview-service-error';
import * as i0 from "@angular/core";
import * as i1 from "@backbase/data-ang/arrangements";
import * as i2 from "@backbase/ui-ang/notification";
export const bbEventToggleAccountFavoriteUpdate = 'bb.event.toggle-account-favorite.update';
export class ProductSummaryAccountsService {
    constructor(productSummaryDataService, accountDataService, balancesHttpService, notificationService, pubSub) {
        this.productSummaryDataService = productSummaryDataService;
        this.accountDataService = accountDataService;
        this.balancesHttpService = balancesHttpService;
        this.notificationService = notificationService;
        this.pubSub = pubSub;
        this.requestObject = new ReplaySubject(1);
        this.favoriteRequestComplete = new BehaviorSubject(true);
        this.updateError = new BehaviorSubject(undefined);
        this.error = new BehaviorSubject(undefined);
        this.loading = new BehaviorSubject(true);
        this.aggregatedBalancesErrorSubject = new BehaviorSubject(undefined);
        this.aggregatedBalancesError = this.aggregatedBalancesErrorSubject.asObservable();
        this.loadingAggregatedBalancesSubject = new BehaviorSubject(false);
        this.loadingAggregatedBalances = this.loadingAggregatedBalancesSubject.asObservable();
        this.refreshAggregatedBalancesSubject = new BehaviorSubject(false);
        this.accountsList = combineLatest([
            this.requestObject,
            this.favoriteRequestComplete,
        ]).pipe(distinctUntilChanged(), tap(() => this.loading.next(true)), switchMap(([requestObject]) => this.getAccounts(requestObject)), scan((acc, curr) => ({
            count: curr.count,
            items: this.mergeResponses(acc, curr),
            params: curr.params,
        })), tap(() => this.error.next(undefined)), catchError((error) => {
            this.error.next(error);
            return of(undefined);
        }), tap(() => this.loading.next(false)));
        this.aggregatedBalances = combineLatest([
            this.refreshAggregatedBalancesSubject,
        ]).pipe(tap(() => this.loadingAggregatedBalancesSubject.next(true)), switchMap(() => this.getAggregatedBalances()), tap(() => this.loadingAggregatedBalancesSubject.next(false)));
        this.pubSub.subscribe(bbEventToggleAccountFavoriteUpdate, this.retriggerGetAccounts.bind(this));
    }
    getAccountById(arrangementId) {
        return this.accountDataService.getArrangementById({ arrangementId });
    }
    /**
     * Fetches an unmasked attribute for the given `UnmaskedAttributeRequestParams`
     *
     * @param requestParameters
     */
    getUnmaskedAttribute(requestParameters) {
        return this.accountDataService.unmaskedAttribute(requestParameters, 'body', false, {
            httpHeaderAccept: 'text/plain',
        });
    }
    toggleAccountFavorite(body, errorTemplateRef, successTemplateRef) {
        return this.putAccountFavorite(body).pipe(take(1), tap(() => {
            this.showNotification(successTemplateRef, 'success');
            this.updateError.next(undefined);
            this.pubSub.publish(bbEventToggleAccountFavoriteUpdate, undefined);
        }), catchError((error) => {
            this.updateError.next(error);
            this.showNotification(errorTemplateRef, 'error');
            return of(undefined);
        }));
    }
    putAccountFavorite(accountUserPreferences) {
        return this.accountDataService.updateUserPreferences({ accountUserPreferences }).pipe(catchError((error) => {
            throw parseError(error);
        }));
    }
    getAccounts(requestObject) {
        const paginationType = requestObject.paginationType || '';
        const from = requestObject.from || 0;
        const params = Object.assign({}, requestObject);
        delete params.paginationType;
        return this.productSummaryDataService.getArrangementsByBusinessFunction(params, HttpResponseType.RESPONSE).pipe(map(res => this.mapResponseWithCount(res, { from, paginationType })), catchError((error) => {
            throw parseError(error);
        }));
    }
    mapResponseWithCount(response, { from, paginationType }) {
        // eslint-disable-next-line no-null/no-null
        if (response.body === null) {
            throw new Error();
        }
        const headerCount = response.headers ? response.headers.get('x-total-count') : undefined;
        const counter = headerCount ? parseInt(headerCount, 10) : response.body.length || 0;
        return {
            count: counter,
            items: response.body || [],
            params: { from, paginationType },
        };
    }
    mergeResponses(acc, current) {
        if (acc &&
            acc.items &&
            current &&
            current.items &&
            acc.params.paginationType === PaginationType.LOAD_MORE &&
            current.params.from !== 0) {
            return [...acc.items, ...current.items];
        }
        return current.items;
    }
    showNotification(templateRef, modifier) {
        this.notificationService.showNotification({
            header: templateRef,
            modifier,
            message: '',
        });
    }
    getAccountsFrom(requestObject) {
        requestObject.subscribe(this.requestObject);
    }
    refreshAggregatedBalances() {
        this.refreshAggregatedBalancesSubject.next(true);
    }
    getAggregatedBalances() {
        const requestParameters = {};
        return this.balancesHttpService.getAggregations(requestParameters).pipe(map(response => this.mapResponseToAggregatedBalances(response)), tap(() => this.aggregatedBalancesErrorSubject.next(undefined)), catchError(error => this.parseAggregatedBalanceError(error)));
    }
    mapResponseToAggregatedBalances(aggregations) {
        const allBalances = (aggregations || [{}])[0];
        return allBalances && allBalances.aggregatedBalances;
    }
    parseAggregatedBalanceError(error) {
        this.aggregatedBalancesErrorSubject.next(error);
        return of(undefined);
    }
    retriggerGetAccounts() {
        this.favoriteRequestComplete.next(true);
    }
}
ProductSummaryAccountsService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: ProductSummaryAccountsService, deps: [{ token: i1.ProductSummaryHttpService }, { token: i1.ArrangementsHttpService }, { token: i1.BalancesHttpService }, { token: i2.NotificationService }, { token: PUBSUB }], target: i0.ɵɵFactoryTarget.Injectable });
ProductSummaryAccountsService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: ProductSummaryAccountsService });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: ProductSummaryAccountsService, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.ProductSummaryHttpService }, { type: i1.ArrangementsHttpService }, { type: i1.BalancesHttpService }, { type: i2.NotificationService }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [PUBSUB]
                }] }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvZHVjdC1zdW1tYXJ5LWFjY291bnRzLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9saWJzL3Byb2R1Y3Qtc3VtbWFyeS1jb21tb24tYW5nL3NyYy9zZXJ2aWNlcy9hY2NvdW50cy9wcm9kdWN0LXN1bW1hcnktYWNjb3VudHMuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFlLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQVVoRSxPQUFPLEVBQXNDLGdCQUFnQixFQUFFLGNBQWMsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ3pHLE9BQU8sRUFBRSxlQUFlLEVBQUUsYUFBYSxFQUFjLEVBQUUsRUFBRSxhQUFhLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDckYsT0FBTyxFQUFFLFVBQVUsRUFBRSxvQkFBb0IsRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFbkcsT0FBTyxFQUFVLE1BQU0sRUFBRSxNQUFNLGtDQUFrQyxDQUFDO0FBR2xFLE9BQU8sRUFFTCxVQUFVO0FBV1YsbUJBQW1CO0VBQ3BCLE1BQU0sOENBQThDLENBQUM7Ozs7QUFFdEQsTUFBTSxDQUFDLE1BQU0sa0NBQWtDLEdBQUcseUNBQXlDLENBQUM7QUFHNUYsTUFBTSxPQUFPLDZCQUE2QjtJQUN4QyxZQUNtQix5QkFBb0QsRUFDcEQsa0JBQTJDLEVBQzNDLG1CQUF3QyxFQUN4QyxtQkFBd0MsRUFDeEIsTUFBYztRQUo5Qiw4QkFBeUIsR0FBekIseUJBQXlCLENBQTJCO1FBQ3BELHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBeUI7UUFDM0Msd0JBQW1CLEdBQW5CLG1CQUFtQixDQUFxQjtRQUN4Qyx3QkFBbUIsR0FBbkIsbUJBQW1CLENBQXFCO1FBQ3hCLFdBQU0sR0FBTixNQUFNLENBQVE7UUFL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QyxFQUMvRCxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLDhCQUE4QixDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUM5RCxVQUFVLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsMkJBQTJCLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FDN0QsQ0FBQztJQUNKLENBQUM7SUFFTywrQkFBK0IsQ0FBQyxZQUFrQztRQUN4RSxNQUFNLFdBQVcsR0FBRyxDQUFDLFlBQVksSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDOUMsT0FBTyxXQUFXLElBQUksV0FBVyxDQUFDLGtCQUFrQixDQUFDO0lBQ3ZELENBQUM7SUFFTywyQkFBMkIsQ0FBQyxLQUF3QjtRQUMxRCxJQUFJLENBQUMsOEJBQThCLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ2hELE9BQU8sRUFBRSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQ3ZCLENBQUM7SUFFTyxvQkFBb0I7UUFDMUIsSUFBSSxDQUFDLHVCQUF1QixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUMxQyxDQUFDOzsySEFwTFUsNkJBQTZCLHdLQU05QixNQUFNOytIQU5MLDZCQUE2Qjs0RkFBN0IsNkJBQTZCO2tCQUR6QyxVQUFVOzswQkFPTixNQUFNOzJCQUFDLE1BQU0iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBUZW1wbGF0ZVJlZiwgSW5qZWN0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1xuICBQcm9kdWN0U3VtbWFyeUh0dHBTZXJ2aWNlLFxuICBBcnJhbmdlbWVudHNIdHRwU2VydmljZSxcbiAgQmFsYW5jZXNIdHRwU2VydmljZSxcbiAgQWNjb3VudFVzZXJQcmVmZXJlbmNlcyxcbiAgQWdncmVnYXRlZEJhbGFuY2VzLFxuICBVbm1hc2tlZEF0dHJpYnV0ZVJlcXVlc3RQYXJhbXMsXG59IGZyb20gJ0BiYWNrYmFzZS9kYXRhLWFuZy9hcnJhbmdlbWVudHMnO1xuaW1wb3J0IHsgTm90aWZpY2F0aW9uU2VydmljZSB9IGZyb20gJ0BiYWNrYmFzZS91aS1hbmcvbm90aWZpY2F0aW9uJztcbmltcG9ydCB7IEFjY291bnRzLCBHZXRQcm9kdWN0c3VtbWFyeVJlcXVlc3QsIEh0dHBSZXNwb25zZVR5cGUsIFBhZ2luYXRpb25UeXBlIH0gZnJvbSAnLi4vLi4vbW9kZWwvdHlwZXMnO1xuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0LCBjb21iaW5lTGF0ZXN0LCBPYnNlcnZhYmxlLCBvZiwgUmVwbGF5U3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgY2F0Y2hFcnJvciwgZGlzdGluY3RVbnRpbENoYW5nZWQsIG1hcCwgc2Nhbiwgc3dpdGNoTWFwLCB0YWtlLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBIdHRwRXJyb3JSZXNwb25zZSwgSHR0cFJlc3BvbnNlIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHsgUHVic3ViLCBQVUJTVUIgfSBmcm9tICdAYmFja2Jhc2UvZm91bmRhdGlvbi1hbmcvd2ViLXNkayc7XG5pbXBvcnQgeyBBY2NvdW50QWdncmVnYXRlZEJhbGFuY2VDdXJyZW5jeSB9IGZyb20gJ0BiYWNrYmFzZS9kYXRhLWFuZy9hcnJhbmdlbWVudHMnO1xuaW1wb3J0IHsgQWNjb3VudEFycmFuZ2VtZW50SXRlbSwgUHJvZHVjdFN1bW1hcnlJdGVtIH0gZnJvbSAnLi4vLi4vbW9kZWwvcHJvZHVjdC1zdW1tYXJ5LXR5cGVzJztcbmltcG9ydCB7XG4gIEFjY291bnRzT3ZlcnZpZXdFcnJvcixcbiAgcGFyc2VFcnJvcixcbiAgLyoqXG4gICAqIHRoZXNlIHVudXNlZCBpbXBvcnRzIGhlcmUgYmVjYXVzZSBvZiBpc3N1ZSBpbiBhcGktZXh0cmFjdG9yXG4gICAqIGlzc3VlOiBodHRwczovL2dpdGh1Yi5jb20vbWljcm9zb2Z0L3J1c2hzdGFjay9pc3N1ZXMvMjE0MFxuICAgKi9cbiAgLyogZXNsaW50LWRpc2FibGUgQHR5cGVzY3JpcHQtZXNsaW50L25vLXVudXNlZC12YXJzLG5vLXVudXNlZC12YXJzICovXG4gIEFjY291bnRzT3ZlcnZpZXdBY2Nlc3NEZW5pZWQsXG4gIEFjY291bnRzT3ZlcnZpZXdCYWRSZXF1ZXN0LFxuICBBY2NvdW50c092ZXJ2aWV3Tm90Rm91bmQsXG4gIEFjY291bnRzT3ZlcnZpZXdDb25uZWN0aXZpdHlFcnJvcixcbiAgQWNjb3VudHNPdmVydmlld1Vua25vd25FcnJvcixcbiAgLyogZXNsaW50LWVuYWJsZSAqL1xufSBmcm9tICcuLi8uLi9lcnJvcnMvYWNjb3VudHMtb3ZlcnZpZXctc2VydmljZS1lcnJvcic7XG5cbmV4cG9ydCBjb25zdCBiYkV2ZW50VG9nZ2xlQWNjb3VudEZhdm9yaXRlVXBkYXRlID0gJ2JiLmV2ZW50LnRvZ2dsZS1hY2NvdW50LWZhdm9yaXRlLnVwZGF0ZSc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBQcm9kdWN0U3VtbWFyeUFjY291bnRzU2VydmljZSB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgcHJvZHVjdFN1bW1hcnlEYXRhU2VydmljZTogUHJvZHVjdFN1bW1hcnlIdHRwU2VydmljZSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGFjY291bnREYXRhU2VydmljZTogQXJyYW5nZW1lbnRzSHR0cFNlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSBiYWxhbmNlc0h0dHBTZXJ2aWNlOiBCYWxhbmNlc0h0dHBTZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgbm90aWZpY2F0aW9uU2VydmljZTogTm90aWZpY2F0aW9uU2VydmljZSxcbiAgICBASW5qZWN0KFBVQlNVQikgcHJpdmF0ZSByZWFkb25seSBwdWJTdWI6IFB1YnN1YixcbiAgKSB7XG4gICAgdGhpcy5wdWJTdWIuc3Vic2NyaWJlKGJiRXZlbnRUb2dnbGVBY2NvdW50RmF2b3JpdGVVcGRhdGUsIHRoaXMucmV0cmlnZ2VyR2V0QWNjb3VudHMuYmluZCh0aGlzKSk7XG4gIH1cblxuICBwcml2YXRlIHJlYWRvbmx5IHJlcXVlc3RPYmplY3QgPSBuZXcgUmVwbGF5U3ViamVjdDxHZXRQcm9kdWN0c3VtbWFyeVJlcXVlc3Q+KDEpO1xuICBwcml2YXRlIHJlYWRvbmx5IGZhdm9yaXRlUmVxdWVzdENvbXBsZXRlID0gbmV3IEJlaGF2aW9yU3ViamVjdDxib29sZWFuPih0cnVlKTtcbiAgcmVhZG9ubHkgdXBkYXRlRXJyb3I6IEJlaGF2aW9yU3ViamVjdDxBY2NvdW50c092ZXJ2aWV3RXJyb3IgfCB1bmRlZmluZWQ+ID0gbmV3IEJlaGF2aW9yU3ViamVjdDxcbiAgICBBY2NvdW50c092ZXJ2aWV3RXJyb3IgfCB1bmRlZmluZWRcbiAgPih1bmRlZmluZWQpO1xuICByZWFkb25seSBlcnJvcjogQmVoYXZpb3JTdWJqZWN0PEFjY291bnRzT3ZlcnZpZXdFcnJvciB8IHVuZGVmaW5lZD4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0PFxuICAgIEFjY291bnRzT3ZlcnZpZXdFcnJvciB8IHVuZGVmaW5lZFxuICA+KHVuZGVmaW5lZCk7XG4gIHJlYWRvbmx5IGxvYWRpbmcgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PGJvb2xlYW4+KHRydWUpO1xuICBwcml2YXRlIHJlYWRvbmx5IGFnZ3JlZ2F0ZWRCYWxhbmNlc0Vycm9yU3ViamVjdCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8SHR0cEVycm9yUmVzcG9uc2UgfCB1bmRlZmluZWQ+KHVuZGVmaW5lZCk7XG4gIHJlYWRvbmx5IGFnZ3JlZ2F0ZWRCYWxhbmNlc0Vycm9yID0gdGhpcy5hZ2dyZWdhdGVkQmFsYW5jZXNFcnJvclN1YmplY3QuYXNPYnNlcnZhYmxlKCk7XG4gIHByaXZhdGUgcmVhZG9ubHkgbG9hZGluZ0FnZ3JlZ2F0ZWRCYWxhbmNlc1N1YmplY3QgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PGJvb2xlYW4+KGZhbHNlKTtcbiAgcmVhZG9ubHkgbG9hZGluZ0FnZ3JlZ2F0ZWRCYWxhbmNlcyA9IHRoaXMubG9hZGluZ0FnZ3JlZ2F0ZWRCYWxhbmNlc1N1YmplY3QuYXNPYnNlcnZhYmxlKCk7XG4gIHByaXZhdGUgcmVhZG9ubHkgcmVmcmVzaEFnZ3JlZ2F0ZWRCYWxhbmNlc1N1YmplY3QgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PGJvb2xlYW4+KGZhbHNlKTtcblxuICByZWFkb25seSBhY2NvdW50c0xpc3Q6IE9ic2VydmFibGU8QWNjb3VudHMgfCB1bmRlZmluZWQ+ID0gY29tYmluZUxhdGVzdChbXG4gICAgdGhpcy5yZXF1ZXN0T2JqZWN0LFxuICAgIHRoaXMuZmF2b3JpdGVSZXF1ZXN0Q29tcGxldGUsXG4gIF0pLnBpcGUoXG4gICAgZGlzdGluY3RVbnRpbENoYW5nZWQoKSxcbiAgICB0YXAoKCkgPT4gdGhpcy5sb2FkaW5nLm5leHQodHJ1ZSkpLFxuICAgIHN3aXRjaE1hcCgoW3JlcXVlc3RPYmplY3RdKSA9PiB0aGlzLmdldEFjY291bnRzKHJlcXVlc3RPYmplY3QpKSxcbiAgICBzY2FuKFxuICAgICAgKGFjYzogQWNjb3VudHMsIGN1cnI6IEFjY291bnRzKTogQWNjb3VudHMgPT4gKHtcbiAgICAgICAgY291bnQ6IGN1cnIuY291bnQsXG4gICAgICAgIGl0ZW1zOiB0aGlzLm1lcmdlUmVzcG9uc2VzKGFjYywgY3VyciksXG4gICAgICAgIHBhcmFtczogY3Vyci5wYXJhbXMsXG4gICAgICB9KSxcbiAgICApLFxuICAgIHRhcCgoKSA9PiB0aGlzLmVycm9yLm5leHQodW5kZWZpbmVkKSksXG4gICAgY2F0Y2hFcnJvcigoZXJyb3I6IEFjY291bnRzT3ZlcnZpZXdFcnJvcikgPT4ge1xuICAgICAgdGhpcy5lcnJvci5uZXh0KGVycm9yKTtcbiAgICAgIHJldHVybiBvZih1bmRlZmluZWQpO1xuICAgIH0pLFxuICAgIHRhcCgoKSA9PiB0aGlzLmxvYWRpbmcubmV4dChmYWxzZSkpLFxuICApO1xuXG4gIHJlYWRvbmx5IGFnZ3JlZ2F0ZWRCYWxhbmNlczogT2JzZXJ2YWJsZTxBY2NvdW50QWdncmVnYXRlZEJhbGFuY2VDdXJyZW5jeVtdIHwgdW5kZWZpbmVkPiA9IGNvbWJpbmVMYXRlc3QoW1xuICAgIHRoaXMucmVmcmVzaEFnZ3JlZ2F0ZWRCYWxhbmNlc1N1YmplY3QsXG4gIF0pLnBpcGUoXG4gICAgdGFwKCgpID0+IHRoaXMubG9hZGluZ0FnZ3JlZ2F0ZWRCYWxhbmNlc1N1YmplY3QubmV4dCh0cnVlKSksXG4gICAgc3dpdGNoTWFwKCgpID0+IHRoaXMuZ2V0QWdncmVnYXRlZEJhbGFuY2VzKCkpLFxuICAgIHRhcCgoKSA9PiB0aGlzLmxvYWRpbmdBZ2dyZWdhdGVkQmFsYW5jZXNTdWJqZWN0Lm5leHQoZmFsc2UpKSxcbiAgKTtcblxuICBnZXRBY2NvdW50QnlJZChhcnJhbmdlbWVudElkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPEFjY291bnRBcnJhbmdlbWVudEl0ZW0+IHtcbiAgICByZXR1cm4gdGhpcy5hY2NvdW50RGF0YVNlcnZpY2UuZ2V0QXJyYW5nZW1lbnRCeUlkKHsgYXJyYW5nZW1lbnRJZCB9KTtcbiAgfVxuICAvKipcbiAgICogRmV0Y2hlcyBhbiB1bm1hc2tlZCBhdHRyaWJ1dGUgZm9yIHRoZSBnaXZlbiBgVW5tYXNrZWRBdHRyaWJ1dGVSZXF1ZXN0UGFyYW1zYFxuICAgKlxuICAgKiBAcGFyYW0gcmVxdWVzdFBhcmFtZXRlcnNcbiAgICovXG4gIGdldFVubWFza2VkQXR0cmlidXRlKHJlcXVlc3RQYXJhbWV0ZXJzOiBVbm1hc2tlZEF0dHJpYnV0ZVJlcXVlc3RQYXJhbXMpOiBPYnNlcnZhYmxlPHN0cmluZz4ge1xuICAgIHJldHVybiB0aGlzLmFjY291bnREYXRhU2VydmljZS51bm1hc2tlZEF0dHJpYnV0ZShyZXF1ZXN0UGFyYW1ldGVycywgJ2JvZHknLCBmYWxzZSwge1xuICAgICAgaHR0cEhlYWRlckFjY2VwdDogJ3RleHQvcGxhaW4nLFxuICAgIH0pO1xuICB9XG5cbiAgdG9nZ2xlQWNjb3VudEZhdm9yaXRlKFxuICAgIGJvZHk6IEFjY291bnRVc2VyUHJlZmVyZW5jZXMsXG4gICAgZXJyb3JUZW1wbGF0ZVJlZjogVGVtcGxhdGVSZWY8YW55PiB8IHN0cmluZyxcbiAgICBzdWNjZXNzVGVtcGxhdGVSZWY6IFRlbXBsYXRlUmVmPGFueT4gfCBzdHJpbmcsXG4gICk6IE9ic2VydmFibGU8YW55IHwgdW5kZWZpbmVkPiB7XG4gICAgcmV0dXJuIHRoaXMucHV0QWNjb3VudEZhdm9yaXRlKGJvZHkpLnBpcGUoXG4gICAgICB0YWtlKDEpLFxuICAgICAgdGFwKCgpID0+IHtcbiAgICAgICAgdGhpcy5zaG93Tm90aWZpY2F0aW9uKHN1Y2Nlc3NUZW1wbGF0ZVJlZiwgJ3N1Y2Nlc3MnKTtcbiAgICAgICAgdGhpcy51cGRhdGVFcnJvci5uZXh0KHVuZGVmaW5lZCk7XG4gICAgICAgIHRoaXMucHViU3ViLnB1Ymxpc2goYmJFdmVudFRvZ2dsZUFjY291bnRGYXZvcml0ZVVwZGF0ZSwgdW5kZWZpbmVkKTtcbiAgICAgIH0pLFxuICAgICAgY2F0Y2hFcnJvcigoZXJyb3I6IEFjY291bnRzT3ZlcnZpZXdFcnJvcikgPT4ge1xuICAgICAgICB0aGlzLnVwZGF0ZUVycm9yLm5leHQoZXJyb3IpO1xuICAgICAgICB0aGlzLnNob3dOb3RpZmljYXRpb24oZXJyb3JUZW1wbGF0ZVJlZiwgJ2Vycm9yJyk7XG4gICAgICAgIHJldHVybiBvZih1bmRlZmluZWQpO1xuICAgICAgfSksXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgcHV0QWNjb3VudEZhdm9yaXRlKGFjY291bnRVc2VyUHJlZmVyZW5jZXM6IEFjY291bnRVc2VyUHJlZmVyZW5jZXMpOiBPYnNlcnZhYmxlPEh0dHBSZXNwb25zZTxhbnk+PiB7XG4gICAgcmV0dXJuIHRoaXMuYWNjb3VudERhdGFTZXJ2aWNlLnVwZGF0ZVVzZXJQcmVmZXJlbmNlcyh7IGFjY291bnRVc2VyUHJlZmVyZW5jZXMgfSkucGlwZShcbiAgICAgIGNhdGNoRXJyb3IoKGVycm9yOiBIdHRwRXJyb3JSZXNwb25zZSkgPT4ge1xuICAgICAgICB0aHJvdyBwYXJzZUVycm9yKGVycm9yKTtcbiAgICAgIH0pLFxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGdldEFjY291bnRzKHJlcXVlc3RPYmplY3Q6IEdldFByb2R1Y3RzdW1tYXJ5UmVxdWVzdCk6IE9ic2VydmFibGU8QWNjb3VudHM+IHtcbiAgICBjb25zdCBwYWdpbmF0aW9uVHlwZSA9IHJlcXVlc3RPYmplY3QucGFnaW5hdGlvblR5cGUgfHwgJyc7XG4gICAgY29uc3QgZnJvbSA9IHJlcXVlc3RPYmplY3QuZnJvbSB8fCAwO1xuICAgIGNvbnN0IHBhcmFtcyA9IHsgLi4ucmVxdWVzdE9iamVjdCB9O1xuICAgIGRlbGV0ZSBwYXJhbXMucGFnaW5hdGlvblR5cGU7XG4gICAgcmV0dXJuIHRoaXMucHJvZHVjdFN1bW1hcnlEYXRhU2VydmljZS5nZXRBcnJhbmdlbWVudHNCeUJ1c2luZXNzRnVuY3Rpb24ocGFyYW1zLCBIdHRwUmVzcG9uc2VUeXBlLlJFU1BPTlNFKS5waXBlKFxuICAgICAgbWFwKHJlcyA9PiB0aGlzLm1hcFJlc3BvbnNlV2l0aENvdW50KHJlcywgeyBmcm9tLCBwYWdpbmF0aW9uVHlwZSB9KSksXG4gICAgICBjYXRjaEVycm9yKChlcnJvcjogSHR0cEVycm9yUmVzcG9uc2UpID0+IHtcbiAgICAgICAgdGhyb3cgcGFyc2VFcnJvcihlcnJvcik7XG4gICAgICB9KSxcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBtYXBSZXNwb25zZVdpdGhDb3VudChcbiAgICByZXNwb25zZTogSHR0cFJlc3BvbnNlPFByb2R1Y3RTdW1tYXJ5SXRlbVtdPixcbiAgICB7IGZyb20sIHBhZ2luYXRpb25UeXBlIH06IHsgZnJvbTogbnVtYmVyOyBwYWdpbmF0aW9uVHlwZTogUGFnaW5hdGlvblR5cGUgfCBzdHJpbmcgfSxcbiAgKTogQWNjb3VudHMge1xuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1udWxsL25vLW51bGxcbiAgICBpZiAocmVzcG9uc2UuYm9keSA9PT0gbnVsbCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCk7XG4gICAgfVxuICAgIGNvbnN0IGhlYWRlckNvdW50ID0gcmVzcG9uc2UuaGVhZGVycyA/IHJlc3BvbnNlLmhlYWRlcnMuZ2V0KCd4LXRvdGFsLWNvdW50JykgOiB1bmRlZmluZWQ7XG4gICAgY29uc3QgY291bnRlciA9IGhlYWRlckNvdW50ID8gcGFyc2VJbnQoaGVhZGVyQ291bnQsIDEwKSA6IHJlc3BvbnNlLmJvZHkubGVuZ3RoIHx8IDA7XG5cbiAgICByZXR1cm4ge1xuICAgICAgY291bnQ6IGNvdW50ZXIsXG4gICAgICBpdGVtczogcmVzcG9uc2UuYm9keSB8fCBbXSxcbiAgICAgIHBhcmFtczogeyBmcm9tLCBwYWdpbmF0aW9uVHlwZSB9LFxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIG1lcmdlUmVzcG9uc2VzKGFjYzogQWNjb3VudHMsIGN1cnJlbnQ6IEFjY291bnRzKTogUHJvZHVjdFN1bW1hcnlJdGVtW10ge1xuICAgIGlmIChcbiAgICAgIGFjYyAmJlxuICAgICAgYWNjLml0ZW1zICYmXG4gICAgICBjdXJyZW50ICYmXG4gICAgICBjdXJyZW50Lml0ZW1zICYmXG4gICAgICBhY2MucGFyYW1zLnBhZ2luYXRpb25UeXBlID09PSBQYWdpbmF0aW9uVHlwZS5MT0FEX01PUkUgJiZcbiAgICAgIGN1cnJlbnQucGFyYW1zLmZyb20gIT09IDBcbiAgICApIHtcbiAgICAgIHJldHVybiBbLi4uYWNjLml0ZW1zLCAuLi5jdXJyZW50Lml0ZW1zXTtcbiAgICB9XG4gICAgcmV0dXJuIGN1cnJlbnQuaXRlbXM7XG4gIH1cblxuICBwcml2YXRlIHNob3dOb3RpZmljYXRpb24odGVtcGxhdGVSZWY6IFRlbXBsYXRlUmVmPGFueT4gfCBzdHJpbmcsIG1vZGlmaWVyOiAnc3VjY2VzcycgfCAnZXJyb3InKSB7XG4gICAgdGhpcy5ub3RpZmljYXRpb25TZXJ2aWNlLnNob3dOb3RpZmljYXRpb24oe1xuICAgICAgaGVhZGVyOiB0ZW1wbGF0ZVJlZixcbiAgICAgIG1vZGlmaWVyLFxuICAgICAgbWVzc2FnZTogJycsXG4gICAgfSk7XG4gIH1cblxuICBnZXRBY2NvdW50c0Zyb20ocmVxdWVzdE9iamVjdDogT2JzZXJ2YWJsZTxHZXRQcm9kdWN0c3VtbWFyeVJlcXVlc3Q+KSB7XG4gICAgcmVxdWVzdE9iamVjdC5zdWJzY3JpYmUodGhpcy5yZXF1ZXN0T2JqZWN0KTtcbiAgfVxuXG4gIHJlZnJlc2hBZ2dyZWdhdGVkQmFsYW5jZXMoKSB7XG4gICAgdGhpcy5yZWZyZXNoQWdncmVnYXRlZEJhbGFuY2VzU3ViamVjdC5uZXh0KHRydWUpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRBZ2dyZWdhdGVkQmFsYW5jZXMoKTogT2JzZXJ2YWJsZTxBY2NvdW50QWdncmVnYXRlZEJhbGFuY2VDdXJyZW5jeVtdIHwgdW5kZWZpbmVkPiB7XG4gICAgY29uc3QgcmVxdWVzdFBhcmFtZXRlcnMgPSB7fTtcbiAgICByZXR1cm4gdGhpcy5iYWxhbmNlc0h0dHBTZXJ2aWNlLmdldEFnZ3JlZ2F0aW9ucyhyZXF1ZXN0UGFyYW1ldGVycykucGlwZShcbiAgICAgIG1hcChyZXNwb25zZSA9PiB0aGlzLm1hcFJlc3BvbnNlVG9BZ2dyZWdhdGVkQmFsYW5jZXMocmVzcG9uc2UpKSxcbiAgICAgIHRhcCgoKSA9PiB0aGlzLmFnZ3JlZ2F0ZWRCYWxhbmNlc0Vycm9yU3ViamVjdC5uZXh0KHVuZGVmaW5lZCkpLFxuICAgICAgY2F0Y2hFcnJvcihlcnJvciA9PiB0aGlzLnBhcnNlQWdncmVnYXRlZEJhbGFuY2VFcnJvcihlcnJvcikpLFxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIG1hcFJlc3BvbnNlVG9BZ2dyZWdhdGVkQmFsYW5jZXMoYWdncmVnYXRpb25zOiBBZ2dyZWdhdGVkQmFsYW5jZXNbXSkge1xuICAgIGNvbnN0IGFsbEJhbGFuY2VzID0gKGFnZ3JlZ2F0aW9ucyB8fCBbe31dKVswXTtcbiAgICByZXR1cm4gYWxsQmFsYW5jZXMgJiYgYWxsQmFsYW5jZXMuYWdncmVnYXRlZEJhbGFuY2VzO1xuICB9XG5cbiAgcHJpdmF0ZSBwYXJzZUFnZ3JlZ2F0ZWRCYWxhbmNlRXJyb3IoZXJyb3I6IEh0dHBFcnJvclJlc3BvbnNlKSB7XG4gICAgdGhpcy5hZ2dyZWdhdGVkQmFsYW5jZXNFcnJvclN1YmplY3QubmV4dChlcnJvcik7XG4gICAgcmV0dXJuIG9mKHVuZGVmaW5lZCk7XG4gIH1cblxuICBwcml2YXRlIHJldHJpZ2dlckdldEFjY291bnRzKCkge1xuICAgIHRoaXMuZmF2b3JpdGVSZXF1ZXN0Q29tcGxldGUubmV4dCh0cnVlKTtcbiAgfVxufVxuIl19