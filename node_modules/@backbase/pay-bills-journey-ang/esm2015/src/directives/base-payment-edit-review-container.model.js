import { HostListener, ViewChild, Directive, Input } from '@angular/core';
import { BehaviorSubject, combineLatest, of, Subject } from 'rxjs';
import { filter, first, map, switchMap, take, takeUntil, tap } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "@angular/router";
import * as i2 from "../services/pay-bills-state.service";
import * as i3 from "@backbase/billpay-journeys-common";
import * as i4 from "../services/pay-bills-navigation.service";
export class BasePaymentEditReviewContainerDirective {
    /** @internal */
    constructor(route, stateService, discardModalService, paymentParserService, routerService) {
        this.route = route;
        this.stateService = stateService;
        this.discardModalService = discardModalService;
        this.paymentParserService = paymentParserService;
        this.routerService = routerService;
        this.paymentError = false;
        this.hasDateError = false;
        this.paymentConfirm$ = new BehaviorSubject(undefined);
        this.destroy$ = new Subject();
        this.notificationMessageTemplate = '';
        this.notificationHeaderTemplate = '';
        this.id$ = this.route.paramMap.pipe(first(), map(params => params.get('id') || ''));
    }
    onWindowUnload($event) {
        if (!this.isDiscardModalOpen) {
            $event.returnValue = true;
        }
    }
    ngOnInit() {
        combineLatest([this.stateService.paymentState, this.id$])
            .pipe(take(1))
            .subscribe(([payment, id]) => {
            this.payment = payment === null || payment === void 0 ? void 0 : payment[0];
            this.paymentReview = this.payment && this.paymentParserService.paymentFormStateToReview(this.payment);
            if (!this.payment) {
                this.navigateToForm(id);
            }
        });
        combineLatest([this.paymentConfirm$.pipe(filter(Boolean)), this.id$])
            .pipe(takeUntil(this.destroy$))
            .subscribe(([payment, id]) => this.onPaymentConfirm(payment, id));
    }
    ngOnDestroy() {
        this.destroy$.next();
        this.destroy$.complete();
    }
    get isDiscardModalOpen() {
        return this.discardModalService.isDiscardModalOpen;
    }
    confirmPayment(payment) {
        if (!payment)
            return;
        this.paymentConfirm$.next(payment);
    }
    openModal() {
        return this.paymentConfirm$.pipe(switchMap(payment => (payment ? of(true) : this.discardModalService.openModal())), tap(isResolved => isResolved && this.stateService.reset()));
    }
    onModalResolve(isConfirmed) {
        this.discardModalService.onModalResolve(isConfirmed);
    }
    cancel() {
        this.routerService.navigateToPayeeList();
    }
    get dismissTimeout() {
        if (this.dismissTimeoutValue === undefined) {
            throw new Error('Dismiss timeout value not found');
        }
        return this.dismissTimeoutValue;
    }
}
BasePaymentEditReviewContainerDirective.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.15", ngImport: i0, type: BasePaymentEditReviewContainerDirective, deps: [{ token: i1.ActivatedRoute }, { token: i2.PayBillsStateService }, { token: i3.BillpayDiscardChangesModalService }, { token: i3.BillpayPaymentParserService }, { token: i4.PayBillsNavigationService }], target: i0.ɵɵFactoryTarget.Directive });
BasePaymentEditReviewContainerDirective.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "12.0.0", version: "12.2.15", type: BasePaymentEditReviewContainerDirective, inputs: { dismissTimeoutValue: "dismissTimeoutValue", accountNumberMasked: "accountNumberMasked" }, host: { listeners: { "window:beforeunload": "onWindowUnload($event)" } }, viewQueries: [{ propertyName: "notificationMessageTemplate", first: true, predicate: ["notificationMessage"], descendants: true }, { propertyName: "notificationHeaderTemplate", first: true, predicate: ["notificationHeader"], descendants: true }, { propertyName: "failAlert", first: true, predicate: ["failAlert"], descendants: true }], ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.15", ngImport: i0, type: BasePaymentEditReviewContainerDirective, decorators: [{
            type: Directive
        }], ctorParameters: function () { return [{ type: i1.ActivatedRoute }, { type: i2.PayBillsStateService }, { type: i3.BillpayDiscardChangesModalService }, { type: i3.BillpayPaymentParserService }, { type: i4.PayBillsNavigationService }]; }, propDecorators: { dismissTimeoutValue: [{
                type: Input
            }], accountNumberMasked: [{
                type: Input
            }], notificationMessageTemplate: [{
                type: ViewChild,
                args: ['notificationMessage']
            }], notificationHeaderTemplate: [{
                type: ViewChild,
                args: ['notificationHeader']
            }], failAlert: [{
                type: ViewChild,
                args: ['failAlert']
            }], onWindowUnload: [{
                type: HostListener,
                args: ['window:beforeunload', ['$event']]
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZS1wYXltZW50LWVkaXQtcmV2aWV3LWNvbnRhaW5lci5tb2RlbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL2xpYnMvcGF5LWJpbGxzLWpvdXJuZXkvc3JjL2RpcmVjdGl2ZXMvYmFzZS1wYXltZW50LWVkaXQtcmV2aWV3LWNvbnRhaW5lci5tb2RlbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsWUFBWSxFQUFrQyxTQUFTLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBYyxNQUFNLGVBQWUsQ0FBQztBQUV0SCxPQUFPLEVBQUUsZUFBZSxFQUFFLGFBQWEsRUFBYyxFQUFFLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQy9FLE9BQU8sRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQzs7Ozs7O0FBYXJGLE1BQU0sT0FBZ0IsdUNBQXVDO0lBNEIzRCxnQkFBZ0I7SUFDaEIsWUFDbUIsS0FBcUIsRUFDckIsWUFBa0MsRUFDbEMsbUJBQXNELEVBQ3RELG9CQUFpRCxFQUN6RCxhQUF3QztRQUpoQyxVQUFLLEdBQUwsS0FBSyxDQUFnQjtRQUNyQixpQkFBWSxHQUFaLFlBQVksQ0FBc0I7UUFDbEMsd0JBQW1CLEdBQW5CLG1CQUFtQixDQUFtQztRQUN0RCx5QkFBb0IsR0FBcEIsb0JBQW9CLENBQTZCO1FBQ3pELGtCQUFhLEdBQWIsYUFBYSxDQUEyQjtRQTdCbkQsaUJBQVksR0FBRyxLQUFLLENBQUM7UUFDckIsaUJBQVksR0FBRyxLQUFLLENBQUM7UUFFRixvQkFBZSxHQUFHLElBQUksZUFBZSxDQUErQixTQUFTLENBQUMsQ0FBQztRQUMvRSxhQUFRLEdBQUcsSUFBSSxPQUFPLEVBQVEsQ0FBQztRQUtoQixnQ0FBMkIsR0FBOEIsRUFBRSxDQUFDO1FBQzdELCtCQUEw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SSxJQUFJLENBQUMsbUJBQW1CLEtBQUssU0FBUyxFQUFFO1lBQzFDLE1BQU0sSUFBSSxLQUFLLENBQUMsaUNBQWlDLENBQUMsQ0FBQztTQUNwRDtRQUNELE9BQU8sSUFBSSxDQUFDLG1CQUFtQixDQUFDO0lBQ2xDLENBQUM7O3FJQTVGbUIsdUNBQXVDO3lIQUF2Qyx1Q0FBdUM7NEZBQXZDLHVDQUF1QztrQkFENUQsU0FBUzswUUFZQyxtQkFBbUI7c0JBQTNCLEtBQUs7Z0JBQ0csbUJBQW1CO3NCQUEzQixLQUFLO2dCQUU0QiwyQkFBMkI7c0JBQTVELFNBQVM7dUJBQUMscUJBQXFCO2dCQUNDLDBCQUEwQjtzQkFBMUQsU0FBUzt1QkFBQyxvQkFBb0I7Z0JBQ1AsU0FBUztzQkFBaEMsU0FBUzt1QkFBQyxXQUFXO2dCQUd0QixjQUFjO3NCQURiLFlBQVk7dUJBQUMscUJBQXFCLEVBQUUsQ0FBQyxRQUFRLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBIb3N0TGlzdGVuZXIsIE9uRGVzdHJveSwgT25Jbml0LCBUZW1wbGF0ZVJlZiwgVmlld0NoaWxkLCBEaXJlY3RpdmUsIElucHV0LCBFbGVtZW50UmVmIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBBY3RpdmF0ZWRSb3V0ZSB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QsIGNvbWJpbmVMYXRlc3QsIE9ic2VydmFibGUsIG9mLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBmaWx0ZXIsIGZpcnN0LCBtYXAsIHN3aXRjaE1hcCwgdGFrZSwgdGFrZVVudGlsLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7IFBheUJpbGxzU3RhdGVTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvcGF5LWJpbGxzLXN0YXRlLnNlcnZpY2UnO1xuaW1wb3J0IHsgUGF5QmlsbHNOYXZpZ2F0aW9uU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL3BheS1iaWxscy1uYXZpZ2F0aW9uLnNlcnZpY2UnO1xuaW1wb3J0IHtcbiAgQmlsbHBheURpc2NhcmRDaGFuZ2VzRm9ybUNvbXBvbmVudCxcbiAgQmlsbHBheURpc2NhcmRDaGFuZ2VzTW9kYWxTZXJ2aWNlLFxuICBCaWxscGF5UGF5bWVudFBhcnNlclNlcnZpY2UsXG4gIFBheW1lbnRGb3JtU3RhdGUsXG4gIFBheW1lbnRSZXZpZXcsXG59IGZyb20gJ0BiYWNrYmFzZS9iaWxscGF5LWpvdXJuZXlzLWNvbW1vbic7XG5cbkBEaXJlY3RpdmUoKVxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIEJhc2VQYXltZW50RWRpdFJldmlld0NvbnRhaW5lckRpcmVjdGl2ZVxuICBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95LCBCaWxscGF5RGlzY2FyZENoYW5nZXNGb3JtQ29tcG9uZW50IHtcbiAgcGF5bWVudD86IFBheW1lbnRGb3JtU3RhdGU7XG4gIHBheW1lbnRSZXZpZXc/OiBQYXltZW50UmV2aWV3O1xuICByZWFkb25seSBpZCQ6IE9ic2VydmFibGU8c3RyaW5nPjtcbiAgcGF5bWVudEVycm9yID0gZmFsc2U7XG4gIGhhc0RhdGVFcnJvciA9IGZhbHNlO1xuXG4gIHByb3RlY3RlZCByZWFkb25seSBwYXltZW50Q29uZmlybSQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PFBheW1lbnRGb3JtU3RhdGUgfCB1bmRlZmluZWQ+KHVuZGVmaW5lZCk7XG4gIHByb3RlY3RlZCByZWFkb25seSBkZXN0cm95JCA9IG5ldyBTdWJqZWN0PHZvaWQ+KCk7XG5cbiAgQElucHV0KCkgZGlzbWlzc1RpbWVvdXRWYWx1ZTogbnVtYmVyIHwgdW5kZWZpbmVkO1xuICBASW5wdXQoKSBhY2NvdW50TnVtYmVyTWFza2VkPzogYm9vbGVhbjtcblxuICBAVmlld0NoaWxkKCdub3RpZmljYXRpb25NZXNzYWdlJykgbm90aWZpY2F0aW9uTWVzc2FnZVRlbXBsYXRlOiBUZW1wbGF0ZVJlZjxhbnk+IHwgc3RyaW5nID0gJyc7XG4gIEBWaWV3Q2hpbGQoJ25vdGlmaWNhdGlvbkhlYWRlcicpIG5vdGlmaWNhdGlvbkhlYWRlclRlbXBsYXRlOiBUZW1wbGF0ZVJlZjxhbnk+IHwgc3RyaW5nID0gJyc7XG4gIEBWaWV3Q2hpbGQoJ2ZhaWxBbGVydCcpIGZhaWxBbGVydCE6IEVsZW1lbnRSZWY7XG5cbiAgQEhvc3RMaXN0ZW5lcignd2luZG93OmJlZm9yZXVubG9hZCcsIFsnJGV2ZW50J10pXG4gIG9uV2luZG93VW5sb2FkKCRldmVudDogQmVmb3JlVW5sb2FkRXZlbnQpIHtcbiAgICBpZiAoIXRoaXMuaXNEaXNjYXJkTW9kYWxPcGVuKSB7XG4gICAgICAkZXZlbnQucmV0dXJuVmFsdWUgPSB0cnVlO1xuICAgIH1cbiAgfVxuXG4gIGFic3RyYWN0IG5hdmlnYXRlVG9Gb3JtKGlkOiBzdHJpbmcpOiB2b2lkO1xuICBwcm90ZWN0ZWQgYWJzdHJhY3Qgb25QYXltZW50Q29uZmlybShwYXltZW50OiBQYXltZW50Rm9ybVN0YXRlLCBpZDogc3RyaW5nKTogdm9pZDtcblxuICAvKiogQGludGVybmFsICovXG4gIHByb3RlY3RlZCBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IHJvdXRlOiBBY3RpdmF0ZWRSb3V0ZSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IHN0YXRlU2VydmljZTogUGF5QmlsbHNTdGF0ZVNlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSBkaXNjYXJkTW9kYWxTZXJ2aWNlOiBCaWxscGF5RGlzY2FyZENoYW5nZXNNb2RhbFNlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSBwYXltZW50UGFyc2VyU2VydmljZTogQmlsbHBheVBheW1lbnRQYXJzZXJTZXJ2aWNlLFxuICAgIHJlYWRvbmx5IHJvdXRlclNlcnZpY2U6IFBheUJpbGxzTmF2aWdhdGlvblNlcnZpY2UsXG4gICkge1xuICAgIHRoaXMuaWQkID0gdGhpcy5yb3V0ZS5wYXJhbU1hcC5waXBlKFxuICAgICAgZmlyc3QoKSxcbiAgICAgIG1hcChwYXJhbXMgPT4gcGFyYW1zLmdldCgnaWQnKSB8fCAnJyksXG4gICAgKTtcbiAgfVxuXG4gIG5nT25Jbml0KCkge1xuICAgIGNvbWJpbmVMYXRlc3QoW3RoaXMuc3RhdGVTZXJ2aWNlLnBheW1lbnRTdGF0ZSwgdGhpcy5pZCRdKVxuICAgICAgLnBpcGUodGFrZSgxKSlcbiAgICAgIC5zdWJzY3JpYmUoKFtwYXltZW50LCBpZF06IFtQYXltZW50Rm9ybVN0YXRlW10gfCB1bmRlZmluZWQsIHN0cmluZ10pID0+IHtcbiAgICAgICAgdGhpcy5wYXltZW50ID0gcGF5bWVudD8uWzBdO1xuICAgICAgICB0aGlzLnBheW1lbnRSZXZpZXcgPSB0aGlzLnBheW1lbnQgJiYgdGhpcy5wYXltZW50UGFyc2VyU2VydmljZS5wYXltZW50Rm9ybVN0YXRlVG9SZXZpZXcodGhpcy5wYXltZW50KTtcbiAgICAgICAgaWYgKCF0aGlzLnBheW1lbnQpIHtcbiAgICAgICAgICB0aGlzLm5hdmlnYXRlVG9Gb3JtKGlkKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICBjb21iaW5lTGF0ZXN0KFt0aGlzLnBheW1lbnRDb25maXJtJC5waXBlKGZpbHRlcihCb29sZWFuKSksIHRoaXMuaWQkXSlcbiAgICAgIC5waXBlKHRha2VVbnRpbCh0aGlzLmRlc3Ryb3kkKSlcbiAgICAgIC5zdWJzY3JpYmUoKFtwYXltZW50LCBpZF0pID0+IHRoaXMub25QYXltZW50Q29uZmlybShwYXltZW50IGFzIFBheW1lbnRGb3JtU3RhdGUsIGlkKSk7XG4gIH1cblxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICB0aGlzLmRlc3Ryb3kkLm5leHQoKTtcbiAgICB0aGlzLmRlc3Ryb3kkLmNvbXBsZXRlKCk7XG4gIH1cblxuICBnZXQgaXNEaXNjYXJkTW9kYWxPcGVuKCkge1xuICAgIHJldHVybiB0aGlzLmRpc2NhcmRNb2RhbFNlcnZpY2UuaXNEaXNjYXJkTW9kYWxPcGVuO1xuICB9XG5cbiAgY29uZmlybVBheW1lbnQocGF5bWVudD86IFBheW1lbnRGb3JtU3RhdGUpIHtcbiAgICBpZiAoIXBheW1lbnQpIHJldHVybjtcbiAgICB0aGlzLnBheW1lbnRDb25maXJtJC5uZXh0KHBheW1lbnQpO1xuICB9XG5cbiAgb3Blbk1vZGFsKCk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xuICAgIHJldHVybiB0aGlzLnBheW1lbnRDb25maXJtJC5waXBlKFxuICAgICAgc3dpdGNoTWFwKHBheW1lbnQgPT4gKHBheW1lbnQgPyBvZih0cnVlKSA6IHRoaXMuZGlzY2FyZE1vZGFsU2VydmljZS5vcGVuTW9kYWwoKSkpLFxuICAgICAgdGFwKGlzUmVzb2x2ZWQgPT4gaXNSZXNvbHZlZCAmJiB0aGlzLnN0YXRlU2VydmljZS5yZXNldCgpKSxcbiAgICApO1xuICB9XG5cbiAgb25Nb2RhbFJlc29sdmUoaXNDb25maXJtZWQ6IGJvb2xlYW4pIHtcbiAgICB0aGlzLmRpc2NhcmRNb2RhbFNlcnZpY2Uub25Nb2RhbFJlc29sdmUoaXNDb25maXJtZWQpO1xuICB9XG5cbiAgY2FuY2VsKCkge1xuICAgIHRoaXMucm91dGVyU2VydmljZS5uYXZpZ2F0ZVRvUGF5ZWVMaXN0KCk7XG4gIH1cblxuICBwcm90ZWN0ZWQgZ2V0IGRpc21pc3NUaW1lb3V0KCk6IG51bWJlciB7XG4gICAgaWYgKHRoaXMuZGlzbWlzc1RpbWVvdXRWYWx1ZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Rpc21pc3MgdGltZW91dCB2YWx1ZSBub3QgZm91bmQnKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuZGlzbWlzc1RpbWVvdXRWYWx1ZTtcbiAgfVxufVxuIl19