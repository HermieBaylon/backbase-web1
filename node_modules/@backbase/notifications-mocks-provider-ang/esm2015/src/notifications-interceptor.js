import { Injectable } from '@angular/core';
import { HttpErrorResponse, HttpHeaders, HttpResponse, } from '@angular/common/http';
import { throwError } from 'rxjs';
import { map } from 'rxjs/operators';
import { toISOExtendedFormat } from '@backbase/notifications-common-ang';
import { notification } from './notification-mock';
import * as i0 from "@angular/core";
const DEFAULT_FREQUENCY = 20000;
const notificationReadRegexp = /\/notifications\/(.*)\/read\/?$/;
function getGenerationFrequency(frequency) {
    const freq = frequency && parseInt(frequency, 10);
    return freq || DEFAULT_FREQUENCY;
}
function createNotificationsPage(notifications, options) {
    const { from, size } = options;
    const start = from * size;
    const end = start + size;
    return notifications.slice(start, end);
}
const quietNotificationsStrategy = {
    STICKY_LIMIT: 1,
    POPUPS_LIMIT: 1,
};
const noLimitsNotificationsStrategy = {
    STICKY_LIMIT: Infinity,
    POPUPS_LIMIT: Infinity,
};
const noNotificationsStrategy = {
    STICKY_LIMIT: 0,
    POPUPS_LIMIT: 0,
};
export class NotificationsInterceptor {
    constructor(ngZone) {
        this.ngZone = ngZone;
        this.areMocksEnabled = localStorage.getItem('enableMocks') === 'true';
        this.isEmptyNotificationsEnabled = localStorage.getItem('noNotifications') === 'true';
        this.isNoLimitsNotificationsEnabled = localStorage.getItem('noLimitsNotifications') === 'true';
        this.liveNotificationFreq = localStorage.getItem('liveNotificationFreq');
        this.mockStrategy = this.getMockStrategy();
        this.readNotifications = {};
        this.newNotifications = [];
        this.popupsCount = 0;
        this.notificationsStreamHandled = false;
        this.notificationRequestUnreadIds = []; // from spec examples
        if (this.mockStrategy && this.liveNotificationFreq) {
            this.ngZone.runOutsideAngular(() => {
                setInterval(() => {
                    this.newNotifications.unshift(Object.assign(Object.assign({}, notification), { id: (345679 + this.newNotifications.length).toString(), title: `New Notification ${this.newNotifications.length + 1}`, createdOn: new Date().toISOString() }));
                }, getGenerationFrequency(this.liveNotificationFreq));
            });
        }
    }
    intercept(req, next) {
        if (!this.mockStrategy) {
            return next.handle(req);
        }
        if (req.url.endsWith('notifications/unread-count')) {
            return this.handleUnreadCountRequest(req, next);
        }
        if (req.url.endsWith('notifications/read')) {
            return this.handleReadAllNotificationRequest(req, next);
        }
        if (req.url.endsWith('read') && req.method === 'PUT') {
            return this.handleReadNotificationRequest(req, next);
        }
        if (req.url.endsWith('notifications')) {
            return this.handleNotificationsRequest(req, next);
        }
        if (req.url.endsWith('notifications/stream')) {
            return this.handleNotificationsStreamRequest(req, next);
        }
        return next.handle(req);
    }
    handleUnreadCountRequest(req, next) {
        if (this.mockStrategy === noNotificationsStrategy) {
            return next.handle(req).pipe(map((event) => {
                if (event instanceof HttpResponse) {
                    return event.clone({
                        body: {
                            unread: 0,
                        },
                    });
                }
                return event;
            }));
        }
        return next.handle(req).pipe(map((event) => {
            if (event instanceof HttpResponse) {
                return event.clone({
                    body: {
                        unread: this.newNotifications.length +
                            event.body.unread +
                            this.popupsCount -
                            Object.keys(this.readNotifications).length,
                    },
                });
            }
            return event;
        }));
    }
    handleNotificationsRequest(req, next) {
        if (this.mockStrategy === noNotificationsStrategy) {
            return next.handle(req).pipe(map((event) => {
                if (event instanceof HttpResponse) {
                    return event.clone({
                        body: [],
                    });
                }
                return event;
            }));
        }
        return next.handle(req).pipe(map((event) => {
            if (event instanceof HttpResponse) {
                const from = Number(req.params.get('from'));
                const size = Number(req.params.get('size'));
                const toDate = req.params.get('toDate');
                if (!this.notificationRequestUnreadIds.length) {
                    this.notificationRequestUnreadIds.push(
                    //@ts-ignore
                    ...event.body.filter((item) => !item.read).map((item) => item.id));
                }
                let notifications = [...this.newNotifications, ...event.body];
                if (toDate) {
                    notifications = notifications.filter(({ createdOn }) => new Date(toISOExtendedFormat(createdOn)).getTime() <= new Date(toDate).getTime());
                }
                const notificationsPage = createNotificationsPage(notifications, { from, size });
                return event.clone({
                    body: notificationsPage.map((n) => (Object.assign(Object.assign({}, n), { read: this.readNotifications[n.id] || n.read }))),
                    headers: new HttpHeaders({
                        'x-total-count': String(notifications.length),
                        'x-cursor': notificationsPage[notificationsPage.length - 1].id,
                    }),
                });
            }
            return event;
        }));
    }
    handleReadAllNotificationRequest(req, next) {
        this.newNotifications.forEach(item => (this.readNotifications[item.id] = true));
        this.notificationRequestUnreadIds.forEach(id => (this.readNotifications[id] = true));
        return next.handle(req);
    }
    handleReadNotificationRequest(req, next) {
        const [, notificationId] = notificationReadRegexp.exec(req.url);
        if (notificationId === '1234-5678-9022') {
            return throwError(new HttpErrorResponse({
                status: 500,
                statusText: '',
            }));
        }
        this.readNotifications[notificationId] = true;
        return next.handle(req);
    }
    handleNotificationsStreamRequest(req, next) {
        return next.handle(req).pipe(map((event) => {
            if (event instanceof HttpResponse) {
                const popupsLimit = this.mockStrategy === quietNotificationsStrategy && !this.notificationsStreamHandled
                    ? 0
                    : // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
                        this.mockStrategy.POPUPS_LIMIT;
                const popups = event.body
                    .filter((item) => !item.expiresOn && !this.readNotifications[item.id])
                    .slice(0, popupsLimit)
                    .map((item) => (Object.assign({}, item)));
                const sticky = event.body
                    .filter((item) => !!item.expiresOn)
                    // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
                    .slice(0, this.mockStrategy.STICKY_LIMIT)
                    .filter((item) => !this.readNotifications[item.id]);
                const randomPopups = popups.slice(0, Math.ceil(Math.random() * popups.length));
                this.popupsCount = event.body.length;
                this.notificationsStreamHandled = true;
                return event.clone({
                    body: [...sticky, ...randomPopups],
                });
            }
            return event;
        }));
    }
    getMockStrategy() {
        if (!this.areMocksEnabled)
            return undefined;
        if (this.isEmptyNotificationsEnabled)
            return noNotificationsStrategy;
        if (this.isNoLimitsNotificationsEnabled)
            return noLimitsNotificationsStrategy;
        return quietNotificationsStrategy;
    }
}
NotificationsInterceptor.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.14", ngImport: i0, type: NotificationsInterceptor, deps: [{ token: i0.NgZone }], target: i0.ɵɵFactoryTarget.Injectable });
NotificationsInterceptor.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "12.2.14", ngImport: i0, type: NotificationsInterceptor });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.14", ngImport: i0, type: NotificationsInterceptor, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i0.NgZone }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibm90aWZpY2F0aW9ucy1pbnRlcmNlcHRvci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL2xpYnMvbm90aWZpY2F0aW9ucy1tb2Nrcy1wcm92aWRlci1hbmcvc3JjL25vdGlmaWNhdGlvbnMtaW50ZXJjZXB0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBVSxNQUFNLGVBQWUsQ0FBQztBQUNuRCxPQUFPLEVBQ0wsaUJBQWlCLEVBR2pCLFdBQVcsRUFHWCxZQUFZLEdBQ2IsTUFBTSxzQkFBc0IsQ0FBQztBQUM5QixPQUFPLEVBQWMsVUFBVSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzlDLE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNyQyxPQUFPLEVBQTRDLG1CQUFtQixFQUFFLE1BQU0sb0NBQW9DLENBQUM7QUFFbkgsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLHFCQUFxQixDQUFDOztBQUVuRCxNQUFNLGlCQUFpQixHQUFHLEtBQUssQ0FBQztBQUVoQyxNQUFNLHNCQUFzQixHQUFHLGlDQUFpQyxDQUFDO0FBRWpFLFNBQVMsc0JBQXNCLENBQUMsU0FBd0I7SUFDdEQsTUFBTSxJQUFJLEdBQUcsU0FBUyxJQUFJLFFBQVEsQ0FBQyxTQUFTLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFFbEQsT0FBTyxJQUFJLElBQUksaUJBQWlCLENBQUM7QUFDbkMsQ0FBQztBQUVELFNBQVMsdUJBQXVCLENBQUMsYUFBaUMsRUFBRSxPQUF1QztJQUN6RyxNQUFNLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxHQUFHLE9BQU8sQ0FBQztJQUMvQixNQUFNLEtBQUssR0FBRyxJQUFJLEdBQUcsSUFBSSxDQUFDO0lBQzFCLE1BQU0sR0FBRyxHQUFHLEtBQUssR0FBRyxJQUFJLENBQUM7SUFFekIsT0FBTyxhQUFhLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMs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QUM7Z0JBRXZDLE9BQU8sS0FBSyxDQUFDLEtBQUssQ0FBQztvQkFDakIsSUFBSSxFQUFFLENBQUMsR0FBRyxNQUFNLEVBQUUsR0FBRyxZQUFZLENBQUM7aUJBQ25DLENBQUMsQ0FBQzthQUNKO1lBRUQsT0FBTyxLQUFLLENBQUM7UUFDZixDQUFDLENBQUMsQ0FDSCxDQUFDO0lBQ0osQ0FBQztJQUVPLGVBQWU7UUFDckIsSUFBSSxDQUFDLElBQUksQ0FBQyxlQUFlO1lBQUUsT0FBTyxTQUFTLENBQUM7UUFFNUMsSUFBSSxJQUFJLENBQUMsMkJBQTJCO1lBQUUsT0FBTyx1QkFBdUIsQ0FBQztRQUNyRSxJQUFJLElBQUksQ0FBQyw4QkFBOEI7WUFBRSxPQUFPLDZCQUE2QixDQUFDO1FBRTlFLE9BQU8sMEJBQTBCLENBQUM7SUFDcEMsQ0FBQzs7c0hBdk5VLHdCQUF3QjswSEFBeEIsd0JBQXdCOzRGQUF4Qix3QkFBd0I7a0JBRHBDLFVBQVUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBOZ1pvbmUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7XG4gIEh0dHBFcnJvclJlc3BvbnNlLFxuICBIdHRwRXZlbnQsXG4gIEh0dHBIYW5kbGVyLFxuICBIdHRwSGVhZGVycyxcbiAgSHR0cEludGVyY2VwdG9yLFxuICBIdHRwUmVxdWVzdCxcbiAgSHR0cFJlc3BvbnNlLFxufSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCB0aHJvd0Vycm9yIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBtYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBOb3RpZmljYXRpb25TdHJlYW1JdGVtLCBOb3RpZmljYXRpb25JdGVtLCB0b0lTT0V4dGVuZGVkRm9ybWF0IH0gZnJvbSAnQGJhY2tiYXNlL25vdGlmaWNhdGlvbnMtY29tbW9uLWFuZyc7XG5cbmltcG9ydCB7IG5vdGlmaWNhdGlvbiB9IGZyb20gJy4vbm90aWZpY2F0aW9uLW1vY2snO1xuXG5jb25zdCBERUZBVUxUX0ZSRVFVRU5DWSA9IDIwMDAwO1xuXG5jb25zdCBub3RpZmljYXRpb25SZWFkUmVnZXhwID0gL1xcL25vdGlmaWNhdGlvbnNcXC8oLiopXFwvcmVhZFxcLz8kLztcblxuZnVuY3Rpb24gZ2V0R2VuZXJhdGlvbkZyZXF1ZW5jeShmcmVxdWVuY3k6IHN0cmluZyB8IG51bGwpOiBudW1iZXIge1xuICBjb25zdCBmcmVxID0gZnJlcXVlbmN5ICYmIHBhcnNlSW50KGZyZXF1ZW5jeSwgMTApO1xuXG4gIHJldHVybiBmcmVxIHx8IERFRkFVTFRfRlJFUVVFTkNZO1xufVxuXG5mdW5jdGlvbiBjcmVhdGVOb3RpZmljYXRpb25zUGFnZShub3RpZmljYXRpb25zOiBOb3RpZmljYXRpb25JdGVtW10sIG9wdGlvbnM6IHsgZnJvbTogbnVtYmVyOyBzaXplOiBudW1iZXIgfSkge1xuICBjb25zdCB7IGZyb20sIHNpemUgfSA9IG9wdGlvbnM7XG4gIGNvbnN0IHN0YXJ0ID0gZnJvbSAqIHNpemU7XG4gIGNvbnN0IGVuZCA9IHN0YXJ0ICsgc2l6ZTtcblxuICByZXR1cm4gbm90aWZpY2F0aW9ucy5zbGljZShzdGFydCwgZW5kKTtcbn1cblxuY29uc3QgcXVpZXROb3RpZmljYXRpb25zU3RyYXRlZ3kgPSB7XG4gIFNUSUNLWV9MSU1JVDogMSxcbiAgUE9QVVBTX0xJTUlUOiAxLFxufTtcblxuY29uc3Qgbm9MaW1pdHNOb3RpZmljYXRpb25zU3RyYXRlZ3kgPSB7XG4gIFNUSUNLWV9MSU1JVDogSW5maW5pdHksXG4gIFBPUFVQU19MSU1JVDogSW5maW5pdHksXG59O1xuXG5jb25zdCBub05vdGlmaWNhdGlvbnNTdHJhdGVneSA9IHtcbiAgU1RJQ0tZX0xJTUlUOiAwLFxuICBQT1BVUFNfTElNSVQ6IDAsXG59O1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgTm90aWZpY2F0aW9uc0ludGVyY2VwdG9yIGltcGxlbWVudHMgSHR0cEludGVyY2VwdG9yIHtcbiAgcHJpdmF0ZSByZWFkb25seSBhcmVNb2Nrc0VuYWJsZWQgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnZW5hYmxlTW9ja3MnKSA9PT0gJ3RydWUnO1xuICBwcml2YXRlIHJlYWRvbmx5IGlzRW1wdHlOb3RpZmljYXRpb25zRW5hYmxlZCA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKCdub05vdGlmaWNhdGlvbnMnKSA9PT0gJ3RydWUnO1xuICBwcml2YXRlIHJlYWRvbmx5IGlzTm9MaW1pdHNOb3RpZmljYXRpb25zRW5hYmxlZCA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKCdub0xpbWl0c05vdGlmaWNhdGlvbnMnKSA9PT0gJ3RydWUnO1xuICBwcml2YXRlIHJlYWRvbmx5IGxpdmVOb3RpZmljYXRpb25GcmVxID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oJ2xpdmVOb3RpZmljYXRpb25GcmVxJyk7XG4gIHByaXZhdGUgcmVhZG9ubHkgbW9ja1N0cmF0ZWd5ID0gdGhpcy5nZXRNb2NrU3RyYXRlZ3koKTtcblxuICBwcml2YXRlIHJlYWRvbmx5IHJlYWROb3RpZmljYXRpb25zOiBhbnkgPSB7fTtcbiAgcHJpdmF0ZSByZWFkb25seSBuZXdOb3RpZmljYXRpb25zOiBOb3RpZmljYXRpb25JdGVtW10gPSBbXTtcbiAgcHJpdmF0ZSBwb3B1cHNDb3VudCA9IDA7XG4gIHByaXZhdGUgbm90aWZpY2F0aW9uc1N0cmVhbUhhbmRsZWQgPSBmYWxzZTtcbiAgcHJpdmF0ZSByZWFkb25seSBub3RpZmljYXRpb25SZXF1ZXN0VW5yZWFkSWRzID0gW107IC8vIGZyb20gc3BlYyBleGFtcGxlc1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgbmdab25lOiBOZ1pvbmUpIHtcbiAgICBpZiAodGhpcy5tb2NrU3RyYXRlZ3kgJiYgdGhpcy5saXZlTm90aWZpY2F0aW9uRnJlcSkge1xuICAgICAgdGhpcy5uZ1pvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT4ge1xuICAgICAgICBzZXRJbnRlcnZhbCgoKSA9PiB7XG4gICAgICAgICAgdGhpcy5uZXdOb3RpZmljYXRpb25zLnVuc2hpZnQoe1xuICAgICAgICAgICAgLi4ubm90aWZpY2F0aW9uLFxuICAgICAgICAgICAgaWQ6ICgzNDU2NzkgKyB0aGlzLm5ld05vdGlmaWNhdGlvbnMubGVuZ3RoKS50b1N0cmluZygpLFxuICAgICAgICAgICAgdGl0bGU6IGBOZXcgTm90aWZpY2F0aW9uICR7dGhpcy5uZXdOb3RpZmljYXRpb25zLmxlbmd0aCArIDF9YCxcbiAgICAgICAgICAgIGNyZWF0ZWRPbjogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgICAgICAgIH0pO1xuICAgICAgICB9LCBnZXRHZW5lcmF0aW9uRnJlcXVlbmN5KHRoaXMubGl2ZU5vdGlmaWNhdGlvbkZyZXEpKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIGludGVyY2VwdChyZXE6IEh0dHBSZXF1ZXN0PGFueT4sIG5leHQ6IEh0dHBIYW5kbGVyKTogT2JzZXJ2YWJsZTxIdHRwRXZlbnQ8YW55Pj4ge1xuICAgIGlmICghdGhpcy5tb2NrU3RyYXRlZ3kpIHtcbiAgICAgIHJldHVybiBuZXh0LmhhbmRsZShyZXEpO1xuICAgIH1cblxuICAgIGlmIChyZXEudXJsLmVuZHNXaXRoKCdub3RpZmljYXRpb25zL3VucmVhZC1jb3VudCcpKSB7XG4gICAgICByZXR1cm4gdGhpcy5oYW5kbGVVbnJlYWRDb3VudFJlcXVlc3QocmVxLCBuZXh0KTtcbiAgICB9XG5cbiAgICBpZiAocmVxLnVybC5lbmRzV2l0aCgnbm90aWZpY2F0aW9ucy9yZWFkJykpIHtcbiAgICAgIHJldHVybiB0aGlzLmhhbmRsZVJlYWRBbGxOb3RpZmljYXRpb25SZXF1ZXN0KHJlcSwgbmV4dCk7XG4gICAgfVxuXG4gICAgaWYgKHJlcS51cmwuZW5kc1dpdGgoJ3JlYWQnKSAmJiByZXEubWV0aG9kID09PSAnUFVUJykge1xuICAgICAgcmV0dXJuIHRoaXMuaGFuZGxlUmVhZE5vdGlmaWNhdGlvblJlcXVlc3QocmVxLCBuZXh0KTtcbiAgICB9XG5cbiAgICBpZiAocmVxLnVybC5lbmRzV2l0aCgnbm90aWZpY2F0aW9ucycpKSB7XG4gICAgICByZXR1cm4gdGhpcy5oYW5kbGVOb3RpZmljYXRpb25zUmVxdWVzdChyZXEsIG5leHQpO1xuICAgIH1cblxuICAgIGlmIChyZXEudXJsLmVuZHNXaXRoKCdub3RpZmljYXRpb25zL3N0cmVhbScpKSB7XG4gICAgICByZXR1cm4gdGhpcy5oYW5kbGVOb3RpZmljYXRpb25zU3RyZWFtUmVxdWVzdChyZXEsIG5leHQpO1xuICAgIH1cblxuICAgIHJldHVybiBuZXh0LmhhbmRsZShyZXEpO1xuICB9XG5cbiAgcHJpdmF0ZSBoYW5kbGVVbnJlYWRDb3VudFJlcXVlc3QocmVxOiBIdHRwUmVxdWVzdDxhbnk+LCBuZXh0OiBIdHRwSGFuZGxlcik6IE9ic2VydmFibGU8SHR0cEV2ZW50PGFueT4+IHtcbiAgICBpZiAodGhpcy5tb2NrU3RyYXRlZ3kgPT09IG5vTm90aWZpY2F0aW9uc1N0cmF0ZWd5KSB7XG4gICAgICByZXR1cm4gbmV4dC5oYW5kbGUocmVxKS5waXBlKFxuICAgICAgICBtYXAoKGV2ZW50OiBIdHRwRXZlbnQ8YW55PikgPT4ge1xuICAgICAgICAgIGlmIChldmVudCBpbnN0YW5jZW9mIEh0dHBSZXNwb25zZSkge1xuICAgICAgICAgICAgcmV0dXJuIGV2ZW50LmNsb25lKHtcbiAgICAgICAgICAgICAgYm9keToge1xuICAgICAgICAgICAgICAgIHVucmVhZDogMCxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHJldHVybiBldmVudDtcbiAgICAgICAgfSksXG4gICAgICApO1xuICAgIH1cblxuICAgIHJldHVybiBuZXh0LmhhbmRsZShyZXEpLnBpcGUoXG4gICAgICBtYXAoKGV2ZW50OiBIdHRwRXZlbnQ8YW55PikgPT4ge1xuICAgICAgICBpZiAoZXZlbnQgaW5zdGFuY2VvZiBIdHRwUmVzcG9uc2UpIHtcbiAgICAgICAgICByZXR1cm4gZXZlbnQuY2xvbmUoe1xuICAgICAgICAgICAgYm9keToge1xuICAgICAgICAgICAgICB1bnJlYWQ6XG4gICAgICAgICAgICAgICAgdGhpcy5uZXdOb3RpZmljYXRpb25zLmxlbmd0aCArXG4gICAgICAgICAgICAgICAgZXZlbnQuYm9keS51bnJlYWQgK1xuICAgICAgICAgICAgICAgIHRoaXMucG9wdXBzQ291bnQgLVxuICAgICAgICAgICAgICAgIE9iamVjdC5rZXlzKHRoaXMucmVhZE5vdGlmaWNhdGlvbnMpLmxlbmd0aCxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gZXZlbnQ7XG4gICAgICB9KSxcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBoYW5kbGVOb3RpZmljYXRpb25zUmVxdWVzdChyZXE6IEh0dHBSZXF1ZXN0PGFueT4sIG5leHQ6IEh0dHBIYW5kbGVyKTogT2JzZXJ2YWJsZTxIdHRwRXZlbnQ8YW55Pj4ge1xuICAgIGlmICh0aGlzLm1vY2tTdHJhdGVneSA9PT0gbm9Ob3RpZmljYXRpb25zU3RyYXRlZ3kpIHtcbiAgICAgIHJldHVybiBuZXh0LmhhbmRsZShyZXEpLnBpcGUoXG4gICAgICAgIG1hcCgoZXZlbnQ6IEh0dHBFdmVudDxhbnk+KSA9PiB7XG4gICAgICAgICAgaWYgKGV2ZW50IGluc3RhbmNlb2YgSHR0cFJlc3BvbnNlKSB7XG4gICAgICAgICAgICByZXR1cm4gZXZlbnQuY2xvbmUoe1xuICAgICAgICAgICAgICBib2R5OiBbXSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHJldHVybiBldmVudDtcbiAgICAgICAgfSksXG4gICAgICApO1xuICAgIH1cblxuICAgIHJldHVybiBuZXh0LmhhbmRsZShyZXEpLnBpcGUoXG4gICAgICBtYXAoKGV2ZW50OiBIdHRwRXZlbnQ8YW55PikgPT4ge1xuICAgICAgICBpZiAoZXZlbnQgaW5zdGFuY2VvZiBIdHRwUmVzcG9uc2UpIHtcbiAgICAgICAgICBjb25zdCBmcm9tID0gTnVtYmVyKHJlcS5wYXJhbXMuZ2V0KCdmcm9tJykpO1xuICAgICAgICAgIGNvbnN0IHNpemUgPSBOdW1iZXIocmVxLnBhcmFtcy5nZXQoJ3NpemUnKSk7XG4gICAgICAgICAgY29uc3QgdG9EYXRlID0gcmVxLnBhcmFtcy5nZXQoJ3RvRGF0ZScpO1xuXG4gICAgICAgICAgaWYgKCF0aGlzLm5vdGlmaWNhdGlvblJlcXVlc3RVbnJlYWRJZHMubGVuZ3RoKSB7XG4gICAgICAgICAgICB0aGlzLm5vdGlmaWNhdGlvblJlcXVlc3RVbnJlYWRJZHMucHVzaChcbiAgICAgICAgICAgICAgLy9AdHMtaWdub3JlXG4gICAgICAgICAgICAgIC4uLmV2ZW50LmJvZHkuZmlsdGVyKChpdGVtOiBOb3RpZmljYXRpb25JdGVtKSA9PiAhaXRlbS5yZWFkKS5tYXAoKGl0ZW06IE5vdGlmaWNhdGlvbkl0ZW0pID0+IGl0ZW0uaWQpLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBsZXQgbm90aWZpY2F0aW9ucyA9IFsuLi50aGlzLm5ld05vdGlmaWNhdGlvbnMsIC4uLmV2ZW50LmJvZHldO1xuXG4gICAgICAgICAgaWYgKHRvRGF0ZSkge1xuICAgICAgICAgICAgbm90aWZpY2F0aW9ucyA9IG5vdGlmaWNhdGlvbnMuZmlsdGVyKFxuICAgICAgICAgICAgICAoeyBjcmVhdGVkT24gfSkgPT4gbmV3IERhdGUodG9JU09FeHRlbmRlZEZvcm1hdChjcmVhdGVkT24pKS5nZXRUaW1lKCkgPD0gbmV3IERhdGUodG9EYXRlKS5nZXRUaW1lKCksXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGNvbnN0IG5vdGlmaWNhdGlvbnNQYWdlID0gY3JlYXRlTm90aWZpY2F0aW9uc1BhZ2Uobm90aWZpY2F0aW9ucywgeyBmcm9tLCBzaXplIH0pO1xuXG4gICAgICAgICAgcmV0dXJuIGV2ZW50LmNsb25lKHtcbiAgICAgICAgICAgIGJvZHk6IG5vdGlmaWNhdGlvbnNQYWdlLm1hcCgobjogeyBpZDogc3RyaW5nOyByZWFkOiBib29sZWFuIH0pID0+ICh7XG4gICAgICAgICAgICAgIC4uLm4sXG4gICAgICAgICAgICAgIHJlYWQ6IHRoaXMucmVhZE5vdGlmaWNhdGlvbnNbbi5pZF0gfHwgbi5yZWFkLFxuICAgICAgICAgICAgfSkpLFxuICAgICAgICAgICAgaGVhZGVyczogbmV3IEh0dHBIZWFkZXJzKHtcbiAgICAgICAgICAgICAgJ3gtdG90YWwtY291bnQnOiBTdHJpbmcobm90aWZpY2F0aW9ucy5sZW5ndGgpLFxuICAgICAgICAgICAgICAneC1jdXJzb3InOiBub3RpZmljYXRpb25zUGFnZVtub3RpZmljYXRpb25zUGFnZS5sZW5ndGggLSAxXS5pZCxcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGV2ZW50O1xuICAgICAgfSksXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgaGFuZGxlUmVhZEFsbE5vdGlmaWNhdGlvblJlcXVlc3QocmVxOiBIdHRwUmVxdWVzdDxhbnk+LCBuZXh0OiBIdHRwSGFuZGxlcik6IE9ic2VydmFibGU8SHR0cEV2ZW50PGFueT4+IHtcbiAgICB0aGlzLm5ld05vdGlmaWNhdGlvbnMuZm9yRWFjaChpdGVtID0+ICh0aGlzLnJlYWROb3RpZmljYXRpb25zW2l0ZW0uaWRdID0gdHJ1ZSkpO1xuICAgIHRoaXMubm90aWZpY2F0aW9uUmVxdWVzdFVucmVhZElkcy5mb3JFYWNoKGlkID0+ICh0aGlzLnJlYWROb3RpZmljYXRpb25zW2lkXSA9IHRydWUpKTtcblxuICAgIHJldHVybiBuZXh0LmhhbmRsZShyZXEpO1xuICB9XG5cbiAgcHJpdmF0ZSBoYW5kbGVSZWFkTm90aWZpY2F0aW9uUmVxdWVzdChyZXE6IEh0dHBSZXF1ZXN0PGFueT4sIG5leHQ6IEh0dHBIYW5kbGVyKTogT2JzZXJ2YWJsZTxIdHRwRXZlbnQ8YW55Pj4ge1xuICAgIGNvbnN0IFssIG5vdGlmaWNhdGlvbklkXSA9IG5vdGlmaWNhdGlvblJlYWRSZWdleHAuZXhlYyhyZXEudXJsKSBhcyBzdHJpbmdbXTtcblxuICAgIGlmIChub3RpZmljYXRpb25JZCA9PT0gJzEyMzQtNTY3OC05MDIyJykge1xuICAgICAgcmV0dXJuIHRocm93RXJyb3IoXG4gICAgICAgIG5ldyBIdHRwRXJyb3JSZXNwb25zZSh7XG4gICAgICAgICAgc3RhdHVzOiA1MDAsXG4gICAgICAgICAgc3RhdHVzVGV4dDogJycsXG4gICAgICAgIH0pLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICB0aGlzLnJlYWROb3RpZmljYXRpb25zW25vdGlmaWNhdGlvbklkXSA9IHRydWU7XG5cbiAgICByZXR1cm4gbmV4dC5oYW5kbGUocmVxKTtcbiAgfVxuXG4gIHByaXZhdGUgaGFuZGxlTm90aWZpY2F0aW9uc1N0cmVhbVJlcXVlc3QocmVxOiBIdHRwUmVxdWVzdDxhbnk+LCBuZXh0OiBIdHRwSGFuZGxlcik6IE9ic2VydmFibGU8SHR0cEV2ZW50PGFueT4+IHtcbiAgICByZXR1cm4gbmV4dC5oYW5kbGUocmVxKS5waXBlKFxuICAgICAgbWFwKChldmVudDogSHR0cEV2ZW50PGFueT4pID0+IHtcbiAgICAgICAgaWYgKGV2ZW50IGluc3RhbmNlb2YgSHR0cFJlc3BvbnNlKSB7XG4gICAgICAgICAgY29uc3QgcG9wdXBzTGltaXQgPVxuICAgICAgICAgICAgdGhpcy5tb2NrU3RyYXRlZ3kgPT09IHF1aWV0Tm90aWZpY2F0aW9uc1N0cmF0ZWd5ICYmICF0aGlzLm5vdGlmaWNhdGlvbnNTdHJlYW1IYW5kbGVkXG4gICAgICAgICAgICAgID8gMFxuICAgICAgICAgICAgICA6IC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tbm9uLW51bGwtYXNzZXJ0aW9uXG4gICAgICAgICAgICAgICAgdGhpcy5tb2NrU3RyYXRlZ3khLlBPUFVQU19MSU1JVDtcblxuICAgICAgICAgIGNvbnN0IHBvcHVwcyA9IGV2ZW50LmJvZHlcbiAgICAgICAgICAgIC5maWx0ZXIoKGl0ZW06IE5vdGlmaWNhdGlvblN0cmVhbUl0ZW0pID0+ICFpdGVtLmV4cGlyZXNPbiAmJiAhdGhpcy5yZWFkTm90aWZpY2F0aW9uc1tpdGVtLmlkXSlcbiAgICAgICAgICAgIC5zbGljZSgwLCBwb3B1cHNMaW1pdClcbiAgICAgICAgICAgIC5tYXAoKGl0ZW06IE5vdGlmaWNhdGlvblN0cmVhbUl0ZW0pID0+ICh7IC4uLml0ZW0gfSkpO1xuXG4gICAgICAgICAgY29uc3Qgc3RpY2t5ID0gZXZlbnQuYm9keVxuICAgICAgICAgICAgLmZpbHRlcigoaXRlbTogTm90aWZpY2F0aW9uU3RyZWFtSXRlbSkgPT4gISFpdGVtLmV4cGlyZXNPbilcbiAgICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tbm9uLW51bGwtYXNzZXJ0aW9uXG4gICAgICAgICAgICAuc2xpY2UoMCwgdGhpcy5tb2NrU3RyYXRlZ3khLlNUSUNLWV9MSU1JVClcbiAgICAgICAgICAgIC5maWx0ZXIoKGl0ZW06IE5vdGlmaWNhdGlvblN0cmVhbUl0ZW0pID0+ICF0aGlzLnJlYWROb3RpZmljYXRpb25zW2l0ZW0uaWRdKTtcblxuICAgICAgICAgIGNvbnN0IHJhbmRvbVBvcHVwcyA9IHBvcHVwcy5zbGljZSgwLCBNYXRoLmNlaWwoTWF0aC5yYW5kb20oKSAqIHBvcHVwcy5sZW5ndGgpKTtcblxuICAgICAgICAgIHRoaXMucG9wdXBzQ291bnQgPSBldmVudC5ib2R5Lmxlbmd0aDtcbiAgICAgICAgICB0aGlzLm5vdGlmaWNhdGlvbnNTdHJlYW1IYW5kbGVkID0gdHJ1ZTtcblxuICAgICAgICAgIHJldHVybiBldmVudC5jbG9uZSh7XG4gICAgICAgICAgICBib2R5OiBbLi4uc3RpY2t5LCAuLi5yYW5kb21Qb3B1cHNdLFxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGV2ZW50O1xuICAgICAgfSksXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0TW9ja1N0cmF0ZWd5KCkge1xuICAgIGlmICghdGhpcy5hcmVNb2Nrc0VuYWJsZWQpIHJldHVybiB1bmRlZmluZWQ7XG5cbiAgICBpZiAodGhpcy5pc0VtcHR5Tm90aWZpY2F0aW9uc0VuYWJsZWQpIHJldHVybiBub05vdGlmaWNhdGlvbnNTdHJhdGVneTtcbiAgICBpZiAodGhpcy5pc05vTGltaXRzTm90aWZpY2F0aW9uc0VuYWJsZWQpIHJldHVybiBub0xpbWl0c05vdGlmaWNhdGlvbnNTdHJhdGVneTtcblxuICAgIHJldHVybiBxdWlldE5vdGlmaWNhdGlvbnNTdHJhdGVneTtcbiAgfVxufVxuIl19