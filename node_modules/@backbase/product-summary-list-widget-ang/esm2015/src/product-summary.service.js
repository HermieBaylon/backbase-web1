import { Injectable } from '@angular/core';
import { combineLatest, of } from 'rxjs';
import { catchError, distinctUntilChanged, map, tap } from 'rxjs/operators';
import { cacheRequest, isProductVisible, ProductKindUri, } from '@backbase/product-summary-common-ang';
import { parseError } from './product-summary-error';
import { ProductSummaryBaseService } from './product-summary-base.service';
import * as i0 from "@angular/core";
import * as i1 from "@backbase/arrangement-manager-http-ang";
const clearUndefinedProperties = (obj) => JSON.parse(JSON.stringify(obj));
const aggregatedToTotalBalance = (aggregatedBalance) => ({
    aggregatedBalance: aggregatedBalance.value || '',
    currency: aggregatedBalance.currency || '',
});
const hasVisibleProducts = (products) => products.some(product => product && isProductVisible(product));
const getProductKind = (kind) => {
    switch (kind) {
        case 'currentAccounts':
            return ProductKindUri.CURRENT_ACCOUNT;
        case 'savingsAccounts':
            return ProductKindUri.SAVINGS_ACCOUNT;
        case 'termDeposits':
            return ProductKindUri.TERM_DEPOSIT;
        case 'loans':
            return ProductKindUri.LOAN;
        case 'creditCards':
            return ProductKindUri.CREDIT_CARD;
        case 'debitCards':
            return ProductKindUri.DEBIT_CARD;
        case 'investmentAccounts':
            return ProductKindUri.INVESTMENT_ACCOUNT;
        default:
            return kind;
    }
};
const objectToProductKind = (kind, productKind) => {
    const hasProducts = productKind && productKind.products && productKind.products.length > 0;
    if (hasProducts && hasVisibleProducts(productKind.products)) {
        const products = productKind.products;
        return Object.assign({ id: kind, name: productKind.name, aggregatedBalance: productKind.aggregatedBalance ? productKind.aggregatedBalance.value : undefined, currency: productKind.aggregatedBalance ? productKind.aggregatedBalance.currency : undefined, products: products
                .filter(isProductVisible)
                .map((product) => (Object.assign(Object.assign({}, product), { kind, productKindUri: getProductKind(kind) }))) }, (productKind.additions ? { additions: productKind.additions } : {}));
    }
    return undefined;
};
const arrayToProductKindList = (obj) => obj.map((element) => element && objectToProductKind(element.name, element)).filter(Boolean);
const flattenArray = (arr) => [].concat(...arr);
const toProductKindList = (res) => {
    const products = Object.entries(res)
        .filter(([key]) => key !== 'aggregatedBalance')
        .map(([kind, value]) => {
        if (!Array.isArray(value)) {
            return objectToProductKind(kind, value);
        }
        return arrayToProductKindList(value);
    })
        .filter(Boolean);
    return flattenArray(products);
};
const responseToProductKinds = (res) => clearUndefinedProperties(Object.assign({ total: res && res.aggregatedBalance ? aggregatedToTotalBalance(res.aggregatedBalance) : undefined, productKinds: res ? toProductKindList(res) : [] }, (res && res.additions ? { additions: res.additions } : {})));
/**
 * Service for fetching and storing product kinds
 *
 * This service relies on providers from `ProductSummaryListWidgetModule`.
 *
 * @see ProductSummaryListWidgetModule
 *
 * @usageNotes
 *
 * ### Ensure the ProductSummaryListWidgetModule is imported to your component module
 *
 * ```ts
 * @NgModule({
 *   ...
 *   imports: [
 *     ...
 *     ProductSummaryListWidgetModule,
 *   ],
 * })
 * export class MyWidgetModule {}
 * ```
 *
 * ### Inject this service into your component
 *
 * ```ts
 * @Component({
 *   ...
 *   providers: [ProductSummaryService],
 * })
 *  export class MyComponent {
 * ```
 */
export class ProductSummaryService extends ProductSummaryBaseService {
    constructor(productSummaryDataService) {
        super();
        this.productSummaryDataService = productSummaryDataService;
        this.productKinds = combineLatest(this.listParams.pipe(distinctUntilChanged()), // [NOTE] This may require a compare function if `ListParams` isn't a primitive
        this.productKindsRefresh).pipe(tap(() => {
            this.isLoading.next(true);
        }), cacheRequest(([params]) => this.productSummaryDataService.getProductSummary(params).pipe(map((res) => responseToProductKinds(res)), catchError((error) => {
            this.error.next(parseError(error));
            return of(undefined);
        }))), tap(() => {
            this.isLoading.next(false);
        }));
    }
}
ProductSummaryService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: ProductSummaryService, deps: [{ token: i1.ProductSummaryHttpService }], target: i0.ɵɵFactoryTarget.Injectable });
ProductSummaryService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: ProductSummaryService });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: ProductSummaryService, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.ProductSummaryHttpService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvZHVjdC1zdW1tYXJ5LnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9saWJzL3Byb2R1Y3Qtc3VtbWFyeS1saXN0LXdpZGdldC1hbmcvc3JjL3Byb2R1Y3Qtc3VtbWFyeS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFHM0MsT0FBTyxFQUFFLGFBQWEsRUFBYyxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDckQsT0FBTyxFQUFFLFVBQVUsRUFBRSxvQkFBb0IsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFlNUUsT0FBTyxFQUVMLFlBQVksRUFDWixnQkFBZ0IsRUFFaEIsY0FBYyxHQUNmLE1BQU0sc0NBQXNDLENBQUM7QUFFOUMsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQ3JELE9BQU8sRUFBZ0IseUJBQXlCLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQzs7O0FBeUJ6RixNQUFNLHdCQUF3QixHQUFHLENBQUksR0FBTSxFQUFLLEVBQUUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztBQUVuRixNQUFNLHdCQUF3QixHQUFHLENBQUMsaUJBQTJDLEVBQWdCLEVBQUUsQ0FBQyxDQUFDO0lBQy9GLGlCQUFpQixFQUFFLGlCQUFpQixDQUFDLEtBQUssSUFBSSxFQUFFO0lBQ2hELFFBQVEsRUFBRSxpQkFBaUIsQ0FBQyxRQUFRLElBQUksRUFBRTtDQUMzQyxDQUFDLENBQUM7QUFFSCxNQUFNLGtCQUFrQixHQUFHLENBQUMsUUFBbUIsRUFBVyxFQUFFLENBQzFELFFBQVEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxPQUFPLElBQUksZ0JBQWdCLENBQUMsT0FBTyxDQUFDLENB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O1FBQzVCLENBQUMsQ0FBQyxFQUNGLFlBQVksQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxDQUN4QixJQUFJLENBQUMseUJBQXlCLENBQUMsaUJBQWlCLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUMzRCxHQUFHLENBQUMsQ0FBQyxHQUFtQixFQUFFLEVBQUUsQ0FBQyxzQkFBc0IsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUN6RCxVQUFVLENBQUMsQ0FBQyxLQUF3QixFQUFFLEVBQUU7WUFDdEMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7WUFDbkMsT0FBTyxFQUFFLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDdkIsQ0FBQyxDQUFDLENBQ0gsQ0FDRixFQUNELEdBQUcsQ0FBQyxHQUFHLEVBQUU7WUFDUCxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUM3QixDQUFDLENBQUMsQ0FDSCxDQUFDO0lBckJGLENBQUM7O21IQUhVLHFCQUFxQjt1SEFBckIscUJBQXFCOzRGQUFyQixxQkFBcUI7a0JBRGpDLFVBQVUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBIdHRwRXJyb3JSZXNwb25zZSB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcblxuaW1wb3J0IHsgY29tYmluZUxhdGVzdCwgT2JzZXJ2YWJsZSwgb2YgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGNhdGNoRXJyb3IsIGRpc3RpbmN0VW50aWxDaGFuZ2VkLCBtYXAsIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7XG4gIEJhc2VQcm9kdWN0LFxuICBDcmVkaXRDYXJkUHJvZHVjdEtpbmRzLFxuICBDdXJyZW50QWNjb3VudFByb2R1Y3RLaW5kcyxcbiAgQ3VzdG9tUHJvZHVjdEtpbmQsXG4gIERlYml0Q2FyZFByb2R1Y3RLaW5kcyxcbiAgSW52ZXN0bWVudEFjY291bnRQcm9kdWN0S2luZHMsXG4gIExvYW5Qcm9kdWN0S2luZHMsXG4gIFByb2R1Y3RTdW1tYXJ5LFxuICBTYXZpbmdzQWNjb3VudFByb2R1Y3RLaW5kcyxcbiAgU3VtbWFyeUFnZ3JlZ2F0ZWRCYWxhbmNlLFxuICBUZXJtRGVwb3NpdFByb2R1Y3RLaW5kcyxcbiAgUHJvZHVjdFN1bW1hcnlIdHRwU2VydmljZSxcbn0gZnJvbSAnQGJhY2tiYXNlL2FycmFuZ2VtZW50LW1hbmFnZXItaHR0cC1hbmcnO1xuaW1wb3J0IHtcbiAgQWRkaXRpb25hbFByb3BlcnRpZXMsXG4gIGNhY2hlUmVxdWVzdCxcbiAgaXNQcm9kdWN0VmlzaWJsZSxcbiAgUHJvZHVjdCxcbiAgUHJvZHVjdEtpbmRVcmksXG59IGZyb20gJ0BiYWNrYmFzZS9wcm9kdWN0LXN1bW1hcnktY29tbW9uLWFuZyc7XG5cbmltcG9ydCB7IHBhcnNlRXJyb3IgfSBmcm9tICcuL3Byb2R1Y3Qtc3VtbWFyeS1lcnJvcic7XG5pbXBvcnQgeyBQcm9kdWN0S2luZHMsIFByb2R1Y3RTdW1tYXJ5QmFzZVNlcnZpY2UgfSBmcm9tICcuL3Byb2R1Y3Qtc3VtbWFyeS1iYXNlLnNlcnZpY2UnO1xuXG50eXBlIFByb2R1Y3RLaW5kUmVzcG9uc2UgPVxuICB8IEN1cnJlbnRBY2NvdW50UHJvZHVjdEtpbmRzXG4gIHwgU2F2aW5nc0FjY291bnRQcm9kdWN0S2luZHNcbiAgfCBUZXJtRGVwb3NpdFByb2R1Y3RLaW5kc1xuICB8IExvYW5Qcm9kdWN0S2luZHNcbiAgfCBDcmVkaXRDYXJkUHJvZHVjdEtpbmRzXG4gIHwgRGViaXRDYXJkUHJvZHVjdEtpbmRzXG4gIHwgSW52ZXN0bWVudEFjY291bnRQcm9kdWN0S2luZHNcbiAgfCBDdXN0b21Qcm9kdWN0S2luZDtcblxuZXhwb3J0IGludGVyZmFjZSBUb3RhbEJhbGFuY2UgZXh0ZW5kcyBBZGRpdGlvbmFsUHJvcGVydGllcyB7XG4gIGFnZ3JlZ2F0ZWRCYWxhbmNlOiBzdHJpbmc7XG4gIGN1cnJlbmN5OiBzdHJpbmc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUHJvZHVjdEtpbmQgZXh0ZW5kcyBBZGRpdGlvbmFsUHJvcGVydGllcyB7XG4gIGlkOiBzdHJpbmc7XG4gIG5hbWU/OiBzdHJpbmc7XG4gIGFnZ3JlZ2F0ZWRCYWxhbmNlPzogc3RyaW5nO1xuICBjdXJyZW5jeT86IHN0cmluZztcbiAgcHJvZHVjdHM/OiBBcnJheTxQcm9kdWN0Pjtcbn1cblxuY29uc3QgY2xlYXJVbmRlZmluZWRQcm9wZXJ0aWVzID0gPFQ+KG9iajogVCk6IFQgPT4gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShvYmopKTtcblxuY29uc3QgYWdncmVnYXRlZFRvVG90YWxCYWxhbmNlID0gKGFnZ3JlZ2F0ZWRCYWxhbmNlOiBTdW1tYXJ5QWdncmVnYXRlZEJhbGFuY2UpOiBUb3RhbEJhbGFuY2UgPT4gKHtcbiAgYWdncmVnYXRlZEJhbGFuY2U6IGFnZ3JlZ2F0ZWRCYWxhbmNlLnZhbHVlIHx8ICcnLFxuICBjdXJyZW5jeTogYWdncmVnYXRlZEJhbGFuY2UuY3VycmVuY3kgfHwgJycsXG59KTtcblxuY29uc3QgaGFzVmlzaWJsZVByb2R1Y3RzID0gKHByb2R1Y3RzOiBQcm9kdWN0W10pOiBib29sZWFuID0+XG4gIHByb2R1Y3RzLnNvbWUocHJvZHVjdCA9PiBwcm9kdWN0ICYmIGlzUHJvZHVjdFZpc2libGUocHJvZHVjdCkpO1xuXG5jb25zdCBnZXRQcm9kdWN0S2luZCA9IChraW5kOiBzdHJpbmcpOiBzdHJpbmcgPT4ge1xuICBzd2l0Y2ggKGtpbmQpIHtcbiAgICBjYXNlICdjdXJyZW50QWNjb3VudHMnOlxuICAgICAgcmV0dXJuIFByb2R1Y3RLaW5kVXJpLkNVUlJFTlRfQUNDT1VOVDtcbiAgICBjYXNlICdzYXZpbmdzQWNjb3VudHMnOlxuICAgICAgcmV0dXJuIFByb2R1Y3RLaW5kVXJpLlNBVklOR1NfQUNDT1VOVDtcbiAgICBjYXNlICd0ZXJtRGVwb3NpdHMnOlxuICAgICAgcmV0dXJuIFByb2R1Y3RLaW5kVXJpLlRFUk1fREVQT1NJVDtcbiAgICBjYXNlICdsb2Fucyc6XG4gICAgICByZXR1cm4gUHJvZHVjdEtpbmRVcmkuTE9BTjtcbiAgICBjYXNlICdjcmVkaXRDYXJkcyc6XG4gICAgICByZXR1cm4gUHJvZHVjdEtpbmRVcmkuQ1JFRElUX0NBUkQ7XG4gICAgY2FzZSAnZGViaXRDYXJkcyc6XG4gICAgICByZXR1cm4gUHJvZHVjdEtpbmRVcmkuREVCSVRfQ0FSRDtcbiAgICBjYXNlICdpbnZlc3RtZW50QWNjb3VudHMnOlxuICAgICAgcmV0dXJuIFByb2R1Y3RLaW5kVXJpLklOVkVTVE1FTlRfQUNDT1VOVDtcbiAgICBkZWZhdWx0OlxuICAgICAgcmV0dXJuIGtpbmQ7XG4gIH1cbn07XG5cbmNvbnN0IG9iamVjdFRvUHJvZHVjdEtpbmQgPSAoa2luZDogc3RyaW5nLCBwcm9kdWN0S2luZDogUHJvZHVjdEtpbmRSZXNwb25zZSk6IFByb2R1Y3RLaW5kIHwgdW5kZWZpbmVkID0+IHtcbiAgY29uc3QgaGFzUHJvZHVjdHMgPSBwcm9kdWN0S2luZCAmJiBwcm9kdWN0S2luZC5wcm9kdWN0cyAmJiBwcm9kdWN0S2luZC5wcm9kdWN0cy5sZW5ndGggPiAwO1xuICBpZiAoaGFzUHJvZHVjdHMgJiYgaGFzVmlzaWJsZVByb2R1Y3RzKHByb2R1Y3RLaW5kLnByb2R1Y3RzKSkge1xuICAgIGNvbnN0IHByb2R1Y3RzID0gcHJvZHVjdEtpbmQucHJvZHVjdHMgYXMgQmFzZVByb2R1Y3RbXTtcbiAgICByZXR1cm4ge1xuICAgICAgaWQ6IGtpbmQsXG4gICAgICBuYW1lOiBwcm9kdWN0S2luZC5uYW1lLFxuICAgICAgYWdncmVnYXRlZEJhbGFuY2U6IHByb2R1Y3RLaW5kLmFnZ3JlZ2F0ZWRCYWxhbmNlID8gcHJvZHVjdEtpbmQuYWdncmVnYXRlZEJhbGFuY2UudmFsdWUgOiB1bmRlZmluZWQsXG4gICAgICBjdXJyZW5jeTogcHJvZHVjdEtpbmQuYWdncmVnYXRlZEJhbGFuY2UgPyBwcm9kdWN0S2luZC5hZ2dyZWdhdGVkQmFsYW5jZS5jdXJyZW5jeSA6IHVuZGVmaW5lZCxcbiAgICAgIHByb2R1Y3RzOiBwcm9kdWN0c1xuICAgICAgICAuZmlsdGVyKGlzUHJvZHVjdFZpc2libGUpXG4gICAgICAgIC5tYXAoKHByb2R1Y3Q6IFByb2R1Y3QpID0+ICh7IC4uLnByb2R1Y3QsIGtpbmQsIHByb2R1Y3RLaW5kVXJpOiBnZXRQcm9kdWN0S2luZChraW5kKSB9KSksXG4gICAgICAuLi4ocHJvZHVjdEtpbmQuYWRkaXRpb25zID8geyBhZGRpdGlvbnM6IHByb2R1Y3RLaW5kLmFkZGl0aW9ucyB9IDoge30pLFxuICAgIH07XG4gIH1cbiAgcmV0dXJuIHVuZGVmaW5lZDtcbn07XG5cbmNvbnN0IGFycmF5VG9Qcm9kdWN0S2luZExpc3QgPSAob2JqOiBhbnkpOiBQcm9kdWN0S2luZFtdID0+XG4gIG9iai5tYXAoKGVsZW1lbnQ6IGFueSkgPT4gZWxlbWVudCAmJiBvYmplY3RUb1Byb2R1Y3RLaW5kKGVsZW1lbnQubmFtZSwgZWxlbWVudCkpLmZpbHRlcihCb29sZWFuKTtcblxuY29uc3QgZmxhdHRlbkFycmF5ID0gKGFycjogYW55KTogYW55ID0+IFtdLmNvbmNhdCguLi5hcnIpO1xuXG5jb25zdCB0b1Byb2R1Y3RLaW5kTGlzdCA9IChyZXM6IFByb2R1Y3RTdW1tYXJ5KTogUHJvZHVjdEtpbmRbXSA9PiB7XG4gIGNvbnN0IHByb2R1Y3RzID0gT2JqZWN0LmVudHJpZXMocmVzKVxuICAgIC5maWx0ZXIoKFtrZXldKSA9PiBrZXkgIT09ICdhZ2dyZWdhdGVkQmFsYW5jZScpXG4gICAgLm1hcCgoW2tpbmQsIHZhbHVlXSkgPT4ge1xuICAgICAgaWYgKCFBcnJheS5pc0FycmF5KHZhbHVlKSkge1xuICAgICAgICByZXR1cm4gb2JqZWN0VG9Qcm9kdWN0S2luZChraW5kLCB2YWx1ZSk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBhcnJheVRvUHJvZHVjdEtpbmRMaXN0KHZhbHVlKTtcbiAgICB9KVxuICAgIC5maWx0ZXIoQm9vbGVhbik7XG5cbiAgcmV0dXJuIGZsYXR0ZW5BcnJheShwcm9kdWN0cyk7XG59O1xuXG5jb25zdCByZXNwb25zZVRvUHJvZHVjdEtpbmRzID0gKHJlczogUHJvZHVjdFN1bW1hcnkpOiBQcm9kdWN0S2luZHMgPT5cbiAgY2xlYXJVbmRlZmluZWRQcm9wZXJ0aWVzKHtcbiAgICB0b3RhbDogcmVzICYmIHJlcy5hZ2dyZWdhdGVkQmFsYW5jZSA/IGFnZ3JlZ2F0ZWRUb1RvdGFsQmFsYW5jZShyZXMuYWdncmVnYXRlZEJhbGFuY2UpIDogdW5kZWZpbmVkLFxuICAgIHByb2R1Y3RLaW5kczogcmVzID8gdG9Qcm9kdWN0S2luZExpc3QocmVzKSA6IFtdLFxuICAgIC4uLihyZXMgJiYgcmVzLmFkZGl0aW9ucyA/IHsgYWRkaXRpb25zOiByZXMuYWRkaXRpb25zIH0gOiB7fSksXG4gIH0pO1xuXG4vKipcbiAqIFNlcnZpY2UgZm9yIGZldGNoaW5nIGFuZCBzdG9yaW5nIHByb2R1Y3Qga2luZHNcbiAqXG4gKiBUaGlzIHNlcnZpY2UgcmVsaWVzIG9uIHByb3ZpZGVycyBmcm9tIGBQcm9kdWN0U3VtbWFyeUxpc3RXaWRnZXRNb2R1bGVgLlxuICpcbiAqIEBzZWUgUHJvZHVjdFN1bW1hcnlMaXN0V2lkZ2V0TW9kdWxlXG4gKlxuICogQHVzYWdlTm90ZXNcbiAqXG4gKiAjIyMgRW5zdXJlIHRoZSBQcm9kdWN0U3VtbWFyeUxpc3RXaWRnZXRNb2R1bGUgaXMgaW1wb3J0ZWQgdG8geW91ciBjb21wb25lbnQgbW9kdWxlXG4gKlxuICogYGBgdHNcbiAqIEBOZ01vZHVsZSh7XG4gKiAgIC4uLlxuICogICBpbXBvcnRzOiBbXG4gKiAgICAgLi4uXG4gKiAgICAgUHJvZHVjdFN1bW1hcnlMaXN0V2lkZ2V0TW9kdWxlLFxuICogICBdLFxuICogfSlcbiAqIGV4cG9ydCBjbGFzcyBNeVdpZGdldE1vZHVsZSB7fVxuICogYGBgXG4gKlxuICogIyMjIEluamVjdCB0aGlzIHNlcnZpY2UgaW50byB5b3VyIGNvbXBvbmVudFxuICpcbiAqIGBgYHRzXG4gKiBAQ29tcG9uZW50KHtcbiAqICAgLi4uXG4gKiAgIHByb3ZpZGVyczogW1Byb2R1Y3RTdW1tYXJ5U2VydmljZV0sXG4gKiB9KVxuICogIGV4cG9ydCBjbGFzcyBNeUNvbXBvbmVudCB7XG4gKiBgYGBcbiAqL1xuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFByb2R1Y3RTdW1tYXJ5U2VydmljZSBleHRlbmRzIFByb2R1Y3RTdW1tYXJ5QmFzZVNlcnZpY2Uge1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IHByb2R1Y3RTdW1tYXJ5RGF0YVNlcnZpY2U6IFByb2R1Y3RTdW1tYXJ5SHR0cFNlcnZpY2UpIHtcbiAgICBzdXBlcigpO1xuICB9XG5cbiAgcmVhZG9ubHkgcHJvZHVjdEtpbmRzOiBPYnNlcnZhYmxlPFByb2R1Y3RLaW5kcyB8IHVuZGVmaW5lZD4gPSBjb21iaW5lTGF0ZXN0KFxuICAgIHRoaXMubGlzdFBhcmFtcy5waXBlKGRpc3RpbmN0VW50aWxDaGFuZ2VkKCkpLCAvLyBbTk9URV0gVGhpcyBtYXkgcmVxdWlyZSBhIGNvbXBhcmUgZnVuY3Rpb24gaWYgYExpc3RQYXJhbXNgIGlzbid0IGEgcHJpbWl0aXZlXG4gICAgdGhpcy5wcm9kdWN0S2luZHNSZWZyZXNoLFxuICApLnBpcGUoXG4gICAgdGFwKCgpID0+IHtcbiAgICAgIHRoaXMuaXNMb2FkaW5nLm5leHQodHJ1ZSk7XG4gICAgfSksXG4gICAgY2FjaGVSZXF1ZXN0KChbcGFyYW1zXSkgPT5cbiAgICAgIHRoaXMucHJvZHVjdFN1bW1hcnlEYXRhU2VydmljZS5nZXRQcm9kdWN0U3VtbWFyeShwYXJhbXMpLnBpcGUoXG4gICAgICAgIG1hcCgocmVzOiBQcm9kdWN0U3VtbWFyeSkgPT4gcmVzcG9uc2VUb1Byb2R1Y3RLaW5kcyhyZXMpKSxcbiAgICAgICAgY2F0Y2hFcnJvcigoZXJyb3I6IEh0dHBFcnJvclJlc3BvbnNlKSA9PiB7XG4gICAgICAgICAgdGhpcy5lcnJvci5uZXh0KHBhcnNlRXJyb3IoZXJyb3IpKTtcbiAgICAgICAgICByZXR1cm4gb2YodW5kZWZpbmVkKTtcbiAgICAgICAgfSksXG4gICAgICApLFxuICAgICksXG4gICAgdGFwKCgpID0+IHtcbiAgICAgIHRoaXMuaXNMb2FkaW5nLm5leHQoZmFsc2UpO1xuICAgIH0pLFxuICApO1xufVxuIl19