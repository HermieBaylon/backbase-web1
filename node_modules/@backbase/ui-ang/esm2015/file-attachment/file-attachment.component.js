import { ChangeDetectionStrategy, Component, EventEmitter, Inject, Input, Output, } from '@angular/core';
import { DOCUMENT } from '@angular/common';
import { isObservable } from 'rxjs';
import { take } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "@backbase/ui-ang/icon";
import * as i2 from "@backbase/ui-ang/loading-indicator";
import * as i3 from "@backbase/ui-ang/keyboard-click-directive";
import * as i4 from "@angular/common";
import * as i5 from "@backbase/ui-ang/button";
/**
 * @name FileAttachmentComponent
 *
 * @description
 * Component displays file attachment.
 *
 * @dynamic (to suppress error with resolving statics declarations during compilation)
 */
export class FileAttachmentComponent {
    constructor(document, renderer) {
        this.document = document;
        this.renderer = renderer;
        /**
         * Loading indicator flag. Defaults to false.
         */
        this.loading = false;
        /**
         * Show delete button flag. Defaults to false.
         */
        this.deletable = false;
        /**
         * Disabled state flag. Defaults to false.
         */
        this.disabled = false;
        /**
         * The flag to indicate whether the file-attachment should fill the container that it is in. Defaults to 'false'.
         */
        this.block = false;
        /**
         * Event emitted on delete button click.
         */
        this.delete = new EventEmitter();
        /**
         * File type which is determined by file extension. Defaults to 'unknown'.
         */
        this.fileType = 'unknown';
    }
    /**
     * Set name (required).
     */
    set name(value) {
        if (value === null || value === void 0 ? void 0 : value.trim()) {
            this._name = value;
            this.fileType = this.getFileType(value);
        }
        else {
            throw new Error(`"name" input is invalid in "${this.constructor.name}"`);
        }
    }
    /**
     * Get name.
     */
    get name() {
        return this._name;
    }
    /**
     * Set file size (required).
     */
    set size(value) {
        if (value !== undefined) {
            const valueAsNumber = Math.trunc(Number(value));
            this._sizeInUnits = this.formatBytes(valueAsNumber, 2);
        }
    }
    /**
     * Get file size in information units (Bytes, Kbs, etc.).
     */
    get sizeInUnits() {
        return this._sizeInUnits;
    }
    /**
     * Set file content (required if disabled property is not set to true).
     */
    set fileContent(value) {
        if (value && isObservable(value)) {
            this._fileContent = value;
        }
        else {
            throw new Error(`"fileContent" stream input is invalid in "${this.constructor.name}"`);
        }
    }
    /**
     * Get file content.
     */
    get fileContent() {
        return this._fileContent;
    }
    ngOnInit() {
        if (!this._name) {
            throw new Error(`"name" input is required in "${this.constructor.name}"`);
        }
        if (!this.disabled && !this._fileContent) {
            throw new Error(`"fileContent" input is required in "${this.constructor.name}"`);
        }
    }
    /**
     * Download attachment method.
     *
     * @param $event Download button click event
     */
    onDownload($event) {
        $event.stopPropagation();
        if (this.fileContent) {
            this.fileContent.pipe(take(1)).subscribe((response) => {
                if (!this.document.defaultView) {
                    return;
                }
                const window = this.document.defaultView;
                const blob = new window.Blob([response]);
                if (window.navigator.msSaveBlob) {
                    window.navigator.msSaveBlob(blob, this.name);
                }
                else {
                    const fileURL = window.URL.createObjectURL(blob);
                    const link = this.renderer.createElement('a');
                    link.setAttribute('href', fileURL);
                    link.setAttribute('target', '_blank');
                    link.setAttribute('download', this.name || '');
                    link.click();
                    URL.revokeObjectURL(fileURL);
                }
            });
        }
    }
    /**
     * Delete attachment event emitter.
     *
     * @param event Delete button click event.
     */
    onDelete(event) {
        event.stopPropagation();
        this.delete.emit();
    }
    getFileType(fileName) {
        return fileName.includes('.') ? fileName.toLowerCase().split('.').pop() || 'unknown' : 'unknown';
    }
    formatBytes(bytes, decimals) {
        if (bytes === 0) {
            return {
                value: 0,
                unit: 'Bytes',
            };
        }
        const k = 1024;
        const dm = decimals <= 0 ? 0 : decimals || 2;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return {
            value: parseFloat((bytes / Math.pow(k, i)).toFixed(dm)),
            unit: sizes[i],
        };
    }
}
FileAttachmentComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: FileAttachmentComponent, deps: [{ token: DOCUMENT }, { token: i0.Renderer2 }], target: i0.ɵɵFactoryTarget.Component });
FileAttachmentComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "12.0.0", version: "12.2.16", type: FileAttachmentComponent, selector: "bb-file-attachment-ui", inputs: { name: "name", size: "size", fileContent: "fileContent", loading: "loading", deletable: "deletable", disabled: "disabled", block: "block" }, outputs: { delete: "delete" }, ngImport: i0, template: "<div\n  class=\"bb-attachment-ui bb-card bb-card--sm\"\n  [class.bb-attachment-ui--block]=\"block\"\n  [attr.role]=\"disabled || deletable ? null : 'button'\"\n  [tabindex]=\"disabled ? -1 : 0\"\n  data-role=\"download-attachment\"\n  aria-describedby=\"file-attachment-card-body\"\n  (bbKeyboardClick)=\"!disabled && onDownload($event)\"\n>\n  <div class=\"bb-stack bb-stack--align-top bb-card__body\" id=\"file-attachment-card-body\">\n    <div class=\"bb-stack__item\">\n      <em\n        data-role=\"file-type-icon\"\n        [attr.aria-label]=\"fileType\"\n        [ngClass]=\"'bb-icon-file-' + fileType\"\n        class=\"bb-icon bb-icon--md bb-message-attachment__content\"\n        [class.bb-message-attachment__content--disabled]=\"loading\"\n      ></em>\n    </div>\n    <div class=\"bb-stack__item text-truncate\" [class.bb-message-attachment__content--disabled]=\"loading\">\n      <span class=\"bb-block bb-block--xs\" data-role=\"attachment-name\">{{ name }}</span>\n      <div *ngIf=\"sizeInUnits\">\n        <span class=\"bb-text-support\" data-role=\"attachment-size\"\n          >{{ sizeInUnits.value }}\n          <span i18n=\"File size|Attachment file size in units@@fileAttachment.fileSize\"\n            >{ sizeInUnits.unit, select, Bytes {Bytes} KB {KB} MB {MB} GB {GB} TB {TB} }</span\n          ></span\n        >\n      </div>\n    </div>\n    <div *ngIf=\"loading || deletable\" class=\"bb-stack__item bb-stack__item--push-right\">\n      <button\n        bbButton\n        color=\"link-text\"\n        *ngIf=\"deletable && !loading\"\n        class=\"bb-text-support\"\n        aria-label=\"Delete file\"\n        i18n-aria-label=\"Delete file button@@fileAttachment.deleteButton.ariaLabel\"\n        data-role=\"file-attachment-delete-button\"\n        (click)=\"onDelete($event)\"\n      >\n        <bb-icon-ui name=\"times\"></bb-icon-ui>\n      </button>\n\n      <bb-loading-indicator-ui\n        *ngIf=\"loading\"\n        class=\"bb-message-attachment__loader\"\n        loaderSize=\"sm\"\n        aria-label=\"Loading\"\n        i18n-aria-label=\"Loading|File attachment loading indicator@@fileAttachment.loadingIndicator.ariaLabel\"\n      >\n      </bb-loading-indicator-ui>\n    </div>\n  </div>\n</div>\n", components: [{ type: i1.IconComponent, selector: "bb-icon-ui", inputs: ["name", "inverse", "size", "color", "animate", "aria-label", "cropped", "backgroundType"] }, { type: i2.LoadingIndicatorComponent, selector: "bb-loading-indicator-ui", inputs: ["text", "loaderSize", "showDelay", "hasBackground", "inline"] }], directives: [{ type: i3.KeyboardClickDirective, selector: "[bbKeyboardClick]", outputs: ["bbKeyboardClick"] }, { type: i4.NgClass, selector: "[ngClass]", inputs: ["class", "ngClass"] }, { type: i4.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { type: i5.ButtonDirective, selector: "button[bbButton]", inputs: ["type", "color", "buttonSize", "block", "circle"] }], changeDetection: i0.ChangeDetectionStrategy.OnPush });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: FileAttachmentComponent, decorators: [{
            type: Component,
            args: [{
                    selector: 'bb-file-attachment-ui',
                    templateUrl: './file-attachment.component.html',
                    changeDetection: ChangeDetectionStrategy.OnPush,
                }]
        }], ctorParameters: function () { return [{ type: Document, decorators: [{
                    type: Inject,
                    args: [DOCUMENT]
                }] }, { type: i0.Renderer2 }]; }, propDecorators: { name: [{
                type: Input
            }], size: [{
                type: Input
            }], fileContent: [{
                type: Input
            }], loading: [{
                type: Input
            }], deletable: [{
                type: Input
            }], disabled: [{
                type: Input
            }], block: [{
                type: Input
            }], delete: [{
                type: Output
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsZS1hdHRhY2htZW50LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL2xpYnMvdWktYW5nL2ZpbGUtYXR0YWNobWVudC9maWxlLWF0dGFjaG1lbnQuY29tcG9uZW50LnRzIiwiLi4vLi4vLi4vLi4vLi4vbGlicy91aS1hbmcvZmlsZS1hdHRhY2htZW50L2ZpbGUtYXR0YWNobWVudC5jb21wb25lbnQuaHRtbCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0wsdUJBQXVCLEVBQ3ZCLFNBQVMsRUFDVCxZQUFZLEVBQ1osTUFBTSxFQUNOLEtBQUssRUFFTCxNQUFNLEdBRVAsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzNDLE9BQU8sRUFBRSxZQUFZLEVBQWMsTUFBTSxNQUFNLENBQUM7QUFDaEQsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLGdCQUFnQixDQUFDOzs7Ozs7O0FBT3RDOzs7Ozs7O0dBT0c7QUFPSCxNQUFNLE9BQU8sdUJBQXVCO0lBNkZsQyxZQUErQyxRQUFrQixFQUFtQixRQUFtQjtRQUF4RCxhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQW1CLGFBQVEsR0FBUixRQUFRLENBQVc7UUFsQ3ZHOztXQUVHO1FBQ00sWUFBTyxHQUFHLEtBQUssQ0FBQztRQUV6Qjs7V0FFRztRQUNNLGNBQVMsR0FBRyxLQUFLLENBQUM7UUFFM0I7O1dBRUc7UUFDTSxhQUFRLEdBQUcsS0FBSyxDQUFDO1FBRTFCOztXQUVHO1FBQ00sVUFBSyxHQUFHLEtBQUssQ0FBQztRQUV2Qjs7V0FFRztRQUNPLFdBQU0sR0FBRyxJQUFJLFlBQVksRUFBUSxDQUFDO1FBRTVDOztXQUVHO1FBQ0gsYUFBUSxHQUFHLFNBQVMsQ0FBQztJQU1xRixDQUFDO0lBNUYzRzs7T0FFRztJQUNILElBQ0ksSUFBSSxDQUFDLEtBQXlCO1FBQ2hDLElBQUksS0FBSyxh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SUFBSSxDQUFDLENBQUM7UUFDaEQsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUVwRCxPQUFPO1lBQ0wsS0FBSyxFQUFFLFVBQVUsQ0FBQyxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUN2RCxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQztTQUNmLENBQUM7SUFDSixDQUFDOztxSEF4S1UsdUJBQXVCLGtCQTZGZCxRQUFRO3lHQTdGakIsdUJBQXVCLGtQQ2pDcEMsd3NFQXVEQTs0RkR0QmEsdUJBQXVCO2tCQUxuQyxTQUFTO21CQUFDO29CQUNULFFBQVEsRUFBRSx1QkFBdUI7b0JBQ2pDLFdBQVcsRUFBRSxrQ0FBa0M7b0JBQy9DLGVBQWUsRUFBRSx1QkFBdUIsQ0FBQyxNQUFNO2lCQUNoRDswREE4RjBELFFBQVE7MEJBQXBELE1BQU07MkJBQUMsUUFBUTtvRUF4RnhCLElBQUk7c0JBRFAsS0FBSztnQkFxQkYsSUFBSTtzQkFEUCxLQUFLO2dCQW9CRixXQUFXO3NCQURkLEtBQUs7Z0JBbUJHLE9BQU87c0JBQWYsS0FBSztnQkFLRyxTQUFTO3NCQUFqQixLQUFLO2dCQUtHLFFBQVE7c0JBQWhCLEtBQUs7Z0JBS0csS0FBSztzQkFBYixLQUFLO2dCQUtJLE1BQU07c0JBQWYsTUFBTSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENoYW5nZURldGVjdGlvblN0cmF0ZWd5LFxuICBDb21wb25lbnQsXG4gIEV2ZW50RW1pdHRlcixcbiAgSW5qZWN0LFxuICBJbnB1dCxcbiAgT25Jbml0LFxuICBPdXRwdXQsXG4gIFJlbmRlcmVyMixcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBET0NVTUVOVCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5pbXBvcnQgeyBpc09ic2VydmFibGUsIE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IHRha2UgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgRmlsZVNpemUge1xuICB2YWx1ZTogbnVtYmVyO1xuICB1bml0OiBzdHJpbmc7XG59XG5cbi8qKlxuICogQG5hbWUgRmlsZUF0dGFjaG1lbnRDb21wb25lbnRcbiAqXG4gKiBAZGVzY3JpcHRpb25cbiAqIENvbXBvbmVudCBkaXNwbGF5cyBmaWxlIGF0dGFjaG1lbnQuXG4gKlxuICogQGR5bmFtaWMgKHRvIHN1cHByZXNzIGVycm9yIHdpdGggcmVzb2x2aW5nIHN0YXRpY3MgZGVjbGFyYXRpb25zIGR1cmluZyBjb21waWxhdGlvbilcbiAqL1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdiYi1maWxlLWF0dGFjaG1lbnQtdWknLFxuICB0ZW1wbGF0ZVVybDogJy4vZmlsZS1hdHRhY2htZW50LmNvbXBvbmVudC5odG1sJyxcbiAgY2hhbmdlRGV0ZWN0aW9uOiBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneS5PblB1c2gsXG59KVxuZXhwb3J0IGNsYXNzIEZpbGVBdHRhY2htZW50Q29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0IHtcbiAgLyoqXG4gICAqIFNldCBuYW1lIChyZXF1aXJlZCkuXG4gICAqL1xuICBASW5wdXQoKVxuICBzZXQgbmFtZSh2YWx1ZTogc3RyaW5nIHwgdW5kZWZpbmVkKSB7XG4gICAgaWYgKHZhbHVlPy50cmltKCkpIHtcbiAgICAgIHRoaXMuX25hbWUgPSB2YWx1ZTtcbiAgICAgIHRoaXMuZmlsZVR5cGUgPSB0aGlzLmdldEZpbGVUeXBlKHZhbHVlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBcIm5hbWVcIiBpbnB1dCBpcyBpbnZhbGlkIGluIFwiJHt0aGlzLmNvbnN0cnVjdG9yLm5hbWV9XCJgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2V0IG5hbWUuXG4gICAqL1xuICBnZXQgbmFtZSgpIHtcbiAgICByZXR1cm4gdGhpcy5fbmFtZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXQgZmlsZSBzaXplIChyZXF1aXJlZCkuXG4gICAqL1xuICBASW5wdXQoKVxuICBzZXQgc2l6ZSh2YWx1ZTogbnVtYmVyIHwgc3RyaW5nIHwgdW5kZWZpbmVkKSB7XG4gICAgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIGNvbnN0IHZhbHVlQXNOdW1iZXIgPSBNYXRoLnRydW5jKE51bWJlcih2YWx1ZSkpO1xuXG4gICAgICB0aGlzLl9zaXplSW5Vbml0cyA9IHRoaXMuZm9ybWF0Qnl0ZXModmFsdWVBc051bWJlciwgMik7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEdldCBmaWxlIHNpemUgaW4gaW5mb3JtYXRpb24gdW5pdHMgKEJ5dGVzLCBLYnMsIGV0Yy4pLlxuICAgKi9cbiAgZ2V0IHNpemVJblVuaXRzKCkge1xuICAgIHJldHVybiB0aGlzLl9zaXplSW5Vbml0cztcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXQgZmlsZSBjb250ZW50IChyZXF1aXJlZCBpZiBkaXNhYmxlZCBwcm9wZXJ0eSBpcyBub3Qgc2V0IHRvIHRydWUpLlxuICAgKi9cbiAgQElucHV0KClcbiAgc2V0IGZpbGVDb250ZW50KHZhbHVlOiBPYnNlcnZhYmxlPEFycmF5QnVmZmVyPiB8IHVuZGVmaW5lZCkge1xuICAgIGlmICh2YWx1ZSAmJiBpc09ic2VydmFibGUodmFsdWUpKSB7XG4gICAgICB0aGlzLl9maWxlQ29udGVudCA9IHZhbHVlO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFwiZmlsZUNvbnRlbnRcIiBzdHJlYW0gaW5wdXQgaXMgaW52YWxpZCBpbiBcIiR7dGhpcy5jb25zdHJ1Y3Rvci5uYW1lfVwiYCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEdldCBmaWxlIGNvbnRlbnQuXG4gICAqL1xuICBnZXQgZmlsZUNvbnRlbnQoKSB7XG4gICAgcmV0dXJuIHRoaXMuX2ZpbGVDb250ZW50O1xuICB9XG5cbiAgLyoqXG4gICAqIExvYWRpbmcgaW5kaWNhdG9yIGZsYWcuIERlZmF1bHRzIHRvIGZhbHNlLlxuICAgKi9cbiAgQElucHV0KCkgbG9hZGluZyA9IGZhbHNlO1xuXG4gIC8qKlxuICAgKiBTaG93IGRlbGV0ZSBidXR0b24gZmxhZy4gRGVmYXVsdHMgdG8gZmFsc2UuXG4gICAqL1xuICBASW5wdXQoKSBkZWxldGFibGUgPSBmYWxzZTtcblxuICAvKipcbiAgICogRGlzYWJsZWQgc3RhdGUgZmxhZy4gRGVmYXVsdHMgdG8gZmFsc2UuXG4gICAqL1xuICBASW5wdXQoKSBkaXNhYmxlZCA9IGZhbHNlO1xuXG4gIC8qKlxuICAgKiBUaGUgZmxhZyB0byBpbmRpY2F0ZSB3aGV0aGVyIHRoZSBmaWxlLWF0dGFjaG1lbnQgc2hvdWxkIGZpbGwgdGhlIGNvbnRhaW5lciB0aGF0IGl0IGlzIGluLiBEZWZhdWx0cyB0byAnZmFsc2UnLlxuICAgKi9cbiAgQElucHV0KCkgYmxvY2sgPSBmYWxzZTtcblxuICAvKipcbiAgICogRXZlbnQgZW1pdHRlZCBvbiBkZWxldGUgYnV0dG9uIGNsaWNrLlxuICAgKi9cbiAgQE91dHB1dCgpIGRlbGV0ZSA9IG5ldyBFdmVudEVtaXR0ZXI8dm9pZD4oKTtcblxuICAvKipcbiAgICogRmlsZSB0eXBlIHdoaWNoIGlzIGRldGVybWluZWQgYnkgZmlsZSBleHRlbnNpb24uIERlZmF1bHRzIHRvICd1bmtub3duJy5cbiAgICovXG4gIGZpbGVUeXBlID0gJ3Vua25vd24nO1xuXG4gIHByaXZhdGUgX3NpemVJblVuaXRzOiBGaWxlU2l6ZSB8IHVuZGVmaW5lZDtcbiAgcHJpdmF0ZSBfbmFtZTogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICBwcml2YXRlIF9maWxlQ29udGVudDogT2JzZXJ2YWJsZTxBcnJheUJ1ZmZlcj4gfCB1bmRlZmluZWQ7XG5cbiAgY29uc3RydWN0b3IoQEluamVjdChET0NVTUVOVCkgcHJpdmF0ZSByZWFkb25seSBkb2N1bWVudDogRG9jdW1lbnQsIHByaXZhdGUgcmVhZG9ubHkgcmVuZGVyZXI6IFJlbmRlcmVyMikge31cblxuICBuZ09uSW5pdCgpIHtcbiAgICBpZiAoIXRoaXMuX25hbWUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgXCJuYW1lXCIgaW5wdXQgaXMgcmVxdWlyZWQgaW4gXCIke3RoaXMuY29uc3RydWN0b3IubmFtZX1cImApO1xuICAgIH1cblxuICAgIGlmICghdGhpcy5kaXNhYmxlZCAmJiAhdGhpcy5fZmlsZUNvbnRlbnQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgXCJmaWxlQ29udGVudFwiIGlucHV0IGlzIHJlcXVpcmVkIGluIFwiJHt0aGlzLmNvbnN0cnVjdG9yLm5hbWV9XCJgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogRG93bmxvYWQgYXR0YWNobWVudCBtZXRob2QuXG4gICAqXG4gICAqIEBwYXJhbSAkZXZlbnQgRG93bmxvYWQgYnV0dG9uIGNsaWNrIGV2ZW50XG4gICAqL1xuICBvbkRvd25sb2FkKCRldmVudDogRXZlbnQpIHtcbiAgICAkZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG5cbiAgICBpZiAodGhpcy5maWxlQ29udGVudCkge1xuICAgICAgdGhpcy5maWxlQ29udGVudC5waXBlKHRha2UoMSkpLnN1YnNjcmliZSgocmVzcG9uc2U6IEFycmF5QnVmZmVyKSA9PiB7XG4gICAgICAgIGlmICghdGhpcy5kb2N1bWVudC5kZWZhdWx0Vmlldykge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCB3aW5kb3cgPSB0aGlzLmRvY3VtZW50LmRlZmF1bHRWaWV3O1xuICAgICAgICBjb25zdCBibG9iID0gbmV3IHdpbmRvdy5CbG9iKFtyZXNwb25zZV0pO1xuXG4gICAgICAgIGlmICh3aW5kb3cubmF2aWdhdG9yLm1zU2F2ZUJsb2IpIHtcbiAgICAgICAgICB3aW5kb3cubmF2aWdhdG9yLm1zU2F2ZUJsb2IoYmxvYiwgdGhpcy5uYW1lKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb25zdCBmaWxlVVJMID0gd2luZG93LlVSTC5jcmVhdGVPYmplY3RVUkwoYmxvYik7XG4gICAgICAgICAgY29uc3QgbGluayA9IHRoaXMucmVuZGVyZXIuY3JlYXRlRWxlbWVudCgnYScpO1xuXG4gICAgICAgICAgbGluay5zZXRBdHRyaWJ1dGUoJ2hyZWYnLCBmaWxlVVJMKTtcbiAgICAgICAgICBsaW5rLnNldEF0dHJpYnV0ZSgndGFyZ2V0JywgJ19ibGFuaycpO1xuICAgICAgICAgIGxpbmsuc2V0QXR0cmlidXRlKCdkb3dubG9hZCcsIHRoaXMubmFtZSB8fCAnJyk7XG4gICAgICAgICAgbGluay5jbGljaygpO1xuICAgICAgICAgIFVSTC5yZXZva2VPYmplY3RVUkwoZmlsZVVSTCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBEZWxldGUgYXR0YWNobWVudCBldmVudCBlbWl0dGVyLlxuICAgKlxuICAgKiBAcGFyYW0gZXZlbnQgRGVsZXRlIGJ1dHRvbiBjbGljayBldmVudC5cbiAgICovXG4gIG9uRGVsZXRlKGV2ZW50OiBNb3VzZUV2ZW50KSB7XG4gICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgdGhpcy5kZWxldGUuZW1pdCgpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRGaWxlVHlwZShmaWxlTmFtZTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICByZXR1cm4gZmlsZU5hbWUuaW5jbHVkZXMoJy4nKSA/IGZpbGVOYW1lLnRvTG93ZXJDYXNlKCkuc3BsaXQoJy4nKS5wb3AoKSB8fCAndW5rbm93bicgOiAndW5rbm93bic7XG4gIH1cblxuICBwcml2YXRlIGZvcm1hdEJ5dGVzKGJ5dGVzOiBudW1iZXIsIGRlY2ltYWxzOiBudW1iZXIpOiBGaWxlU2l6ZSB7XG4gICAgaWYgKGJ5dGVzID09PSAwKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICB2YWx1ZTogMCxcbiAgICAgICAgdW5pdDogJ0J5dGVzJyxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgY29uc3QgayA9IDEwMjQ7XG4gICAgY29uc3QgZG0gPSBkZWNpbWFscyA8PSAwID8gMCA6IGRlY2ltYWxzIHx8IDI7XG4gICAgY29uc3Qgc2l6ZXMgPSBbJ0J5dGVzJywgJ0tCJywgJ01CJywgJ0dCJywgJ1RCJ107XG4gICAgY29uc3QgaSA9IE1hdGguZmxvb3IoTWF0aC5sb2coYnl0ZXMpIC8gTWF0aC5sb2coaykpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHZhbHVlOiBwYXJzZUZsb2F0KChieXRlcyAvIE1hdGgucG93KGssIGkpKS50b0ZpeGVkKGRtKSksXG4gICAgICB1bml0OiBzaXplc1tpXSxcbiAgICB9O1xuICB9XG59XG4iLCI8ZGl2XG4gIGNsYXNzPVwiYmItYXR0YWNobWVudC11aSBiYi1jYXJkIGJiLWNhcmQtLXNtXCJcbiAgW2NsYXNzLmJiLWF0dGFjaG1lbnQtdWktLWJsb2NrXT1cImJsb2NrXCJcbiAgW2F0dHIucm9sZV09XCJkaXNhYmxlZCB8fCBkZWxldGFibGUgPyBudWxsIDogJ2J1dHRvbidcIlxuICBbdGFiaW5kZXhdPVwiZGlzYWJsZWQgPyAtMSA6IDBcIlxuICBkYXRhLXJvbGU9XCJkb3dubG9hZC1hdHRhY2htZW50XCJcbiAgYXJpYS1kZXNjcmliZWRieT1cImZpbGUtYXR0YWNobWVudC1jYXJkLWJvZHlcIlxuICAoYmJLZXlib2FyZENsaWNrKT1cIiFkaXNhYmxlZCAmJiBvbkRvd25sb2FkKCRldmVudClcIlxuPlxuICA8ZGl2IGNsYXNzPVwiYmItc3RhY2sgYmItc3RhY2stLWFsaWduLXRvcCBiYi1jYXJkX19ib2R5XCIgaWQ9XCJmaWxlLWF0dGFjaG1lbnQtY2FyZC1ib2R5XCI+XG4gICAgPGRpdiBjbGFzcz1cImJiLXN0YWNrX19pdGVtXCI+XG4gICAgICA8ZW1cbiAgICAgICAgZGF0YS1yb2xlPVwiZmlsZS10eXBlLWljb25cIlxuICAgICAgICBbYXR0ci5hcmlhLWxhYmVsXT1cImZpbGVUeXBlXCJcbiAgICAgICAgW25nQ2xhc3NdPVwiJ2JiLWljb24tZmlsZS0nICsgZmlsZVR5cGVcIlxuICAgICAgICBjbGFzcz1cImJiLWljb24gYmItaWNvbi0tbWQgYmItbWVzc2FnZS1hdHRhY2htZW50X19jb250ZW50XCJcbiAgICAgICAgW2NsYXNzLmJiLW1lc3NhZ2UtYXR0YWNobWVudF9fY29udGVudC0tZGlzYWJsZWRdPVwibG9hZGluZ1wiXG4gICAgICA+PC9lbT5cbiAgICA8L2Rpdj5cbiAgICA8ZGl2IGNsYXNzPVwiYmItc3RhY2tfX2l0ZW0gdGV4dC10cnVuY2F0ZVwiIFtjbGFzcy5iYi1tZXNzYWdlLWF0dGFjaG1lbnRfX2NvbnRlbnQtLWRpc2FibGVkXT1cImxvYWRpbmdcIj5cbiAgICAgIDxzcGFuIGNsYXNzPVwiYmItYmxvY2sgYmItYmxvY2stLXhzXCIgZGF0YS1yb2xlPVwiYXR0YWNobWVudC1uYW1lXCI+e3sgbmFtZSB9fTwvc3Bhbj5cbiAgICAgIDxkaXYgKm5nSWY9XCJzaXplSW5Vbml0c1wiPlxuICAgICAgICA8c3BhbiBjbGFzcz1cImJiLXRleHQtc3VwcG9ydFwiIGRhdGEtcm9sZT1cImF0dGFjaG1lbnQtc2l6ZVwiXG4gICAgICAgICAgPnt7IHNpemVJblVuaXRzLnZhbHVlIH19XG4gICAgICAgICAgPHNwYW4gaTE4bj1cIkZpbGUgc2l6ZXxBdHRhY2htZW50IGZpbGUgc2l6ZSBpbiB1bml0c0BAZmlsZUF0dGFjaG1lbnQuZmlsZVNpemVcIlxuICAgICAgICAgICAgPnsgc2l6ZUluVW5pdHMudW5pdCwgc2VsZWN0LCBCeXRlcyB7Qnl0ZXN9IEtCIHtLQn0gTUIge01CfSBHQiB7R0J9IFRCIHtUQn0gfTwvc3BhblxuICAgICAgICAgID48L3NwYW5cbiAgICAgICAgPlxuICAgICAgPC9kaXY+XG4gICAgPC9kaXY+XG4gICAgPGRpdiAqbmdJZj1cImxvYWRpbmcgfHwgZGVsZXRhYmxlXCIgY2xhc3M9XCJiYi1zdGFja19faXRlbSBiYi1zdGFja19faXRlbS0tcHVzaC1yaWdodFwiPlxuICAgICAgPGJ1dHRvblxuICAgICAgICBiYkJ1dHRvblxuICAgICAgICBjb2xvcj1cImxpbmstdGV4dFwiXG4gICAgICAgICpuZ0lmPVwiZGVsZXRhYmxlICYmICFsb2FkaW5nXCJcbiAgICAgICAgY2xhc3M9XCJiYi10ZXh0LXN1cHBvcnRcIlxuICAgICAgICBhcmlhLWxhYmVsPVwiRGVsZXRlIGZpbGVcIlxuICAgICAgICBpMThuLWFyaWEtbGFiZWw9XCJEZWxldGUgZmlsZSBidXR0b25AQGZpbGVBdHRhY2htZW50LmRlbGV0ZUJ1dHRvbi5hcmlhTGFiZWxcIlxuICAgICAgICBkYXRhLXJvbGU9XCJmaWxlLWF0dGFjaG1lbnQtZGVsZXRlLWJ1dHRvblwiXG4gICAgICAgIChjbGljayk9XCJvbkRlbGV0ZSgkZXZlbnQpXCJcbiAgICAgID5cbiAgICAgICAgPGJiLWljb24tdWkgbmFtZT1cInRpbWVzXCI+PC9iYi1pY29uLXVpPlxuICAgICAgPC9idXR0b24+XG5cbiAgICAgIDxiYi1sb2FkaW5nLWluZGljYXRvci11aVxuICAgICAgICAqbmdJZj1cImxvYWRpbmdcIlxuICAgICAgICBjbGFzcz1cImJiLW1lc3NhZ2UtYXR0YWNobWVudF9fbG9hZGVyXCJcbiAgICAgICAgbG9hZGVyU2l6ZT1cInNtXCJcbiAgICAgICAgYXJpYS1sYWJlbD1cIkxvYWRpbmdcIlxuICAgICAgICBpMThuLWFyaWEtbGFiZWw9XCJMb2FkaW5nfEZpbGUgYXR0YWNobWVudCBsb2FkaW5nIGluZGljYXRvckBAZmlsZUF0dGFjaG1lbnQubG9hZGluZ0luZGljYXRvci5hcmlhTGFiZWxcIlxuICAgICAgPlxuICAgICAgPC9iYi1sb2FkaW5nLWluZGljYXRvci11aT5cbiAgICA8L2Rpdj5cbiAgPC9kaXY+XG48L2Rpdj5cbiJdfQ==