import { ChangeDetectionStrategy, Component, forwardRef, HostBinding, Inject, Input, LOCALE_ID, ViewChild, } from '@angular/core';
import { InputBaseComponent } from '@backbase/ui-ang/base-classes';
import { NG_VALUE_ACCESSOR } from '@angular/forms';
import BigNumber from 'bignumber.js';
import { getCurrencySymbol, getLocaleNumberSymbol, getNumberOfCurrencyDigits, NumberSymbol } from '@angular/common';
import { idListAttr } from '@backbase/ui-ang/util';
import * as i0 from "@angular/core";
import * as i1 from "@backbase/foundation-ang/future";
import * as i2 from "@angular/common";
/**
 * @name AmountInputComponent
 *
 * @a11y Current component provide option to pass needed accessibility
 * attributes. You need to take care of properties that are required in your case :
 *  - set aria-describedby with ID of another element in the DOM with descriptive text about the amount input,
 *    by default it is set to div defining the type of currency
 *  - set aria-invalid with boolean value when the entered input value is not valid
 *  - set aria-labelledby with ID of another element in the DOM as input's label
 *
 * @description
 * Component that displays a text input.
 */
export class AmountInputComponent extends InputBaseComponent {
    constructor(cd, deprecationsService, locale, renderer) {
        super(cd, deprecationsService);
        this.locale = locale;
        this.renderer = renderer;
        this.inputClass = 'bb-amount-input';
        /**
         * Unique ID used for the accessibility property. New value is created when component is initialized.
         *
         * @internal
         */
        this.componentUniqueId = `${this.id}-currency`;
        /**
         * Utility function for use in template
         */
        this.idListAttr = idListAttr;
        /**
         * The placeholder for the text input. Defaults to an empty string;
         */
        this.placeholder = '';
        /**
         * classnames for the wrapper div
         */
        this.wrapperClasses = '';
        /**
         * Whether currency local should be transformed to symbol.
         * Default value true.
         */
        this.mapCurrency = true;
        /**
         * Determines currency type.
         * If nothing provided, wouldn't be displayed.
         */
        this._currency = '';
        this._decimals = 2;
        /**
         * The flag to wether auto add decimal part or not defaults to false
         */
        this.autoDecimal = false;
        this.groupSeparator = getLocaleNumberSymbol(this.locale, NumberSymbol.CurrencyGroup);
        this.decimalSeparator = getLocaleNumberSymbol(this.locale, NumberSymbol.CurrencyDecimal);
        this.nonNumbersAndDecimalSeparatorRegex = new RegExp(`[^${this.decimalSeparator}\\d]`, 'g');
        this.endWithDecimal = new RegExp(`[${this.decimalSeparator}]$`, 'g');
        this.format = {
            groupSeparator: this.groupSeparator,
            decimalSeparator: this.decimalSeparator,
            groupSize: 3,
        };
    }
    set currency(value) {
        if (value) {
            this._currency = this.mapCurrency ? getCurrencySymbol(value, 'wide', this.locale) : value;
            this._decimals = getNumberOfCurrencyDigits(value);
        }
    }
    get currency() {
        return this._currency;
    }
    writeValue(model) {
        const sanitizedInput = model !== null && model !== void 0 ? model : '';
        if (typeof sanitizedInput === 'string') {
            const numeric = sanitizedInput.replace(this.nonNumbersAndDecimalSeparatorRegex, '').slice(0, this.maxLength) || '';
            this.renderer.setProperty(this.amountEl.nativeElement, 'value', this.formatAmount(numeric));
        }
    }
    formatAmount(numeric) {
        if (numeric) {
            if (numeric.includes(this.decimalSeparator)) {
                const [int, dec] = numeric.split(this.decimalSeparator);
                return new BigNumber(int || 0).toFormat(this.format) + this.decimalSeparator + dec.slice(0, this._decimals);
            }
            else {
                return new BigNumber(numeric).toFormat(this.format);
            }
        }
        else {
            return numeric;
        }
    }
    updateAmountInput() {
        var _a;
        const amountEl = this.amountEl.nativeElement;
        const numeric = ((_a = amountEl.value) === null || _a === void 0 ? void 0 : _a.replace(this.nonNumbersAndDecimalSeparatorRegex, '').slice(0, this.maxLength)) || '';
        this.renderer.setProperty(amountEl, 'value', this.formatAmount(numeric));
    }
    setSelection(start, end) {
        const amountEl = this.amountEl.nativeElement;
        this.renderer.setProperty(amountEl, 'selectionStart', start);
        this.renderer.setProperty(amountEl, 'selectionEnd', end);
    }
    correctInputValue() {
        var _a;
        this.onBlur();
        const amountEl = (_a = this.amountEl) === null || _a === void 0 ? void 0 : _a.nativeElement;
        if (amountEl.value) {
            const numeric = amountEl.value.replace(this.endWithDecimal, '');
            this.renderer.setProperty(amountEl, 'value', numeric);
            this.updateOutputValue(numeric.replace(this.nonNumbersAndDecimalSeparatorRegex, ''));
        }
    }
    /**
     * Event handler for backspace key press, and check if correct number is deleted
     */
    onBackspace(el) {
        if (this.autoDecimal && el.selectionStart && el.value[el.selectionStart - 1] === this.groupSeparator) {
            this.setSelection(el.selectionStart - 1, el.selectionStart - 1);
        }
    }
    onPress($event) {
        const key = $event.key;
        const elm = this.amountEl.nativeElement;
        const value = elm.value;
        if (value) {
            const isDotExist = value.includes(this.decimalSeparator) && key === this.decimalSeparator;
            const regexString = `^[\\d${this.groupSeparator}]*[${this.decimalSeparator}]?\\d{0,${this._decimals}}$`;
            const formattedCurrencyRegex = new RegExp(regexString, 'g');
            const decimalStructure = formattedCurrencyRegex.test(value);
            if (isDotExist || !decimalStructure) {
                const pos = elm.selectionStart;
                if (value.indexOf(this.decimalSeparator) === pos) {
                    this.setSelection(pos + 1, pos + 1);
                }
                $event.preventDefault();
            }
        }
    }
    onInput() {
        const elm = this.amountEl.nativeElement;
        const value = elm.value.trim();
        const cursorPos = elm.selectionStart || 0;
        const oldPos = value.length - cursorPos;
        this.updateAmountInput();
        const formatted = elm.value.replace(this.nonNumbersAndDecimalSeparatorRegex, '').replace(this.endWithDecimal, '');
        if (formatted) {
            if (value.length === 1 && value !== this.decimalSeparator) {
                const newValue = this.autoDecimal ? value + this.decimalSeparator + '0'.repeat(this._decimals) : value;
                this.renderer.setProperty(elm, 'value', newValue);
                this.setSelection(1, 1);
            }
            else {
                let newpos = elm.value.length - oldPos;
                if (value.includes(this.decimalSeparator) && cursorPos > value.indexOf(this.decimalSeparator)) {
                    newpos++;
                }
                this.setSelection(newpos, newpos);
            }
        }
        this.updateOutputValue(formatted);
    }
    updateOutputValue(value) {
        this.onValueChange(value.replace(this.decimalSeparator, '.'));
    }
}
AmountInputComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: AmountInputComponent, deps: [{ token: i0.ChangeDetectorRef }, { token: i1.DeprecationsService }, { token: LOCALE_ID }, { token: i0.Renderer2 }], target: i0.ɵɵFactoryTarget.Component });
AmountInputComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "12.0.0", version: "12.2.16", type: AmountInputComponent, selector: "bb-amount-input-ui", inputs: { placeholder: "placeholder", maxLength: "maxLength", wrapperClasses: "wrapperClasses", mapCurrency: "mapCurrency", currency: "currency", autoDecimal: "autoDecimal" }, host: { properties: { "class": "this.inputClass" } }, providers: [
        {
            provide: NG_VALUE_ACCESSOR,
            useExisting: forwardRef(() => AmountInputComponent),
            multi: true,
        },
    ], viewQueries: [{ propertyName: "amountEl", first: true, predicate: ["amountInput"], descendants: true, static: true }], usesInheritance: true, ngImport: i0, template: "<label *ngIf=\"label\" for=\"{{ id }}\"> {{ label }} </label>\n<div class=\"bb-amount-input__field\" [ngClass]=\"wrapperClasses\">\n  <input\n    id=\"{{ id }}\"\n    type=\"text\"\n    class=\"form-control bb-text-align-right\"\n    autocomplete=\"off\"\n    autocorrect=\"off\"\n    autocapitalize=\"off\"\n    spellcheck=\"false\"\n    data-role=\"bb-amount-input-ui\"\n    #amountInput\n    [attr.maxlength]=\"maxLength\"\n    [readOnly]=\"readonly\"\n    [disabled]=\"disabled\"\n    [required]=\"required\"\n    [placeholder]=\"placeholder\"\n    [attr.aria-describedby]=\"idListAttr(ariaDescribedby, componentUniqueId)\"\n    [attr.aria-invalid]=\"ariaInvalid\"\n    [attr.aria-labelledby]=\"ariaLabelledby\"\n    (keydown)=\"onPress($event)\"\n    (keydown.backspace)=\"onBackspace(amountInput)\"\n    (blur)=\"correctInputValue()\"\n    (input)=\"onInput()\"\n  />\n  <span *ngIf=\"currency\" data-role=\"bb-amount-input-currency\" class=\"bb-amount-input__symbol\" [id]=\"componentUniqueId\">\n    <span\n      class=\"sr-only\"\n      i18n=\"\n        Currency|Text to explain that currency will be read by screen reader@@bb-amount-input-ui.currency-description\"\n      >Currency</span\n    >\n    {{ currency }}\n  </span>\n</div>\n", directives: [{ type: i2.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { type: i2.NgClass, selector: "[ngClass]", inputs: ["class", "ngClass"] }], changeDetection: i0.ChangeDetectionStrategy.OnPush });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: AmountInputComponent, decorators: [{
            type: Component,
            args: [{
                    selector: 'bb-amount-input-ui',
                    templateUrl: './amount-input.component.html',
                    changeDetection: ChangeDetectionStrategy.OnPush,
                    providers: [
                        {
                            provide: NG_VALUE_ACCESSOR,
                            useExisting: forwardRef(() => AmountInputComponent),
                            multi: true,
                        },
                    ],
                }]
        }], ctorParameters: function () { return [{ type: i0.ChangeDetectorRef }, { type: i1.DeprecationsService }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [LOCALE_ID]
                }] }, { type: i0.Renderer2 }]; }, propDecorators: { inputClass: [{
                type: HostBinding,
                args: ['class']
            }], placeholder: [{
                type: Input
            }], maxLength: [{
                type: Input
            }], wrapperClasses: [{
                type: Input
            }], mapCurrency: [{
                type: Input
            }], currency: [{
                type: Input
            }], autoDecimal: [{
                type: Input
            }], amountEl: [{
                type: ViewChild,
                args: ['amountInput', { static: true }]
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYW1vdW50LWlucHV0LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL2xpYnMvdWktYW5nL2Ftb3VudC1pbnB1dC9hbW91bnQtaW5wdXQuY29tcG9uZW50LnRzIiwiLi4vLi4vLi4vLi4vLi4vbGlicy91aS1hbmcvYW1vdW50LWlucHV0L2Ftb3VudC1pbnB1dC5jb21wb25lbnQuaHRtbCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0wsdUJBQXVCLEVBRXZCLFNBQVMsRUFFVCxVQUFVLEVBQ1YsV0FBVyxFQUNYLE1BQU0sRUFDTixLQUFLLEVBQ0wsU0FBUyxFQUVULFNBQVMsR0FDVixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUNuRSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUVuRCxPQUFPLFNBQVMsTUFBTSxjQUFjLENBQUM7QUFDckMsT0FBTyxFQUFFLGlCQUFpQixFQUFFLHFCQUFxQixFQUFFLHlCQUF5QixFQUFFLFlBQVksRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3BILE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQzs7OztBQUVuRDs7Ozs7Ozs7Ozs7O0dBWUc7QUFhSCxNQUFNLE9BQU8sb0JBQXFCLFNBQVEsa0JBQWtCO0lBa0UxRCxZQUNFLEVBQXFCLEVBQ3JCLG1CQUF3QyxFQUNKLE1BQWMsRUFDakMsUUFBbUI7UUFFcEMsS0FBSyxDQUFDLEVBQUUsRUFBRSxtQkFBbUIsQ0FBQyxDQUFDO1FBSEssV0FBTSxHQUFOLE1BQU0sQ0FBUTtRQUNqQyxhQUFRLEdBQVIsUUFBUSxDQUFXO1FBckVoQixlQUFVLEdBQUcsaUJBQWlCLENBQUM7UUFFckQ7Ozs7V0FJRztRQUNNLHNCQUFpQixHQUFHLEdBQUcsSUFBSSxDQUFDLEVBQUUsV0FBVyxDQUFDO1FBQ25EOztXQUVHO1FBQ0ksZUFBVSxHQUFHLFVBQVUsQ0FBQztRQVkvQjs7V0FFRztRQUNNLGdCQUFXLEdBQUcsRUFBRSxDQUFDO1FBSzFCOztXQUVHO1FBQ00sbUJBQWMsR0FBRyxFQUFFLENBQUM7UUFDN0I7OztXQUdHO1FBQ00sZ0JBQVcsR0FBRyxJQUFJLENBQUM7UUFDNUI7OztXQUdHO1FBQ0ssY0FBUyxHQUFHLEVBQUUsQ0FBQztRQUNmLGNBQVMsR0FBRyxDQUFDLENBQUM7UUFVdEI7O1dBRUc7UUFDTSxnQkFBVyxHQUFHLEtBQUssQ0FBQztRQWMzQixJQUFJLENBQUMsY0FBYyxHQUFHLHFCQUFxQixDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsWUFBWSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ3JGLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxxQkFBcUIsQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLFlBQVksQ0FBQyxlQUFlLENBQUMsQ0FBQztRQUN6RixJQUFJLENBQUMsa0NBQWtDLEdBQUcsSUFBSSxNQUFNLENBQUMsS0FBSyxJQUFJLENBQUMsZ0JBQWdCLE1BQU0sRUFBRSxHQUFHLENBQUMsQ0FBQztRQUM1RixJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksTUFBTSxDQUFDLElBQUksSUFBSSxDQUFDLGdCQUFnQixJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDckUsSUFBSSxDQUFDLE1BQU0sR0FBRztZQUNaLGNBQWMsRUFBRSxJQUFJLENBQUMsY0FBYztZQUNuQyxnQkFBZ0IsRUFBRSxJQUFJLENBQUMsZ0JBQWdCO1lBQ3ZDLFNBQVMsRUFBRSxDQUFDO1NBQ2IsQ0FBQztJQUNKLENBQUM7SUFuQ0QsSUFBYSxRQUFRLENBQUMsS0FBeUI7UUFDN0MsSUFBSSxLQUFLLEVBQUU7WUFDVCxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLGlCQUFpQixDQUFDLEtBQUssRUFBRSxNQUFNLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUM7WUFDMUYsSUFBSSxDQUFDLFNBQVMsR0FBRyx5QkFBeUIsQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUNuRDtJQUNILENBQUM7SUFDRCxJQUFJLFFBQVE7UUFDVixPQUFPLElBQUksQ0FBQyxTQUFTLENBQUM7SUFDeEIsQ0FBQztJQTZCRCxVQUFVLENBQUMsS0FBVTtRQUNuQixNQUFNLGNBQWMsR0FBRyxLQUFLLGFBQUwsS0FBSyxjQUFMLEtBQUssR0FBSSxFQUFFLENBQUM7UUFDbkMsSUFBSSxPQUFPLGNBQWMsS0FBSyxRQUFRLEVBQUU7WUFDdEMsTUFBTSxPQUFPLEdBQ1gsY0FBYyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsa0NBQWtDLEVBQUUsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxDQUFDO1lBQ3JHLElBQUksQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsYUFBYSxFQUFFLE9BQU8sRUFBRSxJQUFJLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7U0FDN0Y7SUFDSCxDQUFDO0lBRU8sWUFBWSxDQUFDLE9BQWU7UUFDbEMsSUFBSSxPQUFPLEVBQUU7WUFDWCxJQUFJLE9BQU8sQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEVBQUU7Z0JBQzNDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztnQkFFeEQsT0FBTyxJQUFJLFNBQVMsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO2FBQzdHO2lCQUFNO2dCQUNMLE9BQU8sSUFBSSxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQzthQUNyRDtTQUNGO2FBQU07WUFDTCxPQUFPLE9BQU8sQ0FBQztTQUNoQjtJQUNILENBQUM7SUFFTyxpQkFBaUI7O1FBQ3ZCLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsYUFBYSxDQUFDO1FBQzdDLE1BQU0sT0FBTyxHQUFHLENBQUEsTUFBQSxRQUFRLENBQUMsS0FBSywwQ0FBRSxPQUFPLENBQUMsSUFBSSxDQUFDLGtDQUFrQyxFQUFFLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSSxFQUFFLENBQUM7UUFFcEgsSUFBSSxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUMsUUFBUSxFQUFFLE9BQU8sRUFBRSxJQUFJLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7SUFDM0UsQ0FBQztJQUVPLFlBQVksQ0FBQyxLQUFhLEVBQUUsR0FBVztRQUM3QyxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLGFBQWEsQ0FBQztRQUM3QyxJQUFJLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxRQUFRLEVBQUUsZ0JBQWdCLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDN0QsSUFBSSxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUMsUUFBUSxFQUFFLGNBQWMsRUFBRSxHQUFHLENBQUMsQ0FBQztJQUMzRCxDQUFDO0lBRUQsaUJBQWlCOztRQUNmLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztRQUNkLE1BQU0sUUFBUSxHQUFHLE1BQUEsSUFBSSxDQUFDLFFBQVEsMENBQUUsYUFBYSxDQUFDO1FBQzlDLElBQUksUUFBUSxDQUFDLEtBQUssRUFBRTtZQUNsQixNQUFNLE9BQU8sR0FBRyxRQUFRLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsY0FBYyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBQ2hFLElBQUksQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLFFBQVEsRUFBRSxPQUFPLEVBQUUsT0FBTyxDQUFDLENBQUM7WUFDdEQsSUFBSSxDQUFDLGlCQUFpQixDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLGtDQUFrQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUM7U0FDdEY7SUFDSCxDQUFDO0lBQ0Q7O09BRUc7SUFDSCxXQUFXLENBQUMsRUFBb0I7UUFDOUIsSUFBSSxJQUFJLENBQUMsV0FBVyxJQUFJLEVBQUUsQ0FBQyxjQUFjLElBQUksRUFBRSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsY0FBYyxHQUFHLENBQUMsQ0FBQyxLQUFLLElBQUksQ0FBQyxjQUFjLEVBQUU7WUFDcEcsSUFBSSxDQUFDLFlBQVksQ0FBQyxFQUFFLENBQUMsY0FBYyxHQUFHLENBQUMsRUFBRSxFQUFFLENBQUMsY0FBYyxHQUFHLENBQUMsQ0FBQyxDQUFDO1NBQ2pFO0lBQ0gsQ0FBQztJQUVELE9BQU8sQ0FBQyxNQUFxQjtRQUMzQixNQUFNLEdBQUcsR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDO1FBQ3ZCLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsYUFBYSxDQUFDO1FBQ3hDLE1BQU0sS0FBSyxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUM7UUFDeEIsSUFBSSxLQUFLLEVBQUU7WUFDVCxNQUFNLFVBQVUsR0FBRyxLQUFLLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLEdBQUcsS0FBSyxJQUFJLENBQUMsZ0JBQWdCLENBQUM7WUFDMUYsTUFBTSxXQUFXLEdBQUcsUUFBUSxJQUFJLENBQUMsY0FBYyxNQUFNLElBQUksQ0FBQyxnQkFBZ0IsV0FBVyxJQUFJLENBQUMsU0FBUyxJQUFJLENBQUM7WUFDeEcsTUFBTSxzQkFBc0IsR0FBRyxJQUFJLE1BQU0sQ0FBQyxXQUFXLEVBQUUsR0FBRyxDQUFDLENBQUM7WUFDNUQsTUFBTSxnQkFBZ0IsR0FBRyxzQkFBc0IsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDNUQsSUFBSSxVQUFVLElBQUksQ0FBQyxnQkFBZ0IsRUFBRTtnQkFDbkMsTUFBTSxHQUFHLEdBQUcsR0FBRyxDQUFDLGNBQWMsQ0FBQztnQkFDL0IsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLEdBQUcsRUFBRTtvQkFDaEQsSUFBSSxDQUFDLFlBQVksQ0FBQyxHQUFHLEdBQUcsQ0FBQyxFQUFFLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQztpQkFDckM7Z0JBQ0QsTUFBTSxDQUFDLGNBQWMsRUFBRSxDQUFDO2FBQ3pCO1NBQ0Y7SUFDSCxDQUFDO0lBRUQsT0FBTztRQUNMLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsYUFBYSxDQUFDO1FBQ3hDLE1BQU0sS0FBSyxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDL0IsTUFBTSxTQUFTLEdBQUcsR0FBRyxDQUFDLGNBQWMsSUFBSSxDQUFDLENBQUM7UUFDMUMsTUFBTSxNQUFNLEdBQUcsS0FBSyxDQUFDLE1BQU0sR0FBRyxTQUFTLENBQUM7UUFDeEMsSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUM7UUFDekIsTUFBTSxTQUFTLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLGtDQUFrQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsY0FBYyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQ2xILElBQUksU0FBUyxFQUFFO1lBQ2IsSUFBSSxLQUFLLENBQUMsTUFBTSxLQUFLLENBQUMsSUFBSSxLQUFLLEtBQUssSUFBSSxDQUFDLGdCQUFnQixFQUFFO2dCQUN6RCxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixHQUFHLEdBQUcsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUM7Z0JBQ3ZHLElBQUksQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLEdBQUcsRUFBRSxPQUFPLEVBQUUsUUFBUSxDQUFDLENBQUM7Z0JBQ2xELElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO2FBQ3pCO2lCQUFNO2dCQUNMLElBQUksTUFBTSxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztnQkFDdkMsSUFBSSxLQUFLLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLFNBQVMsR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxFQUFFO29CQUM3RixNQUFNLEVBQUUsQ0FBQztpQkFDVjtnQkFDRCxJQUFJLENBQUMsWUFBWSxDQUFDLE1BQU0sRUFBRSxNQUFNLENBQUMsQ0FBQzthQUNuQztTQUNGO1FBQ0QsSUFBSSxDQUFDLGlCQUFpQixDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQ3BDLENBQUM7SUFDTyxpQkFBaUIsQ0FBQyxLQUFhO1FBQ3JDLElBQUksQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQztJQUNoRSxDQUFDOztrSEFyTFUsb0JBQW9CLHNGQXFFckIsU0FBUztzR0FyRVIsb0JBQW9CLG1SQVJwQjtRQUNUO1lBQ0UsT0FBTyxFQUFFLGlCQUFpQjtZQUMxQixXQUFXLEVBQUUsVUFBVSxDQUFDLEdBQUcsRUFBRSxDQUFDLG9CQUFvQixDQUFDO1lBQ25ELEtBQUssRUFBRSxJQUFJO1NBQ1o7S0FDRix3S0MzQ0gsK3RDQW1DQTs0RkRVYSxvQkFBb0I7a0JBWmhDLFNBQVM7bUJBQUM7b0JBQ1QsUUFBUSxFQUFFLG9CQUFvQjtvQkFDOUIsV0FBVyxFQUFFLCtCQUErQjtvQkFDNUMsZUFBZSxFQUFFLHVCQUF1QixDQUFDLE1BQU07b0JBQy9DLFNBQVMsRUFBRTt3QkFDVDs0QkFDRSxPQUFPLEVBQUUsaUJBQWlCOzRCQUMxQixXQUFXLEVBQUUsVUFBVSxDQUFDLEdBQUcsRUFBRSxxQkFBcUIsQ0FBQzs0QkFDbkQsS0FBSyxFQUFFLElBQUk7eUJBQ1o7cUJBQ0Y7aUJBQ0Y7OzBCQXNFSSxNQUFNOzJCQUFDLFNBQVM7b0VBcEVHLFVBQVU7c0JBQS9CLFdBQVc7dUJBQUMsT0FBTztnQkEwQlgsV0FBVztzQkFBbkIsS0FBSztnQkFJRyxTQUFTO3NCQUFqQixLQUFLO2dCQUlHLGNBQWM7c0JBQXRCLEtBQUs7Z0JBS0csV0FBVztzQkFBbkIsS0FBSztnQkFPTyxRQUFRO3NCQUFwQixLQUFLO2dCQVlHLFdBQVc7c0JBQW5CLEtBQUs7Z0JBSzhDLFFBQVE7c0JBQTNELFNBQVM7dUJBQUMsYUFBYSxFQUFFLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENoYW5nZURldGVjdGlvblN0cmF0ZWd5LFxuICBDaGFuZ2VEZXRlY3RvclJlZixcbiAgQ29tcG9uZW50LFxuICBFbGVtZW50UmVmLFxuICBmb3J3YXJkUmVmLFxuICBIb3N0QmluZGluZyxcbiAgSW5qZWN0LFxuICBJbnB1dCxcbiAgTE9DQUxFX0lELFxuICBSZW5kZXJlcjIsXG4gIFZpZXdDaGlsZCxcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBJbnB1dEJhc2VDb21wb25lbnQgfSBmcm9tICdAYmFja2Jhc2UvdWktYW5nL2Jhc2UtY2xhc3Nlcyc7XG5pbXBvcnQgeyBOR19WQUxVRV9BQ0NFU1NPUiB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7IERlcHJlY2F0aW9uc1NlcnZpY2UgfSBmcm9tICdAYmFja2Jhc2UvZm91bmRhdGlvbi1hbmcvZnV0dXJlJztcbmltcG9ydCBCaWdOdW1iZXIgZnJvbSAnYmlnbnVtYmVyLmpzJztcbmltcG9ydCB7IGdldEN1cnJlbmN5U3ltYm9sLCBnZXRMb2NhbGVOdW1iZXJTeW1ib2wsIGdldE51bWJlck9mQ3VycmVuY3lEaWdpdHMsIE51bWJlclN5bWJvbCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5pbXBvcnQgeyBpZExpc3RBdHRyIH0gZnJvbSAnQGJhY2tiYXNlL3VpLWFuZy91dGlsJztcblxuLyoqXG4gKiBAbmFtZSBBbW91bnRJbnB1dENvbXBvbmVudFxuICpcbiAqIEBhMTF5IEN1cnJlbnQgY29tcG9uZW50IHByb3ZpZGUgb3B0aW9uIHRvIHBhc3MgbmVlZGVkIGFjY2Vzc2liaWxpdHlcbiAqIGF0dHJpYnV0ZXMuIFlvdSBuZWVkIHRvIHRha2UgY2FyZSBvZiBwcm9wZXJ0aWVzIHRoYXQgYXJlIHJlcXVpcmVkIGluIHlvdXIgY2FzZSA6XG4gKiAgLSBzZXQgYXJpYS1kZXNjcmliZWRieSB3aXRoIElEIG9mIGFub3RoZXIgZWxlbWVudCBpbiB0aGUgRE9NIHdpdGggZGVzY3JpcHRpdmUgdGV4dCBhYm91dCB0aGUgYW1vdW50IGlucHV0LFxuICogICAgYnkgZGVmYXVsdCBpdCBpcyBzZXQgdG8gZGl2IGRlZmluaW5nIHRoZSB0eXBlIG9mIGN1cnJlbmN5XG4gKiAgLSBzZXQgYXJpYS1pbnZhbGlkIHdpdGggYm9vbGVhbiB2YWx1ZSB3aGVuIHRoZSBlbnRlcmVkIGlucHV0IHZhbHVlIGlzIG5vdCB2YWxpZFxuICogIC0gc2V0IGFyaWEtbGFiZWxsZWRieSB3aXRoIElEIG9mIGFub3RoZXIgZWxlbWVudCBpbiB0aGUgRE9NIGFzIGlucHV0J3MgbGFiZWxcbiAqXG4gKiBAZGVzY3JpcHRpb25cbiAqIENvbXBvbmVudCB0aGF0IGRpc3BsYXlzIGEgdGV4dCBpbnB1dC5cbiAqL1xuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYmItYW1vdW50LWlucHV0LXVpJyxcbiAgdGVtcGxhdGVVcmw6ICcuL2Ftb3VudC1pbnB1dC5jb21wb25lbnQuaHRtbCcsXG4gIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoLFxuICBwcm92aWRlcnM6IFtcbiAgICB7XG4gICAgICBwcm92aWRlOiBOR19WQUxVRV9BQ0NFU1NPUixcbiAgICAgIHVzZUV4aXN0aW5nOiBmb3J3YXJkUmVmKCgpID0+IEFtb3VudElucHV0Q29tcG9uZW50KSxcbiAgICAgIG11bHRpOiB0cnVlLFxuICAgIH0sXG4gIF0sXG59KVxuZXhwb3J0IGNsYXNzIEFtb3VudElucHV0Q29tcG9uZW50IGV4dGVuZHMgSW5wdXRCYXNlQ29tcG9uZW50IHtcbiAgQEhvc3RCaW5kaW5nKCdjbGFzcycpIGlucHV0Q2xhc3MgPSAnYmItYW1vdW50LWlucHV0JztcblxuICAvKipcbiAgICogVW5pcXVlIElEIHVzZWQgZm9yIHRoZSBhY2Nlc3NpYmlsaXR5IHByb3BlcnR5LiBOZXcgdmFsdWUgaXMgY3JlYXRlZCB3aGVuIGNvbXBvbmVudCBpcyBpbml0aWFsaXplZC5cbiAgICpcbiAgICogQGludGVybmFsXG4gICAqL1xuICByZWFkb25seSBjb21wb25lbnRVbmlxdWVJZCA9IGAke3RoaXMuaWR9LWN1cnJlbmN5YDtcbiAgLyoqXG4gICAqIFV0aWxpdHkgZnVuY3Rpb24gZm9yIHVzZSBpbiB0ZW1wbGF0ZVxuICAgKi9cbiAgcHVibGljIGlkTGlzdEF0dHIgPSBpZExpc3RBdHRyO1xuXG4gIHByaXZhdGUgcmVhZG9ubHkgZ3JvdXBTZXBhcmF0b3I6IHN0cmluZztcbiAgcHJpdmF0ZSByZWFkb25seSBkZWNpbWFsU2VwYXJhdG9yOiBzdHJpbmc7XG4gIHByaXZhdGUgcmVhZG9ubHkgbm9uTnVtYmVyc0FuZERlY2ltYWxTZXBhcmF0b3JSZWdleDogUmVnRXhwO1xuICBwcml2YXRlIHJlYWRvbmx5IGVuZFdpdGhEZWNpbWFsOiBSZWdFeHA7XG5cbiAgLyoqXG4gICAqIFRoZSBmb3JtYXQgdXNlZCBmb3IgYmlnbnVtYmVyO1xuICAgKi9cbiAgcHJpdmF0ZSByZWFkb25seSBmb3JtYXQ6IEJpZ051bWJlci5Gb3JtYXQ7XG5cbiAgLyoqXG4gICAqIFRoZSBwbGFjZWhvbGRlciBmb3IgdGhlIHRleHQgaW5wdXQuIERlZmF1bHRzIHRvIGFuIGVtcHR5IHN0cmluZztcbiAgICovXG4gIEBJbnB1dCgpIHBsYWNlaG9sZGVyID0gJyc7XG4gIC8qKlxuICAgKiBUaGUgbWF4TGVuZ3RoIGZvciB0aGUgdGV4dCBpbnB1dC5cbiAgICovXG4gIEBJbnB1dCgpIG1heExlbmd0aDogbnVtYmVyIHwgdW5kZWZpbmVkO1xuICAvKipcbiAgICogY2xhc3NuYW1lcyBmb3IgdGhlIHdyYXBwZXIgZGl2XG4gICAqL1xuICBASW5wdXQoKSB3cmFwcGVyQ2xhc3NlcyA9ICcnO1xuICAvKipcbiAgICogV2hldGhlciBjdXJyZW5jeSBsb2NhbCBzaG91bGQgYmUgdHJhbnNmb3JtZWQgdG8gc3ltYm9sLlxuICAgKiBEZWZhdWx0IHZhbHVlIHRydWUuXG4gICAqL1xuICBASW5wdXQoKSBtYXBDdXJyZW5jeSA9IHRydWU7XG4gIC8qKlxuICAgKiBEZXRlcm1pbmVzIGN1cnJlbmN5IHR5cGUuXG4gICAqIElmIG5vdGhpbmcgcHJvdmlkZWQsIHdvdWxkbid0IGJlIGRpc3BsYXllZC5cbiAgICovXG4gIHByaXZhdGUgX2N1cnJlbmN5ID0gJyc7XG4gIHByaXZhdGUgX2RlY2ltYWxzID0gMjtcbiAgQElucHV0KCkgc2V0IGN1cnJlbmN5KHZhbHVlOiBzdHJpbmcgfCB1bmRlZmluZWQpIHtcbiAgICBpZiAodmFsdWUpIHtcbiAgICAgIHRoaXMuX2N1cnJlbmN5ID0gdGhpcy5tYXBDdXJyZW5jeSA/IGdldEN1cnJlbmN5U3ltYm9sKHZhbHVlLCAnd2lkZScsIHRoaXMubG9jYWxlKSA6IHZhbHVlO1xuICAgICAgdGhpcy5fZGVjaW1hbHMgPSBnZXROdW1iZXJPZkN1cnJlbmN5RGlnaXRzKHZhbHVlKTtcbiAgICB9XG4gIH1cbiAgZ2V0IGN1cnJlbmN5KCk6IHN0cmluZyB8IHVuZGVmaW5lZCB7XG4gICAgcmV0dXJuIHRoaXMuX2N1cnJlbmN5O1xuICB9XG4gIC8qKlxuICAgKiBUaGUgZmxhZyB0byB3ZXRoZXIgYXV0byBhZGQgZGVjaW1hbCBwYXJ0IG9yIG5vdCBkZWZhdWx0cyB0byBmYWxzZVxuICAgKi9cbiAgQElucHV0KCkgYXV0b0RlY2ltYWwgPSBmYWxzZTtcblxuICAvKipcbiAgICogRWxlbWVudFJlZiBmb3IgYW1vdW50IGlucHV0XG4gICAqL1xuICBAVmlld0NoaWxkKCdhbW91bnRJbnB1dCcsIHsgc3RhdGljOiB0cnVlIH0pIHByaXZhdGUgYW1vdW50RWwhOiBFbGVtZW50UmVmPEhUTUxJbnB1dEVsZW1lbnQ+O1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIGNkOiBDaGFuZ2VEZXRlY3RvclJlZixcbiAgICBkZXByZWNhdGlvbnNTZXJ2aWNlOiBEZXByZWNhdGlvbnNTZXJ2aWNlLFxuICAgIEBJbmplY3QoTE9DQUxFX0lEKSBwcml2YXRlIHJlYWRvbmx5IGxvY2FsZTogc3RyaW5nLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgcmVuZGVyZXI6IFJlbmRlcmVyMixcbiAgKSB7XG4gICAgc3VwZXIoY2QsIGRlcHJlY2F0aW9uc1NlcnZpY2UpO1xuICAgIHRoaXMuZ3JvdXBTZXBhcmF0b3IgPSBnZXRMb2NhbGVOdW1iZXJTeW1ib2wodGhpcy5sb2NhbGUsIE51bWJlclN5bWJvbC5DdXJyZW5jeUdyb3VwKTtcbiAgICB0aGlzLmRlY2ltYWxTZXBhcmF0b3IgPSBnZXRMb2NhbGVOdW1iZXJTeW1ib2wodGhpcy5sb2NhbGUsIE51bWJlclN5bWJvbC5DdXJyZW5jeURlY2ltYWwpO1xuICAgIHRoaXMubm9uTnVtYmVyc0FuZERlY2ltYWxTZXBhcmF0b3JSZWdleCA9IG5ldyBSZWdFeHAoYFteJHt0aGlzLmRlY2ltYWxTZXBhcmF0b3J9XFxcXGRdYCwgJ2cnKTtcbiAgICB0aGlzLmVuZFdpdGhEZWNpbWFsID0gbmV3IFJlZ0V4cChgWyR7dGhpcy5kZWNpbWFsU2VwYXJhdG9yfV0kYCwgJ2cnKTtcbiAgICB0aGlzLmZvcm1hdCA9IHtcbiAgICAgIGdyb3VwU2VwYXJhdG9yOiB0aGlzLmdyb3VwU2VwYXJhdG9yLFxuICAgICAgZGVjaW1hbFNlcGFyYXRvcjogdGhpcy5kZWNpbWFsU2VwYXJhdG9yLFxuICAgICAgZ3JvdXBTaXplOiAzLFxuICAgIH07XG4gIH1cblxuICB3cml0ZVZhbHVlKG1vZGVsOiBhbnkpOiB2b2lkIHtcbiAgICBjb25zdCBzYW5pdGl6ZWRJbnB1dCA9IG1vZGVsID8/ICcnO1xuICAgIGlmICh0eXBlb2Ygc2FuaXRpemVkSW5wdXQgPT09ICdzdHJpbmcnKSB7XG4gICAgICBjb25zdCBudW1lcmljID1cbiAgICAgICAgc2FuaXRpemVkSW5wdXQucmVwbGFjZSh0aGlzLm5vbk51bWJlcnNBbmREZWNpbWFsU2VwYXJhdG9yUmVnZXgsICcnKS5zbGljZSgwLCB0aGlzLm1heExlbmd0aCkgfHwgJyc7XG4gICAgICB0aGlzLnJlbmRlcmVyLnNldFByb3BlcnR5KHRoaXMuYW1vdW50RWwubmF0aXZlRWxlbWVudCwgJ3ZhbHVlJywgdGhpcy5mb3JtYXRBbW91bnQobnVtZXJpYykpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZm9ybWF0QW1vdW50KG51bWVyaWM6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgaWYgKG51bWVyaWMpIHtcbiAgICAgIGlmIChudW1lcmljLmluY2x1ZGVzKHRoaXMuZGVjaW1hbFNlcGFyYXRvcikpIHtcbiAgICAgICAgY29uc3QgW2ludCwgZGVjXSA9IG51bWVyaWMuc3BsaXQodGhpcy5kZWNpbWFsU2VwYXJhdG9yKTtcblxuICAgICAgICByZXR1cm4gbmV3IEJpZ051bWJlcihpbnQgfHwgMCkudG9Gb3JtYXQodGhpcy5mb3JtYXQpICsgdGhpcy5kZWNpbWFsU2VwYXJhdG9yICsgZGVjLnNsaWNlKDAsIHRoaXMuX2RlY2ltYWxzKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBuZXcgQmlnTnVtYmVyKG51bWVyaWMpLnRvRm9ybWF0KHRoaXMuZm9ybWF0KTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIG51bWVyaWM7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVBbW91bnRJbnB1dCgpIHtcbiAgICBjb25zdCBhbW91bnRFbCA9IHRoaXMuYW1vdW50RWwubmF0aXZlRWxlbWVudDtcbiAgICBjb25zdCBudW1lcmljID0gYW1vdW50RWwudmFsdWU/LnJlcGxhY2UodGhpcy5ub25OdW1iZXJzQW5kRGVjaW1hbFNlcGFyYXRvclJlZ2V4LCAnJykuc2xpY2UoMCwgdGhpcy5tYXhMZW5ndGgpIHx8ICcnO1xuXG4gICAgdGhpcy5yZW5kZXJlci5zZXRQcm9wZXJ0eShhbW91bnRFbCwgJ3ZhbHVlJywgdGhpcy5mb3JtYXRBbW91bnQobnVtZXJpYykpO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXRTZWxlY3Rpb24oc3RhcnQ6IG51bWJlciwgZW5kOiBudW1iZXIpOiB2b2lkIHtcbiAgICBjb25zdCBhbW91bnRFbCA9IHRoaXMuYW1vdW50RWwubmF0aXZlRWxlbWVudDtcbiAgICB0aGlzLnJlbmRlcmVyLnNldFByb3BlcnR5KGFtb3VudEVsLCAnc2VsZWN0aW9uU3RhcnQnLCBzdGFydCk7XG4gICAgdGhpcy5yZW5kZXJlci5zZXRQcm9wZXJ0eShhbW91bnRFbCwgJ3NlbGVjdGlvbkVuZCcsIGVuZCk7XG4gIH1cblxuICBjb3JyZWN0SW5wdXRWYWx1ZSgpIHtcbiAgICB0aGlzLm9uQmx1cigpO1xuICAgIGNvbnN0IGFtb3VudEVsID0gdGhpcy5hbW91bnRFbD8ubmF0aXZlRWxlbWVudDtcbiAgICBpZiAoYW1vdW50RWwudmFsdWUpIHtcbiAgICAgIGNvbnN0IG51bWVyaWMgPSBhbW91bnRFbC52YWx1ZS5yZXBsYWNlKHRoaXMuZW5kV2l0aERlY2ltYWwsICcnKTtcbiAgICAgIHRoaXMucmVuZGVyZXIuc2V0UHJvcGVydHkoYW1vdW50RWwsICd2YWx1ZScsIG51bWVyaWMpO1xuICAgICAgdGhpcy51cGRhdGVPdXRwdXRWYWx1ZShudW1lcmljLnJlcGxhY2UodGhpcy5ub25OdW1iZXJzQW5kRGVjaW1hbFNlcGFyYXRvclJlZ2V4LCAnJykpO1xuICAgIH1cbiAgfVxuICAvKipcbiAgICogRXZlbnQgaGFuZGxlciBmb3IgYmFja3NwYWNlIGtleSBwcmVzcywgYW5kIGNoZWNrIGlmIGNvcnJlY3QgbnVtYmVyIGlzIGRlbGV0ZWRcbiAgICovXG4gIG9uQmFja3NwYWNlKGVsOiBIVE1MSW5wdXRFbGVtZW50KSB7XG4gICAgaWYgKHRoaXMuYXV0b0RlY2ltYWwgJiYgZWwuc2VsZWN0aW9uU3RhcnQgJiYgZWwudmFsdWVbZWwuc2VsZWN0aW9uU3RhcnQgLSAxXSA9PT0gdGhpcy5ncm91cFNlcGFyYXRvcikge1xuICAgICAgdGhpcy5zZXRTZWxlY3Rpb24oZWwuc2VsZWN0aW9uU3RhcnQgLSAxLCBlbC5zZWxlY3Rpb25TdGFydCAtIDEpO1xuICAgIH1cbiAgfVxuXG4gIG9uUHJlc3MoJGV2ZW50OiBLZXlib2FyZEV2ZW50KSB7XG4gICAgY29uc3Qga2V5ID0gJGV2ZW50LmtleTtcbiAgICBjb25zdCBlbG0gPSB0aGlzLmFtb3VudEVsLm5hdGl2ZUVsZW1lbnQ7XG4gICAgY29uc3QgdmFsdWUgPSBlbG0udmFsdWU7XG4gICAgaWYgKHZhbHVlKSB7XG4gICAgICBjb25zdCBpc0RvdEV4aXN0ID0gdmFsdWUuaW5jbHVkZXModGhpcy5kZWNpbWFsU2VwYXJhdG9yKSAmJiBrZXkgPT09IHRoaXMuZGVjaW1hbFNlcGFyYXRvcjtcbiAgICAgIGNvbnN0IHJlZ2V4U3RyaW5nID0gYF5bXFxcXGQke3RoaXMuZ3JvdXBTZXBhcmF0b3J9XSpbJHt0aGlzLmRlY2ltYWxTZXBhcmF0b3J9XT9cXFxcZHswLCR7dGhpcy5fZGVjaW1hbHN9fSRgO1xuICAgICAgY29uc3QgZm9ybWF0dGVkQ3VycmVuY3lSZWdleCA9IG5ldyBSZWdFeHAocmVnZXhTdHJpbmcsICdnJyk7XG4gICAgICBjb25zdCBkZWNpbWFsU3RydWN0dXJlID0gZm9ybWF0dGVkQ3VycmVuY3lSZWdleC50ZXN0KHZhbHVlKTtcbiAgICAgIGlmIChpc0RvdEV4aXN0IHx8ICFkZWNpbWFsU3RydWN0dXJlKSB7XG4gICAgICAgIGNvbnN0IHBvcyA9IGVsbS5zZWxlY3Rpb25TdGFydDtcbiAgICAgICAgaWYgKHZhbHVlLmluZGV4T2YodGhpcy5kZWNpbWFsU2VwYXJhdG9yKSA9PT0gcG9zKSB7XG4gICAgICAgICAgdGhpcy5zZXRTZWxlY3Rpb24ocG9zICsgMSwgcG9zICsgMSk7XG4gICAgICAgIH1cbiAgICAgICAgJGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgb25JbnB1dCgpIHtcbiAgICBjb25zdCBlbG0gPSB0aGlzLmFtb3VudEVsLm5hdGl2ZUVsZW1lbnQ7XG4gICAgY29uc3QgdmFsdWUgPSBlbG0udmFsdWUudHJpbSgpO1xuICAgIGNvbnN0IGN1cnNvclBvcyA9IGVsbS5zZWxlY3Rpb25TdGFydCB8fCAwO1xuICAgIGNvbnN0IG9sZFBvcyA9IHZhbHVlLmxlbmd0aCAtIGN1cnNvclBvcztcbiAgICB0aGlzLnVwZGF0ZUFtb3VudElucHV0KCk7XG4gICAgY29uc3QgZm9ybWF0dGVkID0gZWxtLnZhbHVlLnJlcGxhY2UodGhpcy5ub25OdW1iZXJzQW5kRGVjaW1hbFNlcGFyYXRvclJlZ2V4LCAnJykucmVwbGFjZSh0aGlzLmVuZFdpdGhEZWNpbWFsLCAnJyk7XG4gICAgaWYgKGZvcm1hdHRlZCkge1xuICAgICAgaWYgKHZhbHVlLmxlbmd0aCA9PT0gMSAmJiB2YWx1ZSAhPT0gdGhpcy5kZWNpbWFsU2VwYXJhdG9yKSB7XG4gICAgICAgIGNvbnN0IG5ld1ZhbHVlID0gdGhpcy5hdXRvRGVjaW1hbCA/IHZhbHVlICsgdGhpcy5kZWNpbWFsU2VwYXJhdG9yICsgJzAnLnJlcGVhdCh0aGlzLl9kZWNpbWFscykgOiB2YWx1ZTtcbiAgICAgICAgdGhpcy5yZW5kZXJlci5zZXRQcm9wZXJ0eShlbG0sICd2YWx1ZScsIG5ld1ZhbHVlKTtcbiAgICAgICAgdGhpcy5zZXRTZWxlY3Rpb24oMSwgMSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsZXQgbmV3cG9zID0gZWxtLnZhbHVlLmxlbmd0aCAtIG9sZFBvcztcbiAgICAgICAgaWYgKHZhbHVlLmluY2x1ZGVzKHRoaXMuZGVjaW1hbFNlcGFyYXRvcikgJiYgY3Vyc29yUG9zID4gdmFsdWUuaW5kZXhPZih0aGlzLmRlY2ltYWxTZXBhcmF0b3IpKSB7XG4gICAgICAgICAgbmV3cG9zKys7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5zZXRTZWxlY3Rpb24obmV3cG9zLCBuZXdwb3MpO1xuICAgICAgfVxuICAgIH1cbiAgICB0aGlzLnVwZGF0ZU91dHB1dFZhbHVlKGZvcm1hdHRlZCk7XG4gIH1cbiAgcHJpdmF0ZSB1cGRhdGVPdXRwdXRWYWx1ZSh2YWx1ZTogc3RyaW5nKTogdm9pZCB7XG4gICAgdGhpcy5vblZhbHVlQ2hhbmdlKHZhbHVlLnJlcGxhY2UodGhpcy5kZWNpbWFsU2VwYXJhdG9yLCAnLicpKTtcbiAgfVxufVxuIiwiPGxhYmVsICpuZ0lmPVwibGFiZWxcIiBmb3I9XCJ7eyBpZCB9fVwiPiB7eyBsYWJlbCB9fSA8L2xhYmVsPlxuPGRpdiBjbGFzcz1cImJiLWFtb3VudC1pbnB1dF9fZmllbGRcIiBbbmdDbGFzc109XCJ3cmFwcGVyQ2xhc3Nlc1wiPlxuICA8aW5wdXRcbiAgICBpZD1cInt7IGlkIH19XCJcbiAgICB0eXBlPVwidGV4dFwiXG4gICAgY2xhc3M9XCJmb3JtLWNvbnRyb2wgYmItdGV4dC1hbGlnbi1yaWdodFwiXG4gICAgYXV0b2NvbXBsZXRlPVwib2ZmXCJcbiAgICBhdXRvY29ycmVjdD1cIm9mZlwiXG4gICAgYXV0b2NhcGl0YWxpemU9XCJvZmZcIlxuICAgIHNwZWxsY2hlY2s9XCJmYWxzZVwiXG4gICAgZGF0YS1yb2xlPVwiYmItYW1vdW50LWlucHV0LXVpXCJcbiAgICAjYW1vdW50SW5wdXRcbiAgICBbYXR0ci5tYXhsZW5ndGhdPVwibWF4TGVuZ3RoXCJcbiAgICBbcmVhZE9ubHldPVwicmVhZG9ubHlcIlxuICAgIFtkaXNhYmxlZF09XCJkaXNhYmxlZFwiXG4gICAgW3JlcXVpcmVkXT1cInJlcXVpcmVkXCJcbiAgICBbcGxhY2Vob2xkZXJdPVwicGxhY2Vob2xkZXJcIlxuICAgIFthdHRyLmFyaWEtZGVzY3JpYmVkYnldPVwiaWRMaXN0QXR0cihhcmlhRGVzY3JpYmVkYnksIGNvbXBvbmVudFVuaXF1ZUlkKVwiXG4gICAgW2F0dHIuYXJpYS1pbnZhbGlkXT1cImFyaWFJbnZhbGlkXCJcbiAgICBbYXR0ci5hcmlhLWxhYmVsbGVkYnldPVwiYXJpYUxhYmVsbGVkYnlcIlxuICAgIChrZXlkb3duKT1cIm9uUHJlc3MoJGV2ZW50KVwiXG4gICAgKGtleWRvd24uYmFja3NwYWNlKT1cIm9uQmFja3NwYWNlKGFtb3VudElucHV0KVwiXG4gICAgKGJsdXIpPVwiY29ycmVjdElucHV0VmFsdWUoKVwiXG4gICAgKGlucHV0KT1cIm9uSW5wdXQoKVwiXG4gIC8+XG4gIDxzcGFuICpuZ0lmPVwiY3VycmVuY3lcIiBkYXRhLXJvbGU9XCJiYi1hbW91bnQtaW5wdXQtY3VycmVuY3lcIiBjbGFzcz1cImJiLWFtb3VudC1pbnB1dF9fc3ltYm9sXCIgW2lkXT1cImNvbXBvbmVudFVuaXF1ZUlkXCI+XG4gICAgPHNwYW5cbiAgICAgIGNsYXNzPVwic3Itb25seVwiXG4gICAgICBpMThuPVwiXG4gICAgICAgIEN1cnJlbmN5fFRleHQgdG8gZXhwbGFpbiB0aGF0IGN1cnJlbmN5IHdpbGwgYmUgcmVhZCBieSBzY3JlZW4gcmVhZGVyQEBiYi1hbW91bnQtaW5wdXQtdWkuY3VycmVuY3ktZGVzY3JpcHRpb25cIlxuICAgICAgPkN1cnJlbmN5PC9zcGFuXG4gICAgPlxuICAgIHt7IGN1cnJlbmN5IH19XG4gIDwvc3Bhbj5cbjwvZGl2PlxuIl19