import { Directive, Host, HostListener, Inject, Input, Optional, Self, } from '@angular/core';
import { EMPTY, merge, Subject } from 'rxjs';
import { debounceTime, first, takeUntil } from 'rxjs/operators';
import { BB_DYNAMIC_VALIDATION_ERROR_TMPL, BB_VALIDATION_ERRORS, } from '../control-error-handler.const';
import { idListAttr } from '@backbase/ui-ang/util';
import * as i0 from "@angular/core";
import * as i1 from "./form-submit.directive";
import * as i2 from "./control-error-container.directive";
import * as i3 from "@angular/forms";
export class ValidationErrorsDirective {
    constructor(form, controlErrorContainer, control, errors, errorTmpl, resolver, vcr, hostElem, renderer) {
        this.form = form;
        this.controlErrorContainer = controlErrorContainer;
        this.control = control;
        this.errors = errors;
        this.errorTmpl = errorTmpl;
        this.resolver = resolver;
        this.vcr = vcr;
        this.hostElem = hostElem;
        this.renderer = renderer;
        this.onBlur = new Subject();
        this.destroy = new Subject();
        this.ariaAttributeName = 'aria-describedby';
        /**
         * Custom error labels object.
         *
         * Use only if you need to set custom error labels for specific control.
         * To specify custom error labels for entire form use BB_VALIDATION_ERRORS InjectionToken.
         *
         * @default `BB_VALIDATION_ERRORS`.
         */
        this.errorLabels = {};
        /**
         * Custom function to specify when errors should be shown.
         * By default will be shown when control is invalid.
         */
        this.showError = this.showErrorDefault;
        /**
         * Selector to indicate the control in which `aria-describedby` should be set.
         */
        this.inputSelector = '.form-control';
        /**
         * Input label
         */
        this.label = null;
        /**
         * Custom component for error message.
         *
         * Use only if you need to set custom component for specific control.
         * To specify custom component for all form errors use BB_DYNAMIC_ERROR_TMPL InjectionToken.
         *
         * @default `BB_DYNAMIC_ERROR_TMPL`.
         */
        this.errorComponent = this.errorTmpl;
        this.submit = this.form ? this.form.submit : EMPTY;
        if (!this.control) {
            throw Error('bbFormControl must contain a NgControl.');
        }
    }
    onElBlur() {
        this.onBlur.next();
    }
    ngOnInit() {
        const controlChanges = this.control.valueChanges ? this.control.valueChanges : EMPTY;
        merge(controlChanges, this.submit, this.onBlur.pipe(first()))
            .pipe(debounceTime(100), takeUntil(this.destroy))
            .subscribe(() => this.manageErrors());
    }
    ngOnDestroy() {
        this.destroy.next();
        this.destroy.complete();
    }
    manageErrors() {
        var _a, _b, _c;
        const controlErrors = this.control.errors;
        if (controlErrors && this.showError()) {
            const errorList = Object.assign(Object.assign({}, this.errors), this.errorLabels);
            const firstKey = Object.keys(controlErrors)[0];
            const getError = errorList[firstKey] || errorList.invalid;
            const text = getError(controlErrors[firstKey]);
            // TODO: add aria-invalid?
            if (((_a = this.ref) === null || _a === void 0 ? void 0 : _a.instance.text) !== text) {
                this.setError(text);
                this.setDescribedById((_b = this.ref) === null || _b === void 0 ? void 0 : _b.instance.errorId);
            }
        }
        else if (this.ref) {
            this.setError('');
            this.removeErrorId((_c = this.ref) === null || _c === void 0 ? void 0 : _c.instance.errorId);
        }
    }
    setDescribedById(id) {
        const targetEl = this.hostElem.nativeElement.querySelector(this.inputSelector);
        if (targetEl) {
            const existingIds = targetEl.getAttribute(this.ariaAttributeName);
            const attributeVal = idListAttr(id, existingIds);
            if (attributeVal) {
                this.renderer.setAttribute(targetEl, this.ariaAttributeName, attributeVal);
            }
        }
    }
    removeErrorId(id) {
        const targetEl = this.hostElem.nativeElement.querySelector(this.inputSelector);
        if (targetEl) {
            const existingIds = targetEl.getAttribute(this.ariaAttributeName) || '';
            const cleanIds = (id ? existingIds.replace(id, '') : existingIds).trim();
            if (cleanIds) {
                this.renderer.setAttribute(targetEl, this.ariaAttributeName, cleanIds);
            }
            else {
                this.renderer.removeAttribute(targetEl, this.ariaAttributeName);
            }
        }
    }
    showErrorDefault() {
        return Boolean(this.control.invalid);
    }
    setError(text) {
        var _a;
        if (!this.ref) {
            const container = ((_a = this.controlErrorContainer) === null || _a === void 0 ? void 0 : _a.vcr) || this.vcr;
            const factory = this.resolver.resolveComponentFactory(this.errorComponent);
            this.ref = container.createComponent(factory);
        }
        this.ref.instance.text = text;
        // Setup this properties in case of custom validation error component to give possibility to customise behavior.
        this.ref.instance.control = this.control;
        this.ref.instance.errorList = Object.assign(Object.assign({}, this.errors), this.errorLabels);
        this.ref.instance.label = this.label;
        this.ref.changeDetectorRef.detectChanges();
    }
}
ValidationErrorsDirective.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: ValidationErrorsDirective, deps: [{ token: i1.FormSubmitDirective, host: true, optional: true }, { token: i2.ControlErrorContainerDirective, optional: true }, { token: i3.NgControl, self: true }, { token: BB_VALIDATION_ERRORS }, { token: BB_DYNAMIC_VALIDATION_ERROR_TMPL }, { token: i0.ComponentFactoryResolver }, { token: i0.ViewContainerRef }, { token: i0.ElementRef }, { token: i0.Renderer2 }], target: i0.ɵɵFactoryTarget.Directive });
ValidationErrorsDirective.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "12.0.0", version: "12.2.16", type: ValidationErrorsDirective, selector: "[bbFormControl]", inputs: { errorLabels: "errorLabels", showError: "showError", inputSelector: "inputSelector", label: "label", errorComponent: "errorComponent" }, host: { listeners: { "blur": "onElBlur()" } }, ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: ValidationErrorsDirective, decorators: [{
            type: Directive,
            args: [{
                    // tslint:disable-next-line:directive-selector
                    selector: '[bbFormControl]',
                }]
        }], ctorParameters: function () { return [{ type: i1.FormSubmitDirective, decorators: [{
                    type: Optional
                }, {
                    type: Host
                }] }, { type: i2.ControlErrorContainerDirective, decorators: [{
                    type: Optional
                }] }, { type: i3.NgControl, decorators: [{
                    type: Self
                }] }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [BB_VALIDATION_ERRORS]
                }] }, { type: i0.Type, decorators: [{
                    type: Inject,
                    args: [BB_DYNAMIC_VALIDATION_ERROR_TMPL]
                }] }, { type: i0.ComponentFactoryResolver }, { type: i0.ViewContainerRef }, { type: i0.ElementRef }, { type: i0.Renderer2 }]; }, propDecorators: { errorLabels: [{
                type: Input
            }], showError: [{
                type: Input
            }], inputSelector: [{
                type: Input
            }], label: [{
                type: Input
            }], errorComponent: [{
                type: Input
            }], onElBlur: [{
                type: HostListener,
                args: ['blur']
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmFsaWRhdGlvbi1lcnJvcnMuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vbGlicy91aS1hbmcvY29udHJvbC1lcnJvci1oYW5kbGVyL2RpcmVjdGl2ZXMvdmFsaWRhdGlvbi1lcnJvcnMuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFHTCxTQUFTLEVBRVQsSUFBSSxFQUNKLFlBQVksRUFDWixNQUFNLEVBQ04sS0FBSyxFQUdMLFFBQVEsRUFFUixJQUFJLEdBR0wsTUFBTSxlQUFlLENBQUM7QUFFdkIsT0FBTyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQWMsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3pELE9BQU8sRUFBRSxZQUFZLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ2hFLE9BQU8sRUFDTCxnQ0FBZ0MsRUFDaEMsb0JBQW9CLEdBR3JCLE1BQU0sZ0NBQWdDLENBQUM7QUFFeEMsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHVCQUF1QixDQUFDOzs7OztBQU9uRCxNQUFNLE9BQU8seUJBQXlCO0lBZ0RwQyxZQUN1QyxJQUF5QixFQUNqQyxxQkFBcUQsRUFDekQsT0FBa0IsRUFDSSxNQUEyQixFQUNmLFNBQThDLEVBQ3hGLFFBQWtDLEVBQ2xDLEdBQXFCLEVBQ3JCLFFBQWlDLEVBQ2pDLFFBQW1CO1FBUkMsU0FBSSxHQUFKLElBQUksQ0FBcUI7UUFDakMsMEJBQXFCLEdBQXJCLHFCQUFxQixDQUFnQztRQUN6RCxZQUFPLEdBQVAsT0FBTyxDQUFXO1FBQ0ksV0FBTSxHQUFOLE1BQU0sQ0FBcUI7UUFDZixjQUFTLEdBQVQsU0FBUyxDQUFxQztRQUN4RixhQUFRLEdBQVIsUUFBUSxDQUEwQjtRQUNsQyxRQUFHLEdBQUgsR0FBRyxDQUFrQjtRQUNyQixhQUFRLEdBQVIsUUFBUSxDQUF5QjtRQUNqQyxhQUFRLEdBQVIs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MEJBa0RJLFFBQVE7OzBCQUFJLElBQUk7OzBCQUNoQixRQUFROzswQkFDUixJQUFJOzswQkFDSixNQUFNOzJCQUFDLG9CQUFvQjs7MEJBQzNCLE1BQU07MkJBQUMsZ0NBQWdDO21LQXJDakMsV0FBVztzQkFBbkIsS0FBSztnQkFNRyxTQUFTO3NCQUFqQixLQUFLO2dCQUtHLGFBQWE7c0JBQXJCLEtBQUs7Z0JBS0csS0FBSztzQkFBYixLQUFLO2dCQVVHLGNBQWM7c0JBQXRCLEtBQUs7Z0JBRWdCLFFBQVE7c0JBQTdCLFlBQVk7dUJBQUMsTUFBTSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcixcbiAgQ29tcG9uZW50UmVmLFxuICBEaXJlY3RpdmUsXG4gIEVsZW1lbnRSZWYsXG4gIEhvc3QsXG4gIEhvc3RMaXN0ZW5lcixcbiAgSW5qZWN0LFxuICBJbnB1dCxcbiAgT25EZXN0cm95LFxuICBPbkluaXQsXG4gIE9wdGlvbmFsLFxuICBSZW5kZXJlcjIsXG4gIFNlbGYsXG4gIFR5cGUsXG4gIFZpZXdDb250YWluZXJSZWYsXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgTmdDb250cm9sIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuaW1wb3J0IHsgRU1QVFksIG1lcmdlLCBPYnNlcnZhYmxlLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBkZWJvdW5jZVRpbWUsIGZpcnN0LCB0YWtlVW50aWwgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQge1xuICBCQl9EWU5BTUlDX1ZBTElEQVRJT05fRVJST1JfVE1QTCxcbiAgQkJfVkFMSURBVElPTl9FUlJPUlMsXG4gIFZhbGlkYXRpb25FcnJvckNvbXBvbmVudE1vZGVsLFxuICBQbGFpbk9iamVjdCxcbn0gZnJvbSAnLi4vY29udHJvbC1lcnJvci1oYW5kbGVyLmNvbnN0JztcbmltcG9ydCB7IEZvcm1TdWJtaXREaXJlY3RpdmUgfSBmcm9tICcuL2Zvcm0tc3VibWl0LmRpcmVjdGl2ZSc7XG5pbXBvcnQgeyBpZExpc3RBdHRyIH0gZnJvbSAnQGJhY2tiYXNlL3VpLWFuZy91dGlsJztcbmltcG9ydCB7IENvbnRyb2xFcnJvckNvbnRhaW5lckRpcmVjdGl2ZSB9IGZyb20gJy4vY29udHJvbC1lcnJvci1jb250YWluZXIuZGlyZWN0aXZlJztcblxuQERpcmVjdGl2ZSh7XG4gIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpkaXJlY3RpdmUtc2VsZWN0b3JcbiAgc2VsZWN0b3I6ICdbYmJGb3JtQ29udHJvbF0nLFxufSlcbmV4cG9ydCBjbGFzcyBWYWxpZGF0aW9uRXJyb3JzRGlyZWN0aXZlIGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3kge1xuICBwcml2YXRlIHJlYWRvbmx5IG9uQmx1ciA9IG5ldyBTdWJqZWN0PHZvaWQ+KCk7XG4gIHByaXZhdGUgcmVhZG9ubHkgZGVzdHJveSA9IG5ldyBTdWJqZWN0PHZvaWQ+KCk7XG4gIHByaXZhdGUgcmVhZG9ubHkgc3VibWl0OiBPYnNlcnZhYmxlPEV2ZW50PjtcbiAgcHJpdmF0ZSByZWFkb25seSBhcmlhQXR0cmlidXRlTmFtZSA9ICdhcmlhLWRlc2NyaWJlZGJ5JztcblxuICBwcml2YXRlIHJlZjogQ29tcG9uZW50UmVmPGFueT4gfCB1bmRlZmluZWQ7XG5cbiAgLyoqXG4gICAqIEN1c3RvbSBlcnJvciBsYWJlbHMgb2JqZWN0LlxuICAgKlxuICAgKiBVc2Ugb25seSBpZiB5b3UgbmVlZCB0byBzZXQgY3VzdG9tIGVycm9yIGxhYmVscyBmb3Igc3BlY2lmaWMgY29udHJvbC5cbiAgICogVG8gc3BlY2lmeSBjdXN0b20gZXJyb3IgbGFiZWxzIGZvciBlbnRpcmUgZm9ybSB1c2UgQkJfVkFMSURBVElPTl9FUlJPUlMgSW5qZWN0aW9uVG9rZW4uXG4gICAqXG4gICAqIEBkZWZhdWx0IGBCQl9WQUxJREFUSU9OX0VSUk9SU2AuXG4gICAqL1xuICBASW5wdXQoKSBlcnJvckxhYmVsczogUGxhaW5PYmplY3Q8c3RyaW5nPiA9IHt9O1xuXG4gIC8qKlxuICAgKiBDdXN0b20gZnVuY3Rpb24gdG8gc3BlY2lmeSB3aGVuIGVycm9ycyBzaG91bGQgYmUgc2hvd24uXG4gICAqIEJ5IGRlZmF1bHQgd2lsbCBiZSBzaG93biB3aGVuIGNvbnRyb2wgaXMgaW52YWxpZC5cbiAgICovXG4gIEBJbnB1dCgpIHNob3dFcnJvciA9IHRoaXMuc2hvd0Vycm9yRGVmYXVsdDtcblxuICAvKipcbiAgICogU2VsZWN0b3IgdG8gaW5kaWNhdGUgdGhlIGNvbnRyb2wgaW4gd2hpY2ggYGFyaWEtZGVzY3JpYmVkYnlgIHNob3VsZCBiZSBzZXQuXG4gICAqL1xuICBASW5wdXQoKSBpbnB1dFNlbGVjdG9yID0gJy5mb3JtLWNvbnRyb2wnO1xuXG4gIC8qKlxuICAgKiBJbnB1dCBsYWJlbFxuICAgKi9cbiAgQElucHV0KCkgbGFiZWw6IHN0cmluZyB8IG51bGwgPSBudWxsO1xuXG4gIC8qKlxuICAgKiBDdXN0b20gY29tcG9uZW50IGZvciBlcnJvciBtZXNzYWdlLlxuICAgKlxuICAgKiBVc2Ugb25seSBpZiB5b3UgbmVlZCB0byBzZXQgY3VzdG9tIGNvbXBvbmVudCBmb3Igc3BlY2lmaWMgY29udHJvbC5cbiAgICogVG8gc3BlY2lmeSBjdXN0b20gY29tcG9uZW50IGZvciBhbGwgZm9ybSBlcnJvcnMgdXNlIEJCX0RZTkFNSUNfRVJST1JfVE1QTCBJbmplY3Rpb25Ub2tlbi5cbiAgICpcbiAgICogQGRlZmF1bHQgYEJCX0RZTkFNSUNfRVJST1JfVE1QTGAuXG4gICAqL1xuICBASW5wdXQoKSBlcnJvckNvbXBvbmVudCA9IHRoaXMuZXJyb3JUbXBsO1xuXG4gIEBIb3N0TGlzdGVuZXIoJ2JsdXInKSBvbkVsQmx1cigpIHtcbiAgICB0aGlzLm9uQmx1ci5uZXh0KCk7XG4gIH1cblxuICBjb25zdHJ1Y3RvcihcbiAgICBAT3B0aW9uYWwoKSBASG9zdCgpIHByaXZhdGUgcmVhZG9ubHkgZm9ybTogRm9ybVN1Ym1pdERpcmVjdGl2ZSxcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIHJlYWRvbmx5IGNvbnRyb2xFcnJvckNvbnRhaW5lcjogQ29udHJvbEVycm9yQ29udGFpbmVyRGlyZWN0aXZlLFxuICAgIEBTZWxmKCkgcHJpdmF0ZSByZWFkb25seSBjb250cm9sOiBOZ0NvbnRyb2wsXG4gICAgQEluamVjdChCQl9WQUxJREFUSU9OX0VSUk9SUykgcHJpdmF0ZSByZWFkb25seSBlcnJvcnM6IFBsYWluT2JqZWN0PHN0cmluZz4sXG4gICAgQEluamVjdChCQl9EWU5BTUlDX1ZBTElEQVRJT05fRVJST1JfVE1QTCkgcHJpdmF0ZSByZWFkb25seSBlcnJvclRtcGw6IFR5cGU8VmFsaWRhdGlvbkVycm9yQ29tcG9uZW50TW9kZWw+LFxuICAgIHByaXZhdGUgcmVhZG9ubHkgcmVzb2x2ZXI6IENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcixcbiAgICBwcml2YXRlIHJlYWRvbmx5IHZjcjogVmlld0NvbnRhaW5lclJlZixcbiAgICBwcml2YXRlIHJlYWRvbmx5IGhvc3RFbGVtOiBFbGVtZW50UmVmPEhUTUxFbGVtZW50PixcbiAgICBwcml2YXRlIHJlYWRvbmx5IHJlbmRlcmVyOiBSZW5kZXJlcjIsXG4gICkge1xuICAgIHRoaXMuc3VibWl0ID0gdGhpcy5mb3JtID8gdGhpcy5mb3JtLnN1Ym1pdCA6IEVNUFRZO1xuXG4gICAgaWYgKCF0aGlzLmNvbnRyb2wpIHtcbiAgICAgIHRocm93IEVycm9yKCdiYkZvcm1Db250cm9sIG11c3QgY29udGFpbiBhIE5nQ29udHJvbC4nKTtcbiAgICB9XG4gIH1cblxuICBuZ09uSW5pdCgpIHtcbiAgICBjb25zdCBjb250cm9sQ2hhbmdlcyA9IHRoaXMuY29udHJvbC52YWx1ZUNoYW5nZXMgPyB0aGlzLmNvbnRyb2wudmFsdWVDaGFuZ2VzIDogRU1QVFk7XG5cbiAgICBtZXJnZShcbiAgICAgIGNvbnRyb2xDaGFuZ2VzLFxuICAgICAgdGhpcy5zdWJtaXQsXG4gICAgICB0aGlzLm9uQmx1ci5waXBlKGZpcnN0KCkpLCAvLyB0byBkZXRlY3QgZmlyc3QgaW52YWxpZCBzdGF0ZSBpZiBubyBjb250cm9sIGNoYW5nZXMgaGFwcGVuZWQuXG4gICAgKVxuICAgICAgLnBpcGUoZGVib3VuY2VUaW1lKDEwMCksIHRha2VVbnRpbCh0aGlzLmRlc3Ryb3kpKVxuICAgICAgLnN1YnNjcmliZSgoKSA9PiB0aGlzLm1hbmFnZUVycm9ycygpKTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIHRoaXMuZGVzdHJveS5uZXh0KCk7XG4gICAgdGhpcy5kZXN0cm95LmNvbXBsZXRlKCk7XG4gIH1cblxuICBwcml2YXRlIG1hbmFnZUVycm9ycygpIHtcbiAgICBjb25zdCBjb250cm9sRXJyb3JzID0gdGhpcy5jb250cm9sLmVycm9ycztcblxuICAgIGlmIChjb250cm9sRXJyb3JzICYmIHRoaXMuc2hvd0Vycm9yKCkpIHtcbiAgICAgIGNvbnN0IGVycm9yTGlzdCA9IHsgLi4udGhpcy5lcnJvcnMsIC4uLnRoaXMuZXJyb3JMYWJlbHMgfTtcbiAgICAgIGNvbnN0IGZpcnN0S2V5ID0gT2JqZWN0LmtleXMoY29udHJvbEVycm9ycylbMF07XG4gICAgICBjb25zdCBnZXRFcnJvciA9IGVycm9yTGlzdFtmaXJzdEtleV0gfHwgZXJyb3JMaXN0LmludmFsaWQ7XG4gICAgICBjb25zdCB0ZXh0ID0gZ2V0RXJyb3IoY29udHJvbEVycm9yc1tmaXJzdEtleV0pO1xuXG4gICAgICAvLyBUT0RPOiBhZGQgYXJpYS1pbnZhbGlkP1xuICAgICAgaWYgKHRoaXMucmVmPy5pbnN0YW5jZS50ZXh0ICE9PSB0ZXh0KSB7XG4gICAgICAgIHRoaXMuc2V0RXJyb3IodGV4dCk7XG4gICAgICAgIHRoaXMuc2V0RGVzY3JpYmVkQnlJZCh0aGlzLnJlZj8uaW5zdGFuY2UuZXJyb3JJZCk7XG4gICAgICB9XG4gICAgfSBlbHNlIGlmICh0aGlzLnJlZikge1xuICAgICAgdGhpcy5zZXRFcnJvcignJyk7XG4gICAgICB0aGlzLnJlbW92ZUVycm9ySWQodGhpcy5yZWY/Lmluc3RhbmNlLmVycm9ySWQpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgc2V0RGVzY3JpYmVkQnlJZChpZDogc3RyaW5nIHwgdW5kZWZpbmVkKSB7XG4gICAgY29uc3QgdGFyZ2V0RWwgPSB0aGlzLmhvc3RFbGVtLm5hdGl2ZUVsZW1lbnQucXVlcnlTZWxlY3Rvcih0aGlzLmlucHV0U2VsZWN0b3IpO1xuXG4gICAgaWYgKHRhcmdldEVsKSB7XG4gICAgICBjb25zdCBleGlzdGluZ0lkcyA9IHRhcmdldEVsLmdldEF0dHJpYnV0ZSh0aGlzLmFyaWFBdHRyaWJ1dGVOYW1lKTtcbiAgICAgIGNvbnN0IGF0dHJpYnV0ZVZhbCA9IGlkTGlzdEF0dHIoaWQsIGV4aXN0aW5nSWRzKTtcblxuICAgICAgaWYgKGF0dHJpYnV0ZVZhbCkge1xuICAgICAgICB0aGlzLnJlbmRlcmVyLnNldEF0dHJpYnV0ZSh0YXJnZXRFbCwgdGhpcy5hcmlhQXR0cmlidXRlTmFtZSwgYXR0cmlidXRlVmFsKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHJlbW92ZUVycm9ySWQoaWQ6IHN0cmluZyB8IHVuZGVmaW5lZCkge1xuICAgIGNvbnN0IHRhcmdldEVsID0gdGhpcy5ob3N0RWxlbS5uYXRpdmVFbGVtZW50LnF1ZXJ5U2VsZWN0b3IodGhpcy5pbnB1dFNlbGVjdG9yKTtcblxuICAgIGlmICh0YXJnZXRFbCkge1xuICAgICAgY29uc3QgZXhpc3RpbmdJZHMgPSB0YXJnZXRFbC5nZXRBdHRyaWJ1dGUodGhpcy5hcmlhQXR0cmlidXRlTmFtZSkgfHwgJyc7XG4gICAgICBjb25zdCBjbGVhbklkcyA9IChpZCA/IGV4aXN0aW5nSWRzLnJlcGxhY2UoaWQsICcnKSA6IGV4aXN0aW5nSWRzKS50cmltKCk7XG5cbiAgICAgIGlmIChjbGVhbklkcykge1xuICAgICAgICB0aGlzLnJlbmRlcmVyLnNldEF0dHJpYnV0ZSh0YXJnZXRFbCwgdGhpcy5hcmlhQXR0cmlidXRlTmFtZSwgY2xlYW5JZHMpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5yZW5kZXJlci5yZW1vdmVBdHRyaWJ1dGUodGFyZ2V0RWwsIHRoaXMuYXJpYUF0dHJpYnV0ZU5hbWUpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgc2hvd0Vycm9yRGVmYXVsdCgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gQm9vbGVhbih0aGlzLmNvbnRyb2wuaW52YWxpZCk7XG4gIH1cblxuICBwcml2YXRlIHNldEVycm9yKHRleHQ6IHN0cmluZykge1xuICAgIGlmICghdGhpcy5yZWYpIHtcbiAgICAgIGNvbnN0IGNvbnRhaW5lciA9IHRoaXMuY29udHJvbEVycm9yQ29udGFpbmVyPy52Y3IgfHwgdGhpcy52Y3I7XG4gICAgICBjb25zdCBmYWN0b3J5ID0gdGhpcy5yZXNvbHZlci5yZXNvbHZlQ29tcG9uZW50RmFjdG9yeTxWYWxpZGF0aW9uRXJyb3JDb21wb25lbnRNb2RlbD4odGhpcy5lcnJvckNvbXBvbmVudCk7XG5cbiAgICAgIHRoaXMucmVmID0gY29udGFpbmVyLmNyZWF0ZUNvbXBvbmVudChmYWN0b3J5KTtcbiAgICB9XG5cbiAgICB0aGlzLnJlZi5pbnN0YW5jZS50ZXh0ID0gdGV4dDtcblxuICAgIC8vIFNldHVwIHRoaXMgcHJvcGVydGllcyBpbiBjYXNlIG9mIGN1c3RvbSB2YWxpZGF0aW9uIGVycm9yIGNvbXBvbmVudCB0byBnaXZlIHBvc3NpYmlsaXR5IHRvIGN1c3RvbWlzZSBiZWhhdmlvci5cbiAgICB0aGlzLnJlZi5pbnN0YW5jZS5jb250cm9sID0gdGhpcy5jb250cm9sO1xuICAgIHRoaXMucmVmLmluc3RhbmNlLmVycm9yTGlzdCA9IHsgLi4udGhpcy5lcnJvcnMsIC4uLnRoaXMuZXJyb3JMYWJlbHMgfTtcbiAgICB0aGlzLnJlZi5pbnN0YW5jZS5sYWJlbCA9IHRoaXMubGFiZWw7XG5cbiAgICB0aGlzLnJlZi5jaGFuZ2VEZXRlY3RvclJlZi5kZXRlY3RDaGFuZ2VzKCk7XG4gIH1cbn1cbiJdfQ==