import { Component, ContentChild, Directive, EventEmitter, Inject, Input, Output, ViewChild, } from '@angular/core';
import { getKeyCode, KEY_CODES } from '@backbase/ui-ang/util';
import { ModalHeaderComponent } from './modal-templates/modal-header.component';
import { DOCUMENT } from '@angular/common';
import * as i0 from "@angular/core";
import * as i1 from "@ng-bootstrap/ng-bootstrap";
import * as i2 from "@backbase/ui-ang/services";
import * as i3 from "@backbase/foundation-ang/future";
import * as i4 from "@angular/cdk/a11y";
/**
 * @name ModalComponent
 *
 * @description
 * Component that displays a modal window.
 */
export class ModalComponent {
    constructor(modalService, renderer, domAttrService, depricatedService, 
    // cannot use type `Document` due to compilation issues caused by `strictMetadataEmit`
    document) {
        this.modalService = modalService;
        this.renderer = renderer;
        this.domAttrService = domAttrService;
        this.depricatedService = depricatedService;
        this.document = document;
        this.id = this.domAttrService.generateId();
        /**
         * The flag to show the dialog window.  Defaults to 'false'.
         */
        this.isOpen = false;
        /**
         * Dialog options. Defaults to empty object.
         */
        this.modalOptions = {};
        /**
         * The event that's fired after confirm button is pressed. Can be used with
         * (click)="dialogRef.onConfirm()" where dialogRef is a templateRef on <bb-dialog-ui #dialogRef />
         */
        this.confirm = new EventEmitter();
        /**
         * The event that's fired after cancel button is pressed. Can be used with
         * (click)="dialogRef.onCancel()" where dialogRef is a templateRef on <bb-dialog-ui #dialogRef />
         */
        this.cancel = new EventEmitter();
        /**
         * Used for two way binding with the isOpen Input. If used, backdrop
         * and esc dismiss cases will be handled automatically.
         */
        this.isOpenChange = new EventEmitter();
        this.emitConfirm = true;
    }
    ngOnChanges() {
        if (this.isOpen) {
            this.setConfirm(true);
            // needs to be inside setTimeout due to the
            // https://github.com/angular/angular/issues/15634
            setTimeout(() => {
                const headerId = this.modalHeader ? this.modalHeader.headerId : '';
                this.ariaLabelledby = this.ariaLabelledby || headerId;
                this.modalOptions.ariaDescribedBy = this.ariaDescribedby
                    ? this.ariaDescribedby
                    : this.modalOptions.ariaDescribedBy;
                this.modalOptions.ariaLabelledBy = this.ariaLabelledby ? this.ariaLabelledby : this.modalOptions.ariaLabelledBy;
                this.modalRef = this.modalService.open(this.modalContent, this.modalOptions);
                this.modalRef.result.then((result) => {
                    if (this.emitConfirm) {
                        this.confirm.emit(result);
                    }
                }, (reason) => this.cancel.emit(this.getDismissReason(reason)));
            }, 0);
            // remove role=document from dialog, because we need have role=dialog, bootstrap accessibility bug
            setTimeout(() => {
                const modalContent = this.document.getElementsByClassName('modal-dialog');
                const modal = this.document.getElementsByClassName('modal');
                modalContent === null || modalContent === void 0 ? void 0 : modalContent[0].removeAttribute('role');
                modal === null || modal === void 0 ? void 0 : modal[0].scrollTo(0, 0);
            }, 0);
        }
        else if (this.modalRef) {
            this.setConfirm(false);
            this.modalRef.close();
        }
    }
    onElementViewInit(el) {
        this.copyAriaAttrsToElement(el);
    }
    copyAriaAttrsToElement(el) {
        this.depricatedService.logDeprecatedFeature('`copyAriaAttrsToElement` of `ModalComponent` is deprecated.');
        const headerId = this.modalHeader ? this.modalHeader.headerId : '';
        const dialogHostNativeElement = this.modalRef['_windowCmptRef'].instance._elRef.nativeElement;
        if (headerId && !this.modalOptions.ariaLabelledBy) {
            this.renderer.setAttribute(dialogHostNativeElement, 'aria-labelledby', headerId);
        }
        if (this.ariaDescribedby && !this.modalOptions.ariaDescribedBy) {
            this.renderer.setAttribute(dialogHostNativeElement, 'aria-describedby', this.ariaDescribedby);
        }
    }
    getDismissReason(reason) {
        this.isOpenChange.emit(false);
        return reason;
    }
    dismissModal(reason) {
        if (this.modalRef)
            this.modalRef.dismiss(reason);
    }
    closeModal(reason) {
        if (this.modalRef)
            this.modalRef.close(reason);
    }
    setConfirm(flag) {
        this.emitConfirm = flag;
    }
    ngOnDestroy() {
        this.closeModal();
    }
    trapKeyEvent(event) {
        if (getKeyCode(event) !== KEY_CODES.ESCAPE) {
            event.stopPropagation();
        }
    }
}
ModalComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: ModalComponent, deps: [{ token: i1.NgbModal }, { token: i0.Renderer2 }, { token: i2.DomAttributesService }, { token: i3.DeprecationsService }, { token: DOCUMENT }], target: i0.ɵɵFactoryTarget.Component });
ModalComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "12.0.0", version: "12.2.16", type: ModalComponent, selector: "bb-modal-ui", inputs: { isOpen: "isOpen", ariaLabelledby: ["aria-labelledby", "ariaLabelledby"], ariaDescribedby: ["aria-describedby", "ariaDescribedby"], modalOptions: "modalOptions" }, outputs: { confirm: "confirm", cancel: "cancel", isOpenChange: "isOpenChange" }, queries: [{ propertyName: "modalHeader", first: true, predicate: ModalHeaderComponent, descendants: true }], viewQueries: [{ propertyName: "modalContent", first: true, predicate: ["modalContent"], descendants: true, static: true }], usesOnChanges: true, ngImport: i0, template: "<ng-template #modalContent let-close=\"close\">\n  <div\n    class=\"modal-content-container\"\n    (keydown)=\"trapKeyEvent($event)\"\n    (keyup)=\"trapKeyEvent($event)\"\n    cdkTrapFocus\n    [cdkTrapFocusAutoCapture]=\"true\"\n    (bbElementViewInit)=\"onElementViewInit($event)\"\n  >\n    <ng-content></ng-content>\n  </div>\n</ng-template>\n", directives: [{ type: i0.forwardRef(function () { return i4.CdkTrapFocus; }), selector: "[cdkTrapFocus]", inputs: ["cdkTrapFocus", "cdkTrapFocusAutoCapture"], exportAs: ["cdkTrapFocus"] }, { type: i0.forwardRef(function () { return ElementViewInitDirective; }), selector: "[bbElementViewInit]", outputs: ["bbElementViewInit"] }] });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: ModalComponent, decorators: [{
            type: Component,
            args: [{
                    selector: 'bb-modal-ui',
                    templateUrl: './modal.component.html',
                }]
        }], ctorParameters: function () { return [{ type: i1.NgbModal }, { type: i0.Renderer2 }, { type: i2.DomAttributesService }, { type: i3.DeprecationsService }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [DOCUMENT]
                }] }]; }, propDecorators: { isOpen: [{
                type: Input
            }], ariaLabelledby: [{
                type: Input,
                args: ['aria-labelledby']
            }], ariaDescribedby: [{
                type: Input,
                args: ['aria-describedby']
            }], modalOptions: [{
                type: Input
            }], confirm: [{
                type: Output
            }], cancel: [{
                type: Output
            }], isOpenChange: [{
                type: Output
            }], modalContent: [{
                type: ViewChild,
                args: ['modalContent', { static: true }]
            }], modalHeader: [{
                type: ContentChild,
                args: [ModalHeaderComponent]
            }] } });
export class ElementViewInitDirective {
    constructor(elem) {
        this.elem = elem;
        this.bbElementViewInit = new EventEmitter();
    }
    ngAfterViewInit() {
        this.bbElementViewInit.emit(this.elem);
    }
}
ElementViewInitDirective.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: ElementViewInitDirective, deps: [{ token: i0.ElementRef }], target: i0.ɵɵFactoryTarget.Directive });
ElementViewInitDirective.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "12.0.0", version: "12.2.16", type: ElementViewInitDirective, selector: "[bbElementViewInit]", outputs: { bbElementViewInit: "bbElementViewInit" }, ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: ElementViewInitDirective, decorators: [{
            type: Directive,
            args: [{
                    selector: '[bbElementViewInit]',
                }]
        }], ctorParameters: function () { return [{ type: i0.ElementRef }]; }, propDecorators: { bbElementViewInit: [{
                type: Output
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9kYWwuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vbGlicy91aS1hbmcvbW9kYWwvbW9kYWwuY29tcG9uZW50LnRzIiwiLi4vLi4vLi4vLi4vLi4vbGlicy91aS1hbmcvbW9kYWwvbW9kYWwuY29tcG9uZW50Lmh0bWwiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUVMLFNBQVMsRUFDVCxZQUFZLEVBQ1osU0FBUyxFQUVULFlBQVksRUFDWixNQUFNLEVBQ04sS0FBSyxFQUdMLE1BQU0sRUFHTixTQUFTLEdBQ1YsTUFBTSxlQUFlLENBQUM7QUFFdkIsT0FBTyxFQUFFLFVBQVUsRUFBRSxTQUFTLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUU5RCxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSwwQ0FBMEMsQ0FBQztBQUVoRixPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0saUJBQWlCLENBQUM7Ozs7OztBQUUzQzs7Ozs7R0FLRztBQUtILE1BQU0sT0FBTyxjQUFjO0lBQ3pCLFlBQ21CLFlBQXNCLEVBQ3RCLFFBQW1CLEVBQ25CLGNBQW9DLEVBQ3BDLGlCQUFzQztJQUN2RCxzRkFBc0Y7SUFDbkQsUUFBYTtRQUwvQixpQkFBWSxHQUFaLFlBQVksQ0FBVTtRQUN0QixhQUFRLEdBQVIsUUFBUSxDQUFXO1FBQ25CLG1CQUFjLEdBQWQsY0FBYyxDQUFzQjtRQUNwQyxzQkFBaUIsR0FBakIsaUJBQWlCLENBQXFCO1FBRXBCLGFBQVEsR0FBUixRQUFRLENBQUs7UUFJekMsT0FBRSxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsVUFBVSxFQUFFLENBQUM7UUFDL0M7O1dBRUc7UUFDTSxXQUFNLEdBQUcsS0FBSyxDQUFDO1FBVXhCOztXQUVHO1FBQ00saUJBQVksR0FBb0IsRUFBRSxDQUFDO1FBQzVDOzs7V0FHRztRQUNPLFlBQU8sR0FBRyxJQUFJLFlBQVksRUFBRSxDQUFDO1FBQ3ZDOzs7V0FHRztR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b3J0IHtcbiAgQWZ0ZXJWaWV3SW5pdCxcbiAgQ29tcG9uZW50LFxuICBDb250ZW50Q2hpbGQsXG4gIERpcmVjdGl2ZSxcbiAgRWxlbWVudFJlZixcbiAgRXZlbnRFbWl0dGVyLFxuICBJbmplY3QsXG4gIElucHV0LFxuICBPbkNoYW5nZXMsXG4gIE9uRGVzdHJveSxcbiAgT3V0cHV0LFxuICBSZW5kZXJlcjIsXG4gIFRlbXBsYXRlUmVmLFxuICBWaWV3Q2hpbGQsXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgTW9kYWxEaXNtaXNzUmVhc29ucywgTmdiTW9kYWwsIE5nYk1vZGFsT3B0aW9ucywgTmdiTW9kYWxSZWYgfSBmcm9tICdAbmctYm9vdHN0cmFwL25nLWJvb3RzdHJhcCc7XG5pbXBvcnQgeyBnZXRLZXlDb2RlLCBLRVlfQ09ERVMgfSBmcm9tICdAYmFja2Jhc2UvdWktYW5nL3V0aWwnO1xuaW1wb3J0IHsgRG9tQXR0cmlidXRlc1NlcnZpY2UgfSBmcm9tICdAYmFja2Jhc2UvdWktYW5nL3NlcnZpY2VzJztcbmltcG9ydCB7IE1vZGFsSGVhZGVyQ29tcG9uZW50IH0gZnJvbSAnLi9tb2RhbC10ZW1wbGF0ZXMvbW9kYWwtaGVhZGVyLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBEZXByZWNhdGlvbnNTZXJ2aWNlIH0gZnJvbSAnQGJhY2tiYXNlL2ZvdW5kYXRpb24tYW5nL2Z1dHVyZSc7XG5pbXBvcnQgeyBET0NVTUVOVCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5cbi8qKlxuICogQG5hbWUgTW9kYWxDb21wb25lbnRcbiAqXG4gKiBAZGVzY3JpcHRpb25cbiAqIENvbXBvbmVudCB0aGF0IGRpc3BsYXlzIGEgbW9kYWwgd2luZG93LlxuICovXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdiYi1tb2RhbC11aScsXG4gIHRlbXBsYXRlVXJsOiAnLi9tb2RhbC5jb21wb25lbnQuaHRtbCcsXG59KVxuZXhwb3J0IGNsYXNzIE1vZGFsQ29tcG9uZW50IGltcGxlbWVudHMgT25DaGFuZ2VzLCBPbkRlc3Ryb3kge1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IG1vZGFsU2VydmljZTogTmdiTW9kYWwsXG4gICAgcHJpdmF0ZSByZWFkb25seSByZW5kZXJlcjogUmVuZGVyZXIyLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgZG9tQXR0clNlcnZpY2U6IERvbUF0dHJpYnV0ZXNTZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgZGVwcmljYXRlZFNlcnZpY2U6IERlcHJlY2F0aW9uc1NlcnZpY2UsXG4gICAgLy8gY2Fubm90IHVzZSB0eXBlIGBEb2N1bWVudGAgZHVlIHRvIGNvbXBpbGF0aW9uIGlzc3VlcyBjYXVzZWQgYnkgYHN0cmljdE1ldGFkYXRhRW1pdGBcbiAgICBASW5qZWN0KERPQ1VNRU5UKSBwcml2YXRlIHJlYWRvbmx5IGRvY3VtZW50OiBhbnksXG4gICkge31cblxuICBwcml2YXRlIG1vZGFsUmVmOiBOZ2JNb2RhbFJlZiB8IHVuZGVmaW5lZDtcbiAgcmVhZG9ubHkgaWQgPSB0aGlzLmRvbUF0dHJTZXJ2aWNlLmdlbmVyYXRlSWQoKTtcbiAgLyoqXG4gICAqIFRoZSBmbGFnIHRvIHNob3cgdGhlIGRpYWxvZyB3aW5kb3cuICBEZWZhdWx0cyB0byAnZmFsc2UnLlxuICAgKi9cbiAgQElucHV0KCkgaXNPcGVuID0gZmFsc2U7XG4gIC8qKlxuICAgKiBTZXQgYXJpYS1sYWJlbGxlZGJ5ICB3aXRoIGFuIGVsZW1lbnQgaWQgdGhhdCBjb250YWlucyBhIGJyaWVmIGxhYmVsIGFib3V0IHRoZSBtb2RhbCxcbiAgICogQnkgRGVmYXVsdCBpcyB0YWtlcyB0aGUgbW9kYWwgaGVhZGluZ1xuICAgKi9cbiAgQElucHV0KCdhcmlhLWxhYmVsbGVkYnknKSBhcmlhTGFiZWxsZWRieTogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICAvKipcbiAgICogU2V0IGFyaWEtZGVzY3JpYmVkYnkgIHdpdGggYW4gZWxlbWVudCBpZCB0aGF0IGNvbnRhaW5zIGEgZGV0YWlsZWQgZGVjcmlwdGlvbiBhYm91dCB0aGUgbW9kYWxcbiAgICovXG4gIEBJbnB1dCgnYXJpYS1kZXNjcmliZWRieScpIGFyaWFEZXNjcmliZWRieTogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICAvKipcbiAgICogRGlhbG9nIG9wdGlvbnMuIERlZmF1bHRzIHRvIGVtcHR5IG9iamVjdC5cbiAgICovXG4gIEBJbnB1dCgpIG1vZGFsT3B0aW9uczogTmdiTW9kYWxPcHRpb25zID0ge307XG4gIC8qKlxuICAgKiBUaGUgZXZlbnQgdGhhdCdzIGZpcmVkIGFmdGVyIGNvbmZpcm0gYnV0dG9uIGlzIHByZXNzZWQuIENhbiBiZSB1c2VkIHdpdGhcbiAgICogKGNsaWNrKT1cImRpYWxvZ1JlZi5vbkNvbmZpcm0oKVwiIHdoZXJlIGRpYWxvZ1JlZiBpcyBhIHRlbXBsYXRlUmVmIG9uIDxiYi1kaWFsb2ctdWkgI2RpYWxvZ1JlZiAvPlxuICAgKi9cbiAgQE91dHB1dCgpIGNvbmZpcm0gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gIC8qKlxuICAgKiBUaGUgZXZlbnQgdGhhdCdzIGZpcmVkIGFmdGVyIGNhbmNlbCBidXR0b24gaXMgcHJlc3NlZC4gQ2FuIGJlIHVzZWQgd2l0aFxuICAgKiAoY2xpY2spPVwiZGlhbG9nUmVmLm9uQ2FuY2VsKClcIiB3aGVyZSBkaWFsb2dSZWYgaXMgYSB0ZW1wbGF0ZVJlZiBvbiA8YmItZGlhbG9nLXVpICNkaWFsb2dSZWYgLz5cbiAgICovXG4gIEBPdXRwdXQoKSBjYW5jZWwgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gIC8qKlxuICAgKiBVc2VkIGZvciB0d28gd2F5IGJpbmRpbmcgd2l0aCB0aGUgaXNPcGVuIElucHV0LiBJZiB1c2VkLCBiYWNrZHJvcFxuICAgKiBhbmQgZXNjIGRpc21pc3MgY2FzZXMgd2lsbCBiZSBoYW5kbGVkIGF1dG9tYXRpY2FsbHkuXG4gICAqL1xuICBAT3V0cHV0KCkgaXNPcGVuQ2hhbmdlID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuXG4gIEBWaWV3Q2hpbGQoJ21vZGFsQ29udGVudCcsIHsgc3RhdGljOiB0cnVlIH0pIG1vZGFsQ29udGVudDogVGVtcGxhdGVSZWY8YW55PiB8IHVuZGVmaW5lZDtcblxuICBAQ29udGVudENoaWxkKE1vZGFsSGVhZGVyQ29tcG9uZW50KSBtb2RhbEhlYWRlcjogTW9kYWxIZWFkZXJDb21wb25lbnQgfCB1bmRlZmluZWQ7XG5cbiAgcHJpdmF0ZSBlbWl0Q29uZmlybSA9IHRydWU7XG5cbiAgbmdPbkNoYW5nZXMoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuaXNPcGVuKSB7XG4gICAgICB0aGlzLnNldENvbmZpcm0odHJ1ZSk7XG4gICAgICAvLyBuZWVkcyB0byBiZSBpbnNpZGUgc2V0VGltZW91dCBkdWUgdG8gdGhlXG4gICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci9hbmd1bGFyL2lzc3Vlcy8xNTYzNFxuICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIGNvbnN0IGhlYWRlcklkID0gdGhpcy5tb2RhbEhlYWRlciA/IHRoaXMubW9kYWxIZWFkZXIuaGVhZGVySWQgOiAnJztcbiAgICAgICAgdGhpcy5hcmlhTGFiZWxsZWRieSA9IHRoaXMuYXJpYUxhYmVsbGVkYnkgfHwgaGVhZGVySWQ7XG4gICAgICAgIHRoaXMubW9kYWxPcHRpb25zLmFyaWFEZXNjcmliZWRCeSA9IHRoaXMuYXJpYURlc2NyaWJlZGJ5XG4gICAgICAgICAgPyB0aGlzLmFyaWFEZXNjcmliZWRieVxuICAgICAgICAgIDogdGhpcy5tb2RhbE9wdGlvbnMuYXJpYURlc2NyaWJlZEJ5O1xuICAgICAgICB0aGlzLm1vZGFsT3B0aW9ucy5hcmlhTGFiZWxsZWRCeSA9IHRoaXMuYXJpYUxhYmVsbGVkYnkgPyB0aGlzLmFyaWFMYWJlbGxlZGJ5IDogdGhpcy5tb2RhbE9wdGlvbnMuYXJpYUxhYmVsbGVkQnk7XG4gICAgICAgIHRoaXMubW9kYWxSZWYgPSB0aGlzLm1vZGFsU2VydmljZS5vcGVuKHRoaXMubW9kYWxDb250ZW50LCB0aGlzLm1vZGFsT3B0aW9ucyk7XG4gICAgICAgIHRoaXMubW9kYWxSZWYucmVzdWx0LnRoZW4oXG4gICAgICAgICAgKHJlc3VsdCkgPT4ge1xuICAgICAgICAgICAgaWYgKHRoaXMuZW1pdENvbmZpcm0pIHtcbiAgICAgICAgICAgICAgdGhpcy5jb25maXJtLmVtaXQocmVzdWx0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9LFxuICAgICAgICAgIChyZWFzb24pID0+IHRoaXMuY2FuY2VsLmVtaXQodGhpcy5nZXREaXNtaXNzUmVhc29uKHJlYXNvbikpLFxuICAgICAgICApO1xuICAgICAgfSwgMCk7XG5cbiAgICAgIC8vIHJlbW92ZSByb2xlPWRvY3VtZW50IGZyb20gZGlhbG9nLCBiZWNhdXNlIHdlIG5lZWQgaGF2ZSByb2xlPWRpYWxvZywgYm9vdHN0cmFwIGFjY2Vzc2liaWxpdHkgYnVnXG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgY29uc3QgbW9kYWxDb250ZW50ID0gKHRoaXMuZG9jdW1lbnQgYXMgRG9jdW1lbnQpLmdldEVsZW1lbnRzQnlDbGFzc05hbWUoJ21vZGFsLWRpYWxvZycpO1xuICAgICAgICBjb25zdCBtb2RhbCA9ICh0aGlzLmRvY3VtZW50IGFzIERvY3VtZW50KS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCdtb2RhbCcpO1xuICAgICAgICBtb2RhbENvbnRlbnQ/LlswXS5yZW1vdmVBdHRyaWJ1dGUoJ3JvbGUnKTtcbiAgICAgICAgbW9kYWw/LlswXS5zY3JvbGxUbygwLCAwKTtcbiAgICAgIH0sIDApO1xuICAgIH0gZWxzZSBpZiAodGhpcy5tb2RhbFJlZikge1xuICAgICAgdGhpcy5zZXRDb25maXJtKGZhbHNlKTtcbiAgICAgIHRoaXMubW9kYWxSZWYuY2xvc2UoKTtcbiAgICB9XG4gIH1cblxuICBvbkVsZW1lbnRWaWV3SW5pdChlbDogRWxlbWVudFJlZjxNb2RhbEhlYWRlckNvbXBvbmVudD4pIHtcbiAgICB0aGlzLmNvcHlBcmlhQXR0cnNUb0VsZW1lbnQoZWwpO1xuICB9XG5cbiAgY29weUFyaWFBdHRyc1RvRWxlbWVudChlbDogRWxlbWVudFJlZikge1xuICAgIHRoaXMuZGVwcmljYXRlZFNlcnZpY2UubG9nRGVwcmVjYXRlZEZlYXR1cmUoJ2Bjb3B5QXJpYUF0dHJzVG9FbGVtZW50YCBvZiBgTW9kYWxDb21wb25lbnRgIGlzIGRlcHJlY2F0ZWQuJyk7XG4gICAgY29uc3QgaGVhZGVySWQgPSB0aGlzLm1vZGFsSGVhZGVyID8gdGhpcy5tb2RhbEhlYWRlci5oZWFkZXJJZCA6ICcnO1xuXG4gICAgY29uc3QgZGlhbG9nSG9zdE5hdGl2ZUVsZW1lbnQgPSAodGhpcy5tb2RhbFJlZiBhcyBhbnkpWydfd2luZG93Q21wdFJlZiddLmluc3RhbmNlLl9lbFJlZi5uYXRpdmVFbGVtZW50O1xuXG4gICAgaWYgKGhlYWRlcklkICYmICF0aGlzLm1vZGFsT3B0aW9ucy5hcmlhTGFiZWxsZWRCeSkge1xuICAgICAgdGhpcy5yZW5kZXJlci5zZXRBdHRyaWJ1dGUoZGlhbG9nSG9zdE5hdGl2ZUVsZW1lbnQsICdhcmlhLWxhYmVsbGVkYnknLCBoZWFkZXJJZCk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuYXJpYURlc2NyaWJlZGJ5ICYmICF0aGlzLm1vZGFsT3B0aW9ucy5hcmlhRGVzY3JpYmVkQnkpIHtcbiAgICAgIHRoaXMucmVuZGVyZXIuc2V0QXR0cmlidXRlKGRpYWxvZ0hvc3ROYXRpdmVFbGVtZW50LCAnYXJpYS1kZXNjcmliZWRieScsIHRoaXMuYXJpYURlc2NyaWJlZGJ5KTtcbiAgICB9XG4gIH1cblxuICBnZXREaXNtaXNzUmVhc29uKHJlYXNvbjogTW9kYWxEaXNtaXNzUmVhc29ucyB8IHN0cmluZyk6IE1vZGFsRGlzbWlzc1JlYXNvbnMgfCBzdHJpbmcge1xuICAgIHRoaXMuaXNPcGVuQ2hhbmdlLmVtaXQoZmFsc2UpO1xuXG4gICAgcmV0dXJuIHJlYXNvbjtcbiAgfVxuXG4gIGRpc21pc3NNb2RhbChyZWFzb24/OiBzdHJpbmcpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5tb2RhbFJlZikgdGhpcy5tb2RhbFJlZi5kaXNtaXNzKHJlYXNvbik7XG4gIH1cblxuICBjbG9zZU1vZGFsKHJlYXNvbj86IHN0cmluZyk6IHZvaWQge1xuICAgIGlmICh0aGlzLm1vZGFsUmVmKSB0aGlzLm1vZGFsUmVmLmNsb3NlKHJlYXNvbik7XG4gIH1cblxuICBzZXRDb25maXJtKGZsYWc6IGJvb2xlYW4pOiB2b2lkIHtcbiAgICB0aGlzLmVtaXRDb25maXJtID0gZmxhZztcbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIHRoaXMuY2xvc2VNb2RhbCgpO1xuICB9XG5cbiAgdHJhcEtleUV2ZW50KGV2ZW50OiBLZXlib2FyZEV2ZW50KSB7XG4gICAgaWYgKGdldEtleUNvZGUoZXZlbnQpICE9PSBLRVlfQ09ERVMuRVNDQVBFKSB7XG4gICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICB9XG4gIH1cbn1cblxuQERpcmVjdGl2ZSh7XG4gIHNlbGVjdG9yOiAnW2JiRWxlbWVudFZpZXdJbml0XScsXG59KVxuZXhwb3J0IGNsYXNzIEVsZW1lbnRWaWV3SW5pdERpcmVjdGl2ZSBpbXBsZW1lbnRzIEFmdGVyVmlld0luaXQge1xuICBAT3V0cHV0KCkgYmJFbGVtZW50Vmlld0luaXQgPSBuZXcgRXZlbnRFbWl0dGVyPEVsZW1lbnRSZWY+KCk7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBlbGVtOiBFbGVtZW50UmVmKSB7fVxuXG4gIG5nQWZ0ZXJWaWV3SW5pdCgpOiB2b2lkIHtcbiAgICB0aGlzLmJiRWxlbWVudFZpZXdJbml0LmVtaXQodGhpcy5lbGVtKTtcbiAgfVxufVxuIiwiPG5nLXRlbXBsYXRlICNtb2RhbENvbnRlbnQgbGV0LWNsb3NlPVwiY2xvc2VcIj5cbiAgPGRpdlxuICAgIGNsYXNzPVwibW9kYWwtY29udGVudC1jb250YWluZXJcIlxuICAgIChrZXlkb3duKT1cInRyYXBLZXlFdmVudCgkZXZlbnQpXCJcbiAgICAoa2V5dXApPVwidHJhcEtleUV2ZW50KCRldmVudClcIlxuICAgIGNka1RyYXBGb2N1c1xuICAgIFtjZGtUcmFwRm9jdXNBdXRvQ2FwdHVyZV09XCJ0cnVlXCJcbiAgICAoYmJFbGVtZW50Vmlld0luaXQpPVwib25FbGVtZW50Vmlld0luaXQoJGV2ZW50KVwiXG4gID5cbiAgICA8bmctY29udGVudD48L25nLWNvbnRlbnQ+XG4gIDwvZGl2PlxuPC9uZy10ZW1wbGF0ZT5cbiJdfQ==