import { Component, EventEmitter, Inject, Input, Output } from '@angular/core';
import { RichTextEditorActionsComponent } from '../rich-text-editor-actions.component';
import { DOCUMENT } from '@angular/common';
import * as i0 from "@angular/core";
import * as i1 from "../rich-text-editor-actions.service";
import * as i2 from "@backbase/ui-ang/icon";
import * as i3 from "@backbase/ui-ang/modal";
import * as i4 from "@backbase/ui-ang/tooltip-directive";
import * as i5 from "@backbase/ui-ang/button";
import * as i6 from "@angular/forms";
/**
 * @name RichTextEditorLinkActionComponent
 *
 * @dynamic (to suppress error with resolving statics declarations during compilation)
 */
export class RichTextEditorLinkActionComponent extends RichTextEditorActionsComponent {
    constructor(ma, document) {
        super(ma);
        this.document = document;
        /**
         * Event emitted after link was added
         */
        this.linkAdded = new EventEmitter();
        /**
         * Flag to determine whether the add link modal is open
         */
        this.modalOpened = false;
        /**
         * Selection link url
         */
        this.selectionUrl = '';
    }
    /**
     * Open add link modal
     */
    openModal() {
        var _a, _b, _c, _d;
        this.modalOpened = true;
        this.setSelectionData();
        if (((_a = this.selection) === null || _a === void 0 ? void 0 : _a.rangeCount) && ((_b = this.selection) === null || _b === void 0 ? void 0 : _b.rangeCount) > 0) {
            this.selectionUrl =
                ((_c = this.linkedSelection) === null || _c === void 0 ? void 0 : _c.nodeName) === 'A' && ((_d = this.linkedSelection) === null || _d === void 0 ? void 0 : _d.href) !== ''
                    ? this.linkedSelection.href
                    : 'http://';
        }
    }
    /**
     * On add link modal confirmation
     */
    onResult() {
        this.restoreSelection();
        this.selectionUrl = this.selectionUrl.replace(/\s/g, '');
        if (this.selectionUrl.length === 0) {
            this.document.execCommand('unlink', false);
        }
        else {
            this.insertLink();
        }
        this.closeModal();
    }
    /**
     * Close add link modal
     */
    closeModal() {
        this.modalOpened = false;
        this.linkAdded.emit();
    }
    setSelectionData() {
        var _a;
        this.selection = this.document.getSelection();
        this.range = (_a = this.selection) === null || _a === void 0 ? void 0 : _a.getRangeAt(0);
        this.selectionUrl = '';
    }
    restoreSelection() {
        var _a, _b;
        if (this.range) {
            (_a = this.selection) === null || _a === void 0 ? void 0 : _a.removeAllRanges();
            (_b = this.selection) === null || _b === void 0 ? void 0 : _b.addRange(this.range);
        }
    }
    insertLink() {
        var _a;
        if (!/^(http:\/\/|https:\/\/)/.test(this.selectionUrl)) {
            this.selectionUrl = 'http://' + this.selectionUrl;
        }
        if (((_a = this.range) === null || _a === void 0 ? void 0 : _a.toString()) !== '') {
            this.document.execCommand('createLink', false, this.selectionUrl);
        }
        else {
            this.document.execCommand('insertHTML', false, this.linkElement);
        }
    }
    get linkElement() {
        var _a;
        const innerText = ((_a = this.selection) === null || _a === void 0 ? void 0 : _a.toString()) || this.selectionUrl;
        const element = this.document.createElement('a');
        element.setAttribute('href', this.selectionUrl);
        element.setAttribute('target', '_blank');
        element.innerHTML = innerText;
        return element.outerHTML;
    }
    get linkedSelection() {
        var _a, _b, _c, _d, _e, _f, _g;
        return (((_c = (_b = (_a = this.range) === null || _a === void 0 ? void 0 : _a.commonAncestorContainer) === null || _b === void 0 ? void 0 : _b.parentElement) === null || _c === void 0 ? void 0 : _c.closest('a')) ||
            ((_g = (_f = (_e = (_d = this.range) === null || _d === void 0 ? void 0 : _d.commonAncestorContainer) === null || _e === void 0 ? void 0 : _e.children) === null || _f === void 0 ? void 0 : _f[0]) === null || _g === void 0 ? void 0 : _g.closest('a')));
    }
}
RichTextEditorLinkActionComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: RichTextEditorLinkActionComponent, deps: [{ token: i1.RichTextEditorActionsService }, { token: DOCUMENT }], target: i0.ɵɵFactoryTarget.Component });
RichTextEditorLinkActionComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "12.0.0", version: "12.2.16", type: RichTextEditorLinkActionComponent, selector: "bb-rich-text-editor-link-action", inputs: { contentClassNames: "contentClassNames" }, outputs: { linkAdded: "linkAdded" }, usesInheritance: true, ngImport: i0, template: "<span\n  bbTooltip=\"Link\"\n  i18n-bbTooltip=\"Link|Link action @@bb-rich-text-editor-ui.rich-text-editor-actions.link\"\n  container=\"body\"\n  triggers=\"hover focus\"\n  [placement]=\"actionsTooltipPlacement\"\n>\n  <button\n    bbButton\n    [circle]=\"true\"\n    color=\"link-dark\"\n    aria-label=\"Link\"\n    i18n-aria-label=\"@@bb-rich-text-editor-ui.rich-text-editor-actions.link\"\n    [disabled]=\"disabled\"\n    (click)=\"openModal()\"\n    data-role=\"link-action\"\n  >\n    <bb-icon-ui name=\"link\"></bb-icon-ui>\n  </button>\n</span>\n\n<bb-modal-ui [isOpen]=\"modalOpened\" (cancel)=\"closeModal()\" (confirm)=\"onResult()\">\n  <form data-role=\"add-link-form\">\n    <bb-modal-header-ui\n      title=\"Add link\"\n      i18n-title=\"Add link|Add link title@@bb-rich-text-editor-ui.rich-text-editor-link-modal.title\"\n    ></bb-modal-header-ui>\n    <bb-modal-body-ui>\n      <ng-template bbCustomModalBody>\n        <label\n          class=\"bb-label\"\n          for=\"link-input\"\n          i18n=\"Enter the link|Enter the link title@@bb-rich-text-editor-ui.rich-text-editor-link-modal.input-label\"\n        >\n          Enter the URL Link\n        </label>\n        <input\n          type=\"text\"\n          class=\"form-control\"\n          [(ngModel)]=\"selectionUrl\"\n          name=\"url\"\n          id=\"link-input\"\n          data-role=\"link-input\"\n        />\n      </ng-template>\n    </bb-modal-body-ui>\n    <bb-modal-footer-ui #footerRef data-role=\"link-modal-footer\">\n      <ng-template bbCustomModalFooter>\n        <div class=\"bb-button-bar\">\n          <button\n            bbButton\n            class=\"bb-button-bar__button\"\n            (click)=\"onResult()\"\n            type=\"submit\"\n            data-role=\"save-link\"\n            i18n=\"Save a link|Save a link button@@bb-rich-text-editor-ui.rich-text-editor-link-modal.save-button\"\n          >\n            Save Link\n          </button>\n          <button\n            bbButton\n            class=\"bb-button-bar__button\"\n            (click)=\"closeModal()\"\n            color=\"secondary\"\n            data-role=\"cancel-link-saving\"\n            i18n=\"Cancel|Cancel button@@bb-rich-text-editor-ui.rich-text-editor-link-modal.cancel-button\"\n          >\n            Cancel\n          </button>\n        </div>\n      </ng-template>\n    </bb-modal-footer-ui>\n  </form>\n</bb-modal-ui>\n", components: [{ type: i2.IconComponent, selector: "bb-icon-ui", inputs: ["name", "inverse", "size", "color", "animate", "aria-label", "cropped", "backgroundType"] }, { type: i3.ModalComponent, selector: "bb-modal-ui", inputs: ["isOpen", "aria-labelledby", "aria-describedby", "modalOptions"], outputs: ["confirm", "cancel", "isOpenChange"] }, { type: i3.ModalHeaderComponent, selector: "bb-modal-header-ui", inputs: ["title"], outputs: ["close"] }, { type: i3.ModalBodyComponent, selector: "bb-modal-body-ui" }, { type: i3.ModalFooterComponent, selector: "bb-modal-footer-ui", inputs: ["confirmText", "cancelText"], outputs: ["confirm", "cancel"] }], directives: [{ type: i4.TooltipDirective, selector: "[bbTooltip]", inputs: ["bbTooltip", "triggers"] }, { type: i5.ButtonDirective, selector: "button[bbButton]", inputs: ["type", "color", "buttonSize", "block", "circle"] }, { type: i6.ɵNgNoValidate, selector: "form:not([ngNoForm]):not([ngNativeValidate])" }, { type: i6.NgControlStatusGroup, selector: "[formGroupName],[formArrayName],[ngModelGroup],[formGroup],form:not([ngNoForm]),[ngForm]" }, { type: i6.NgForm, selector: "form:not([ngNoForm]):not([formGroup]),ng-form,[ngForm]", inputs: ["ngFormOptions"], outputs: ["ngSubmit"], exportAs: ["ngForm"] }, { type: i3.CustomModalBodyDirective, selector: "ng-template[bbCustomModalBody]" }, { type: i6.DefaultValueAccessor, selector: "input:not([type=checkbox])[formControlName],textarea[formControlName],input:not([type=checkbox])[formControl],textarea[formControl],input:not([type=checkbox])[ngModel],textarea[ngModel],[ngDefaultControl]" }, { type: i6.NgControlStatus, selector: "[formControlName],[ngModel],[formControl]" }, { type: i6.NgModel, selector: "[ngModel]:not([formControlName]):not([formControl])", inputs: ["name", "disabled", "ngModel", "ngModelOptions"], outputs: ["ngModelChange"], exportAs: ["ngModel"] }, { type: i3.CustomModalFooterDirective, selector: "ng-template[bbCustomModalFooter]" }] });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: RichTextEditorLinkActionComponent, decorators: [{
            type: Component,
            args: [{
                    selector: 'bb-rich-text-editor-link-action',
                    templateUrl: './rich-text-editor-link-action.component.html',
                }]
        }], ctorParameters: function () { return [{ type: i1.RichTextEditorActionsService }, { type: Document, decorators: [{
                    type: Inject,
                    args: [DOCUMENT]
                }] }]; }, propDecorators: { linkAdded: [{
                type: Output
            }], contentClassNames: [{
                type: Input
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmljaC10ZXh0LWVkaXRvci1saW5rLWFjdGlvbi5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9saWJzL3VpLWFuZy9yaWNoLXRleHQtZWRpdG9yL2JiLXJpY2gtdGV4dC1lZGl0b3ItYWN0aW9ucy9yaWNoLXRleHQtZWRpdG9yLWxpbmstYWN0aW9uL3JpY2gtdGV4dC1lZGl0b3ItbGluay1hY3Rpb24uY29tcG9uZW50LnRzIiwiLi4vLi4vLi4vLi4vLi4vLi4vLi4vbGlicy91aS1hbmcvcmljaC10ZXh0LWVkaXRvci9iYi1yaWNoLXRleHQtZWRpdG9yLWFjdGlvbnMvcmljaC10ZXh0LWVkaXRvci1saW5rLWFjdGlvbi9yaWNoLXRleHQtZWRpdG9yLWxpbmstYWN0aW9uLmNvbXBvbmVudC5odG1sIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsWUFBWSxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRS9FLE9BQU8sRUFBRSw4QkFBOEIsRUFBRSxNQUFNLHVDQUF1QyxDQUFDO0FBQ3ZGLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQzs7Ozs7Ozs7QUFFM0M7Ozs7R0FJRztBQU1ILE1BQU0sT0FBTyxpQ0FBa0MsU0FBUSw4QkFBOEI7SUF3Qm5GLFlBQVksRUFBZ0MsRUFBcUMsUUFBa0I7UUFDakcsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBRHFFLGFBQVEsR0FBUixRQUFRLENBQVU7UUF2Qm5HOztXQUVHO1FBQ08sY0FBUyxHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7UUFPekM7O1dBRUc7UUFDSCxnQkFBVyxHQUFHLEtBQUssQ0FBQztRQUVwQjs7V0FFRztRQUNILGlCQUFZLEdBQUcsRUFBRSxDQUFDO0lBT2xCLENBQUM7SUFFRDs7T0FFRztJQUNILFNBQVM7O1FBQ1AsSUFBSSxDQUFD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QUNoRCxPQUFPLENBQUMsWUFBWSxDQUFDLFFBQVEsRUFBRSxRQUFRLENBQUMsQ0FBQztRQUN6QyxPQUFPLENBQUMsU0FBUyxHQUFHLFNBQVMsQ0FBQztRQUU5QixPQUFPLE9BQU8sQ0FBQyxTQUFTLENBQUM7SUFDM0IsQ0FBQztJQUVELElBQVksZUFBZTs7UUFDekIsT0FBTyxDQUNMLENBQUEsTUFBQSxNQUFBLE1BQUEsSUFBSSxDQUFDLEtBQUssMENBQUUsdUJBQXVCLDBDQUFFLGFBQWEsMENBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQzthQUNoRSxNQUFBLE1BQUEsTUFBQyxNQUFBLElBQUksQ0FBQyxLQUFLLDBDQUFFLHVCQUF1QywwQ0FBRSxRQUFRLDBDQUFHLENBQUMsQ0FBQywwQ0FBRSxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUEsQ0FDbEYsQ0FBQztJQUNKLENBQUM7OytIQXpHVSxpQ0FBaUMsOERBd0JVLFFBQVE7bUhBeEJuRCxpQ0FBaUMsdUxDZjlDLHczRUEwRUE7NEZEM0RhLGlDQUFpQztrQkFKN0MsU0FBUzttQkFBQztvQkFDVCxRQUFRLEVBQUUsaUNBQWlDO29CQUMzQyxXQUFXLEVBQUUsK0NBQStDO2lCQUM3RDtxR0F5QjRGLFFBQVE7MEJBQXBELE1BQU07MkJBQUMsUUFBUTs0Q0FwQnBELFNBQVM7c0JBQWxCLE1BQU07Z0JBS0UsaUJBQWlCO3NCQUF6QixLQUFLIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBFdmVudEVtaXR0ZXIsIEluamVjdCwgSW5wdXQsIE91dHB1dCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgUmljaFRleHRFZGl0b3JBY3Rpb25zU2VydmljZSB9IGZyb20gJy4uL3JpY2gtdGV4dC1lZGl0b3ItYWN0aW9ucy5zZXJ2aWNlJztcbmltcG9ydCB7IFJpY2hUZXh0RWRpdG9yQWN0aW9uc0NvbXBvbmVudCB9IGZyb20gJy4uL3JpY2gtdGV4dC1lZGl0b3ItYWN0aW9ucy5jb21wb25lbnQnO1xuaW1wb3J0IHsgRE9DVU1FTlQgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuXG4vKipcbiAqIEBuYW1lIFJpY2hUZXh0RWRpdG9yTGlua0FjdGlvbkNvbXBvbmVudFxuICpcbiAqIEBkeW5hbWljICh0byBzdXBwcmVzcyBlcnJvciB3aXRoIHJlc29sdmluZyBzdGF0aWNzIGRlY2xhcmF0aW9ucyBkdXJpbmcgY29tcGlsYXRpb24pXG4gKi9cblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYmItcmljaC10ZXh0LWVkaXRvci1saW5rLWFjdGlvbicsXG4gIHRlbXBsYXRlVXJsOiAnLi9yaWNoLXRleHQtZWRpdG9yLWxpbmstYWN0aW9uLmNvbXBvbmVudC5odG1sJyxcbn0pXG5leHBvcnQgY2xhc3MgUmljaFRleHRFZGl0b3JMaW5rQWN0aW9uQ29tcG9uZW50IGV4dGVuZHMgUmljaFRleHRFZGl0b3JBY3Rpb25zQ29tcG9uZW50IHtcbiAgLyoqXG4gICAqIEV2ZW50IGVtaXR0ZWQgYWZ0ZXIgbGluayB3YXMgYWRkZWRcbiAgICovXG4gIEBPdXRwdXQoKSBsaW5rQWRkZWQgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG5cbiAgLyoqXG4gICAqIExpc3Qgb2YgY2xhc3NlcyB0byByZWFjaCBvdXQgZWRpdG9yJ3MgY29udGVudFxuICAgKi9cbiAgQElucHV0KCkgY29udGVudENsYXNzTmFtZXMhOiBzdHJpbmdbXTtcblxuICAvKipcbiAgICogRmxhZyB0byBkZXRlcm1pbmUgd2hldGhlciB0aGUgYWRkIGxpbmsgbW9kYWwgaXMgb3BlblxuICAgKi9cbiAgbW9kYWxPcGVuZWQgPSBmYWxzZTtcblxuICAvKipcbiAgICogU2VsZWN0aW9uIGxpbmsgdXJsXG4gICAqL1xuICBzZWxlY3Rpb25VcmwgPSAnJztcblxuICBwcml2YXRlIHNlbGVjdGlvbj86IFNlbGVjdGlvbiB8IG51bGw7XG4gIHByaXZhdGUgcmFuZ2U/OiBSYW5nZTtcblxuICBjb25zdHJ1Y3RvcihtYTogUmljaFRleHRFZGl0b3JBY3Rpb25zU2VydmljZSwgQEluamVjdChET0NVTUVOVCkgcHJpdmF0ZSByZWFkb25seSBkb2N1bWVudDogRG9jdW1lbnQpIHtcbiAgICBzdXBlcihtYSk7XG4gIH1cblxuICAvKipcbiAgICogT3BlbiBhZGQgbGluayBtb2RhbFxuICAgKi9cbiAgb3Blbk1vZGFsKCkge1xuICAgIHRoaXMubW9kYWxPcGVuZWQgPSB0cnVlO1xuICAgIHRoaXMuc2V0U2VsZWN0aW9uRGF0YSgpO1xuICAgIGlmICh0aGlzLnNlbGVjdGlvbj8ucmFuZ2VDb3VudCAmJiB0aGlzLnNlbGVjdGlvbj8ucmFuZ2VDb3VudCA+IDApIHtcbiAgICAgIHRoaXMuc2VsZWN0aW9uVXJsID1cbiAgICAgICAgdGhpcy5saW5rZWRTZWxlY3Rpb24/Lm5vZGVOYW1lID09PSAnQScgJiYgdGhpcy5saW5rZWRTZWxlY3Rpb24/LmhyZWYgIT09ICcnXG4gICAgICAgICAgPyB0aGlzLmxpbmtlZFNlbGVjdGlvbi5ocmVmXG4gICAgICAgICAgOiAnaHR0cDovLyc7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIE9uIGFkZCBsaW5rIG1vZGFsIGNvbmZpcm1hdGlvblxuICAgKi9cbiAgb25SZXN1bHQoKSB7XG4gICAgdGhpcy5yZXN0b3JlU2VsZWN0aW9uKCk7XG4gICAgdGhpcy5zZWxlY3Rpb25VcmwgPSB0aGlzLnNlbGVjdGlvblVybC5yZXBsYWNlKC9cXHMvZywgJycpO1xuICAgIGlmICh0aGlzLnNlbGVjdGlvblVybC5sZW5ndGggPT09IDApIHtcbiAgICAgIHRoaXMuZG9jdW1lbnQuZXhlY0NvbW1hbmQoJ3VubGluaycsIGZhbHNlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5pbnNlcnRMaW5rKCk7XG4gICAgfVxuXG4gICAgdGhpcy5jbG9zZU1vZGFsKCk7XG4gIH1cblxuICAvKipcbiAgICogQ2xvc2UgYWRkIGxpbmsgbW9kYWxcbiAgICovXG4gIGNsb3NlTW9kYWwoKSB7XG4gICAgdGhpcy5tb2RhbE9wZW5lZCA9IGZhbHNlO1xuICAgIHRoaXMubGlua0FkZGVkLmVtaXQoKTtcbiAgfVxuXG4gIHByaXZhdGUgc2V0U2VsZWN0aW9uRGF0YSgpIHtcbiAgICB0aGlzLnNlbGVjdGlvbiA9IHRoaXMuZG9jdW1lbnQuZ2V0U2VsZWN0aW9uKCk7XG4gICAgdGhpcy5yYW5nZSA9IHRoaXMuc2VsZWN0aW9uPy5nZXRSYW5nZUF0KDApO1xuICAgIHRoaXMuc2VsZWN0aW9uVXJsID0gJyc7XG4gIH1cblxuICBwcml2YXRlIHJlc3RvcmVTZWxlY3Rpb24oKSB7XG4gICAgaWYgKHRoaXMucmFuZ2UpIHtcbiAgICAgIHRoaXMuc2VsZWN0aW9uPy5yZW1vdmVBbGxSYW5nZXMoKTtcbiAgICAgIHRoaXMuc2VsZWN0aW9uPy5hZGRSYW5nZSh0aGlzLnJhbmdlKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGluc2VydExpbmsoKSB7XG4gICAgaWYgKCEvXihodHRwOlxcL1xcL3xodHRwczpcXC9cXC8pLy50ZXN0KHRoaXMuc2VsZWN0aW9uVXJsKSkge1xuICAgICAgdGhpcy5zZWxlY3Rpb25VcmwgPSAnaHR0cDovLycgKyB0aGlzLnNlbGVjdGlvblVybDtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5yYW5nZT8udG9TdHJpbmcoKSAhPT0gJycpIHtcbiAgICAgIHRoaXMuZG9jdW1lbnQuZXhlY0NvbW1hbmQoJ2NyZWF0ZUxpbmsnLCBmYWxzZSwgdGhpcy5zZWxlY3Rpb25VcmwpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmRvY3VtZW50LmV4ZWNDb21tYW5kKCdpbnNlcnRIVE1MJywgZmFsc2UsIHRoaXMubGlua0VsZW1lbnQpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZ2V0IGxpbmtFbGVtZW50KCk6IHN0cmluZyB7XG4gICAgY29uc3QgaW5uZXJUZXh0ID0gdGhpcy5zZWxlY3Rpb24/LnRvU3RyaW5nKCkgfHwgdGhpcy5zZWxlY3Rpb25Vcmw7XG4gICAgY29uc3QgZWxlbWVudCA9IHRoaXMuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpO1xuICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKCdocmVmJywgdGhpcy5zZWxlY3Rpb25VcmwpO1xuICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKCd0YXJnZXQnLCAnX2JsYW5rJyk7XG4gICAgZWxlbWVudC5pbm5lckhUTUwgPSBpbm5lclRleHQ7XG5cbiAgICByZXR1cm4gZWxlbWVudC5vdXRlckhUTUw7XG4gIH1cblxuICBwcml2YXRlIGdldCBsaW5rZWRTZWxlY3Rpb24oKTogSFRNTEFuY2hvckVsZW1lbnQgfCBudWxsIHtcbiAgICByZXR1cm4gKFxuICAgICAgdGhpcy5yYW5nZT8uY29tbW9uQW5jZXN0b3JDb250YWluZXI/LnBhcmVudEVsZW1lbnQ/LmNsb3Nlc3QoJ2EnKSB8fFxuICAgICAgKHRoaXMucmFuZ2U/LmNvbW1vbkFuY2VzdG9yQ29udGFpbmVyIGFzIEhUTUxFbGVtZW50KT8uY2hpbGRyZW4/LlswXT8uY2xvc2VzdCgnYScpXG4gICAgKTtcbiAgfVxufVxuIiwiPHNwYW5cbiAgYmJUb29sdGlwPVwiTGlua1wiXG4gIGkxOG4tYmJUb29sdGlwPVwiTGlua3xMaW5rIGFjdGlvbiBAQGJiLXJpY2gtdGV4dC1lZGl0b3ItdWkucmljaC10ZXh0LWVkaXRvci1hY3Rpb25zLmxpbmtcIlxuICBjb250YWluZXI9XCJib2R5XCJcbiAgdHJpZ2dlcnM9XCJob3ZlciBmb2N1c1wiXG4gIFtwbGFjZW1lbnRdPVwiYWN0aW9uc1Rvb2x0aXBQbGFjZW1lbnRcIlxuPlxuICA8YnV0dG9uXG4gICAgYmJCdXR0b25cbiAgICBbY2lyY2xlXT1cInRydWVcIlxuICAgIGNvbG9yPVwibGluay1kYXJrXCJcbiAgICBhcmlhLWxhYmVsPVwiTGlua1wiXG4gICAgaTE4bi1hcmlhLWxhYmVsPVwiQEBiYi1yaWNoLXRleHQtZWRpdG9yLXVpLnJpY2gtdGV4dC1lZGl0b3ItYWN0aW9ucy5saW5rXCJcbiAgICBbZGlzYWJsZWRdPVwiZGlzYWJsZWRcIlxuICAgIChjbGljayk9XCJvcGVuTW9kYWwoKVwiXG4gICAgZGF0YS1yb2xlPVwibGluay1hY3Rpb25cIlxuICA+XG4gICAgPGJiLWljb24tdWkgbmFtZT1cImxpbmtcIj48L2JiLWljb24tdWk+XG4gIDwvYnV0dG9uPlxuPC9zcGFuPlxuXG48YmItbW9kYWwtdWkgW2lzT3Blbl09XCJtb2RhbE9wZW5lZFwiIChjYW5jZWwpPVwiY2xvc2VNb2RhbCgpXCIgKGNvbmZpcm0pPVwib25SZXN1bHQoKVwiPlxuICA8Zm9ybSBkYXRhLXJvbGU9XCJhZGQtbGluay1mb3JtXCI+XG4gICAgPGJiLW1vZGFsLWhlYWRlci11aVxuICAgICAgdGl0bGU9XCJBZGQgbGlua1wiXG4gICAgICBpMThuLXRpdGxlPVwiQWRkIGxpbmt8QWRkIGxpbmsgdGl0bGVAQGJiLXJpY2gtdGV4dC1lZGl0b3ItdWkucmljaC10ZXh0LWVkaXRvci1saW5rLW1vZGFsLnRpdGxlXCJcbiAgICA+PC9iYi1tb2RhbC1oZWFkZXItdWk+XG4gICAgPGJiLW1vZGFsLWJvZHktdWk+XG4gICAgICA8bmctdGVtcGxhdGUgYmJDdXN0b21Nb2RhbEJvZHk+XG4gICAgICAgIDxsYWJlbFxuICAgICAgICAgIGNsYXNzPVwiYmItbGFiZWxcIlxuICAgICAgICAgIGZvcj1cImxpbmstaW5wdXRcIlxuICAgICAgICAgIGkxOG49XCJFbnRlciB0aGUgbGlua3xFbnRlciB0aGUgbGluayB0aXRsZUBAYmItcmljaC10ZXh0LWVkaXRvci11aS5yaWNoLXRleHQtZWRpdG9yLWxpbmstbW9kYWwuaW5wdXQtbGFiZWxcIlxuICAgICAgICA+XG4gICAgICAgICAgRW50ZXIgdGhlIFVSTCBMaW5rXG4gICAgICAgIDwvbGFiZWw+XG4gICAgICAgIDxpbnB1dFxuICAgICAgICAgIHR5cGU9XCJ0ZXh0XCJcbiAgICAgICAgICBjbGFzcz1cImZvcm0tY29udHJvbFwiXG4gICAgICAgICAgWyhuZ01vZGVsKV09XCJzZWxlY3Rpb25VcmxcIlxuICAgICAgICAgIG5hbWU9XCJ1cmxcIlxuICAgICAgICAgIGlkPVwibGluay1pbnB1dFwiXG4gICAgICAgICAgZGF0YS1yb2xlPVwibGluay1pbnB1dFwiXG4gICAgICAgIC8+XG4gICAgICA8L25nLXRlbXBsYXRlPlxuICAgIDwvYmItbW9kYWwtYm9keS11aT5cbiAgICA8YmItbW9kYWwtZm9vdGVyLXVpICNmb290ZXJSZWYgZGF0YS1yb2xlPVwibGluay1tb2RhbC1mb290ZXJcIj5cbiAgICAgIDxuZy10ZW1wbGF0ZSBiYkN1c3RvbU1vZGFsRm9vdGVyPlxuICAgICAgICA8ZGl2IGNsYXNzPVwiYmItYnV0dG9uLWJhclwiPlxuICAgICAgICAgIDxidXR0b25cbiAgICAgICAgICAgIGJiQnV0dG9uXG4gICAgICAgICAgICBjbGFzcz1cImJiLWJ1dHRvbi1iYXJfX2J1dHRvblwiXG4gICAgICAgICAgICAoY2xpY2spPVwib25SZXN1bHQoKVwiXG4gICAgICAgICAgICB0eXBlPVwic3VibWl0XCJcbiAgICAgICAgICAgIGRhdGEtcm9sZT1cInNhdmUtbGlua1wiXG4gICAgICAgICAgICBpMThuPVwiU2F2ZSBhIGxpbmt8U2F2ZSBhIGxpbmsgYnV0dG9uQEBiYi1yaWNoLXRleHQtZWRpdG9yLXVpLnJpY2gtdGV4dC1lZGl0b3ItbGluay1tb2RhbC5zYXZlLWJ1dHRvblwiXG4gICAgICAgICAgPlxuICAgICAgICAgICAgU2F2ZSBMaW5rXG4gICAgICAgICAgPC9idXR0b24+XG4gICAgICAgICAgPGJ1dHRvblxuICAgICAgICAgICAgYmJCdXR0b25cbiAgICAgICAgICAgIGNsYXNzPVwiYmItYnV0dG9uLWJhcl9fYnV0dG9uXCJcbiAgICAgICAgICAgIChjbGljayk9XCJjbG9zZU1vZGFsKClcIlxuICAgICAgICAgICAgY29sb3I9XCJzZWNvbmRhcnlcIlxuICAgICAgICAgICAgZGF0YS1yb2xlPVwiY2FuY2VsLWxpbmstc2F2aW5nXCJcbiAgICAgICAgICAgIGkxOG49XCJDYW5jZWx8Q2FuY2VsIGJ1dHRvbkBAYmItcmljaC10ZXh0LWVkaXRvci11aS5yaWNoLXRleHQtZWRpdG9yLWxpbmstbW9kYWwuY2FuY2VsLWJ1dHRvblwiXG4gICAgICAgICAgPlxuICAgICAgICAgICAgQ2FuY2VsXG4gICAgICAgICAgPC9idXR0b24+XG4gICAgICAgIDwvZGl2PlxuICAgICAgPC9uZy10ZW1wbGF0ZT5cbiAgICA8L2JiLW1vZGFsLWZvb3Rlci11aT5cbiAgPC9mb3JtPlxuPC9iYi1tb2RhbC11aT5cbiJdfQ==