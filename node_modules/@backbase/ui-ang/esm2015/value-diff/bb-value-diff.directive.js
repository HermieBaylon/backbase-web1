import { Directive, Input } from '@angular/core';
import { Subject } from 'rxjs';
import { filter, startWith, takeUntil } from 'rxjs/operators';
import { crossOutValueClass, ValueDiffPosition, highlightValueClass, srTextForNewVal, srTextForOldVal, valueDiffArrowRightClass, valueDiffArrowLeftClass, } from './bb-value-diff.model';
import * as i0 from "@angular/core";
export class ValueDiffDirective {
    constructor(elRef, renderer, cdRef) {
        this.elRef = elRef;
        this.renderer = renderer;
        this.cdRef = cdRef;
        this.destroyed$ = new Subject();
        this.valueChanged$ = new Subject();
        this.SROnlyOldEl = this.createA11ySpan(srTextForOldVal);
        this.SROnlyNewEl = this.createA11ySpan(srTextForNewVal);
        this._newValue = '';
        this._position = ValueDiffPosition.BEFORE;
        /**
         * Show arrow between old and new value
         * Default value: false
         */
        this.showArrow = false;
    }
    /**
     * New data with which we will compare content.
     */
    set newValue(value) {
        this._newValue = value;
        this.onValueChanged(value);
    }
    get newValue() {
        return this._newValue;
    }
    /**
     * A position where differences will be added.
     * Default value: 'before'
     */
    set position(val) {
        this._position = val;
        this.onValueChanged(this._newValue);
    }
    get position() {
        return this._position;
    }
    /**
     * Text for screen reader to describe old value
     * Default value: 'Previous value:'
     */
    set SROnlyOld(val) {
        this.renderer.setProperty(this.SROnlyOldEl, 'textContent', val);
    }
    /**
     * Text for screen reader to describe new value
     * Default value: 'Current value:'
     */
    set SROnlyNew(val) {
        this.renderer.setProperty(this.SROnlyNewEl, 'textContent', val);
    }
    static isEqual(newData, initialEl) {
        return initialEl.innerText.trim() === newData;
    }
    get isPositionBefore() {
        return this._position === ValueDiffPosition.BEFORE;
    }
    get parentEl() {
        return this.elRef.nativeElement.parentElement;
    }
    ngAfterContentInit() {
        const changedEl = this.elRef.nativeElement.cloneNode(true);
        this.valueChanged$
            .pipe(startWith({ newData: this._newValue, elRef: this.elRef }), filter(({ newData }) => !ValueDiffDirective.isEqual(newData, this.elRef.nativeElement)), takeUntil(this.destroyed$))
            .subscribe(({ newData }) => {
            this.cdRef.detectChanges();
            this.renderer.setProperty(changedEl, 'textContent', newData);
            this.setupContainer(changedEl);
        });
    }
    ngOnDestroy() {
        this.destroyed$.next();
    }
    setupContainer(changedEl) {
        const { nativeElement } = this.elRef;
        if (ValueDiffDirective.isEqual(changedEl.innerText, nativeElement)) {
            this.cleanUpContent(changedEl);
        }
        else {
            this.renderer.addClass(changedEl, highlightValueClass);
            this.renderer.addClass(nativeElement, crossOutValueClass);
            this.renderer.insertBefore(this.parentEl, changedEl, this.getSiblingEl());
            this.renderer.insertBefore(this.parentEl, this.SROnlyNewEl, changedEl);
            if (this.showArrow) {
                this.addElWithArrow();
            }
            this.renderer.insertBefore(this.parentEl, this.SROnlyOldEl, nativeElement);
        }
    }
    cleanUpContent(changedEl) {
        this.renderer.removeClass(changedEl, highlightValueClass);
        this.renderer.removeClass(this.elRef.nativeElement, crossOutValueClass);
        this.renderer.removeChild(this.parentEl, changedEl);
        this.renderer.removeChild(this.parentEl, this.SROnlyOldEl);
        this.renderer.removeChild(this.parentEl, this.SROnlyNewEl);
        if (this.arrow) {
            this.renderer.removeChild(this.parentEl, this.arrow);
        }
    }
    createA11ySpan(content) {
        const SROnlySpan = this.renderer.createElement('span');
        this.renderer.addClass(SROnlySpan, 'sr-only');
        this.renderer.setProperty(SROnlySpan, 'textContent', content);
        return SROnlySpan;
    }
    addElWithArrow() {
        if (!this.arrow) {
            const iconClass = this.isPositionBefore ? valueDiffArrowLeftClass : valueDiffArrowRightClass;
            this.arrow = this.renderer.createElement('i');
            this.renderer.addClass(this.arrow, iconClass);
        }
        this.renderer.insertBefore(this.parentEl, this.arrow, this.getSiblingEl());
    }
    getSiblingEl() {
        return this.isPositionBefore ? this.elRef.nativeElement : this.elRef.nativeElement.nextElementSibling;
    }
    onValueChanged(newData) {
        this.valueChanged$.next({ newData });
    }
}
ValueDiffDirective.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: ValueDiffDirective, deps: [{ token: i0.ElementRef }, { token: i0.Renderer2 }, { token: i0.ChangeDetectorRef }], target: i0.ɵɵFactoryTarget.Directive });
ValueDiffDirective.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "12.0.0", version: "12.2.16", type: ValueDiffDirective, selector: "[bbValueDiff]", inputs: { newValue: ["bbValueDiff", "newValue"], position: "position", SROnlyOld: ["sr-only-old", "SROnlyOld"], SROnlyNew: ["sr-only-new", "SROnlyNew"], showArrow: "showArrow" }, ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: ValueDiffDirective, decorators: [{
            type: Directive,
            args: [{
                    selector: '[bbValueDiff]',
                }]
        }], ctorParameters: function () { return [{ type: i0.ElementRef }, { type: i0.Renderer2 }, { type: i0.ChangeDetectorRef }]; }, propDecorators: { newValue: [{
                type: Input,
                args: ['bbValueDiff']
            }], position: [{
                type: Input
            }], SROnlyOld: [{
                type: Input,
                args: ['sr-only-old']
            }], SROnlyNew: [{
                type: Input,
                args: ['sr-only-new']
            }], showArrow: [{
                type: Input
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmItdmFsdWUtZGlmZi5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9saWJzL3VpLWFuZy92YWx1ZS1kaWZmL2JiLXZhbHVlLWRpZmYuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBdUMsU0FBUyxFQUFjLEtBQUssRUFBd0IsTUFBTSxlQUFlLENBQUM7QUFDeEgsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMvQixPQUFPLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUM5RCxPQUFPLEVBQ0wsa0JBQWtCLEVBRWxCLGlCQUFpQixFQUNqQixtQkFBbUIsRUFDbkIsZUFBZSxFQUNmLGVBQWUsRUFDZix3QkFBd0IsRUFDeEIsdUJBQXVCLEdBQ3hCLE1BQU0sdUJBQXVCLENBQUM7O0FBSy9CLE1BQU0sT0FBTyxrQkFBa0I7SUEwRTdCLFlBQ21CLEtBQWlCLEVBQ2pCLFFBQW1CLEVBQ25CLEtBQXdCO1FBRnhCLFVBQUssR0FBTCxLQUFLLENBQVk7UUFDakIsYUFBUSxHQUFSLFFBQVEsQ0FBVztRQUNuQixVQUFLLEdBQUwsS0FBSyxDQUFtQjtRQTVFMUIsZUFBVSxHQUFHLElBQUksT0FBTyxFQUFRLENBQUM7UUFDakMsa0JBQWEsR0FBRyxJQUFJLE9BQU8sRUFBeUIsQ0FBQztRQUVyRCxnQkFBVyxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsZUFBZSxDQUFDLENBQUM7UUFDbkQsZ0JBQVcsR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLGVBQWUsQ0FBQyxDQUFDO1FBRTVELGNBQVMsR0FBRyxFQUFFLENBQUM7UUFDZixjQUFTLEdBQUcsaUJBQWlCLENBQUMsTUFBTSxDQUFDO1FBZ0Q3Qzs7O1dBR0c7UUFDTSxjQUFTLEdBQUcsS0FBSyxDQUFDO0lBa0J4QixDQUFDO0lBbkVKOztPQUVHO0lBQ0gsSUFD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TyxFQUFFLENBQUMsQ0FBQztJQUN2QyxDQUFDOztnSEE3SlUsa0JBQWtCO29HQUFsQixrQkFBa0I7NEZBQWxCLGtCQUFrQjtrQkFIOUIsU0FBUzttQkFBQztvQkFDVCxRQUFRLEVBQUUsZUFBZTtpQkFDMUI7eUpBZ0JLLFFBQVE7c0JBRFgsS0FBSzt1QkFBQyxhQUFhO2dCQWVoQixRQUFRO3NCQURYLEtBQUs7Z0JBZUYsU0FBUztzQkFEWixLQUFLO3VCQUFDLGFBQWE7Z0JBVWhCLFNBQVM7c0JBRFosS0FBSzt1QkFBQyxhQUFhO2dCQVNYLFNBQVM7c0JBQWpCLEtBQUsiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBZnRlckNvbnRlbnRJbml0LCBDaGFuZ2VEZXRlY3RvclJlZiwgRGlyZWN0aXZlLCBFbGVtZW50UmVmLCBJbnB1dCwgT25EZXN0cm95LCBSZW5kZXJlcjIgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGZpbHRlciwgc3RhcnRXaXRoLCB0YWtlVW50aWwgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQge1xuICBjcm9zc091dFZhbHVlQ2xhc3MsXG4gIFZhbHVlRGlmZkNoYW5nZWRNb2RlbCxcbiAgVmFsdWVEaWZmUG9zaXRpb24sXG4gIGhpZ2hsaWdodFZhbHVlQ2xhc3MsXG4gIHNyVGV4dEZvck5ld1ZhbCxcbiAgc3JUZXh0Rm9yT2xkVmFsLFxuICB2YWx1ZURpZmZBcnJvd1JpZ2h0Q2xhc3MsXG4gIHZhbHVlRGlmZkFycm93TGVmdENsYXNzLFxufSBmcm9tICcuL2JiLXZhbHVlLWRpZmYubW9kZWwnO1xuXG5ARGlyZWN0aXZlKHtcbiAgc2VsZWN0b3I6ICdbYmJWYWx1ZURpZmZdJyxcbn0pXG5leHBvcnQgY2xhc3MgVmFsdWVEaWZmRGlyZWN0aXZlIGltcGxlbWVudHMgQWZ0ZXJDb250ZW50SW5pdCwgT25EZXN0cm95IHtcbiAgcHJpdmF0ZSByZWFkb25seSBkZXN0cm95ZWQkID0gbmV3IFN1YmplY3Q8dm9pZD4oKTtcbiAgcHJpdmF0ZSByZWFkb25seSB2YWx1ZUNoYW5nZWQkID0gbmV3IFN1YmplY3Q8VmFsdWVEaWZmQ2hhbmdlZE1vZGVsPigpO1xuXG4gIHByaXZhdGUgcmVhZG9ubHkgU1JPbmx5T2xkRWwgPSB0aGlzLmNyZWF0ZUExMXlTcGFuKHNyVGV4dEZvck9sZFZhbCk7XG4gIHByaXZhdGUgcmVhZG9ubHkgU1JPbmx5TmV3RWwgPSB0aGlzLmNyZWF0ZUExMXlTcGFuKHNyVGV4dEZvck5ld1ZhbCk7XG5cbiAgcHJpdmF0ZSBfbmV3VmFsdWUgPSAnJztcbiAgcHJpdmF0ZSBfcG9zaXRpb24gPSBWYWx1ZURpZmZQb3NpdGlvbi5CRUZPUkU7XG4gIHByaXZhdGUgYXJyb3c6IEhUTUxFbGVtZW50IHwgdW5kZWZpbmVkO1xuXG4gIC8qKlxuICAgKiBOZXcgZGF0YSB3aXRoIHdoaWNoIHdlIHdpbGwgY29tcGFyZSBjb250ZW50LlxuICAgKi9cbiAgQElucHV0KCdiYlZhbHVlRGlmZicpXG4gIHNldCBuZXdWYWx1ZSh2YWx1ZTogc3RyaW5nKSB7XG4gICAgdGhpcy5fbmV3VmFsdWUgPSB2YWx1ZTtcbiAgICB0aGlzLm9uVmFsdWVDaGFuZ2VkKHZhbHVlKTtcbiAgfVxuXG4gIGdldCBuZXdWYWx1ZSgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLl9uZXdWYWx1ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBIHBvc2l0aW9uIHdoZXJlIGRpZmZlcmVuY2VzIHdpbGwgYmUgYWRkZWQuXG4gICAqIERlZmF1bHQgdmFsdWU6ICdiZWZvcmUnXG4gICAqL1xuICBASW5wdXQoKVxuICBzZXQgcG9zaXRpb24odmFsOiBWYWx1ZURpZmZQb3NpdGlvbikge1xuICAgIHRoaXMuX3Bvc2l0aW9uID0gdmFsO1xuICAgIHRoaXMub25WYWx1ZUNoYW5nZWQodGhpcy5fbmV3VmFsdWUpO1xuICB9XG5cbiAgZ2V0IHBvc2l0aW9uKCk6IFZhbHVlRGlmZlBvc2l0aW9uIHtcbiAgICByZXR1cm4gdGhpcy5fcG9zaXRpb247XG4gIH1cblxuICAvKipcbiAgICogVGV4dCBmb3Igc2NyZWVuIHJlYWRlciB0byBkZXNjcmliZSBvbGQgdmFsdWVcbiAgICogRGVmYXVsdCB2YWx1ZTogJ1ByZXZpb3VzIHZhbHVlOidcbiAgICovXG4gIEBJbnB1dCgnc3Itb25seS1vbGQnKVxuICBzZXQgU1JPbmx5T2xkKHZhbDogc3RyaW5nKSB7XG4gICAgdGhpcy5yZW5kZXJlci5zZXRQcm9wZXJ0eSh0aGlzLlNST25seU9sZEVsLCAndGV4dENvbnRlbnQnLCB2YWwpO1xuICB9XG5cbiAgLyoqXG4gICAqIFRleHQgZm9yIHNjcmVlbiByZWFkZXIgdG8gZGVzY3JpYmUgbmV3IHZhbHVlXG4gICAqIERlZmF1bHQgdmFsdWU6ICdDdXJyZW50IHZhbHVlOidcbiAgICovXG4gIEBJbnB1dCgnc3Itb25seS1uZXcnKVxuICBzZXQgU1JPbmx5TmV3KHZhbDogc3RyaW5nKSB7XG4gICAgdGhpcy5yZW5kZXJlci5zZXRQcm9wZXJ0eSh0aGlzLlNST25seU5ld0VsLCAndGV4dENvbnRlbnQnLCB2YWwpO1xuICB9XG5cbiAgLyoqXG4gICAqIFNob3cgYXJyb3cgYmV0d2VlbiBvbGQgYW5kIG5ldyB2YWx1ZVxuICAgKiBEZWZhdWx0IHZhbHVlOiBmYWxzZVxuICAgKi9cbiAgQElucHV0KCkgc2hvd0Fycm93ID0gZmFsc2U7XG5cbiAgcHJpdmF0ZSBzdGF0aWMgaXNFcXVhbChuZXdEYXRhOiBzdHJpbmcsIGluaXRpYWxFbDogSFRNTEVsZW1lbnQpOiBib29sZWFuIHtcbiAgICByZXR1cm4gaW5pdGlhbEVsLmlubmVyVGV4dC50cmltKCkgPT09IG5ld0RhdGE7XG4gIH1cblxuICBwcml2YXRlIGdldCBpc1Bvc2l0aW9uQmVmb3JlKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLl9wb3NpdGlvbiA9PT0gVmFsdWVEaWZmUG9zaXRpb24uQkVGT1JFO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXQgcGFyZW50RWwoKTogSFRNTEVsZW1lbnQge1xuICAgIHJldHVybiB0aGlzLmVsUmVmLm5hdGl2ZUVsZW1lbnQucGFyZW50RWxlbWVudDtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgZWxSZWY6IEVsZW1lbnRSZWYsXG4gICAgcHJpdmF0ZSByZWFkb25seSByZW5kZXJlcjogUmVuZGVyZXIyLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgY2RSZWY6IENoYW5nZURldGVjdG9yUmVmLFxuICApIHt9XG5cbiAgbmdBZnRlckNvbnRlbnRJbml0KCkge1xuICAgIGNvbnN0IGNoYW5nZWRFbCA9IHRoaXMuZWxSZWYubmF0aXZlRWxlbWVudC5jbG9uZU5vZGUodHJ1ZSk7XG5cbiAgICB0aGlzLnZhbHVlQ2hhbmdlZCRcbiAgICAgIC5waXBlKFxuICAgICAgICBzdGFydFdpdGgoeyBuZXdEYXRhOiB0aGlzLl9uZXdWYWx1ZSwgZWxSZWY6IHRoaXMuZWxSZWYgfSksXG4gICAgICAgIGZpbHRlcigoeyBuZXdEYXRhIH06IFZhbHVlRGlmZkNoYW5nZWRNb2RlbCkgPT4gIVZhbHVlRGlmZkRpcmVjdGl2ZS5pc0VxdWFsKG5ld0RhdGEsIHRoaXMuZWxSZWYubmF0aXZlRWxlbWVudCkpLFxuICAgICAgICB0YWtlVW50aWwodGhpcy5kZXN0cm95ZWQkKSxcbiAgICAgIClcbiAgICAgIC5zdWJzY3JpYmUoKHsgbmV3RGF0YSB9OiBWYWx1ZURpZmZDaGFuZ2VkTW9kZWwpID0+IHtcbiAgICAgICAgdGhpcy5jZFJlZi5kZXRlY3RDaGFuZ2VzKCk7XG4gICAgICAgIHRoaXMucmVuZGVyZXIuc2V0UHJvcGVydHkoY2hhbmdlZEVsLCAndGV4dENvbnRlbnQnLCBuZXdEYXRhKTtcbiAgICAgICAgdGhpcy5zZXR1cENvbnRhaW5lcihjaGFuZ2VkRWwpO1xuICAgICAgfSk7XG4gIH1cblxuICBuZ09uRGVzdHJveSgpIHtcbiAgICB0aGlzLmRlc3Ryb3llZCQubmV4dCgpO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXR1cENvbnRhaW5lcihjaGFuZ2VkRWw6IEhUTUxFbGVtZW50KSB7XG4gICAgY29uc3QgeyBuYXRpdmVFbGVtZW50IH0gPSB0aGlzLmVsUmVmO1xuXG4gICAgaWYgKFZhbHVlRGlmZkRpcmVjdGl2ZS5pc0VxdWFsKGNoYW5nZWRFbC5pbm5lclRleHQsIG5hdGl2ZUVsZW1lbnQpKSB7XG4gICAgICB0aGlzLmNsZWFuVXBDb250ZW50KGNoYW5nZWRFbCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMucmVuZGVyZXIuYWRkQ2xhc3MoY2hhbmdlZEVsLCBoaWdobGlnaHRWYWx1ZUNsYXNzKTtcbiAgICAgIHRoaXMucmVuZGVyZXIuYWRkQ2xhc3MobmF0aXZlRWxlbWVudCwgY3Jvc3NPdXRWYWx1ZUNsYXNzKTtcblxuICAgICAgdGhpcy5yZW5kZXJlci5pbnNlcnRCZWZvcmUodGhpcy5wYXJlbnRFbCwgY2hhbmdlZEVsLCB0aGlzLmdldFNpYmxpbmdFbCgpKTtcbiAgICAgIHRoaXMucmVuZGVyZXIuaW5zZXJ0QmVmb3JlKHRoaXMucGFyZW50RWwsIHRoaXMuU1JPbmx5TmV3RWwsIGNoYW5nZWRFbCk7XG5cbiAgICAgIGlmICh0aGlzLnNob3dBcnJvdykge1xuICAgICAgICB0aGlzLmFkZEVsV2l0aEFycm93KCk7XG4gICAgICB9XG5cbiAgICAgIHRoaXMucmVuZGVyZXIuaW5zZXJ0QmVmb3JlKHRoaXMucGFyZW50RWwsIHRoaXMuU1JPbmx5T2xkRWwsIG5hdGl2ZUVsZW1lbnQpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgY2xlYW5VcENvbnRlbnQoY2hhbmdlZEVsOiBIVE1MRWxlbWVudCkge1xuICAgIHRoaXMucmVuZGVyZXIucmVtb3ZlQ2xhc3MoY2hhbmdlZEVsLCBoaWdobGlnaHRWYWx1ZUNsYXNzKTtcbiAgICB0aGlzLnJlbmRlcmVyLnJlbW92ZUNsYXNzKHRoaXMuZWxSZWYubmF0aXZlRWxlbWVudCwgY3Jvc3NPdXRWYWx1ZUNsYXNzKTtcbiAgICB0aGlzLnJlbmRlcmVyLnJlbW92ZUNoaWxkKHRoaXMucGFyZW50RWwsIGNoYW5nZWRFbCk7XG4gICAgdGhpcy5yZW5kZXJlci5yZW1vdmVDaGlsZCh0aGlzLnBhcmVudEVsLCB0aGlzLlNST25seU9sZEVsKTtcbiAgICB0aGlzLnJlbmRlcmVyLnJlbW92ZUNoaWxkKHRoaXMucGFyZW50RWwsIHRoaXMuU1JPbmx5TmV3RWwpO1xuXG4gICAgaWYgKHRoaXMuYXJyb3cpIHtcbiAgICAgIHRoaXMucmVuZGVyZXIucmVtb3ZlQ2hpbGQodGhpcy5wYXJlbnRFbCwgdGhpcy5hcnJvdyk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVBMTF5U3Bhbihjb250ZW50OiBzdHJpbmcpOiBIVE1MRWxlbWVudCB7XG4gICAgY29uc3QgU1JPbmx5U3BhbiA9IHRoaXMucmVuZGVyZXIuY3JlYXRlRWxlbWVudCgnc3BhbicpO1xuICAgIHRoaXMucmVuZGVyZXIuYWRkQ2xhc3MoU1JPbmx5U3BhbiwgJ3NyLW9ubHknKTtcbiAgICB0aGlzLnJlbmRlcmVyLnNldFByb3BlcnR5KFNST25seVNwYW4sICd0ZXh0Q29udGVudCcsIGNvbnRlbnQpO1xuXG4gICAgcmV0dXJuIFNST25seVNwYW47XG4gIH1cblxuICBwcml2YXRlIGFkZEVsV2l0aEFycm93KCkge1xuICAgIGlmICghdGhpcy5hcnJvdykge1xuICAgICAgY29uc3QgaWNvbkNsYXNzID0gdGhpcy5pc1Bvc2l0aW9uQmVmb3JlID8gdmFsdWVEaWZmQXJyb3dMZWZ0Q2xhc3MgOiB2YWx1ZURpZmZBcnJvd1JpZ2h0Q2xhc3M7XG5cbiAgICAgIHRoaXMuYXJyb3cgPSB0aGlzLnJlbmRlcmVyLmNyZWF0ZUVsZW1lbnQoJ2knKTtcbiAgICAgIHRoaXMucmVuZGVyZXIuYWRkQ2xhc3ModGhpcy5hcnJvdywgaWNvbkNsYXNzKTtcbiAgICB9XG5cbiAgICB0aGlzLnJlbmRlcmVyLmluc2VydEJlZm9yZSh0aGlzLnBhcmVudEVsLCB0aGlzLmFycm93LCB0aGlzLmdldFNpYmxpbmdFbCgpKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0U2libGluZ0VsKCk6IEhUTUxFbGVtZW50IHtcbiAgICByZXR1cm4gdGhpcy5pc1Bvc2l0aW9uQmVmb3JlID8gdGhpcy5lbFJlZi5uYXRpdmVFbGVtZW50IDogdGhpcy5lbFJlZi5uYXRpdmVFbGVtZW50Lm5leHRFbGVtZW50U2libGluZztcbiAgfVxuXG4gIHByaXZhdGUgb25WYWx1ZUNoYW5nZWQobmV3RGF0YTogc3RyaW5nKSB7XG4gICAgdGhpcy52YWx1ZUNoYW5nZWQkLm5leHQoeyBuZXdEYXRhIH0pO1xuICB9XG59XG4iXX0=