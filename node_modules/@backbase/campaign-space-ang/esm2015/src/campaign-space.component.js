import { Component, Input, ViewChild, Optional, Inject, } from '@angular/core';
import { BehaviorSubject, Subject } from 'rxjs';
import { CampaignService } from './services/campaign.service';
import { TargetAttribute } from './types';
import { delay, filter, takeUntil, tap } from 'rxjs/operators';
import { ENGAGEMENT_BASE_PATH } from '@backbase/data-ang/engagement';
import * as i0 from "@angular/core";
import * as i1 from "./services/campaign.service";
import * as i2 from "@angular/common";
export class CampaignSpaceComponent {
    constructor(campaignService, renderer, cdr, basePath) {
        this.campaignService = campaignService;
        this.renderer = renderer;
        this.cdr = cdr;
        this.basePath = basePath;
        /**
         * Component name
         */
        this.name = '';
        /**
         * Campaign banner dimensions
         */
        this.dimensions = '300x250';
        /**
         * Page name
         */
        this.pageName = 'index';
        /**
         * Is banner responsive
         */
        this.responsive = false;
        /**
         * Banner title
         */
        this.title = 'Campaign Space';
        this.designMode = this.campaignService.designMode;
        this.placeholderTitle = '';
        this.iframeContext = new BehaviorSubject(undefined);
        this.destroy$ = new Subject();
    }
    ngOnInit() {
        this.widgetStyles = this.getWidgetStyles();
        if (this.designMode) {
            this.initDesignMode();
        }
        else {
            this.initLiveMode();
        }
    }
    ngOnDestroy() {
        this.destroy$.next();
    }
    initDesignMode() {
        this.placeholderTitle = this.getPlaceholderTitle();
    }
    initLiveMode() {
        this.campaignService.selectCampaign(this.name, this.dimensions, this.pageName).subscribe(campaign => {
            if (campaign) {
                this.campaign = campaign;
                this.setTargetUrl();
                this.content = this.campaignService.b64Decode(campaign.creative.content);
                this.iframeContext.next(this.content);
                this.targetMode = TargetAttribute[campaign.targetUrlDisplayMode || 'self'];
                this.cdr.detectChanges();
            }
        });
    }
    setTargetUrl() {
        var _a, _b;
        const basePath = this.basePath.endsWith('/') ? this.basePath.slice(0, -1) : this.basePath;
        const campaignUrl = ((_a = this.campaign) === null || _a === void 0 ? void 0 : _a.targetUrl.startsWith('/'))
            ? this.campaign.targetUrl.slice(1)
            : (_b = this.campaign) === null || _b === void 0 ? void 0 : _b.targetUrl;
        this.targetUrl = `${basePath}/${campaignUrl}`;
    }
    iframeLoad() {
        this.cdr.detectChanges();
        const iframeElement = this.iframeRef.nativeElement;
        const iframeBody = iframeElement.contentDocument.body;
        this.renderer.setStyle(iframeElement, 'width', '100%');
        this.renderer.setStyle(iframeElement, 'border', '0');
        this.renderer.setStyle(iframeBody, 'margin', '0');
        this.iframeContext
            .pipe(filter(Boolean), tap(content => this.renderer.setProperty(iframeBody, 'innerHTML', content)), delay(300), takeUntil(this.destroy$))
            .subscribe(() => {
            let currentHeight = iframeBody.scrollHeight;
            let previousHeight = 0;
            let counter = 0;
            do {
                this.renderer.setStyle(iframeElement, 'height', `${currentHeight}px`);
                previousHeight = currentHeight;
                currentHeight = iframeBody.scrollHeight;
                counter++;
            } while (previousHeight !== currentHeight && counter < 5);
            this.cdr.detectChanges();
        });
    }
    getWidgetStyles() {
        const [width, height] = this.getDimensions(this.dimensions);
        const properties = {
            width: this.responsive ? '100%' : this.toPx(width),
            height: this.toPx(height),
        };
        if (this.responsive) {
            properties.maxWidth = this.toPx(width);
        }
        return properties;
    }
    getPlaceholderTitle() {
        const [width, height] = this.getDimensions(this.dimensions);
        let placeholderTitle = `${this.title} - ${this.dimensions}`;
        if (this.responsive) {
            placeholderTitle = `${this.title} - Responsive Max-width: ${width}, Height: ${height}`;
        }
        return placeholderTitle;
    }
    toPx(value) {
        return value + 'px';
    }
    getDimensions(dimensions) {
        return dimensions.split('x');
    }
}
CampaignSpaceComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: CampaignSpaceComponent, deps: [{ token: i1.CampaignService }, { token: i0.Renderer2 }, { token: i0.ChangeDetectorRef }, { token: ENGAGEMENT_BASE_PATH, optional: true }], target: i0.ɵɵFactoryTarget.Component });
CampaignSpaceComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "12.0.0", version: "12.2.16", type: CampaignSpaceComponent, selector: "bb-campaign-space-ang", inputs: { name: "name", dimensions: "dimensions", pageName: "pageName", responsive: "responsive", title: "title" }, providers: [CampaignService], viewQueries: [{ propertyName: "iframeRef", first: true, predicate: ["iframeRef"], descendants: true }], ngImport: i0, template: "<ng-container *ngIf=\"widgetStyles\">\n  <div *ngIf=\"!designMode && campaign\" class=\"bb-campaign-space-widget\" [ngStyle]=\"widgetStyles\">\n    <a [href]=\"targetUrl\" [ngStyle]=\"widgetStyles\" [target]=\"targetMode\" class=\"bb-campaign-space-widget__overlay\"> </a>\n    <iframe #iframeRef class=\"bb-campaign-space-widget__iframe\" [ngStyle]=\"widgetStyles\" (load)=\"iframeLoad()\">\n    </iframe>\n  </div>\n  <div *ngIf=\"designMode\" [ngStyle]=\"widgetStyles\" class=\"bb-campaign-space-widget\">\n    <div [ngStyle]=\"widgetStyles\" class=\"bb-campaign-space-widget__placeholder\">\n      <span>{{ placeholderTitle }}</span>\n    </div>\n  </div>\n</ng-container>\n", styles: [":host{position:relative}.bb-campaign-space-widget{position:relative;left:50%;transform:translate(-50%)}.bb-campaign-space-widget__overlay{position:absolute;top:0;left:0;right:0;bottom:0;z-index:1}.bb-campaign-space-widget__iframe{position:absolute;top:0;left:0;right:0;bottom:0;z-index:0}.bb-campaign-space-widget__placeholder{display:flex;justify-content:center;align-items:center;position:relative;background-color:#0000001a;border:1px solid #bfbfbf;text-align:center}\n"], directives: [{ type: i2.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { type: i2.NgStyle, selector: "[ngStyle]", inputs: ["ngStyle"] }] });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: CampaignSpaceComponent, decorators: [{
            type: Component,
            args: [{
                    selector: 'bb-campaign-space-ang',
                    templateUrl: './campaign-space.component.html',
                    styleUrls: ['./campaign-space.component.css'],
                    providers: [CampaignService],
                }]
        }], ctorParameters: function () { return [{ type: i1.CampaignService }, { type: i0.Renderer2 }, { type: i0.ChangeDetectorRef }, { type: undefined, decorators: [{
                    type: Optional
                }, {
                    type: Inject,
                    args: [ENGAGEMENT_BASE_PATH]
                }] }]; }, propDecorators: { name: [{
                type: Input
            }], dimensions: [{
                type: Input
            }], pageName: [{
                type: Input
            }], responsive: [{
                type: Input
            }], title: [{
                type: Input
            }], iframeRef: [{
                type: ViewChild,
                args: ['iframeRef', { static: false }]
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FtcGFpZ24tc3BhY2UuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vbGlicy9jYW1wYWlnbi1zcGFjZS1hbmcvc3JjL2NhbXBhaWduLXNwYWNlLmNvbXBvbmVudC50cyIsIi4uLy4uLy4uLy4uLy4uL2xpYnMvY2FtcGFpZ24tc3BhY2UtYW5nL3NyYy9jYW1wYWlnbi1zcGFjZS5jb21wb25lbnQuaHRtbCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBRUwsU0FBUyxFQUVULEtBQUssRUFJTCxTQUFTLEVBQ1QsUUFBUSxFQUNSLE1BQU0sR0FDUCxNQUFNLGVBQWUsQ0FBQztBQUV2QixPQUFPLEVBQUUsZUFBZSxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNoRCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFDOUQsT0FBTyxFQUFFLGVBQWUsRUFBZ0IsTUFBTSxTQUFTLENBQUM7QUFDeEQsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQy9ELE9BQU8sRUFBNEIsb0JBQW9CLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQzs7OztBQVEvRixNQUFNLE9BQU8sc0JBQXNCO0lBK0NqQyxZQUNVLGVBQWdDLEVBQ3ZCLFFBQW1CLEVBQzVCLEdBQXNCLEVBQzZCLFFBQWdCO1FBSG5FLG9CQUFlLEdBQWYsZUFBZSxDQUFpQjtRQUN2QixhQUFRLEdBQVIsUUFBUSxDQUFXO1FBQzVCLFFBQUcsR0FBSCxHQUFHLENBQW1CO1FBQzZCLGFBQVEsR0FBUixRQUFRLENBQVE7UUFsRDdFOztXQUVHO1FBQ00sU0FBSSxHQUFHLEVBQUUsQ0FBQztRQUVuQjs7V0FFRztRQUNNLGVBQVUsR0FBRyxTQUFTLENBQUM7UUFFaEM7O1dBRUc7UUFDTSxhQUFRLEdBQUcsT0FBTyxDQUFDO1FBRTVCOztXQUVHO1FBQ00s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ZUFBZSxDQUFDO2lCQUM3Qjs7MEJBb0RJLFFBQVE7OzBCQUFJLE1BQU07MkJBQUMsb0JBQW9COzRDQS9DakMsSUFBSTtzQkFBWixLQUFLO2dCQUtHLFVBQVU7c0JBQWxCLEtBQUs7Z0JBS0csUUFBUTtzQkFBaEIsS0FBSztnQkFLRyxVQUFVO3NCQUFsQixLQUFLO2dCQUtHLEtBQUs7c0JBQWIsS0FBSztnQkFxQnFDLFNBQVM7c0JBQW5ELFNBQVM7dUJBQUMsV0FBVyxFQUFFLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENoYW5nZURldGVjdG9yUmVmLFxuICBDb21wb25lbnQsXG4gIEVsZW1lbnRSZWYsXG4gIElucHV0LFxuICBPbkRlc3Ryb3ksXG4gIE9uSW5pdCxcbiAgUmVuZGVyZXIyLFxuICBWaWV3Q2hpbGQsXG4gIE9wdGlvbmFsLFxuICBJbmplY3QsXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgU2FmZVJlc291cmNlVXJsIH0gZnJvbSAnQGFuZ3VsYXIvcGxhdGZvcm0tYnJvd3Nlcic7XG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IENhbXBhaWduU2VydmljZSB9IGZyb20gJy4vc2VydmljZXMvY2FtcGFpZ24uc2VydmljZSc7XG5pbXBvcnQgeyBUYXJnZXRBdHRyaWJ1dGUsIFdpZGdldFN0eWxlcyB9IGZyb20gJy4vdHlwZXMnO1xuaW1wb3J0IHsgZGVsYXksIGZpbHRlciwgdGFrZVVudGlsLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBTZWxlY3RlZENhbXBhaWduUmVzb3VyY2UsIEVOR0FHRU1FTlRfQkFTRV9QQVRIIH0gZnJvbSAnQGJhY2tiYXNlL2RhdGEtYW5nL2VuZ2FnZW1lbnQnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdiYi1jYW1wYWlnbi1zcGFjZS1hbmcnLFxuICB0ZW1wbGF0ZVVybDogJy4vY2FtcGFpZ24tc3BhY2UuY29tcG9uZW50Lmh0bWwnLFxuICBzdHlsZVVybHM6IFsnLi9jYW1wYWlnbi1zcGFjZS5jb21wb25lbnQuY3NzJ10sXG4gIHByb3ZpZGVyczogW0NhbXBhaWduU2VydmljZV0sXG59KVxuZXhwb3J0IGNsYXNzIENhbXBhaWduU3BhY2VDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIE9uRGVzdHJveSB7XG4gIC8qKlxuICAgKiBDb21wb25lbnQgbmFtZVxuICAgKi9cbiAgQElucHV0KCkgbmFtZSA9ICcnO1xuXG4gIC8qKlxuICAgKiBDYW1wYWlnbiBiYW5uZXIgZGltZW5zaW9uc1xuICAgKi9cbiAgQElucHV0KCkgZGltZW5zaW9ucyA9ICczMDB4MjUwJztcblxuICAvKipcbiAgICogUGFnZSBuYW1lXG4gICAqL1xuICBASW5wdXQoKSBwYWdlTmFtZSA9ICdpbmRleCc7XG5cbiAgLyoqXG4gICAqIElzIGJhbm5lciByZXNwb25zaXZlXG4gICAqL1xuICBASW5wdXQoKSByZXNwb25zaXZlID0gZmFsc2U7XG5cbiAgLyoqXG4gICAqIEJhbm5lciB0aXRsZVxuICAgKi9cbiAgQElucHV0KCkgdGl0bGUgPSAnQ2FtcGFpZ24gU3BhY2UnO1xuXG4gIGNhbXBhaWduPzogU2VsZWN0ZWRDYW1wYWlnblJlc291cmNlO1xuXG4gIGNyZWF0aXZlU3JjPzogU2FmZVJlc291cmNlVXJsO1xuXG4gIHRhcmdldFVybD86IHN0cmluZztcblxuICB0YXJnZXRNb2RlPzogVGFyZ2V0QXR0cmlidXRlO1xuXG4gIGRlc2lnbk1vZGUgPSB0aGlzLmNhbXBhaWduU2VydmljZS5kZXNpZ25Nb2RlO1xuXG4gIGNvbnRlbnQ/OiBzdHJpbmc7XG5cbiAgd2lkZ2V0U3R5bGVzPzogV2lkZ2V0U3R5bGVzO1xuXG4gIHBsYWNlaG9sZGVyVGl0bGUgPSAnJztcblxuICBwcml2YXRlIHJlYWRvbmx5IGlmcmFtZUNvbnRleHQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PHN0cmluZyB8IHVuZGVmaW5lZD4odW5kZWZpbmVkKTtcbiAgcHJpdmF0ZSBkZXN0cm95JCA9IG5ldyBTdWJqZWN0KCk7XG5cbiAgQFZpZXdDaGlsZCgnaWZyYW1lUmVmJywgeyBzdGF0aWM6IGZhbHNlIH0pIGlmcmFtZVJlZiE6IEVsZW1lbnRSZWY8SFRNTElGcmFtZUVsZW1lbnQ+O1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgY2FtcGFpZ25TZXJ2aWNlOiBDYW1wYWlnblNlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSByZW5kZXJlcjogUmVuZGVyZXIyLFxuICAgIHByaXZhdGUgY2RyOiBDaGFuZ2VEZXRlY3RvclJlZixcbiAgICBAT3B0aW9uYWwoKSBASW5qZWN0KEVOR0FHRU1FTlRfQkFTRV9QQVRIKSBwcml2YXRlIHJlYWRvbmx5IGJhc2VQYXRoOiBzdHJpbmcsXG4gICkge31cblxuICBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLndpZGdldFN0eWxlcyA9IHRoaXMuZ2V0V2lkZ2V0U3R5bGVzKCk7XG4gICAgaWYgKHRoaXMuZGVzaWduTW9kZSkge1xuICAgICAgdGhpcy5pbml0RGVzaWduTW9kZSgpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmluaXRMaXZlTW9kZSgpO1xuICAgIH1cbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIHRoaXMuZGVzdHJveSQubmV4dCgpO1xuICB9XG5cbiAgcHJpdmF0ZSBpbml0RGVzaWduTW9kZSgpIHtcbiAgICB0aGlzLnBsYWNlaG9sZGVyVGl0bGUgPSB0aGlzLmdldFBsYWNlaG9sZGVyVGl0bGUoKTtcbiAgfVxuXG4gIHByaXZhdGUgaW5pdExpdmVNb2RlKCkge1xuICAgIHRoaXMuY2FtcGFpZ25TZXJ2aWNlLnNlbGVjdENhbXBhaWduKHRoaXMubmFtZSwgdGhpcy5kaW1lbnNpb25zLCB0aGlzLnBhZ2VOYW1lKS5zdWJzY3JpYmUoY2FtcGFpZ24gPT4ge1xuICAgICAgaWYgKGNhbXBhaWduKSB7XG4gICAgICAgIHRoaXMuY2FtcGFpZ24gPSBjYW1wYWlnbjtcbiAgICAgICAgdGhpcy5zZXRUYXJnZXRVcmwoKTtcbiAgICAgICAgdGhpcy5jb250ZW50ID0gdGhpcy5jYW1wYWlnblNlcnZpY2UuYjY0RGVjb2RlKGNhbXBhaWduLmNyZWF0aXZlLmNvbnRlbnQpO1xuICAgICAgICB0aGlzLmlmcmFtZUNvbnRleHQubmV4dCh0aGlzLmNvbnRlbnQpO1xuICAgICAgICB0aGlzLnRhcmdldE1vZGUgPSBUYXJnZXRBdHRyaWJ1dGVbY2FtcGFpZ24udGFyZ2V0VXJsRGlzcGxheU1vZGUgfHwgJ3NlbGYnXTtcbiAgICAgICAgdGhpcy5jZHIuZGV0ZWN0Q2hhbmdlcygpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXRUYXJnZXRVcmwoKSB7XG4gICAgY29uc3QgYmFzZVBhdGggPSB0aGlzLmJhc2VQYXRoLmVuZHNXaXRoKCcvJykgPyB0aGlzLmJhc2VQYXRoLnNsaWNlKDAsIC0xKSA6IHRoaXMuYmFzZVBhdGg7XG4gICAgY29uc3QgY2FtcGFpZ25VcmwgPSB0aGlzLmNhbXBhaWduPy50YXJnZXRVcmwuc3RhcnRzV2l0aCgnLycpXG4gICAgICA/IHRoaXMuY2FtcGFpZ24udGFyZ2V0VXJsLnNsaWNlKDEpXG4gICAgICA6IHRoaXMuY2FtcGFpZ24/LnRhcmdldFVybDtcbiAgICB0aGlzLnRhcmdldFVybCA9IGAke2Jhc2VQYXRofS8ke2NhbXBhaWduVXJsfWA7XG4gIH1cblxuICBpZnJhbWVMb2FkKCkge1xuICAgIHRoaXMuY2RyLmRldGVjdENoYW5nZXMoKTtcbiAgICBjb25zdCBpZnJhbWVFbGVtZW50ID0gdGhpcy5pZnJhbWVSZWYubmF0aXZlRWxlbWVudDtcbiAgICBjb25zdCBpZnJhbWVCb2R5ID0gKGlmcmFtZUVsZW1lbnQuY29udGVudERvY3VtZW50IGFzIERvY3VtZW50KS5ib2R5O1xuXG4gICAgdGhpcy5yZW5kZXJlci5zZXRTdHlsZShpZnJhbWVFbGVtZW50LCAnd2lkdGgnLCAnMTAwJScpO1xuICAgIHRoaXMucmVuZGVyZXIuc2V0U3R5bGUoaWZyYW1lRWxlbWVudCwgJ2JvcmRlcicsICcwJyk7XG4gICAgdGhpcy5yZW5kZXJlci5zZXRTdHlsZShpZnJhbWVCb2R5LCAnbWFyZ2luJywgJzAnKTtcblxuICAgIHRoaXMuaWZyYW1lQ29udGV4dFxuICAgICAgLnBpcGUoXG4gICAgICAgIGZpbHRlcihCb29sZWFuKSxcbiAgICAgICAgdGFwKGNvbnRlbnQgPT4gdGhpcy5yZW5kZXJlci5zZXRQcm9wZXJ0eShpZnJhbWVCb2R5LCAnaW5uZXJIVE1MJywgY29udGVudCkpLFxuICAgICAgICBkZWxheSgzMDApLFxuICAgICAgICB0YWtlVW50aWwodGhpcy5kZXN0cm95JCksXG4gICAgICApXG4gICAgICAuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgICAgbGV0IGN1cnJlbnRIZWlnaHQgPSBpZnJhbWVCb2R5LnNjcm9sbEhlaWdodDtcbiAgICAgICAgbGV0IHByZXZpb3VzSGVpZ2h0ID0gMDtcbiAgICAgICAgbGV0IGNvdW50ZXIgPSAwO1xuXG4gICAgICAgIGRvIHtcbiAgICAgICAgICB0aGlzLnJlbmRlcmVyLnNldFN0eWxlKGlmcmFtZUVsZW1lbnQsICdoZWlnaHQnLCBgJHtjdXJyZW50SGVpZ2h0fXB4YCk7XG4gICAgICAgICAgcHJldmlvdXNIZWlnaHQgPSBjdXJyZW50SGVpZ2h0O1xuICAgICAgICAgIGN1cnJlbnRIZWlnaHQgPSBpZnJhbWVCb2R5LnNjcm9sbEhlaWdodDtcbiAgICAgICAgICBjb3VudGVyKys7XG4gICAgICAgIH0gd2hpbGUgKHByZXZpb3VzSGVpZ2h0ICE9PSBjdXJyZW50SGVpZ2h0ICYmIGNvdW50ZXIgPCA1KTtcblxuICAgICAgICB0aGlzLmNkci5kZXRlY3RDaGFuZ2VzKCk7XG4gICAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0V2lkZ2V0U3R5bGVzKCk6IFdpZGdldFN0eWxlcyB7XG4gICAgY29uc3QgW3dpZHRoLCBoZWlnaHRdID0gdGhpcy5nZXREaW1lbnNpb25zKHRoaXMuZGltZW5zaW9ucyk7XG4gICAgY29uc3QgcHJvcGVydGllczogV2lkZ2V0U3R5bGVzID0ge1xuICAgICAgd2lkdGg6IHRoaXMucmVzcG9uc2l2ZSA/ICcxMDAlJyA6IHRoaXMudG9QeCh3aWR0aCksXG4gICAgICBoZWlnaHQ6IHRoaXMudG9QeChoZWlnaHQpLFxuICAgIH07XG5cbiAgICBpZiAodGhpcy5yZXNwb25zaXZlKSB7XG4gICAgICBwcm9wZXJ0aWVzLm1heFdpZHRoID0gdGhpcy50b1B4KHdpZHRoKTtcbiAgICB9XG5cbiAgICByZXR1cm4gcHJvcGVydGllcztcbiAgfVxuXG4gIHByaXZhdGUgZ2V0UGxhY2Vob2xkZXJUaXRsZSgpIHtcbiAgICBjb25zdCBbd2lkdGgsIGhlaWdodF0gPSB0aGlzLmdldERpbWVuc2lvbnModGhpcy5kaW1lbnNpb25zKTtcbiAgICBsZXQgcGxhY2Vob2xkZXJUaXRsZSA9IGAke3RoaXMudGl0bGV9IC0gJHt0aGlzLmRpbWVuc2lvbnN9YDtcblxuICAgIGlmICh0aGlzLnJlc3BvbnNpdmUpIHtcbiAgICAgIHBsYWNlaG9sZGVyVGl0bGUgPSBgJHt0aGlzLnRpdGxlfSAtIFJlc3BvbnNpdmUgTWF4LXdpZHRoOiAke3dpZHRofSwgSGVpZ2h0OiAke2hlaWdodH1gO1xuICAgIH1cblxuICAgIHJldHVybiBwbGFjZWhvbGRlclRpdGxlO1xuICB9XG5cbiAgcHJpdmF0ZSB0b1B4KHZhbHVlOiBudW1iZXIgfCBzdHJpbmcpOiBzdHJpbmcge1xuICAgIHJldHVybiB2YWx1ZSArICdweCc7XG4gIH1cblxuICBwcml2YXRlIGdldERpbWVuc2lvbnMoZGltZW5zaW9uczogc3RyaW5nKSB7XG4gICAgcmV0dXJuIGRpbWVuc2lvbnMuc3BsaXQoJ3gnKTtcbiAgfVxufVxuIiwiPG5nLWNvbnRhaW5lciAqbmdJZj1cIndpZGdldFN0eWxlc1wiPlxuICA8ZGl2ICpuZ0lmPVwiIWRlc2lnbk1vZGUgJiYgY2FtcGFpZ25cIiBjbGFzcz1cImJiLWNhbXBhaWduLXNwYWNlLXdpZGdldFwiIFtuZ1N0eWxlXT1cIndpZGdldFN0eWxlc1wiPlxuICAgIDxhIFtocmVmXT1cInRhcmdldFVybFwiIFtuZ1N0eWxlXT1cIndpZGdldFN0eWxlc1wiIFt0YXJnZXRdPVwidGFyZ2V0TW9kZVwiIGNsYXNzPVwiYmItY2FtcGFpZ24tc3BhY2Utd2lkZ2V0X19vdmVybGF5XCI+IDwvYT5cbiAgICA8aWZyYW1lICNpZnJhbWVSZWYgY2xhc3M9XCJiYi1jYW1wYWlnbi1zcGFjZS13aWRnZXRfX2lmcmFtZVwiIFtuZ1N0eWxlXT1cIndpZGdldFN0eWxlc1wiIChsb2FkKT1cImlmcmFtZUxvYWQoKVwiPlxuICAgIDwvaWZyYW1lPlxuICA8L2Rpdj5cbiAgPGRpdiAqbmdJZj1cImRlc2lnbk1vZGVcIiBbbmdTdHlsZV09XCJ3aWRnZXRTdHlsZXNcIiBjbGFzcz1cImJiLWNhbXBhaWduLXNwYWNlLXdpZGdldFwiPlxuICAgIDxkaXYgW25nU3R5bGVdPVwid2lkZ2V0U3R5bGVzXCIgY2xhc3M9XCJiYi1jYW1wYWlnbi1zcGFjZS13aWRnZXRfX3BsYWNlaG9sZGVyXCI+XG4gICAgICA8c3Bhbj57eyBwbGFjZWhvbGRlclRpdGxlIH19PC9zcGFuPlxuICAgIDwvZGl2PlxuICA8L2Rpdj5cbjwvbmctY29udGFpbmVyPlxuIl19