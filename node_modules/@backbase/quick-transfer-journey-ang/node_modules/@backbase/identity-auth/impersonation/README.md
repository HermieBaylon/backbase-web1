# Identity Impersonation

This library supports the originating and target application setup for impersonation to take place.
This document will cover the setup, from an angular stand point, required for both your employee
based application and your target user application.

## Prerequisites

Both your originating and Target application must import the `OAuthModule` in some form from the
`angular-oauth2-oidc` library . They should also import the `IdentityAuthModule` found in
the `@backbase/identity-auth` library.

If both applications are using `localStorage` for `OAuthStorage` then Impersonation will not work
as expected. In general you should not use localStorage for your applications as it's shared across
all tabs and is not domain specific.

## Originating application configuration (Employee)

This application should support an employee in selecting a user to impersonate. The employee user
should already be configured with the service agreements required to impersonate that user. The
Identity Orchestration service should also have been updated to support this originating application.

### App Module

In the `app.module.ts`, or wherever the impersonation code is to be implanted, the
`ImpersonationModule` should be imported from the `@backbase/identity-auth/impersonation` library. This
module requires no configuration.

### Component / Service

In your chosen component or service that supports the Employee user in impersonating someone, you'll
need to add a call to the `ImpersonationService` which can be imported from the
`@backbase/identity-auth/impersonation` library. Below is a code example showing a component calling the
`impersonationService` to `getImpersonationUrl` which returns back the target application url with
the `impersonation_code` reference as a query parameter.


``` ts
  impersonateUser() {
    ...
    this.impersonationService.getImpersonationUrl(userId, targetAppUrl).subscribe({
      next: url => {
        ...
        window.open(url);
      },
      ...
    });
  }
```

The component or service calling this should have access to the target user's internal ID, as well as
the target web application's URL. The User Context *MUST* also be set before performing this request.
The target web application URL should be the route of your target application, this should be the location
you have placed the impersonation banner component.


## Target application configuration

This application will represent what the target user normally logs in to. The target user should
already be configured with the service agreements required to be impersonated. The Identity
Orchestration service should also have been updated to support this target application.

### App Module

In the `app.module.ts`, or inside the private module of your application if you're using lazy loading,
import the `ImpersonationModule` from the `@backbase/identity-auth/impersonation` library.
In your providers you should include the following entry:

``` ts
  {
    provide: APP_INITIALIZER,
    multi: true,
    deps: [OAuthService, ImpersonationService],
    useFactory: (oAuthService: OAuthService, impersonationService: ImpersonationService) => async () => {
      await impersonationService.checkImpersonationStatus();
      await oAuthService.loadDiscoveryDocumentAndTryLogin();
    },
  },
```
The `APP_INITIALIZER` provider should be extended to call the `impersonationService` to
`checkImpersonationStatus` before attempting to login. This method will check the URL for an
`impersonation_code` query parameter. If it finds one then it attempts to exchange this code for an
access and refresh token pair which are then stored and picked up during the login flow. This will stop the
application from redirecting to Identity to request user login.

### Target component

Inside the target application you should include the `<bb-impersonation-banner></bb-impersonation-banner>`
component to display the impersonation banner at the top of the page. This notifies the employee user that
they're currently impersonating someone.

This will most likely be at the top of your `app.component.html` page if you're using a completely private
application. It also may exist at the top of the private part of your application if you have a public login
page.

You must ensure whatever page the banner is used on is wrapped by a *User Context* guard so that the User
Context must be found before loading the banner component. This component uses a call to get the impersonated
user's name which requires the context cookie to be set.
