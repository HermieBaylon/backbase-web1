import { ChangeDetectionStrategy, Component, EventEmitter, Input, Output, } from '@angular/core';
import { formatLabel, PlacementTypes } from '@swimlane/ngx-charts';
import { max } from 'd3-array';
import { arc, pie } from 'd3-shape';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common";
import * as i2 from "./pie-label.component";
import * as i3 from "@swimlane/ngx-charts";
import * as i4 from "../tooltip/tooltip.directive";
export class PieSeriesComponent {
    constructor(currencyPipe) {
        this.currencyPipe = currencyPipe;
        /**
         * Array of Chart data objects needed for the chart to be rendered.
         */
        this.series = [];
        /**
         * Inner slice radius.
         */
        this.innerRadius = 60;
        /**
         * Outer slice radius.
         */
        this.outerRadius = 80;
        /**
         * Slice offsets.
         */
        this.margins = [0, 0, 0, 0];
        /**
         * Flag to show/hide labels.
         */
        this.showLabels = false;
        /**
         * Preselects an active slice of the chart.
         */
        this.activeEntries = [];
        /**
         * Sets the threshold in which the label of each section is visible.
         */
        this.labelThreshold = 0;
        /**
         * Enable/disable label trimming.
         */
        this.trimLabels = true;
        /**
         * Set the max length of the label characters.
         */
        this.maxLabelLength = 10;
        /**
         * Disable/enable the tooltip.
         */
        this.tooltipDisabled = false;
        /**
         * Enable/Disable animations.
         */
        this.animations = true;
        /**
         * EventEmitter for triggering a select event.
         */
        // eslint-disable-next-line @angular-eslint/no-output-native
        this.select = new EventEmitter();
        /**
         * EventEmitter for triggering a activate event.
         */
        this.activate = new EventEmitter();
        /**
         * EventEmitter for triggering a deactivate event.
         */
        this.deactivate = new EventEmitter();
        /**
         * EventEmitter for triggering a dblclick event.
         */
        // eslint-disable-next-line @angular-eslint/no-output-native
        this.dblclick = new EventEmitter();
        this.data = [];
    }
    ngOnChanges() {
        this.update();
    }
    update() {
        const pieGenerator = pie()
            .value((d) => d.value)
            // eslint-disable-next-line no-null/no-null
            .sort(null);
        const arcData = pieGenerator(this.series);
        this.max = max(arcData, (d) => {
            return d.value;
        });
        this.data = this.calculateLabelPositions(arcData);
        this.tooltipText = this.tooltipText || this.defaultTooltipText;
    }
    midAngle(d) {
        return d.startAngle + (d.endAngle - d.startAngle) / 2;
    }
    outerArc(padding) {
        const r = this.outerRadius + padding;
        return arc().innerRadius(r).outerRadius(r);
    }
    calculateLabelPositions(pieData) {
        const labelPositions = pieData;
        labelPositions.forEach((d) => {
            d.pos = this.outerArc(30).centroid(d);
            d.edge = this.outerArc(0).centroid(d);
        });
        return labelPositions;
    }
    labelVisible(myArc) {
        return this.showLabels && myArc.data.portion > this.labelThreshold;
    }
    getTooltipTitle(a) {
        if (this.tooltipTemplate || typeof this.tooltipText !== 'function') {
            return undefined;
        }
        return this.tooltipText(a);
    }
    getTooltipPlacement(a) {
        return this.midAngle(a) > Math.PI ? PlacementTypes.Left : PlacementTypes.Right;
    }
    labelText(myArc) {
        if (this.labelFormatting) {
            return this.labelFormatting(myArc.data.value);
        }
        return (this.currencyPipe.transform(myArc.data.value, myArc.data.totalAmount.currencyCode, undefined, '1.0-0') ||
            myArc.data.value.toString());
    }
    label(myArc) {
        return formatLabel(myArc.data.name);
    }
    defaultTooltipText(myArc) {
        const label = this.label(myArc);
        const val = formatLabel(myArc.data.value);
        return `
      <span class="tooltip-label">${label}</span>
      <span class="tooltip-val">${val}</span>
    `;
    }
    getTooltipPosition(myArc) {
        const halfWidth = this.outerRadius + this.margins[0];
        let position = [0, 0];
        if (this.chartElement) {
            const chartDims = this.chartElement.nativeElement.getBoundingClientRect();
            position = [chartDims.left + halfWidth, chartDims.top + halfWidth];
        }
        return [position[0] + myArc.edge[0], position[1] + myArc.edge[1]];
    }
    color(myArc) {
        return this.colors ? this.colors.getColor(this.label(myArc)) : '';
    }
    icon(myArc) {
        if (!this.colors || !this.colors.customColors) {
            return '';
        }
        const label = this.label(myArc);
        const found = this.colors.customColors.find((item) => item.name === label);
        return found ? found.icon : '';
    }
    trackBy(index, item) {
        return item.data.name;
    }
    onClick(data) {
        this.select.emit(data);
    }
    isActive(entry) {
        if (!this.activeEntries)
            return false;
        const item = this.activeEntries.find((d) => {
            return entry.name === d.name && entry.series === d.series;
        });
        return item !== undefined;
    }
}
PieSeriesComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: PieSeriesComponent, deps: [{ token: i1.CurrencyPipe }], target: i0.ɵɵFactoryTarget.Component });
PieSeriesComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "12.0.0", version: "12.2.16", type: PieSeriesComponent, selector: "g[bb-charts-pie-series]", inputs: { colors: "colors", series: "series", dims: "dims", chartElement: "chartElement", innerRadius: "innerRadius", outerRadius: "outerRadius", margins: "margins", explodeSlices: "explodeSlices", showLabels: "showLabels", gradient: "gradient", activeEntries: "activeEntries", labelThreshold: "labelThreshold", labelFormatting: "labelFormatting", labelTemplate: "labelTemplate", trimLabels: "trimLabels", maxLabelLength: "maxLabelLength", tooltipText: "tooltipText", tooltipDisabled: "tooltipDisabled", tooltipTemplate: "tooltipTemplate", animations: "animations" }, outputs: { select: "select", activate: "activate", deactivate: "deactivate", dblclick: "dblclick" }, usesOnChanges: true, ngImport: i0, template: `
    <svg:g
      *ngFor="let arc of data; trackBy: trackBy"
      data-role="analysis-donut-chart-segment"
      bb-tooltip
      [tooltipDisabled]="tooltipDisabled"
      [tooltipPlacement]="getTooltipPlacement(arc)"
      [tooltipType]="'tooltip'"
      [tooltipShowCaret]="false"
      [tooltipSpacing]="0"
      [tooltipTitle]="getTooltipTitle(arc)"
      [tooltipPosition]="getTooltipPosition(arc)"
      [tooltipTemplate]="tooltipTemplate"
      [tooltipContext]="arc.data"
    >
      <svg:g
        bb-charts-pie-label
        *ngIf="labelVisible(arc)"
        [data]="arc"
        [radius]="outerRadius"
        [color]="color(arc)"
        [icon]="icon(arc)"
        [label]="labelText(arc)"
        [labelTrim]="trimLabels"
        [labelTrimSize]="maxLabelLength"
        [template]="labelTemplate"
        [max]="max"
        [value]="arc.value"
        [explodeSlices]="explodeSlices"
        [animations]="animations"
      ></svg:g>
      <svg:g
        ngx-charts-pie-arc
        [startAngle]="arc.startAngle"
        [endAngle]="arc.endAngle"
        [innerRadius]="innerRadius"
        [outerRadius]="outerRadius"
        [fill]="color(arc)"
        [value]="arc.data.value"
        [gradient]="gradient"
        [data]="arc.data"
        [max]="max"
        [explodeSlices]="explodeSlices"
        [isActive]="isActive(arc.data)"
        [animate]="animations"
        (select)="onClick($event)"
        (activate)="activate.emit($event)"
        (deactivate)="deactivate.emit($event)"
        (dblclick)="dblclick.emit($event)"
      ></svg:g>
    </svg:g>
  `, isInline: true, components: [{ type: i2.PieLabelComponent, selector: "g[bb-charts-pie-label]", inputs: ["data", "radius", "label", "color", "icon", "max", "value", "explodeSlices", "animations", "labelTrim", "labelTrimSize", "template"] }, { type: i3.PieArcComponent, selector: "g[ngx-charts-pie-arc]", inputs: ["startAngle", "endAngle", "cornerRadius", "explodeSlices", "gradient", "animate", "pointerEvents", "isActive", "fill", "innerRadius", "outerRadius", "value", "max", "data"], outputs: ["select", "activate", "deactivate", "dblclick"] }], directives: [{ type: i1.NgForOf, selector: "[ngFor][ngForOf]", inputs: ["ngForOf", "ngForTrackBy", "ngForTemplate"] }, { type: i4.TooltipDirective, selector: "[bb-tooltip]", inputs: ["tooltipCssClass", "tooltipTitle", "tooltipPosition", "tooltipAppendToBody", "tooltipSpacing", "tooltipDisabled", "tooltipShowCaret", "tooltipPlacement", "tooltipAlignment", "tooltipType", "tooltipCloseOnClickOutside", "tooltipCloseOnMouseLeave", "tooltipHideTimeout", "tooltipShowTimeout", "tooltipTemplate", "tooltipShowEvent", "tooltipContext", "tooltipImmediateExit"], outputs: ["show", "hide"] }, { type: i1.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }], changeDetection: i0.ChangeDetectionStrategy.OnPush });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: PieSeriesComponent, decorators: [{
            type: Component,
            args: [{
                    // eslint-disable-next-line @angular-eslint/component-selector
                    selector: 'g[bb-charts-pie-series]',
                    template: `
    <svg:g
      *ngFor="let arc of data; trackBy: trackBy"
      data-role="analysis-donut-chart-segment"
      bb-tooltip
      [tooltipDisabled]="tooltipDisabled"
      [tooltipPlacement]="getTooltipPlacement(arc)"
      [tooltipType]="'tooltip'"
      [tooltipShowCaret]="false"
      [tooltipSpacing]="0"
      [tooltipTitle]="getTooltipTitle(arc)"
      [tooltipPosition]="getTooltipPosition(arc)"
      [tooltipTemplate]="tooltipTemplate"
      [tooltipContext]="arc.data"
    >
      <svg:g
        bb-charts-pie-label
        *ngIf="labelVisible(arc)"
        [data]="arc"
        [radius]="outerRadius"
        [color]="color(arc)"
        [icon]="icon(arc)"
        [label]="labelText(arc)"
        [labelTrim]="trimLabels"
        [labelTrimSize]="maxLabelLength"
        [template]="labelTemplate"
        [max]="max"
        [value]="arc.value"
        [explodeSlices]="explodeSlices"
        [animations]="animations"
      ></svg:g>
      <svg:g
        ngx-charts-pie-arc
        [startAngle]="arc.startAngle"
        [endAngle]="arc.endAngle"
        [innerRadius]="innerRadius"
        [outerRadius]="outerRadius"
        [fill]="color(arc)"
        [value]="arc.data.value"
        [gradient]="gradient"
        [data]="arc.data"
        [max]="max"
        [explodeSlices]="explodeSlices"
        [isActive]="isActive(arc.data)"
        [animate]="animations"
        (select)="onClick($event)"
        (activate)="activate.emit($event)"
        (deactivate)="deactivate.emit($event)"
        (dblclick)="dblclick.emit($event)"
      ></svg:g>
    </svg:g>
  `,
                    changeDetection: ChangeDetectionStrategy.OnPush,
                }]
        }], ctorParameters: function () { return [{ type: i1.CurrencyPipe }]; }, propDecorators: { colors: [{
                type: Input
            }], series: [{
                type: Input
            }], dims: [{
                type: Input
            }], chartElement: [{
                type: Input
            }], innerRadius: [{
                type: Input
            }], outerRadius: [{
                type: Input
            }], margins: [{
                type: Input
            }], explodeSlices: [{
                type: Input
            }], showLabels: [{
                type: Input
            }], gradient: [{
                type: Input
            }], activeEntries: [{
                type: Input
            }], labelThreshold: [{
                type: Input
            }], labelFormatting: [{
                type: Input
            }], labelTemplate: [{
                type: Input
            }], trimLabels: [{
                type: Input
            }], maxLabelLength: [{
                type: Input
            }], tooltipText: [{
                type: Input
            }], tooltipDisabled: [{
                type: Input
            }], tooltipTemplate: [{
                type: Input
            }], animations: [{
                type: Input
            }], select: [{
                type: Output
            }], activate: [{
                type: Output
            }], deactivate: [{
                type: Output
            }], dblclick: [{
                type: Output
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGllLXNlcmllcy5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9saWJzL2luY29tZS1zcGVuZGluZy1hbmFseXNpcy13aWRnZXQvc3JjL2JiLWRvbnV0LWNoYXJ0LXVpL25neC9waWUvcGllLXNlcmllcy5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUNMLHVCQUF1QixFQUN2QixTQUFTLEVBRVQsWUFBWSxFQUNaLEtBQUssRUFFTCxNQUFNLEdBRVAsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFlLFdBQVcsRUFBRSxjQUFjLEVBQWtCLE1BQU0sc0JBQXNCLENBQUM7QUFDaEcsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUMvQixPQUFPLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxNQUFNLFVBQVUsQ0FBQzs7Ozs7O0FBNERwQyxNQUFNLE9BQU8sa0JBQWtCO0lBd0c3QixZQUE2QixZQUEwQjtRQUExQixpQkFBWSxHQUFaLFlBQVksQ0FBYztRQW5HdkQ7O1dBRUc7UUFDTSxXQUFNLEdBQTRCLEVBQUUsQ0FBQztRQVM5Qzs7V0FFRztRQUNNLGdCQUFXLEdBQUcsRUFBRSxDQUFDO1FBQzFCOztXQUVHO1FBQ00sZ0JBQVcsR0FBRyxFQUFFLENBQUM7UUFDMUI7O1dBRUc7UUFDTSxZQUFPLEdBQUcsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUtoQzs7V0FFRztRQUNNLGVBQVUsR0FBRyxLQUFLLENBQUM7UUFLNUI7O1dBRUc7UUFDTSxrQkFBYSxHQUE0QixFQUFFLENBQUM7UUFDckQ7O1dBRUc7UUFDTSxtQkFBYyxHQUFHLENBQUMsQ0FBQztRQVM1Qjs7V0FFRztRQUNNLGVBQVUsR0FBRyxJQUFJLENBQUM7UUFDM0I7O1dBRUc7UUFDTSxtQkFBYyxHQUFHLEVBQUUsQ0FBQztR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SztnQkFJRyxjQUFjO3NCQUF0QixLQUFLO2dCQUlHLGVBQWU7c0JBQXZCLEtBQUs7Z0JBSUcsYUFBYTtzQkFBckIsS0FBSztnQkFJRyxVQUFVO3NCQUFsQixLQUFLO2dCQUlHLGNBQWM7c0JBQXRCLEtBQUs7Z0JBSUcsV0FBVztzQkFBbkIsS0FBSztnQkFJRyxlQUFlO3NCQUF2QixLQUFLO2dCQUlHLGVBQWU7c0JBQXZCLEtBQUs7Z0JBSUcsVUFBVTtzQkFBbEIsS0FBSztnQkFNSSxNQUFNO3NCQUFmLE1BQU07Z0JBSUcsUUFBUTtzQkFBakIsTUFBTTtnQkFJRyxVQUFVO3NCQUFuQixNQUFNO2dCQUtHLFFBQVE7c0JBQWpCLE1BQU0iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDdXJyZW5jeVBpcGUgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuaW1wb3J0IHtcbiAgQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3ksXG4gIENvbXBvbmVudCxcbiAgRWxlbWVudFJlZixcbiAgRXZlbnRFbWl0dGVyLFxuICBJbnB1dCxcbiAgT25DaGFuZ2VzLFxuICBPdXRwdXQsXG4gIFRlbXBsYXRlUmVmLFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IENvbG9ySGVscGVyLCBmb3JtYXRMYWJlbCwgUGxhY2VtZW50VHlwZXMsIFZpZXdEaW1lbnNpb25zIH0gZnJvbSAnQHN3aW1sYW5lL25neC1jaGFydHMnO1xuaW1wb3J0IHsgbWF4IH0gZnJvbSAnZDMtYXJyYXknO1xuaW1wb3J0IHsgYXJjLCBwaWUgfSBmcm9tICdkMy1zaGFwZSc7XG5pbXBvcnQgeyBBcmMsIENoYXJ0Q29sb3JJdGVtLCBDaGFydERhdGFJdGVtRXh0ZW5kZWQgfSBmcm9tICcuLi8uLi9tb2RlbC90eXBlcyc7XG5cbkBDb21wb25lbnQoe1xuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQGFuZ3VsYXItZXNsaW50L2NvbXBvbmVudC1zZWxlY3RvclxuICBzZWxlY3RvcjogJ2dbYmItY2hhcnRzLXBpZS1zZXJpZXNdJyxcbiAgdGVtcGxhdGU6IGBcbiAgICA8c3ZnOmdcbiAgICAgICpuZ0Zvcj1cImxldCBhcmMgb2YgZGF0YTsgdHJhY2tCeTogdHJhY2tCeVwiXG4gICAgICBkYXRhLXJvbGU9XCJhbmFseXNpcy1kb251dC1jaGFydC1zZWdtZW50XCJcbiAgICAgIGJiLXRvb2x0aXBcbiAgICAgIFt0b29sdGlwRGlzYWJsZWRdPVwidG9vbHRpcERpc2FibGVkXCJcbiAgICAgIFt0b29sdGlwUGxhY2VtZW50XT1cImdldFRvb2x0aXBQbGFjZW1lbnQoYXJjKVwiXG4gICAgICBbdG9vbHRpcFR5cGVdPVwiJ3Rvb2x0aXAnXCJcbiAgICAgIFt0b29sdGlwU2hvd0NhcmV0XT1cImZhbHNlXCJcbiAgICAgIFt0b29sdGlwU3BhY2luZ109XCIwXCJcbiAgICAgIFt0b29sdGlwVGl0bGVdPVwiZ2V0VG9vbHRpcFRpdGxlKGFyYylcIlxuICAgICAgW3Rvb2x0aXBQb3NpdGlvbl09XCJnZXRUb29sdGlwUG9zaXRpb24oYXJjKVwiXG4gICAgICBbdG9vbHRpcFRlbXBsYXRlXT1cInRvb2x0aXBUZW1wbGF0ZVwiXG4gICAgICBbdG9vbHRpcENvbnRleHRdPVwiYXJjLmRhdGFcIlxuICAgID5cbiAgICAgIDxzdmc6Z1xuICAgICAgICBiYi1jaGFydHMtcGllLWxhYmVsXG4gICAgICAgICpuZ0lmPVwibGFiZWxWaXNpYmxlKGFyYylcIlxuICAgICAgICBbZGF0YV09XCJhcmNcIlxuICAgICAgICBbcmFkaXVzXT1cIm91dGVyUmFkaXVzXCJcbiAgICAgICAgW2NvbG9yXT1cImNvbG9yKGFyYylcIlxuICAgICAgICBbaWNvbl09XCJpY29uKGFyYylcIlxuICAgICAgICBbbGFiZWxdPVwibGFiZWxUZXh0KGFyYylcIlxuICAgICAgICBbbGFiZWxUcmltXT1cInRyaW1MYWJlbHNcIlxuICAgICAgICBbbGFiZWxUcmltU2l6ZV09XCJtYXhMYWJlbExlbmd0aFwiXG4gICAgICAgIFt0ZW1wbGF0ZV09XCJsYWJlbFRlbXBsYXRlXCJcbiAgICAgICAgW21heF09XCJtYXhcIlxuICAgICAgICBbdmFsdWVdPVwiYXJjLnZhbHVlXCJcbiAgICAgICAgW2V4cGxvZGVTbGljZXNdPVwiZXhwbG9kZVNsaWNlc1wiXG4gICAgICAgIFthbmltYXRpb25zXT1cImFuaW1hdGlvbnNcIlxuICAgICAgPjwvc3ZnOmc+XG4gICAgICA8c3ZnOmdcbiAgICAgICAgbmd4LWNoYXJ0cy1waWUtYXJjXG4gICAgICAgIFtzdGFydEFuZ2xlXT1cImFyYy5zdGFydEFuZ2xlXCJcbiAgICAgICAgW2VuZEFuZ2xlXT1cImFyYy5lbmRBbmdsZVwiXG4gICAgICAgIFtpbm5lclJhZGl1c109XCJpbm5lclJhZGl1c1wiXG4gICAgICAgIFtvdXRlclJhZGl1c109XCJvdXRlclJhZGl1c1wiXG4gICAgICAgIFtmaWxsXT1cImNvbG9yKGFyYylcIlxuICAgICAgICBbdmFsdWVdPVwiYXJjLmRhdGEudmFsdWVcIlxuICAgICAgICBbZ3JhZGllbnRdPVwiZ3JhZGllbnRcIlxuICAgICAgICBbZGF0YV09XCJhcmMuZGF0YVwiXG4gICAgICAgIFttYXhdPVwibWF4XCJcbiAgICAgICAgW2V4cGxvZGVTbGljZXNdPVwiZXhwbG9kZVNsaWNlc1wiXG4gICAgICAgIFtpc0FjdGl2ZV09XCJpc0FjdGl2ZShhcmMuZGF0YSlcIlxuICAgICAgICBbYW5pbWF0ZV09XCJhbmltYXRpb25zXCJcbiAgICAgICAgKHNlbGVjdCk9XCJvbkNsaWNrKCRldmVudClcIlxuICAgICAgICAoYWN0aXZhdGUpPVwiYWN0aXZhdGUuZW1pdCgkZXZlbnQpXCJcbiAgICAgICAgKGRlYWN0aXZhdGUpPVwiZGVhY3RpdmF0ZS5lbWl0KCRldmVudClcIlxuICAgICAgICAoZGJsY2xpY2spPVwiZGJsY2xpY2suZW1pdCgkZXZlbnQpXCJcbiAgICAgID48L3N2ZzpnPlxuICAgIDwvc3ZnOmc+XG4gIGAsXG4gIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoLFxufSlcbmV4cG9ydCBjbGFzcyBQaWVTZXJpZXNDb21wb25lbnQgaW1wbGVtZW50cyBPbkNoYW5nZXMge1xuICAvKipcbiAgICogQ3VzdG9tIGNvbG9yIHBhbGV0dGUgZm9yIHRoZSBjaGFydC5cbiAgICovXG4gIEBJbnB1dCgpIGNvbG9yczogQ29sb3JIZWxwZXIgfCB1bmRlZmluZWQ7XG4gIC8qKlxuICAgKiBBcnJheSBvZiBDaGFydCBkYXRhIG9iamVjdHMgbmVlZGVkIGZvciB0aGUgY2hhcnQgdG8gYmUgcmVuZGVyZWQuXG4gICAqL1xuICBASW5wdXQoKSBzZXJpZXM6IENoYXJ0RGF0YUl0ZW1FeHRlbmRlZFtdID0gW107XG4gIC8qKlxuICAgKiBEaW1lbnNpb25zIG9mIHRoZSBjaGFydCBzbGljZS5cbiAgICovXG4gIEBJbnB1dCgpIGRpbXM6IFZpZXdEaW1lbnNpb25zIHwgdW5kZWZpbmVkO1xuICAvKipcbiAgICogUmVmZXJlbmNlIHRvIHRoZSBjaGFydCBlbGVtZW50LlxuICAgKi9cbiAgQElucHV0KCkgY2hhcnRFbGVtZW50OiBFbGVtZW50UmVmIHwgdW5kZWZpbmVkO1xuICAvKipcbiAgICogSW5uZXIgc2xpY2UgcmFkaXVzLlxuICAgKi9cbiAgQElucHV0KCkgaW5uZXJSYWRpdXMgPSA2MDtcbiAgLyoqXG4gICAqIE91dGVyIHNsaWNlIHJhZGl1cy5cbiAgICovXG4gIEBJbnB1dCgpIG91dGVyUmFkaXVzID0gODA7XG4gIC8qKlxuICAgKiBTbGljZSBvZmZzZXRzLlxuICAgKi9cbiAgQElucHV0KCkgbWFyZ2lucyA9IFswLCAwLCAwLCAwXTtcbiAgLyoqXG4gICAqIE1ha2UgdGhlIHJhZGl1cyBvZiBlYWNoIHNsaWNlIHByb3BvcnRpb25hbCB0byBpdCdzIHZhbHVlLlxuICAgKi9cbiAgQElucHV0KCkgZXhwbG9kZVNsaWNlczogYm9vbGVhbiB8IHVuZGVmaW5lZDtcbiAgLyoqXG4gICAqIEZsYWcgdG8gc2hvdy9oaWRlIGxhYmVscy5cbiAgICovXG4gIEBJbnB1dCgpIHNob3dMYWJlbHMgPSBmYWxzZTtcbiAgLyoqXG4gICAqIElmIGVuYWJsZWQgYWRkcyBncmFkaWVudCB0byB0aGUgY2hhcnQuXG4gICAqL1xuICBASW5wdXQoKSBncmFkaWVudDogYm9vbGVhbiB8IHVuZGVmaW5lZDtcbiAgLyoqXG4gICAqIFByZXNlbGVjdHMgYW4gYWN0aXZlIHNsaWNlIG9mIHRoZSBjaGFydC5cbiAgICovXG4gIEBJbnB1dCgpIGFjdGl2ZUVudHJpZXM6IENoYXJ0RGF0YUl0ZW1FeHRlbmRlZFtdID0gW107XG4gIC8qKlxuICAgKiBTZXRzIHRoZSB0aHJlc2hvbGQgaW4gd2hpY2ggdGhlIGxhYmVsIG9mIGVhY2ggc2VjdGlvbiBpcyB2aXNpYmxlLlxuICAgKi9cbiAgQElucHV0KCkgbGFiZWxUaHJlc2hvbGQgPSAwO1xuICAvKipcbiAgICogUGFzcyBjdXN0b20gZm9ybWF0aW5nIGlmIG5lZWRlZCBmb3IgdGhlIGNoYXJ0IGxhYmVscy5cbiAgICovXG4gIEBJbnB1dCgpIGxhYmVsRm9ybWF0dGluZzogYW55O1xuICAvKipcbiAgICogVGhlIHRlbXBsYXRlIGZvciB0aGUgbGFiZWwuXG4gICAqL1xuICBASW5wdXQoKSBsYWJlbFRlbXBsYXRlOiBUZW1wbGF0ZVJlZjxhbnk+IHwgdW5kZWZpbmVkO1xuICAvKipcbiAgICogRW5hYmxlL2Rpc2FibGUgbGFiZWwgdHJpbW1pbmcuXG4gICAqL1xuICBASW5wdXQoKSB0cmltTGFiZWxzID0gdHJ1ZTtcbiAgLyoqXG4gICAqIFNldCB0aGUgbWF4IGxlbmd0aCBvZiB0aGUgbGFiZWwgY2hhcmFjdGVycy5cbiAgICovXG4gIEBJbnB1dCgpIG1heExhYmVsTGVuZ3RoID0gMTA7XG4gIC8qKlxuICAgKiBUZXh0IGZvciB0aGUgdG9vbHRpcC5cbiAgICovXG4gIEBJbnB1dCgpIHRvb2x0aXBUZXh0OiAoKG86IGFueSkgPT4gYW55KSB8IHVuZGVmaW5lZDtcbiAgLyoqXG4gICAqIERpc2FibGUvZW5hYmxlIHRoZSB0b29sdGlwLlxuICAgKi9cbiAgQElucHV0KCkgdG9vbHRpcERpc2FibGVkID0gZmFsc2U7XG4gIC8qKlxuICAgKiBUZW1wbGF0ZSBmb3IgdGhlIHRvb2x0aXAuXG4gICAqL1xuICBASW5wdXQoKSB0b29sdGlwVGVtcGxhdGU6IFRlbXBsYXRlUmVmPGFueT4gfCB1bmRlZmluZWQ7XG4gIC8qKlxuICAgKiBFbmFibGUvRGlzYWJsZSBhbmltYXRpb25zLlxuICAgKi9cbiAgQElucHV0KCkgYW5pbWF0aW9ucyA9IHRydWU7XG5cbiAgLyoqXG4gICAqIEV2ZW50RW1pdHRlciBmb3IgdHJpZ2dlcmluZyBhIHNlbGVjdCBldmVudC5cbiAgICovXG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAYW5ndWxhci1lc2xpbnQvbm8tb3V0cHV0LW5hdGl2ZVxuICBAT3V0cHV0KCkgc2VsZWN0ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICAvKipcbiAgICogRXZlbnRFbWl0dGVyIGZvciB0cmlnZ2VyaW5nIGEgYWN0aXZhdGUgZXZlbnQuXG4gICAqL1xuICBAT3V0cHV0KCkgYWN0aXZhdGUgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gIC8qKlxuICAgKiBFdmVudEVtaXR0ZXIgZm9yIHRyaWdnZXJpbmcgYSBkZWFjdGl2YXRlIGV2ZW50LlxuICAgKi9cbiAgQE91dHB1dCgpIGRlYWN0aXZhdGUgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gIC8qKlxuICAgKiBFdmVudEVtaXR0ZXIgZm9yIHRyaWdnZXJpbmcgYSBkYmxjbGljayBldmVudC5cbiAgICovXG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAYW5ndWxhci1lc2xpbnQvbm8tb3V0cHV0LW5hdGl2ZVxuICBAT3V0cHV0KCkgZGJsY2xpY2sgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG5cbiAgbWF4OiBudW1iZXIgfCB1bmRlZmluZWQ7XG4gIGRhdGE6IEFyY1tdID0gW107XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBjdXJyZW5jeVBpcGU6IEN1cnJlbmN5UGlwZSkge31cblxuICBuZ09uQ2hhbmdlcygpOiB2b2lkIHtcbiAgICB0aGlzLnVwZGF0ZSgpO1xuICB9XG5cbiAgdXBkYXRlKCk6IHZvaWQge1xuICAgIGNvbnN0IHBpZUdlbmVyYXRvciA9IHBpZTxhbnksIGFueT4oKVxuICAgICAgLnZhbHVlKChkKSA9PiBkLnZhbHVlKVxuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLW51bGwvbm8tbnVsbFxuICAgICAgLnNvcnQobnVsbCk7XG5cbiAgICBjb25zdCBhcmNEYXRhID0gcGllR2VuZXJhdG9yKHRoaXMuc2VyaWVzKTtcblxuICAgIHRoaXMubWF4ID0gbWF4KGFyY0RhdGEsIChkKSA9PiB7XG4gICAgICByZXR1cm4gZC52YWx1ZTtcbiAgICB9KTtcblxuICAgIHRoaXMuZGF0YSA9IHRoaXMuY2FsY3VsYXRlTGFiZWxQb3NpdGlvbnMoYXJjRGF0YSBhcyBBcmNbXSk7XG4gICAgdGhpcy50b29sdGlwVGV4dCA9IHRoaXMudG9vbHRpcFRleHQgfHwgdGhpcy5kZWZhdWx0VG9vbHRpcFRleHQ7XG4gIH1cblxuICBtaWRBbmdsZShkOiBBcmMpOiBudW1iZXIge1xuICAgIHJldHVybiBkLnN0YXJ0QW5nbGUgKyAoZC5lbmRBbmdsZSAtIGQuc3RhcnRBbmdsZSkgLyAyO1xuICB9XG5cbiAgb3V0ZXJBcmMocGFkZGluZzogbnVtYmVyKTogYW55IHtcbiAgICBjb25zdCByID0gdGhpcy5vdXRlclJhZGl1cyArIHBhZGRpbmc7XG4gICAgcmV0dXJuIGFyYygpLmlubmVyUmFkaXVzKHIpLm91dGVyUmFkaXVzKHIpO1xuICB9XG5cbiAgY2FsY3VsYXRlTGFiZWxQb3NpdGlvbnMocGllRGF0YTogQXJjW10pOiBBcmNbXSB7XG4gICAgY29uc3QgbGFiZWxQb3NpdGlvbnMgPSBwaWVEYXRhO1xuICAgIGxhYmVsUG9zaXRpb25zLmZvckVhY2goKGQpID0+IHtcbiAgICAgIGQucG9zID0gdGhpcy5vdXRlckFyYygzMCkuY2VudHJvaWQoZCk7XG4gICAgICBkLmVkZ2UgPSB0aGlzLm91dGVyQXJjKDApLmNlbnRyb2lkKGQpO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIGxhYmVsUG9zaXRpb25zO1xuICB9XG5cbiAgbGFiZWxWaXNpYmxlKG15QXJjOiBBcmMpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5zaG93TGFiZWxzICYmIG15QXJjLmRhdGEucG9ydGlvbiA+IHRoaXMubGFiZWxUaHJlc2hvbGQ7XG4gIH1cblxuICBnZXRUb29sdGlwVGl0bGUoYTogQXJjKSB7XG4gICAgaWYgKHRoaXMudG9vbHRpcFRlbXBsYXRlIHx8IHR5cGVvZiB0aGlzLnRvb2x0aXBUZXh0ICE9PSAnZnVuY3Rpb24nKSB7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLnRvb2x0aXBUZXh0KGEpO1xuICB9XG5cbiAgZ2V0VG9vbHRpcFBsYWNlbWVudChhOiBBcmMpIHtcbiAgICByZXR1cm4gdGhpcy5taWRBbmdsZShhKSA+IE1hdGguUEkgPyBQbGFjZW1lbnRUeXBlcy5MZWZ0IDogUGxhY2VtZW50VHlwZXMuUmlnaHQ7XG4gIH1cblxuICBsYWJlbFRleHQobXlBcmM6IEFyYyk6IHN0cmluZyB7XG4gICAgaWYgKHRoaXMubGFiZWxGb3JtYXR0aW5nKSB7XG4gICAgICByZXR1cm4gdGhpcy5sYWJlbEZvcm1hdHRpbmcobXlBcmMuZGF0YS52YWx1ZSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIChcbiAgICAgIHRoaXMuY3VycmVuY3lQaXBlLnRyYW5zZm9ybShteUFyYy5kYXRhLnZhbHVlLCBteUFyYy5kYXRhLnRvdGFsQW1vdW50LmN1cnJlbmN5Q29kZSwgdW5kZWZpbmVkLCAnMS4wLTAnKSB8fFxuICAgICAgbXlBcmMuZGF0YS52YWx1ZS50b1N0cmluZygpXG4gICAgKTtcbiAgfVxuXG4gIGxhYmVsKG15QXJjOiBBcmMpOiBzdHJpbmcge1xuICAgIHJldHVybiBmb3JtYXRMYWJlbChteUFyYy5kYXRhLm5hbWUpO1xuICB9XG5cbiAgZGVmYXVsdFRvb2x0aXBUZXh0KG15QXJjOiBBcmMpOiBzdHJpbmcge1xuICAgIGNvbnN0IGxhYmVsID0gdGhpcy5sYWJlbChteUFyYyk7XG4gICAgY29uc3QgdmFsID0gZm9ybWF0TGFiZWwobXlBcmMuZGF0YS52YWx1ZSk7XG5cbiAgICByZXR1cm4gYFxuICAgICAgPHNwYW4gY2xhc3M9XCJ0b29sdGlwLWxhYmVsXCI+JHtsYWJlbH08L3NwYW4+XG4gICAgICA8c3BhbiBjbGFzcz1cInRvb2x0aXAtdmFsXCI+JHt2YWx9PC9zcGFuPlxuICAgIGA7XG4gIH1cblxuICBnZXRUb29sdGlwUG9zaXRpb24obXlBcmM6IEFyYyk6IFtudW1iZXIsIG51bWJlcl0ge1xuICAgIGNvbnN0IGhhbGZXaWR0aCA9IHRoaXMub3V0ZXJSYWRpdXMgKyB0aGlzLm1hcmdpbnNbMF07XG4gICAgbGV0IHBvc2l0aW9uID0gWzAsIDBdO1xuICAgIGlmICh0aGlzLmNoYXJ0RWxlbWVudCkge1xuICAgICAgY29uc3QgY2hhcnREaW1zID0gdGhpcy5jaGFydEVsZW1lbnQubmF0aXZlRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcbiAgICAgIHBvc2l0aW9uID0gW2NoYXJ0RGltcy5sZWZ0ICsgaGFsZldpZHRoLCBjaGFydERpbXMudG9wICsgaGFsZldpZHRoXTtcbiAgICB9XG5cbiAgICByZXR1cm4gW3Bvc2l0aW9uWzBdICsgbXlBcmMuZWRnZVswXSwgcG9zaXRpb25bMV0gKyBteUFyYy5lZGdlWzFdXTtcbiAgfVxuXG4gIGNvbG9yKG15QXJjOiBBcmMpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLmNvbG9ycyA/IHRoaXMuY29sb3JzLmdldENvbG9yKHRoaXMubGFiZWwobXlBcmMpKSA6ICcnO1xuICB9XG5cbiAgaWNvbihteUFyYzogQXJjKTogc3RyaW5nIHtcbiAgICBpZiAoIXRoaXMuY29sb3JzIHx8ICF0aGlzLmNvbG9ycy5jdXN0b21Db2xvcnMpIHtcbiAgICAgIHJldHVybiAnJztcbiAgICB9XG4gICAgY29uc3QgbGFiZWwgPSB0aGlzLmxhYmVsKG15QXJjKTtcbiAgICBjb25zdCBmb3VuZCA9IHRoaXMuY29sb3JzLmN1c3RvbUNvbG9ycy5maW5kKChpdGVtOiBDaGFydENvbG9ySXRlbSkgPT4gaXRlbS5uYW1lID09PSBsYWJlbCk7XG4gICAgcmV0dXJuIGZvdW5kID8gZm91bmQuaWNvbiA6ICcnO1xuICB9XG5cbiAgdHJhY2tCeShpbmRleDogbnVtYmVyLCBpdGVtOiBBcmMpOiBzdHJpbmcge1xuICAgIHJldHVybiA8c3RyaW5nPml0ZW0uZGF0YS5uYW1lO1xuICB9XG5cbiAgb25DbGljayhkYXRhOiBDaGFydERhdGFJdGVtRXh0ZW5kZWQpOiB2b2lkIHtcbiAgICB0aGlzLnNlbGVjdC5lbWl0KGRhdGEpO1xuICB9XG5cbiAgaXNBY3RpdmUoZW50cnk6IENoYXJ0RGF0YUl0ZW1FeHRlbmRlZCk6IGJvb2xlYW4ge1xuICAgIGlmICghdGhpcy5hY3RpdmVFbnRyaWVzKSByZXR1cm4gZmFsc2U7XG4gICAgY29uc3QgaXRlbSA9IHRoaXMuYWN0aXZlRW50cmllcy5maW5kKChkKSA9PiB7XG4gICAgICByZXR1cm4gZW50cnkubmFtZSA9PT0gZC5uYW1lICYmIGVudHJ5LnNlcmllcyA9PT0gZC5zZXJpZXM7XG4gICAgfSk7XG4gICAgcmV0dXJuIGl0ZW0gIT09IHVuZGVmaW5lZDtcbiAgfVxufVxuIl19