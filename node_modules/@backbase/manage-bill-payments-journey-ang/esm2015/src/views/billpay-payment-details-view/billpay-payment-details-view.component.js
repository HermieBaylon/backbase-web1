import { Component, ViewChild } from '@angular/core';
import { combineLatest, of, Subject, throwError } from 'rxjs';
import { catchError, map, shareReplay, switchMap, takeUntil, tap } from 'rxjs/operators';
import { ONE_OFF_PAYMENT } from '@backbase/billpay-journeys-common';
import * as i0 from "@angular/core";
import * as i1 from "../../services/manage-bill-payments-journey-config.service";
import * as i2 from "../../services/manage-bill-payments-data.service";
import * as i3 from "@angular/router";
import * as i4 from "../../services/manage-bill-payments-navigation.service";
import * as i5 from "@backbase/ui-ang/notification";
import * as i6 from "@backbase/ui-ang/header";
import * as i7 from "../../components/billpay-payment-details/billpay-payment-details.component";
import * as i8 from "../../components/billpay-payments-delete-modal/billpay-payments-delete-modal.component";
import * as i9 from "@backbase/ui-ang/empty-state";
import * as i10 from "@backbase/ui-ang/loading-indicator";
import * as i11 from "@angular/common";
export class BillPayPaymentDetailsViewComponent {
    constructor(config, dataService, route, routerService, notificationService) {
        this.config = config;
        this.dataService = dataService;
        this.route = route;
        this.routerService = routerService;
        this.notificationService = notificationService;
        this.notificationHeaderTemplate = '';
        this.notificationMessageTemplate = '';
        this.hasLoadingError = false;
        this.isDeleteModalOpened = false;
        this.id$ = this.route.paramMap.pipe(map(params => params.get('id') || ''));
        this.paymentType$ = this.route.queryParamMap.pipe(map(params => params.get('type') || ONE_OFF_PAYMENT));
        this.destroy$ = new Subject();
        this.payment$ = combineLatest([this.id$, this.paymentType$]).pipe(takeUntil(this.destroy$), switchMap(([id, paymentType]) => this.dataService.getPayment(id, paymentType)), map(({ payment }) => payment), shareReplay(1), catchError(() => {
            this.hasLoadingError = true;
            return of(undefined);
        }));
        this.payee$ = this.payment$.pipe(switchMap(payment => payment && !payment.payeeElectronic && payment.payeeID
            ? this.dataService.getPayee(payment.payeeID)
            : throwError("Payee can't be retrieved")), map(({ payee }) => payee), catchError(() => {
            return of({});
        }));
    }
    ngOnDestroy() {
        this.destroy$.next();
        this.destroy$.complete();
    }
    onPaymentDeleteFlowStarted() {
        this.isDeleteModalOpened = true;
    }
    onEditPayment(payment) {
        if (payment.recurring) {
            this.routerService.navigateToEditRecurringPayment(payment.id);
        }
        else {
            this.routerService.navigateToEditOneOffPayment(payment.id);
        }
    }
    onModalResolve(resolvedWith) {
        const deletePayment$ = this.deletePayment().pipe(tap(() => {
            this.routerService.navigateToPaymentsList(this.config.pageFilter);
            this.notificationService.showNotification({
                header: this.notificationHeaderTemplate,
                message: this.notificationMessageTemplate,
                modifier: 'success',
                ttl: this.dismissTimeout,
            });
        }));
        (resolvedWith ? deletePayment$ : of()).subscribe({
            complete: () => (this.isDeleteModalOpened = false),
        });
    }
    deletePayment() {
        return combineLatest([this.id$, this.paymentType$]).pipe(takeUntil(this.destroy$), switchMap(([id, paymentType]) => this.dataService.deletePayment(id, paymentType)));
    }
    get dismissTimeout() {
        if (this.config.notificationDismissTime === undefined) {
            throw new Error('Dismiss timeout value not found');
        }
        return this.config.notificationDismissTime;
    }
}
BillPayPaymentDetailsViewComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.15", ngImport: i0, type: BillPayPaymentDetailsViewComponent, deps: [{ token: i1.ManageBillPaymentsJourneyConfigService }, { token: i2.ManageBillPaymentsDataService }, { token: i3.ActivatedRoute }, { token: i4.ManageBillPaymentsNavigationService }, { token: i5.NotificationService }], target: i0.ɵɵFactoryTarget.Component });
BillPayPaymentDetailsViewComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "12.0.0", version: "12.2.15", type: BillPayPaymentDetailsViewComponent, selector: "bb-billpay-payment-details-view", viewQueries: [{ propertyName: "notificationHeaderTemplate", first: true, predicate: ["notificationHeader"], descendants: true }, { propertyName: "notificationMessageTemplate", first: true, predicate: ["notificationMessage"], descendants: true }], ngImport: i0, template: "<div>\n  <div class=\"bb-block bb-block--lg\">\n    <bb-header-ui\n      headingType=\"h1\"\n      [heading]=\"config.pageTitle\"\n      i18n-heading=\"@@billpay-payments-journey.payment-details-view.title\"\n    ></bb-header-ui>\n  </div>\n  <ng-container *ngIf=\"!hasLoadingError; else errorState\">\n    <ng-container *ngIf=\"{ payment: payment$ | async, payee: payee$ | async } as data; else loadingState\">\n      <section>\n        <bb-billpay-payment-details\n          *ngIf=\"data.payment && data.payee\"\n          [payment]=\"data?.payment\"\n          [payee]=\"data?.payee\"\n          [accountNumberMasked]=\"config.accountNumberMasked\"\n          (paymentCancelling)=\"onPaymentDeleteFlowStarted()\"\n          (paymentEditing)=\"onEditPayment($event)\"\n        ></bb-billpay-payment-details>\n      </section>\n\n      <ng-template #notificationMessage>\n        <span\n          data-role=\"notification-message\"\n          i18n=\"Payee notification message|Payee has created successfully notification@@billpay-payments.details.notification.message\"\n          >Payment to\n          {{ (data.payment?.payeeNickName && data.payment?.payeeNickName + ' (' + data.payment?.payeeName + ')') || data.payment?.payeeName }} has\n          been canceled successfully</span\n        >\n      </ng-template>\n\n    </ng-container>\n  </ng-container>\n</div>\n\n<bb-billpay-payments-delete-modal\n*ngIf=\"isDeleteModalOpened\"\n(resolve)=\"onModalResolve($event)\"\n></bb-billpay-payments-delete-modal>\n\n\n<ng-template #notificationHeader>\n  <span\n    class=\"text-dark\"\n    i18n=\"Payee notification header|Payee created success notification header@@billpay-payments.details.notification.header\"\n  >Payment canceled</span\n></ng-template>\n\n<ng-template #errorState>\n  <div class=\"card card-lg\">\n    <div class=\"card-body\">\n      <div class=\"bb-state-container\">\n        <bb-empty-state-ui\n          data-role=\"error-state\"\n          iconSize=\"xxl\"\n          iconModifier=\"error-outline\"\n          title=\"Payment is not loading\"\n          i18n-title=\"Payment list is not loading title@@billpay-payments.details.error-state.title\"\n          subtitle=\"Try to reload the page or contact support\"\n          i18n-subtitle=\"Payment is not loading subtitle@@billpay-payments.details.error-state.subtitle\"\n        >\n        </bb-empty-state-ui>\n      </div>\n    </div>\n  </div>\n</ng-template>\n\n<ng-template #loadingState>\n  <div class=\"card card-lg\">\n    <div class=\"card-body\">\n      <bb-loading-indicator-ui loaderSize=\"lg\"> </bb-loading-indicator-ui>\n    </div>\n  </div>\n</ng-template>\n", components: [{ type: i6.HeaderComponent, selector: "bb-header-ui", inputs: ["headingClasses", "headingType", "heading"] }, { type: i7.BillpayPaymentDetailsComponent, selector: "bb-billpay-payment-details", inputs: ["payment", "payee", "accountNumberMasked"], outputs: ["paymentCancelling", "paymentEditing"] }, { type: i8.BillpayPaymentsDeleteModalComponent, selector: "bb-billpay-payments-delete-modal", outputs: ["resolve"] }, { type: i9.EmptyStateComponent, selector: "bb-empty-state-ui", inputs: ["title", "subtitle", "showIcon", "iconClasses", "iconModifier", "iconSize", "iconColor"] }, { type: i10.LoadingIndicatorComponent, selector: "bb-loading-indicator-ui", inputs: ["text", "loaderSize", "showDelay", "hasBackground", "inline"] }], directives: [{ type: i11.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }], pipes: { "async": i11.AsyncPipe } });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.15", ngImport: i0, type: BillPayPaymentDetailsViewComponent, decorators: [{
            type: Component,
            args: [{
                    selector: 'bb-billpay-payment-details-view',
                    templateUrl: './billpay-payment-details-view.component.html',
                }]
        }], ctorParameters: function () { return [{ type: i1.ManageBillPaymentsJourneyConfigService }, { type: i2.ManageBillPaymentsDataService }, { type: i3.ActivatedRoute }, { type: i4.ManageBillPaymentsNavigationService }, { type: i5.NotificationService }]; }, propDecorators: { notificationHeaderTemplate: [{
                type: ViewChild,
                args: ['notificationHeader']
            }], notificationMessageTemplate: [{
                type: ViewChild,
                args: ['notificationMessage']
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmlsbHBheS1wYXltZW50LWRldGFpbHMtdmlldy5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9saWJzL21hbmFnZS1iaWxsLXBheW1lbnRzLWpvdXJuZXkvc3JjL3ZpZXdzL2JpbGxwYXktcGF5bWVudC1kZXRhaWxzLXZpZXcvYmlsbHBheS1wYXltZW50LWRldGFpbHMtdmlldy5jb21wb25lbnQudHMiLCIuLi8uLi8uLi8uLi8uLi8uLi8uLi9saWJzL21hbmFnZS1iaWxsLXBheW1lbnRzLWpvdXJuZXkvc3JjL3ZpZXdzL2JpbGxwYXktcGF5bWVudC1kZXRhaWxzLXZpZXcvYmlsbHBheS1wYXltZW50LWRldGFpbHMtdmlldy5jb21wb25lbnQuaHRtbCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsU0FBUyxFQUEwQixTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFN0UsT0FBTyxFQUFFLGFBQWEsRUFBYyxFQUFFLEVBQUUsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMxRSxPQUFPLEVBQUUsVUFBVSxFQUFFLEdBQUcsRUFBRSxXQUFXLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQU96RixPQUFPLEVBQUUsZUFBZSxFQUFlLE1BQU0sbUNBQW1DLENBQUM7Ozs7Ozs7Ozs7Ozs7QUFPakYsTUFBTSxPQUFPLGtDQUFrQztJQWE3QyxZQUNXLE1BQThDLEVBQ3RDLFdBQTBDLEVBQzFDLEtBQXFCLEVBQ3JCLGFBQWtELEVBQ2xELG1CQUF3QztRQUpoRCxXQUFNLEdBQU4sTUFBTSxDQUF3QztRQUN0QyxnQkFBVyxHQUFYLFdBQVcsQ0FBK0I7UUFDMUMsVUFBSyxHQUFMLEtBQUssQ0FBZ0I7UUFDckIsa0JBQWEsR0FBYixhQUFhLENBQXFDO1FBQ2xELHdCQUFtQixHQUFuQixtQkFBbUIsQ0FBcUI7UUFqQjFC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OUMsU0FBUzttQkFBQztvQkFDVCxRQUFRLEVBQUUsaUNBQWlDO29CQUMzQyxXQUFXLEVBQUUsK0NBQStDO2lCQUM3RDswUkFFa0MsMEJBQTBCO3NCQUExRCxTQUFTO3VCQUFDLG9CQUFvQjtnQkFDRywyQkFBMkI7c0JBQTVELFNBQVM7dUJBQUMscUJBQXFCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBPbkRlc3Ryb3ksIFRlbXBsYXRlUmVmLCBWaWV3Q2hpbGQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEFjdGl2YXRlZFJvdXRlIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcbmltcG9ydCB7IGNvbWJpbmVMYXRlc3QsIE9ic2VydmFibGUsIG9mLCBTdWJqZWN0LCB0aHJvd0Vycm9yIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBjYXRjaEVycm9yLCBtYXAsIHNoYXJlUmVwbGF5LCBzd2l0Y2hNYXAsIHRha2VVbnRpbCwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbXBvcnQgeyBOb3RpZmljYXRpb25TZXJ2aWNlIH0gZnJvbSAnQGJhY2tiYXNlL3VpLWFuZy9ub3RpZmljYXRpb24nO1xuaW1wb3J0IHsgT25lT2ZmUGF5bWVudCwgUGF5ZWUsIFBheW1lbnQgfSBmcm9tICdAYmFja2Jhc2UvZGF0YS1hbmcvYmlsbHBheSc7XG5pbXBvcnQgeyBNYW5hZ2VCaWxsUGF5bWVudHNOYXZpZ2F0aW9uU2VydmljZSB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL21hbmFnZS1iaWxsLXBheW1lbnRzLW5hdmlnYXRpb24uc2VydmljZSc7XG5pbXBvcnQgeyBNYW5hZ2VCaWxsUGF5bWVudHNKb3VybmV5Q29uZmlnU2VydmljZSB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL21hbmFnZS1iaWxsLXBheW1lbnRzLWpvdXJuZXktY29uZmlnLnNlcnZpY2UnO1xuaW1wb3J0IHsgTWFuYWdlQmlsbFBheW1lbnRzRGF0YVNlcnZpY2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9tYW5hZ2UtYmlsbC1wYXltZW50cy1kYXRhLnNlcnZpY2UnO1xuaW1wb3J0IHsgT05FX09GRl9QQVlNRU5ULCBQYXltZW50VHlwZSB9IGZyb20gJ0BiYWNrYmFzZS9iaWxscGF5LWpvdXJuZXlzLWNvbW1vbic7XG5pbXBvcnQgeyBQYXltZW50RWRpdEV2ZW50IH0gZnJvbSAnLi4vLi4vbW9kZWwnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdiYi1iaWxscGF5LXBheW1lbnQtZGV0YWlscy12aWV3JyxcbiAgdGVtcGxhdGVVcmw6ICcuL2JpbGxwYXktcGF5bWVudC1kZXRhaWxzLXZpZXcuY29tcG9uZW50Lmh0bWwnLFxufSlcbmV4cG9ydCBjbGFzcyBCaWxsUGF5UGF5bWVudERldGFpbHNWaWV3Q29tcG9uZW50IGltcGxlbWVudHMgT25EZXN0cm95IHtcbiAgQFZpZXdDaGlsZCgnbm90aWZpY2F0aW9uSGVhZGVyJykgbm90aWZpY2F0aW9uSGVhZGVyVGVtcGxhdGU6IFRlbXBsYXRlUmVmPGFueT4gfCBzdHJpbmcgPSAnJztcbiAgQFZpZXdDaGlsZCgnbm90aWZpY2F0aW9uTWVzc2FnZScpIG5vdGlmaWNhdGlvbk1lc3NhZ2VUZW1wbGF0ZTogVGVtcGxhdGVSZWY8YW55PiB8IHN0cmluZyA9ICcnO1xuICBwYXltZW50JDogT2JzZXJ2YWJsZTxQYXltZW50IHwgT25lT2ZmUGF5bWVudCB8IHVuZGVmaW5lZD47XG4gIHBheWVlJDogT2JzZXJ2YWJsZTxQYXllZSB8IHVuZGVmaW5lZD47XG4gIGhhc0xvYWRpbmdFcnJvciA9IGZhbHNlO1xuICBpc0RlbGV0ZU1vZGFsT3BlbmVkID0gZmFsc2U7XG4gIGlkJCA9IHRoaXMucm91dGUucGFyYW1NYXAucGlwZShtYXAocGFyYW1zID0+IHBhcmFtcy5nZXQoJ2lkJykgfHwgJycpKTtcbiAgcHJpdmF0ZSByZWFkb25seSBwYXltZW50VHlwZSQgPSB0aGlzLnJvdXRlLnF1ZXJ5UGFyYW1NYXAucGlwZShcbiAgICBtYXAocGFyYW1zID0+IHBhcmFtcy5nZXQoJ3R5cGUnKSB8fCBPTkVfT0ZGX1BBWU1FTlQpLFxuICApIGFzIE9ic2VydmFibGU8UGF5bWVudFR5cGU+O1xuICBwcml2YXRlIHJlYWRvbmx5IGRlc3Ryb3kkID0gbmV3IFN1YmplY3Q8dm9pZD4oKTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICByZWFkb25seSBjb25maWc6IE1hbmFnZUJpbGxQYXltZW50c0pvdXJuZXlDb25maWdTZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgZGF0YVNlcnZpY2U6IE1hbmFnZUJpbGxQYXltZW50c0RhdGFTZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgcm91dGU6IEFjdGl2YXRlZFJvdXRlLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgcm91dGVyU2VydmljZTogTWFuYWdlQmlsbFBheW1lbnRzTmF2aWdhdGlvblNlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSBub3RpZmljYXRpb25TZXJ2aWNlOiBOb3RpZmljYXRpb25TZXJ2aWNlLFxuICApIHtcbiAgICB0aGlzLnBheW1lbnQkID0gY29tYmluZUxhdGVzdChbdGhpcy5pZCQsIHRoaXMucGF5bWVudFR5cGUkXSkucGlwZShcbiAgICAgIHRha2VVbnRpbCh0aGlzLmRlc3Ryb3kkKSxcbiAgICAgIHN3aXRjaE1hcCgoW2lkLCBwYXltZW50VHlwZV0pID0+IHRoaXMuZGF0YVNlcnZpY2UuZ2V0UGF5bWVudChpZCwgcGF5bWVudFR5cGUpKSxcbiAgICAgIG1hcCgoeyBwYXltZW50IH0pID0+IHBheW1lbnQpLFxuICAgICAgc2hhcmVSZXBsYXkoMSksXG4gICAgICBjYXRjaEVycm9yKCgpID0+IHtcbiAgICAgICAgdGhpcy5oYXNMb2FkaW5nRXJyb3IgPSB0cnVlO1xuICAgICAgICByZXR1cm4gb2YodW5kZWZpbmVkKTtcbiAgICAgIH0pLFxuICAgICk7XG5cbiAgICB0aGlzLnBheWVlJCA9IHRoaXMucGF5bWVudCQucGlwZShcbiAgICAgIHN3aXRjaE1hcChwYXltZW50ID0+XG4gICAgICAgIHBheW1lbnQgJiYgIXBheW1lbnQucGF5ZWVFbGVjdHJvbmljICYmIHBheW1lbnQucGF5ZWVJRFxuICAgICAgICAgID8gdGhpcy5kYXRhU2VydmljZS5nZXRQYXllZShwYXltZW50LnBheWVlSUQpXG4gICAgICAgICAgOiB0aHJvd0Vycm9yKFwiUGF5ZWUgY2FuJ3QgYmUgcmV0cmlldmVkXCIpLFxuICAgICAgKSxcbiAgICAgIG1hcCgoeyBwYXllZSB9KSA9PiBwYXllZSksXG4gICAgICBjYXRjaEVycm9yKCgpID0+IHtcbiAgICAgICAgcmV0dXJuIG9mKHt9IGFzIFBheWVlKTtcbiAgICAgIH0pLFxuICAgICk7XG4gIH1cblxuICBuZ09uRGVzdHJveSgpIHtcbiAgICB0aGlzLmRlc3Ryb3kkLm5leHQoKTtcbiAgICB0aGlzLmRlc3Ryb3kkLmNvbXBsZXRlKCk7XG4gIH1cblxuICBvblBheW1lbnREZWxldGVGbG93U3RhcnRlZCgpIHtcbiAgICB0aGlzLmlzRGVsZXRlTW9kYWxPcGVuZWQgPSB0cnVlO1xuICB9XG5cbiAgb25FZGl0UGF5bWVudChwYXltZW50OiBQYXltZW50RWRpdEV2ZW50KSB7XG4gICAgaWYgKHBheW1lbnQucmVjdXJyaW5nKSB7XG4gICAgICB0aGlzLnJvdXRlclNlcnZpY2UubmF2aWdhdGVUb0VkaXRSZWN1cnJpbmdQYXltZW50KHBheW1lbnQuaWQpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnJvdXRlclNlcnZpY2UubmF2aWdhdGVUb0VkaXRPbmVPZmZQYXltZW50KHBheW1lbnQuaWQpO1xuICAgIH1cbiAgfVxuXG4gIG9uTW9kYWxSZXNvbHZlKHJlc29sdmVkV2l0aDogYm9vbGVhbikge1xuICAgIGNvbnN0IGRlbGV0ZVBheW1lbnQkID0gdGhpcy5kZWxldGVQYXltZW50KCkucGlwZShcbiAgICAgIHRhcCgoKSA9PiB7XG4gICAgICAgIHRoaXMucm91dGVyU2VydmljZS5uYXZpZ2F0ZVRvUGF5bWVudHNMaXN0KHRoaXMuY29uZmlnLnBhZ2VGaWx0ZXIpO1xuICAgICAgICB0aGlzLm5vdGlmaWNhdGlvblNlcnZpY2Uuc2hvd05vdGlmaWNhdGlvbih7XG4gICAgICAgICAgaGVhZGVyOiB0aGlzLm5vdGlmaWNhdGlvbkhlYWRlclRlbXBsYXRlLFxuICAgICAgICAgIG1lc3NhZ2U6IHRoaXMubm90aWZpY2F0aW9uTWVzc2FnZVRlbXBsYXRlLFxuICAgICAgICAgIG1vZGlmaWVyOiAnc3VjY2VzcycsXG4gICAgICAgICAgdHRsOiB0aGlzLmRpc21pc3NUaW1lb3V0LFxuICAgICAgICB9KTtcbiAgICAgIH0pLFxuICAgICk7XG4gICAgKHJlc29sdmVkV2l0aCA/IGRlbGV0ZVBheW1lbnQkIDogb2YoKSkuc3Vic2NyaWJlKHtcbiAgICAgIGNvbXBsZXRlOiAoKSA9PiAodGhpcy5pc0RlbGV0ZU1vZGFsT3BlbmVkID0gZmFsc2UpLFxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBkZWxldGVQYXltZW50KCkge1xuICAgIHJldHVybiBjb21iaW5lTGF0ZXN0KFt0aGlzLmlkJCwgdGhpcy5wYXltZW50VHlwZSRdKS5waXBlKFxuICAgICAgdGFrZVVudGlsKHRoaXMuZGVzdHJveSQpLFxuICAgICAgc3dpdGNoTWFwKChbaWQsIHBheW1lbnRUeXBlXSkgPT4gdGhpcy5kYXRhU2VydmljZS5kZWxldGVQYXltZW50KGlkLCBwYXltZW50VHlwZSkpLFxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGdldCBkaXNtaXNzVGltZW91dCgpOiBudW1iZXIge1xuICAgIGlmICh0aGlzLmNvbmZpZy5ub3RpZmljYXRpb25EaXNtaXNzVGltZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Rpc21pc3MgdGltZW91dCB2YWx1ZSBub3QgZm91bmQnKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuY29uZmlnLm5vdGlmaWNhdGlvbkRpc21pc3NUaW1lO1xuICB9XG59XG4iLCI8ZGl2PlxuICA8ZGl2IGNsYXNzPVwiYmItYmxvY2sgYmItYmxvY2stLWxnXCI+XG4gICAgPGJiLWhlYWRlci11aVxuICAgICAgaGVhZGluZ1R5cGU9XCJoMVwiXG4gICAgICBbaGVhZGluZ109XCJjb25maWcucGFnZVRpdGxlXCJcbiAgICAgIGkxOG4taGVhZGluZz1cIkBAYmlsbHBheS1wYXltZW50cy1qb3VybmV5LnBheW1lbnQtZGV0YWlscy12aWV3LnRpdGxlXCJcbiAgICA+PC9iYi1oZWFkZXItdWk+XG4gIDwvZGl2PlxuICA8bmctY29udGFpbmVyICpuZ0lmPVwiIWhhc0xvYWRpbmdFcnJvcjsgZWxzZSBlcnJvclN0YXRlXCI+XG4gICAgPG5nLWNvbnRhaW5lciAqbmdJZj1cInsgcGF5bWVudDogcGF5bWVudCQgfCBhc3luYywgcGF5ZWU6IHBheWVlJCB8IGFzeW5jIH0gYXMgZGF0YTsgZWxzZSBsb2FkaW5nU3RhdGVcIj5cbiAgICAgIDxzZWN0aW9uPlxuICAgICAgICA8YmItYmlsbHBheS1wYXltZW50LWRldGFpbHNcbiAgICAgICAgICAqbmdJZj1cImRhdGEucGF5bWVudCAmJiBkYXRhLnBheWVlXCJcbiAgICAgICAgICBbcGF5bWVudF09XCJkYXRhPy5wYXltZW50XCJcbiAgICAgICAgICBbcGF5ZWVdPVwiZGF0YT8ucGF5ZWVcIlxuICAgICAgICAgIFthY2NvdW50TnVtYmVyTWFza2VkXT1cImNvbmZpZy5hY2NvdW50TnVtYmVyTWFza2VkXCJcbiAgICAgICAgICAocGF5bWVudENhbmNlbGxpbmcpPVwib25QYXltZW50RGVsZXRlRmxvd1N0YXJ0ZWQoKVwiXG4gICAgICAgICAgKHBheW1lbnRFZGl0aW5nKT1cIm9uRWRpdFBheW1lbnQoJGV2ZW50KVwiXG4gICAgICAgID48L2JiLWJpbGxwYXktcGF5bWVudC1kZXRhaWxzPlxuICAgICAgPC9zZWN0aW9uPlxuXG4gICAgICA8bmctdGVtcGxhdGUgI25vdGlmaWNhdGlvbk1lc3NhZ2U+XG4gICAgICAgIDxzcGFuXG4gICAgICAgICAgZGF0YS1yb2xlPVwibm90aWZpY2F0aW9uLW1lc3NhZ2VcIlxuICAgICAgICAgIGkxOG49XCJQYXllZSBub3RpZmljYXRpb24gbWVzc2FnZXxQYXllZSBoYXMgY3JlYXRlZCBzdWNjZXNzZnVsbHkgbm90aWZpY2F0aW9uQEBiaWxscGF5LXBheW1lbnRzLmRldGFpbHMubm90aWZpY2F0aW9uLm1lc3NhZ2VcIlxuICAgICAgICAgID5QYXltZW50IHRvXG4gICAgICAgICAge3sgKGRhdGEucGF5bWVudD8ucGF5ZWVOaWNrTmFtZSAmJiBkYXRhLnBheW1lbnQ/LnBheWVlTmlja05hbWUgKyAnICgnICsgZGF0YS5wYXltZW50Py5wYXllZU5hbWUgKyAnKScpIHx8IGRhdGEucGF5bWVudD8ucGF5ZWVOYW1lIH19IGhhc1xuICAgICAgICAgIGJlZW4gY2FuY2VsZWQgc3VjY2Vzc2Z1bGx5PC9zcGFuXG4gICAgICAgID5cbiAgICAgIDwvbmctdGVtcGxhdGU+XG5cbiAgICA8L25nLWNvbnRhaW5lcj5cbiAgPC9uZy1jb250YWluZXI+XG48L2Rpdj5cblxuPGJiLWJpbGxwYXktcGF5bWVudHMtZGVsZXRlLW1vZGFsXG4qbmdJZj1cImlzRGVsZXRlTW9kYWxPcGVuZWRcIlxuKHJlc29sdmUpPVwib25Nb2RhbFJlc29sdmUoJGV2ZW50KVwiXG4+PC9iYi1iaWxscGF5LXBheW1lbnRzLWRlbGV0ZS1tb2RhbD5cblxuXG48bmctdGVtcGxhdGUgI25vdGlmaWNhdGlvbkhlYWRlcj5cbiAgPHNwYW5cbiAgICBjbGFzcz1cInRleHQtZGFya1wiXG4gICAgaTE4bj1cIlBheWVlIG5vdGlmaWNhdGlvbiBoZWFkZXJ8UGF5ZWUgY3JlYXRlZCBzdWNjZXNzIG5vdGlmaWNhdGlvbiBoZWFkZXJAQGJpbGxwYXktcGF5bWVudHMuZGV0YWlscy5ub3RpZmljYXRpb24uaGVhZGVyXCJcbiAgPlBheW1lbnQgY2FuY2VsZWQ8L3NwYW5cbj48L25nLXRlbXBsYXRlPlxuXG48bmctdGVtcGxhdGUgI2Vycm9yU3RhdGU+XG4gIDxkaXYgY2xhc3M9XCJjYXJkIGNhcmQtbGdcIj5cbiAgICA8ZGl2IGNsYXNzPVwiY2FyZC1ib2R5XCI+XG4gICAgICA8ZGl2IGNsYXNzPVwiYmItc3RhdGUtY29udGFpbmVyXCI+XG4gICAgICAgIDxiYi1lbXB0eS1zdGF0ZS11aVxuICAgICAgICAgIGRhdGEtcm9sZT1cImVycm9yLXN0YXRlXCJcbiAgICAgICAgICBpY29uU2l6ZT1cInh4bFwiXG4gICAgICAgICAgaWNvbk1vZGlmaWVyPVwiZXJyb3Itb3V0bGluZVwiXG4gICAgICAgICAgdGl0bGU9XCJQYXltZW50IGlzIG5vdCBsb2FkaW5nXCJcbiAgICAgICAgICBpMThuLXRpdGxlPVwiUGF5bWVudCBsaXN0IGlzIG5vdCBsb2FkaW5nIHRpdGxlQEBiaWxscGF5LXBheW1lbnRzLmRldGFpbHMuZXJyb3Itc3RhdGUudGl0bGVcIlxuICAgICAgICAgIHN1YnRpdGxlPVwiVHJ5IHRvIHJlbG9hZCB0aGUgcGFnZSBvciBjb250YWN0IHN1cHBvcnRcIlxuICAgICAgICAgIGkxOG4tc3VidGl0bGU9XCJQYXltZW50IGlzIG5vdCBsb2FkaW5nIHN1YnRpdGxlQEBiaWxscGF5LXBheW1lbnRzLmRldGFpbHMuZXJyb3Itc3RhdGUuc3VidGl0bGVcIlxuICAgICAgICA+XG4gICAgICAgIDwvYmItZW1wdHktc3RhdGUtdWk+XG4gICAgICA8L2Rpdj5cbiAgICA8L2Rpdj5cbiAgPC9kaXY+XG48L25nLXRlbXBsYXRlPlxuXG48bmctdGVtcGxhdGUgI2xvYWRpbmdTdGF0ZT5cbiAgPGRpdiBjbGFzcz1cImNhcmQgY2FyZC1sZ1wiPlxuICAgIDxkaXYgY2xhc3M9XCJjYXJkLWJvZHlcIj5cbiAgICAgIDxiYi1sb2FkaW5nLWluZGljYXRvci11aSBsb2FkZXJTaXplPVwibGdcIj4gPC9iYi1sb2FkaW5nLWluZGljYXRvci11aT5cbiAgICA8L2Rpdj5cbiAgPC9kaXY+XG48L25nLXRlbXBsYXRlPlxuIl19