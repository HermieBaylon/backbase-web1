import { Injectable } from '@angular/core';
import { BehaviorSubject, combineLatest, of, ReplaySubject } from 'rxjs';
import { catchError, distinctUntilChanged, map, scan, switchMap, take, tap } from 'rxjs/operators';
import { parseError } from './manage-account-error';
import { HttpResponseType, PaginationType, } from '@backbase/product-summary-common-ang';
import * as i0 from "@angular/core";
import * as i1 from "@backbase/data-ang/arrangements";
import * as i2 from "@backbase/ui-ang/notification";
const toDataServiceForVisibility = (state) => {
    let visibility = state.userPreferences ? state.userPreferences.visible : state.visible;
    visibility = visibility !== undefined ? visibility : state.visible;
    return {
        arrangementId: state.id,
        visible: !visibility,
    };
};
const toDataServiceForAlias = (alias, arrangementId) => ({
    arrangementId,
    alias,
});
/**
 * Service for fetching and storing the list of accounts
 *
 * This service relies on providers from `ProductSummaryManageAccountsWidgetModule`.
 *
 * @see ProductSummaryManageAccountsWidgetModule
 *
 * @usageNotes
 *
 * ### Ensure the ProductSummaryManageAccountsWidgetModule is imported to your component module
 *
 * ```ts
 * @NgModule({
 *   ...
 *   imports: [
 *     ...
 *     ProductSummaryManageAccountsWidgetModule,
 *   ],
 * })
 * export class MyWidgetModule {}
 * ```
 *
 * ### Inject this service into your component
 *
 * ```ts
 * @Component({
 *   ...
 *   providers: [ManageAccountsService],
 * })
 *  export class MyComponent {
 * ```
 */
export class ManageAccountsService {
    /**
     * Constructor
     *
     * @param productSummaryDataService
     * @param manageAccountDataService
     * @param notification
     */
    constructor(productSummaryDataService, manageAccountDataService, notification) {
        this.productSummaryDataService = productSummaryDataService;
        this.manageAccountDataService = manageAccountDataService;
        this.notification = notification;
        /**
         * If the fetching of the list failed, this property
         * holds the errors coming from the server
         */
        this.error = new BehaviorSubject(undefined);
        /**
         * If errors occurred during patching arrangements record,
         * holds the errors coming from the server
         */
        this.updateError = new BehaviorSubject(undefined);
        /**
         * Whether the widget is currently fetching data from the server
         */
        this.loading = new BehaviorSubject(true);
        this.revokingComplete = new BehaviorSubject(true);
        this.requestObject = new ReplaySubject(1);
        /**
         * Available product summary items.
         */
        this.accountList = combineLatest(this.requestObject, this.revokingComplete).pipe(distinctUntilChanged(), 
        // resetting error and loading values
        tap(() => this.error.next(undefined)), tap(() => this.loading.next(true)), switchMap(([requestObject]) => this.getAccountList(requestObject)), scan((acc, curr) => ({
            count: curr.count,
            items: this.mergeResponses(acc, curr),
            params: curr.params,
        })), catchError((error) => {
            this.error.next(error);
            return of(undefined);
        }), tap(() => this.loading.next(false)));
    }
    getAccountList(requestObject) {
        const from = requestObject.from || 0;
        const paginationType = requestObject.paginationType || '';
        const requestObjWithoutPaginationType = Object.assign({}, requestObject);
        delete requestObjWithoutPaginationType.paginationType;
        return this.productSummaryDataService
            .getArrangementsByBusinessFunction(requestObjWithoutPaginationType, HttpResponseType.RESPONSE)
            .pipe(map((res) => this.mapResponseWithCount(res, { from, paginationType })), catchError((error) => {
            throw parseError(error);
        }));
    }
    patchArrangementsRecord(accountUserPreferences, errorTemplateRef, successTemplateRef) {
        return this.manageAccountDataService.updateUserPreferences({ accountUserPreferences }).pipe(take(1), tap(() => this.revokingComplete.next(true)), tap(() => this.showNotification(successTemplateRef, 'success')), catchError((updateError) => {
            this.updateError.next(parseError(updateError));
            this.revokingComplete.next(true);
            this.showNotification(errorTemplateRef, 'error');
            return of(undefined);
        }));
    }
    /**
     * Toggles visibility of product summary item.
     *
     * @param request
     * @param errorTemplateRef
     * @param successTemplateRef
     */
    toggleVisibility(request, errorTemplateRef, successTemplateRef) {
        this.patchArrangementsRecord(toDataServiceForVisibility(request), errorTemplateRef, successTemplateRef).subscribe();
    }
    /**
     * Updates alias of product summary item, by id.
     *
     * @param arrangementId
     * @param alias
     * @param errorTemplateRef
     * @param successTemplateRef
     */
    updateAlias(arrangementId, alias, errorTemplateRef, successTemplateRef) {
        const payloadForAlias = toDataServiceForAlias(alias, arrangementId);
        this.patchArrangementsRecord(payloadForAlias, errorTemplateRef, successTemplateRef).subscribe();
    }
    /**
     * Subscribes the passed `requestObject` to the local `requestObject`
     *
     * @param requestObject
     */
    getAccountsFrom(requestObject) {
        requestObject.subscribe(this.requestObject);
    }
    showNotification(templateRef, modifier) {
        this.notification.showNotification({
            header: templateRef,
            message: '',
            modifier,
        });
    }
    mergeResponses(acc, current) {
        if (acc &&
            acc.items &&
            current &&
            current.items &&
            acc.params.paginationType === PaginationType.LOAD_MORE &&
            current.params.from !== 0) {
            return [...acc.items, ...current.items];
        }
        return current.items;
    }
    mapResponseWithCount(response, { from, paginationType }) {
        // eslint-disable-next-line no-null/no-null
        if (response.body === null) {
            throw new Error();
        }
        const headerCount = response.headers ? response.headers.get('x-total-count') : undefined;
        const counter = headerCount ? parseInt(headerCount, 10) : (response.body && response.body.length) || 0;
        return {
            count: counter,
            items: response.body || [],
            params: { from, paginationType },
        };
    }
}
ManageAccountsService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: ManageAccountsService, deps: [{ token: i1.ProductSummaryHttpService }, { token: i1.ArrangementsHttpService }, { token: i2.NotificationService }], target: i0.ɵɵFactoryTarget.Injectable });
ManageAccountsService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: ManageAccountsService });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: ManageAccountsService, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.ProductSummaryHttpService }, { type: i1.ArrangementsHttpService }, { type: i2.NotificationService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFuYWdlLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9saWJzL3Byb2R1Y3Qtc3VtbWFyeS1tYW5hZ2UtYWNjb3VudHMtd2lkZ2V0LWFuZy9zcmMvbWFuYWdlLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBZSxNQUFNLGVBQWUsQ0FBQztBQUV4RCxPQUFPLEVBQUUsZUFBZSxFQUFFLGFBQWEsRUFBYyxFQUFFLEVBQUUsYUFBYSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3JGLE9BQU8sRUFBRSxVQUFVLEVBQUUsb0JBQW9CLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBT25HLE9BQU8sRUFBRSxVQUFVLEVBQXNCLE1BQU0sd0JBQXdCLENBQUM7QUFFeEUsT0FBTyxFQUlMLGdCQUFnQixFQUNoQixjQUFjLEdBQ2YsTUFBTSxzQ0FBc0MsQ0FBQzs7OztBQUU5QyxNQUFNLDBCQUEwQixHQUFHLENBQUMsS0FBeUIsRUFBd0IsRUFBRTtJQUNyRixJQUFJLFVBQVUsR0FBRyxLQUFLLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQztJQUN2RixVQUFVLEdBQUcsVUFBVSxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDO0lBQ25FLE9BQU87UUFDTCxhQUFhLEVBQUUsS0FBSyxDQUFDLEVBQUU7UUFDdkIsT0FBTyxFQUFFLENBQUMsVUFBVTtLQUNyQixDQUFDO0FBQ0osQ0FBQyxDQUFDO0FBRUYsTUFBTSxxQkFBcUIsR0FBRyxDQUFDLEtBQWEsRUFBRSxhQUFxQixFQUEwQixFQUFFLENBQUMsQ0FBQztJQUMv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Q0FBQyxDQUFDLFNBQVMsQ0FBQztRQUN6RixNQUFNLE9BQU8sR0FBRyxXQUFXLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxXQUFXLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLElBQUksSUFBSSxRQUFRLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN2RyxPQUFPO1lBQ0wsS0FBSyxFQUFFLE9BQU87WUFDZCxLQUFLLEVBQUUsUUFBUSxDQUFDLElBQUksSUFBSSxFQUFFO1lBQzFCLE1BQU0sRUFBRSxFQUFFLElBQUksRUFBRSxjQUFjLEVBQUU7U0FDakMsQ0FBQztJQUNKLENBQUM7O21IQTNLVSxxQkFBcUI7dUhBQXJCLHFCQUFxQjs0RkFBckIscUJBQXFCO2tCQURqQyxVQUFVIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgVGVtcGxhdGVSZWYgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEh0dHBFcnJvclJlc3BvbnNlLCBIdHRwUmVzcG9uc2UgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QsIGNvbWJpbmVMYXRlc3QsIE9ic2VydmFibGUsIG9mLCBSZXBsYXlTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBjYXRjaEVycm9yLCBkaXN0aW5jdFVudGlsQ2hhbmdlZCwgbWFwLCBzY2FuLCBzd2l0Y2hNYXAsIHRha2UsIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7XG4gIEFycmFuZ2VtZW50c0h0dHBTZXJ2aWNlLFxuICBBY2NvdW50VXNlclByZWZlcmVuY2VzLFxuICBQcm9kdWN0U3VtbWFyeUh0dHBTZXJ2aWNlLFxufSBmcm9tICdAYmFja2Jhc2UvZGF0YS1hbmcvYXJyYW5nZW1lbnRzJztcbmltcG9ydCB7IE5vdGlmaWNhdGlvblNlcnZpY2UgfSBmcm9tICdAYmFja2Jhc2UvdWktYW5nL25vdGlmaWNhdGlvbic7XG5pbXBvcnQgeyBwYXJzZUVycm9yLCBNYW5hZ2VBY2NvdW50RXJyb3IgfSBmcm9tICcuL21hbmFnZS1hY2NvdW50LWVycm9yJztcbmltcG9ydCB7IEdldEFycmFuZ2VtZW50c1JlcXVlc3RQYXJhbXMsIFVwZGF0ZVZpc2liaWxpdHlJdGVtIH0gZnJvbSAnLi9tb2RlbC90eXBlcyc7XG5pbXBvcnQge1xuICBBY2NvdW50cyxcbiAgUHJvZHVjdFN1bW1hcnlJdGVtLFxuICBHZXRQcm9kdWN0c3VtbWFyeVJlcXVlc3QsXG4gIEh0dHBSZXNwb25zZVR5cGUsXG4gIFBhZ2luYXRpb25UeXBlLFxufSBmcm9tICdAYmFja2Jhc2UvcHJvZHVjdC1zdW1tYXJ5LWNvbW1vbi1hbmcnO1xuXG5jb25zdCB0b0RhdGFTZXJ2aWNlRm9yVmlzaWJpbGl0eSA9IChzdGF0ZTogUHJvZHVjdFN1bW1hcnlJdGVtKTogVXBkYXRlVmlzaWJpbGl0eUl0ZW0gPT4ge1xuICBsZXQgdmlzaWJpbGl0eSA9IHN0YXRlLnVzZXJQcmVmZXJlbmNlcyA/IHN0YXRlLnVzZXJQcmVmZXJlbmNlcy52aXNpYmxlIDogc3RhdGUudmlzaWJsZTtcbiAgdmlzaWJpbGl0eSA9IHZpc2liaWxpdHkgIT09IHVuZGVmaW5lZCA/IHZpc2liaWxpdHkgOiBzdGF0ZS52aXNpYmxlO1xuICByZXR1cm4ge1xuICAgIGFycmFuZ2VtZW50SWQ6IHN0YXRlLmlkLFxuICAgIHZpc2libGU6ICF2aXNpYmlsaXR5LFxuICB9O1xufTtcblxuY29uc3QgdG9EYXRhU2VydmljZUZvckFsaWFzID0gKGFsaWFzOiBzdHJpbmcsIGFycmFuZ2VtZW50SWQ6IHN0cmluZyk6IEFjY291bnRVc2VyUHJlZmVyZW5jZXMgPT4gKHtcbiAgYXJyYW5nZW1lbnRJZCxcbiAgYWxpYXMsXG59KTtcblxuLyoqXG4gKiBTZXJ2aWNlIGZvciBmZXRjaGluZyBhbmQgc3RvcmluZyB0aGUgbGlzdCBvZiBhY2NvdW50c1xuICpcbiAqIFRoaXMgc2VydmljZSByZWxpZXMgb24gcHJvdmlkZXJzIGZyb20gYFByb2R1Y3RTdW1tYXJ5TWFuYWdlQWNjb3VudHNXaWRnZXRNb2R1bGVgLlxuICpcbiAqIEBzZWUgUHJvZHVjdFN1bW1hcnlNYW5hZ2VBY2NvdW50c1dpZGdldE1vZHVsZVxuICpcbiAqIEB1c2FnZU5vdGVzXG4gKlxuICogIyMjIEVuc3VyZSB0aGUgUHJvZHVjdFN1bW1hcnlNYW5hZ2VBY2NvdW50c1dpZGdldE1vZHVsZSBpcyBpbXBvcnRlZCB0byB5b3VyIGNvbXBvbmVudCBtb2R1bGVcbiAqXG4gKiBgYGB0c1xuICogQE5nTW9kdWxlKHtcbiAqICAgLi4uXG4gKiAgIGltcG9ydHM6IFtcbiAqICAgICAuLi5cbiAqICAgICBQcm9kdWN0U3VtbWFyeU1hbmFnZUFjY291bnRzV2lkZ2V0TW9kdWxlLFxuICogICBdLFxuICogfSlcbiAqIGV4cG9ydCBjbGFzcyBNeVdpZGdldE1vZHVsZSB7fVxuICogYGBgXG4gKlxuICogIyMjIEluamVjdCB0aGlzIHNlcnZpY2UgaW50byB5b3VyIGNvbXBvbmVudFxuICpcbiAqIGBgYHRzXG4gKiBAQ29tcG9uZW50KHtcbiAqICAgLi4uXG4gKiAgIHByb3ZpZGVyczogW01hbmFnZUFjY291bnRzU2VydmljZV0sXG4gKiB9KVxuICogIGV4cG9ydCBjbGFzcyBNeUNvbXBvbmVudCB7XG4gKiBgYGBcbiAqL1xuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIE1hbmFnZUFjY291bnRzU2VydmljZSB7XG4gIC8qKlxuICAgKiBDb25zdHJ1Y3RvclxuICAgKlxuICAgKiBAcGFyYW0gcHJvZHVjdFN1bW1hcnlEYXRhU2VydmljZVxuICAgKiBAcGFyYW0gbWFuYWdlQWNjb3VudERhdGFTZXJ2aWNlXG4gICAqIEBwYXJhbSBub3RpZmljYXRpb25cbiAgICovXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgcHJvZHVjdFN1bW1hcnlEYXRhU2VydmljZTogUHJvZHVjdFN1bW1hcnlIdHRwU2VydmljZSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IG1hbmFnZUFjY291bnREYXRhU2VydmljZTogQXJyYW5nZW1lbnRzSHR0cFNlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSBub3RpZmljYXRpb246IE5vdGlmaWNhdGlvblNlcnZpY2UsXG4gICkge31cblxuICAvKipcbiAgICogSWYgdGhlIGZldGNoaW5nIG9mIHRoZSBsaXN0IGZhaWxlZCwgdGhpcyBwcm9wZXJ0eVxuICAgKiBob2xkcyB0aGUgZXJyb3JzIGNvbWluZyBmcm9tIHRoZSBzZXJ2ZXJcbiAgICovXG4gIHJlYWRvbmx5IGVycm9yID0gbmV3IEJlaGF2aW9yU3ViamVjdDxNYW5hZ2VBY2NvdW50RXJyb3IgfCB1bmRlZmluZWQ+KHVuZGVmaW5lZCk7XG4gIC8qKlxuICAgKiBJZiBlcnJvcnMgb2NjdXJyZWQgZHVyaW5nIHBhdGNoaW5nIGFycmFuZ2VtZW50cyByZWNvcmQsXG4gICAqIGhvbGRzIHRoZSBlcnJvcnMgY29taW5nIGZyb20gdGhlIHNlcnZlclxuICAgKi9cbiAgcmVhZG9ubHkgdXBkYXRlRXJyb3IgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PE1hbmFnZUFjY291bnRFcnJvciB8IHVuZGVmaW5lZD4odW5kZWZpbmVkKTtcbiAgLyoqXG4gICAqIFdoZXRoZXIgdGhlIHdpZGdldCBpcyBjdXJyZW50bHkgZmV0Y2hpbmcgZGF0YSBmcm9tIHRoZSBzZXJ2ZXJcbiAgICovXG4gIHJlYWRvbmx5IGxvYWRpbmcgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PGJvb2xlYW4+KHRydWUpO1xuXG4gIHByaXZhdGUgcmVhZG9ubHkgcmV2b2tpbmdDb21wbGV0ZSA9IG5ldyBCZWhhdmlvclN1YmplY3Q8Ym9vbGVhbj4odHJ1ZSk7XG4gIHByaXZhdGUgcmVhZG9ubHkgcmVxdWVzdE9iamVjdCA9IG5ldyBSZXBsYXlTdWJqZWN0PEdldEFycmFuZ2VtZW50c1JlcXVlc3RQYXJhbXM+KDEpO1xuICAvKipcbiAgICogQXZhaWxhYmxlIHByb2R1Y3Qgc3VtbWFyeSBpdGVtcy5cbiAgICovXG4gIHJlYWRvbmx5IGFjY291bnRMaXN0OiBPYnNlcnZhYmxlPEFjY291bnRzIHwgdW5kZWZpbmVkPiA9IGNvbWJpbmVMYXRlc3QoXG4gICAgdGhpcy5yZXF1ZXN0T2JqZWN0LFxuICAgIHRoaXMucmV2b2tpbmdDb21wbGV0ZSxcbiAgKS5waXBlKFxuICAgIGRpc3RpbmN0VW50aWxDaGFuZ2VkKCksXG4gICAgLy8gcmVzZXR0aW5nIGVycm9yIGFuZCBsb2FkaW5nIHZhbHVlc1xuICAgIHRhcCgoKSA9PiB0aGlzLmVycm9yLm5leHQodW5kZWZpbmVkKSksXG4gICAgdGFwKCgpID0+IHRoaXMubG9hZGluZy5uZXh0KHRydWUpKSxcbiAgICBzd2l0Y2hNYXAoKFtyZXF1ZXN0T2JqZWN0XSkgPT4gdGhpcy5nZXRBY2NvdW50TGlzdChyZXF1ZXN0T2JqZWN0KSksXG4gICAgc2NhbihcbiAgICAgIChhY2M6IEFjY291bnRzLCBjdXJyOiBBY2NvdW50cyk6IEFjY291bnRzID0+ICh7XG4gICAgICAgIGNvdW50OiBjdXJyLmNvdW50LFxuICAgICAgICBpdGVtczogdGhpcy5tZXJnZVJlc3BvbnNlcyhhY2MsIGN1cnIpLFxuICAgICAgICBwYXJhbXM6IGN1cnIucGFyYW1zLFxuICAgICAgfSksXG4gICAgKSxcbiAgICBjYXRjaEVycm9yKChlcnJvcjogTWFuYWdlQWNjb3VudEVycm9yKSA9PiB7XG4gICAgICB0aGlzLmVycm9yLm5leHQoZXJyb3IpO1xuICAgICAgcmV0dXJuIG9mKHVuZGVmaW5lZCk7XG4gICAgfSksXG4gICAgdGFwKCgpID0+IHRoaXMubG9hZGluZy5uZXh0KGZhbHNlKSksXG4gICk7XG5cbiAgcHJpdmF0ZSBnZXRBY2NvdW50TGlzdChyZXF1ZXN0T2JqZWN0OiBHZXRQcm9kdWN0c3VtbWFyeVJlcXVlc3QpOiBPYnNlcnZhYmxlPEFjY291bnRzPiB7XG4gICAgY29uc3QgZnJvbSA9IHJlcXVlc3RPYmplY3QuZnJvbSB8fCAwO1xuXG4gICAgY29uc3QgcGFnaW5hdGlvblR5cGUgPSByZXF1ZXN0T2JqZWN0LnBhZ2luYXRpb25UeXBlIHx8ICcnO1xuICAgIGNvbnN0IHJlcXVlc3RPYmpXaXRob3V0UGFnaW5hdGlvblR5cGUgPSB7IC4uLnJlcXVlc3RPYmplY3QgfTtcbiAgICBkZWxldGUgcmVxdWVzdE9ialdpdGhvdXRQYWdpbmF0aW9uVHlwZS5wYWdpbmF0aW9uVHlwZTtcblxuICAgIHJldHVybiB0aGlzLnByb2R1Y3RTdW1tYXJ5RGF0YVNlcnZpY2VcbiAgICAgIC5nZXRBcnJhbmdlbWVudHNCeUJ1c2luZXNzRnVuY3Rpb24ocmVxdWVzdE9ialdpdGhvdXRQYWdpbmF0aW9uVHlwZSwgSHR0cFJlc3BvbnNlVHlwZS5SRVNQT05TRSlcbiAgICAgIC5waXBlKFxuICAgICAgICBtYXAoKHJlczogSHR0cFJlc3BvbnNlPFByb2R1Y3RTdW1tYXJ5SXRlbVtdPikgPT4gdGhpcy5tYXBSZXNwb25zZVdpdGhDb3VudChyZXMsIHsgZnJvbSwgcGFnaW5hdGlvblR5cGUgfSkpLFxuICAgICAgICBjYXRjaEVycm9yKChlcnJvcjogSHR0cEVycm9yUmVzcG9uc2UpID0+IHtcbiAgICAgICAgICB0aHJvdyBwYXJzZUVycm9yKGVycm9yKTtcbiAgICAgICAgfSksXG4gICAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBwYXRjaEFycmFuZ2VtZW50c1JlY29yZChcbiAgICBhY2NvdW50VXNlclByZWZlcmVuY2VzOiBBY2NvdW50VXNlclByZWZlcmVuY2VzLFxuICAgIGVycm9yVGVtcGxhdGVSZWY6IFRlbXBsYXRlUmVmPGFueT4gfCBzdHJpbmcsXG4gICAgc3VjY2Vzc1RlbXBsYXRlUmVmOiBUZW1wbGF0ZVJlZjxhbnk+IHwgc3RyaW5nLFxuICApOiBPYnNlcnZhYmxlPEh0dHBSZXNwb25zZTxhbnk+IHwgdW5kZWZpbmVkPiB7XG4gICAgcmV0dXJuIHRoaXMubWFuYWdlQWNjb3VudERhdGFTZXJ2aWNlLnVwZGF0ZVVzZXJQcmVmZXJlbmNlcyh7IGFjY291bnRVc2VyUHJlZmVyZW5jZXMgfSkucGlwZShcbiAgICAgIHRha2UoMSksXG4gICAgICB0YXAoKCkgPT4gdGhpcy5yZXZva2luZ0NvbXBsZXRlLm5leHQodHJ1ZSkpLFxuICAgICAgdGFwKCgpID0+IHRoaXMuc2hvd05vdGlmaWNhdGlvbihzdWNjZXNzVGVtcGxhdGVSZWYsICdzdWNjZXNzJykpLFxuICAgICAgY2F0Y2hFcnJvcigodXBkYXRlRXJyb3I6IEh0dHBFcnJvclJlc3BvbnNlKSA9PiB7XG4gICAgICAgIHRoaXMudXBkYXRlRXJyb3IubmV4dChwYXJzZUVycm9yKHVwZGF0ZUVycm9yKSk7XG4gICAgICAgIHRoaXMucmV2b2tpbmdDb21wbGV0ZS5uZXh0KHRydWUpO1xuICAgICAgICB0aGlzLnNob3dOb3RpZmljYXRpb24oZXJyb3JUZW1wbGF0ZVJlZiwgJ2Vycm9yJyk7XG4gICAgICAgIHJldHVybiBvZih1bmRlZmluZWQpO1xuICAgICAgfSksXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUb2dnbGVzIHZpc2liaWxpdHkgb2YgcHJvZHVjdCBzdW1tYXJ5IGl0ZW0uXG4gICAqXG4gICAqIEBwYXJhbSByZXF1ZXN0XG4gICAqIEBwYXJhbSBlcnJvclRlbXBsYXRlUmVmXG4gICAqIEBwYXJhbSBzdWNjZXNzVGVtcGxhdGVSZWZcbiAgICovXG4gIHRvZ2dsZVZpc2liaWxpdHkoXG4gICAgcmVxdWVzdDogUHJvZHVjdFN1bW1hcnlJdGVtLFxuICAgIGVycm9yVGVtcGxhdGVSZWY6IFRlbXBsYXRlUmVmPGFueT4gfCBzdHJpbmcsXG4gICAgc3VjY2Vzc1RlbXBsYXRlUmVmOiBUZW1wbGF0ZVJlZjxhbnk+IHwgc3RyaW5nLFxuICApIHtcbiAgICB0aGlzLnBhdGNoQXJyYW5nZW1lbnRzUmVjb3JkKHRvRGF0YVNlcnZpY2VGb3JWaXNpYmlsaXR5KHJlcXVlc3QpLCBlcnJvclRlbXBsYXRlUmVmLCBzdWNjZXNzVGVtcGxhdGVSZWYpLnN1YnNjcmliZSgpO1xuICB9XG5cbiAgLyoqXG4gICAqIFVwZGF0ZXMgYWxpYXMgb2YgcHJvZHVjdCBzdW1tYXJ5IGl0ZW0sIGJ5IGlkLlxuICAgKlxuICAgKiBAcGFyYW0gYXJyYW5nZW1lbnRJZFxuICAgKiBAcGFyYW0gYWxpYXNcbiAgICogQHBhcmFtIGVycm9yVGVtcGxhdGVSZWZcbiAgICogQHBhcmFtIHN1Y2Nlc3NUZW1wbGF0ZVJlZlxuICAgKi9cbiAgdXBkYXRlQWxpYXMoXG4gICAgYXJyYW5nZW1lbnRJZDogc3RyaW5nLFxuICAgIGFsaWFzOiBzdHJpbmcsXG4gICAgZXJyb3JUZW1wbGF0ZVJlZjogVGVtcGxhdGVSZWY8YW55PiB8IHN0cmluZyxcbiAgICBzdWNjZXNzVGVtcGxhdGVSZWY6IFRlbXBsYXRlUmVmPGFueT4gfCBzdHJpbmcsXG4gICkge1xuICAgIGNvbnN0IHBheWxvYWRGb3JBbGlhcyA9IHRvRGF0YVNlcnZpY2VGb3JBbGlhcyhhbGlhcywgYXJyYW5nZW1lbnRJZCk7XG4gICAgdGhpcy5wYXRjaEFycmFuZ2VtZW50c1JlY29yZChwYXlsb2FkRm9yQWxpYXMsIGVycm9yVGVtcGxhdGVSZWYsIHN1Y2Nlc3NUZW1wbGF0ZVJlZikuc3Vic2NyaWJlKCk7XG4gIH1cblxuICAvKipcbiAgICogU3Vic2NyaWJlcyB0aGUgcGFzc2VkIGByZXF1ZXN0T2JqZWN0YCB0byB0aGUgbG9jYWwgYHJlcXVlc3RPYmplY3RgXG4gICAqXG4gICAqIEBwYXJhbSByZXF1ZXN0T2JqZWN0XG4gICAqL1xuICBnZXRBY2NvdW50c0Zyb20ocmVxdWVzdE9iamVjdDogT2JzZXJ2YWJsZTxHZXRBcnJhbmdlbWVudHNSZXF1ZXN0UGFyYW1zPikge1xuICAgIHJlcXVlc3RPYmplY3Quc3Vic2NyaWJlKHRoaXMucmVxdWVzdE9iamVjdCk7XG4gIH1cblxuICBwcml2YXRlIHNob3dOb3RpZmljYXRpb24odGVtcGxhdGVSZWY6IFRlbXBsYXRlUmVmPGFueT4gfCBzdHJpbmcsIG1vZGlmaWVyOiAnc3VjY2VzcycgfCAnZXJyb3InKSB7XG4gICAgdGhpcy5ub3RpZmljYXRpb24uc2hvd05vdGlmaWNhdGlvbih7XG4gICAgICBoZWFkZXI6IHRlbXBsYXRlUmVmLFxuICAgICAgbWVzc2FnZTogJycsXG4gICAgICBtb2RpZmllcixcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgbWVyZ2VSZXNwb25zZXMoYWNjOiBBY2NvdW50cywgY3VycmVudDogQWNjb3VudHMpOiBQcm9kdWN0U3VtbWFyeUl0ZW1bXSB7XG4gICAgaWYgKFxuICAgICAgYWNjICYmXG4gICAgICBhY2MuaXRlbXMgJiZcbiAgICAgIGN1cnJlbnQgJiZcbiAgICAgIGN1cnJlbnQuaXRlbXMgJiZcbiAgICAgIGFjYy5wYXJhbXMucGFnaW5hdGlvblR5cGUgPT09IFBhZ2luYXRpb25UeXBlLkxPQURfTU9SRSAmJlxuICAgICAgY3VycmVudC5wYXJhbXMuZnJvbSAhPT0gMFxuICAgICkge1xuICAgICAgcmV0dXJuIFsuLi5hY2MuaXRlbXMsIC4uLmN1cnJlbnQuaXRlbXNdO1xuICAgIH1cbiAgICByZXR1cm4gY3VycmVudC5pdGVtcztcbiAgfVxuXG4gIHByaXZhdGUgbWFwUmVzcG9uc2VXaXRoQ291bnQoXG4gICAgcmVzcG9uc2U6IEh0dHBSZXNwb25zZTxQcm9kdWN0U3VtbWFyeUl0ZW1bXT4sXG4gICAgeyBmcm9tLCBwYWdpbmF0aW9uVHlwZSB9OiB7IGZyb206IG51bWJlcjsgcGFnaW5hdGlvblR5cGU6IFBhZ2luYXRpb25UeXBlIHwgc3RyaW5nIH0sXG4gICk6IEFjY291bnRzIHtcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tbnVsbC9uby1udWxsXG4gICAgaWYgKHJlc3BvbnNlLmJvZHkgPT09IG51bGwpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcigpO1xuICAgIH1cbiAgICBjb25zdCBoZWFkZXJDb3VudCA9IHJlc3BvbnNlLmhlYWRlcnMgPyByZXNwb25zZS5oZWFkZXJzLmdldCgneC10b3RhbC1jb3VudCcpIDogdW5kZWZpbmVkO1xuICAgIGNvbnN0IGNvdW50ZXIgPSBoZWFkZXJDb3VudCA/IHBhcnNlSW50KGhlYWRlckNvdW50LCAxMCkgOiAocmVzcG9uc2UuYm9keSAmJiByZXNwb25zZS5ib2R5Lmxlbmd0aCkgfHwgMDtcbiAgICByZXR1cm4ge1xuICAgICAgY291bnQ6IGNvdW50ZXIsXG4gICAgICBpdGVtczogcmVzcG9uc2UuYm9keSB8fCBbXSxcbiAgICAgIHBhcmFtczogeyBmcm9tLCBwYWdpbmF0aW9uVHlwZSB9LFxuICAgIH07XG4gIH1cbn1cbiJdfQ==