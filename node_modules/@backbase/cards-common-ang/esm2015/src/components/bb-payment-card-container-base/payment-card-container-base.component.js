import { Directive, EventEmitter, Input, Output } from '@angular/core';
import { PaymentCardLockStatus } from '../../model/payment-card.model';
import * as i0 from "@angular/core";
import * as i1 from "../../services/cards.service";
import * as i2 from "@backbase/ui-ang/notification";
const baseNotification = {
    header: '',
    message: '',
    dismissible: true,
    modifier: 'success',
};
// eslint-disable-next-line
export class PaymentCardContainerBase {
    constructor(cardsService, cd, notificationService) {
        this.cardsService = cardsService;
        this.cd = cd;
        this.notificationService = notificationService;
        /**
         * Notification messages translations
         */
        this.localizations = {
            activationErrorHeader: '',
            activationErrorMessage: '',
            activationSuccessHeader: '',
            lockErrorHeader: '',
            lockErrorMessage: '',
            lockSuccessHeader: '',
            lockSuccessMessage: '',
            replacementErrorHeader: '',
            replacementErrorMessage: '',
            replacementSuccessHeader: '',
            replacementSuccessMessage: '',
            requestNewPinSuccessMessage: '',
            requestPinErrorMessage: '',
            resetPinSuccessMessage: '',
            resetPinErrorMessage: '',
            resetInvalidPinMessage: '',
            unlockErrorHeader: '',
            unlockErrorMessage: '',
            unlockSuccessHeader: '',
            unlockSuccessMessage: '',
            updateLimitErrorHeader: '',
            updateLimitErrorMessage: '',
            updateLimitSuccessHeader: '',
            updateLimitSuccessMessage: '',
        };
        /**
         * Event emitter for selecting a card.
         */
        this.selectCard = new EventEmitter();
        this.isLockLoading = false;
        this.isInitiateReplacementLoading = false;
        this.isInitiateActivationLoading = false;
        this.isResetPinLoading = false;
        this.isLimitsLoading = false;
    }
    showNotification(notification) {
        this.notificationService.showNotification(Object.assign(Object.assign(Object.assign({}, baseNotification), { ttl: this.notificationTtl }), notification));
    }
    ngOnInit() {
        if (typeof this.paymentCard === 'undefined') {
            throw new Error(`"paymentCard" input is required in "${this.constructor.name}"`);
        }
    }
    onUpdateLockStatus(lockStatus) {
        if (typeof this.paymentCard === 'undefined') {
            return;
        }
        this.isLockLoading = true;
        const onUpdateLockStatusSuccess = (paymentCard) => {
            if (typeof this.paymentCard !== 'undefined') {
                this.paymentCard = paymentCard;
                const header = lockStatus === PaymentCardLockStatus.Locked
                    ? this.localizations.lockSuccessHeader
                    : this.localizations.unlockSuccessHeader;
                const message = lockStatus === PaymentCardLockStatus.Locked
                    ? this.localizations.lockSuccessMessage
                    : this.localizations.unlockSuccessMessage;
                this.showNotification({
                    header,
                    message,
                });
            }
        };
        const onUpdateLockStatusError = () => {
            if (typeof this.paymentCard !== 'undefined') {
                const header = lockStatus === PaymentCardLockStatus.Locked
                    ? this.localizations.lockErrorHeader
                    : this.localizations.unlockErrorHeader;
                const message = lockStatus === PaymentCardLockStatus.Locked
                    ? this.localizations.lockErrorMessage
                    : this.localizations.unlockErrorMessage;
                this.showNotification({
                    header,
                    message,
                    modifier: 'error',
                });
            }
            this.isLockLoading = false;
            this.cd.markForCheck();
        };
        const onUpdateLockStatusComplete = () => {
            this.isLockLoading = false;
            this.cd.markForCheck();
        };
        this.cardsService
            .updateLockStatus(this.paymentCard, lockStatus)
            .subscribe(onUpdateLockStatusSuccess, onUpdateLockStatusError, onUpdateLockStatusComplete);
    }
    onInitiateReplacement(reason) {
        if (typeof this.paymentCard === 'undefined') {
            return;
        }
        this.isInitiateReplacementLoading = true;
        const onInitiateReplacementSuccess = (paymentCard) => {
            if (typeof this.paymentCard !== 'undefined') {
                this.paymentCard = paymentCard;
                this.showNotification({
                    header: this.localizations.replacementSuccessHeader,
                    message: this.localizations.replacementSuccessMessage,
                });
            }
        };
        const onInitiateReplacementError = () => {
            if (typeof this.paymentCard !== 'undefined') {
                this.showNotification({
                    header: this.localizations.replacementErrorHeader,
                    message: this.localizations.replacementErrorMessage,
                    modifier: 'error',
                });
            }
            this.isInitiateReplacementLoading = false;
            this.cd.markForCheck();
        };
        const onInitiateReplacementComplete = () => {
            this.isInitiateReplacementLoading = false;
            this.cd.markForCheck();
        };
        this.cardsService
            .initiateReplacement(this.paymentCard, reason)
            .subscribe(onInitiateReplacementSuccess, onInitiateReplacementError, onInitiateReplacementComplete);
    }
    onInitiateActivation(token) {
        if (typeof this.paymentCard === 'undefined') {
            return;
        }
        this.isInitiateActivationLoading = true;
        const onInitiateActivationSuccess = (paymentCard) => {
            if (typeof this.paymentCard !== 'undefined') {
                this.paymentCard = paymentCard;
                this.showNotification({
                    header: this.localizations.activationSuccessHeader,
                });
            }
        };
        const onInitiateActivationError = () => {
            if (typeof this.paymentCard !== 'undefined') {
                this.showNotification({
                    header: this.localizations.activationErrorHeader,
                    message: this.localizations.activationErrorMessage,
                    modifier: 'error',
                });
            }
            this.isInitiateActivationLoading = false;
            this.cd.markForCheck();
        };
        const onInitiateActivationComplete = () => {
            this.isInitiateActivationLoading = false;
            this.cd.markForCheck();
        };
        this.cardsService
            .initiateActivation(this.paymentCard, token)
            .subscribe(onInitiateActivationSuccess, onInitiateActivationError, onInitiateActivationComplete);
    }
    onUpdateLimit(limit) {
        if (typeof this.paymentCard === 'undefined') {
            return;
        }
        this.isLimitsLoading = true;
        const onUpdateLimitSuccess = (paymentCard) => {
            if (typeof this.paymentCard !== 'undefined') {
                this.paymentCard = paymentCard;
                this.showNotification({
                    header: this.localizations.updateLimitSuccessHeader,
                    message: this.localizations.updateLimitSuccessMessage,
                });
            }
        };
        const onUpdateLimitError = () => {
            if (typeof this.paymentCard !== 'undefined') {
                this.notificationService.showNotification(Object.assign(Object.assign({}, baseNotification), { header: this.localizations.updateLimitErrorHeader, message: this.localizations.updateLimitErrorMessage, modifier: 'error' }));
            }
            this.isLimitsLoading = false;
            this.cd.markForCheck();
        };
        const onUpdateLimitComplete = () => {
            this.isLimitsLoading = false;
            this.cd.markForCheck();
        };
        this.cardsService
            .updateLimit(this.paymentCard, limit, this.updateAllLimits)
            .subscribe(onUpdateLimitSuccess, onUpdateLimitError, onUpdateLimitComplete);
    }
    onResetPin(token) {
        if (typeof this.paymentCard === 'undefined') {
            return;
        }
        this.isResetPinLoading = true;
        if (token.raw.pin2 !== undefined && token.raw.pin !== token.raw.pin2) {
            this.isResetPinLoading = false;
            this.showNotification({
                message: this.localizations.resetInvalidPinMessage,
                modifier: 'error',
            });
            return;
        }
        const onResetPinSuccess = (paymentCard) => {
            if (typeof this.paymentCard !== 'undefined') {
                this.paymentCard = paymentCard;
                this.showNotification({
                    message: this.localizations.resetPinSuccessMessage,
                });
            }
        };
        const onResetPinError = () => {
            if (typeof this.paymentCard !== 'undefined') {
                this.showNotification({
                    message: this.localizations.resetPinErrorMessage,
                    modifier: 'error',
                });
            }
            this.isResetPinLoading = false;
            this.cd.markForCheck();
        };
        const onResetPinComplete = () => {
            this.isResetPinLoading = false;
            this.cd.markForCheck();
        };
        this.cardsService
            .resetPIN(this.paymentCard, token.model)
            .subscribe(onResetPinSuccess, onResetPinError, onResetPinComplete);
    }
    onRequestPin(token) {
        if (typeof this.paymentCard === 'undefined') {
            return;
        }
        this.isResetPinLoading = true;
        const onRequestPinSuccess = (paymentCard) => {
            if (typeof this.paymentCard !== 'undefined') {
                this.paymentCard = paymentCard;
                this.showNotification({
                    message: this.localizations.requestNewPinSuccessMessage,
                });
            }
        };
        const onRequestPinError = () => {
            if (typeof this.paymentCard !== 'undefined') {
                this.showNotification({
                    message: this.localizations.requestPinErrorMessage,
                    modifier: 'error',
                });
            }
            this.isResetPinLoading = false;
            this.cd.markForCheck();
        };
        const onRequestPinComplete = () => {
            this.isResetPinLoading = false;
            this.cd.markForCheck();
        };
        this.cardsService
            .requestPIN(this.paymentCard, token.model)
            .subscribe(onRequestPinSuccess, onRequestPinError, onRequestPinComplete);
    }
    onOpenDetails() {
        if (typeof this.paymentCard !== 'undefined') {
            this.selectCard.emit(this.paymentCard);
        }
    }
}
PaymentCardContainerBase.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.15", ngImport: i0, type: PaymentCardContainerBase, deps: [{ token: i1.CardsService }, { token: i0.ChangeDetectorRef }, { token: i2.NotificationService }], target: i0.ɵɵFactoryTarget.Directive });
PaymentCardContainerBase.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "12.0.0", version: "12.2.15", type: PaymentCardContainerBase, inputs: { paymentCard: "paymentCard", notificationTtl: "notificationTtl", updateAllLimits: "updateAllLimits" }, outputs: { selectCard: "selectCard" }, ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.15", ngImport: i0, type: PaymentCardContainerBase, decorators: [{
            type: Directive
        }], ctorParameters: function () { return [{ type: i1.CardsService }, { type: i0.ChangeDetectorRef }, { type: i2.NotificationService }]; }, propDecorators: { paymentCard: [{
                type: Input
            }], notificationTtl: [{
                type: Input
            }], updateAllLimits: [{
                type: Input
            }], selectCard: [{
                type: Output
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGF5bWVudC1jYXJkLWNvbnRhaW5lci1iYXNlLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL2xpYnMvY2FyZHMtY29tbW9uLWFuZy9zcmMvY29tcG9uZW50cy9iYi1wYXltZW50LWNhcmQtY29udGFpbmVyLWJhc2UvcGF5bWVudC1jYXJkLWNvbnRhaW5lci1iYXNlLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQXFCLFNBQVMsRUFBRSxZQUFZLEVBQUUsS0FBSyxFQUFVLE1BQU0sRUFBZSxNQUFNLGVBQWUsQ0FBQztBQUsvRyxPQUFPLEVBQWUscUJBQXFCLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQzs7OztBQUdwRixNQUFNLGdCQUFnQixHQUFpQjtJQUNyQyxNQUFNLEVBQUUsRUFBRTtJQUNWLE9BQU8sRUFBRSxFQUFFO0lBQ1gsV0FBVyxFQUFFLElBQUk7SUFDakIsUUFBUSxFQUFFLFNBQVM7Q0FDcEIsQ0FBQztBQUdGLDJCQUEyQjtBQUMzQixNQUFNLE9BQU8sd0JBQXdCO0lBaURuQyxZQUNxQixZQUEwQixFQUMxQixFQUFxQixFQUNyQixtQkFBd0M7UUFGeEMsaUJBQVksR0FBWixZQUFZLENBQWM7UUFDMUIsT0FBRSxHQUFGLEVBQUUsQ0FBbUI7UUFDckIsd0JBQW1CLEdBQW5CLG1CQUFtQixDQUFxQjtRQW5EN0Q7O1dBRUc7UUFFTyxrQkFBYSxHQUFpRDtZQUN0RSxxQkFBcUIsRUFBRSxFQUFFO1lBQ3pCLHNCQUFzQixFQUFFLEVBQUU7WUFDMUIsdUJBQXVCLEVBQUUsRUFBRTtZQUMzQixlQUFlLEVBQUUsRUFBRTtZQUNuQixnQkFBZ0IsRUFBRSxFQUFFO1lBQ3BCLGlCQUFpQixFQUFFLEVBQUU7WUFDckIsa0JBQWtCLEVBQUUsRUFBRTtZQUN0QixzQkFBc0IsRUFBRSxFQUFFO1lBQzFCLHVCQUF1QixFQUFFLEVBQUU7WUFDM0Isd0JBQXdCLEVBQUUs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QyxJQUFJLENBQUMsV0FBVyxFQUFFLEtBQUssQ0FBQyxLQUFLLENBQUM7YUFDekMsU0FBUyxDQUFDLG1CQUFtQixFQUFFLGlCQUFpQixFQUFFLG9CQUFvQixDQUFDLENBQUM7SUFDN0UsQ0FBQztJQUVELGFBQWE7UUFDWCxJQUFJLE9BQU8sSUFBSSxDQUFDLFdBQVcsS0FBSyxXQUFXLEVBQUU7WUFDM0MsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1NBQ3hDO0lBQ0gsQ0FBQzs7c0hBbFZVLHdCQUF3QjswR0FBeEIsd0JBQXdCOzRGQUF4Qix3QkFBd0I7a0JBRnBDLFNBQVM7cUtBb0NDLFdBQVc7c0JBQW5CLEtBQUs7Z0JBRUcsZUFBZTtzQkFBdkIsS0FBSztnQkFDRyxlQUFlO3NCQUF2QixLQUFLO2dCQUlhLFVBQVU7c0JBQTVCLE1BQU0iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDaGFuZ2VEZXRlY3RvclJlZiwgRGlyZWN0aXZlLCBFdmVudEVtaXR0ZXIsIElucHV0LCBPbkluaXQsIE91dHB1dCwgVGVtcGxhdGVSZWYgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE5vdGlmaWNhdGlvbiwgTm90aWZpY2F0aW9uU2VydmljZSB9IGZyb20gJ0BiYWNrYmFzZS91aS1hbmcvbm90aWZpY2F0aW9uJztcbmltcG9ydCB7IFBheW1lbnRDYXJkTGltaXQgfSBmcm9tICcuLi8uLi9tb2RlbC9wYXltZW50LWNhcmQtbGltaXQubW9kZWwnO1xuaW1wb3J0IHsgUGF5bWVudENhcmRSZXBsYWNlbWVudFJlYXNvbiB9IGZyb20gJy4uLy4uL21vZGVsL3BheW1lbnQtY2FyZC1yZXBsYWNlbWVudC1yZWFzb24ubW9kZWwnO1xuaW1wb3J0IHsgUGF5bWVudENhcmRSZXNldFBpblRyYW5zcG9ydCB9IGZyb20gJy4uLy4uL21vZGVsL3BheW1lbnQtY2FyZC1yZXNldC1waW4ubW9kZWwnO1xuaW1wb3J0IHsgUGF5bWVudENhcmQsIFBheW1lbnRDYXJkTG9ja1N0YXR1cyB9IGZyb20gJy4uLy4uL21vZGVsL3BheW1lbnQtY2FyZC5tb2RlbCc7XG5pbXBvcnQgeyBDYXJkc1NlcnZpY2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9jYXJkcy5zZXJ2aWNlJztcblxuY29uc3QgYmFzZU5vdGlmaWNhdGlvbjogTm90aWZpY2F0aW9uID0ge1xuICBoZWFkZXI6ICcnLFxuICBtZXNzYWdlOiAnJyxcbiAgZGlzbWlzc2libGU6IHRydWUsXG4gIG1vZGlmaWVyOiAnc3VjY2VzcycsXG59O1xuXG5ARGlyZWN0aXZlKClcbi8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZVxuZXhwb3J0IGNsYXNzIFBheW1lbnRDYXJkQ29udGFpbmVyQmFzZSBpbXBsZW1lbnRzIE9uSW5pdCB7XG4gIC8qKlxuICAgKiBOb3RpZmljYXRpb24gbWVzc2FnZXMgdHJhbnNsYXRpb25zXG4gICAqL1xuXG4gIHByb3RlY3RlZCBsb2NhbGl6YXRpb25zOiB7IFtrZXk6IHN0cmluZ106IFRlbXBsYXRlUmVmPGFueT4gfCBzdHJpbmcgfSA9IHtcbiAgICBhY3RpdmF0aW9uRXJyb3JIZWFkZXI6ICcnLFxuICAgIGFjdGl2YXRpb25FcnJvck1lc3NhZ2U6ICcnLFxuICAgIGFjdGl2YXRpb25TdWNjZXNzSGVhZGVyOiAnJyxcbiAgICBsb2NrRXJyb3JIZWFkZXI6ICcnLFxuICAgIGxvY2tFcnJvck1lc3NhZ2U6ICcnLFxuICAgIGxvY2tTdWNjZXNzSGVhZGVyOiAnJyxcbiAgICBsb2NrU3VjY2Vzc01lc3NhZ2U6ICcnLFxuICAgIHJlcGxhY2VtZW50RXJyb3JIZWFkZXI6ICcnLFxuICAgIHJlcGxhY2VtZW50RXJyb3JNZXNzYWdlOiAnJyxcbiAgICByZXBsYWNlbWVudFN1Y2Nlc3NIZWFkZXI6ICcnLFxuICAgIHJlcGxhY2VtZW50U3VjY2Vzc01lc3NhZ2U6ICcnLFxuICAgIHJlcXVlc3ROZXdQaW5TdWNjZXNzTWVzc2FnZTogJycsXG4gICAgcmVxdWVzdFBpbkVycm9yTWVzc2FnZTogJycsXG4gICAgcmVzZXRQaW5TdWNjZXNzTWVzc2FnZTogJycsXG4gICAgcmVzZXRQaW5FcnJvck1lc3NhZ2U6ICcnLFxuICAgIHJlc2V0SW52YWxpZFBpbk1lc3NhZ2U6ICcnLFxuICAgIHVubG9ja0Vycm9ySGVhZGVyOiAnJyxcbiAgICB1bmxvY2tFcnJvck1lc3NhZ2U6ICcnLFxuICAgIHVubG9ja1N1Y2Nlc3NIZWFkZXI6ICcnLFxuICAgIHVubG9ja1N1Y2Nlc3NNZXNzYWdlOiAnJyxcbiAgICB1cGRhdGVMaW1pdEVycm9ySGVhZGVyOiAnJyxcbiAgICB1cGRhdGVMaW1pdEVycm9yTWVzc2FnZTogJycsXG4gICAgdXBkYXRlTGltaXRTdWNjZXNzSGVhZGVyOiAnJyxcbiAgICB1cGRhdGVMaW1pdFN1Y2Nlc3NNZXNzYWdlOiAnJyxcbiAgfTtcbiAgLyoqXG4gICAqIFBheW1lbnQgY2FyZCB0byBiZSBkaXNwbGF5ZWQuXG4gICAqL1xuICBASW5wdXQoKSBwYXltZW50Q2FyZDogUGF5bWVudENhcmQgfCB1bmRlZmluZWQ7XG5cbiAgQElucHV0KCkgbm90aWZpY2F0aW9uVHRsOiBudW1iZXIgfCB1bmRlZmluZWQ7XG4gIEBJbnB1dCgpIHVwZGF0ZUFsbExpbWl0czogYm9vbGVhbiB8IHVuZGVmaW5lZDtcbiAgLyoqXG4gICAqIEV2ZW50IGVtaXR0ZXIgZm9yIHNlbGVjdGluZyBhIGNhcmQuXG4gICAqL1xuICBAT3V0cHV0KCkgcmVhZG9ubHkgc2VsZWN0Q2FyZCA9IG5ldyBFdmVudEVtaXR0ZXI8UGF5bWVudENhcmQ+KCk7XG5cbiAgaXNMb2NrTG9hZGluZyA9IGZhbHNlO1xuICBpc0luaXRpYXRlUmVwbGFjZW1lbnRMb2FkaW5nID0gZmFsc2U7XG4gIGlzSW5pdGlhdGVBY3RpdmF0aW9uTG9hZGluZyA9IGZhbHNlO1xuICBpc1Jlc2V0UGluTG9hZGluZyA9IGZhbHNlO1xuICBpc0xpbWl0c0xvYWRpbmcgPSBmYWxzZTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcm90ZWN0ZWQgcmVhZG9ubHkgY2FyZHNTZXJ2aWNlOiBDYXJkc1NlcnZpY2UsXG4gICAgcHJvdGVjdGVkIHJlYWRvbmx5IGNkOiBDaGFuZ2VEZXRlY3RvclJlZixcbiAgICBwcm90ZWN0ZWQgcmVhZG9ubHkgbm90aWZpY2F0aW9uU2VydmljZTogTm90aWZpY2F0aW9uU2VydmljZSxcbiAgKSB7fVxuXG4gIHByaXZhdGUgc2hvd05vdGlmaWNhdGlvbihub3RpZmljYXRpb246IFBhcnRpYWw8Tm90aWZpY2F0aW9uPikge1xuICAgIHRoaXMubm90aWZpY2F0aW9uU2VydmljZS5zaG93Tm90aWZpY2F0aW9uKHtcbiAgICAgIC4uLmJhc2VOb3RpZmljYXRpb24sXG4gICAgICB0dGw6IHRoaXMubm90aWZpY2F0aW9uVHRsLFxuICAgICAgLi4ubm90aWZpY2F0aW9uLFxuICAgIH0pO1xuICB9XG5cbiAgbmdPbkluaXQoKSB7XG4gICAgaWYgKHR5cGVvZiB0aGlzLnBheW1lbnRDYXJkID09PSAndW5kZWZpbmVkJykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBcInBheW1lbnRDYXJkXCIgaW5wdXQgaXMgcmVxdWlyZWQgaW4gXCIke3RoaXMuY29uc3RydWN0b3IubmFtZX1cImApO1xuICAgIH1cbiAgfVxuXG4gIG9uVXBkYXRlTG9ja1N0YXR1cyhsb2NrU3RhdHVzOiBQYXltZW50Q2FyZExvY2tTdGF0dXMpIHtcbiAgICBpZiAodHlwZW9mIHRoaXMucGF5bWVudENhcmQgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5pc0xvY2tMb2FkaW5nID0gdHJ1ZTtcblxuICAgIGNvbnN0IG9uVXBkYXRlTG9ja1N0YXR1c1N1Y2Nlc3MgPSAocGF5bWVudENhcmQ6IFBheW1lbnRDYXJkKSA9PiB7XG4gICAgICBpZiAodHlwZW9mIHRoaXMucGF5bWVudENhcmQgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgIHRoaXMucGF5bWVudENhcmQgPSBwYXltZW50Q2FyZDtcblxuICAgICAgICBjb25zdCBoZWFkZXIgPVxuICAgICAgICAgIGxvY2tTdGF0dXMgPT09IFBheW1lbnRDYXJkTG9ja1N0YXR1cy5Mb2NrZWRcbiAgICAgICAgICAgID8gdGhpcy5sb2NhbGl6YXRpb25zLmxvY2tTdWNjZXNzSGVhZGVyXG4gICAgICAgICAgICA6IHRoaXMubG9jYWxpemF0aW9ucy51bmxvY2tTdWNjZXNzSGVhZGVyO1xuICAgICAgICBjb25zdCBtZXNzYWdlID1cbiAgICAgICAgICBsb2NrU3RhdHVzID09PSBQYXltZW50Q2FyZExvY2tTdGF0dXMuTG9ja2VkXG4gICAgICAgICAgICA/IHRoaXMubG9jYWxpemF0aW9ucy5sb2NrU3VjY2Vzc01lc3NhZ2VcbiAgICAgICAgICAgIDogdGhpcy5sb2NhbGl6YXRpb25zLnVubG9ja1N1Y2Nlc3NNZXNzYWdlO1xuXG4gICAgICAgIHRoaXMuc2hvd05vdGlmaWNhdGlvbih7XG4gICAgICAgICAgaGVhZGVyLFxuICAgICAgICAgIG1lc3NhZ2UsXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH07XG5cbiAgICBjb25zdCBvblVwZGF0ZUxvY2tTdGF0dXNFcnJvciA9ICgpID0+IHtcbiAgICAgIGlmICh0eXBlb2YgdGhpcy5wYXltZW50Q2FyZCAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgY29uc3QgaGVhZGVyID1cbiAgICAgICAgICBsb2NrU3RhdHVzID09PSBQYXltZW50Q2FyZExvY2tTdGF0dXMuTG9ja2VkXG4gICAgICAgICAgICA/IHRoaXMubG9jYWxpemF0aW9ucy5sb2NrRXJyb3JIZWFkZXJcbiAgICAgICAgICAgIDogdGhpcy5sb2NhbGl6YXRpb25zLnVubG9ja0Vycm9ySGVhZGVyO1xuICAgICAgICBjb25zdCBtZXNzYWdlID1cbiAgICAgICAgICBsb2NrU3RhdHVzID09PSBQYXltZW50Q2FyZExvY2tTdGF0dXMuTG9ja2VkXG4gICAgICAgICAgICA/IHRoaXMubG9jYWxpemF0aW9ucy5sb2NrRXJyb3JNZXNzYWdlXG4gICAgICAgICAgICA6IHRoaXMubG9jYWxpemF0aW9ucy51bmxvY2tFcnJvck1lc3NhZ2U7XG5cbiAgICAgICAgdGhpcy5zaG93Tm90aWZpY2F0aW9uKHtcbiAgICAgICAgICBoZWFkZXIsXG4gICAgICAgICAgbWVzc2FnZSxcbiAgICAgICAgICBtb2RpZmllcjogJ2Vycm9yJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIHRoaXMuaXNMb2NrTG9hZGluZyA9IGZhbHNlO1xuICAgICAgdGhpcy5jZC5tYXJrRm9yQ2hlY2soKTtcbiAgICB9O1xuXG4gICAgY29uc3Qgb25VcGRhdGVMb2NrU3RhdHVzQ29tcGxldGUgPSAoKSA9PiB7XG4gICAgICB0aGlzLmlzTG9ja0xvYWRpbmcgPSBmYWxzZTtcbiAgICAgIHRoaXMuY2QubWFya0ZvckNoZWNrKCk7XG4gICAgfTtcblxuICAgIHRoaXMuY2FyZHNTZXJ2aWNlXG4gICAgICAudXBkYXRlTG9ja1N0YXR1cyh0aGlzLnBheW1lbnRDYXJkLCBsb2NrU3RhdHVzKVxuICAgICAgLnN1YnNjcmliZShvblVwZGF0ZUxvY2tTdGF0dXNTdWNjZXNzLCBvblVwZGF0ZUxvY2tTdGF0dXNFcnJvciwgb25VcGRhdGVMb2NrU3RhdHVzQ29tcGxldGUpO1xuICB9XG5cbiAgb25Jbml0aWF0ZVJlcGxhY2VtZW50KHJlYXNvbjogUGF5bWVudENhcmRSZXBsYWNlbWVudFJlYXNvbiB8IHN0cmluZykge1xuICAgIGlmICh0eXBlb2YgdGhpcy5wYXltZW50Q2FyZCA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLmlzSW5pdGlhdGVSZXBsYWNlbWVudExvYWRpbmcgPSB0cnVlO1xuXG4gICAgY29uc3Qgb25Jbml0aWF0ZVJlcGxhY2VtZW50U3VjY2VzcyA9IChwYXltZW50Q2FyZDogUGF5bWVudENhcmQpID0+IHtcbiAgICAgIGlmICh0eXBlb2YgdGhpcy5wYXltZW50Q2FyZCAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgdGhpcy5wYXltZW50Q2FyZCA9IHBheW1lbnRDYXJkO1xuXG4gICAgICAgIHRoaXMuc2hvd05vdGlmaWNhdGlvbih7XG4gICAgICAgICAgaGVhZGVyOiB0aGlzLmxvY2FsaXphdGlvbnMucmVwbGFjZW1lbnRTdWNjZXNzSGVhZGVyLFxuICAgICAgICAgIG1lc3NhZ2U6IHRoaXMubG9jYWxpemF0aW9ucy5yZXBsYWNlbWVudFN1Y2Nlc3NNZXNzYWdlLFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgY29uc3Qgb25Jbml0aWF0ZVJlcGxhY2VtZW50RXJyb3IgPSAoKSA9PiB7XG4gICAgICBpZiAodHlwZW9mIHRoaXMucGF5bWVudENhcmQgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgIHRoaXMuc2hvd05vdGlmaWNhdGlvbih7XG4gICAgICAgICAgaGVhZGVyOiB0aGlzLmxvY2FsaXphdGlvbnMucmVwbGFjZW1lbnRFcnJvckhlYWRlcixcbiAgICAgICAgICBtZXNzYWdlOiB0aGlzLmxvY2FsaXphdGlvbnMucmVwbGFjZW1lbnRFcnJvck1lc3NhZ2UsXG4gICAgICAgICAgbW9kaWZpZXI6ICdlcnJvcicsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmlzSW5pdGlhdGVSZXBsYWNlbWVudExvYWRpbmcgPSBmYWxzZTtcbiAgICAgIHRoaXMuY2QubWFya0ZvckNoZWNrKCk7XG4gICAgfTtcblxuICAgIGNvbnN0IG9uSW5pdGlhdGVSZXBsYWNlbWVudENvbXBsZXRlID0gKCkgPT4ge1xuICAgICAgdGhpcy5pc0luaXRpYXRlUmVwbGFjZW1lbnRMb2FkaW5nID0gZmFsc2U7XG4gICAgICB0aGlzLmNkLm1hcmtGb3JDaGVjaygpO1xuICAgIH07XG5cbiAgICB0aGlzLmNhcmRzU2VydmljZVxuICAgICAgLmluaXRpYXRlUmVwbGFjZW1lbnQodGhpcy5wYXltZW50Q2FyZCwgcmVhc29uKVxuICAgICAgLnN1YnNjcmliZShvbkluaXRpYXRlUmVwbGFjZW1lbnRTdWNjZXNzLCBvbkluaXRpYXRlUmVwbGFjZW1lbnRFcnJvciwgb25Jbml0aWF0ZVJlcGxhY2VtZW50Q29tcGxldGUpO1xuICB9XG5cbiAgb25Jbml0aWF0ZUFjdGl2YXRpb24odG9rZW46IHN0cmluZykge1xuICAgIGlmICh0eXBlb2YgdGhpcy5wYXltZW50Q2FyZCA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLmlzSW5pdGlhdGVBY3RpdmF0aW9uTG9hZGluZyA9IHRydWU7XG5cbiAgICBjb25zdCBvbkluaXRpYXRlQWN0aXZhdGlvblN1Y2Nlc3MgPSAocGF5bWVudENhcmQ6IFBheW1lbnRDYXJkKSA9PiB7XG4gICAgICBpZiAodHlwZW9mIHRoaXMucGF5bWVudENhcmQgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgIHRoaXMucGF5bWVudENhcmQgPSBwYXltZW50Q2FyZDtcblxuICAgICAgICB0aGlzLnNob3dOb3RpZmljYXRpb24oe1xuICAgICAgICAgIGhlYWRlcjogdGhpcy5sb2NhbGl6YXRpb25zLmFjdGl2YXRpb25TdWNjZXNzSGVhZGVyLFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgY29uc3Qgb25Jbml0aWF0ZUFjdGl2YXRpb25FcnJvciA9ICgpID0+IHtcbiAgICAgIGlmICh0eXBlb2YgdGhpcy5wYXltZW50Q2FyZCAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgdGhpcy5zaG93Tm90aWZpY2F0aW9uKHtcbiAgICAgICAgICBoZWFkZXI6IHRoaXMubG9jYWxpemF0aW9ucy5hY3RpdmF0aW9uRXJyb3JIZWFkZXIsXG4gICAgICAgICAgbWVzc2FnZTogdGhpcy5sb2NhbGl6YXRpb25zLmFjdGl2YXRpb25FcnJvck1lc3NhZ2UsXG4gICAgICAgICAgbW9kaWZpZXI6ICdlcnJvcicsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmlzSW5pdGlhdGVBY3RpdmF0aW9uTG9hZGluZyA9IGZhbHNlO1xuICAgICAgdGhpcy5jZC5tYXJrRm9yQ2hlY2soKTtcbiAgICB9O1xuXG4gICAgY29uc3Qgb25Jbml0aWF0ZUFjdGl2YXRpb25Db21wbGV0ZSA9ICgpID0+IHtcbiAgICAgIHRoaXMuaXNJbml0aWF0ZUFjdGl2YXRpb25Mb2FkaW5nID0gZmFsc2U7XG4gICAgICB0aGlzLmNkLm1hcmtGb3JDaGVjaygpO1xuICAgIH07XG5cbiAgICB0aGlzLmNhcmRzU2VydmljZVxuICAgICAgLmluaXRpYXRlQWN0aXZhdGlvbih0aGlzLnBheW1lbnRDYXJkLCB0b2tlbilcbiAgICAgIC5zdWJzY3JpYmUob25Jbml0aWF0ZUFjdGl2YXRpb25TdWNjZXNzLCBvbkluaXRpYXRlQWN0aXZhdGlvbkVycm9yLCBvbkluaXRpYXRlQWN0aXZhdGlvbkNvbXBsZXRlKTtcbiAgfVxuXG4gIG9uVXBkYXRlTGltaXQobGltaXQ6IEFycmF5PFBheW1lbnRDYXJkTGltaXQ+KSB7XG4gICAgaWYgKHR5cGVvZiB0aGlzLnBheW1lbnRDYXJkID09PSAndW5kZWZpbmVkJykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLmlzTGltaXRzTG9hZGluZyA9IHRydWU7XG5cbiAgICBjb25zdCBvblVwZGF0ZUxpbWl0U3VjY2VzcyA9IChwYXltZW50Q2FyZDogUGF5bWVudENhcmQpID0+IHtcbiAgICAgIGlmICh0eXBlb2YgdGhpcy5wYXltZW50Q2FyZCAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgdGhpcy5wYXltZW50Q2FyZCA9IHBheW1lbnRDYXJkO1xuXG4gICAgICAgIHRoaXMuc2hvd05vdGlmaWNhdGlvbih7XG4gICAgICAgICAgaGVhZGVyOiB0aGlzLmxvY2FsaXphdGlvbnMudXBkYXRlTGltaXRTdWNjZXNzSGVhZGVyLFxuICAgICAgICAgIG1lc3NhZ2U6IHRoaXMubG9jYWxpemF0aW9ucy51cGRhdGVMaW1pdFN1Y2Nlc3NNZXNzYWdlLFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgY29uc3Qgb25VcGRhdGVMaW1pdEVycm9yID0gKCkgPT4ge1xuICAgICAgaWYgKHR5cGVvZiB0aGlzLnBheW1lbnRDYXJkICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgICB0aGlzLm5vdGlmaWNhdGlvblNlcnZpY2Uuc2hvd05vdGlmaWNhdGlvbih7XG4gICAgICAgICAgLi4uYmFzZU5vdGlmaWNhdGlvbixcbiAgICAgICAgICBoZWFkZXI6IHRoaXMubG9jYWxpemF0aW9ucy51cGRhdGVMaW1pdEVycm9ySGVhZGVyLFxuICAgICAgICAgIG1lc3NhZ2U6IHRoaXMubG9jYWxpemF0aW9ucy51cGRhdGVMaW1pdEVycm9yTWVzc2FnZSxcbiAgICAgICAgICBtb2RpZmllcjogJ2Vycm9yJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgICB0aGlzLmlzTGltaXRzTG9hZGluZyA9IGZhbHNlO1xuICAgICAgdGhpcy5jZC5tYXJrRm9yQ2hlY2soKTtcbiAgICB9O1xuXG4gICAgY29uc3Qgb25VcGRhdGVMaW1pdENvbXBsZXRlID0gKCkgPT4ge1xuICAgICAgdGhpcy5pc0xpbWl0c0xvYWRpbmcgPSBmYWxzZTtcbiAgICAgIHRoaXMuY2QubWFya0ZvckNoZWNrKCk7XG4gICAgfTtcbiAgICB0aGlzLmNhcmRzU2VydmljZVxuICAgICAgLnVwZGF0ZUxpbWl0KHRoaXMucGF5bWVudENhcmQsIGxpbWl0LCB0aGlzLnVwZGF0ZUFsbExpbWl0cylcbiAgICAgIC5zdWJzY3JpYmUob25VcGRhdGVMaW1pdFN1Y2Nlc3MsIG9uVXBkYXRlTGltaXRFcnJvciwgb25VcGRhdGVMaW1pdENvbXBsZXRlKTtcbiAgfVxuXG4gIG9uUmVzZXRQaW4odG9rZW46IFBheW1lbnRDYXJkUmVzZXRQaW5UcmFuc3BvcnQpIHtcbiAgICBpZiAodHlwZW9mIHRoaXMucGF5bWVudENhcmQgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5pc1Jlc2V0UGluTG9hZGluZyA9IHRydWU7XG5cbiAgICBpZiAodG9rZW4ucmF3LnBpbjIgIT09IHVuZGVmaW5lZCAmJiB0b2tlbi5yYXcucGluICE9PSB0b2tlbi5yYXcucGluMikge1xuICAgICAgdGhpcy5pc1Jlc2V0UGluTG9hZGluZyA9IGZhbHNlO1xuICAgICAgdGhpcy5zaG93Tm90aWZpY2F0aW9uKHtcbiAgICAgICAgbWVzc2FnZTogdGhpcy5sb2NhbGl6YXRpb25zLnJlc2V0SW52YWxpZFBpbk1lc3NhZ2UsXG4gICAgICAgIG1vZGlmaWVyOiAnZXJyb3InLFxuICAgICAgfSk7XG5cbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBvblJlc2V0UGluU3VjY2VzcyA9IChwYXltZW50Q2FyZDogUGF5bWVudENhcmQpID0+IHtcbiAgICAgIGlmICh0eXBlb2YgdGhpcy5wYXltZW50Q2FyZCAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgdGhpcy5wYXltZW50Q2FyZCA9IHBheW1lbnRDYXJkO1xuXG4gICAgICAgIHRoaXMuc2hvd05vdGlmaWNhdGlvbih7XG4gICAgICAgICAgbWVzc2FnZTogdGhpcy5sb2NhbGl6YXRpb25zLnJlc2V0UGluU3VjY2Vzc01lc3NhZ2UsXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH07XG5cbiAgICBjb25zdCBvblJlc2V0UGluRXJyb3IgPSAoKSA9PiB7XG4gICAgICBpZiAodHlwZW9mIHRoaXMucGF5bWVudENhcmQgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgIHRoaXMuc2hvd05vdGlmaWNhdGlvbih7XG4gICAgICAgICAgbWVzc2FnZTogdGhpcy5sb2NhbGl6YXRpb25zLnJlc2V0UGluRXJyb3JNZXNzYWdlLFxuICAgICAgICAgIG1vZGlmaWVyOiAnZXJyb3InLFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICAgIHRoaXMuaXNSZXNldFBpbkxvYWRpbmcgPSBmYWxzZTtcbiAgICAgIHRoaXMuY2QubWFya0ZvckNoZWNrKCk7XG4gICAgfTtcblxuICAgIGNvbnN0IG9uUmVzZXRQaW5Db21wbGV0ZSA9ICgpID0+IHtcbiAgICAgIHRoaXMuaXNSZXNldFBpbkxvYWRpbmcgPSBmYWxzZTtcbiAgICAgIHRoaXMuY2QubWFya0ZvckNoZWNrKCk7XG4gICAgfTtcblxuICAgIHRoaXMuY2FyZHNTZXJ2aWNlXG4gICAgICAucmVzZXRQSU4odGhpcy5wYXltZW50Q2FyZCwgdG9rZW4ubW9kZWwpXG4gICAgICAuc3Vic2NyaWJlKG9uUmVzZXRQaW5TdWNjZXNzLCBvblJlc2V0UGluRXJyb3IsIG9uUmVzZXRQaW5Db21wbGV0ZSk7XG4gIH1cblxuICBvblJlcXVlc3RQaW4odG9rZW46IFBheW1lbnRDYXJkUmVzZXRQaW5UcmFuc3BvcnQpIHtcbiAgICBpZiAodHlwZW9mIHRoaXMucGF5bWVudENhcmQgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5pc1Jlc2V0UGluTG9hZGluZyA9IHRydWU7XG5cbiAgICBjb25zdCBvblJlcXVlc3RQaW5TdWNjZXNzID0gKHBheW1lbnRDYXJkOiBQYXltZW50Q2FyZCkgPT4ge1xuICAgICAgaWYgKHR5cGVvZiB0aGlzLnBheW1lbnRDYXJkICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgICB0aGlzLnBheW1lbnRDYXJkID0gcGF5bWVudENhcmQ7XG5cbiAgICAgICAgdGhpcy5zaG93Tm90aWZpY2F0aW9uKHtcbiAgICAgICAgICBtZXNzYWdlOiB0aGlzLmxvY2FsaXphdGlvbnMucmVxdWVzdE5ld1BpblN1Y2Nlc3NNZXNzYWdlLFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgY29uc3Qgb25SZXF1ZXN0UGluRXJyb3IgPSAoKSA9PiB7XG4gICAgICBpZiAodHlwZW9mIHRoaXMucGF5bWVudENhcmQgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgIHRoaXMuc2hvd05vdGlmaWNhdGlvbih7XG4gICAgICAgICAgbWVzc2FnZTogdGhpcy5sb2NhbGl6YXRpb25zLnJlcXVlc3RQaW5FcnJvck1lc3NhZ2UsXG4gICAgICAgICAgbW9kaWZpZXI6ICdlcnJvcicsXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgICAgdGhpcy5pc1Jlc2V0UGluTG9hZGluZyA9IGZhbHNlO1xuICAgICAgdGhpcy5jZC5tYXJrRm9yQ2hlY2soKTtcbiAgICB9O1xuXG4gICAgY29uc3Qgb25SZXF1ZXN0UGluQ29tcGxldGUgPSAoKSA9PiB7XG4gICAgICB0aGlzLmlzUmVzZXRQaW5Mb2FkaW5nID0gZmFsc2U7XG4gICAgICB0aGlzLmNkLm1hcmtGb3JDaGVjaygpO1xuICAgIH07XG5cbiAgICB0aGlzLmNhcmRzU2VydmljZVxuICAgICAgLnJlcXVlc3RQSU4odGhpcy5wYXltZW50Q2FyZCwgdG9rZW4ubW9kZWwpXG4gICAgICAuc3Vic2NyaWJlKG9uUmVxdWVzdFBpblN1Y2Nlc3MsIG9uUmVxdWVzdFBpbkVycm9yLCBvblJlcXVlc3RQaW5Db21wbGV0ZSk7XG4gIH1cblxuICBvbk9wZW5EZXRhaWxzKCkge1xuICAgIGlmICh0eXBlb2YgdGhpcy5wYXltZW50Q2FyZCAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIHRoaXMuc2VsZWN0Q2FyZC5lbWl0KHRoaXMucGF5bWVudENhcmQpO1xuICAgIH1cbiAgfVxufVxuIl19