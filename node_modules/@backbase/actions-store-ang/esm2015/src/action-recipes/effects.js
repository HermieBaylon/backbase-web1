import { Injectable } from '@angular/core';
import { merge, of, throwError } from 'rxjs';
import { catchError, first, groupBy, map, mergeMap, switchMap } from 'rxjs/operators';
import { EMPTY_RESPONSE_ERROR, parseActionRecipeFormItem, getMappedRecurrenceResponse, } from '@backbase/actions-common-ang';
import { loadActionRecipes, loadActionRecipesFailed, loadActionRecipesSuccess, saveActionRecipe, saveActionRecipeFailure, saveActionRecipeSuccess, } from './actions';
import { actionRecipesSpecificationIds } from './selectors';
import { createEffect, ofType } from '@ngrx/effects';
import * as i0 from "@angular/core";
import * as i1 from "@ngrx/effects";
import * as i2 from "@ngrx/store";
import * as i3 from "@backbase/actions-common-ang";
import * as i4 from "@backbase/ui-ang/notification";
export class ActionsRecipesEffects {
    constructor(actions$, store, dataService, notificationService) {
        this.actions$ = actions$;
        this.store = store;
        this.dataService = dataService;
        this.notificationService = notificationService;
        this.actionRecipes$ = createEffect(() => this.actions$.pipe(ofType(loadActionRecipes), switchMap(({ specificationIds, arrangementId }) => this.dataService.getActionRecipes(arrangementId).pipe(map(data => (specificationIds ? data.filter(({ specificationId: id }) => specificationIds.has(id)) : data)), map(data => arrangementId ? data.filter(item => !item.arrangementId || item.arrangementId === arrangementId) : data), map(data => loadActionRecipesSuccess({
            actionRecipes: data || [],
            specificationIds,
        })), catchError(error => of(loadActionRecipesFailed({ error })))))));
        this.saveActionRecipe$ = createEffect(() => this.actions$.pipe(ofType(saveActionRecipe), groupBy(({ actionRecipe }) => actionRecipe.specificationId), mergeMap(group => group.pipe(switchMap(({ actionRecipe, arrangementId, warningNotification, successNotification }) => this.dataService.saveActionRecipe(actionRecipe, arrangementId).pipe(switchMap(({ actionRecipes }) => {
            if (!actionRecipes || !actionRecipes.length)
                return throwError(EMPTY_RESPONSE_ERROR);
            return of(saveActionRecipeSuccess(Object.assign({ actionRecipe: Object.assign(Object.assign({}, actionRecipes[0]), (actionRecipes[0].recurrence && {
                    recurrence: getMappedRecurrenceResponse(actionRecipes[0].recurrence, actionRecipe),
                })) }, (successNotification && { notification: successNotification }))));
        }), catchError(err => {
            if (err.status === 409) {
                return this.store.select(actionRecipesSpecificationIds).pipe(first(), map(specificationIds => loadActionRecipes({
                    arrangementId,
                    specificationIds,
                })));
            }
            return of(saveActionRecipeFailure(Object.assign({ actionRecipe: parseActionRecipeFormItem(actionRecipe) }, (warningNotification && { notification: warningNotification }))));
        })))))));
        this.showNotification$ = createEffect(() => merge(this.actions$.pipe(ofType(saveActionRecipeSuccess)), this.actions$.pipe(ofType(saveActionRecipeFailure))).pipe(map(({ notification }) => {
            if (notification) {
                this.notificationService.showNotification(notification);
            }
        })), { dispatch: false });
    }
}
ActionsRecipesEffects.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.14", ngImport: i0, type: ActionsRecipesEffects, deps: [{ token: i1.Actions }, { token: i2.Store }, { token: i3.NotificationsPreferencesBaseDataService }, { token: i4.NotificationService }], target: i0.ɵɵFactoryTarget.Injectable });
ActionsRecipesEffects.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "12.2.14", ngImport: i0, type: ActionsRecipesEffects });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.14", ngImport: i0, type: ActionsRecipesEffects, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.Actions }, { type: i2.Store }, { type: i3.NotificationsPreferencesBaseDataService }, { type: i4.NotificationService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZWZmZWN0cy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL2xpYnMvYWN0aW9ucy1zdG9yZS1hbmcvc3JjL2FjdGlvbi1yZWNpcGVzL2VmZmVjdHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUczQyxPQUFPLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBRSxVQUFVLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDN0MsT0FBTyxFQUFFLFVBQVUsRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLEdBQUcsRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDdEYsT0FBTyxFQUNMLG9CQUFvQixFQUNwQix5QkFBeUIsRUFDekIsMkJBQTJCLEdBRTVCLE1BQU0sOEJBQThCLENBQUM7QUFDdEMsT0FBTyxFQUNMLGlCQUFpQixFQUNqQix1QkFBdUIsRUFDdkIsd0JBQXdCLEVBQ3hCLGdCQUFnQixFQUNoQix1QkFBdUIsRUFDdkIsdUJBQXVCLEdBQ3hCLE1BQU0sV0FBVyxDQUFDO0FBQ25CLE9BQU8sRUFBRSw2QkFBNkIsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUM1RCxPQUFPLEVBQVcsWUFBWSxFQUFFLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQzs7Ozs7O0FBSTlELE1BQU0sT0FBTyxxQkFBcUI7SUFDaEMsWUFDbUIsUUFBaUIsRUFDakIsS0FBMEIsRUFDMUIsV0FBb0QsRUFDcEQsbUJBQXdDO1FBSHhDLGFBQVEsR0FBUixRQUFRLENBQVM7UUFDakIsVUFBSyxHQUFMLEtBQUssQ0FBcUI7UUFDMUIsZ0JBQVcsR0FBWCxXQUFXLENBQXlDO1FBQ3BELHdCQUFtQixHQUFuQixtQkFBbUIsQ0FBcUI7UUFHM0QsbUJBQWMsR0FBRyxZQUFZLENBQUMsR0FBRyxFQUFFLENBQ2pDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUNoQixNQUFN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RUFBRSx5QkFBeUIsQ0FBQyxZQUFZLENBQUMsSUFDbEQsQ0FBQyxtQkFBbUIsSUFBSSxFQUFFLFlBQVksRUFBRSxtQkFBbUIsRUFBRSxDQUFDLEVBQ2pFLENBQ0gsQ0FBQztRQUNKLENBQUMsQ0FBQyxDQUNILENBQ0YsQ0FDRixDQUNGLENBQ0YsQ0FDRixDQUFDO1FBRUYsc0JBQWlCLEdBQUcsWUFBWSxDQUM5QixHQUFHLEVBQUUsQ0FDSCxLQUFLLENBQ0gsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLHVCQUF1QixDQUFDLENBQUMsRUFDbkQsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLHVCQUF1QixDQUFDLENBQUMsQ0FDcEQsQ0FBQyxJQUFJLENBQ0osR0FBRyxDQUFDLENBQUMsRUFBRSxZQUFZLEVBQUUsRUFBRSxFQUFFO1lBQ3ZCLElBQUksWUFBWSxFQUFFO2dCQUNoQixJQUFJLENBQUMsbUJBQW1CLENBQUMsZ0JBQWdCLENBQUMsWUFBWSxDQUFDLENBQUM7YUFDekQ7UUFDSCxDQUFDLENBQUMsQ0FDSCxFQUNILEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxDQUNwQixDQUFDO0lBdEZDLENBQUM7O21IQU5PLHFCQUFxQjt1SEFBckIscUJBQXFCOzRGQUFyQixxQkFBcUI7a0JBRGpDLFVBQVUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBOb3RpZmljYXRpb25TZXJ2aWNlIH0gZnJvbSAnQGJhY2tiYXNlL3VpLWFuZy9ub3RpZmljYXRpb24nO1xuaW1wb3J0IHsgU3RvcmUgfSBmcm9tICdAbmdyeC9zdG9yZSc7XG5pbXBvcnQgeyBtZXJnZSwgb2YsIHRocm93RXJyb3IgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGNhdGNoRXJyb3IsIGZpcnN0LCBncm91cEJ5LCBtYXAsIG1lcmdlTWFwLCBzd2l0Y2hNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQge1xuICBFTVBUWV9SRVNQT05TRV9FUlJPUixcbiAgcGFyc2VBY3Rpb25SZWNpcGVGb3JtSXRlbSxcbiAgZ2V0TWFwcGVkUmVjdXJyZW5jZVJlc3BvbnNlLFxuICBOb3RpZmljYXRpb25zUHJlZmVyZW5jZXNCYXNlRGF0YVNlcnZpY2UsXG59IGZyb20gJ0BiYWNrYmFzZS9hY3Rpb25zLWNvbW1vbi1hbmcnO1xuaW1wb3J0IHtcbiAgbG9hZEFjdGlvblJlY2lwZXMsXG4gIGxvYWRBY3Rpb25SZWNpcGVzRmFpbGVkLFxuICBsb2FkQWN0aW9uUmVjaXBlc1N1Y2Nlc3MsXG4gIHNhdmVBY3Rpb25SZWNpcGUsXG4gIHNhdmVBY3Rpb25SZWNpcGVGYWlsdXJlLFxuICBzYXZlQWN0aW9uUmVjaXBlU3VjY2Vzcyxcbn0gZnJvbSAnLi9hY3Rpb25zJztcbmltcG9ydCB7IGFjdGlvblJlY2lwZXNTcGVjaWZpY2F0aW9uSWRzIH0gZnJvbSAnLi9zZWxlY3RvcnMnO1xuaW1wb3J0IHsgQWN0aW9ucywgY3JlYXRlRWZmZWN0LCBvZlR5cGUgfSBmcm9tICdAbmdyeC9lZmZlY3RzJztcbmltcG9ydCB7IEFjdGlvbnNTdGF0ZSB9IGZyb20gJy4uL21vZGVsL2FjdGlvbnMtc3RvcmUtc3RhdGUubW9kZWwnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgQWN0aW9uc1JlY2lwZXNFZmZlY3RzIHtcbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBhY3Rpb25zJDogQWN0aW9ucyxcbiAgICBwcml2YXRlIHJlYWRvbmx5IHN0b3JlOiBTdG9yZTxBY3Rpb25zU3RhdGU+LFxuICAgIHByaXZhdGUgcmVhZG9ubHkgZGF0YVNlcnZpY2U6IE5vdGlmaWNhdGlvbnNQcmVmZXJlbmNlc0Jhc2VEYXRhU2VydmljZSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IG5vdGlmaWNhdGlvblNlcnZpY2U6IE5vdGlmaWNhdGlvblNlcnZpY2UsXG4gICkge31cblxuICBhY3Rpb25SZWNpcGVzJCA9IGNyZWF0ZUVmZmVjdCgoKSA9PlxuICAgIHRoaXMuYWN0aW9ucyQucGlwZShcbiAgICAgIG9mVHlwZShsb2FkQWN0aW9uUmVjaXBlcyksXG4gICAgICBzd2l0Y2hNYXAoKHsgc3BlY2lmaWNhdGlvbklkcywgYXJyYW5nZW1lbnRJZCB9KSA9PlxuICAgICAgICB0aGlzLmRhdGFTZXJ2aWNlLmdldEFjdGlvblJlY2lwZXMoYXJyYW5nZW1lbnRJZCkucGlwZShcbiAgICAgICAgICBtYXAoZGF0YSA9PiAoc3BlY2lmaWNhdGlvbklkcyA/IGRhdGEuZmlsdGVyKCh7IHNwZWNpZmljYXRpb25JZDogaWQgfSkgPT4gc3BlY2lmaWNhdGlvbklkcy5oYXMoaWQpKSA6IGRhdGEpKSxcbiAgICAgICAgICBtYXAoZGF0YSA9PlxuICAgICAgICAgICAgYXJyYW5nZW1lbnRJZCA/IGRhdGEuZmlsdGVyKGl0ZW0gPT4gIWl0ZW0uYXJyYW5nZW1lbnRJZCB8fCBpdGVtLmFycmFuZ2VtZW50SWQgPT09IGFycmFuZ2VtZW50SWQpIDogZGF0YSxcbiAgICAgICAgICApLFxuICAgICAgICAgIG1hcChkYXRhID0+XG4gICAgICAgICAgICBsb2FkQWN0aW9uUmVjaXBlc1N1Y2Nlc3Moe1xuICAgICAgICAgICAgICBhY3Rpb25SZWNpcGVzOiBkYXRhIHx8IFtdLFxuICAgICAgICAgICAgICBzcGVjaWZpY2F0aW9uSWRzLFxuICAgICAgICAgICAgfSksXG4gICAgICAgICAgKSxcbiAgICAgICAgICBjYXRjaEVycm9yKGVycm9yID0+IG9mKGxvYWRBY3Rpb25SZWNpcGVzRmFpbGVkKHsgZXJyb3IgfSkpKSxcbiAgICAgICAgKSxcbiAgICAgICksXG4gICAgKSxcbiAgKTtcblxuICBzYXZlQWN0aW9uUmVjaXBlJCA9IGNyZWF0ZUVmZmVjdCgoKSA9PlxuICAgIHRoaXMuYWN0aW9ucyQucGlwZShcbiAgICAgIG9mVHlwZShzYXZlQWN0aW9uUmVjaXBlKSxcbiAgICAgIGdyb3VwQnkoKHsgYWN0aW9uUmVjaXBlIH0pID0+IGFjdGlvblJlY2lwZS5zcGVjaWZpY2F0aW9uSWQpLFxuICAgICAgbWVyZ2VNYXAoZ3JvdXAgPT5cbiAgICAgICAgZ3JvdXAucGlwZShcbiAgICAgICAgICBzd2l0Y2hNYXAoKHsgYWN0aW9uUmVjaXBlLCBhcnJhbmdlbWVudElkLCB3YXJuaW5nTm90aWZpY2F0aW9uLCBzdWNjZXNzTm90aWZpY2F0aW9uIH0pID0+XG4gICAgICAgICAgICB0aGlzLmRhdGFTZXJ2aWNlLnNhdmVBY3Rpb25SZWNpcGUoYWN0aW9uUmVjaXBlLCBhcnJhbmdlbWVudElkKS5waXBlKFxuICAgICAgICAgICAgICBzd2l0Y2hNYXAoKHsgYWN0aW9uUmVjaXBlcyB9KSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKCFhY3Rpb25SZWNpcGVzIHx8ICFhY3Rpb25SZWNpcGVzLmxlbmd0aCkgcmV0dXJuIHRocm93RXJyb3IoRU1QVFlfUkVTUE9OU0VfRVJST1IpO1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuIG9mKFxuICAgICAgICAgICAgICAgICAgc2F2ZUFjdGlvblJlY2lwZVN1Y2Nlc3Moe1xuICAgICAgICAgICAgICAgICAgICBhY3Rpb25SZWNpcGU6IHtcbiAgICAgICAgICAgICAgICAgICAgICAuLi5hY3Rpb25SZWNpcGVzWzBdLFxuICAgICAgICAgICAgICAgICAgICAgIC4uLihhY3Rpb25SZWNpcGVzWzBdLnJlY3VycmVuY2UgJiYge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVjdXJyZW5jZTogZ2V0TWFwcGVkUmVjdXJyZW5jZVJlc3BvbnNlKGFjdGlvblJlY2lwZXNbMF0ucmVjdXJyZW5jZSwgYWN0aW9uUmVjaXBlKSxcbiAgICAgICAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgLi4uKHN1Y2Nlc3NOb3RpZmljYXRpb24gJiYgeyBub3RpZmljYXRpb246IHN1Y2Nlc3NOb3RpZmljYXRpb24gfSksXG4gICAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgY2F0Y2hFcnJvcihlcnIgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChlcnIuc3RhdHVzID09PSA0MDkpIHtcbiAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnN0b3JlLnNlbGVjdChhY3Rpb25SZWNpcGVzU3BlY2lmaWNhdGlvbklkcykucGlwZShcbiAgICAgICAgICAgICAgICAgICAgZmlyc3QoKSxcbiAgICAgICAgICAgICAgICAgICAgbWFwKHNwZWNpZmljYXRpb25JZHMgPT5cbiAgICAgICAgICAgICAgICAgICAgICBsb2FkQWN0aW9uUmVjaXBlcyh7XG4gICAgICAgICAgICAgICAgICAgICAgICBhcnJhbmdlbWVudElkLFxuICAgICAgICAgICAgICAgICAgICAgICAgc3BlY2lmaWNhdGlvbklkcyxcbiAgICAgICAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcmV0dXJuIG9mKFxuICAgICAgICAgICAgICAgICAgc2F2ZUFjdGlvblJlY2lwZUZhaWx1cmUoe1xuICAgICAgICAgICAgICAgICAgICBhY3Rpb25SZWNpcGU6IHBhcnNlQWN0aW9uUmVjaXBlRm9ybUl0ZW0oYWN0aW9uUmVjaXBlKSxcbiAgICAgICAgICAgICAgICAgICAgLi4uKHdhcm5pbmdOb3RpZmljYXRpb24gJiYgeyBub3RpZmljYXRpb246IHdhcm5pbmdOb3RpZmljYXRpb24gfSksXG4gICAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICksXG4gICAgICAgICAgKSxcbiAgICAgICAgKSxcbiAgICAgICksXG4gICAgKSxcbiAgKTtcblxuICBzaG93Tm90aWZpY2F0aW9uJCA9IGNyZWF0ZUVmZmVjdChcbiAgICAoKSA9PlxuICAgICAgbWVyZ2UoXG4gICAgICAgIHRoaXMuYWN0aW9ucyQucGlwZShvZlR5cGUoc2F2ZUFjdGlvblJlY2lwZVN1Y2Nlc3MpKSxcbiAgICAgICAgdGhpcy5hY3Rpb25zJC5waXBlKG9mVHlwZShzYXZlQWN0aW9uUmVjaXBlRmFpbHVyZSkpLFxuICAgICAgKS5waXBlKFxuICAgICAgICBtYXAoKHsgbm90aWZpY2F0aW9uIH0pID0+IHtcbiAgICAgICAgICBpZiAobm90aWZpY2F0aW9uKSB7XG4gICAgICAgICAgICB0aGlzLm5vdGlmaWNhdGlvblNlcnZpY2Uuc2hvd05vdGlmaWNhdGlvbihub3RpZmljYXRpb24pO1xuICAgICAgICAgIH1cbiAgICAgICAgfSksXG4gICAgICApLFxuICAgIHsgZGlzcGF0Y2g6IGZhbHNlIH0sXG4gICk7XG59XG4iXX0=