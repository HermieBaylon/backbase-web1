import { Injectable } from '@angular/core';
import { mergeNotificationChannels } from '../helpers/mappers';
import { hoursToMinutesArray } from '../helpers/time.helper';
import * as i0 from "@angular/core";
import * as i1 from "@angular/forms";
export class ActionsFormBuilderService {
    constructor(fb) {
        this.fb = fb;
    }
    /**
     * Method to build action recipe form group.
     *
     * @param specification - acton recipe specification
     * @param actionRecipe - action recipe
     * @param account - account data
     * @returns prefilled form object
     */
    buildActionRecipeFormGroup(specification, actionRecipe, account) {
        const actionRecipeFormValue = this.buildActionRecipeFormValue(specification, actionRecipe, account);
        return this.fb.group(Object.assign(Object.assign({}, actionRecipeFormValue), { actions: this.fb.group(actionRecipeFormValue.actions), recurrence: this.buildScheduleNotificationsFormGroup(actionRecipe) }));
    }
    /**
     * Method to build action recipe form value.
     *
     * @param specification - acton recipe specification
     * @param actionRecipe - action recipe
     * @param account - account data
     * @returns action recipe form value object
     */
    buildActionRecipeFormValue(specification, actionRecipe, account) {
        var _a, _b;
        const { actions, amount, active, recurrence, id, specificationId, name } = actionRecipe || this.getDefaultActionRecipe(specification);
        return Object.assign({ id, 
            // tslint:disable-next-line:no-null-keyword
            name: name || null, specificationId,
            active, recurrence: this.buildRecurrenceFormItem(recurrence), amount: {
                amount,
                currency: account ? account.currency : {},
            }, actions: this.buildChannelsFormValue(actions) }, (((_a = specification.recipeDefaults) === null || _a === void 0 ? void 0 : _a.additions) && { additions: Object.assign({}, (_b = specification.recipeDefaults) === null || _b === void 0 ? void 0 : _b.additions) }));
    }
    /**
     * Method to build schedule notificatons form group.
     *
     * @param actionRecipe - action recipe
     * @returns prefilled form object
     */
    buildScheduleNotificationsFormGroup(actionRecipe) {
        return this.fb.group({
            scheduleTime: this.getTimeOptions(actionRecipe),
        });
    }
    getDefaultActionRecipe(specification) {
        return {
            // tslint:disable-next-line:no-null-keyword
            id: null,
            // tslint:disable-next-line:no-null-keyword
            name: specification.name || null,
            specificationId: specification.id,
            amount: (specification.recipeDefaults && specification.recipeDefaults.amount) || '0',
            active: false,
            actions: mergeNotificationChannels(specification.actions, (specification.recipeDefaults && specification.recipeDefaults.actions) || []),
        };
    }
    buildChannelsFormValue(channels) {
        return channels.reduce((previous, current) => (Object.assign(Object.assign({}, previous), { [current.type]: current.enabled })), {});
    }
    buildRecurrenceFormItem(recurrence) {
        return Object.assign({ scheduleTime: hoursToMinutesArray(recurrence === null || recurrence === void 0 ? void 0 : recurrence.hoursOfDay) }, ((recurrence === null || recurrence === void 0 ? void 0 : recurrence.daysOfWeek) && { daysOfWeek: recurrence === null || recurrence === void 0 ? void 0 : recurrence.daysOfWeek }));
    }
    getTimeOptions(recipe) {
        var _a, _b;
        const mappedHours = ((_b = (_a = recipe === null || recipe === void 0 ? void 0 : recipe.recurrence) === null || _a === void 0 ? void 0 : _a.hoursOfDay) === null || _b === void 0 ? void 0 : _b.map(option => this.fb.control(Number(option) * 60))) || [];
        return this.fb.array((mappedHours === null || mappedHours === void 0 ? void 0 : mappedHours.length) !== 24 ? mappedHours : []);
    }
}
ActionsFormBuilderService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.14", ngImport: i0, type: ActionsFormBuilderService, deps: [{ token: i1.FormBuilder }], target: i0.ɵɵFactoryTarget.Injectable });
ActionsFormBuilderService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "12.2.14", ngImport: i0, type: ActionsFormBuilderService });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.14", ngImport: i0, type: ActionsFormBuilderService, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.FormBuilder }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWN0aW9ucy1mb3JtLWJ1aWxkZXIuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL2xpYnMvYWN0aW9ucy1jb21tb24tYW5nL3NyYy9zZXJ2aWNlcy9hY3Rpb25zLWZvcm0tYnVpbGRlci5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFjM0MsT0FBTyxFQUFFLHlCQUF5QixFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFFL0QsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7OztBQVU3RCxNQUFNLE9BQU8seUJBQXlCO0lBQ3BDLFlBQTZCLEVBQWU7UUFBZixPQUFFLEdBQUYsRUFBRSxDQUFhO0lBQUcsQ0FBQztJQUVoRDs7Ozs7OztPQU9HO0lBQ0gsMEJBQTBCLENBQ3hCLGFBQXdDLEVBQ3hDLFlBQTBDLEVBQzFDLE9BQWdDO1FBRWhDLE1BQU0scUJBQXFCLEdBQUcsSUFBSSxDQUFDLDBCQUEwQixDQUFDLGFBQWEsRUFBRSxZQUFZLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFFcEcsT0FBTyxJQUFJLENBQUMsRUFBRSxDQUFDLEtBQUssaUNBQ2YscUJBQXFCLEtBQ3hCLE9BQU8sRUFBRSxJQUFJLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxxQkFBcUIsQ0FBQyxPQUFPLENBQUMsRUFDckQsVUFBVSxFQUFFLElBQUksQ0FBQyxtQ0FBbUMsQ0FBQyxZQUFZLENBQUMsSUFDbEUsQ0FBQztJQUNMLENBQUM7SUFFRDs7Ozs7OztPQU9HO0lBQ0gsMEJBQTBCLENBQ3hCLGFBQXdDLEVBQ3hDLFlBQTBDLEVBQzFDLE9BQWdDOztRQUVoQyxNQUFNLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLEVBQUUsRUFBRSxlQUFlLEVBQUUsSUFBSSxFQUFFLEdBQ3RFLFlBQVksSUFBSSxJ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eUI7MkhBQXpCLHlCQUF5Qjs0RkFBekIseUJBQXlCO2tCQURyQyxVQUFVIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgRm9ybUFycmF5LCBGb3JtQnVpbGRlciwgRm9ybUdyb3VwIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuaW1wb3J0IHtcbiAgQWN0aW9uUGFyZW50LFxuICBBY3Rpb24sXG4gIEFjdGlvblJlY2lwZUdldFJlc3BvbnNlQm9keSxcbiAgQWN0aW9uUmVjaXBlU3BlY2lmaWNhdGlvbixcbiAgUmVjdXJyZW5jZSxcbn0gZnJvbSAnQGJhY2tiYXNlL2RhdGEtYW5nL2FjdGlvbnMnO1xuaW1wb3J0IHtcbiAgQWN0aW9uUmVjaXBlQ2hhbm5lbHNGb3JtVmFsdWUsXG4gIEFjdGlvblJlY2lwZUZvcm1JdGVtVmFsdWUsXG4gIEFjdGlvblJlY3VycmVuY2VGb3JtVmFsdWUsXG59IGZyb20gJy4uL21vZGVscy9hY3Rpb24tcmVjaXBlcy1mb3JtLXZhbHVlLm1vZGVsJztcbmltcG9ydCB7IG1lcmdlTm90aWZpY2F0aW9uQ2hhbm5lbHMgfSBmcm9tICcuLi9oZWxwZXJzL21hcHBlcnMnO1xuaW1wb3J0IHsgQWNjb3VudEFycmFuZ2VtZW50SXRlbSB9IGZyb20gJ0BiYWNrYmFzZS9kYXRhLWFuZy9hcnJhbmdlbWVudHMnO1xuaW1wb3J0IHsgaG91cnNUb01pbnV0ZXNBcnJheSB9IGZyb20gJy4uL2hlbHBlcnMvdGltZS5oZWxwZXInO1xuXG5pbnRlcmZhY2UgRGVmYXVsdEFjdGlvblJlY2lwZSBleHRlbmRzIFBpY2s8QWN0aW9uUmVjaXBlR2V0UmVzcG9uc2VCb2R5LCAnYWN0aW9ucycgfCAnYWN0aXZlJyB8ICdzcGVjaWZpY2F0aW9uSWQnPiB7XG4gIGlkOiBzdHJpbmcgfCBudWxsO1xuICBuYW1lOiBzdHJpbmcgfCBudWxsO1xuICBhbW91bnQ6IHN0cmluZztcbiAgcmVjdXJyZW5jZT86IFJlY3VycmVuY2U7XG59XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBBY3Rpb25zRm9ybUJ1aWxkZXJTZXJ2aWNlIHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBmYjogRm9ybUJ1aWxkZXIpIHt9XG5cbiAgLyoqXG4gICAqIE1ldGhvZCB0byBidWlsZCBhY3Rpb24gcmVjaXBlIGZvcm0gZ3JvdXAuXG4gICAqXG4gICAqIEBwYXJhbSBzcGVjaWZpY2F0aW9uIC0gYWN0b24gcmVjaXBlIHNwZWNpZmljYXRpb25cbiAgICogQHBhcmFtIGFjdGlvblJlY2lwZSAtIGFjdGlvbiByZWNpcGVcbiAgICogQHBhcmFtIGFjY291bnQgLSBhY2NvdW50IGRhdGFcbiAgICogQHJldHVybnMgcHJlZmlsbGVkIGZvcm0gb2JqZWN0XG4gICAqL1xuICBidWlsZEFjdGlvblJlY2lwZUZvcm1Hcm91cChcbiAgICBzcGVjaWZpY2F0aW9uOiBBY3Rpb25SZWNpcGVTcGVjaWZpY2F0aW9uLFxuICAgIGFjdGlvblJlY2lwZT86IEFjdGlvblJlY2lwZUdldFJlc3BvbnNlQm9keSxcbiAgICBhY2NvdW50PzogQWNjb3VudEFycmFuZ2VtZW50SXRlbSxcbiAgKTogRm9ybUdyb3VwIHtcbiAgICBjb25zdCBhY3Rpb25SZWNpcGVGb3JtVmFsdWUgPSB0aGlzLmJ1aWxkQWN0aW9uUmVjaXBlRm9ybVZhbHVlKHNwZWNpZmljYXRpb24sIGFjdGlvblJlY2lwZSwgYWNjb3VudCk7XG5cbiAgICByZXR1cm4gdGhpcy5mYi5ncm91cCh7XG4gICAgICAuLi5hY3Rpb25SZWNpcGVGb3JtVmFsdWUsXG4gICAgICBhY3Rpb25zOiB0aGlzLmZiLmdyb3VwKGFjdGlvblJlY2lwZUZvcm1WYWx1ZS5hY3Rpb25zKSxcbiAgICAgIHJlY3VycmVuY2U6IHRoaXMuYnVpbGRTY2hlZHVsZU5vdGlmaWNhdGlvbnNGb3JtR3JvdXAoYWN0aW9uUmVjaXBlKSxcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBNZXRob2QgdG8gYnVpbGQgYWN0aW9uIHJlY2lwZSBmb3JtIHZhbHVlLlxuICAgKlxuICAgKiBAcGFyYW0gc3BlY2lmaWNhdGlvbiAtIGFjdG9uIHJlY2lwZSBzcGVjaWZpY2F0aW9uXG4gICAqIEBwYXJhbSBhY3Rpb25SZWNpcGUgLSBhY3Rpb24gcmVjaXBlXG4gICAqIEBwYXJhbSBhY2NvdW50IC0gYWNjb3VudCBkYXRhXG4gICAqIEByZXR1cm5zIGFjdGlvbiByZWNpcGUgZm9ybSB2YWx1ZSBvYmplY3RcbiAgICovXG4gIGJ1aWxkQWN0aW9uUmVjaXBlRm9ybVZhbHVlKFxuICAgIHNwZWNpZmljYXRpb246IEFjdGlvblJlY2lwZVNwZWNpZmljYXRpb24sXG4gICAgYWN0aW9uUmVjaXBlPzogQWN0aW9uUmVjaXBlR2V0UmVzcG9uc2VCb2R5LFxuICAgIGFjY291bnQ/OiBBY2NvdW50QXJyYW5nZW1lbnRJdGVtLFxuICApOiBBY3Rpb25SZWNpcGVGb3JtSXRlbVZhbHVlIHtcbiAgICBjb25zdCB7IGFjdGlvbnMsIGFtb3VudCwgYWN0aXZlLCByZWN1cnJlbmNlLCBpZCwgc3BlY2lmaWNhdGlvbklkLCBuYW1lIH0gPVxuICAgICAgYWN0aW9uUmVjaXBlIHx8IHRoaXMuZ2V0RGVmYXVsdEFjdGlvblJlY2lwZShzcGVjaWZpY2F0aW9uKTtcblxuICAgIHJldHVybiB7XG4gICAgICBpZCxcbiAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1udWxsLWtleXdvcmRcbiAgICAgIG5hbWU6IG5hbWUgfHwgbnVsbCxcbiAgICAgIHNwZWNpZmljYXRpb25JZCxcbiAgICAgIGFjdGl2ZSxcbiAgICAgIHJlY3VycmVuY2U6IHRoaXMuYnVpbGRSZWN1cnJlbmNlRm9ybUl0ZW0ocmVjdXJyZW5jZSksXG4gICAgICBhbW91bnQ6IHtcbiAgICAgICAgYW1vdW50LFxuICAgICAgICBjdXJyZW5jeTogYWNjb3VudCA/IGFjY291bnQuY3VycmVuY3kgOiB7fSxcbiAgICAgIH0gYXMgeyBhbW91bnQ6IHN0cmluZzsgY3VycmVuY3k6IHN0cmluZyB8IG9iamVjdCB9LFxuICAgICAgYWN0aW9uczogdGhpcy5idWlsZENoYW5uZWxzRm9ybVZhbHVlKGFjdGlvbnMpLFxuICAgICAgLi4uKHNwZWNpZmljYXRpb24ucmVjaXBlRGVmYXVsdHM/LmFkZGl0aW9ucyAmJiB7IGFkZGl0aW9uczogeyAuLi5zcGVjaWZpY2F0aW9uLnJlY2lwZURlZmF1bHRzPy5hZGRpdGlvbnMgfSB9KSxcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIE1ldGhvZCB0byBidWlsZCBzY2hlZHVsZSBub3RpZmljYXRvbnMgZm9ybSBncm91cC5cbiAgICpcbiAgICogQHBhcmFtIGFjdGlvblJlY2lwZSAtIGFjdGlvbiByZWNpcGVcbiAgICogQHJldHVybnMgcHJlZmlsbGVkIGZvcm0gb2JqZWN0XG4gICAqL1xuICBidWlsZFNjaGVkdWxlTm90aWZpY2F0aW9uc0Zvcm1Hcm91cChhY3Rpb25SZWNpcGU/OiBBY3Rpb25SZWNpcGVHZXRSZXNwb25zZUJvZHkpOiBGb3JtR3JvdXAge1xuICAgIHJldHVybiB0aGlzLmZiLmdyb3VwKHtcbiAgICAgIHNjaGVkdWxlVGltZTogdGhpcy5nZXRUaW1lT3B0aW9ucyhhY3Rpb25SZWNpcGUpLFxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXREZWZhdWx0QWN0aW9uUmVjaXBlKHNwZWNpZmljYXRpb246IEFjdGlvblJlY2lwZVNwZWNpZmljYXRpb24pOiBEZWZhdWx0QWN0aW9uUmVjaXBlIHtcbiAgICByZXR1cm4ge1xuICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLW51bGwta2V5d29yZFxuICAgICAgaWQ6IG51bGwsXG4gICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tbnVsbC1rZXl3b3JkXG4gICAgICBuYW1lOiBzcGVjaWZpY2F0aW9uLm5hbWUgfHwgbnVsbCxcbiAgICAgIHNwZWNpZmljYXRpb25JZDogc3BlY2lmaWNhdGlvbi5pZCBhcyBzdHJpbmcsXG4gICAgICBhbW91bnQ6IChzcGVjaWZpY2F0aW9uLnJlY2lwZURlZmF1bHRzICYmIHNwZWNpZmljYXRpb24ucmVjaXBlRGVmYXVsdHMuYW1vdW50KSB8fCAnMCcsXG4gICAgICBhY3RpdmU6IGZhbHNlLFxuICAgICAgYWN0aW9uczogbWVyZ2VOb3RpZmljYXRpb25DaGFubmVscyhcbiAgICAgICAgc3BlY2lmaWNhdGlvbi5hY3Rpb25zIGFzIEFjdGlvblBhcmVudFtdLFxuICAgICAgICAoc3BlY2lmaWNhdGlvbi5yZWNpcGVEZWZhdWx0cyAmJiBzcGVjaWZpY2F0aW9uLnJlY2lwZURlZmF1bHRzLmFjdGlvbnMpIHx8IFtdLFxuICAgICAgKSxcbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSBidWlsZENoYW5uZWxzRm9ybVZhbHVlKGNoYW5uZWxzOiBBY3Rpb25bXSk6IEFjdGlvblJlY2lwZUNoYW5uZWxzRm9ybVZhbHVlIHtcbiAgICByZXR1cm4gY2hhbm5lbHMucmVkdWNlKFxuICAgICAgKHByZXZpb3VzLCBjdXJyZW50KSA9PiAoe1xuICAgICAgICAuLi5wcmV2aW91cyxcbiAgICAgICAgW2N1cnJlbnQudHlwZV06IGN1cnJlbnQuZW5hYmxlZCxcbiAgICAgIH0pLFxuICAgICAge30sXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgYnVpbGRSZWN1cnJlbmNlRm9ybUl0ZW0ocmVjdXJyZW5jZTogUmVjdXJyZW5jZSB8IHVuZGVmaW5lZCk6IEFjdGlvblJlY3VycmVuY2VGb3JtVmFsdWUge1xuICAgIHJldHVybiB7XG4gICAgICBzY2hlZHVsZVRpbWU6IGhvdXJzVG9NaW51dGVzQXJyYXkocmVjdXJyZW5jZT8uaG91cnNPZkRheSksXG4gICAgICAuLi4ocmVjdXJyZW5jZT8uZGF5c09mV2VlayAmJiB7IGRheXNPZldlZWs6IHJlY3VycmVuY2U/LmRheXNPZldlZWsgfSksXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0VGltZU9wdGlvbnMocmVjaXBlPzogQWN0aW9uUmVjaXBlR2V0UmVzcG9uc2VCb2R5KTogRm9ybUFycmF5IHtcbiAgICBjb25zdCBtYXBwZWRIb3VycyA9IHJlY2lwZT8ucmVjdXJyZW5jZT8uaG91cnNPZkRheT8ubWFwKG9wdGlvbiA9PiB0aGlzLmZiLmNvbnRyb2woTnVtYmVyKG9wdGlvbikgKiA2MCkpIHx8IFtdO1xuXG4gICAgcmV0dXJuIHRoaXMuZmIuYXJyYXkobWFwcGVkSG91cnM/Lmxlbmd0aCAhPT0gMjQgPyBtYXBwZWRIb3VycyA6IFtdKTtcbiAgfVxufVxuIl19