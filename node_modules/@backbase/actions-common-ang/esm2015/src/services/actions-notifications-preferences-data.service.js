import { Injectable } from '@angular/core';
import { BehaviorSubject, of } from 'rxjs';
import { map, switchMap, withLatestFrom } from 'rxjs/operators';
import { PreferenceDataMap } from '../models/notification-to-specification-id.model';
import { fromHttpResponse } from '../helpers/mappers';
import * as i0 from "@angular/core";
import * as i1 from "@backbase/data-ang/engagement";
export class ActionsNotificationsPreferencesDataService {
    constructor(dataHttpService) {
        this.dataHttpService = dataHttpService;
        this.cachedNotificationPreferences$$ = new BehaviorSubject([]);
        this.mapSavePreferenceResponce = () => (preference) => preference.pipe(withLatestFrom(this.cachedNotificationPreferences$$), switchMap(([pref, preferences]) => {
            this.updatePreferencesCache(preferences, pref);
            return of({
                actionRecipes: [this.preferenceToRecipe(pref)],
            });
        }));
        this.preferenceToSpecification = ({ userConditions, channels, generalNotificationId, }) => {
            var _a, _b, _c;
            return ({
                actions: channels.map(channel => ({ type: channel.channel })),
                recipeDefaults: Object.assign({}, (((_a = userConditions === null || userConditions === void 0 ? void 0 : userConditions.conditions) === null || _a === void 0 ? void 0 : _a.hasOwnProperty('amount')) && {
                    amount: `${(_b = userConditions === null || userConditions === void 0 ? void 0 : userConditions.conditions) === null || _b === void 0 ? void 0 : _b.amount}`,
                })),
                id: (_c = Object.values(PreferenceDataMap).find(pref => pref.generalNotificationId === generalNotificationId)) === null || _c === void 0 ? void 0 : _c.specificationId,
            });
        };
        this.preferenceToRecipe = ({ channels, userConditions, createdOn, generalNotificationId, active, id, }) => {
            var _a, _b, _c;
            return (Object.assign(Object.assign({ specificationId: (_a = Object.values(PreferenceDataMap).find(pref => pref.generalNotificationId === generalNotificationId)) === null || _a === void 0 ? void 0 : _a.specificationId, active, actions: channels.map(channel => ({
                    type: channel.channel,
                    enabled: channel.enabled,
                })), createdOn }, (((_b = userConditions === null || userConditions === void 0 ? void 0 : userConditions.conditions) === null || _b === void 0 ? void 0 : _b.hasOwnProperty('amount')) && {
                amount: `${(_c = userConditions === null || userConditions === void 0 ? void 0 : userConditions.conditions) === null || _c === void 0 ? void 0 : _c.amount}`,
            })), { id: id || '' }));
        };
    }
    /**
     * Method to get action recipes.
     *
     * @param arrangementId
     * @returns action recipe array
     */
    getActionRecipes(arrangementId) {
        const requestParams = {
            entityId: arrangementId,
            entityType: 'arrangement',
        };
        return this.dataHttpService.getNotificationPreferences(requestParams).pipe(map(fromHttpResponse), map(({ notificationPreferences }) => {
            this.cachedNotificationPreferences$$.next(notificationPreferences);
            return notificationPreferences.map(pref => this.preferenceToRecipe(pref));
        }));
    }
    /**
     * Method to get action recipe specifications.
     *
     * @returns action recipe specifications
     */
    getSpecifications() {
        return this.cachedNotificationPreferences$$.pipe(map(fromHttpResponse), map(notificationPreferences => notificationPreferences.map(pref => this.preferenceToSpecification(pref))));
    }
    /**
     * Method to save action recipe.
     *
     * @param action - recipe form value
     * @param arrangementId - arrangement ID
     * @returns batch processing response
     */
    saveActionRecipe(actionRecipeFormItem, arrangementId) {
        const notificationPreferences = this.cachedNotificationPreferences$$.getValue();
        const preferenceToUpdate = notificationPreferences.find(pref => pref.generalNotificationId === PreferenceDataMap[actionRecipeFormItem.specificationId].generalNotificationId);
        if (preferenceToUpdate.id) {
            return this.updateNotificationPreference(preferenceToUpdate, actionRecipeFormItem);
        }
        else {
            return this.createNotificationPreference(preferenceToUpdate, actionRecipeFormItem, arrangementId);
        }
    }
    updateNotificationPreference(preferenceToUpdate, actionRecipeFormItem) {
        const notificationPreferencePutRequest = this.getNotificationPreferencePutRequest(preferenceToUpdate, actionRecipeFormItem);
        return this.dataHttpService
            .updateNotificationPreference({ id: preferenceToUpdate.id || '', notificationPreferencePutRequest })
            .pipe(this.mapSavePreferenceResponce());
    }
    createNotificationPreference(preferenceToUpdate, actionRecipeFormItem, arrangementId) {
        const notificationPreferencePostRequest = this.getNotificationPreferencePostRequest(preferenceToUpdate, actionRecipeFormItem, arrangementId);
        return this.dataHttpService
            .createNotificationPreference({ notificationPreferencePostRequest })
            .pipe(this.mapSavePreferenceResponce());
    }
    getNotificationPreferencePutRequest(preference, actionRecipeFormItem) {
        return {
            active: actionRecipeFormItem.active,
            channels: preference.channels.map(channel => (Object.assign(Object.assign({}, channel), { enabled: !!actionRecipeFormItem.actions[channel.channel] }))),
            conditions: Object.assign({}, (actionRecipeFormItem.amount.amount !== undefined && {
                amount: `${actionRecipeFormItem.amount.amount}`,
            })),
        };
    }
    getNotificationPreferencePostRequest(preference, actionRecipeFormItem, arrangementId) {
        var _a;
        return {
            generalNotificationId: preference.generalNotificationId,
            active: actionRecipeFormItem.active,
            eRef: arrangementId,
            channels: preference.channels.map(channel => (Object.assign(Object.assign({}, channel), { enabled: !!actionRecipeFormItem.actions[channel.channel] }))),
            conditions: Object.assign({}, (_a = preference.userConditions) === null || _a === void 0 ? void 0 : _a.conditions),
        };
    }
    updatePreferencesCache(preferences, updatedPreference) {
        const updatedPreferences = preferences.map(pref => pref.generalNotificationId === updatedPreference.generalNotificationId ? updatedPreference : pref);
        this.cachedNotificationPreferences$$.next(updatedPreferences);
    }
}
ActionsNotificationsPreferencesDataService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.14", ngImport: i0, type: ActionsNotificationsPreferencesDataService, deps: [{ token: i1.NotificationPreferenceService }], target: i0.ɵɵFactoryTarget.Injectable });
ActionsNotificationsPreferencesDataService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "12.2.14", ngImport: i0, type: ActionsNotificationsPreferencesDataService });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.14", ngImport: i0, type: ActionsNotificationsPreferencesDataService, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.NotificationPreferenceService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWN0aW9ucy1ub3RpZmljYXRpb25zLXByZWZlcmVuY2VzLWRhdGEuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL2xpYnMvYWN0aW9ucy1jb21tb24tYW5nL3NyYy9zZXJ2aWNlcy9hY3Rpb25zLW5vdGlmaWNhdGlvbnMtcHJlZmVyZW5jZXMtZGF0YS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLGVBQWUsRUFBYyxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdkQsT0FBTyxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsY0FBYyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFlaEUsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sa0RBQWtELENBQUM7QUFFckYsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sb0JBQW9CLENBQUM7OztBQUd0RCxNQUFNLE9BQU8sMENBQTBDO0lBR3JELFlBQTZCLGVBQThDO1FBQTlDLG9CQUFlLEdBQWYsZUFBZSxDQUErQjtRQUYxRCxvQ0FBK0IsR0FBRyxJQUFJLGVBQWUsQ0FBMkIsRUFBRSxDQUFDLENBQUM7UUE0RjdGLDhCQUF5QixHQUFHLEdBQUcsRUFBRSxDQUFDLENBQUMsVUFBOEMsRUFBRSxFQUFFLENBQzNGLFVBQVUsQ0FBQyxJQUFJLENBQ2IsY0FBYyxDQUFDLElBQUksQ0FBQywrQkFBK0IsQ0FBQyxFQUNwRCxTQUFTLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxXQUFXLENBQUMsRUFBRSxFQUFFO1lBQ2hDLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxXQUFXLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFFL0MsT0FBTyxFQUFFLENBQUM7Z0JBQ1IsYUFBYSxFQUFFLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBaUIsQ0FBQzthQUM3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LENBQUM7WUFDSCxVQUFVLG9CQUFPLE1BQUEsVUFBVSxDQUFDLGNBQWMsMENBQUUsVUFBVSxDQUFFO1NBQ3pELENBQUM7SUFDSixDQUFDO0lBMENPLHNCQUFzQixDQUFDLFdBQXFDLEVBQUUsaUJBQXlDO1FBQzdHLE1BQU0sa0JBQWtCLEdBQUcsV0FBVyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUNoRCxJQUFJLENBQUMscUJBQXFCLEtBQUssaUJBQWlCLENBQUMscUJBQXFCLENBQUMsQ0FBQyxDQUFDLGlCQUFpQixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQ2xHLENBQUM7UUFDRixJQUFJLENBQUMsK0JBQStCLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLENBQUM7SUFDaEUsQ0FBQzs7d0lBekxVLDBDQUEwQzs0SUFBMUMsMENBQTBDOzRGQUExQywwQ0FBMEM7a0JBRHRELFVBQVUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QsIE9ic2VydmFibGUsIG9mIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBtYXAsIHN3aXRjaE1hcCwgd2l0aExhdGVzdEZyb20gfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQge1xuICBBY3Rpb25SZWNpcGUsXG4gIEFjdGlvblJlY2lwZVNwZWNpZmljYXRpb24sXG4gIEJhdGNoUHJvY2Vzc2luZ1B1dFJlc3BvbnNlQm9keSxcbiAgQWN0aW9uUmVjaXBlR2V0UmVzcG9uc2VCb2R5LFxufSBmcm9tICdAYmFja2Jhc2UvZGF0YS1hbmcvYWN0aW9ucyc7XG5pbXBvcnQge1xuICBOb3RpZmljYXRpb25QcmVmZXJlbmNlU2VydmljZSxcbiAgR2V0Tm90aWZpY2F0aW9uUHJlZmVyZW5jZXNSZXF1ZXN0UGFyYW1zLFxuICBOb3RpZmljYXRpb25QcmVmZXJlbmNlLFxuICBOb3RpZmljYXRpb25QcmVmZXJlbmNlUHV0UmVxdWVzdCxcbiAgTm90aWZpY2F0aW9uUHJlZmVyZW5jZVBvc3RSZXF1ZXN0LFxufSBmcm9tICdAYmFja2Jhc2UvZGF0YS1hbmcvZW5nYWdlbWVudCc7XG5pbXBvcnQgeyBBY3Rpb25SZWNpcGVGb3JtSXRlbVZhbHVlIH0gZnJvbSAnLi4vbW9kZWxzL2FjdGlvbi1yZWNpcGVzLWZvcm0tdmFsdWUubW9kZWwnO1xuaW1wb3J0IHsgUHJlZmVyZW5jZURhdGFNYXAgfSBmcm9tICcuLi9tb2RlbHMvbm90aWZpY2F0aW9uLXRvLXNwZWNpZmljYXRpb24taWQubW9kZWwnO1xuaW1wb3J0IHsgTm90aWZpY2F0aW9uc1ByZWZlcmVuY2VzQmFzZURhdGFTZXJ2aWNlIH0gZnJvbSAnLi9ub3RpZmljYXRpb24tcHJlZmVyZW5jZXMtYmFzZS1kYXRhLnNlcnZpY2UnO1xuaW1wb3J0IHsgZnJvbUh0dHBSZXNwb25zZSB9IGZyb20gJy4uL2hlbHBlcnMvbWFwcGVycyc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBBY3Rpb25zTm90aWZpY2F0aW9uc1ByZWZlcmVuY2VzRGF0YVNlcnZpY2UgaW1wbGVtZW50cyBOb3RpZmljYXRpb25zUHJlZmVyZW5jZXNCYXNlRGF0YVNlcnZpY2Uge1xuICBwcml2YXRlIHJlYWRvbmx5IGNhY2hlZE5vdGlmaWNhdGlvblByZWZlcmVuY2VzJCQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PE5vdGlmaWNhdGlvblByZWZlcmVuY2VbXT4oW10pO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgZGF0YUh0dHBTZXJ2aWNlOiBOb3RpZmljYXRpb25QcmVmZXJlbmNlU2VydmljZSkge31cblxuICAvKipcbiAgICogTWV0aG9kIHRvIGdldCBhY3Rpb24gcmVjaXBlcy5cbiAgICpcbiAgICogQHBhcmFtIGFycmFuZ2VtZW50SWRcbiAgICogQHJldHVybnMgYWN0aW9uIHJlY2lwZSBhcnJheVxuICAgKi9cbiAgZ2V0QWN0aW9uUmVjaXBlcyhhcnJhbmdlbWVudElkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPEFjdGlvblJlY2lwZVtdPiB7XG4gICAgY29uc3QgcmVxdWVzdFBhcmFtcyA9IHtcbiAgICAgIGVudGl0eUlkOiBhcnJhbmdlbWVudElkLFxuICAgICAgZW50aXR5VHlwZTogJ2FycmFuZ2VtZW50JyxcbiAgICB9IGFzIEdldE5vdGlmaWNhdGlvblByZWZlcmVuY2VzUmVxdWVzdFBhcmFtcztcblxuICAgIHJldHVybiB0aGlzLmRhdGFIdHRwU2VydmljZS5nZXROb3RpZmljYXRpb25QcmVmZXJlbmNlcyhyZXF1ZXN0UGFyYW1zKS5waXBlKFxuICAgICAgbWFwKGZyb21IdHRwUmVzcG9uc2UpLFxuICAgICAgbWFwKCh7IG5vdGlmaWNhdGlvblByZWZlcmVuY2VzIH0pID0+IHtcbiAgICAgICAgdGhpcy5jYWNoZWROb3RpZmljYXRpb25QcmVmZXJlbmNlcyQkLm5leHQobm90aWZpY2F0aW9uUHJlZmVyZW5jZXMpO1xuXG4gICAgICAgIHJldHVybiBub3RpZmljYXRpb25QcmVmZXJlbmNlcy5tYXAocHJlZiA9PiB0aGlzLnByZWZlcmVuY2VUb1JlY2lwZShwcmVmKSk7XG4gICAgICB9KSxcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIE1ldGhvZCB0byBnZXQgYWN0aW9uIHJlY2lwZSBzcGVjaWZpY2F0aW9ucy5cbiAgICpcbiAgICogQHJldHVybnMgYWN0aW9uIHJlY2lwZSBzcGVjaWZpY2F0aW9uc1xuICAgKi9cbiAgZ2V0U3BlY2lmaWNhdGlvbnMoKTogT2JzZXJ2YWJsZTxBY3Rpb25SZWNpcGVTcGVjaWZpY2F0aW9uW10+IHtcbiAgICByZXR1cm4gdGhpcy5jYWNoZWROb3RpZmljYXRpb25QcmVmZXJlbmNlcyQkLnBpcGUoXG4gICAgICBtYXAoZnJvbUh0dHBSZXNwb25zZSksXG4gICAgICBtYXAobm90aWZpY2F0aW9uUHJlZmVyZW5jZXMgPT4gbm90aWZpY2F0aW9uUHJlZmVyZW5jZXMubWFwKHByZWYgPT4gdGhpcy5wcmVmZXJlbmNlVG9TcGVjaWZpY2F0aW9uKHByZWYpKSksXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBNZXRob2QgdG8gc2F2ZSBhY3Rpb24gcmVjaXBlLlxuICAgKlxuICAgKiBAcGFyYW0gYWN0aW9uIC0gcmVjaXBlIGZvcm0gdmFsdWVcbiAgICogQHBhcmFtIGFycmFuZ2VtZW50SWQgLSBhcnJhbmdlbWVudCBJRFxuICAgKiBAcmV0dXJucyBiYXRjaCBwcm9jZXNzaW5nIHJlc3BvbnNlXG4gICAqL1xuICBzYXZlQWN0aW9uUmVjaXBlKFxuICAgIGFjdGlvblJlY2lwZUZvcm1JdGVtOiBBY3Rpb25SZWNpcGVGb3JtSXRlbVZhbHVlLFxuICAgIGFycmFuZ2VtZW50SWQ6IHN0cmluZyxcbiAgKTogT2JzZXJ2YWJsZTxCYXRjaFByb2Nlc3NpbmdQdXRSZXNwb25zZUJvZHk+IHtcbiAgICBjb25zdCBub3RpZmljYXRpb25QcmVmZXJlbmNlcyA9IHRoaXMuY2FjaGVkTm90aWZpY2F0aW9uUHJlZmVyZW5jZXMkJC5nZXRWYWx1ZSgpO1xuICAgIGNvbnN0IHByZWZlcmVuY2VUb1VwZGF0ZSA9IG5vdGlmaWNhdGlvblByZWZlcmVuY2VzLmZpbmQoXG4gICAgICBwcmVmID0+XG4gICAgICAgIHByZWYuZ2VuZXJhbE5vdGlmaWNhdGlvbklkID09PSBQcmVmZXJlbmNlRGF0YU1hcFthY3Rpb25SZWNpcGVGb3JtSXRlbS5zcGVjaWZpY2F0aW9uSWRdLmdlbmVyYWxOb3RpZmljYXRpb25JZCxcbiAgICApIGFzIE5vdGlmaWNhdGlvblByZWZlcmVuY2U7XG5cbiAgICBpZiAocHJlZmVyZW5jZVRvVXBkYXRlLmlkKSB7XG4gICAgICByZXR1cm4gdGhpcy51cGRhdGVOb3RpZmljYXRpb25QcmVmZXJlbmNlKHByZWZlcmVuY2VUb1VwZGF0ZSwgYWN0aW9uUmVjaXBlRm9ybUl0ZW0pO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdGhpcy5jcmVhdGVOb3RpZmljYXRpb25QcmVmZXJlbmNlKHByZWZlcmVuY2VUb1VwZGF0ZSwgYWN0aW9uUmVjaXBlRm9ybUl0ZW0sIGFycmFuZ2VtZW50SWQpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgdXBkYXRlTm90aWZpY2F0aW9uUHJlZmVyZW5jZShcbiAgICBwcmVmZXJlbmNlVG9VcGRhdGU6IE5vdGlmaWNhdGlvblByZWZlcmVuY2UsXG4gICAgYWN0aW9uUmVjaXBlRm9ybUl0ZW06IEFjdGlvblJlY2lwZUZvcm1JdGVtVmFsdWUsXG4gICk6IE9ic2VydmFibGU8QmF0Y2hQcm9jZXNzaW5nUHV0UmVzcG9uc2VCb2R5PiB7XG4gICAgY29uc3Qgbm90aWZpY2F0aW9uUHJlZmVyZW5jZVB1dFJlcXVlc3QgPSB0aGlzLmdldE5vdGlmaWNhdGlvblByZWZlcmVuY2VQdXRSZXF1ZXN0KFxuICAgICAgcHJlZmVyZW5jZVRvVXBkYXRlLFxuICAgICAgYWN0aW9uUmVjaXBlRm9ybUl0ZW0sXG4gICAgKTtcblxuICAgIHJldHVybiB0aGlzLmRhdGFIdHRwU2VydmljZVxuICAgICAgLnVwZGF0ZU5vdGlmaWNhdGlvblByZWZlcmVuY2UoeyBpZDogcHJlZmVyZW5jZVRvVXBkYXRlLmlkIHx8ICcnLCBub3RpZmljYXRpb25QcmVmZXJlbmNlUHV0UmVxdWVzdCB9KVxuICAgICAgLnBpcGUodGhpcy5tYXBTYXZlUHJlZmVyZW5jZVJlc3BvbmNlKCkpO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVOb3RpZmljYXRpb25QcmVmZXJlbmNlKFxuICAgIHByZWZlcmVuY2VUb1VwZGF0ZTogTm90aWZpY2F0aW9uUHJlZmVyZW5jZSxcbiAgICBhY3Rpb25SZWNpcGVGb3JtSXRlbTogQWN0aW9uUmVjaXBlRm9ybUl0ZW1WYWx1ZSxcbiAgICBhcnJhbmdlbWVudElkOiBzdHJpbmcsXG4gICk6IE9ic2VydmFibGU8QmF0Y2hQcm9jZXNzaW5nUHV0UmVzcG9uc2VCb2R5PiB7XG4gICAgY29uc3Qgbm90aWZpY2F0aW9uUHJlZmVyZW5jZVBvc3RSZXF1ZXN0ID0gdGhpcy5nZXROb3RpZmljYXRpb25QcmVmZXJlbmNlUG9zdFJlcXVlc3QoXG4gICAgICBwcmVmZXJlbmNlVG9VcGRhdGUsXG4gICAgICBhY3Rpb25SZWNpcGVGb3JtSXRlbSxcbiAgICAgIGFycmFuZ2VtZW50SWQsXG4gICAgKTtcblxuICAgIHJldHVybiB0aGlzLmRhdGFIdHRwU2VydmljZVxuICAgICAgLmNyZWF0ZU5vdGlmaWNhdGlvblByZWZlcmVuY2UoeyBub3RpZmljYXRpb25QcmVmZXJlbmNlUG9zdFJlcXVlc3QgfSlcbiAgICAgIC5waXBlKHRoaXMubWFwU2F2ZVByZWZlcmVuY2VSZXNwb25jZSgpKTtcbiAgfVxuXG4gIHByaXZhdGUgbWFwU2F2ZVByZWZlcmVuY2VSZXNwb25jZSA9ICgpID0+IChwcmVmZXJlbmNlOiBPYnNlcnZhYmxlPE5vdGlmaWNhdGlvblByZWZlcmVuY2U+KSA9PlxuICAgIHByZWZlcmVuY2UucGlwZShcbiAgICAgIHdpdGhMYXRlc3RGcm9tKHRoaXMuY2FjaGVkTm90aWZpY2F0aW9uUHJlZmVyZW5jZXMkJCksXG4gICAgICBzd2l0Y2hNYXAoKFtwcmVmLCBwcmVmZXJlbmNlc10pID0+IHtcbiAgICAgICAgdGhpcy51cGRhdGVQcmVmZXJlbmNlc0NhY2hlKHByZWZlcmVuY2VzLCBwcmVmKTtcblxuICAgICAgICByZXR1cm4gb2Yoe1xuICAgICAgICAgIGFjdGlvblJlY2lwZXM6IFt0aGlzLnByZWZlcmVuY2VUb1JlY2lwZShwcmVmKSBhcyBBY3Rpb25SZWNpcGVdLFxuICAgICAgICB9IGFzIEJhdGNoUHJvY2Vzc2luZ1B1dFJlc3BvbnNlQm9keSk7XG4gICAgICB9KSxcbiAgICApO1xuXG4gIHByaXZhdGUgZ2V0Tm90aWZpY2F0aW9uUHJlZmVyZW5jZVB1dFJlcXVlc3QoXG4gICAgcHJlZmVyZW5jZTogTm90aWZpY2F0aW9uUHJlZmVyZW5jZSxcbiAgICBhY3Rpb25SZWNpcGVGb3JtSXRlbTogQWN0aW9uUmVjaXBlRm9ybUl0ZW1WYWx1ZSxcbiAgKTogTm90aWZpY2F0aW9uUHJlZmVyZW5jZVB1dFJlcXVlc3Qge1xuICAgIHJldHVybiB7XG4gICAgICBhY3RpdmU6IGFjdGlvblJlY2lwZUZvcm1JdGVtLmFjdGl2ZSxcbiAgICAgIGNoYW5uZWxzOiBwcmVmZXJlbmNlLmNoYW5uZWxzLm1hcChjaGFubmVsID0+ICh7XG4gICAgICAgIC4uLmNoYW5uZWwsXG4gICAgICAgIGVuYWJsZWQ6ICEhYWN0aW9uUmVjaXBlRm9ybUl0ZW0uYWN0aW9uc1tjaGFubmVsLmNoYW5uZWxdLFxuICAgICAgfSkpLFxuICAgICAgY29uZGl0aW9uczoge1xuICAgICAgICAuLi4oYWN0aW9uUmVjaXBlRm9ybUl0ZW0uYW1vdW50LmFtb3VudCAhPT0gdW5kZWZpbmVkICYmIHtcbiAgICAgICAgICBhbW91bnQ6IGAke2FjdGlvblJlY2lwZUZvcm1JdGVtLmFtb3VudC5hbW91bnR9YCBhcyBhbnksXG4gICAgICAgIH0pLFxuICAgICAgfSxcbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSBnZXROb3RpZmljYXRpb25QcmVmZXJlbmNlUG9zdFJlcXVlc3QoXG4gICAgcHJlZmVyZW5jZTogTm90aWZpY2F0aW9uUHJlZmVyZW5jZSxcbiAgICBhY3Rpb25SZWNpcGVGb3JtSXRlbTogQWN0aW9uUmVjaXBlRm9ybUl0ZW1WYWx1ZSxcbiAgICBhcnJhbmdlbWVudElkOiBzdHJpbmcsXG4gICk6IE5vdGlmaWNhdGlvblByZWZlcmVuY2VQb3N0UmVxdWVzdCB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGdlbmVyYWxOb3RpZmljYXRpb25JZDogcHJlZmVyZW5jZS5nZW5lcmFsTm90aWZpY2F0aW9uSWQsXG4gICAgICBhY3RpdmU6IGFjdGlvblJlY2lwZUZvcm1JdGVtLmFjdGl2ZSxcbiAgICAgIGVSZWY6IGFycmFuZ2VtZW50SWQsXG4gICAgICBjaGFubmVsczogcHJlZmVyZW5jZS5jaGFubmVscy5tYXAoY2hhbm5lbCA9PiAoe1xuICAgICAgICAuLi5jaGFubmVsLFxuICAgICAgICBlbmFibGVkOiAhIWFjdGlvblJlY2lwZUZvcm1JdGVtLmFjdGlvbnNbY2hhbm5lbC5jaGFubmVsXSxcbiAgICAgIH0pKSxcbiAgICAgIGNvbmRpdGlvbnM6IHsgLi4ucHJlZmVyZW5jZS51c2VyQ29uZGl0aW9ucz8uY29uZGl0aW9ucyB9LFxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIHByZWZlcmVuY2VUb1NwZWNpZmljYXRpb24gPSAoe1xuICAgIHVzZXJDb25kaXRpb25zLFxuICAgIGNoYW5uZWxzLFxuICAgIGdlbmVyYWxOb3RpZmljYXRpb25JZCxcbiAgfTogTm90aWZpY2F0aW9uUHJlZmVyZW5jZSk6IEFjdGlvblJlY2lwZVNwZWNpZmljYXRpb24gPT5cbiAgICAoe1xuICAgICAgYWN0aW9uczogY2hhbm5lbHMubWFwKGNoYW5uZWwgPT4gKHsgdHlwZTogY2hhbm5lbC5jaGFubmVsIH0pKSxcbiAgICAgIHJlY2lwZURlZmF1bHRzOiB7XG4gICAgICAgIC4uLih1c2VyQ29uZGl0aW9ucz8uY29uZGl0aW9ucz8uaGFzT3duUHJvcGVydHkoJ2Ftb3VudCcpICYmIHtcbiAgICAgICAgICBhbW91bnQ6IGAke3VzZXJDb25kaXRpb25zPy5jb25kaXRpb25zPy5hbW91bnR9YCxcbiAgICAgICAgfSksXG4gICAgICB9LFxuICAgICAgaWQ6IE9iamVjdC52YWx1ZXMoUHJlZmVyZW5jZURhdGFNYXApLmZpbmQocHJlZiA9PiBwcmVmLmdlbmVyYWxOb3RpZmljYXRpb25JZCA9PT0gZ2VuZXJhbE5vdGlmaWNhdGlvbklkKVxuICAgICAgICA/LnNwZWNpZmljYXRpb25JZCxcbiAgICB9IGFzIEFjdGlvblJlY2lwZVNwZWNpZmljYXRpb24pO1xuXG4gIHByaXZhdGUgcHJlZmVyZW5jZVRvUmVjaXBlID0gKHtcbiAgICBjaGFubmVscyxcbiAgICB1c2VyQ29uZGl0aW9ucyxcbiAgICBjcmVhdGVkT24sXG4gICAgZ2VuZXJhbE5vdGlmaWNhdGlvbklkLFxuICAgIGFjdGl2ZSxcbiAgICBpZCxcbiAgfTogTm90aWZpY2F0aW9uUHJlZmVyZW5jZSk6IEFjdGlvblJlY2lwZUdldFJlc3BvbnNlQm9keSA9PlxuICAgICh7XG4gICAgICBzcGVjaWZpY2F0aW9uSWQ6IE9iamVjdC52YWx1ZXMoUHJlZmVyZW5jZURhdGFNYXApLmZpbmQoXG4gICAgICAgIHByZWYgPT4gcHJlZi5nZW5lcmFsTm90aWZpY2F0aW9uSWQgPT09IGdlbmVyYWxOb3RpZmljYXRpb25JZCxcbiAgICAgICk/LnNwZWNpZmljYXRpb25JZCxcbiAgICAgIGFjdGl2ZSxcbiAgICAgIGFjdGlvbnM6IGNoYW5uZWxzLm1hcChjaGFubmVsID0+ICh7XG4gICAgICAgIHR5cGU6IGNoYW5uZWwuY2hhbm5lbCxcbiAgICAgICAgZW5hYmxlZDogY2hhbm5lbC5lbmFibGVkLFxuICAgICAgfSkpLFxuICAgICAgY3JlYXRlZE9uLFxuICAgICAgLi4uKHVzZXJDb25kaXRpb25zPy5jb25kaXRpb25zPy5oYXNPd25Qcm9wZXJ0eSgnYW1vdW50JykgJiYge1xuICAgICAgICBhbW91bnQ6IGAke3VzZXJDb25kaXRpb25zPy5jb25kaXRpb25zPy5hbW91bnR9YCxcbiAgICAgIH0pLFxuICAgICAgaWQ6IGlkIHx8ICcnLFxuICAgIH0gYXMgQWN0aW9uUmVjaXBlR2V0UmVzcG9uc2VCb2R5KTtcblxuICBwcml2YXRlIHVwZGF0ZVByZWZlcmVuY2VzQ2FjaGUocHJlZmVyZW5jZXM6IE5vdGlmaWNhdGlvblByZWZlcmVuY2VbXSwgdXBkYXRlZFByZWZlcmVuY2U6IE5vdGlmaWNhdGlvblByZWZlcmVuY2UpIHtcbiAgICBjb25zdCB1cGRhdGVkUHJlZmVyZW5jZXMgPSBwcmVmZXJlbmNlcy5tYXAocHJlZiA9PlxuICAgICAgcHJlZi5nZW5lcmFsTm90aWZpY2F0aW9uSWQgPT09IHVwZGF0ZWRQcmVmZXJlbmNlLmdlbmVyYWxOb3RpZmljYXRpb25JZCA/IHVwZGF0ZWRQcmVmZXJlbmNlIDogcHJlZixcbiAgICApO1xuICAgIHRoaXMuY2FjaGVkTm90aWZpY2F0aW9uUHJlZmVyZW5jZXMkJC5uZXh0KHVwZGF0ZWRQcmVmZXJlbmNlcyk7XG4gIH1cbn1cbiJdfQ==