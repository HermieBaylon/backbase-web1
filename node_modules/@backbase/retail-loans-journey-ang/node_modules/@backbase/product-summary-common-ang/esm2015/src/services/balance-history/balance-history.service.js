import { Injectable } from '@angular/core';
import { BehaviorSubject, of, ReplaySubject } from 'rxjs';
import { catchError, distinctUntilChanged, filter, map, scan, switchMap, tap } from 'rxjs/operators';
import { BalanceHistoryExportFormat, HttpResponseType, PaginationType, } from '../../model/types';
import { defaultArrangementName } from '../../model/constants';
import { splitDataByTrend } from './colors-helper';
import { parseBalanceHistoryError,
/* eslint-enable */
 } from '../../errors/balance-history-service-errors';
import * as i0 from "@angular/core";
import * as i1 from "@backbase/data-ang/arrangements";
export class BalanceHistoryCommonService {
    constructor(accountDataService) {
        this.accountDataService = accountDataService;
        this.reportDefaultFileName = {
            [BalanceHistoryExportFormat.CSV]: 'balance-history.csv',
            [BalanceHistoryExportFormat.JSON]: 'balance-history.json',
        };
        this.requestObjectSeries = new ReplaySubject(1);
        this.requestObjectPaginated = new ReplaySubject(1);
        this.errorSeries = new BehaviorSubject(undefined);
        this.errorPaginated = new BehaviorSubject(undefined);
        this.loadingPaginated = new BehaviorSubject(true);
        this.loadingSeries = new BehaviorSubject(true);
        this.balanceHistorySeries = this.requestObjectSeries.pipe(distinctUntilChanged(), filter(param => !!param.arrangementIds), tap(() => this.loadingSeries.next(true)), tap(() => this.errorSeries.next(undefined)), switchMap(res => this.getBalanceHistorySeries(res).pipe(catchError((errorSeries) => {
            this.errorSeries.next(errorSeries);
            return of(undefined);
        }))), tap(() => this.loadingSeries.next(false)));
        this.balanceHistoryPaginated = this.requestObjectPaginated.pipe(distinctUntilChanged(), filter(param => !!param.arrangementId), tap(() => this.loadingPaginated.next(true)), tap(() => this.errorPaginated.next(undefined)), switchMap(res => this.getBalanceHistoryPaginated(res).pipe(catchError((errorPaginated) => {
            this.errorPaginated.next(errorPaginated);
            return of({
                count: 0,
                items: [],
                params: res,
            });
        }))), scan((acc, curr) => ({
            count: curr.count,
            items: this.responsesMerge(acc, curr),
            params: curr.params,
        })), tap(() => this.loadingPaginated.next(false)));
    }
    getBalanceHistorySeries(request) {
        const parameters = this.getBalanceHistoryRequestParameters(request);
        return this.accountDataService.getBalanceHistory(parameters).pipe(catchError((error) => {
            throw parseBalanceHistoryError(error);
        }));
    }
    getBalanceHistoryPaginated(request) {
        const paginationType = request.params ? request.params.paginationType || '' : '';
        const from = request.params ? request.params.from || 0 : 0;
        const parameters = this.getBalanceHistoryForArrangementRequestParameters(request);
        return this.accountDataService.getBalanceHistoryForArrangement(parameters, HttpResponseType.RESPONSE).pipe(map((res) => this.mapResponseWithCount(res, { from, paginationType })), catchError((error) => {
            throw parseBalanceHistoryError(error);
        }));
    }
    loadBalanceHistorySeries(requestObjectSeries) {
        requestObjectSeries.subscribe(this.requestObjectSeries);
    }
    loadBalanceHistoryPaginated(requestObjectPaginated) {
        requestObjectPaginated.subscribe(this.requestObjectPaginated);
    }
    /**
     * Returns URL for fetching balance history data
     *
     * @param format
     * @param exportParameters
     */
    exportBalanceHistory(format, exportParameters) {
        const parameters = this.getBalanceHistoryRequestParameters(exportParameters, format);
        return this.accountDataService.getBalanceHistoryUrl(parameters);
    }
    /**
     * Fetches balance history data in one of the available formats
     *
     * @param format
     * @param exportParameters
     */
    getBalanceHistory(format, exportParameters) {
        const parameters = this.getBalanceHistoryRequestParameters(exportParameters, format);
        const options = { httpHeaderAccept: format };
        return this.accountDataService.getBalanceHistory(parameters, HttpResponseType.RESPONSE, false, options).pipe(map(({ headers, body }) => {
            const defaultFileName = this.reportDefaultFileName[format];
            const fileNameInHeaders = this.getFileNameFromHeaders(headers);
            return { name: fileNameInHeaders || defaultFileName, content: body };
        }));
    }
    responsesMerge(acc, current) {
        if (acc &&
            acc.items &&
            current &&
            current.items &&
            acc.params.paginationType === PaginationType.LOAD_MORE &&
            current.params.from !== 0) {
            return [...acc.items, ...current.items];
        }
        return current.items;
    }
    processBalanceHistory(balanceHistory) {
        const [balanceHistoryItem] = balanceHistory.items;
        const defaultSeries = {
            name: defaultArrangementName,
            series: balanceHistoryItem.balanceHistory.map(({ dateTo, value, valuePtc }) => ({
                name: new Date(dateTo),
                value: (value ? value.balance : valuePtc),
            })),
        };
        return defaultSeries ? splitDataByTrend(defaultSeries.series) : [];
    }
    mapResponseWithCount(response, { from, paginationType }) {
        // eslint-disable-next-line no-null/no-null
        if (response.body === null) {
            throw new Error();
        }
        const headerCount = response.headers ? response.headers.get('x-total-count') : undefined;
        const counter = headerCount ? parseInt(headerCount, 10) : response.body.length || 0;
        return {
            count: counter,
            items: response.body,
            params: { from, paginationType },
        };
    }
    getBalanceHistoryRequestParameters({ arrangementIds, params }, requestFormat) {
        const format = requestFormat !== null && requestFormat !== void 0 ? requestFormat : params.format;
        return Object.assign({ arrangementIds }, this.toRequestParameters(Object.assign(Object.assign({}, params), { format })));
    }
    getBalanceHistoryForArrangementRequestParameters({ arrangementId, params, }) {
        const format = undefined;
        return Object.assign({ arrangementId }, this.toRequestParameters(Object.assign(Object.assign({}, params), { format })));
    }
    toRequestParameters(params) {
        const requestParameters = Object.assign(Object.assign({}, params), { timePeriod: params.timePeriod });
        delete requestParameters.paginationType;
        if (!requestParameters.format) {
            delete requestParameters.format;
        }
        if (requestParameters.timePeriod) {
            delete requestParameters.dateFrom;
            delete requestParameters.dateTo;
        }
        else {
            delete requestParameters.timePeriod;
        }
        return requestParameters;
    }
    getFileNameFromHeaders(headers) {
        const contentDisposition = (headers && headers.get('content-disposition')) || '';
        const contentDispositionWithoutQuotes = contentDisposition.replace(/['"]*/g, '');
        return (contentDispositionWithoutQuotes.match(/filename[^;=\n]*=([^;\n]*)/) || [])[1];
    }
}
BalanceHistoryCommonService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.15", ngImport: i0, type: BalanceHistoryCommonService, deps: [{ token: i1.AccountsHttpService }], target: i0.ɵɵFactoryTarget.Injectable });
BalanceHistoryCommonService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "12.2.15", ngImport: i0, type: BalanceHistoryCommonService });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.15", ngImport: i0, type: BalanceHistoryCommonService, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.AccountsHttpService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFsYW5jZS1oaXN0b3J5LnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9saWJzL3Byb2R1Y3Qtc3VtbWFyeS1jb21tb24tYW5nL3NyYy9zZXJ2aWNlcy9iYWxhbmNlLWhpc3RvcnkvYmFsYW5jZS1oaXN0b3J5LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQVUzQyxPQUFPLEVBQUUsZUFBZSxFQUFjLEVBQUUsRUFBRSxhQUFhLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdEUsT0FBTyxFQUFFLFVBQVUsRUFBRSxvQkFBb0IsRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDckcsT0FBTyxFQUdMLDBCQUEwQixFQU0xQixnQkFBZ0IsRUFDaEIsY0FBYyxHQUNmLE1BQU0sbUJBQW1CLENBQUM7QUFDM0IsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDL0QsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDbkQsT0FBTyxFQUVMLHdCQUF3QjtBQVd4QixtQkFBbUI7RUFDcEIsTUFBTSw2Q0FBNkMsQ0FBQzs7O0FBR3JELE1BQU0sT0FBTywyQkFBMkI7SUFRdEMsWUFBNkIsa0JBQXVDO1FBQXZDLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBcUI7UUFQbkQsMEJBQXFCLEdBQUc7WUFDdkMsQ0FBQywwQkFBMEIsQ0FBQyxHQUFHLENBQUMsRUFBRSxxQkFBcUI7WUFDdkQsQ0FBQywwQkFBMEIsQ0FBQyxJQUFJLENBQUMsRUFBRSxzQkFBc0I7U0FDMUQsQ0FBQztRQUNlLHdCQUFtQixHQUFHLElBQUksYUFBYSxDQUEyQyxDQUFDLENBQUMsQ0FBQztRQUNyRiwyQkFBc0IsR0FBRyxJQUFJ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QkFBaUIsQ0FBQyxRQUFRLENBQUM7WUFDbEMsT0FBTyxpQkFBaUIsQ0FBQyxNQUFNLENBQUM7U0FDakM7YUFBTTtZQUNMLE9BQU8saUJBQWlCLENBQUMsVUFBVSxDQUFDO1NBQ3JDO1FBQ0QsT0FBTyxpQkFBaUIsQ0FBQztJQUMzQixDQUFDO0lBRU8sc0JBQXNCLENBQUMsT0FBcUI7UUFDbEQsTUFBTSxrQkFBa0IsR0FBRyxDQUFDLE9BQU8sSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLHFCQUFxQixDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDakYsTUFBTSwrQkFBK0IsR0FBRyxrQkFBa0IsQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQ2pGLE9BQU8sQ0FBQywrQkFBK0IsQ0FBQyxLQUFLLENBQUMsNEJBQTRCLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUN4RixDQUFDOzt5SEFwTlUsMkJBQTJCOzZIQUEzQiwyQkFBMkI7NEZBQTNCLDJCQUEyQjtrQkFEdkMsVUFBVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEh0dHBFcnJvclJlc3BvbnNlLCBIdHRwSGVhZGVycywgSHR0cFJlc3BvbnNlIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHtcbiAgQWNjb3VudEJhbGFuY2VIaXN0b3J5LFxuICBBY2NvdW50QmFsYW5jZUhpc3RvcnlJdGVtLFxuICBBY2NvdW50c0h0dHBTZXJ2aWNlLFxuICBHZXRCYWxhbmNlSGlzdG9yeUZvckFycmFuZ2VtZW50UmVxdWVzdFBhcmFtcyxcbiAgR2V0QmFsYW5jZUhpc3RvcnlSZXF1ZXN0UGFyYW1zLFxuICBUaW1lUGVyaW9kLFxufSBmcm9tICdAYmFja2Jhc2UvZGF0YS1hbmcvYXJyYW5nZW1lbnRzJztcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCwgT2JzZXJ2YWJsZSwgb2YsIFJlcGxheVN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGNhdGNoRXJyb3IsIGRpc3RpbmN0VW50aWxDaGFuZ2VkLCBmaWx0ZXIsIG1hcCwgc2Nhbiwgc3dpdGNoTWFwLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQge1xuICBCYWxhbmNlSGlzdG9yeURhdGFTZXJpZXMsXG4gIEJhbGFuY2VIaXN0b3J5RXhwb3J0RGF0YSxcbiAgQmFsYW5jZUhpc3RvcnlFeHBvcnRGb3JtYXQsXG4gIEJhbGFuY2VIaXN0b3J5UGFnaW5hdGVkLFxuICBCYWxhbmNlSGlzdG9yeVBhZ2luYXRpb25QYXJhbXMsXG4gIEJhbGFuY2VIaXN0b3J5U2VyaWVzUGFyYW1zLFxuICBHZXRCYWxhbmNlSGlzdG9yeVJlcXVlc3RQYWdpbmF0ZWRPYmplY3RUeXBlLFxuICBHZXRCYWxhbmNlSGlzdG9yeVJlcXVlc3RTZXJpZXNPYmplY3RUeXBlLFxuICBIdHRwUmVzcG9uc2VUeXBlLFxuICBQYWdpbmF0aW9uVHlwZSxcbn0gZnJvbSAnLi4vLi4vbW9kZWwvdHlwZXMnO1xuaW1wb3J0IHsgZGVmYXVsdEFycmFuZ2VtZW50TmFtZSB9IGZyb20gJy4uLy4uL21vZGVsL2NvbnN0YW50cyc7XG5pbXBvcnQgeyBzcGxpdERhdGFCeVRyZW5kIH0gZnJvbSAnLi9jb2xvcnMtaGVscGVyJztcbmltcG9ydCB7XG4gIEJhbGFuY2VIaXN0b3J5RXJyb3IsXG4gIHBhcnNlQmFsYW5jZUhpc3RvcnlFcnJvcixcbiAgLyoqXG4gICAqIHRoZXNlIHVudXNlZCBpbXBvcnRzIGhlcmUgYmVjYXVzZSBvZiBpc3N1ZSBpbiBhcGktZXh0cmFjdG9yXG4gICAqIGlzc3VlOiBodHRwczovL2dpdGh1Yi5jb20vbWljcm9zb2Z0L3J1c2hzdGFjay9pc3N1ZXMvMjE0MFxuICAgKi9cbiAgLyogZXNsaW50LWRpc2FibGUgQHR5cGVzY3JpcHQtZXNsaW50L25vLXVudXNlZC12YXJzLG5vLXVudXNlZC12YXJzICovXG4gIEJhbGFuY2VIaXN0b3J5QWNjZXNzRGVuaWVkLFxuICBCYWxhbmNlSGlzdG9yeUJhZFJlcXVlc3QsXG4gIEJhbGFuY2VIaXN0b3J5Tm90Rm91bmQsXG4gIEJhbGFuY2VIaXN0b3J5Q29ubmVjdGl2aXR5RXJyb3IsXG4gIEJhbGFuY2VIaXN0b3J5VW5rbm93bkVycm9yLFxuICAvKiBlc2xpbnQtZW5hYmxlICovXG59IGZyb20gJy4uLy4uL2Vycm9ycy9iYWxhbmNlLWhpc3Rvcnktc2VydmljZS1lcnJvcnMnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgQmFsYW5jZUhpc3RvcnlDb21tb25TZXJ2aWNlIHtcbiAgcHJpdmF0ZSByZWFkb25seSByZXBvcnREZWZhdWx0RmlsZU5hbWUgPSB7XG4gICAgW0JhbGFuY2VIaXN0b3J5RXhwb3J0Rm9ybWF0LkNTVl06ICdiYWxhbmNlLWhpc3RvcnkuY3N2JyxcbiAgICBbQmFsYW5jZUhpc3RvcnlFeHBvcnRGb3JtYXQuSlNPTl06ICdiYWxhbmNlLWhpc3RvcnkuanNvbicsXG4gIH07XG4gIHByaXZhdGUgcmVhZG9ubHkgcmVxdWVzdE9iamVjdFNlcmllcyA9IG5ldyBSZXBsYXlTdWJqZWN0PEdldEJhbGFuY2VIaXN0b3J5UmVxdWVzdFNlcmllc09iamVjdFR5cGU+KDEpO1xuICBwcml2YXRlIHJlYWRvbmx5IHJlcXVlc3RPYmplY3RQYWdpbmF0ZWQgPSBuZXcgUmVwbGF5U3ViamVjdDxHZXRCYWxhbmNlSGlzdG9yeVJlcXVlc3RQYWdpbmF0ZWRPYmplY3RUeXBlPigxKTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IGFjY291bnREYXRhU2VydmljZTogQWNjb3VudHNIdHRwU2VydmljZSkge31cblxuICByZWFkb25seSBlcnJvclNlcmllcyA9IG5ldyBCZWhhdmlvclN1YmplY3Q8QmFsYW5jZUhpc3RvcnlFcnJvciB8IHVuZGVmaW5lZD4odW5kZWZpbmVkKTtcbiAgcmVhZG9ubHkgZXJyb3JQYWdpbmF0ZWQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PEJhbGFuY2VIaXN0b3J5RXJyb3IgfCB1bmRlZmluZWQ+KHVuZGVmaW5lZCk7XG5cbiAgcmVhZG9ubHkgbG9hZGluZ1BhZ2luYXRlZCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8Ym9vbGVhbj4odHJ1ZSk7XG4gIHJlYWRvbmx5IGxvYWRpbmdTZXJpZXMgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PGJvb2xlYW4+KHRydWUpO1xuXG4gIHJlYWRvbmx5IGJhbGFuY2VIaXN0b3J5U2VyaWVzOiBPYnNlcnZhYmxlPEFjY291bnRCYWxhbmNlSGlzdG9yeSB8IHVuZGVmaW5lZD4gPSB0aGlzLnJlcXVlc3RPYmplY3RTZXJpZXMucGlwZShcbiAgICBkaXN0aW5jdFVudGlsQ2hhbmdlZCgpLFxuICAgIGZpbHRlcihwYXJhbSA9PiAhIXBhcmFtLmFycmFuZ2VtZW50SWRzKSxcbiAgICB0YXAoKCkgPT4gdGhpcy5sb2FkaW5nU2VyaWVzLm5leHQodHJ1ZSkpLFxuICAgIHRhcCgoKSA9PiB0aGlzLmVycm9yU2VyaWVzLm5leHQodW5kZWZpbmVkKSksXG4gICAgc3dpdGNoTWFwKHJlcyA9PlxuICAgICAgdGhpcy5nZXRCYWxhbmNlSGlzdG9yeVNlcmllcyhyZXMpLnBpcGUoXG4gICAgICAgIGNhdGNoRXJyb3IoKGVycm9yU2VyaWVzOiBCYWxhbmNlSGlzdG9yeUVycm9yKSA9PiB7XG4gICAgICAgICAgdGhpcy5lcnJvclNlcmllcy5uZXh0KGVycm9yU2VyaWVzKTtcbiAgICAgICAgICByZXR1cm4gb2YodW5kZWZpbmVkKTtcbiAgICAgICAgfSksXG4gICAgICApLFxuICAgICksXG4gICAgdGFwKCgpID0+IHRoaXMubG9hZGluZ1Nlcmllcy5uZXh0KGZhbHNlKSksXG4gICk7XG5cbiAgcmVhZG9ubHkgYmFsYW5jZUhpc3RvcnlQYWdpbmF0ZWQ6IE9ic2VydmFibGU8QmFsYW5jZUhpc3RvcnlQYWdpbmF0ZWQgfCB1bmRlZmluZWQ+ID0gdGhpcy5yZXF1ZXN0T2JqZWN0UGFnaW5hdGVkLnBpcGUoXG4gICAgZGlzdGluY3RVbnRpbENoYW5nZWQoKSxcbiAgICBmaWx0ZXIocGFyYW0gPT4gISFwYXJhbS5hcnJhbmdlbWVudElkKSxcbiAgICB0YXAoKCkgPT4gdGhpcy5sb2FkaW5nUGFnaW5hdGVkLm5leHQodHJ1ZSkpLFxuICAgIHRhcCgoKSA9PiB0aGlzLmVycm9yUGFnaW5hdGVkLm5leHQodW5kZWZpbmVkKSksXG4gICAgc3dpdGNoTWFwKHJlcyA9PlxuICAgICAgdGhpcy5nZXRCYWxhbmNlSGlzdG9yeVBhZ2luYXRlZChyZXMpLnBpcGUoXG4gICAgICAgIGNhdGNoRXJyb3IoKGVycm9yUGFnaW5hdGVkOiBCYWxhbmNlSGlzdG9yeUVycm9yKSA9PiB7XG4gICAgICAgICAgdGhpcy5lcnJvclBhZ2luYXRlZC5uZXh0KGVycm9yUGFnaW5hdGVkKTtcbiAgICAgICAgICByZXR1cm4gb2Yoe1xuICAgICAgICAgICAgY291bnQ6IDAsXG4gICAgICAgICAgICBpdGVtczogW10sXG4gICAgICAgICAgICBwYXJhbXM6IHJlcyxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSksXG4gICAgICApLFxuICAgICksXG4gICAgc2NhbihcbiAgICAgIChhY2M6IEJhbGFuY2VIaXN0b3J5UGFnaW5hdGVkLCBjdXJyOiBCYWxhbmNlSGlzdG9yeVBhZ2luYXRlZCk6IEJhbGFuY2VIaXN0b3J5UGFnaW5hdGVkID0+ICh7XG4gICAgICAgIGNvdW50OiBjdXJyLmNvdW50LFxuICAgICAgICBpdGVtczogdGhpcy5yZXNwb25zZXNNZXJnZShhY2MsIGN1cnIpLFxuICAgICAgICBwYXJhbXM6IGN1cnIucGFyYW1zLFxuICAgICAgfSksXG4gICAgKSxcbiAgICB0YXAoKCkgPT4gdGhpcy5sb2FkaW5nUGFnaW5hdGVkLm5leHQoZmFsc2UpKSxcbiAgKTtcblxuICBnZXRCYWxhbmNlSGlzdG9yeVNlcmllcyhyZXF1ZXN0OiBHZXRCYWxhbmNlSGlzdG9yeVJlcXVlc3RTZXJpZXNPYmplY3RUeXBlKSB7XG4gICAgY29uc3QgcGFyYW1ldGVycyA9IHRoaXMuZ2V0QmFsYW5jZUhpc3RvcnlSZXF1ZXN0UGFyYW1ldGVycyhyZXF1ZXN0KTtcbiAgICByZXR1cm4gdGhpcy5hY2NvdW50RGF0YVNlcnZpY2UuZ2V0QmFsYW5jZUhpc3RvcnkocGFyYW1ldGVycykucGlwZShcbiAgICAgIGNhdGNoRXJyb3IoKGVycm9yOiBIdHRwRXJyb3JSZXNwb25zZSkgPT4ge1xuICAgICAgICB0aHJvdyBwYXJzZUJhbGFuY2VIaXN0b3J5RXJyb3IoZXJyb3IpO1xuICAgICAgfSksXG4gICAgKTtcbiAgfVxuXG4gIGdldEJhbGFuY2VIaXN0b3J5UGFnaW5hdGVkKHJlcXVlc3Q6IEdldEJhbGFuY2VIaXN0b3J5UmVxdWVzdFBhZ2luYXRlZE9iamVjdFR5cGUpIHtcbiAgICBjb25zdCBwYWdpbmF0aW9uVHlwZSA9IHJlcXVlc3QucGFyYW1zID8gcmVxdWVzdC5wYXJhbXMucGFnaW5hdGlvblR5cGUgfHwgJycgOiAnJztcbiAgICBjb25zdCBmcm9tID0gcmVxdWVzdC5wYXJhbXMgPyByZXF1ZXN0LnBhcmFtcy5mcm9tIHx8IDAgOiAwO1xuICAgIGNvbnN0IHBhcmFtZXRlcnMgPSB0aGlzLmdldEJhbGFuY2VIaXN0b3J5Rm9yQXJyYW5nZW1lbnRSZXF1ZXN0UGFyYW1ldGVycyhyZXF1ZXN0KTtcbiAgICByZXR1cm4gdGhpcy5hY2NvdW50RGF0YVNlcnZpY2UuZ2V0QmFsYW5jZUhpc3RvcnlGb3JBcnJhbmdlbWVudChwYXJhbWV0ZXJzLCBIdHRwUmVzcG9uc2VUeXBlLlJFU1BPTlNFKS5waXBlKFxuICAgICAgbWFwKChyZXM6IEh0dHBSZXNwb25zZTxBcnJheTxBY2NvdW50QmFsYW5jZUhpc3RvcnlJdGVtPj4pID0+XG4gICAgICAgIHRoaXMubWFwUmVzcG9uc2VXaXRoQ291bnQocmVzLCB7IGZyb20sIHBhZ2luYXRpb25UeXBlIH0pLFxuICAgICAgKSxcbiAgICAgIGNhdGNoRXJyb3IoKGVycm9yOiBIdHRwRXJyb3JSZXNwb25zZSkgPT4ge1xuICAgICAgICB0aHJvdyBwYXJzZUJhbGFuY2VIaXN0b3J5RXJyb3IoZXJyb3IpO1xuICAgICAgfSksXG4gICAgKTtcbiAgfVxuXG4gIGxvYWRCYWxhbmNlSGlzdG9yeVNlcmllcyhyZXF1ZXN0T2JqZWN0U2VyaWVzOiBPYnNlcnZhYmxlPEdldEJhbGFuY2VIaXN0b3J5UmVxdWVzdFNlcmllc09iamVjdFR5cGU+KSB7XG4gICAgcmVxdWVzdE9iamVjdFNlcmllcy5zdWJzY3JpYmUodGhpcy5yZXF1ZXN0T2JqZWN0U2VyaWVzKTtcbiAgfVxuXG4gIGxvYWRCYWxhbmNlSGlzdG9yeVBhZ2luYXRlZChyZXF1ZXN0T2JqZWN0UGFnaW5hdGVkOiBPYnNlcnZhYmxlPEdldEJhbGFuY2VIaXN0b3J5UmVxdWVzdFBhZ2luYXRlZE9iamVjdFR5cGU+KSB7XG4gICAgcmVxdWVzdE9iamVjdFBhZ2luYXRlZC5zdWJzY3JpYmUodGhpcy5yZXF1ZXN0T2JqZWN0UGFnaW5hdGVkKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIFVSTCBmb3IgZmV0Y2hpbmcgYmFsYW5jZSBoaXN0b3J5IGRhdGFcbiAgICpcbiAgICogQHBhcmFtIGZvcm1hdFxuICAgKiBAcGFyYW0gZXhwb3J0UGFyYW1ldGVyc1xuICAgKi9cbiAgZXhwb3J0QmFsYW5jZUhpc3RvcnkoXG4gICAgZm9ybWF0OiBCYWxhbmNlSGlzdG9yeUV4cG9ydEZvcm1hdCxcbiAgICBleHBvcnRQYXJhbWV0ZXJzOiBHZXRCYWxhbmNlSGlzdG9yeVJlcXVlc3RTZXJpZXNPYmplY3RUeXBlLFxuICApOiBzdHJpbmcge1xuICAgIGNvbnN0IHBhcmFtZXRlcnMgPSB0aGlzLmdldEJhbGFuY2VIaXN0b3J5UmVxdWVzdFBhcmFtZXRlcnMoZXhwb3J0UGFyYW1ldGVycywgZm9ybWF0KTtcbiAgICByZXR1cm4gdGhpcy5hY2NvdW50RGF0YVNlcnZpY2UuZ2V0QmFsYW5jZUhpc3RvcnlVcmwocGFyYW1ldGVycyk7XG4gIH1cblxuICAvKipcbiAgICogRmV0Y2hlcyBiYWxhbmNlIGhpc3RvcnkgZGF0YSBpbiBvbmUgb2YgdGhlIGF2YWlsYWJsZSBmb3JtYXRzXG4gICAqXG4gICAqIEBwYXJhbSBmb3JtYXRcbiAgICogQHBhcmFtIGV4cG9ydFBhcmFtZXRlcnNcbiAgICovXG4gIGdldEJhbGFuY2VIaXN0b3J5KFxuICAgIGZvcm1hdDogQmFsYW5jZUhpc3RvcnlFeHBvcnRGb3JtYXQsXG4gICAgZXhwb3J0UGFyYW1ldGVyczogR2V0QmFsYW5jZUhpc3RvcnlSZXF1ZXN0U2VyaWVzT2JqZWN0VHlwZSxcbiAgKTogT2JzZXJ2YWJsZTxCYWxhbmNlSGlzdG9yeUV4cG9ydERhdGE+IHtcbiAgICBjb25zdCBwYXJhbWV0ZXJzID0gdGhpcy5nZXRCYWxhbmNlSGlzdG9yeVJlcXVlc3RQYXJhbWV0ZXJzKGV4cG9ydFBhcmFtZXRlcnMsIGZvcm1hdCk7XG4gICAgY29uc3Qgb3B0aW9ucyA9IHsgaHR0cEhlYWRlckFjY2VwdDogZm9ybWF0IGFzIEJhbGFuY2VIaXN0b3J5RXhwb3J0Rm9ybWF0LkNTViB9O1xuXG4gICAgcmV0dXJuIHRoaXMuYWNjb3VudERhdGFTZXJ2aWNlLmdldEJhbGFuY2VIaXN0b3J5KHBhcmFtZXRlcnMsIEh0dHBSZXNwb25zZVR5cGUuUkVTUE9OU0UsIGZhbHNlLCBvcHRpb25zKS5waXBlKFxuICAgICAgbWFwKCh7IGhlYWRlcnMsIGJvZHkgfTogSHR0cFJlc3BvbnNlPGFueT4pID0+IHtcbiAgICAgICAgY29uc3QgZGVmYXVsdEZpbGVOYW1lID0gdGhpcy5yZXBvcnREZWZhdWx0RmlsZU5hbWVbZm9ybWF0XTtcbiAgICAgICAgY29uc3QgZmlsZU5hbWVJbkhlYWRlcnMgPSB0aGlzLmdldEZpbGVOYW1lRnJvbUhlYWRlcnMoaGVhZGVycyk7XG4gICAgICAgIHJldHVybiB7IG5hbWU6IGZpbGVOYW1lSW5IZWFkZXJzIHx8IGRlZmF1bHRGaWxlTmFtZSwgY29udGVudDogYm9keSB9O1xuICAgICAgfSksXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgcmVzcG9uc2VzTWVyZ2UoXG4gICAgYWNjOiBCYWxhbmNlSGlzdG9yeVBhZ2luYXRlZCxcbiAgICBjdXJyZW50OiBCYWxhbmNlSGlzdG9yeVBhZ2luYXRlZCxcbiAgKTogQXJyYXk8QWNjb3VudEJhbGFuY2VIaXN0b3J5SXRlbT4ge1xuICAgIGlmIChcbiAgICAgIGFjYyAmJlxuICAgICAgYWNjLml0ZW1zICYmXG4gICAgICBjdXJyZW50ICYmXG4gICAgICBjdXJyZW50Lml0ZW1zICYmXG4gICAgICBhY2MucGFyYW1zLnBhZ2luYXRpb25UeXBlID09PSBQYWdpbmF0aW9uVHlwZS5MT0FEX01PUkUgJiZcbiAgICAgIGN1cnJlbnQucGFyYW1zLmZyb20gIT09IDBcbiAgICApIHtcbiAgICAgIHJldHVybiBbLi4uYWNjLml0ZW1zLCAuLi5jdXJyZW50Lml0ZW1zXTtcbiAgICB9XG5cbiAgICByZXR1cm4gY3VycmVudC5pdGVtcztcbiAgfVxuXG4gIHByb2Nlc3NCYWxhbmNlSGlzdG9yeShiYWxhbmNlSGlzdG9yeTogQWNjb3VudEJhbGFuY2VIaXN0b3J5KTogQmFsYW5jZUhpc3RvcnlEYXRhU2VyaWVzW10ge1xuICAgIGNvbnN0IFtiYWxhbmNlSGlzdG9yeUl0ZW1dID0gYmFsYW5jZUhpc3RvcnkuaXRlbXM7XG4gICAgY29uc3QgZGVmYXVsdFNlcmllcyA9IHtcbiAgICAgIG5hbWU6IGRlZmF1bHRBcnJhbmdlbWVudE5hbWUsXG4gICAgICBzZXJpZXM6IGJhbGFuY2VIaXN0b3J5SXRlbS5iYWxhbmNlSGlzdG9yeS5tYXAoKHsgZGF0ZVRvLCB2YWx1ZSwgdmFsdWVQdGMgfSkgPT4gKHtcbiAgICAgICAgbmFtZTogbmV3IERhdGUoZGF0ZVRvKSxcbiAgICAgICAgdmFsdWU6ICgodmFsdWUgPyB2YWx1ZS5iYWxhbmNlIDogdmFsdWVQdGMpIGFzIHVua25vd24pIGFzIG51bWJlcixcbiAgICAgIH0pKSxcbiAgICB9O1xuXG4gICAgcmV0dXJuIGRlZmF1bHRTZXJpZXMgPyBzcGxpdERhdGFCeVRyZW5kKGRlZmF1bHRTZXJpZXMuc2VyaWVzKSA6IFtdO1xuICB9XG5cbiAgcHJpdmF0ZSBtYXBSZXNwb25zZVdpdGhDb3VudChcbiAgICByZXNwb25zZTogSHR0cFJlc3BvbnNlPEFycmF5PEFjY291bnRCYWxhbmNlSGlzdG9yeUl0ZW0+PixcbiAgICB7IGZyb20sIHBhZ2luYXRpb25UeXBlIH06IHsgZnJvbTogbnVtYmVyOyBwYWdpbmF0aW9uVHlwZTogUGFnaW5hdGlvblR5cGUgfCBzdHJpbmcgfSxcbiAgKTogQmFsYW5jZUhpc3RvcnlQYWdpbmF0ZWQge1xuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1udWxsL25vLW51bGxcbiAgICBpZiAocmVzcG9uc2UuYm9keSA9PT0gbnVsbCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCk7XG4gICAgfVxuICAgIGNvbnN0IGhlYWRlckNvdW50ID0gcmVzcG9uc2UuaGVhZGVycyA/IHJlc3BvbnNlLmhlYWRlcnMuZ2V0KCd4LXRvdGFsLWNvdW50JykgOiB1bmRlZmluZWQ7XG4gICAgY29uc3QgY291bnRlciA9IGhlYWRlckNvdW50ID8gcGFyc2VJbnQoaGVhZGVyQ291bnQsIDEwKSA6IHJlc3BvbnNlLmJvZHkubGVuZ3RoIHx8IDA7XG5cbiAgICByZXR1cm4ge1xuICAgICAgY291bnQ6IGNvdW50ZXIsXG4gICAgICBpdGVtczogcmVzcG9uc2UuYm9keSxcbiAgICAgIHBhcmFtczogeyBmcm9tLCBwYWdpbmF0aW9uVHlwZSB9LFxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIGdldEJhbGFuY2VIaXN0b3J5UmVxdWVzdFBhcmFtZXRlcnMoXG4gICAgeyBhcnJhbmdlbWVudElkcywgcGFyYW1zIH06IEdldEJhbGFuY2VIaXN0b3J5UmVxdWVzdFNlcmllc09iamVjdFR5cGUsXG4gICAgcmVxdWVzdEZvcm1hdD86IHN0cmluZyxcbiAgKTogR2V0QmFsYW5jZUhpc3RvcnlSZXF1ZXN0UGFyYW1zIHtcbiAgICBjb25zdCBmb3JtYXQgPSByZXF1ZXN0Rm9ybWF0ID8/IHBhcmFtcy5mb3JtYXQ7XG4gICAgcmV0dXJuIHsgYXJyYW5nZW1lbnRJZHMsIC4uLnRoaXMudG9SZXF1ZXN0UGFyYW1ldGVycyh7IC4uLnBhcmFtcywgZm9ybWF0IH0pIH07XG4gIH1cblxuICBwcml2YXRlIGdldEJhbGFuY2VIaXN0b3J5Rm9yQXJyYW5nZW1lbnRSZXF1ZXN0UGFyYW1ldGVycyh7XG4gICAgYXJyYW5nZW1lbnRJZCxcbiAgICBwYXJhbXMsXG4gIH06IEdldEJhbGFuY2VIaXN0b3J5UmVxdWVzdFBhZ2luYXRlZE9iamVjdFR5cGUpOiBHZXRCYWxhbmNlSGlzdG9yeUZvckFycmFuZ2VtZW50UmVxdWVzdFBhcmFtcyB7XG4gICAgY29uc3QgZm9ybWF0ID0gdW5kZWZpbmVkO1xuICAgIHJldHVybiB7IGFycmFuZ2VtZW50SWQsIC4uLnRoaXMudG9SZXF1ZXN0UGFyYW1ldGVycyh7IC4uLnBhcmFtcywgZm9ybWF0IH0pIH07XG4gIH1cblxuICBwcml2YXRlIHRvUmVxdWVzdFBhcmFtZXRlcnMoXG4gICAgcGFyYW1zOiBCYWxhbmNlSGlzdG9yeVNlcmllc1BhcmFtcyB8IEJhbGFuY2VIaXN0b3J5UGFnaW5hdGlvblBhcmFtcyxcbiAgKTogUGFydGlhbDxHZXRCYWxhbmNlSGlzdG9yeVJlcXVlc3RQYXJhbXMgfCBHZXRCYWxhbmNlSGlzdG9yeUZvckFycmFuZ2VtZW50UmVxdWVzdFBhcmFtcz4ge1xuICAgIGNvbnN0IHJlcXVlc3RQYXJhbWV0ZXJzID0geyAuLi5wYXJhbXMsIHRpbWVQZXJpb2Q6IHBhcmFtcy50aW1lUGVyaW9kIGFzIFRpbWVQZXJpb2QgfCB1bmRlZmluZWQgfTtcbiAgICBkZWxldGUgcmVxdWVzdFBhcmFtZXRlcnMucGFnaW5hdGlvblR5cGU7XG4gICAgaWYgKCFyZXF1ZXN0UGFyYW1ldGVycy5mb3JtYXQpIHtcbiAgICAgIGRlbGV0ZSByZXF1ZXN0UGFyYW1ldGVycy5mb3JtYXQ7XG4gICAgfVxuICAgIGlmIChyZXF1ZXN0UGFyYW1ldGVycy50aW1lUGVyaW9kKSB7XG4gICAgICBkZWxldGUgcmVxdWVzdFBhcmFtZXRlcnMuZGF0ZUZyb207XG4gICAgICBkZWxldGUgcmVxdWVzdFBhcmFtZXRlcnMuZGF0ZVRvO1xuICAgIH0gZWxzZSB7XG4gICAgICBkZWxldGUgcmVxdWVzdFBhcmFtZXRlcnMudGltZVBlcmlvZDtcbiAgICB9XG4gICAgcmV0dXJuIHJlcXVlc3RQYXJhbWV0ZXJzO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRGaWxlTmFtZUZyb21IZWFkZXJzKGhlYWRlcnM/OiBIdHRwSGVhZGVycyk6IHN0cmluZyB8IHVuZGVmaW5lZCB7XG4gICAgY29uc3QgY29udGVudERpc3Bvc2l0aW9uID0gKGhlYWRlcnMgJiYgaGVhZGVycy5nZXQoJ2NvbnRlbnQtZGlzcG9zaXRpb24nKSkgfHwgJyc7XG4gICAgY29uc3QgY29udGVudERpc3Bvc2l0aW9uV2l0aG91dFF1b3RlcyA9IGNvbnRlbnREaXNwb3NpdGlvbi5yZXBsYWNlKC9bJ1wiXSovZywgJycpO1xuICAgIHJldHVybiAoY29udGVudERpc3Bvc2l0aW9uV2l0aG91dFF1b3Rlcy5tYXRjaCgvZmlsZW5hbWVbXjs9XFxuXSo9KFteO1xcbl0qKS8pIHx8IFtdKVsxXTtcbiAgfVxufVxuIl19