import { Inject, Injectable, InjectionToken, LOCALE_ID } from '@angular/core';
import { BehaviorSubject, combineLatest, iif, merge, of, ReplaySubject, Subject } from 'rxjs';
import { catchError, distinctUntilChanged, filter, first, map, scan, switchMap, tap } from 'rxjs/operators';
import { defaultFilterOptions, defaultInitialExportOptions, defaultInitialListOptions, defaultPaginationOptions, defaultSearchOptions, OnLoadAction, TransactionState, } from '../model/transactions-list-options.model';
import { TransactionsFilterOptions } from '../model/transactions-filter-options.model';
import { TransactionsList } from '../model/transactions-list.model';
import { cacheRequest, deepEqual, multipleAccountsPredicate, onLoadTransactions, } from '../model/transactions-list-utils.model';
import { EndpointType } from './widget-properties.service';
import * as i0 from "@angular/core";
import * as i1 from "@backbase/data-ang/transactions";
import * as i2 from "./accounts.service";
import * as i3 from "@backbase/foundation-ang/core";
export var LoadingState;
(function (LoadingState) {
    LoadingState["NotLoaded"] = "NotLoaded";
    LoadingState["LoadingMore"] = "LoadingMore";
    LoadingState["LoadingPage"] = "LoadingPage";
    LoadingState["Loading"] = "Loading";
    LoadingState["Loaded"] = "Loaded";
})(LoadingState || (LoadingState = {}));
export const showDetailsConfigToken = new InjectionToken('shows the transactions details modal');
export class TransactionsService {
    constructor(transactionsDataHttpService, accountService, deprecationsService, locale) {
        this.transactionsDataHttpService = transactionsDataHttpService;
        this.accountService = accountService;
        this.deprecationsService = deprecationsService;
        this.locale = locale;
        this.selectedAccount = new ReplaySubject(1);
        this.pageSize = new ReplaySubject(1);
        this.initialListOptions = new ReplaySubject(1);
        this.options = new BehaviorSubject({});
        this.listRefresh = new Subject();
        this.listOptions = new BehaviorSubject(defaultInitialListOptions);
        this.exportOptions = new BehaviorSubject(defaultInitialExportOptions);
        this.showPendingTransactionsOnTop = new ReplaySubject(1);
        this.getOrPostEndpoint = new BehaviorSubject(EndpointType.GET_REQUEST);
        this.transactionsList = merge(this.listOptions.pipe(filter((listOptions) => typeof listOptions.account.arrangementId !== 'undefined'), distinctUntilChanged(deepEqual)), this.listRefresh).pipe(cacheRequest((listOptions) => {
            this.loadingState.next(listOptions.onLoad === OnLoadAction.Append
                ? LoadingState.LoadingMore
                : listOptions.onLoad === OnLoadAction.ReplacePage
                    ? LoadingState.LoadingPage
                    : LoadingState.Loading);
            return combineLatest([
                this.loadTransactions(listOptions).pipe(tap(() => {
                    this.loadingState.next(LoadingState.Loaded);
                }), map((transactionsList) => ({ transactionsList, onLoad: listOptions.onLoad }))),
                iif(multipleAccountsPredicate(listOptions), this.accountService.getAllArrangements().pipe(map((accounts) => {
                    const accountMap = new Map();
                    accounts.forEach((account) => {
                        accountMap.set(account.id, account);
                    });
                    return accountMap;
                })), of(new Map())),
                this.isFilterApplied,
                this.isSearchApplied,
            ]).pipe(map(([transactions, accountMap, isFilterApplied, isSearchApplied]) => {
                transactions.transactionsList.items = transactions.transactionsList.items.map((transaction) => (Object.assign(Object.assign({}, transaction), { account: accountMap.get(transaction.arrangementId || '') })));
                transactions.transactionsList.initialRequest = !(isFilterApplied || isSearchApplied);
                return transactions;
            }));
        }), scan(onLoadTransactions, { items: [], totalCount: 0 }));
        this.loadingState = new BehaviorSubject(LoadingState.NotLoaded);
        this.isFilterApplied = this.listOptions.pipe(map((options) => !TransactionsFilterOptions.isEmpty(options.filter || {})));
        this.isSearchApplied = this.listOptions.pipe(map((options) => !TransactionsFilterOptions.isEmpty(options.search || {})));
        // Base this.options on this.selectedAccount, this.pageSize, this.initialListOptions
        combineLatest([this.selectedAccount, this.pageSize, this.initialListOptions, this.showPendingTransactionsOnTop])
            .pipe(map(([selectedAccount, pageSize, initialListOptions, showPendingTransactionsOnTop]) => (Object.assign(Object.assign(Object.assign({}, (showPendingTransactionsOnTop ? { state: TransactionState.completed } : {})), { account: {
                arrangementId: selectedAccount,
            }, pagination: {
                from: 0,
                size: pageSize,
            }, onLoad: OnLoadAction.Replace }), initialListOptions))))
            .subscribe(this.options);
        // Base this.listOptions on this.options
        this.options
            .pipe(scan((acc, curr) => Object.assign({}, acc, curr), defaultInitialListOptions))
            .subscribe(this.listOptions);
        // Base this.exportOptions on this.listOptions
        this.listOptions
            .pipe(filter((listOptions) => typeof listOptions.account.arrangementId !== 'undefined'), map((params) => (Object.assign(Object.assign({}, params), { pagination: undefined, state: undefined, exportType: 'csv', locale: 'en-US' }))))
            .subscribe(this.exportOptions);
    }
    loadTransactions(listOptions) {
        const transactionPayload = TransactionsList.toHttpRequest(listOptions);
        let transactionsResponse;
        if (this.isUsingPostEndpoints) {
            transactionsResponse = this.transactionsDataHttpService.getTransactionsWithPost({ transactionListRequest: transactionPayload }, 'response');
        }
        else {
            this.deprecationsService.logDeprecatedFeature('[TransactionsService: loadTransactions] GET endpoints deprecated. Please use POST endpoints by changing CXP configuration');
            transactionsResponse = this.transactionsDataHttpService.getTransactions(transactionPayload, 'response');
        }
        return transactionsResponse.pipe(map(TransactionsList.fromHttpResponse), catchError((err) => of({
            items: [],
            totalCount: 0,
            httpResponseError: err,
        })));
    }
    exportTransactions(exportOptions) {
        const exportPayload = TransactionsList.toHttpRequest(Object.assign(Object.assign({}, exportOptions), { locale: this.locale }));
        if (this.isUsingPostEndpoints) {
            return this.transactionsDataHttpService.getTransactionsExportWithPost({ transactionListRequest: exportPayload }, 'response');
        }
        else {
            this.deprecationsService.logDeprecatedFeature('[TransactionsService: exportTransactions] GET endpoints deprecated. Please use POST endpoints by changing CXP configuration');
            return this.transactionsDataHttpService.getTransactionsExport(exportPayload, 'response');
        }
    }
    search(query) {
        const searchOptions = {
            query,
        };
        const paginationOptions = Object.assign(Object.assign({}, (this.options.getValue().pagination || defaultPaginationOptions.pagination)), { from: 0 });
        this.options.next(Object.assign(Object.assign(Object.assign({}, this.options.getValue()), defaultSearchOptions), { pagination: paginationOptions, search: searchOptions, onLoad: OnLoadAction.Replace }));
    }
    clearSearch() {
        const paginationOptions = Object.assign(Object.assign({}, (this.options.getValue().pagination || defaultPaginationOptions.pagination)), { from: 0 });
        this.options.next(Object.assign(Object.assign(Object.assign({}, this.options.getValue()), defaultSearchOptions), { pagination: paginationOptions, onLoad: OnLoadAction.Replace }));
    }
    filter(filterOptions) {
        const paginationOptions = Object.assign(Object.assign({}, (this.options.getValue().pagination || defaultPaginationOptions.pagination)), { from: 0 });
        this.options.next(Object.assign(Object.assign(Object.assign({}, this.options.getValue()), defaultFilterOptions), { pagination: paginationOptions, filter: Object.assign({}, filterOptions), onLoad: OnLoadAction.Replace }));
    }
    clearFilter() {
        const paginationOptions = Object.assign(Object.assign({}, (this.options.getValue().pagination || defaultPaginationOptions.pagination)), { from: 0 });
        this.options.next(Object.assign(Object.assign(Object.assign({}, this.options.getValue()), defaultFilterOptions), { pagination: paginationOptions, onLoad: OnLoadAction.Replace }));
    }
    exportToType(type) {
        return this.exportOptions.pipe(first(), switchMap((exportOptions) => this.exportTransactions(Object.assign(Object.assign({}, exportOptions), { exportType: type }))));
    }
    loadMore() {
        const currentPaginationOptions = this.options.getValue().pagination || defaultPaginationOptions.pagination;
        const paginationOptions = Object.assign(Object.assign({}, currentPaginationOptions), { from: currentPaginationOptions.from + 1 });
        this.options.next({
            pagination: paginationOptions,
            onLoad: OnLoadAction.Append,
        });
    }
    sort(sortOptions) {
        const currentPaginationOptions = this.options.getValue().pagination || defaultPaginationOptions.pagination;
        this.options.next({
            sort: Object.assign({}, sortOptions),
            pagination: Object.assign(Object.assign({}, currentPaginationOptions), { from: 0 }),
            onLoad: OnLoadAction.ReplacePage,
        });
    }
    pageChange(page) {
        const paginationOptions = Object.assign(Object.assign(Object.assign({}, defaultPaginationOptions.pagination), this.options.getValue().pagination), { from: page });
        this.options.next({
            pagination: paginationOptions,
            onLoad: OnLoadAction.ReplacePage,
        });
    }
    getTransactionsFrom(selectedAccount, pageSize, initialListOptions = of({}), showPendingTransactionsOnTop = of(false), getOrPostEndpoint = of(EndpointType.GET_REQUEST)) {
        selectedAccount.subscribe(this.selectedAccount);
        pageSize.subscribe(this.pageSize);
        initialListOptions.subscribe(this.initialListOptions);
        showPendingTransactionsOnTop.subscribe(this.showPendingTransactionsOnTop);
        getOrPostEndpoint.subscribe(this.getOrPostEndpoint);
    }
    getCurrentPage() {
        return this.listOptions.pipe(map((options) => (options.pagination || defaultPaginationOptions.pagination).from));
    }
    getTransactionsList() {
        return this.transactionsList;
    }
    retryFiltering() {
        this.listRefresh.next(this.listOptions.getValue());
    }
    refreshTransactions() {
        const currentPaginationOptions = this.options.getValue().pagination || defaultPaginationOptions.pagination;
        const paginationOptions = Object.assign(Object.assign({}, currentPaginationOptions), { from: 0 });
        const newOptions = Object.assign(Object.assign({}, this.listOptions.getValue()), { pagination: paginationOptions, onLoad: OnLoadAction.ReplacePage });
        if (deepEqual(newOptions, this.listOptions.getValue())) {
            this.listRefresh.next(this.listOptions.getValue());
        }
        else {
            this.options.next({
                pagination: paginationOptions,
                onLoad: OnLoadAction.ReplacePage,
            });
        }
    }
    get isUsingPostEndpoints() {
        return this.getOrPostEndpoint.getValue() === EndpointType.POST_REQUEST;
    }
    ngOnDestroy() {
        this.listRefresh.complete();
        this.selectedAccount.complete();
        this.pageSize.complete();
        this.initialListOptions.complete();
        this.options.complete();
        this.listOptions.complete();
        this.exportOptions.complete();
        this.showPendingTransactionsOnTop.complete();
        this.loadingState.complete();
        this.getOrPostEndpoint.complete();
    }
}
TransactionsService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: TransactionsService, deps: [{ token: i1.TransactionClientHttpService }, { token: i2.AccountsService }, { token: i3.DeprecationsService }, { token: LOCALE_ID }], target: i0.ɵɵFactoryTarget.Injectable });
TransactionsService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: TransactionsService });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: TransactionsService, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.TransactionClientHttpService }, { type: i2.AccountsService }, { type: i3.DeprecationsService }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [LOCALE_ID]
                }] }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhbnNhY3Rpb25zLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9saWJzL3RyYW5zYWN0aW9ucy1jb21tb24tYW5nL3NyYy9zZXJ2aWNlcy90cmFuc2FjdGlvbnMuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxjQUFjLEVBQUUsU0FBUyxFQUFhLE1BQU0sZUFBZSxDQUFDO0FBT3pGLE9BQU8sRUFBRSxlQUFlLEVBQUUsYUFBYSxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQWMsRUFBRSxFQUFFLGFBQWEsRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDMUcsT0FBTyxFQUFFLFVBQVUsRUFBRSxvQkFBb0IsRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzVHLE9BQU8sRUFDTCxvQkFBb0IsRUFDcEIsMkJBQTJCLEVBQzNCLHlCQUF5QixFQUN6Qix3QkFBd0IsRUFDeEIsb0JBQW9CLEVBQ3BCLFlBQVksRUFFWixnQkFBZ0IsR0FDakIsTUFBTSwwQ0FBMEMsQ0FBQztBQUdsRCxPQUFPLEVBQUUseUJBQXlCLEVBQUUsTUFBTSw0Q0FBNEMsQ0FBQztBQUN2RixPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxrQ0FBa0MsQ0FBQztBQUlwRSxPQUFPLEVBQ0wsWUFBWSxFQUNaLFNBQVMsRUFDVCx5QkFBeUIsRUFDekIsa0JBQWtCLEdBQ25CLE1BQU0sd0NBQXdDLENBQUM7QUFFaEQsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLDZCQUE2QixDQUFDOzs7OztBQUczRCxNQUFNLENBQU4sSUFBWSxZQU1YO0FBTkQsV0FBWSxZQUFZO0lBQ3RCLHVDQUF1QixDQUFBO0lBQ3ZCLDJDQUEyQixDQUFBO0lBQzNCLDJDQUEyQixDQUFB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QixDQUFDLFFBQVEsRUFBRSxDQUFDO0lBQ3BDLENBQUM7O2lIQTFTVSxtQkFBbUIsZ0lBZ1RwQixTQUFTO3FIQWhUUixtQkFBbUI7NEZBQW5CLG1CQUFtQjtrQkFEL0IsVUFBVTs7MEJBaVROLE1BQU07MkJBQUMsU0FBUyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdCwgSW5qZWN0YWJsZSwgSW5qZWN0aW9uVG9rZW4sIExPQ0FMRV9JRCwgT25EZXN0cm95IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1xuICBHZXRUcmFuc2FjdGlvbnNFeHBvcnRXaXRoUG9zdFJlcXVlc3RQYXJhbXMsXG4gIEdldFRyYW5zYWN0aW9uc1dpdGhQb3N0UmVxdWVzdFBhcmFtcyxcbiAgVHJhbnNhY3Rpb25DbGllbnRIdHRwU2VydmljZSxcbiAgVHJhbnNhY3Rpb25JdGVtLFxufSBmcm9tICdAYmFja2Jhc2UvZGF0YS1hbmcvdHJhbnNhY3Rpb25zJztcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCwgY29tYmluZUxhdGVzdCwgaWlmLCBtZXJnZSwgT2JzZXJ2YWJsZSwgb2YsIFJlcGxheVN1YmplY3QsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGNhdGNoRXJyb3IsIGRpc3RpbmN0VW50aWxDaGFuZ2VkLCBmaWx0ZXIsIGZpcnN0LCBtYXAsIHNjYW4sIHN3aXRjaE1hcCwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHtcbiAgZGVmYXVsdEZpbHRlck9wdGlvbnMsXG4gIGRlZmF1bHRJbml0aWFsRXhwb3J0T3B0aW9ucyxcbiAgZGVmYXVsdEluaXRpYWxMaXN0T3B0aW9ucyxcbiAgZGVmYXVsdFBhZ2luYXRpb25PcHRpb25zLFxuICBkZWZhdWx0U2VhcmNoT3B0aW9ucyxcbiAgT25Mb2FkQWN0aW9uLFxuICBUcmFuc2FjdGlvbnNMaXN0T3B0aW9ucyxcbiAgVHJhbnNhY3Rpb25TdGF0ZSxcbn0gZnJvbSAnLi4vbW9kZWwvdHJhbnNhY3Rpb25zLWxpc3Qtb3B0aW9ucy5tb2RlbCc7XG5pbXBvcnQgeyBUcmFuc2FjdGlvbnNFeHBvcnRPcHRpb25zIH0gZnJvbSAnLi4vbW9kZWwvdHJhbnNhY3Rpb25zLWV4cG9ydC1vcHRpb25zLm1vZGVsJztcbmltcG9ydCB7IFRyYW5zYWN0aW9uc1NlYXJjaE9wdGlvbnMgfSBmcm9tICcuLi9tb2RlbC90cmFuc2FjdGlvbnMtc2VhcmNoLW9wdGlvbnMubW9kZWwnO1xuaW1wb3J0IHsgVHJhbnNhY3Rpb25zRmlsdGVyT3B0aW9ucyB9IGZyb20gJy4uL21vZGVsL3RyYW5zYWN0aW9ucy1maWx0ZXItb3B0aW9ucy5tb2RlbCc7XG5pbXBvcnQgeyBUcmFuc2FjdGlvbnNMaXN0IH0gZnJvbSAnLi4vbW9kZWwvdHJhbnNhY3Rpb25zLWxpc3QubW9kZWwnO1xuaW1wb3J0IHsgVHJhbnNhY3Rpb25zU29ydE9wdGlvbnMgfSBmcm9tICcuLi9tb2RlbC90cmFuc2FjdGlvbnMtc29ydC1vcHRpb25zLm1vZGVsJztcbmltcG9ydCB7IEFjY291bnRzU2VydmljZSB9IGZyb20gJy4vYWNjb3VudHMuc2VydmljZSc7XG5pbXBvcnQgeyBBY2NvdW50IH0gZnJvbSAnLi4vbW9kZWwvYWNjb3VudC5tb2RlbCc7XG5pbXBvcnQge1xuICBjYWNoZVJlcXVlc3QsXG4gIGRlZXBFcXVhbCxcbiAgbXVsdGlwbGVBY2NvdW50c1ByZWRpY2F0ZSxcbiAgb25Mb2FkVHJhbnNhY3Rpb25zLFxufSBmcm9tICcuLi9tb2RlbC90cmFuc2FjdGlvbnMtbGlzdC11dGlscy5tb2RlbCc7XG5pbXBvcnQgeyBIdHRwUmVzcG9uc2UgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQgeyBFbmRwb2ludFR5cGUgfSBmcm9tICcuL3dpZGdldC1wcm9wZXJ0aWVzLnNlcnZpY2UnO1xuaW1wb3J0IHsgRGVwcmVjYXRpb25zU2VydmljZSB9IGZyb20gJ0BiYWNrYmFzZS9mb3VuZGF0aW9uLWFuZy9jb3JlJztcblxuZXhwb3J0IGVudW0gTG9hZGluZ1N0YXRlIHtcbiAgTm90TG9hZGVkID0gJ05vdExvYWRlZCcsXG4gIExvYWRpbmdNb3JlID0gJ0xvYWRpbmdNb3JlJyxcbiAgTG9hZGluZ1BhZ2UgPSAnTG9hZGluZ1BhZ2UnLFxuICBMb2FkaW5nID0gJ0xvYWRpbmcnLFxuICBMb2FkZWQgPSAnTG9hZGVkJyxcbn1cblxuZXhwb3J0IGNvbnN0IHNob3dEZXRhaWxzQ29uZmlnVG9rZW4gPSBuZXcgSW5qZWN0aW9uVG9rZW48Ym9vbGVhbj4oJ3Nob3dzIHRoZSB0cmFuc2FjdGlvbnMgZGV0YWlscyBtb2RhbCcpO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgVHJhbnNhY3Rpb25zU2VydmljZSBpbXBsZW1lbnRzIE9uRGVzdHJveSB7XG4gIHByaXZhdGUgcmVhZG9ubHkgc2VsZWN0ZWRBY2NvdW50ID0gbmV3IFJlcGxheVN1YmplY3Q8c3RyaW5nW10+KDEpO1xuICBwcml2YXRlIHJlYWRvbmx5IHBhZ2VTaXplID0gbmV3IFJlcGxheVN1YmplY3Q8bnVtYmVyPigxKTtcbiAgcHJpdmF0ZSByZWFkb25seSBpbml0aWFsTGlzdE9wdGlvbnMgPSBuZXcgUmVwbGF5U3ViamVjdDxQYXJ0aWFsPFRyYW5zYWN0aW9uc0xpc3RPcHRpb25zPj4oMSk7XG4gIHByaXZhdGUgcmVhZG9ubHkgb3B0aW9ucyA9IG5ldyBCZWhhdmlvclN1YmplY3Q8UGFydGlhbDxUcmFuc2FjdGlvbnNMaXN0T3B0aW9ucz4+KHt9KTtcbiAgcHJpdmF0ZSByZWFkb25seSBsaXN0UmVmcmVzaCA9IG5ldyBTdWJqZWN0PFRyYW5zYWN0aW9uc0xpc3RPcHRpb25zPigpO1xuICBwcml2YXRlIHJlYWRvbmx5IGxpc3RPcHRpb25zID0gbmV3IEJlaGF2aW9yU3ViamVjdDxUcmFuc2FjdGlvbnNMaXN0T3B0aW9ucz4oZGVmYXVsdEluaXRpYWxMaXN0T3B0aW9ucyk7XG4gIHByaXZhdGUgcmVhZG9ubHkgZXhwb3J0T3B0aW9ucyA9IG5ldyBCZWhhdmlvclN1YmplY3Q8VHJhbnNhY3Rpb25zRXhwb3J0T3B0aW9ucz4oZGVmYXVsdEluaXRpYWxFeHBvcnRPcHRpb25zKTtcbiAgcHJpdmF0ZSByZWFkb25seSBzaG93UGVuZGluZ1RyYW5zYWN0aW9uc09uVG9wID0gbmV3IFJlcGxheVN1YmplY3Q8Ym9vbGVhbj4oMSk7XG4gIHByaXZhdGUgcmVhZG9ubHkgZ2V0T3JQb3N0RW5kcG9pbnQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PEVuZHBvaW50VHlwZT4oRW5kcG9pbnRUeXBlLkdFVF9SRVFVRVNUKTtcbiAgcHJpdmF0ZSByZWFkb25seSB0cmFuc2FjdGlvbnNMaXN0OiBPYnNlcnZhYmxlPFRyYW5zYWN0aW9uc0xpc3Q+ID0gbWVyZ2UoXG4gICAgdGhpcy5saXN0T3B0aW9ucy5waXBlKFxuICAgICAgZmlsdGVyKChsaXN0T3B0aW9ucykgPT4gdHlwZW9mIGxpc3RPcHRpb25zLmFjY291bnQuYXJyYW5nZW1lbnRJZCAhPT0gJ3VuZGVmaW5lZCcpLFxuICAgICAgZGlzdGluY3RVbnRpbENoYW5nZWQoZGVlcEVxdWFsKSxcbiAgICApLFxuICAgIHRoaXMubGlzdFJlZnJlc2gsXG4gICkucGlwZShcbiAgICBjYWNoZVJlcXVlc3QoKGxpc3RPcHRpb25zKSA9PiB7XG4gICAgICB0aGlzLmxvYWRpbmdTdGF0ZS5uZXh0KFxuICAgICAgICBsaXN0T3B0aW9ucy5vbkxvYWQgPT09IE9uTG9hZEFjdGlvbi5BcHBlbmRcbiAgICAgICAgICA/IExvYWRpbmdTdGF0ZS5Mb2FkaW5nTW9yZVxuICAgICAgICAgIDogbGlzdE9wdGlvbnMub25Mb2FkID09PSBPbkxvYWRBY3Rpb24uUmVwbGFjZVBhZ2VcbiAgICAgICAgICA/IExvYWRpbmdTdGF0ZS5Mb2FkaW5nUGFnZVxuICAgICAgICAgIDogTG9hZGluZ1N0YXRlLkxvYWRpbmcsXG4gICAgICApO1xuXG4gICAgICByZXR1cm4gY29tYmluZUxhdGVzdChbXG4gICAgICAgIHRoaXMubG9hZFRyYW5zYWN0aW9ucyhsaXN0T3B0aW9ucykucGlwZShcbiAgICAgICAgICB0YXAoKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5sb2FkaW5nU3RhdGUubmV4dChMb2FkaW5nU3RhdGUuTG9hZGVkKTtcbiAgICAgICAgICB9KSxcbiAgICAgICAgICBtYXAoKHRyYW5zYWN0aW9uc0xpc3QpID0+ICh7IHRyYW5zYWN0aW9uc0xpc3QsIG9uTG9hZDogbGlzdE9wdGlvbnMub25Mb2FkIH0pKSxcbiAgICAgICAgKSxcbiAgICAgICAgaWlmKFxuICAgICAgICAgIG11bHRpcGxlQWNjb3VudHNQcmVkaWNhdGUobGlzdE9wdGlvbnMpLFxuICAgICAgICAgIHRoaXMuYWNjb3VudFNlcnZpY2UuZ2V0QWxsQXJyYW5nZW1lbnRzKCkucGlwZShcbiAgICAgICAgICAgIG1hcCgoYWNjb3VudHMpID0+IHtcbiAgICAgICAgICAgICAgY29uc3QgYWNjb3VudE1hcCA9IG5ldyBNYXA8c3RyaW5nLCBBY2NvdW50PigpO1xuICAgICAgICAgICAgICBhY2NvdW50cy5mb3JFYWNoKChhY2NvdW50KSA9PiB7XG4gICAgICAgICAgICAgICAgYWNjb3VudE1hcC5zZXQoYWNjb3VudC5pZCwgYWNjb3VudCk7XG4gICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgIHJldHVybiBhY2NvdW50TWFwO1xuICAgICAgICAgICAgfSksXG4gICAgICAgICAgKSxcbiAgICAgICAgICBvZihuZXcgTWFwKCkpLFxuICAgICAgICApLFxuICAgICAgICB0aGlzLmlzRmlsdGVyQXBwbGllZCxcbiAgICAgICAgdGhpcy5pc1NlYXJjaEFwcGxpZWQsXG4gICAgICBdKS5waXBlKFxuICAgICAgICBtYXAoKFt0cmFuc2FjdGlvbnMsIGFjY291bnRNYXAsIGlzRmlsdGVyQXBwbGllZCwgaXNTZWFyY2hBcHBsaWVkXSkgPT4ge1xuICAgICAgICAgIHRyYW5zYWN0aW9ucy50cmFuc2FjdGlvbnNMaXN0Lml0ZW1zID0gdHJhbnNhY3Rpb25zLnRyYW5zYWN0aW9uc0xpc3QuaXRlbXMubWFwKCh0cmFuc2FjdGlvbikgPT4gKHtcbiAgICAgICAgICAgIC4uLnRyYW5zYWN0aW9uLFxuICAgICAgICAgICAgYWNjb3VudDogYWNjb3VudE1hcC5nZXQodHJhbnNhY3Rpb24uYXJyYW5nZW1lbnRJZCB8fCAnJyksXG4gICAgICAgICAgfSkpO1xuICAgICAgICAgIHRyYW5zYWN0aW9ucy50cmFuc2FjdGlvbnNMaXN0LmluaXRpYWxSZXF1ZXN0ID0gIShpc0ZpbHRlckFwcGxpZWQgfHwgaXNTZWFyY2hBcHBsaWVkKTtcblxuICAgICAgICAgIHJldHVybiB0cmFuc2FjdGlvbnM7XG4gICAgICAgIH0pLFxuICAgICAgKTtcbiAgICB9KSxcbiAgICBzY2FuKG9uTG9hZFRyYW5zYWN0aW9ucywgeyBpdGVtczogW10sIHRvdGFsQ291bnQ6IDAgfSksXG4gICk7XG5cbiAgcHVibGljIHJlYWRvbmx5IGxvYWRpbmdTdGF0ZSA9IG5ldyBCZWhhdmlvclN1YmplY3Q8TG9hZGluZ1N0YXRlPihMb2FkaW5nU3RhdGUuTm90TG9hZGVkKTtcblxuICBwdWJsaWMgcmVhZG9ubHkgaXNGaWx0ZXJBcHBsaWVkID0gdGhpcy5saXN0T3B0aW9ucy5waXBlKFxuICAgIG1hcCgob3B0aW9ucykgPT4gIVRyYW5zYWN0aW9uc0ZpbHRlck9wdGlvbnMuaXNFbXB0eShvcHRpb25zLmZpbHRlciB8fCB7fSkpLFxuICApO1xuXG4gIHB1YmxpYyByZWFkb25seSBpc1NlYXJjaEFwcGxpZWQgPSB0aGlzLmxpc3RPcHRpb25zLnBpcGUoXG4gICAgbWFwKChvcHRpb25zKSA9PiAhVHJhbnNhY3Rpb25zRmlsdGVyT3B0aW9ucy5pc0VtcHR5KG9wdGlvbnMuc2VhcmNoIHx8IHt9KSksXG4gICk7XG5cbiAgcHJpdmF0ZSBsb2FkVHJhbnNhY3Rpb25zKGxpc3RPcHRpb25zOiBUcmFuc2FjdGlvbnNMaXN0T3B0aW9ucyk6IE9ic2VydmFibGU8VHJhbnNhY3Rpb25zTGlzdD4ge1xuICAgIGNvbnN0IHRyYW5zYWN0aW9uUGF5bG9hZCA9IFRyYW5zYWN0aW9uc0xpc3QudG9IdHRwUmVxdWVzdChsaXN0T3B0aW9ucyk7XG4gICAgbGV0IHRyYW5zYWN0aW9uc1Jlc3BvbnNlOiBPYnNlcnZhYmxlPEh0dHBSZXNwb25zZTxBcnJheTxUcmFuc2FjdGlvbkl0ZW0+Pj4gfCB1bmRlZmluZWQ7XG5cbiAgICBpZiAodGhpcy5pc1VzaW5nUG9zdEVuZHBvaW50cykge1xuICAgICAgdHJhbnNhY3Rpb25zUmVzcG9uc2UgPSB0aGlzLnRyYW5zYWN0aW9uc0RhdGFIdHRwU2VydmljZS5nZXRUcmFuc2FjdGlvbnNXaXRoUG9zdChcbiAgICAgICAgeyB0cmFuc2FjdGlvbkxpc3RSZXF1ZXN0OiB0cmFuc2FjdGlvblBheWxvYWQgfSBhcyBHZXRUcmFuc2FjdGlvbnNXaXRoUG9zdFJlcXVlc3RQYXJhbXMsXG4gICAgICAgICdyZXNwb25zZScsXG4gICAgICApO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmRlcHJlY2F0aW9uc1NlcnZpY2UubG9nRGVwcmVjYXRlZEZlYXR1cmUoXG4gICAgICAgICdbVHJhbnNhY3Rpb25zU2VydmljZTogbG9hZFRyYW5zYWN0aW9uc10gR0VUIGVuZHBvaW50cyBkZXByZWNhdGVkLiBQbGVhc2UgdXNlIFBPU1QgZW5kcG9pbnRzIGJ5IGNoYW5naW5nIENYUCBjb25maWd1cmF0aW9uJyxcbiAgICAgICk7XG4gICAgICB0cmFuc2FjdGlvbnNSZXNwb25zZSA9IHRoaXMudHJhbnNhY3Rpb25zRGF0YUh0dHBTZXJ2aWNlLmdldFRyYW5zYWN0aW9ucyh0cmFuc2FjdGlvblBheWxvYWQsICdyZXNwb25zZScpO1xuICAgIH1cblxuICAgIHJldHVybiB0cmFuc2FjdGlvbnNSZXNwb25zZS5waXBlKFxuICAgICAgbWFwKFRyYW5zYWN0aW9uc0xpc3QuZnJvbUh0dHBSZXNwb25zZSksXG4gICAgICBjYXRjaEVycm9yKChlcnIpID0+XG4gICAgICAgIG9mKHtcbiAgICAgICAgICBpdGVtczogW10sXG4gICAgICAgICAgdG90YWxDb3VudDogMCxcbiAgICAgICAgICBodHRwUmVzcG9uc2VFcnJvcjogZXJyLFxuICAgICAgICB9KSxcbiAgICAgICksXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgZXhwb3J0VHJhbnNhY3Rpb25zKGV4cG9ydE9wdGlvbnM6IFRyYW5zYWN0aW9uc0V4cG9ydE9wdGlvbnMpOiBPYnNlcnZhYmxlPEh0dHBSZXNwb25zZTxCbG9iPj4ge1xuICAgIGNvbnN0IGV4cG9ydFBheWxvYWQgPSBUcmFuc2FjdGlvbnNMaXN0LnRvSHR0cFJlcXVlc3Qoe1xuICAgICAgLi4uZXhwb3J0T3B0aW9ucyxcbiAgICAgIGxvY2FsZTogdGhpcy5sb2NhbGUsXG4gICAgfSk7XG5cbiAgICBpZiAodGhpcy5pc1VzaW5nUG9zdEVuZHBvaW50cykge1xuICAgICAgcmV0dXJuIHRoaXMudHJhbnNhY3Rpb25zRGF0YUh0dHBTZXJ2aWNlLmdldFRyYW5zYWN0aW9uc0V4cG9ydFdpdGhQb3N0KFxuICAgICAgICB7IHRyYW5zYWN0aW9uTGlzdFJlcXVlc3Q6IGV4cG9ydFBheWxvYWQgfSBhcyBHZXRUcmFuc2FjdGlvbnNFeHBvcnRXaXRoUG9zdFJlcXVlc3RQYXJhbXMsXG4gICAgICAgICdyZXNwb25zZScsXG4gICAgICApO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmRlcHJlY2F0aW9uc1NlcnZpY2UubG9nRGVwcmVjYXRlZEZlYXR1cmUoXG4gICAgICAgICdbVHJhbnNhY3Rpb25zU2VydmljZTogZXhwb3J0VHJhbnNhY3Rpb25zXSBHRVQgZW5kcG9pbnRzIGRlcHJlY2F0ZWQuIFBsZWFzZSB1c2UgUE9TVCBlbmRwb2ludHMgYnkgY2hhbmdpbmcgQ1hQIGNvbmZpZ3VyYXRpb24nLFxuICAgICAgKTtcblxuICAgICAgcmV0dXJuIHRoaXMudHJhbnNhY3Rpb25zRGF0YUh0dHBTZXJ2aWNlLmdldFRyYW5zYWN0aW9uc0V4cG9ydChleHBvcnRQYXlsb2FkLCAncmVzcG9uc2UnKTtcbiAgICB9XG4gIH1cblxuICBzZWFyY2gocXVlcnk6IHN0cmluZykge1xuICAgIGNvbnN0IHNlYXJjaE9wdGlvbnM6IFRyYW5zYWN0aW9uc1NlYXJjaE9wdGlvbnMgPSB7XG4gICAgICBxdWVyeSxcbiAgICB9O1xuXG4gICAgY29uc3QgcGFnaW5hdGlvbk9wdGlvbnMgPSB7XG4gICAgICAuLi4odGhpcy5vcHRpb25zLmdldFZhbHVlKCkucGFnaW5hdGlvbiB8fCBkZWZhdWx0UGFnaW5hdGlvbk9wdGlvbnMucGFnaW5hdGlvbiksXG4gICAgICBmcm9tOiAwLCAvLyByZXNldCB0byAwXG4gICAgfTtcblxuICAgIHRoaXMub3B0aW9ucy5uZXh0KHtcbiAgICAgIC4uLnRoaXMub3B0aW9ucy5nZXRWYWx1ZSgpLFxuICAgICAgLi4uZGVmYXVsdFNlYXJjaE9wdGlvbnMsXG4gICAgICBwYWdpbmF0aW9uOiBwYWdpbmF0aW9uT3B0aW9ucyxcbiAgICAgIHNlYXJjaDogc2VhcmNoT3B0aW9ucyxcbiAgICAgIG9uTG9hZDogT25Mb2FkQWN0aW9uLlJlcGxhY2UsXG4gICAgfSk7XG4gIH1cblxuICBjbGVhclNlYXJjaCgpIHtcbiAgICBjb25zdCBwYWdpbmF0aW9uT3B0aW9ucyA9IHtcbiAgICAgIC4uLih0aGlzLm9wdGlvbnMuZ2V0VmFsdWUoKS5wYWdpbmF0aW9uIHx8IGRlZmF1bHRQYWdpbmF0aW9uT3B0aW9ucy5wYWdpbmF0aW9uKSxcbiAgICAgIGZyb206IDAsIC8vIHJlc2V0IHRvIDBcbiAgICB9O1xuXG4gICAgdGhpcy5vcHRpb25zLm5leHQoe1xuICAgICAgLi4udGhpcy5vcHRpb25zLmdldFZhbHVlKCksXG4gICAgICAuLi5kZWZhdWx0U2VhcmNoT3B0aW9ucyxcbiAgICAgIHBhZ2luYXRpb246IHBhZ2luYXRpb25PcHRpb25zLFxuICAgICAgb25Mb2FkOiBPbkxvYWRBY3Rpb24uUmVwbGFjZSxcbiAgICB9KTtcbiAgfVxuXG4gIGZpbHRlcihmaWx0ZXJPcHRpb25zOiBUcmFuc2FjdGlvbnNGaWx0ZXJPcHRpb25zKSB7XG4gICAgY29uc3QgcGFnaW5hdGlvbk9wdGlvbnMgPSB7XG4gICAgICAuLi4odGhpcy5vcHRpb25zLmdldFZhbHVlKCkucGFnaW5hdGlvbiB8fCBkZWZhdWx0UGFnaW5hdGlvbk9wdGlvbnMucGFnaW5hdGlvbiksXG4gICAgICBmcm9tOiAwLCAvLyByZXNldCB0byAwXG4gICAgfTtcblxuICAgIHRoaXMub3B0aW9ucy5uZXh0KHtcbiAgICAgIC4uLnRoaXMub3B0aW9ucy5nZXRWYWx1ZSgpLFxuICAgICAgLi4uZGVmYXVsdEZpbHRlck9wdGlvbnMsXG4gICAgICBwYWdpbmF0aW9uOiBwYWdpbmF0aW9uT3B0aW9ucyxcbiAgICAgIGZpbHRlcjogeyAuLi5maWx0ZXJPcHRpb25zIH0sXG4gICAgICBvbkxvYWQ6IE9uTG9hZEFjdGlvbi5SZXBsYWNlLFxuICAgIH0pO1xuICB9XG5cbiAgY2xlYXJGaWx0ZXIoKSB7XG4gICAgY29uc3QgcGFnaW5hdGlvbk9wdGlvbnMgPSB7XG4gICAgICAuLi4odGhpcy5vcHRpb25zLmdldFZhbHVlKCkucGFnaW5hdGlvbiB8fCBkZWZhdWx0UGFnaW5hdGlvbk9wdGlvbnMucGFnaW5hdGlvbiksXG4gICAgICBmcm9tOiAwLCAvLyByZXNldCB0byAwXG4gICAgfTtcblxuICAgIHRoaXMub3B0aW9ucy5uZXh0KHtcbiAgICAgIC4uLnRoaXMub3B0aW9ucy5nZXRWYWx1ZSgpLFxuICAgICAgLi4uZGVmYXVsdEZpbHRlck9wdGlvbnMsXG4gICAgICBwYWdpbmF0aW9uOiBwYWdpbmF0aW9uT3B0aW9ucyxcbiAgICAgIG9uTG9hZDogT25Mb2FkQWN0aW9uLlJlcGxhY2UsXG4gICAgfSk7XG4gIH1cblxuICBleHBvcnRUb1R5cGUodHlwZTogc3RyaW5nKSB7XG4gICAgcmV0dXJuIHRoaXMuZXhwb3J0T3B0aW9ucy5waXBlKFxuICAgICAgZmlyc3QoKSxcbiAgICAgIHN3aXRjaE1hcCgoZXhwb3J0T3B0aW9uczogVHJhbnNhY3Rpb25zRXhwb3J0T3B0aW9ucykgPT5cbiAgICAgICAgdGhpcy5leHBvcnRUcmFuc2FjdGlvbnMoe1xuICAgICAgICAgIC4uLmV4cG9ydE9wdGlvbnMsXG4gICAgICAgICAgZXhwb3J0VHlwZTogdHlwZSxcbiAgICAgICAgfSksXG4gICAgICApLFxuICAgICk7XG4gIH1cblxuICBsb2FkTW9yZSgpIHtcbiAgICBjb25zdCBjdXJyZW50UGFnaW5hdGlvbk9wdGlvbnMgPSB0aGlzLm9wdGlvbnMuZ2V0VmFsdWUoKS5wYWdpbmF0aW9uIHx8IGRlZmF1bHRQYWdpbmF0aW9uT3B0aW9ucy5wYWdpbmF0aW9uO1xuICAgIGNvbnN0IHBhZ2luYXRpb25PcHRpb25zID0ge1xuICAgICAgLi4uY3VycmVudFBhZ2luYXRpb25PcHRpb25zLFxuICAgICAgZnJvbTogY3VycmVudFBhZ2luYXRpb25PcHRpb25zLmZyb20gKyAxLFxuICAgIH07XG5cbiAgICB0aGlzLm9wdGlvbnMubmV4dCh7XG4gICAgICBwYWdpbmF0aW9uOiBwYWdpbmF0aW9uT3B0aW9ucyxcbiAgICAgIG9uTG9hZDogT25Mb2FkQWN0aW9uLkFwcGVuZCxcbiAgICB9KTtcbiAgfVxuXG4gIHNvcnQoc29ydE9wdGlvbnM6IFRyYW5zYWN0aW9uc1NvcnRPcHRpb25zKSB7XG4gICAgY29uc3QgY3VycmVudFBhZ2luYXRpb25PcHRpb25zID0gdGhpcy5vcHRpb25zLmdldFZhbHVlKCkucGFnaW5hdGlvbiB8fCBkZWZhdWx0UGFnaW5hdGlvbk9wdGlvbnMucGFnaW5hdGlvbjtcbiAgICB0aGlzLm9wdGlvbnMubmV4dCh7XG4gICAgICBzb3J0OiB7IC4uLnNvcnRPcHRpb25zIH0sXG4gICAgICBwYWdpbmF0aW9uOiB7XG4gICAgICAgIC4uLmN1cnJlbnRQYWdpbmF0aW9uT3B0aW9ucyxcbiAgICAgICAgZnJvbTogMCxcbiAgICAgIH0sXG4gICAgICBvbkxvYWQ6IE9uTG9hZEFjdGlvbi5SZXBsYWNlUGFnZSxcbiAgICB9KTtcbiAgfVxuXG4gIHBhZ2VDaGFuZ2UocGFnZTogbnVtYmVyKSB7XG4gICAgY29uc3QgcGFnaW5hdGlvbk9wdGlvbnMgPSB7XG4gICAgICAuLi5kZWZhdWx0UGFnaW5hdGlvbk9wdGlvbnMucGFnaW5hdGlvbixcbiAgICAgIC4uLnRoaXMub3B0aW9ucy5nZXRWYWx1ZSgpLnBhZ2luYXRpb24sXG4gICAgICBmcm9tOiBwYWdlLFxuICAgIH07XG5cbiAgICB0aGlzLm9wdGlvbnMubmV4dCh7XG4gICAgICBwYWdpbmF0aW9uOiBwYWdpbmF0aW9uT3B0aW9ucyxcbiAgICAgIG9uTG9hZDogT25Mb2FkQWN0aW9uLlJlcGxhY2VQYWdlLFxuICAgIH0pO1xuICB9XG5cbiAgZ2V0VHJhbnNhY3Rpb25zRnJvbShcbiAgICBzZWxlY3RlZEFjY291bnQ6IE9ic2VydmFibGU8c3RyaW5nW10+LFxuICAgIHBhZ2VTaXplOiBPYnNlcnZhYmxlPG51bWJlcj4sXG4gICAgaW5pdGlhbExpc3RPcHRpb25zOiBPYnNlcnZhYmxlPFBhcnRpYWw8VHJhbnNhY3Rpb25zTGlzdE9wdGlvbnM+PiA9IG9mKHt9KSxcbiAgICBzaG93UGVuZGluZ1RyYW5zYWN0aW9uc09uVG9wOiBPYnNlcnZhYmxlPGJvb2xlYW4+ID0gb2YoZmFsc2UpLFxuICAgIGdldE9yUG9zdEVuZHBvaW50OiBPYnNlcnZhYmxlPEVuZHBvaW50VHlwZT4gPSBvZihFbmRwb2ludFR5cGUuR0VUX1JFUVVFU1QpLFxuICApIHtcbiAgICBzZWxlY3RlZEFjY291bnQuc3Vic2NyaWJlKHRoaXMuc2VsZWN0ZWRBY2NvdW50KTtcbiAgICBwYWdlU2l6ZS5zdWJzY3JpYmUodGhpcy5wYWdlU2l6ZSk7XG4gICAgaW5pdGlhbExpc3RPcHRpb25zLnN1YnNjcmliZSh0aGlzLmluaXRpYWxMaXN0T3B0aW9ucyk7XG4gICAgc2hvd1BlbmRpbmdUcmFuc2FjdGlvbnNPblRvcC5zdWJzY3JpYmUodGhpcy5zaG93UGVuZGluZ1RyYW5zYWN0aW9uc09uVG9wKTtcbiAgICBnZXRPclBvc3RFbmRwb2ludC5zdWJzY3JpYmUodGhpcy5nZXRPclBvc3RFbmRwb2ludCk7XG4gIH1cblxuICBnZXRDdXJyZW50UGFnZSgpIHtcbiAgICByZXR1cm4gdGhpcy5saXN0T3B0aW9ucy5waXBlKG1hcCgob3B0aW9ucykgPT4gKG9wdGlvbnMucGFnaW5hdGlvbiB8fCBkZWZhdWx0UGFnaW5hdGlvbk9wdGlvbnMucGFnaW5hdGlvbikuZnJvbSkpO1xuICB9XG5cbiAgZ2V0VHJhbnNhY3Rpb25zTGlzdCgpIHtcbiAgICByZXR1cm4gdGhpcy50cmFuc2FjdGlvbnNMaXN0O1xuICB9XG5cbiAgcmV0cnlGaWx0ZXJpbmcoKSB7XG4gICAgdGhpcy5saXN0UmVmcmVzaC5uZXh0KHRoaXMubGlzdE9wdGlvbnMuZ2V0VmFsdWUoKSk7XG4gIH1cblxuICByZWZyZXNoVHJhbnNhY3Rpb25zKCkge1xuICAgIGNvbnN0IGN1cnJlbnRQYWdpbmF0aW9uT3B0aW9ucyA9IHRoaXMub3B0aW9ucy5nZXRWYWx1ZSgpLnBhZ2luYXRpb24gfHwgZGVmYXVsdFBhZ2luYXRpb25PcHRpb25zLnBhZ2luYXRpb247XG4gICAgY29uc3QgcGFnaW5hdGlvbk9wdGlvbnMgPSB7XG4gICAgICAuLi5jdXJyZW50UGFnaW5hdGlvbk9wdGlvbnMsXG4gICAgICBmcm9tOiAwLFxuICAgIH07XG5cbiAgICBjb25zdCBuZXdPcHRpb25zID0ge1xuICAgICAgLi4udGhpcy5saXN0T3B0aW9ucy5nZXRWYWx1ZSgpLFxuICAgICAgcGFnaW5hdGlvbjogcGFnaW5hdGlvbk9wdGlvbnMsXG4gICAgICBvbkxvYWQ6IE9uTG9hZEFjdGlvbi5SZXBsYWNlUGFnZSxcbiAgICB9O1xuXG4gICAgaWYgKGRlZXBFcXVhbChuZXdPcHRpb25zLCB0aGlzLmxpc3RPcHRpb25zLmdldFZhbHVlKCkpKSB7XG4gICAgICB0aGlzLmxpc3RSZWZyZXNoLm5leHQodGhpcy5saXN0T3B0aW9ucy5nZXRWYWx1ZSgpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5vcHRpb25zLm5leHQoe1xuICAgICAgICBwYWdpbmF0aW9uOiBwYWdpbmF0aW9uT3B0aW9ucyxcbiAgICAgICAgb25Mb2FkOiBPbkxvYWRBY3Rpb24uUmVwbGFjZVBhZ2UsXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGdldCBpc1VzaW5nUG9zdEVuZHBvaW50cygpIHtcbiAgICByZXR1cm4gdGhpcy5nZXRPclBvc3RFbmRwb2ludC5nZXRWYWx1ZSgpID09PSBFbmRwb2ludFR5cGUuUE9TVF9SRVFVRVNUO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgdGhpcy5saXN0UmVmcmVzaC5jb21wbGV0ZSgpO1xuICAgIHRoaXMuc2VsZWN0ZWRBY2NvdW50LmNvbXBsZXRlKCk7XG4gICAgdGhpcy5wYWdlU2l6ZS5jb21wbGV0ZSgpO1xuICAgIHRoaXMuaW5pdGlhbExpc3RPcHRpb25zLmNvbXBsZXRlKCk7XG4gICAgdGhpcy5vcHRpb25zLmNvbXBsZXRlKCk7XG4gICAgdGhpcy5saXN0T3B0aW9ucy5jb21wbGV0ZSgpO1xuICAgIHRoaXMuZXhwb3J0T3B0aW9ucy5jb21wbGV0ZSgpO1xuICAgIHRoaXMuc2hvd1BlbmRpbmdUcmFuc2FjdGlvbnNPblRvcC5jb21wbGV0ZSgpO1xuICAgIHRoaXMubG9hZGluZ1N0YXRlLmNvbXBsZXRlKCk7XG4gICAgdGhpcy5nZXRPclBvc3RFbmRwb2ludC5jb21wbGV0ZSgpO1xuICB9XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSB0cmFuc2FjdGlvbnNEYXRhSHR0cFNlcnZpY2U6IFRyYW5zYWN0aW9uQ2xpZW50SHR0cFNlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSBhY2NvdW50U2VydmljZTogQWNjb3VudHNTZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgZGVwcmVjYXRpb25zU2VydmljZTogRGVwcmVjYXRpb25zU2VydmljZSxcbiAgICBASW5qZWN0KExPQ0FMRV9JRCkgcHJpdmF0ZSByZWFkb25seSBsb2NhbGU6IHN0cmluZyxcbiAgKSB7XG4gICAgLy8gQmFzZSB0aGlzLm9wdGlvbnMgb24gdGhpcy5zZWxlY3RlZEFjY291bnQsIHRoaXMucGFnZVNpemUsIHRoaXMuaW5pdGlhbExpc3RPcHRpb25zXG4gICAgY29tYmluZUxhdGVzdChbdGhpcy5zZWxlY3RlZEFjY291bnQsIHRoaXMucGFnZVNpemUsIHRoaXMuaW5pdGlhbExpc3RPcHRpb25zLCB0aGlzLnNob3dQZW5kaW5nVHJhbnNhY3Rpb25zT25Ub3BdKVxuICAgICAgLnBpcGUoXG4gICAgICAgIG1hcCgoW3NlbGVjdGVkQWNjb3VudCwgcGFnZVNpemUsIGluaXRpYWxMaXN0T3B0aW9ucywgc2hvd1BlbmRpbmdUcmFuc2FjdGlvbnNPblRvcF0pID0+ICh7XG4gICAgICAgICAgLi4uKHNob3dQZW5kaW5nVHJhbnNhY3Rpb25zT25Ub3AgPyB7IHN0YXRlOiBUcmFuc2FjdGlvblN0YXRlLmNvbXBsZXRlZCB9IDoge30pLFxuICAgICAgICAgIGFjY291bnQ6IHtcbiAgICAgICAgICAgIGFycmFuZ2VtZW50SWQ6IHNlbGVjdGVkQWNjb3VudCxcbiAgICAgICAgICB9LFxuICAgICAgICAgIHBhZ2luYXRpb246IHtcbiAgICAgICAgICAgIGZyb206IDAsXG4gICAgICAgICAgICBzaXplOiBwYWdlU2l6ZSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIG9uTG9hZDogT25Mb2FkQWN0aW9uLlJlcGxhY2UsXG4gICAgICAgICAgLi4uaW5pdGlhbExpc3RPcHRpb25zLFxuICAgICAgICB9KSksXG4gICAgICApXG4gICAgICAuc3Vic2NyaWJlKHRoaXMub3B0aW9ucyk7XG5cbiAgICAvLyBCYXNlIHRoaXMubGlzdE9wdGlvbnMgb24gdGhpcy5vcHRpb25zXG4gICAgdGhpcy5vcHRpb25zXG4gICAgICAucGlwZShzY2FuKChhY2M6IGFueSwgY3VycikgPT4gT2JqZWN0LmFzc2lnbih7fSwgYWNjLCBjdXJyKSwgZGVmYXVsdEluaXRpYWxMaXN0T3B0aW9ucykpXG4gICAgICAuc3Vic2NyaWJlKHRoaXMubGlzdE9wdGlvbnMpO1xuXG4gICAgLy8gQmFzZSB0aGlzLmV4cG9ydE9wdGlvbnMgb24gdGhpcy5saXN0T3B0aW9uc1xuICAgIHRoaXMubGlzdE9wdGlvbnNcbiAgICAgIC5waXBlKFxuICAgICAgICBmaWx0ZXIoKGxpc3RPcHRpb25zKSA9PiB0eXBlb2YgbGlzdE9wdGlvbnMuYWNjb3VudC5hcnJhbmdlbWVudElkICE9PSAndW5kZWZpbmVkJyksXG4gICAgICAgIG1hcCgocGFyYW1zKSA9PiAoe1xuICAgICAgICAgIC4uLnBhcmFtcyxcbiAgICAgICAgICBwYWdpbmF0aW9uOiB1bmRlZmluZWQsXG4gICAgICAgICAgc3RhdGU6IHVuZGVmaW5lZCxcbiAgICAgICAgICBleHBvcnRUeXBlOiAnY3N2JyxcbiAgICAgICAgICBsb2NhbGU6ICdlbi1VUycsXG4gICAgICAgIH0pKSxcbiAgICAgIClcbiAgICAgIC5zdWJzY3JpYmUodGhpcy5leHBvcnRPcHRpb25zKTtcbiAgfVxufVxuIl19