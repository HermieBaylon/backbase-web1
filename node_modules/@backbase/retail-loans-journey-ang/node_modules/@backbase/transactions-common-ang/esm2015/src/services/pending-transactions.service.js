import { Injectable } from '@angular/core';
import { ReplaySubject, BehaviorSubject, combineLatest, of, merge, Subject, iif } from 'rxjs';
import { defaultInitialListOptions, defaultPaginationOptions, defaultSearchOptions, defaultFilterOptions, OnLoadAction, TransactionState, } from '../model/transactions-list-options.model';
import { map, scan, filter, distinctUntilChanged, tap, catchError } from 'rxjs/operators';
import { TransactionsList } from '../model/transactions-list.model';
import { TransactionsFilterOptions } from '../model/transactions-filter-options.model';
import { deepEqual, cacheRequest, multipleAccountsPredicate, onLoadTransactions, } from '../model/transactions-list-utils.model';
import { LoadingState } from './transactions.service';
import { EndpointType } from './widget-properties.service';
import * as i0 from "@angular/core";
import * as i1 from "@backbase/data-ang/transactions";
import * as i2 from "./accounts.service";
import * as i3 from "@backbase/foundation-ang/core";
export class PendingTransactionsService {
    constructor(transactionsDataHttpService, accountService, deprecationsService) {
        this.transactionsDataHttpService = transactionsDataHttpService;
        this.accountService = accountService;
        this.deprecationsService = deprecationsService;
        this.initialListOptions = new ReplaySubject(1);
        this.selectedAccount = new ReplaySubject(1);
        this.options = new BehaviorSubject({});
        this.listOptions = new BehaviorSubject(defaultInitialListOptions);
        this.listRefresh = new Subject();
        this.getOrPostEndpoint = new BehaviorSubject(EndpointType.GET_REQUEST);
        this.transactionsList = merge(this.listOptions.pipe(filter((listOptions) => typeof listOptions.account.arrangementId !== 'undefined'), distinctUntilChanged(deepEqual)), this.listRefresh).pipe(cacheRequest((listOptions) => {
            this.loadingState.next(listOptions.onLoad === OnLoadAction.Append
                ? LoadingState.LoadingMore
                : listOptions.onLoad === OnLoadAction.ReplacePage
                    ? LoadingState.LoadingPage
                    : LoadingState.Loading);
            return combineLatest([
                this.loadTransactions(listOptions).pipe(tap(() => {
                    this.loadingState.next(LoadingState.Loaded);
                }), map((transactionsList) => ({ transactionsList, onLoad: OnLoadAction.ReplacePage }))),
                iif(multipleAccountsPredicate(listOptions), this.accountService.getAllArrangements().pipe(map((accounts) => {
                    const accountMap = new Map();
                    accounts.forEach((account) => {
                        accountMap.set(account.id, account);
                    });
                    return accountMap;
                })), of(new Map())),
            ]).pipe(map(([transactions, accountMap]) => {
                transactions.transactionsList.items = transactions.transactionsList.items.map((transaction) => (Object.assign(Object.assign({}, transaction), { account: accountMap.get(transaction.arrangementId || '') })));
                return transactions;
            }));
        }), scan(onLoadTransactions, { items: [], totalCount: 0 }));
        this.loadingState = new BehaviorSubject(LoadingState.NotLoaded);
        this.isFilterApplied = this.listOptions.pipe(map((options) => !TransactionsFilterOptions.isEmpty(options.filter || {})));
        this.isSearchApplied = this.listOptions.pipe(map((options) => !TransactionsFilterOptions.isEmpty(options.search || {})));
        combineLatest([this.selectedAccount, this.initialListOptions])
            .pipe(map(([selectedAccount, initialListOptions]) => (Object.assign({ account: {
                arrangementId: selectedAccount,
            }, pagination: {
                from: 0,
                size: 250,
            }, state: TransactionState.uncompleted }, initialListOptions))))
            .subscribe(this.options);
        // Base this.listOptions on this.options
        this.options
            .pipe(scan((acc, curr) => Object.assign({}, acc, curr), defaultInitialListOptions))
            .subscribe(this.listOptions);
    }
    loadTransactions(listOptions) {
        const transactionPayload = TransactionsList.toHttpRequest(listOptions);
        let transactionsResponse;
        if (this.isUsingPostEndpoints) {
            transactionsResponse = this.transactionsDataHttpService.getTransactionsWithPost({ transactionListRequest: transactionPayload }, 'response');
        }
        else {
            this.deprecationsService.logDeprecatedFeature('[PendingTransactionsService: loadTransactions] GET endpoints are deprecated. Please use POST endpoints by changing CXP configuration');
            transactionsResponse = this.transactionsDataHttpService.getTransactions(transactionPayload, 'response');
        }
        return transactionsResponse.pipe(map(TransactionsList.fromHttpResponse), catchError((err) => of({
            items: [],
            totalCount: 0,
            httpResponseError: err,
        })));
    }
    getTransactionsFrom(selectedAccount, initialListOptions = of({}), getOrPostEndpoint = of(EndpointType.GET_REQUEST)) {
        selectedAccount.subscribe(this.selectedAccount);
        initialListOptions.subscribe(this.initialListOptions);
        getOrPostEndpoint.subscribe(this.getOrPostEndpoint);
    }
    getTransactionsList() {
        return this.transactionsList;
    }
    search(query) {
        const searchOptions = {
            query,
        };
        const paginationOptions = Object.assign(Object.assign({}, (this.options.getValue().pagination || defaultPaginationOptions.pagination)), { from: 0 });
        this.options.next(Object.assign(Object.assign(Object.assign({}, this.options.getValue()), defaultSearchOptions), { pagination: paginationOptions, search: searchOptions }));
    }
    clearSearch() {
        const paginationOptions = Object.assign(Object.assign({}, (this.options.getValue().pagination || defaultPaginationOptions.pagination)), { from: 0 });
        this.options.next(Object.assign(Object.assign(Object.assign({}, this.options.getValue()), defaultSearchOptions), { pagination: paginationOptions }));
    }
    filter(filterOptions) {
        const paginationOptions = Object.assign(Object.assign({}, (this.options.getValue().pagination || defaultPaginationOptions.pagination)), { from: 0 });
        this.options.next(Object.assign(Object.assign(Object.assign({}, this.options.getValue()), defaultFilterOptions), { pagination: paginationOptions, filter: Object.assign({}, filterOptions) }));
    }
    clearFilter() {
        const paginationOptions = Object.assign(Object.assign({}, (this.options.getValue().pagination || defaultPaginationOptions.pagination)), { from: 0 });
        this.options.next(Object.assign(Object.assign(Object.assign({}, this.options.getValue()), defaultFilterOptions), { pagination: paginationOptions }));
    }
    sort(sortOptions) {
        const currentPaginationOptions = this.options.getValue().pagination || defaultPaginationOptions.pagination;
        this.options.next({
            sort: Object.assign({}, sortOptions),
            pagination: Object.assign(Object.assign({}, currentPaginationOptions), { from: 0 }),
        });
    }
    retryFiltering() {
        this.listRefresh.next(this.listOptions.getValue());
    }
    refreshTransactions() {
        const currentPaginationOptions = this.options.getValue().pagination || defaultPaginationOptions.pagination;
        const paginationOptions = Object.assign(Object.assign({}, currentPaginationOptions), { from: 0 });
        const newOptions = Object.assign(Object.assign({}, this.listOptions.getValue()), { pagination: paginationOptions });
        if (deepEqual(newOptions, this.listOptions.getValue())) {
            this.listRefresh.next(this.listOptions.getValue());
        }
        else {
            this.options.next({
                pagination: paginationOptions,
            });
        }
    }
    get isUsingPostEndpoints() {
        return this.getOrPostEndpoint.getValue() === EndpointType.POST_REQUEST;
    }
    ngOnDestroy() {
        this.listRefresh.complete();
        this.selectedAccount.complete();
        this.initialListOptions.complete();
        this.options.complete();
        this.listOptions.complete();
        this.loadingState.complete();
        this.getOrPostEndpoint.complete();
    }
}
PendingTransactionsService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: PendingTransactionsService, deps: [{ token: i1.TransactionClientHttpService }, { token: i2.AccountsService }, { token: i3.DeprecationsService }], target: i0.ɵɵFactoryTarget.Injectable });
PendingTransactionsService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: PendingTransactionsService });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: PendingTransactionsService, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.TransactionClientHttpService }, { type: i2.AccountsService }, { type: i3.DeprecationsService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGVuZGluZy10cmFuc2FjdGlvbnMuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL2xpYnMvdHJhbnNhY3Rpb25zLWNvbW1vbi1hbmcvc3JjL3NlcnZpY2VzL3BlbmRpbmctdHJhbnNhY3Rpb25zLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBYSxNQUFNLGVBQWUsQ0FBQztBQU90RCxPQUFPLEVBQUUsYUFBYSxFQUFFLGVBQWUsRUFBRSxhQUFhLEVBQWMsRUFBRSxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzFHLE9BQU8sRUFFTCx5QkFBeUIsRUFDekIsd0JBQXdCLEVBQ3hCLG9CQUFvQixFQUNwQixvQkFBb0IsRUFDcEIsWUFBWSxFQUNaLGdCQUFnQixHQUNqQixNQUFNLDBDQUEwQyxDQUFDO0FBQ2xELE9BQU8sRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxvQkFBb0IsRUFBRSxHQUFHLEVBQUUsVUFBVSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDMUYsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFFcEUsT0FBTyxFQUFFLHlCQUF5QixFQUFFLE1BQU0sNENBQTRDLENBQUM7QUFHdkYsT0FBTyxFQUNMLFNBQVMsRUFDVCxZQUFZLEVBQ1oseUJBQXlCLEVBQ3pCLGtCQUFrQixHQUNuQixNQUFNLHdDQUF3QyxDQUFDO0FBQ2hELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUN0RCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sNkJBQTZCLENBQUM7Ozs7O0FBSzNELE1BQU0sT0FBTywwQkFBMEI7SUEwTnJDLFlBQ21CLDJCQUF5RCxFQUN6RCxjQUErQixFQUMvQixtQkFBd0M7UUFGeEMsZ0NBQTJCLEdBQTNCLDJCQUEyQixDQUE4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Z3VsYXIvY29yZSc7XG5pbXBvcnQge1xuICBUcmFuc2FjdGlvbkNsaWVudEh0dHBTZXJ2aWNlLFxuICBHZXRUcmFuc2FjdGlvbnNXaXRoUG9zdFJlcXVlc3RQYXJhbXMsXG4gIFRyYW5zYWN0aW9uSXRlbSxcbn0gZnJvbSAnQGJhY2tiYXNlL2RhdGEtYW5nL3RyYW5zYWN0aW9ucyc7XG5pbXBvcnQgeyBBY2NvdW50c1NlcnZpY2UgfSBmcm9tICcuL2FjY291bnRzLnNlcnZpY2UnO1xuaW1wb3J0IHsgUmVwbGF5U3ViamVjdCwgQmVoYXZpb3JTdWJqZWN0LCBjb21iaW5lTGF0ZXN0LCBPYnNlcnZhYmxlLCBvZiwgbWVyZ2UsIFN1YmplY3QsIGlpZiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtcbiAgVHJhbnNhY3Rpb25zTGlzdE9wdGlvbnMsXG4gIGRlZmF1bHRJbml0aWFsTGlzdE9wdGlvbnMsXG4gIGRlZmF1bHRQYWdpbmF0aW9uT3B0aW9ucyxcbiAgZGVmYXVsdFNlYXJjaE9wdGlvbnMsXG4gIGRlZmF1bHRGaWx0ZXJPcHRpb25zLFxuICBPbkxvYWRBY3Rpb24sXG4gIFRyYW5zYWN0aW9uU3RhdGUsXG59IGZyb20gJy4uL21vZGVsL3RyYW5zYWN0aW9ucy1saXN0LW9wdGlvbnMubW9kZWwnO1xuaW1wb3J0IHsgbWFwLCBzY2FuLCBmaWx0ZXIsIGRpc3RpbmN0VW50aWxDaGFuZ2VkLCB0YXAsIGNhdGNoRXJyb3IgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBUcmFuc2FjdGlvbnNMaXN0IH0gZnJvbSAnLi4vbW9kZWwvdHJhbnNhY3Rpb25zLWxpc3QubW9kZWwnO1xuaW1wb3J0IHsgVHJhbnNhY3Rpb25zU2VhcmNoT3B0aW9ucyB9IGZyb20gJy4uL21vZGVsL3RyYW5zYWN0aW9ucy1zZWFyY2gtb3B0aW9ucy5tb2RlbCc7XG5pbXBvcnQgeyBUcmFuc2FjdGlvbnNGaWx0ZXJPcHRpb25zIH0gZnJvbSAnLi4vbW9kZWwvdHJhbnNhY3Rpb25zLWZpbHRlci1vcHRpb25zLm1vZGVsJztcbmltcG9ydCB7IFRyYW5zYWN0aW9uc1NvcnRPcHRpb25zIH0gZnJvbSAnLi4vbW9kZWwvdHJhbnNhY3Rpb25zLXNvcnQtb3B0aW9ucy5tb2RlbCc7XG5pbXBvcnQgeyBBY2NvdW50IH0gZnJvbSAnLi4vbW9kZWwvYWNjb3VudC5tb2RlbCc7XG5pbXBvcnQge1xuICBkZWVwRXF1YWwsXG4gIGNhY2hlUmVxdWVzdCxcbiAgbXVsdGlwbGVBY2NvdW50c1ByZWRpY2F0ZSxcbiAgb25Mb2FkVHJhbnNhY3Rpb25zLFxufSBmcm9tICcuLi9tb2RlbC90cmFuc2FjdGlvbnMtbGlzdC11dGlscy5tb2RlbCc7XG5pbXBvcnQgeyBMb2FkaW5nU3RhdGUgfSBmcm9tICcuL3RyYW5zYWN0aW9ucy5zZXJ2aWNlJztcbmltcG9ydCB7IEVuZHBvaW50VHlwZSB9IGZyb20gJy4vd2lkZ2V0LXByb3BlcnRpZXMuc2VydmljZSc7XG5pbXBvcnQgeyBIdHRwUmVzcG9uc2UgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQgeyBEZXByZWNhdGlvbnNTZXJ2aWNlIH0gZnJvbSAnQGJhY2tiYXNlL2ZvdW5kYXRpb24tYW5nL2NvcmUnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgUGVuZGluZ1RyYW5zYWN0aW9uc1NlcnZpY2UgaW1wbGVtZW50cyBPbkRlc3Ryb3kge1xuICBwcml2YXRlIHJlYWRvbmx5IGluaXRpYWxMaXN0T3B0aW9ucyA9IG5ldyBSZXBsYXlTdWJqZWN0PFBhcnRpYWw8VHJhbnNhY3Rpb25zTGlzdE9wdGlvbnM+PigxKTtcbiAgcHJpdmF0ZSByZWFkb25seSBzZWxlY3RlZEFjY291bnQgPSBuZXcgUmVwbGF5U3ViamVjdDxzdHJpbmdbXT4oMSk7XG4gIHByaXZhdGUgcmVhZG9ubHkgb3B0aW9ucyA9IG5ldyBCZWhhdmlvclN1YmplY3Q8UGFydGlhbDxUcmFuc2FjdGlvbnNMaXN0T3B0aW9ucz4+KHt9KTtcbiAgcHJpdmF0ZSByZWFkb25seSBsaXN0T3B0aW9ucyA9IG5ldyBCZWhhdmlvclN1YmplY3Q8VHJhbnNhY3Rpb25zTGlzdE9wdGlvbnM+KGRlZmF1bHRJbml0aWFsTGlzdE9wdGlvbnMpO1xuICBwcml2YXRlIHJlYWRvbmx5IGxpc3RSZWZyZXNoID0gbmV3IFN1YmplY3Q8VHJhbnNhY3Rpb25zTGlzdE9wdGlvbnM+KCk7XG4gIHByaXZhdGUgcmVhZG9ubHkgZ2V0T3JQb3N0RW5kcG9pbnQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PEVuZHBvaW50VHlwZT4oRW5kcG9pbnRUeXBlLkdFVF9SRVFVRVNUKTtcbiAgcHJpdmF0ZSByZWFkb25seSB0cmFuc2FjdGlvbnNMaXN0OiBPYnNlcnZhYmxlPFRyYW5zYWN0aW9uc0xpc3Q+ID0gbWVyZ2UoXG4gICAgdGhpcy5saXN0T3B0aW9ucy5waXBlKFxuICAgICAgZmlsdGVyKChsaXN0T3B0aW9ucykgPT4gdHlwZW9mIGxpc3RPcHRpb25zLmFjY291bnQuYXJyYW5nZW1lbnRJZCAhPT0gJ3VuZGVmaW5lZCcpLFxuICAgICAgZGlzdGluY3RVbnRpbENoYW5nZWQoZGVlcEVxdWFsKSxcbiAgICApLFxuICAgIHRoaXMubGlzdFJlZnJlc2gsXG4gICkucGlwZShcbiAgICBjYWNoZVJlcXVlc3QoKGxpc3RPcHRpb25zKSA9PiB7XG4gICAgICB0aGlzLmxvYWRpbmdTdGF0ZS5uZXh0KFxuICAgICAgICBsaXN0T3B0aW9ucy5vbkxvYWQgPT09IE9uTG9hZEFjdGlvbi5BcHBlbmRcbiAgICAgICAgICA/IExvYWRpbmdTdGF0ZS5Mb2FkaW5nTW9yZVxuICAgICAgICAgIDogbGlzdE9wdGlvbnMub25Mb2FkID09PSBPbkxvYWRBY3Rpb24uUmVwbGFjZVBhZ2VcbiAgICAgICAgICA/IExvYWRpbmdTdGF0ZS5Mb2FkaW5nUGFnZVxuICAgICAgICAgIDogTG9hZGluZ1N0YXRlLkxvYWRpbmcsXG4gICAgICApO1xuXG4gICAgICByZXR1cm4gY29tYmluZUxhdGVzdChbXG4gICAgICAgIHRoaXMubG9hZFRyYW5zYWN0aW9ucyhsaXN0T3B0aW9ucykucGlwZShcbiAgICAgICAgICB0YXAoKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5sb2FkaW5nU3RhdGUubmV4dChMb2FkaW5nU3RhdGUuTG9hZGVkKTtcbiAgICAgICAgICB9KSxcbiAgICAgICAgICBtYXAoKHRyYW5zYWN0aW9uc0xpc3QpID0+ICh7IHRyYW5zYWN0aW9uc0xpc3QsIG9uTG9hZDogT25Mb2FkQWN0aW9uLlJlcGxhY2VQYWdlIH0pKSxcbiAgICAgICAgKSxcbiAgICAgICAgaWlmKFxuICAgICAgICAgIG11bHRpcGxlQWNjb3VudHNQcmVkaWNhdGUobGlzdE9wdGlvbnMpLFxuICAgICAgICAgIHRoaXMuYWNjb3VudFNlcnZpY2UuZ2V0QWxsQXJyYW5nZW1lbnRzKCkucGlwZShcbiAgICAgICAgICAgIG1hcCgoYWNjb3VudHMpID0+IHtcbiAgICAgICAgICAgICAgY29uc3QgYWNjb3VudE1hcCA9IG5ldyBNYXA8c3RyaW5nLCBBY2NvdW50PigpO1xuICAgICAgICAgICAgICBhY2NvdW50cy5mb3JFYWNoKChhY2NvdW50KSA9PiB7XG4gICAgICAgICAgICAgICAgYWNjb3VudE1hcC5zZXQoYWNjb3VudC5pZCwgYWNjb3VudCk7XG4gICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgIHJldHVybiBhY2NvdW50TWFwO1xuICAgICAgICAgICAgfSksXG4gICAgICAgICAgKSxcbiAgICAgICAgICBvZihuZXcgTWFwKCkpLFxuICAgICAgICApLFxuICAgICAgXSkucGlwZShcbiAgICAgICAgbWFwKChbdHJhbnNhY3Rpb25zLCBhY2NvdW50TWFwXSkgPT4ge1xuICAgICAgICAgIHRyYW5zYWN0aW9ucy50cmFuc2FjdGlvbnNMaXN0Lml0ZW1zID0gdHJhbnNhY3Rpb25zLnRyYW5zYWN0aW9uc0xpc3QuaXRlbXMubWFwKCh0cmFuc2FjdGlvbikgPT4gKHtcbiAgICAgICAgICAgIC4uLnRyYW5zYWN0aW9uLFxuICAgICAgICAgICAgYWNjb3VudDogYWNjb3VudE1hcC5nZXQodHJhbnNhY3Rpb24uYXJyYW5nZW1lbnRJZCB8fCAnJyksXG4gICAgICAgICAgfSkpO1xuXG4gICAgICAgICAgcmV0dXJuIHRyYW5zYWN0aW9ucztcbiAgICAgICAgfSksXG4gICAgICApO1xuICAgIH0pLFxuICAgIHNjYW4ob25Mb2FkVHJhbnNhY3Rpb25zLCB7IGl0ZW1zOiBbXSwgdG90YWxDb3VudDogMCB9KSxcbiAgKTtcblxuICBwdWJsaWMgcmVhZG9ubHkgbG9hZGluZ1N0YXRlID0gbmV3IEJlaGF2aW9yU3ViamVjdDxMb2FkaW5nU3RhdGU+KExvYWRpbmdTdGF0ZS5Ob3RMb2FkZWQpO1xuXG4gIHB1YmxpYyByZWFkb25seSBpc0ZpbHRlckFwcGxpZWQgPSB0aGlzLmxpc3RPcHRpb25zLnBpcGUoXG4gICAgbWFwKChvcHRpb25zKSA9PiAhVHJhbnNhY3Rpb25zRmlsdGVyT3B0aW9ucy5pc0VtcHR5KG9wdGlvbnMuZmlsdGVyIHx8IHt9KSksXG4gICk7XG5cbiAgcHVibGljIHJlYWRvbmx5IGlzU2VhcmNoQXBwbGllZCA9IHRoaXMubGlzdE9wdGlvbnMucGlwZShcbiAgICBtYXAoKG9wdGlvbnMpID0+ICFUcmFuc2FjdGlvbnNGaWx0ZXJPcHRpb25zLmlzRW1wdHkob3B0aW9ucy5zZWFyY2ggfHwge30pKSxcbiAgKTtcblxuICBwcml2YXRlIGxvYWRUcmFuc2FjdGlvbnMobGlzdE9wdGlvbnM6IFRyYW5zYWN0aW9uc0xpc3RPcHRpb25zKTogT2JzZXJ2YWJsZTxUcmFuc2FjdGlvbnNMaXN0PiB7XG4gICAgY29uc3QgdHJhbnNhY3Rpb25QYXlsb2FkID0gVHJhbnNhY3Rpb25zTGlzdC50b0h0dHBSZXF1ZXN0KGxpc3RPcHRpb25zKTtcbiAgICBsZXQgdHJhbnNhY3Rpb25zUmVzcG9uc2U6IE9ic2VydmFibGU8SHR0cFJlc3BvbnNlPEFycmF5PFRyYW5zYWN0aW9uSXRlbT4+PiB8IHVuZGVmaW5lZDtcblxuICAgIGlmICh0aGlzLmlzVXNpbmdQb3N0RW5kcG9pbnRzKSB7XG4gICAgICB0cmFuc2FjdGlvbnNSZXNwb25zZSA9IHRoaXMudHJhbnNhY3Rpb25zRGF0YUh0dHBTZXJ2aWNlLmdldFRyYW5zYWN0aW9uc1dpdGhQb3N0KFxuICAgICAgICB7IHRyYW5zYWN0aW9uTGlzdFJlcXVlc3Q6IHRyYW5zYWN0aW9uUGF5bG9hZCB9IGFzIEdldFRyYW5zYWN0aW9uc1dpdGhQb3N0UmVxdWVzdFBhcmFtcyxcbiAgICAgICAgJ3Jlc3BvbnNlJyxcbiAgICAgICk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuZGVwcmVjYXRpb25zU2VydmljZS5sb2dEZXByZWNhdGVkRmVhdHVyZShcbiAgICAgICAgJ1tQZW5kaW5nVHJhbnNhY3Rpb25zU2VydmljZTogbG9hZFRyYW5zYWN0aW9uc10gR0VUIGVuZHBvaW50cyBhcmUgZGVwcmVjYXRlZC4gUGxlYXNlIHVzZSBQT1NUIGVuZHBvaW50cyBieSBjaGFuZ2luZyBDWFAgY29uZmlndXJhdGlvbicsXG4gICAgICApO1xuICAgICAgdHJhbnNhY3Rpb25zUmVzcG9uc2UgPSB0aGlzLnRyYW5zYWN0aW9uc0RhdGFIdHRwU2VydmljZS5nZXRUcmFuc2FjdGlvbnModHJhbnNhY3Rpb25QYXlsb2FkLCAncmVzcG9uc2UnKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdHJhbnNhY3Rpb25zUmVzcG9uc2UucGlwZShcbiAgICAgIG1hcChUcmFuc2FjdGlvbnNMaXN0LmZyb21IdHRwUmVzcG9uc2UpLFxuICAgICAgY2F0Y2hFcnJvcigoZXJyKSA9PlxuICAgICAgICBvZih7XG4gICAgICAgICAgaXRlbXM6IFtdLFxuICAgICAgICAgIHRvdGFsQ291bnQ6IDAsXG4gICAgICAgICAgaHR0cFJlc3BvbnNlRXJyb3I6IGVycixcbiAgICAgICAgfSksXG4gICAgICApLFxuICAgICk7XG4gIH1cblxuICBnZXRUcmFuc2FjdGlvbnNGcm9tKFxuICAgIHNlbGVjdGVkQWNjb3VudDogT2JzZXJ2YWJsZTxzdHJpbmdbXT4sXG4gICAgaW5pdGlhbExpc3RPcHRpb25zOiBPYnNlcnZhYmxlPFBhcnRpYWw8VHJhbnNhY3Rpb25zTGlzdE9wdGlvbnM+PiA9IG9mKHt9KSxcbiAgICBnZXRPclBvc3RFbmRwb2ludDogT2JzZXJ2YWJsZTxFbmRwb2ludFR5cGU+ID0gb2YoRW5kcG9pbnRUeXBlLkdFVF9SRVFVRVNUKSxcbiAgKSB7XG4gICAgc2VsZWN0ZWRBY2NvdW50LnN1YnNjcmliZSh0aGlzLnNlbGVjdGVkQWNjb3VudCk7XG4gICAgaW5pdGlhbExpc3RPcHRpb25zLnN1YnNjcmliZSh0aGlzLmluaXRpYWxMaXN0T3B0aW9ucyk7XG4gICAgZ2V0T3JQb3N0RW5kcG9pbnQuc3Vic2NyaWJlKHRoaXMuZ2V0T3JQb3N0RW5kcG9pbnQpO1xuICB9XG5cbiAgZ2V0VHJhbnNhY3Rpb25zTGlzdCgpIHtcbiAgICByZXR1cm4gdGhpcy50cmFuc2FjdGlvbnNMaXN0O1xuICB9XG5cbiAgc2VhcmNoKHF1ZXJ5OiBzdHJpbmcpIHtcbiAgICBjb25zdCBzZWFyY2hPcHRpb25zOiBUcmFuc2FjdGlvbnNTZWFyY2hPcHRpb25zID0ge1xuICAgICAgcXVlcnksXG4gICAgfTtcblxuICAgIGNvbnN0IHBhZ2luYXRpb25PcHRpb25zID0ge1xuICAgICAgLi4uKHRoaXMub3B0aW9ucy5nZXRWYWx1ZSgpLnBhZ2luYXRpb24gfHwgZGVmYXVsdFBhZ2luYXRpb25PcHRpb25zLnBhZ2luYXRpb24pLFxuICAgICAgZnJvbTogMCwgLy8gcmVzZXQgdG8gMFxuICAgIH07XG5cbiAgICB0aGlzLm9wdGlvbnMubmV4dCh7XG4gICAgICAuLi50aGlzLm9wdGlvbnMuZ2V0VmFsdWUoKSxcbiAgICAgIC4uLmRlZmF1bHRTZWFyY2hPcHRpb25zLFxuICAgICAgcGFnaW5hdGlvbjogcGFnaW5hdGlvbk9wdGlvbnMsXG4gICAgICBzZWFyY2g6IHNlYXJjaE9wdGlvbnMsXG4gICAgfSk7XG4gIH1cblxuICBjbGVhclNlYXJjaCgpIHtcbiAgICBjb25zdCBwYWdpbmF0aW9uT3B0aW9ucyA9IHtcbiAgICAgIC4uLih0aGlzLm9wdGlvbnMuZ2V0VmFsdWUoKS5wYWdpbmF0aW9uIHx8IGRlZmF1bHRQYWdpbmF0aW9uT3B0aW9ucy5wYWdpbmF0aW9uKSxcbiAgICAgIGZyb206IDAsIC8vIHJlc2V0IHRvIDBcbiAgICB9O1xuXG4gICAgdGhpcy5vcHRpb25zLm5leHQoe1xuICAgICAgLi4udGhpcy5vcHRpb25zLmdldFZhbHVlKCksXG4gICAgICAuLi5kZWZhdWx0U2VhcmNoT3B0aW9ucyxcbiAgICAgIHBhZ2luYXRpb246IHBhZ2luYXRpb25PcHRpb25zLFxuICAgIH0pO1xuICB9XG5cbiAgZmlsdGVyKGZpbHRlck9wdGlvbnM6IFRyYW5zYWN0aW9uc0ZpbHRlck9wdGlvbnMpIHtcbiAgICBjb25zdCBwYWdpbmF0aW9uT3B0aW9ucyA9IHtcbiAgICAgIC4uLih0aGlzLm9wdGlvbnMuZ2V0VmFsdWUoKS5wYWdpbmF0aW9uIHx8IGRlZmF1bHRQYWdpbmF0aW9uT3B0aW9ucy5wYWdpbmF0aW9uKSxcbiAgICAgIGZyb206IDAsIC8vIHJlc2V0IHRvIDBcbiAgICB9O1xuXG4gICAgdGhpcy5vcHRpb25zLm5leHQoe1xuICAgICAgLi4udGhpcy5vcHRpb25zLmdldFZhbHVlKCksXG4gICAgICAuLi5kZWZhdWx0RmlsdGVyT3B0aW9ucyxcbiAgICAgIHBhZ2luYXRpb246IHBhZ2luYXRpb25PcHRpb25zLFxuICAgICAgZmlsdGVyOiB7IC4uLmZpbHRlck9wdGlvbnMgfSxcbiAgICB9KTtcbiAgfVxuXG4gIGNsZWFyRmlsdGVyKCkge1xuICAgIGNvbnN0IHBhZ2luYXRpb25PcHRpb25zID0ge1xuICAgICAgLi4uKHRoaXMub3B0aW9ucy5nZXRWYWx1ZSgpLnBhZ2luYXRpb24gfHwgZGVmYXVsdFBhZ2luYXRpb25PcHRpb25zLnBhZ2luYXRpb24pLFxuICAgICAgZnJvbTogMCwgLy8gcmVzZXQgdG8gMFxuICAgIH07XG5cbiAgICB0aGlzLm9wdGlvbnMubmV4dCh7XG4gICAgICAuLi50aGlzLm9wdGlvbnMuZ2V0VmFsdWUoKSxcbiAgICAgIC4uLmRlZmF1bHRGaWx0ZXJPcHRpb25zLFxuICAgICAgcGFnaW5hdGlvbjogcGFnaW5hdGlvbk9wdGlvbnMsXG4gICAgfSk7XG4gIH1cblxuICBzb3J0KHNvcnRPcHRpb25zOiBUcmFuc2FjdGlvbnNTb3J0T3B0aW9ucykge1xuICAgIGNvbnN0IGN1cnJlbnRQYWdpbmF0aW9uT3B0aW9ucyA9IHRoaXMub3B0aW9ucy5nZXRWYWx1ZSgpLnBhZ2luYXRpb24gfHwgZGVmYXVsdFBhZ2luYXRpb25PcHRpb25zLnBhZ2luYXRpb247XG4gICAgdGhpcy5vcHRpb25zLm5leHQoe1xuICAgICAgc29ydDogeyAuLi5zb3J0T3B0aW9ucyB9LFxuICAgICAgcGFnaW5hdGlvbjoge1xuICAgICAgICAuLi5jdXJyZW50UGFnaW5hdGlvbk9wdGlvbnMsXG4gICAgICAgIGZyb206IDAsXG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgcmV0cnlGaWx0ZXJpbmcoKSB7XG4gICAgdGhpcy5saXN0UmVmcmVzaC5uZXh0KHRoaXMubGlzdE9wdGlvbnMuZ2V0VmFsdWUoKSk7XG4gIH1cblxuICByZWZyZXNoVHJhbnNhY3Rpb25zKCkge1xuICAgIGNvbnN0IGN1cnJlbnRQYWdpbmF0aW9uT3B0aW9ucyA9IHRoaXMub3B0aW9ucy5nZXRWYWx1ZSgpLnBhZ2luYXRpb24gfHwgZGVmYXVsdFBhZ2luYXRpb25PcHRpb25zLnBhZ2luYXRpb247XG4gICAgY29uc3QgcGFnaW5hdGlvbk9wdGlvbnMgPSB7XG4gICAgICAuLi5jdXJyZW50UGFnaW5hdGlvbk9wdGlvbnMsXG4gICAgICBmcm9tOiAwLFxuICAgIH07XG5cbiAgICBjb25zdCBuZXdPcHRpb25zID0ge1xuICAgICAgLi4udGhpcy5saXN0T3B0aW9ucy5nZXRWYWx1ZSgpLFxuICAgICAgcGFnaW5hdGlvbjogcGFnaW5hdGlvbk9wdGlvbnMsXG4gICAgfTtcblxuICAgIGlmIChkZWVwRXF1YWwobmV3T3B0aW9ucywgdGhpcy5saXN0T3B0aW9ucy5nZXRWYWx1ZSgpKSkge1xuICAgICAgdGhpcy5saXN0UmVmcmVzaC5uZXh0KHRoaXMubGlzdE9wdGlvbnMuZ2V0VmFsdWUoKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMub3B0aW9ucy5uZXh0KHtcbiAgICAgICAgcGFnaW5hdGlvbjogcGFnaW5hdGlvbk9wdGlvbnMsXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGdldCBpc1VzaW5nUG9zdEVuZHBvaW50cygpIHtcbiAgICByZXR1cm4gdGhpcy5nZXRPclBvc3RFbmRwb2ludC5nZXRWYWx1ZSgpID09PSBFbmRwb2ludFR5cGUuUE9TVF9SRVFVRVNUO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgdGhpcy5saXN0UmVmcmVzaC5jb21wbGV0ZSgpO1xuICAgIHRoaXMuc2VsZWN0ZWRBY2NvdW50LmNvbXBsZXRlKCk7XG4gICAgdGhpcy5pbml0aWFsTGlzdE9wdGlvbnMuY29tcGxldGUoKTtcbiAgICB0aGlzLm9wdGlvbnMuY29tcGxldGUoKTtcbiAgICB0aGlzLmxpc3RPcHRpb25zLmNvbXBsZXRlKCk7XG4gICAgdGhpcy5sb2FkaW5nU3RhdGUuY29tcGxldGUoKTtcbiAgICB0aGlzLmdldE9yUG9zdEVuZHBvaW50LmNvbXBsZXRlKCk7XG4gIH1cblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IHRyYW5zYWN0aW9uc0RhdGFIdHRwU2VydmljZTogVHJhbnNhY3Rpb25DbGllbnRIdHRwU2VydmljZSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGFjY291bnRTZXJ2aWNlOiBBY2NvdW50c1NlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSBkZXByZWNhdGlvbnNTZXJ2aWNlOiBEZXByZWNhdGlvbnNTZXJ2aWNlLFxuICApIHtcbiAgICBjb21iaW5lTGF0ZXN0KFt0aGlzLnNlbGVjdGVkQWNjb3VudCwgdGhpcy5pbml0aWFsTGlzdE9wdGlvbnNdKVxuICAgICAgLnBpcGUoXG4gICAgICAgIG1hcCgoW3NlbGVjdGVkQWNjb3VudCwgaW5pdGlhbExpc3RPcHRpb25zXSkgPT4gKHtcbiAgICAgICAgICBhY2NvdW50OiB7XG4gICAgICAgICAgICBhcnJhbmdlbWVudElkOiBzZWxlY3RlZEFjY291bnQsXG4gICAgICAgICAgfSxcbiAgICAgICAgICBwYWdpbmF0aW9uOiB7XG4gICAgICAgICAgICBmcm9tOiAwLFxuICAgICAgICAgICAgc2l6ZTogMjUwLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgc3RhdGU6IFRyYW5zYWN0aW9uU3RhdGUudW5jb21wbGV0ZWQsXG4gICAgICAgICAgLi4uaW5pdGlhbExpc3RPcHRpb25zLFxuICAgICAgICB9KSksXG4gICAgICApXG4gICAgICAuc3Vic2NyaWJlKHRoaXMub3B0aW9ucyk7XG5cbiAgICAvLyBCYXNlIHRoaXMubGlzdE9wdGlvbnMgb24gdGhpcy5vcHRpb25zXG4gICAgdGhpcy5vcHRpb25zXG4gICAgICAucGlwZShzY2FuKChhY2M6IGFueSwgY3VycikgPT4gT2JqZWN0LmFzc2lnbih7fSwgYWNjLCBjdXJyKSwgZGVmYXVsdEluaXRpYWxMaXN0T3B0aW9ucykpXG4gICAgICAuc3Vic2NyaWJlKHRoaXMubGlzdE9wdGlvbnMpO1xuICB9XG59XG4iXX0=