import { Injectable } from '@angular/core';
import { Subject, of, ReplaySubject, combineLatest, from } from 'rxjs';
import { TransactionsCheckImages } from '../model/transactions-check-images.model';
import { switchMap, map, tap, scan, catchError, filter, mergeMap } from 'rxjs/operators';
import { TransactionsDetailsLoadingState } from '../model/transactions-details.model';
import { HttpResponse } from '@angular/common/http';
import { CheckImagesAvailability, daysDiff } from '../constants';
import * as i0 from "@angular/core";
import * as i1 from "@backbase/data-ang/transactions";
import * as i2 from "./map-api-loader.service";
import * as i3 from "./payments-batch.service";
class ConfigManager {
    constructor(config) {
        this.config = config;
    }
    isDisputable(transaction) {
        return (this.isBillingStatusApproved(transaction) && !this.isOld(transaction) && this.isOfRestrictedType(transaction));
    }
    isBillingStatusApproved(transaction) {
        var _a;
        if (!((_a = this.config) === null || _a === void 0 ? void 0 : _a.byBillingStatus)) {
            return true;
        }
        return !(transaction === null || transaction === void 0 ? void 0 : transaction.isPending);
    }
    isOld(transaction) {
        var _a;
        if (!(transaction === null || transaction === void 0 ? void 0 : transaction.bookingDate)) {
            return false;
        }
        const days = daysDiff(new Date(), transaction.bookingDate);
        const byEligitibilityDays = ((_a = this.config) === null || _a === void 0 ? void 0 : _a.byEligitibilityDays) || 0;
        return days > byEligitibilityDays;
    }
    isOfRestrictedType(transaction) {
        var _a;
        return (transaction === null || transaction === void 0 ? void 0 : transaction.type) ? (((_a = this.config) === null || _a === void 0 ? void 0 : _a.byTransactionTypes) || []).includes(transaction.type) : false;
    }
}
export class TransactionDetailsService {
    constructor(transactionsDataHttpService, mapApiLoader, paymentsBatchService) {
        this.transactionsDataHttpService = transactionsDataHttpService;
        this.mapApiLoader = mapApiLoader;
        this.paymentsBatchService = paymentsBatchService;
        /**
         * watches the transaction that is shown in the details
         */
        this.transactionSelection = new Subject();
        /**
         * watches the configuration from CXP that can disable/enable check images
         */
        this.hasCheckImages = new ReplaySubject();
        /**
         * general status of each feature that runs asynchronously
         */
        this.transactionsDetailsStatus = new ReplaySubject();
        this.mapsApiKey = new ReplaySubject();
        this.batchOrder = this.transactionSelection.pipe(tap(() => {
            this.transactionsDetailsStatus.next({
                batchOrder: TransactionsDetailsLoadingState.loading,
            });
        }), mergeMap((transaction) => {
            if (!transaction.batchOrderId) {
                return of(undefined);
            }
            return this.paymentsBatchService.getBatch(transaction.batchOrderId).pipe(catchError(() => {
                this.transactionsDetailsStatus.next({
                    batchOrder: TransactionsDetailsLoadingState.error,
                });
                return of(undefined);
            }));
        }), map((data) => {
            this.transactionsDetailsStatus.next({
                batchOrder: data ? TransactionsDetailsLoadingState.done : TransactionsDetailsLoadingState.notStarted,
            });
            return data;
        }));
        this.transactionsDetailsStatus.next({
            checkImages: TransactionsDetailsLoadingState.notStarted,
            geolocation: TransactionsDetailsLoadingState.notStarted,
            enableDisputeAndInquiry: TransactionsDetailsLoadingState.notStarted,
            disputeOption: TransactionsDetailsLoadingState.notStarted,
            batchOrder: TransactionsDetailsLoadingState.notStarted,
        });
    }
    set enableDisputeAndInquiry(value) {
        this.transactionsDetailsStatus.next({
            enableDisputeAndInquiry: value ? TransactionsDetailsLoadingState.done : TransactionsDetailsLoadingState.notLoaded,
        });
    }
    fromInquiryAndDispute(enableDisputeAndInquiry, disputeByBillingStatus, disputeEligibilityDays, disputeTransactionTypes) {
        const config = combineLatest([
            enableDisputeAndInquiry,
            disputeByBillingStatus,
            disputeEligibilityDays,
            disputeTransactionTypes,
        ]).pipe(map(([enabled, byBillingStatus, byEligitibilityDays, byTransactionTypes]) => enabled ? { byBillingStatus, byEligitibilityDays, byTransactionTypes } : undefined));
        combineLatest([this.transactionSelection, config]).subscribe({
            next: ([transactionSelection, inquiryAndDispute]) => {
                if (!inquiryAndDispute) {
                    this.transactionsDetailsStatus.next({
                        enableDisputeAndInquiry: TransactionsDetailsLoadingState.notLoaded,
                        disputeOption: TransactionsDetailsLoadingState.notLoaded,
                    });
                }
                else {
                    const configuration = new ConfigManager(inquiryAndDispute);
                    this.transactionsDetailsStatus.next({
                        enableDisputeAndInquiry: TransactionsDetailsLoadingState.done,
                        disputeOption: configuration.isDisputable(transactionSelection)
                            ? TransactionsDetailsLoadingState.done
                            : TransactionsDetailsLoadingState.notLoaded,
                    });
                }
            },
        });
    }
    /**
     *
     * @param transactionId
     * triggers a new action that will cause transcations details reload and change an image
     */
    selectTransaction(transaction) {
        this.transactionSelection.next(transaction);
    }
    /**
     * Key-value pair that controls the loading status in transactions details
     */
    get loadingState() {
        return this.transactionsDetailsStatus.pipe(scan((acc, curr) => (Object.assign(Object.assign({}, acc), curr)), {}));
    }
    /**
     *
     * @param hasCheckImages
     * Configuration for check images reactive functionality
     */
    fromCheckImages(hasCheckImages) {
        hasCheckImages.subscribe(this.hasCheckImages);
        hasCheckImages
            .pipe(map((value) => ({
            checkImages: value ? TransactionsDetailsLoadingState.loading : TransactionsDetailsLoadingState.notLoaded,
        })))
            .subscribe({
            next: (value) => {
                this.transactionsDetailsStatus.next(value);
            },
        });
        return this.setCondition(this.transactionSelection, this.hasCheckImages).pipe(tap(() => {
            this.transactionsDetailsStatus.next({ checkImages: TransactionsDetailsLoadingState.loading });
        }), filter((transaction) => transaction.checkImageAvailability === CheckImagesAvailability.available), switchMap(({ id: transactionId = '' }) => this.transactionsDataHttpService.getTransactionCheckImages({ transactionId }, 'response').pipe(tap(() => {
            this.transactionsDetailsStatus.next({ checkImages: TransactionsDetailsLoadingState.done });
        }), catchError((error) => {
            switch (error.status) {
                case 500: {
                    this.transactionsDetailsStatus.next({ checkImages: TransactionsDetailsLoadingState.serverError });
                    break;
                }
                case 400: {
                    this.transactionsDetailsStatus.next({ checkImages: TransactionsDetailsLoadingState.badRequestError });
                    break;
                }
                case 404: {
                    this.transactionsDetailsStatus.next({ checkImages: TransactionsDetailsLoadingState.notFoundError });
                    break;
                }
                default: {
                    this.transactionsDetailsStatus.next({ checkImages: TransactionsDetailsLoadingState.error });
                }
            }
            return of(new HttpResponse({
                body: {
                    images: [],
                },
            }));
        }), map(TransactionsCheckImages.fromHttpResponse))));
    }
    fromGeolocation(mapsApiKey) {
        mapsApiKey.subscribe(this.mapsApiKey);
        return combineLatest([this.transactionSelection, this.mapsApiKey]).pipe(map(([transaction, apiKey]) => {
            this.mapApiLoader.config = {
                apiKey,
                libraries: ['geometry'],
            };
            this.transactionsDetailsStatus.next({ geolocation: TransactionsDetailsLoadingState.loading });
            if (!apiKey || !transaction.location || !transaction.location.latitude || !transaction.location.longitude) {
                this.transactionsDetailsStatus.next({ geolocation: TransactionsDetailsLoadingState.notLoaded });
                return Promise.resolve(false);
            }
            return this.mapApiLoader.load().then(() => {
                this.transactionsDetailsStatus.next({ geolocation: TransactionsDetailsLoadingState.done });
                return true;
            }, () => {
                this.transactionsDetailsStatus.next({ geolocation: TransactionsDetailsLoadingState.error });
                return false;
            });
        }), mergeMap((promise) => from(promise)));
    }
    /**
     * destroy lifecycle hook that will release resources
     */
    ngOnDestroy() {
        this.transactionSelection.complete();
        this.transactionsDetailsStatus.complete();
        this.mapsApiKey.complete();
    }
    /**
     *
     * @param feature
     * @param toggle
     *
     * Prevents from emiting values if the cxp configuration is set as disabled
     */
    setCondition(feature, toggle) {
        return combineLatest([feature, toggle]).pipe(filter(([, condition]) => condition), map(([value]) => value));
    }
}
TransactionDetailsService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: TransactionDetailsService, deps: [{ token: i1.TransactionClientHttpService }, { token: i2.MapAPILoaderService }, { token: i3.PaymentsBatchService }], target: i0.ɵɵFactoryTarget.Injectable });
TransactionDetailsService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: TransactionDetailsService });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: TransactionDetailsService, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.TransactionClientHttpService }, { type: i2.MapAPILoaderService }, { type: i3.PaymentsBatchService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhbnNhY3Rpb24tZGV0YWlscy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vbGlicy90cmFuc2FjdGlvbnMtY29tbW9uLWFuZy9zcmMvc2VydmljZXMvdHJhbnNhY3Rpb24tZGV0YWlscy5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQWEsTUFBTSxlQUFlLENBQUM7QUFFdEQsT0FBTyxFQUFFLE9BQU8sRUFBYyxFQUFFLEVBQUUsYUFBYSxFQUFFLGFBQWEsRUFBRSxJQUFJLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDbkYsT0FBTyxFQUFpQyx1QkFBdUIsRUFBRSxNQUFNLDBDQUEwQyxDQUFDO0FBQ2xILE9BQU8sRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN6RixPQUFPLEVBQUUsK0JBQStCLEVBQThCLE1BQU0scUNBQXFDLENBQUM7QUFDbEgsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBRXBELE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxRQUFRLEVBQUUsTUFBTSxjQUFjLENBQUM7Ozs7O0FBTWpFLE1BQU0sYUFBYTtJQUNqQixZQUFvQixNQUF1QztRQUF2QyxXQUFNLEdBQU4sTUFBTSxDQUFpQztJQUFHLENBQUM7SUFFL0QsWUFBWSxDQUFDLFdBQXdCO1FBQ25DLE9BQU8sQ0FDTCxJQUFJLENBQUMsdUJBQXVCLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxJQUFJLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxXQUFXLENBQUMsQ0FDOUcsQ0FBQztJQUNKLENBQUM7SUFFTyx1QkFBdUIsQ0FBQyxXQUF3Qjs7UUFDdEQsSUFBSSxDQUFDLENBQUEsTUFB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LENBQUM7UUFDMUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxRQUFRLEVBQUUsQ0FBQztJQUM3QixDQUFDO0lBRUQ7Ozs7OztPQU1HO0lBQ0ssWUFBWSxDQUFJLE9BQXNCLEVBQUUsTUFBOEI7UUFDNUUsT0FBTyxhQUFhLENBQUMsQ0FBQyxPQUFPLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQzFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxTQUFTLENBQUMsRUFBRSxFQUFFLENBQUMsU0FBUyxDQUFDLEVBQ3BDLEdBQUcsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEVBQUUsRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUN4QixDQUFDO0lBQ0osQ0FBQzs7dUhBaE9VLHlCQUF5QjsySEFBekIseUJBQXlCOzRGQUF6Qix5QkFBeUI7a0JBRHJDLFVBQVUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBPbkRlc3Ryb3kgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFRyYW5zYWN0aW9uQ2xpZW50SHR0cFNlcnZpY2UgfSBmcm9tICdAYmFja2Jhc2UvZGF0YS1hbmcvdHJhbnNhY3Rpb25zJztcbmltcG9ydCB7IFN1YmplY3QsIE9ic2VydmFibGUsIG9mLCBSZXBsYXlTdWJqZWN0LCBjb21iaW5lTGF0ZXN0LCBmcm9tIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBUcmFuc2FjdGlvbkNoZWNrSW1hZ2VSZXNwb25zZSwgVHJhbnNhY3Rpb25zQ2hlY2tJbWFnZXMgfSBmcm9tICcuLi9tb2RlbC90cmFuc2FjdGlvbnMtY2hlY2staW1hZ2VzLm1vZGVsJztcbmltcG9ydCB7IHN3aXRjaE1hcCwgbWFwLCB0YXAsIHNjYW4sIGNhdGNoRXJyb3IsIGZpbHRlciwgbWVyZ2VNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBUcmFuc2FjdGlvbnNEZXRhaWxzTG9hZGluZ1N0YXRlLCBUcmFuc2FjdGlvbnNEZXRhaWxzTG9hZGluZyB9IGZyb20gJy4uL21vZGVsL3RyYW5zYWN0aW9ucy1kZXRhaWxzLm1vZGVsJztcbmltcG9ydCB7IEh0dHBSZXNwb25zZSB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7IFRyYW5zYWN0aW9uIH0gZnJvbSAnLi4vbW9kZWwvdHJhbnNhY3Rpb24ubW9kZWwnO1xuaW1wb3J0IHsgQ2hlY2tJbWFnZXNBdmFpbGFiaWxpdHksIGRheXNEaWZmIH0gZnJvbSAnLi4vY29uc3RhbnRzJztcbmltcG9ydCB7IE1hcEFQSUxvYWRlclNlcnZpY2UgfSBmcm9tICcuL21hcC1hcGktbG9hZGVyLnNlcnZpY2UnO1xuaW1wb3J0IHsgTWVzc2FnZXNEaXNwdXRlQW5kSW5xdWlyeUNvbmZpZyB9IGZyb20gJy4uL21vZGVsL21lc3NhZ2VzLm1vZGVsJztcbmltcG9ydCB7IFBheW1lbnRzQmF0Y2hTZXJ2aWNlIH0gZnJvbSAnLi9wYXltZW50cy1iYXRjaC5zZXJ2aWNlJztcbmltcG9ydCB7IEJhdGNoT3JkZXIgfSBmcm9tICcuLi9tb2RlbC9iYXRjaC1vcmRlci5tb2RlbCc7XG5cbmNsYXNzIENvbmZpZ01hbmFnZXIge1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGNvbmZpZzogTWVzc2FnZXNEaXNwdXRlQW5kSW5xdWlyeUNvbmZpZykge31cblxuICBpc0Rpc3B1dGFibGUodHJhbnNhY3Rpb246IFRyYW5zYWN0aW9uKSB7XG4gICAgcmV0dXJuIChcbiAgICAgIHRoaXMuaXNCaWxsaW5nU3RhdHVzQXBwcm92ZWQodHJhbnNhY3Rpb24pICYmICF0aGlzLmlzT2xkKHRyYW5zYWN0aW9uKSAmJiB0aGlzLmlzT2ZSZXN0cmljdGVkVHlwZSh0cmFuc2FjdGlvbilcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBpc0JpbGxpbmdTdGF0dXNBcHByb3ZlZCh0cmFuc2FjdGlvbjogVHJhbnNhY3Rpb24pIHtcbiAgICBpZiAoIXRoaXMuY29uZmlnPy5ieUJpbGxpbmdTdGF0dXMpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIHJldHVybiAhdHJhbnNhY3Rpb24/LmlzUGVuZGluZztcbiAgfVxuXG4gIHByaXZhdGUgaXNPbGQodHJhbnNhY3Rpb246IFRyYW5zYWN0aW9uKSB7XG4gICAgaWYgKCF0cmFuc2FjdGlvbj8uYm9va2luZ0RhdGUpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgY29uc3QgZGF5cyA9IGRheXNEaWZmKG5ldyBEYXRlKCksIHRyYW5zYWN0aW9uLmJvb2tpbmdEYXRlKTtcbiAgICBjb25zdCBieUVsaWdpdGliaWxpdHlEYXlzID0gdGhpcy5jb25maWc/LmJ5RWxpZ2l0aWJpbGl0eURheXMgfHwgMDtcblxuICAgIHJldHVybiBkYXlzID4gYnlFbGlnaXRpYmlsaXR5RGF5cztcbiAgfVxuXG4gIHByaXZhdGUgaXNPZlJlc3RyaWN0ZWRUeXBlKHRyYW5zYWN0aW9uOiBUcmFuc2FjdGlvbikge1xuICAgIHJldHVybiB0cmFuc2FjdGlvbj8udHlwZSA/ICh0aGlzLmNvbmZpZz8uYnlUcmFuc2FjdGlvblR5cGVzIHx8IFtdKS5pbmNsdWRlcyh0cmFuc2FjdGlvbi50eXBlKSA6IGZhbHNlO1xuICB9XG59XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBUcmFuc2FjdGlvbkRldGFpbHNTZXJ2aWNlIGltcGxlbWVudHMgT25EZXN0cm95IHtcbiAgLyoqXG4gICAqIHdhdGNoZXMgdGhlIHRyYW5zYWN0aW9uIHRoYXQgaXMgc2hvd24gaW4gdGhlIGRldGFpbHNcbiAgICovXG4gIHByaXZhdGUgcmVhZG9ubHkgdHJhbnNhY3Rpb25TZWxlY3Rpb24gPSBuZXcgU3ViamVjdDxUcmFuc2FjdGlvbj4oKTtcbiAgLyoqXG4gICAqIHdhdGNoZXMgdGhlIGNvbmZpZ3VyYXRpb24gZnJvbSBDWFAgdGhhdCBjYW4gZGlzYWJsZS9lbmFibGUgY2hlY2sgaW1hZ2VzXG4gICAqL1xuICBwcml2YXRlIHJlYWRvbmx5IGhhc0NoZWNrSW1hZ2VzID0gbmV3IFJlcGxheVN1YmplY3Q8Ym9vbGVhbj4oKTtcbiAgLyoqXG4gICAqIGdlbmVyYWwgc3RhdHVzIG9mIGVhY2ggZmVhdHVyZSB0aGF0IHJ1bnMgYXN5bmNocm9ub3VzbHlcbiAgICovXG4gIHByaXZhdGUgcmVhZG9ubHkgdHJhbnNhY3Rpb25zRGV0YWlsc1N0YXR1cyA9IG5ldyBSZXBsYXlTdWJqZWN0PFRyYW5zYWN0aW9uc0RldGFpbHNMb2FkaW5nPigpO1xuXG4gIHByaXZhdGUgcmVhZG9ubHkgbWFwc0FwaUtleSA9IG5ldyBSZXBsYXlTdWJqZWN0PHN0cmluZz4oKTtcblxuICBzZXQgZW5hYmxlRGlzcHV0ZUFuZElucXVpcnkodmFsdWU6IGJvb2xlYW4pIHtcbiAgICB0aGlzLnRyYW5zYWN0aW9uc0RldGFpbHNTdGF0dXMubmV4dCh7XG4gICAgICBlbmFibGVEaXNwdXRlQW5kSW5xdWlyeTogdmFsdWUgPyBUcmFuc2FjdGlvbnNEZXRhaWxzTG9hZGluZ1N0YXRlLmRvbmUgOiBUcmFuc2FjdGlvbnNEZXRhaWxzTG9hZGluZ1N0YXRlLm5vdExvYWRlZCxcbiAgICB9KTtcbiAgfVxuXG4gIGZyb21JbnF1aXJ5QW5kRGlzcHV0ZShcbiAgICBlbmFibGVEaXNwdXRlQW5kSW5xdWlyeTogT2JzZXJ2YWJsZTxib29sZWFuPixcbiAgICBkaXNwdXRlQnlCaWxsaW5nU3RhdHVzOiBPYnNlcnZhYmxlPGJvb2xlYW4+LFxuICAgIGRpc3B1dGVFbGlnaWJpbGl0eURheXM6IE9ic2VydmFibGU8bnVtYmVyPixcbiAgICBkaXNwdXRlVHJhbnNhY3Rpb25UeXBlczogT2JzZXJ2YWJsZTxBcnJheTxzdHJpbmc+PixcbiAgKSB7XG4gICAgY29uc3QgY29uZmlnID0gY29tYmluZUxhdGVzdChbXG4gICAgICBlbmFibGVEaXNwdXRlQW5kSW5xdWlyeSxcbiAgICAgIGRpc3B1dGVCeUJpbGxpbmdTdGF0dXMsXG4gICAgICBkaXNwdXRlRWxpZ2liaWxpdHlEYXlzLFxuICAgICAgZGlzcHV0ZVRyYW5zYWN0aW9uVHlwZXMsXG4gICAgXSkucGlwZShcbiAgICAgIG1hcCgoW2VuYWJsZWQsIGJ5QmlsbGluZ1N0YXR1cywgYnlFbGlnaXRpYmlsaXR5RGF5cywgYnlUcmFuc2FjdGlvblR5cGVzXSkgPT5cbiAgICAgICAgZW5hYmxlZCA/IHsgYnlCaWxsaW5nU3RhdHVzLCBieUVsaWdpdGliaWxpdHlEYXlzLCBieVRyYW5zYWN0aW9uVHlwZXMgfSA6IHVuZGVmaW5lZCxcbiAgICAgICksXG4gICAgKTtcblxuICAgIGNvbWJpbmVMYXRlc3QoW3RoaXMudHJhbnNhY3Rpb25TZWxlY3Rpb24sIGNvbmZpZ10pLnN1YnNjcmliZSh7XG4gICAgICBuZXh0OiAoW3RyYW5zYWN0aW9uU2VsZWN0aW9uLCBpbnF1aXJ5QW5kRGlzcHV0ZV0pID0+IHtcbiAgICAgICAgaWYgKCFpbnF1aXJ5QW5kRGlzcHV0ZSkge1xuICAgICAgICAgIHRoaXMudHJhbnNhY3Rpb25zRGV0YWlsc1N0YXR1cy5uZXh0KHtcbiAgICAgICAgICAgIGVuYWJsZURpc3B1dGVBbmRJbnF1aXJ5OiBUcmFuc2FjdGlvbnNEZXRhaWxzTG9hZGluZ1N0YXRlLm5vdExvYWRlZCxcbiAgICAgICAgICAgIGRpc3B1dGVPcHRpb246IFRyYW5zYWN0aW9uc0RldGFpbHNMb2FkaW5nU3RhdGUubm90TG9hZGVkLFxuICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbnN0IGNvbmZpZ3VyYXRpb24gPSBuZXcgQ29uZmlnTWFuYWdlcihpbnF1aXJ5QW5kRGlzcHV0ZSk7XG5cbiAgICAgICAgICB0aGlzLnRyYW5zYWN0aW9uc0RldGFpbHNTdGF0dXMubmV4dCh7XG4gICAgICAgICAgICBlbmFibGVEaXNwdXRlQW5kSW5xdWlyeTogVHJhbnNhY3Rpb25zRGV0YWlsc0xvYWRpbmdTdGF0ZS5kb25lLFxuICAgICAgICAgICAgZGlzcHV0ZU9wdGlvbjogY29uZmlndXJhdGlvbi5pc0Rpc3B1dGFibGUodHJhbnNhY3Rpb25TZWxlY3Rpb24pXG4gICAgICAgICAgICAgID8gVHJhbnNhY3Rpb25zRGV0YWlsc0xvYWRpbmdTdGF0ZS5kb25lXG4gICAgICAgICAgICAgIDogVHJhbnNhY3Rpb25zRGV0YWlsc0xvYWRpbmdTdGF0ZS5ub3RMb2FkZWQsXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cbiAgLyoqXG4gICAqXG4gICAqIEBwYXJhbSB0cmFuc2FjdGlvbklkXG4gICAqIHRyaWdnZXJzIGEgbmV3IGFjdGlvbiB0aGF0IHdpbGwgY2F1c2UgdHJhbnNjYXRpb25zIGRldGFpbHMgcmVsb2FkIGFuZCBjaGFuZ2UgYW4gaW1hZ2VcbiAgICovXG4gIHNlbGVjdFRyYW5zYWN0aW9uKHRyYW5zYWN0aW9uOiBUcmFuc2FjdGlvbikge1xuICAgIHRoaXMudHJhbnNhY3Rpb25TZWxlY3Rpb24ubmV4dCh0cmFuc2FjdGlvbik7XG4gIH1cblxuICAvKipcbiAgICogS2V5LXZhbHVlIHBhaXIgdGhhdCBjb250cm9scyB0aGUgbG9hZGluZyBzdGF0dXMgaW4gdHJhbnNhY3Rpb25zIGRldGFpbHNcbiAgICovXG4gIGdldCBsb2FkaW5nU3RhdGUoKTogT2JzZXJ2YWJsZTxUcmFuc2FjdGlvbnNEZXRhaWxzTG9hZGluZz4ge1xuICAgIHJldHVybiB0aGlzLnRyYW5zYWN0aW9uc0RldGFpbHNTdGF0dXMucGlwZShzY2FuKChhY2MsIGN1cnIpID0+ICh7IC4uLmFjYywgLi4uY3VyciB9KSwge30pKTtcbiAgfVxuXG4gIC8qKlxuICAgKlxuICAgKiBAcGFyYW0gaGFzQ2hlY2tJbWFnZXNcbiAgICogQ29uZmlndXJhdGlvbiBmb3IgY2hlY2sgaW1hZ2VzIHJlYWN0aXZlIGZ1bmN0aW9uYWxpdHlcbiAgICovXG4gIGZyb21DaGVja0ltYWdlcyhoYXNDaGVja0ltYWdlczogT2JzZXJ2YWJsZTxib29sZWFuPik6IE9ic2VydmFibGU8VHJhbnNhY3Rpb25DaGVja0ltYWdlUmVzcG9uc2U+IHtcbiAgICBoYXNDaGVja0ltYWdlcy5zdWJzY3JpYmUodGhpcy5oYXNDaGVja0ltYWdlcyk7XG5cbiAgICBoYXNDaGVja0ltYWdlc1xuICAgICAgLnBpcGUoXG4gICAgICAgIG1hcCgodmFsdWUpID0+ICh7XG4gICAgICAgICAgY2hlY2tJbWFnZXM6IHZhbHVlID8gVHJhbnNhY3Rpb25zRGV0YWlsc0xvYWRpbmdTdGF0ZS5sb2FkaW5nIDogVHJhbnNhY3Rpb25zRGV0YWlsc0xvYWRpbmdTdGF0ZS5ub3RMb2FkZWQsXG4gICAgICAgIH0pKSxcbiAgICAgIClcbiAgICAgIC5zdWJzY3JpYmUoe1xuICAgICAgICBuZXh0OiAodmFsdWUpID0+IHtcbiAgICAgICAgICB0aGlzLnRyYW5zYWN0aW9uc0RldGFpbHNTdGF0dXMubmV4dCh2YWx1ZSk7XG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgIHJldHVybiB0aGlzLnNldENvbmRpdGlvbih0aGlzLnRyYW5zYWN0aW9uU2VsZWN0aW9uLCB0aGlzLmhhc0NoZWNrSW1hZ2VzKS5waXBlKFxuICAgICAgdGFwKCgpID0+IHtcbiAgICAgICAgdGhpcy50cmFuc2FjdGlvbnNEZXRhaWxzU3RhdHVzLm5leHQoeyBjaGVja0ltYWdlczogVHJhbnNhY3Rpb25zRGV0YWlsc0xvYWRpbmdTdGF0ZS5sb2FkaW5nIH0pO1xuICAgICAgfSksXG4gICAgICBmaWx0ZXIoKHRyYW5zYWN0aW9uKSA9PiB0cmFuc2FjdGlvbi5jaGVja0ltYWdlQXZhaWxhYmlsaXR5ID09PSBDaGVja0ltYWdlc0F2YWlsYWJpbGl0eS5hdmFpbGFibGUpLFxuICAgICAgc3dpdGNoTWFwKCh7IGlkOiB0cmFuc2FjdGlvbklkID0gJycgfSkgPT5cbiAgICAgICAgdGhpcy50cmFuc2FjdGlvbnNEYXRhSHR0cFNlcnZpY2UuZ2V0VHJhbnNhY3Rpb25DaGVja0ltYWdlcyh7IHRyYW5zYWN0aW9uSWQgfSwgJ3Jlc3BvbnNlJykucGlwZShcbiAgICAgICAgICB0YXAoKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy50cmFuc2FjdGlvbnNEZXRhaWxzU3RhdHVzLm5leHQoeyBjaGVja0ltYWdlczogVHJhbnNhY3Rpb25zRGV0YWlsc0xvYWRpbmdTdGF0ZS5kb25lIH0pO1xuICAgICAgICAgIH0pLFxuICAgICAgICAgIGNhdGNoRXJyb3IoKGVycm9yKSA9PiB7XG4gICAgICAgICAgICBzd2l0Y2ggKGVycm9yLnN0YXR1cykge1xuICAgICAgICAgICAgICBjYXNlIDUwMDoge1xuICAgICAgICAgICAgICAgIHRoaXMudHJhbnNhY3Rpb25zRGV0YWlsc1N0YXR1cy5uZXh0KHsgY2hlY2tJbWFnZXM6IFRyYW5zYWN0aW9uc0RldGFpbHNMb2FkaW5nU3RhdGUuc2VydmVyRXJyb3IgfSk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgY2FzZSA0MDA6IHtcbiAgICAgICAgICAgICAgICB0aGlzLnRyYW5zYWN0aW9uc0RldGFpbHNTdGF0dXMubmV4dCh7IGNoZWNrSW1hZ2VzOiBUcmFuc2FjdGlvbnNEZXRhaWxzTG9hZGluZ1N0YXRlLmJhZFJlcXVlc3RFcnJvciB9KTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBjYXNlIDQwNDoge1xuICAgICAgICAgICAgICAgIHRoaXMudHJhbnNhY3Rpb25zRGV0YWlsc1N0YXR1cy5uZXh0KHsgY2hlY2tJbWFnZXM6IFRyYW5zYWN0aW9uc0RldGFpbHNMb2FkaW5nU3RhdGUubm90Rm91bmRFcnJvciB9KTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBkZWZhdWx0OiB7XG4gICAgICAgICAgICAgICAgdGhpcy50cmFuc2FjdGlvbnNEZXRhaWxzU3RhdHVzLm5leHQoeyBjaGVja0ltYWdlczogVHJhbnNhY3Rpb25zRGV0YWlsc0xvYWRpbmdTdGF0ZS5lcnJvciB9KTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gb2YoXG4gICAgICAgICAgICAgIG5ldyBIdHRwUmVzcG9uc2Uoe1xuICAgICAgICAgICAgICAgIGJvZHk6IHtcbiAgICAgICAgICAgICAgICAgIGltYWdlczogW10sXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH0pLFxuICAgICAgICAgIG1hcChUcmFuc2FjdGlvbnNDaGVja0ltYWdlcy5mcm9tSHR0cFJlc3BvbnNlKSxcbiAgICAgICAgKSxcbiAgICAgICksXG4gICAgKTtcbiAgfVxuXG4gIGZyb21HZW9sb2NhdGlvbihtYXBzQXBpS2V5OiBPYnNlcnZhYmxlPHN0cmluZz4pOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcbiAgICBtYXBzQXBpS2V5LnN1YnNjcmliZSh0aGlzLm1hcHNBcGlLZXkpO1xuXG4gICAgcmV0dXJuIGNvbWJpbmVMYXRlc3QoW3RoaXMudHJhbnNhY3Rpb25TZWxlY3Rpb24sIHRoaXMubWFwc0FwaUtleV0pLnBpcGUoXG4gICAgICBtYXAoKFt0cmFuc2FjdGlvbiwgYXBpS2V5XSkgPT4ge1xuICAgICAgICB0aGlzLm1hcEFwaUxvYWRlci5jb25maWcgPSB7XG4gICAgICAgICAgYXBpS2V5LFxuICAgICAgICAgIGxpYnJhcmllczogWydnZW9tZXRyeSddLFxuICAgICAgICB9O1xuXG4gICAgICAgIHRoaXMudHJhbnNhY3Rpb25zRGV0YWlsc1N0YXR1cy5uZXh0KHsgZ2VvbG9jYXRpb246IFRyYW5zYWN0aW9uc0RldGFpbHNMb2FkaW5nU3RhdGUubG9hZGluZyB9KTtcblxuICAgICAgICBpZiAoIWFwaUtleSB8fCAhdHJhbnNhY3Rpb24ubG9jYXRpb24gfHwgIXRyYW5zYWN0aW9uLmxvY2F0aW9uLmxhdGl0dWRlIHx8ICF0cmFuc2FjdGlvbi5sb2NhdGlvbi5sb25naXR1ZGUpIHtcbiAgICAgICAgICB0aGlzLnRyYW5zYWN0aW9uc0RldGFpbHNTdGF0dXMubmV4dCh7IGdlb2xvY2F0aW9uOiBUcmFuc2FjdGlvbnNEZXRhaWxzTG9hZGluZ1N0YXRlLm5vdExvYWRlZCB9KTtcblxuICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoZmFsc2UpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXMubWFwQXBpTG9hZGVyLmxvYWQoKS50aGVuKFxuICAgICAgICAgICgpID0+IHtcbiAgICAgICAgICAgIHRoaXMudHJhbnNhY3Rpb25zRGV0YWlsc1N0YXR1cy5uZXh0KHsgZ2VvbG9jYXRpb246IFRyYW5zYWN0aW9uc0RldGFpbHNMb2FkaW5nU3RhdGUuZG9uZSB9KTtcblxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgfSxcbiAgICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnRyYW5zYWN0aW9uc0RldGFpbHNTdGF0dXMubmV4dCh7IGdlb2xvY2F0aW9uOiBUcmFuc2FjdGlvbnNEZXRhaWxzTG9hZGluZ1N0YXRlLmVycm9yIH0pO1xuXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgfSxcbiAgICAgICAgKTtcbiAgICAgIH0pLFxuICAgICAgbWVyZ2VNYXAoKHByb21pc2UpID0+IGZyb20ocHJvbWlzZSkpLFxuICAgICk7XG4gIH1cblxuICBiYXRjaE9yZGVyOiBPYnNlcnZhYmxlPEJhdGNoT3JkZXIgfCB1bmRlZmluZWQ+ID0gdGhpcy50cmFuc2FjdGlvblNlbGVjdGlvbi5waXBlKFxuICAgIHRhcCgoKSA9PiB7XG4gICAgICB0aGlzLnRyYW5zYWN0aW9uc0RldGFpbHNTdGF0dXMubmV4dCh7XG4gICAgICAgIGJhdGNoT3JkZXI6IFRyYW5zYWN0aW9uc0RldGFpbHNMb2FkaW5nU3RhdGUubG9hZGluZyxcbiAgICAgIH0pO1xuICAgIH0pLFxuICAgIG1lcmdlTWFwKCh0cmFuc2FjdGlvbikgPT4ge1xuICAgICAgaWYgKCF0cmFuc2FjdGlvbi5iYXRjaE9yZGVySWQpIHtcbiAgICAgICAgcmV0dXJuIG9mKHVuZGVmaW5lZCk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB0aGlzLnBheW1lbnRzQmF0Y2hTZXJ2aWNlLmdldEJhdGNoKHRyYW5zYWN0aW9uLmJhdGNoT3JkZXJJZCkucGlwZShcbiAgICAgICAgY2F0Y2hFcnJvcigoKSA9PiB7XG4gICAgICAgICAgdGhpcy50cmFuc2FjdGlvbnNEZXRhaWxzU3RhdHVzLm5leHQoe1xuICAgICAgICAgICAgYmF0Y2hPcmRlcjogVHJhbnNhY3Rpb25zRGV0YWlsc0xvYWRpbmdTdGF0ZS5lcnJvcixcbiAgICAgICAgICB9KTtcblxuICAgICAgICAgIHJldHVybiBvZih1bmRlZmluZWQpO1xuICAgICAgICB9KSxcbiAgICAgICk7XG4gICAgfSksXG4gICAgbWFwKChkYXRhKSA9PiB7XG4gICAgICB0aGlzLnRyYW5zYWN0aW9uc0RldGFpbHNTdGF0dXMubmV4dCh7XG4gICAgICAgIGJhdGNoT3JkZXI6IGRhdGEgPyBUcmFuc2FjdGlvbnNEZXRhaWxzTG9hZGluZ1N0YXRlLmRvbmUgOiBUcmFuc2FjdGlvbnNEZXRhaWxzTG9hZGluZ1N0YXRlLm5vdFN0YXJ0ZWQsXG4gICAgICB9KTtcblxuICAgICAgcmV0dXJuIGRhdGE7XG4gICAgfSksXG4gICk7XG5cbiAgLyoqXG4gICAqIGRlc3Ryb3kgbGlmZWN5Y2xlIGhvb2sgdGhhdCB3aWxsIHJlbGVhc2UgcmVzb3VyY2VzXG4gICAqL1xuICBuZ09uRGVzdHJveSgpIHtcbiAgICB0aGlzLnRyYW5zYWN0aW9uU2VsZWN0aW9uLmNvbXBsZXRlKCk7XG4gICAgdGhpcy50cmFuc2FjdGlvbnNEZXRhaWxzU3RhdHVzLmNvbXBsZXRlKCk7XG4gICAgdGhpcy5tYXBzQXBpS2V5LmNvbXBsZXRlKCk7XG4gIH1cblxuICAvKipcbiAgICpcbiAgICogQHBhcmFtIGZlYXR1cmVcbiAgICogQHBhcmFtIHRvZ2dsZVxuICAgKlxuICAgKiBQcmV2ZW50cyBmcm9tIGVtaXRpbmcgdmFsdWVzIGlmIHRoZSBjeHAgY29uZmlndXJhdGlvbiBpcyBzZXQgYXMgZGlzYWJsZWRcbiAgICovXG4gIHByaXZhdGUgc2V0Q29uZGl0aW9uPFQ+KGZlYXR1cmU6IE9ic2VydmFibGU8VD4sIHRvZ2dsZTogUmVwbGF5U3ViamVjdDxib29sZWFuPik6IE9ic2VydmFibGU8VD4ge1xuICAgIHJldHVybiBjb21iaW5lTGF0ZXN0KFtmZWF0dXJlLCB0b2dnbGVdKS5waXBlKFxuICAgICAgZmlsdGVyKChbLCBjb25kaXRpb25dKSA9PiBjb25kaXRpb24pLFxuICAgICAgbWFwKChbdmFsdWVdKSA9PiB2YWx1ZSksXG4gICAgKTtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgdHJhbnNhY3Rpb25zRGF0YUh0dHBTZXJ2aWNlOiBUcmFuc2FjdGlvbkNsaWVudEh0dHBTZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgbWFwQXBpTG9hZGVyOiBNYXBBUElMb2FkZXJTZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgcGF5bWVudHNCYXRjaFNlcnZpY2U6IFBheW1lbnRzQmF0Y2hTZXJ2aWNlLFxuICApIHtcbiAgICB0aGlzLnRyYW5zYWN0aW9uc0RldGFpbHNTdGF0dXMubmV4dCh7XG4gICAgICBjaGVja0ltYWdlczogVHJhbnNhY3Rpb25zRGV0YWlsc0xvYWRpbmdTdGF0ZS5ub3RTdGFydGVkLFxuICAgICAgZ2VvbG9jYXRpb246IFRyYW5zYWN0aW9uc0RldGFpbHNMb2FkaW5nU3RhdGUubm90U3RhcnRlZCxcbiAgICAgIGVuYWJsZURpc3B1dGVBbmRJbnF1aXJ5OiBUcmFuc2FjdGlvbnNEZXRhaWxzTG9hZGluZ1N0YXRlLm5vdFN0YXJ0ZWQsXG4gICAgICBkaXNwdXRlT3B0aW9uOiBUcmFuc2FjdGlvbnNEZXRhaWxzTG9hZGluZ1N0YXRlLm5vdFN0YXJ0ZWQsXG4gICAgICBiYXRjaE9yZGVyOiBUcmFuc2FjdGlvbnNEZXRhaWxzTG9hZGluZ1N0YXRlLm5vdFN0YXJ0ZWQsXG4gICAgfSk7XG4gIH1cbn1cbiJdfQ==