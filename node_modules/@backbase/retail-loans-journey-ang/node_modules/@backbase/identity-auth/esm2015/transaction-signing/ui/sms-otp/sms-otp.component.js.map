{"version":3,"file":"sms-otp.component.js","sourceRoot":"","sources":["../../../../../../../libs/identity-auth/transaction-signing/ui/sms-otp/sms-otp.component.ts","../../../../../../../libs/identity-auth/transaction-signing/ui/sms-otp/sms-otp.component.html"],"names":[],"mappings":"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","sourcesContent":["import { ChangeDetectionStrategy, Component, EventEmitter, Input, OnChanges, Output } from '@angular/core';\nimport { FormBuilder, FormGroup, Validators } from '@angular/forms';\nimport { Observable } from 'rxjs';\nimport { ChallengeError, ChallengeSmsOtpData, CountdownService, SmsOtpResponse } from '../../util';\n\n@Component({\n  selector: 'bb-transaction-signing-sms-otp',\n  templateUrl: 'sms-otp.component.html',\n  changeDetection: ChangeDetectionStrategy.OnPush,\n})\nexport class TransactionSigningSmsOtpComponent implements OnChanges {\n  @Output() cancel = new EventEmitter<void>();\n  @Output() submitResponse = new EventEmitter<SmsOtpResponse>();\n  @Output() acceptError = new EventEmitter<Error>();\n  @Output() resend = new EventEmitter<void>();\n  @Input() previousData: ChallengeSmsOtpData | undefined;\n\n  @Input()\n  set data(value: ChallengeSmsOtpData) {\n    this.setOtpValidators(value.expectedOtpLength);\n    this.clearAlerts();\n    this.setResendCountdown(value);\n  }\n\n  get data() {\n    if (!this.challengeData) {\n      throw new Error('No challenge data set');\n    }\n    return this.challengeData;\n  }\n\n  @Input()\n  set error(value: ChallengeError | undefined) {\n    if (!value || !this.isRecognizedError(value)) {\n      this.errorValue = value;\n      return;\n    }\n\n    this.clearAlerts();\n    this.form.reset();\n    this.form.markAllAsTouched();\n    this.displayMissingAlert = true;\n  }\n\n  get error() {\n    return this.errorValue;\n  }\n\n  private readonly invalidRequestError = 'invalid_request';\n  readonly form: FormGroup = this.formBuilder.group({\n    otp: ['', [Validators.required, Validators.pattern(/^\\d{6}$/)]],\n  });\n  readonly timeUntilResend$: Observable<number> = this.countdown.remainingTime$;\n  errorValue: ChallengeError | undefined;\n  challengeData: ChallengeSmsOtpData | undefined;\n  displayIncorrectAlert = false;\n  displayMissingAlert = false;\n  displayRemainingAlert = false;\n  displayResendAlert = false;\n\n  constructor(private readonly formBuilder: FormBuilder, private countdown: CountdownService) {}\n\n  ngOnChanges(changes: any) {\n    this.setResendOptions(changes.data.currentValue.remainingOtpRequests);\n    this.setRemainingOptions(changes.data.currentValue.remainingAuthenticationAttempts);\n    this.challengeData = { ...this.previousData, ...changes.data.currentValue };\n  }\n\n  onSubmit() {\n    this.clearAlerts();\n    if (this.form.valid) {\n      return this.submitResponse.emit({ ...this.form.value } as SmsOtpResponse);\n    }\n\n    if (!this.form.value.otp || !this.form.value.otp.length) {\n      this.displayMissingAlert = true;\n      this.form.markAllAsTouched();\n    }\n\n    if (this.form.controls.otp.errors && this.form.controls.otp.errors.pattern) {\n      this.displayIncorrectAlert = true;\n      this.form.reset();\n      this.form.markAllAsTouched();\n    }\n  }\n\n  showInvalidError() {\n    return (this.displayIncorrectAlert || this.displayRemainingAlert) && !this.form.value.otp;\n  }\n\n  showMissingError() {\n    return this.displayMissingAlert && !this.form.value.otp;\n  }\n\n  private clearAlerts() {\n    this.displayIncorrectAlert = false;\n    this.displayMissingAlert = false;\n    this.displayRemainingAlert = false;\n    this.displayResendAlert = false;\n  }\n\n  private setOtpValidators(patternLength: number) {\n    const regex = new RegExp('^\\\\d{' + patternLength + '}$');\n    this.form.controls.otp.setValidators([Validators.required, Validators.pattern(regex)]);\n  }\n\n  private isRecognizedError(error: ChallengeError) {\n    return error.errorCode === this.invalidRequestError && error.errorDescription === this.invalidRequestError;\n  }\n\n  private setResendCountdown(challenge: ChallengeSmsOtpData) {\n    if (challenge.nextOtpTime > 0 && challenge.remainingOtpRequests !== 0) {\n      this.countdown.start(challenge.nextOtpTime);\n    }\n  }\n\n  private setResendOptions(remaining?: number) {\n    if (remaining === undefined || !this.previousData) {\n      return;\n    }\n\n    const previousRemaining = this.previousData && this.previousData.remainingOtpRequests;\n    if (!previousRemaining || remaining < previousRemaining) {\n      this.displayResendAlert = true;\n      this.displayRemainingAlert = false;\n    }\n  }\n\n  private setRemainingOptions(remaining?: number) {\n    if (remaining === undefined || !this.previousData) {\n      return;\n    }\n\n    const previousRemaining = this.previousData.remainingAuthenticationAttempts;\n    if (!previousRemaining || remaining < previousRemaining) {\n      this.form.reset();\n      this.form.markAllAsTouched();\n      this.displayRemainingAlert = true;\n      this.displayResendAlert = false;\n    }\n  }\n}\n","<bb-transaction-signing-error\n  *ngIf=\"errorValue; else displayForm\"\n  [error]=\"errorValue\"\n  (closeModal)=\"acceptError.emit($event)\"\n>\n</bb-transaction-signing-error>\n\n<ng-template #displayForm>\n  <bb-alert-ui\n    *ngIf=\"displayMissingAlert\"\n    data-role=\"ts-sms-otp-missing-alert\"\n    i18n-title=\"No value alert title for sms otp signing@@bb-sms-otp-signing.alert.missing.title\"\n    title=\"No value entered\"\n  >\n    <span i18n=\"No value alert message for sms otp signing@@bb-sms-otp-signing.alert.missing.message\">\n      Please enter the value displayed on your device.\n    </span>\n  </bb-alert-ui>\n  <bb-alert-ui\n    *ngIf=\"displayIncorrectAlert\"\n    data-role=\"ts-sms-otp-incorrect-alert\"\n    i18n-title=\"Incorrect attempts alert title for sms otp signing@@bb-sms-otp-signing.alert.incorrect.title\"\n    title=\"Authorization failed\"\n  >\n    <span i18n=\"Incorrect attempts alert message for sms otp signing@@bb-sms-otp-signing.alert.incorrect.message\">\n      The number you entered was incorrect.\n    </span>\n  </bb-alert-ui>\n  <bb-alert-ui\n    *ngIf=\"displayRemainingAlert\"\n    data-role=\"ts-sms-otp-remaining-alert\"\n    i18n-title=\"Remaining attempts alert title for sms otp signing@@bb-sms-otp-signing.alert.remaining.title\"\n    title=\"Authorization failed\"\n  >\n    <span i18n=\"Remaining attempts alert message for sms otp signing@@bb-sms-otp-signing.alert.remaining.message\">\n      The number you entered was incorrect. <br />\n      You have {{ data.remainingAuthenticationAttempts }} other {data.remainingAuthenticationAttempts, plural, =1\n      {attempt} other {attempts}} remaining.\n    </span>\n  </bb-alert-ui>\n  <bb-alert-ui\n    *ngIf=\"displayResendAlert\"\n    data-role=\"ts-sms-otp-resend-alert\"\n    modifier=\"info\"\n    i18n-title=\"Message resend alert title for sms otp signing@@bb-sms-otp-signing.alert.resend.title\"\n    title=\"SMS message resent\"\n  >\n    <span i18n=\"Message resend alert message for sms otp signing@@bb-sms-otp-signing.alert.resend.message\">\n      The SMS message has been successfully sent. <br />\n      You have {data.remainingOtpRequests, plural, =0 {no} other {{{data.remainingOtpRequests}} SMS}} resend\n      {data.remainingOtpRequests, plural, =1 {attempt} other {attempts}} left.\n    </span>\n  </bb-alert-ui>\n  <div class=\"bb-block bb-block--sm\" i18n=\"Instruction for sms otp signing@@bb-sms-otp-signing.instruction\">\n    SMS message sent to {{ data.phoneNumber }}\n  </div>\n  <div class=\"bb-block bb-block--lg\">\n    <ng-container *ngIf=\"data.remainingOtpRequests !== 0; else displayNoRemainingRequests\">\n      <ng-container *ngIf=\"timeUntilResend$ | async as time; else displayResendButton\">\n        <span\n          class=\"bb-subtitle bb-text-support bb-block bb-block--sm\"\n          i18n=\"Time before resend@@bb-sms-otp-signing.resend.time-before\"\n          data-role=\"ts-sms-otp-resend-helper\"\n        >\n          Next resend available in {{ time }} {time, plural, =1 {second} other {seconds}}\n        </span>\n        <bb-progressbar-ui height=\"0.5rem\" [value]=\"data.nextOtpTime - time\" [max]=\"data.nextOtpTime\">\n        </bb-progressbar-ui>\n      </ng-container>\n      <ng-template #displayResendButton>\n        <button\n          bbButton\n          data-role=\"ts-sms-otp-resend\"\n          color=\"secondary\"\n          buttonSize=\"sm\"\n          i18n=\"Resend SMS OTP button@@bb-sms-otp-signing.resend\"\n          (click)=\"resend.emit()\"\n        >\n          Resend message\n        </button>\n      </ng-template>\n    </ng-container>\n    <ng-template #displayNoRemainingRequests>\n      <span\n        data-role=\"ts-sms-otp-no-resend\"\n        class=\"bb-subtitle bb-text-danger\"\n        i18n=\"No otp resend attempts remaining@@bb-sms-otp-signing.no-resend\"\n      >\n        You have no SMS resend attempts left. <br />\n        Please enter the correct OTP code or cancel this transaction.\n      </span>\n    </ng-template>\n  </div>\n\n  <form [formGroup]=\"form\" (submit)=\"onSubmit()\" class=\"bb-block bb-block--md\">\n    <div class=\"form-group\">\n      <bb-input-text-ui\n        data-role=\"ts-sms-otp-field\"\n        class=\"bb-form-field bb-form-field--xs\"\n        formControlName=\"otp\"\n        i18n-label=\"Aria label for otp field input@@bb-sms-otp-signing.label\"\n        label=\"Input OTP code\"\n        [maxLength]=\"data.expectedOtpLength\"\n        [minLength]=\"data.expectedOtpLength\"\n      >\n      </bb-input-text-ui>\n      <bb-input-validation-message-ui [showErrors]=\"true\">\n        <span\n          *ngIf=\"showInvalidError()\"\n          data-role=\"ts-sms-otp-incorrect-error\"\n          i18n=\"Otp input invalid error message@@bb-sms-otp-signing.errors.invalid\"\n        >\n          Incorrect code. Try again.\n        </span>\n        <span\n          *ngIf=\"showMissingError()\"\n          data-role=\"ts-sms-otp-missing-error\"\n          i18n=\"Otp input missing error message@@bb-sms-otp-signing.errors.missing\"\n        >\n          You must enter an OTP.\n        </span>\n      </bb-input-validation-message-ui>\n      <small class=\"bb-text-support\" i18n=\"Otp input helper text@@bb-sms-otp-signing.helper\">\n        Value must be exactly {{ data.expectedOtpLength }} digits\n      </small>\n    </div>\n    <div class=\"bb-button-bar\">\n      <button\n        bbButton\n        data-role=\"ts-sms-otp-complete\"\n        class=\"bb-button-bar__button\"\n        color=\"primary\"\n        type=\"submit\"\n        i18n=\"Complete button@@bb-sms-otp-signing.complete\"\n      >\n        Complete\n      </button>\n      <button\n        bbButton\n        data-role=\"ts-sms-otp-cancel\"\n        class=\"bb-button-bar__button\"\n        color=\"secondary\"\n        (click)=\"cancel.emit()\"\n        i18n=\"Cancel button@@bb-sms-otp-signing.cancel\"\n      >\n        Cancel\n      </button>\n    </div>\n  </form>\n</ng-template>\n"]}