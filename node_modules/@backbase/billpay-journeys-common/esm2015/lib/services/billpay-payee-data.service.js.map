{"version":3,"file":"billpay-payee-data.service.js","sourceRoot":"","sources":["../../../../../../libs/billpay-journeys-common/src/lib/services/billpay-payee-data.service.ts"],"names":[],"mappings":"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","sourcesContent":["import { Injectable } from '@angular/core';\nimport {\n  BillPayPayeesService,\n  BillPayPayverisService,\n  BillPayEbillsService,\n  BillPayPayeesSummaryService,\n  BillPayPayeesSummaryGetResponseBody,\n  BillPayPayverisResolveEbillErrorsPostRequestBody,\n  BillPayPayverisResolveEbillErrorsPostResponseBody,\n  PayeeSummary,\n} from '@backbase/data-ang/billpay';\nimport { catchError, map, switchMap, tap } from 'rxjs/operators';\nimport { HttpResponse } from '@angular/common/http';\nimport { BehaviorSubject, Observable, of } from 'rxjs';\nimport { PayeeSummariesByEbill } from '../model';\nexport { PayeeSummary, Currency, BillPayPayeesSummaryGetResponseBody } from '@backbase/data-ang/billpay';\n\nexport const defaultDeleteParams = {\n  cancelPendingPayments: false,\n};\n\n@Injectable()\nexport class BillpayPayeeDataService {\n  private readonly selectedDeletePayeeSource = new BehaviorSubject<PayeeSummary | undefined>(undefined);\n  private readonly selectedDeleteEbillsSource = new BehaviorSubject<PayeeSummary | undefined>(undefined);\n  private readonly reload = new BehaviorSubject(undefined);\n  private buttonsDisabled = false;\n  private currentPayeesLoadingState: 'loading' | 'error' | '' = '';\n  private iterablePayeeSummaryList: PayeeSummary[] = [];\n\n  /** @internal */\n  constructor(\n    private readonly data: BillPayPayeesService,\n    private readonly payverisData: BillPayPayverisService,\n    private readonly ebillsData: BillPayEbillsService,\n    private readonly payeesSummaryData: BillPayPayeesSummaryService,\n  ) {}\n\n  deletePayee(id: string, electronic: boolean): Observable<HttpResponse<any>> {\n    return electronic\n      ? this.data.deleteElectronicPayeeById({ ...defaultDeleteParams, id })\n      : this.data.deletePayeeById({ ...defaultDeleteParams, id });\n  }\n\n  resolveErrors(id: string): Observable<BillPayPayverisResolveEbillErrorsPostResponseBody> {\n    const resolveErrorsRequest: BillPayPayverisResolveEbillErrorsPostRequestBody = {\n      payeeID: id,\n    };\n    return this.payverisData.postBillPayPayverisResolveEbillErrors({\n      billPayPayverisResolveEbillErrorsPostRequestBody: resolveErrorsRequest,\n    });\n  }\n\n  deleteEbills(id: string): Observable<HttpResponse<any>> {\n    return this.ebillsData.deleteBillPayEbills({ id });\n  }\n\n  getPayees(): Observable<PayeeSummariesByEbill | undefined> {\n    return this.reload.asObservable().pipe(\n      tap(() => (this.currentPayeesLoadingState = 'loading')),\n      switchMap(() => this.payeesSummaryData.getBillPayPayeesSummary().pipe(map(groupByEbills))),\n      tap(data => sortByPayeeGroup(data)),\n      tap(data => this.createIterablePayeeSummaryList(data)),\n      tap(() => {\n        this.currentPayeesLoadingState = '';\n      }),\n      catchError(() => {\n        this.currentPayeesLoadingState = 'error';\n        return of(undefined);\n      }),\n    );\n  }\n\n  private createIterablePayeeSummaryList(list: PayeeSummariesByEbill) {\n    this.iterablePayeeSummaryList = [];\n    for (let i = 0; i < list.ebillsEnabled.length; i++) {\n      const summary = list.ebillsEnabled[i];\n      this.iterablePayeeSummaryList.push(summary);\n    }\n    for (let j = 0; j < list.ebillsNotEnabled.length; j++) {\n      const summary = list.ebillsNotEnabled[j];\n      this.iterablePayeeSummaryList.push(summary);\n    }\n  }\n\n  reloadPayees() {\n    this.reload.next(undefined);\n  }\n\n  disableWidgetButtons() {\n    this.buttonsDisabled = true;\n  }\n\n  enableWidgetButtons() {\n    this.buttonsDisabled = false;\n  }\n\n  updateSelectedDeletePayee(payee: PayeeSummary | undefined) {\n    this.selectedDeletePayeeSource.next(payee);\n  }\n  updateSelectedDeleteEbills(payee: PayeeSummary | undefined) {\n    this.selectedDeleteEbillsSource.next(payee);\n  }\n  get selectedDeletePayee(): Observable<PayeeSummary | undefined> {\n    return this.selectedDeletePayeeSource.asObservable();\n  }\n  get selectedDeleteEbills(): Observable<PayeeSummary | undefined> {\n    return this.selectedDeleteEbillsSource.asObservable();\n  }\n\n  get payeesLoadingState() {\n    return this.currentPayeesLoadingState;\n  }\n\n  get areButtonsDisabled(): boolean {\n    return this.buttonsDisabled;\n  }\n\n  get numberOfPayees() {\n    return this.iterablePayeeSummaryList.length;\n  }\n\n  private payeesLoaded(): Promise<boolean> {\n    const _this = this;\n    return new Promise<boolean>(function (resolve) {\n      (function waitUntilLoaded() {\n        if (_this.currentPayeesLoadingState === '') return resolve(true);\n        setTimeout(waitUntilLoaded, 100);\n      })();\n    });\n  }\n\n  async findPayeeSummaryById(payeeId: string): Promise<PayeeSummary | undefined> {\n    if (await this.payeesLoaded()) {\n      return this.iterablePayeeSummaryList.find(summary => summary.id === payeeId);\n    }\n    return;\n  }\n}\n\nfunction groupByEbills(data: BillPayPayeesSummaryGetResponseBody): PayeeSummariesByEbill {\n  const payeeSummaries = data.payeeSummaries as PayeeSummary[];\n  return payeeSummaries.reduce(\n    (grouped: any, payeeSummary: PayeeSummary) => {\n      grouped[payeeSummary.ebill && payeeSummary.ebill.enabled ? 'ebillsEnabled' : 'ebillsNotEnabled'].push(\n        payeeSummary,\n      );\n      return grouped;\n    },\n    {\n      ebillsEnabled: [],\n      ebillsNotEnabled: [],\n    },\n  );\n}\n\nfunction sortByPayeeGroup(data: PayeeSummariesByEbill) {\n  sortPayeeSummaries(data.ebillsEnabled);\n  sortPayeeSummaries(data.ebillsNotEnabled);\n}\n\nfunction sortPayeeSummaries(summaries: PayeeSummary[]) {\n  summaries.sort((a, b) =>\n    getPayeeDisplayName(a.name, a.nickName).toLowerCase() > getPayeeDisplayName(b.name, b.nickName).toLowerCase()\n      ? 1\n      : -1,\n  );\n}\n\nfunction getPayeeDisplayName(payeeName: string, payeeNickName?: string): string {\n  return payeeNickName || payeeName;\n}\n"]}