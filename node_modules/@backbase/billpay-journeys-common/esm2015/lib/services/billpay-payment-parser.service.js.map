{"version":3,"file":"billpay-payment-parser.service.js","sourceRoot":"","sources":["../../../../../../libs/billpay-journeys-common/src/lib/services/billpay-payment-parser.service.ts"],"names":[],"mappings":"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","sourcesContent":["import { Inject, Injectable, LOCALE_ID } from '@angular/core';\nimport { getLocaleNumberSymbol, NumberSymbol } from '@angular/common';\n\nimport { Currency, PayeeSummary, Payment, OneOffPayment, Payee } from '@backbase/data-ang/billpay';\nimport { Schedule, EndTypes, FrequencyKeys, PaymentServicesTypes, PaymentFormState, PaymentReview } from '../model';\n\nimport { recurringFrequencies } from '../constants';\n\n@Injectable()\nexport class BillpayPaymentParserService {\n  private readonly decimalSeparator: string;\n  constructor(@Inject(LOCALE_ID) private readonly locale: string) {\n    this.decimalSeparator = getLocaleNumberSymbol(this.locale, NumberSymbol.CurrencyDecimal);\n  }\n  paymentRecurringToFormState(payment: Payment, payees: PayeeSummary[]): PaymentFormState {\n    const frequency = payment.recurring && recurringFrequencies.find(item => item.value === payment.frequency);\n    const endType = payment.numberOfInstances ? EndTypes.After : EndTypes.Never;\n\n    return {\n      ...this.parsePaymentCommonResponse(payment, payees),\n      schedule: {\n        repeat: payment.numberOfInstances,\n        endType,\n        startDate: payment.paymentDate,\n        alertPendingCheckbox: payment.paymentScheduledAlert || false,\n        alertSentCheckbox: payment.paymentSentAlert || false,\n        alertLastPendingCheckbox: payment.modelExpirationAlert || false,\n        ...(frequency && { frequency: frequency.value }),\n      },\n    } as PaymentFormState;\n  }\n\n  paymentOneOffToFormState(payment: OneOffPayment, payees: PayeeSummary[]): PaymentFormState {\n    return {\n      ...this.parsePaymentCommonResponse(payment, payees),\n      schedule: {\n        startDate: payment.paymentDate,\n        alertPendingCheckbox: false,\n        alertSentCheckbox: false,\n        alertLastPendingCheckbox: false,\n        frequency: FrequencyKeys.Once,\n      },\n    } as PaymentFormState;\n  }\n\n  paymentFormStateToReview({\n    accountFrom,\n    payeeTo,\n    amount,\n    memo,\n    schedule,\n    overnightDeliveryAddress,\n  }: PaymentFormState): PaymentReview {\n    return {\n      amount: {\n        amount: amount.amount.replace(this.decimalSeparator, '.'),\n        currencyCode: amount.currency,\n      },\n      paymentDate: schedule.paymentServiceDate || schedule.startDate,\n      paymentAccount: accountFrom,\n      recurring: schedule.frequency !== FrequencyKeys.Once,\n      ...(memo && { paymentMemo: memo }),\n      ...(overnightDeliveryAddress && { overnightDeliveryAddress }),\n      ...this.parsePaymentFormPayee(payeeTo),\n      ...this.parsePaymentFormSchedule(schedule),\n    };\n  }\n\n  paymentAndPayeeResponsesToReview(payment: Payment | OneOffPayment, payee: Payee): PaymentReview {\n    return {\n      ...this.paymentResponseToReview(payment),\n      ...(payee.address && { address: payee.address }),\n    };\n  }\n  // eslint-disable-next-line no-unused-vars, @typescript-eslint/no-unused-vars\n  private paymentResponseToReview({ id, status, ebillID, ...rest }: Payment | OneOffPayment) {\n    return rest;\n  }\n\n  private parsePaymentFormPayee(\n    payee: PayeeSummary,\n  ): Pick<PaymentReview, 'payeeID' | 'payeeName' | 'payeeAccountNumber' | 'payeeNickName'> {\n    return {\n      payeeID: payee.id,\n      payeeName: payee.name,\n      ...(payee.accountNumber && { payeeAccountNumber: payee.accountNumber }),\n      ...(payee.nickName && { payeeNickName: payee.nickName }),\n    };\n  }\n\n  private parsePaymentFormSchedule(\n    schedule: Schedule,\n  ): Pick<\n    PaymentReview,\n    'fee' | 'numberOfInstances' | 'frequency' | 'paymentScheduledAlert' | 'paymentSentAlert' | 'modelExpirationAlert'\n  > {\n    return {\n      ...(this.getScheduleFee(schedule) && { fee: this.getScheduleFee(schedule) }),\n      ...(schedule.repeat && { numberOfInstances: schedule.repeat }),\n      ...(schedule.frequency !== FrequencyKeys.Once && { frequency: schedule.frequency }),\n      ...(schedule.alertPendingCheckbox && { paymentScheduledAlert: schedule.alertPendingCheckbox }),\n      ...(schedule.alertSentCheckbox && { paymentSentAlert: schedule.alertSentCheckbox }),\n      ...(schedule.alertLastPendingCheckbox && { modelExpirationAlert: schedule.alertLastPendingCheckbox }),\n    };\n  }\n\n  private getScheduleFee(schedule: Schedule): Currency | undefined {\n    return (\n      (schedule.paymentService &&\n        (schedule.paymentService.index === PaymentServicesTypes.Expedited ||\n          schedule.paymentService.index === PaymentServicesTypes.Overnight) &&\n        schedule.paymentService.service &&\n        schedule.paymentService.service.fee) ||\n      undefined\n    );\n  }\n\n  private parsePaymentCommonResponse(\n    payment: Payment | OneOffPayment,\n    payees: PayeeSummary[],\n  ): Partial<PaymentFormState> {\n    const payeeTo = payees.find(item => item.id === payment.payeeID);\n    const amount = payment.amount && {\n      currency: payment.amount.currencyCode,\n      amount: payment.amount.amount.replace(this.decimalSeparator, '.'),\n    };\n    return {\n      paymentId: payment.id,\n      ...(payment.amount && { amount }),\n      ...(payeeTo && { payeeTo }),\n      ...(payment.paymentAccount && { accountFrom: payment.paymentAccount }),\n      ...(payment.paymentMemo && { memo: payment.paymentMemo }),\n    };\n  }\n}\n"]}