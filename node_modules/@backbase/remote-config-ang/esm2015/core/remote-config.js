import { __awaiter } from "tslib";
import { ParseFailure, ParseSuccess } from './parser/parse-result';
import { ParseError, ValueParser } from './parser/value-parser';
import { TypeExtractor } from './type-extractor/type-extractor';
import { hasProperty } from './utils/has-property';
import { isNullOrUndefined, isUndefined } from './utils/is';
import { trim } from './utils/trim';
const valueParser = new ValueParser();
const typeExtractor = new TypeExtractor();
export class RemoteConfig {
    constructor(configFetcher, context, defaults) {
        this.configFetcher = configFetcher;
        this.tags = new Set();
        const normalizedContext = RemoteConfig.normalizeContext(context);
        RemoteConfig.validateContext(normalizedContext);
        this.context = normalizedContext;
        this.defaultConfig = Object.assign({}, defaults);
        this.extractedType = typeExtractor.extractTypes(defaults);
    }
    static normalizeTag(tag) {
        return trim(tag);
    }
    static normalizeContext(context) {
        const appName = trim(context.appName);
        const appVersion = trim(context.appVersion);
        const projectName = trim(context.projectName);
        const serviceRoot = trim(context.serviceRoot).replace(/\/$/, '');
        return {
            appName,
            appVersion,
            projectName,
            serviceRoot,
        };
    }
    static validateContext(context) {
        if (context.appName.length === 0) {
            throw new TypeError(`[remote-config] Could not instantiate Remove Config client: ` + `The provided appName is empty.`);
        }
        if (context.appVersion.length === 0) {
            throw new TypeError(`[remote-config] Could not instantiate Remove Config client: ` + `The provided appVersion is empty.`);
        }
    }
    activate() {
        this.activatedConfig = Object.assign({}, this.fetchedConfig);
    }
    addCustomTag(tag) {
        const normalizedTag = RemoteConfig.normalizeTag(tag);
        if (normalizedTag.length === 0) {
            console.warn(`[remote-config] Could not add the tag: ` + `A tag must be a non-empty string.`);
            return;
        }
        this.tags.add(normalizedTag);
    }
    removeCustomTag(tag) {
        const normalizedTag = RemoteConfig.normalizeTag(tag);
        if (normalizedTag.length === 0) {
            console.warn(`[remote-config] Could not delete the tag: ` + `A tag must be a non-empty string.`);
            return false;
        }
        return this.tags.delete(normalizedTag);
    }
    clearCustomTags() {
        this.tags.clear();
    }
    fetch() {
        return __awaiter(this, void 0, void 0, function* () {
            const projectName = this.context.projectName;
            const serviceRoot = this.context.serviceRoot;
            const url = `${serviceRoot}/client-api/v1/projects/${projectName}/parameters`;
            const headers = {
                'Application-Name': this.context.appName,
                'Application-Version': this.context.appVersion,
                'Custom-Tags': Array.from(this.tags).join(','),
            };
            try {
                this.fetchedConfig = yield this.configFetcher.fetch({
                    headers,
                    url,
                });
            }
            catch (error) {
                console.warn(`[remote-config] Could not fetch the remote config:`, error);
            }
        });
    }
    fetchAndActivate() {
        return __awaiter(this, void 0, void 0, function* () {
            yield this.fetch();
            this.activate();
        });
    }
    getValue(parameterName) {
        const remoteValue = this.getRemoteValue(parameterName);
        if (remoteValue instanceof ParseSuccess) {
            return remoteValue.result;
        }
        if (remoteValue instanceof ParseFailure) {
            console.warn(`[remote-config] Failed to parse the remote value ` +
                `of the parameter "${parameterName}". ` +
                `Reason: ${remoteValue.reason}`);
        }
        return this.getDefaultValue(parameterName);
    }
    getDefaultValue(parameterName) {
        if (hasProperty(this.defaultConfig, parameterName)) {
            const defaultValue = this.defaultConfig[parameterName];
            return isNullOrUndefined(defaultValue) ? null : defaultValue;
        }
        console.warn(`[remote-config] Could not get a default value. ` +
            `The parameter '${parameterName}' is not present in the default config.`);
        return null;
    }
    getRawRemoteValue(parameterName) {
        if (this.activatedConfig && hasProperty(this.activatedConfig, parameterName)) {
            return this.activatedConfig[parameterName];
        }
        return undefined;
    }
    getRemoteValue(parameterName) {
        const rawRemoteValue = this.getRawRemoteValue(parameterName);
        return !isUndefined(rawRemoteValue) ? this.parseRemoteValue(rawRemoteValue, parameterName) : null;
    }
    parseRemoteValue(rawRemoteValue, parameterName) {
        const valueType = this.extractedType.properties[parameterName];
        if (!valueType) {
            return ParseFailure.create(ParseError.UnknownPropertyType);
        }
        return valueParser.parseAs(rawRemoteValue, valueType);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVtb3RlLWNvbmZpZy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL3JlbW90ZS1jb25maWctYW5nL3NyYy9jb3JlL3JlbW90ZS1jb25maWcudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUNBLE9BQU8sRUFBRSxZQUFZLEVBQWUsWUFBWSxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDaEYsT0FBTyxFQUFFLFVBQVUsRUFBRSxXQUFXLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUdoRSxPQUFPLEVBQWUsYUFBYSxFQUFFLE1BQU0saUNBQWlDLENBQUM7QUFDN0UsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ25ELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxXQUFXLEVBQUUsTUFBTSxZQUFZLENBQUM7QUFDNUQsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUVwQyxNQUFNLFdBQVcsR0FBRyxJQUFJLFdBQVcsRUFBRSxDQUFDO0FBQ3RDLE1BQU0sYUFBYSxHQUFHLElBQUksYUFBYSxFQUFFLENBQUM7QUFFMUMsTUFBTSxPQUFPLFlBQVk7SUFDdkIsWUFBNkIsYUFBK0IsRUFBRSxPQUE0QixFQUFFLFFBQVc7UUFBMUUsa0JBQWEsR0FBYixhQUFhLENBQWtCO1FBdUQzQyxTQUFJLEdBQUcsSUFBSSxHQUFHLEVBQVUsQ0FBQztRQXREeEMsTUFBTSxpQkFBaUIsR0FBRyxZQUFZLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxDQUFDLENBQUM7UUFFakUsWUFBWSxDQUFDLGVBQWUsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1FBRWhELElBQUksQ0FBQyxPQUFPLEdBQUcsaUJBQWlCLENBQUM7UUFFakMsSUFBSSxDQUFDLGFBQWEscUJBQ2IsUUFBUSxDQUNaLENBQUM7UUFFRixJQUFJLENBQUMsYUFBYSxHQUFHLGFBQWEsQ0FBQyxZQUFZLENBQUMsUUFBdUIsQ0FBQyxDQUFDO0lB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QUFDO0lBQ2QsQ0FBQztJQUVPLGlCQUFpQixDQUE2QixhQUFnQjtRQUNwRSxJQUFJLElBQUksQ0FBQyxlQUFlLElBQUksV0FBVyxDQUFDLElBQUksQ0FBQyxlQUFlLEVBQUUsYUFBYSxDQUFDLEVBQUU7WUFDNUUsT0FBTyxJQUFJLENBQUMsZUFBZSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1NBQzVDO1FBRUQsT0FBTyxTQUFTLENBQUM7SUFDbkIsQ0FBQztJQUVPLGNBQWMsQ0FBNkIsYUFBZ0I7UUFDakUsTUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBRTdELE9BQU8sQ0FBQyxXQUFXLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxjQUFjLEVBQUUsYUFBYSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztJQUNwRyxDQUFDO0lBRU8sZ0JBQWdCLENBQ3RCLGNBQXVCLEVBQ3ZCLGFBQWdCO1FBRWhCLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBRS9ELElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDZCxPQUFPLFlBQVksQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLG1CQUFtQixDQUFDLENBQUM7U0FDNUQ7UUFFRCxPQUFPLFdBQVcsQ0FBQyxPQUFPLENBQU8sY0FBYyxFQUFFLFNBQVMsQ0FBQyxDQUFDO0lBQzlELENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbmZpZ0ZldGNoZXIgfSBmcm9tICcuL2NvbmZpZy1mZXRjaGVycy9hYnN0cmFjdCc7XG5pbXBvcnQgeyBQYXJzZUZhaWx1cmUsIFBhcnNlUmVzdWx0LCBQYXJzZVN1Y2Nlc3MgfSBmcm9tICcuL3BhcnNlci9wYXJzZS1yZXN1bHQnO1xuaW1wb3J0IHsgUGFyc2VFcnJvciwgVmFsdWVQYXJzZXIgfSBmcm9tICcuL3BhcnNlci92YWx1ZS1wYXJzZXInO1xuaW1wb3J0IHsgUmVtb3RlQ29uZmlnQ29udGV4dCwgUmVtb3RlQ29uZmlnUGFyYW1ldGVycyB9IGZyb20gJy4vcmVtb3RlLWNvbmZpZy50eXBlcyc7XG5pbXBvcnQgeyBPYmplY3RWYWx1ZVR5cGVEZXNjcmlwdG9yIH0gZnJvbSAnLi90eXBlLWV4dHJhY3Rvci9leHRyYWN0ZWQtdmFsdWUtdHlwZXMnO1xuaW1wb3J0IHsgT2JqZWN0VmFsdWUsIFR5cGVFeHRyYWN0b3IgfSBmcm9tICcuL3R5cGUtZXh0cmFjdG9yL3R5cGUtZXh0cmFjdG9yJztcbmltcG9ydCB7IGhhc1Byb3BlcnR5IH0gZnJvbSAnLi91dGlscy9oYXMtcHJvcGVydHknO1xuaW1wb3J0IHsgaXNOdWxsT3JVbmRlZmluZWQsIGlzVW5kZWZpbmVkIH0gZnJvbSAnLi91dGlscy9pcyc7XG5pbXBvcnQgeyB0cmltIH0gZnJvbSAnLi91dGlscy90cmltJztcblxuY29uc3QgdmFsdWVQYXJzZXIgPSBuZXcgVmFsdWVQYXJzZXIoKTtcbmNvbnN0IHR5cGVFeHRyYWN0b3IgPSBuZXcgVHlwZUV4dHJhY3RvcigpO1xuXG5leHBvcnQgY2xhc3MgUmVtb3RlQ29uZmlnPFQgZXh0ZW5kcyBSZW1vdGVDb25maWdQYXJhbWV0ZXJzPiB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgY29uZmlnRmV0Y2hlcjogQ29uZmlnRmV0Y2hlcjxUPiwgY29udGV4dDogUmVtb3RlQ29uZmlnQ29udGV4dCwgZGVmYXVsdHM6IFQpIHtcbiAgICBjb25zdCBub3JtYWxpemVkQ29udGV4dCA9IFJlbW90ZUNvbmZpZy5ub3JtYWxpemVDb250ZXh0KGNvbnRleHQpO1xuXG4gICAgUmVtb3RlQ29uZmlnLnZhbGlkYXRlQ29udGV4dChub3JtYWxpemVkQ29udGV4dCk7XG5cbiAgICB0aGlzLmNvbnRleHQgPSBub3JtYWxpemVkQ29udGV4dDtcblxuICAgIHRoaXMuZGVmYXVsdENvbmZpZyA9IHtcbiAgICAgIC4uLmRlZmF1bHRzLFxuICAgIH07XG5cbiAgICB0aGlzLmV4dHJhY3RlZFR5cGUgPSB0eXBlRXh0cmFjdG9yLmV4dHJhY3RUeXBlcyhkZWZhdWx0cyBhcyBPYmplY3RWYWx1ZSk7XG4gIH1cblxuICBwcml2YXRlIHN0YXRpYyBub3JtYWxpemVUYWcodGFnOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gdHJpbSh0YWcpO1xuICB9XG5cbiAgcHJpdmF0ZSBzdGF0aWMgbm9ybWFsaXplQ29udGV4dChjb250ZXh0OiBSZW1vdGVDb25maWdDb250ZXh0KTogUmVtb3RlQ29uZmlnQ29udGV4dCB7XG4gICAgY29uc3QgYXBwTmFtZSA9IHRyaW0oY29udGV4dC5hcHBOYW1lKTtcbiAgICBjb25zdCBhcHBWZXJzaW9uID0gdHJpbShjb250ZXh0LmFwcFZlcnNpb24pO1xuICAgIGNvbnN0IHByb2plY3ROYW1lID0gdHJpbShjb250ZXh0LnByb2plY3ROYW1lKTtcbiAgICBjb25zdCBzZXJ2aWNlUm9vdCA9IHRyaW0oY29udGV4dC5zZXJ2aWNlUm9vdCkucmVwbGFjZSgvXFwvJC8sICcnKTtcblxuICAgIHJldHVybiB7XG4gICAgICBhcHBOYW1lLFxuICAgICAgYXBwVmVyc2lvbixcbiAgICAgIHByb2plY3ROYW1lLFxuICAgICAgc2VydmljZVJvb3QsXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgc3RhdGljIHZhbGlkYXRlQ29udGV4dChjb250ZXh0OiBSZW1vdGVDb25maWdDb250ZXh0KTogdm9pZCB7XG4gICAgaWYgKGNvbnRleHQuYXBwTmFtZS5sZW5ndGggPT09IDApIHtcbiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXG4gICAgICAgIGBbcmVtb3RlLWNvbmZpZ10gQ291bGQgbm90IGluc3RhbnRpYXRlIFJlbW92ZSBDb25maWcgY2xpZW50OiBgICsgYFRoZSBwcm92aWRlZCBhcHBOYW1lIGlzIGVtcHR5LmAsXG4gICAgICApO1xuICAgIH1cblxuICAgIGlmIChjb250ZXh0LmFwcFZlcnNpb24ubGVuZ3RoID09PSAwKSB7XG4gICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFxuICAgICAgICBgW3JlbW90ZS1jb25maWddIENvdWxkIG5vdCBpbnN0YW50aWF0ZSBSZW1vdmUgQ29uZmlnIGNsaWVudDogYCArIGBUaGUgcHJvdmlkZWQgYXBwVmVyc2lvbiBpcyBlbXB0eS5gLFxuICAgICAgKTtcbiAgICB9XG4gIH1cbiAgcHJpdmF0ZSBhY3RpdmF0ZWRDb25maWc/OiBQYXJ0aWFsPFQ+O1xuXG4gIHByaXZhdGUgZmV0Y2hlZENvbmZpZz86IFBhcnRpYWw8VD47XG5cbiAgcHJpdmF0ZSByZWFkb25seSBjb250ZXh0OiBSZW1vdGVDb25maWdDb250ZXh0O1xuXG4gIHByaXZhdGUgcmVhZG9ubHkgZGVmYXVsdENvbmZpZzogVDtcblxuICBwcml2YXRlIHJlYWRvbmx5IGV4dHJhY3RlZFR5cGU6IE9iamVjdFZhbHVlVHlwZURlc2NyaXB0b3I7XG5cbiAgcHJpdmF0ZSByZWFkb25seSB0YWdzID0gbmV3IFNldDxzdHJpbmc+KCk7XG5cbiAgYWN0aXZhdGUoKTogdm9pZCB7XG4gICAgdGhpcy5hY3RpdmF0ZWRDb25maWcgPSBPYmplY3QuYXNzaWduKHt9LCB0aGlzLmZldGNoZWRDb25maWcpO1xuICB9XG5cbiAgYWRkQ3VzdG9tVGFnKHRhZzogc3RyaW5nKTogdm9pZCB7XG4gICAgY29uc3Qgbm9ybWFsaXplZFRhZyA9IFJlbW90ZUNvbmZpZy5ub3JtYWxpemVUYWcodGFnKTtcblxuICAgIGlmIChub3JtYWxpemVkVGFnLmxlbmd0aCA9PT0gMCkge1xuICAgICAgY29uc29sZS53YXJuKGBbcmVtb3RlLWNvbmZpZ10gQ291bGQgbm90IGFkZCB0aGUgdGFnOiBgICsgYEEgdGFnIG11c3QgYmUgYSBub24tZW1wdHkgc3RyaW5nLmApO1xuXG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy50YWdzLmFkZChub3JtYWxpemVkVGFnKTtcbiAgfVxuXG4gIHJlbW92ZUN1c3RvbVRhZyh0YWc6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IG5vcm1hbGl6ZWRUYWcgPSBSZW1vdGVDb25maWcubm9ybWFsaXplVGFnKHRhZyk7XG5cbiAgICBpZiAobm9ybWFsaXplZFRhZy5sZW5ndGggPT09IDApIHtcbiAgICAgIGNvbnNvbGUud2FybihgW3JlbW90ZS1jb25maWddIENvdWxkIG5vdCBkZWxldGUgdGhlIHRhZzogYCArIGBBIHRhZyBtdXN0IGJlIGEgbm9uLWVtcHR5IHN0cmluZy5gKTtcblxuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLnRhZ3MuZGVsZXRlKG5vcm1hbGl6ZWRUYWcpO1xuICB9XG5cbiAgY2xlYXJDdXN0b21UYWdzKCkge1xuICAgIHRoaXMudGFncy5jbGVhcigpO1xuICB9XG5cbiAgYXN5bmMgZmV0Y2goKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgcHJvamVjdE5hbWUgPSB0aGlzLmNvbnRleHQucHJvamVjdE5hbWU7XG4gICAgY29uc3Qgc2VydmljZVJvb3QgPSB0aGlzLmNvbnRleHQuc2VydmljZVJvb3Q7XG5cbiAgICBjb25zdCB1cmwgPSBgJHtzZXJ2aWNlUm9vdH0vY2xpZW50LWFwaS92MS9wcm9qZWN0cy8ke3Byb2plY3ROYW1lfS9wYXJhbWV0ZXJzYDtcblxuICAgIGNvbnN0IGhlYWRlcnMgPSB7XG4gICAgICAnQXBwbGljYXRpb24tTmFtZSc6IHRoaXMuY29udGV4dC5hcHBOYW1lLFxuICAgICAgJ0FwcGxpY2F0aW9uLVZlcnNpb24nOiB0aGlzLmNvbnRleHQuYXBwVmVyc2lvbixcbiAgICAgICdDdXN0b20tVGFncyc6IEFycmF5LmZyb20odGhpcy50YWdzKS5qb2luKCcsJyksXG4gICAgfTtcblxuICAgIHRyeSB7XG4gICAgICB0aGlzLmZldGNoZWRDb25maWcgPSBhd2FpdCB0aGlzLmNvbmZpZ0ZldGNoZXIuZmV0Y2goe1xuICAgICAgICBoZWFkZXJzLFxuICAgICAgICB1cmwsXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS53YXJuKGBbcmVtb3RlLWNvbmZpZ10gQ291bGQgbm90IGZldGNoIHRoZSByZW1vdGUgY29uZmlnOmAsIGVycm9yKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBmZXRjaEFuZEFjdGl2YXRlKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGF3YWl0IHRoaXMuZmV0Y2goKTtcbiAgICB0aGlzLmFjdGl2YXRlKCk7XG4gIH1cblxuICBnZXRWYWx1ZTxLIGV4dGVuZHMga2V5b2YgVCAmIHN0cmluZz4ocGFyYW1ldGVyTmFtZTogSyk6IFRbS10gfCBudWxsIHtcbiAgICBjb25zdCByZW1vdGVWYWx1ZSA9IHRoaXMuZ2V0UmVtb3RlVmFsdWUocGFyYW1ldGVyTmFtZSk7XG5cbiAgICBpZiAocmVtb3RlVmFsdWUgaW5zdGFuY2VvZiBQYXJzZVN1Y2Nlc3MpIHtcbiAgICAgIHJldHVybiByZW1vdGVWYWx1ZS5yZXN1bHQ7XG4gICAgfVxuXG4gICAgaWYgKHJlbW90ZVZhbHVlIGluc3RhbmNlb2YgUGFyc2VGYWlsdXJlKSB7XG4gICAgICBjb25zb2xlLndhcm4oXG4gICAgICAgIGBbcmVtb3RlLWNvbmZpZ10gRmFpbGVkIHRvIHBhcnNlIHRoZSByZW1vdGUgdmFsdWUgYCArXG4gICAgICAgICAgYG9mIHRoZSBwYXJhbWV0ZXIgXCIke3BhcmFtZXRlck5hbWV9XCIuIGAgK1xuICAgICAgICAgIGBSZWFzb246ICR7cmVtb3RlVmFsdWUucmVhc29ufWAsXG4gICAgICApO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLmdldERlZmF1bHRWYWx1ZShwYXJhbWV0ZXJOYW1lKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0RGVmYXVsdFZhbHVlPEsgZXh0ZW5kcyBrZXlvZiBUICYgc3RyaW5nPihwYXJhbWV0ZXJOYW1lOiBLKTogVFtLXSB8IG51bGwge1xuICAgIGlmIChoYXNQcm9wZXJ0eSh0aGlzLmRlZmF1bHRDb25maWcsIHBhcmFtZXRlck5hbWUpKSB7XG4gICAgICBjb25zdCBkZWZhdWx0VmFsdWUgPSB0aGlzLmRlZmF1bHRDb25maWdbcGFyYW1ldGVyTmFtZV07XG5cbiAgICAgIHJldHVybiBpc051bGxPclVuZGVmaW5lZChkZWZhdWx0VmFsdWUpID8gbnVsbCA6IGRlZmF1bHRWYWx1ZTtcbiAgICB9XG5cbiAgICBjb25zb2xlLndhcm4oXG4gICAgICBgW3JlbW90ZS1jb25maWddIENvdWxkIG5vdCBnZXQgYSBkZWZhdWx0IHZhbHVlLiBgICtcbiAgICAgICAgYFRoZSBwYXJhbWV0ZXIgJyR7cGFyYW1ldGVyTmFtZX0nIGlzIG5vdCBwcmVzZW50IGluIHRoZSBkZWZhdWx0IGNvbmZpZy5gLFxuICAgICk7XG5cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0UmF3UmVtb3RlVmFsdWU8SyBleHRlbmRzIGtleW9mIFQgJiBzdHJpbmc+KHBhcmFtZXRlck5hbWU6IEspOiB1bmtub3duIHwgdW5kZWZpbmVkIHtcbiAgICBpZiAodGhpcy5hY3RpdmF0ZWRDb25maWcgJiYgaGFzUHJvcGVydHkodGhpcy5hY3RpdmF0ZWRDb25maWcsIHBhcmFtZXRlck5hbWUpKSB7XG4gICAgICByZXR1cm4gdGhpcy5hY3RpdmF0ZWRDb25maWdbcGFyYW1ldGVyTmFtZV07XG4gICAgfVxuXG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0UmVtb3RlVmFsdWU8SyBleHRlbmRzIGtleW9mIFQgJiBzdHJpbmc+KHBhcmFtZXRlck5hbWU6IEspOiBQYXJzZVJlc3VsdDxUW0tdLCBQYXJzZUVycm9yPiB8IG51bGwge1xuICAgIGNvbnN0IHJhd1JlbW90ZVZhbHVlID0gdGhpcy5nZXRSYXdSZW1vdGVWYWx1ZShwYXJhbWV0ZXJOYW1lKTtcblxuICAgIHJldHVybiAhaXNVbmRlZmluZWQocmF3UmVtb3RlVmFsdWUpID8gdGhpcy5wYXJzZVJlbW90ZVZhbHVlKHJhd1JlbW90ZVZhbHVlLCBwYXJhbWV0ZXJOYW1lKSA6IG51bGw7XG4gIH1cblxuICBwcml2YXRlIHBhcnNlUmVtb3RlVmFsdWU8SyBleHRlbmRzIGtleW9mIFQgJiBzdHJpbmc+KFxuICAgIHJhd1JlbW90ZVZhbHVlOiB1bmtub3duLFxuICAgIHBhcmFtZXRlck5hbWU6IEssXG4gICk6IFBhcnNlUmVzdWx0PFRbS10sIFBhcnNlRXJyb3I+IHtcbiAgICBjb25zdCB2YWx1ZVR5cGUgPSB0aGlzLmV4dHJhY3RlZFR5cGUucHJvcGVydGllc1twYXJhbWV0ZXJOYW1lXTtcblxuICAgIGlmICghdmFsdWVUeXBlKSB7XG4gICAgICByZXR1cm4gUGFyc2VGYWlsdXJlLmNyZWF0ZShQYXJzZUVycm9yLlVua25vd25Qcm9wZXJ0eVR5cGUpO1xuICAgIH1cblxuICAgIHJldHVybiB2YWx1ZVBhcnNlci5wYXJzZUFzPFRbS10+KHJhd1JlbW90ZVZhbHVlLCB2YWx1ZVR5cGUpO1xuICB9XG59XG4iXX0=