{"version":3,"file":"iban.directive.js","sourceRoot":"","sources":["../../../../../../../libs/payment-orders-ang/src/lib/ui/directives/iban.directive.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  ChangeDetectorRef,\n  Directive,\n  Input,\n  OnDestroy,\n  OnInit,\n  ElementRef,\n} from '@angular/core';\nimport { NgControl } from '@angular/forms';\nimport { Subject } from 'rxjs';\nimport { distinctUntilChanged, filter, takeUntil, delay } from 'rxjs/operators';\n\n@Directive({\n  selector: '[bbIban]',\n})\nexport class IbanDirective implements OnInit, OnDestroy {\n  /**\n   * The max length for the IBAN number, mostly 34\n   */\n  @Input() maxLen = 34;\n  private value = '';\n  private readonly editPositionRestorer$ = new Subject<number>();\n  private readonly garbageCollector$ = new Subject<void>();\n  private readonly transformValue = (value: string, max: number) => {\n    if (!value) {\n      return value;\n    }\n    const format = (v: string) => v.replace(/(.{4})/g, '$1 ').trim();\n    const rawResult = value.toUpperCase().replace(/[^a-z0-9]/gi, '');\n    return rawResult.length > max\n      ? format(rawResult.slice(0, max))\n      : format(rawResult);\n  };\n\n  constructor(\n    private readonly el: ElementRef,\n    private readonly ngControl: NgControl,\n    private readonly changeDetectorRef: ChangeDetectorRef\n  ) {}\n\n  ngOnInit(): void {\n    if (!this.ngControl || !this.ngControl.control) {\n      return;\n    }\n    const control = this.ngControl.control;\n    const ibanInputEl = this.el.nativeElement.querySelector('input');\n\n    control.valueChanges\n      .pipe(\n        distinctUntilChanged(),\n        filter((value: string) => {\n          const alphaNumericRegex = /^[a-zA-Z0-9 ]{5,}$/; //Only format string with valid iban chars\n          return value !== this.value && alphaNumericRegex.test(value);\n        }),\n        takeUntil(this.garbageCollector$)\n      )\n      .subscribe((value: string) => {\n        let pos: number = ibanInputEl.selectionStart;\n        const transformedValue = this.transformValue(value, this.maxLen);\n        if (\n          value &&\n          value.substring(0, pos) !== transformedValue.substring(0, pos)\n        ) {\n          pos++;\n        }\n        this.changeDetectorRef.detectChanges();\n        control.setValue(transformedValue);\n        control.updateValueAndValidity();\n        this.value = transformedValue;\n        this.changeDetectorRef.detectChanges();\n        this.editPositionRestorer$.next(pos);\n      });\n\n    this.editPositionRestorer$.pipe(delay(1)).subscribe((position: number) => {\n      ibanInputEl.setSelectionRange(position, position);\n    });\n  }\n\n  ngOnDestroy(): void {\n    this.editPositionRestorer$.unsubscribe();\n\n    if (this.garbageCollector$) {\n      this.garbageCollector$.next();\n      this.garbageCollector$.complete();\n    }\n  }\n}\n"]}