import { Component, EventEmitter, Output } from '@angular/core';
import { BehaviorSubject, combineLatest, EMPTY, Subject } from 'rxjs';
import { map, pluck, takeUntil } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "../../services/shared-methods/shared-methods.service";
import * as i2 from "@angular/router";
import * as i3 from "./base-conversations-list-properties.service";
export class BaseConversationsListWidgetComponent {
    constructor(shared, activatedRoute, properties) {
        this.shared = shared;
        this.activatedRoute = activatedRoute;
        this.properties = properties;
        /**
         * Emits id of the selected conversation
         */
        this.conversationId = new EventEmitter();
        /**
         * Emits filter object to keep widget filter params
         */
        this.filter = new EventEmitter();
        /**
         * The `Unsubscribe` subject.
         */
        this.unsubscribe$ = new Subject();
        /**
         * The loading parameter indicating the starting page for the data to be loaded from.
         */
        this.from$ = new BehaviorSubject(0);
        /**
         * The parameters object with the starting page number.
         */
        this.filterParams = {
            from: 0,
        };
        /**
         * The parameters subject with applied filters.
         */
        this.filterParams$ = this.getRouteParam(this.activatedRoute, 'filter').pipe(takeUntil(this.unsubscribe$), map(params => {
            if (params) {
                try {
                    return JSON.parse(params);
                }
                catch (err) { }
            }
            return {};
        }));
    }
    /**
     * The method to change the page and load conversations corresponding to that page.
     *
     * @param page Page number
     */
    onPageChange(page) {
        if (page || page === 0) {
            this.from$.next(page);
            this.filterParams.from = page;
            this.emitFilterParams(this.filterParams);
        }
    }
    /**
     * The method to switch to another mailbox type and load corresponding data.
     *
     * @param mailbox Mailbox type
     */
    onMailboxApply(mailbox) {
        this.from$.next(0);
        this.filterParams = this.setMailboxTypedParams(mailbox);
        this.emitFilterParams(this.filterParams);
    }
    /**
     * The method to fetch conversation list according to the applied filter parameters.
     *
     * @param obj Filter params
     */
    onFilterFormApply(obj) {
        this.from$.next(0);
        this.filterParams = this.setFilterFormParams(obj);
        this.emitFilterParams(this.filterParams);
    }
    /**
     * The method to open the draft thread.
     *
     * @param draft Draft data
     */
    openDraft(draft) {
        if ('conversationId' in draft) {
            this.conversationId.emit(draft.conversationId);
        }
        else {
            this.properties.createMessageOpenEventName
                .pipe(takeUntil(this.unsubscribe$))
                .subscribe(eventName => this.shared.eventBusPublish(eventName, { draftId: draft.id }));
        }
    }
    /**
     * The method to open the conversation thread.
     *
     * @param conversation Conversation data
     */
    openConversation(conversation) {
        this.conversationId.emit(typeof conversation === 'string' ? conversation : conversation.id);
    }
    /**
     * The method to open the error notification.
     *
     * @param error Http error response
     */
    showErrorNotification(error) {
        this.shared.openNotification(this.shared.getErrorMessage(error), 'error');
        return EMPTY;
    }
    ngOnDestroy() {
        this.unsubscribe$.next();
        this.unsubscribe$.complete();
    }
    /**
     * The method to emit the filtering parameters.
     *
     * @param filterParams Filter params data
     */
    emitFilterParams(filterParams) {
        const params = JSON.stringify(filterParams);
        this.filter.emit(params);
    }
    setMailboxTypedParams(mailboxType) {
        return {
            from: 0,
            mailboxType,
        };
    }
    setFilterFormParams(filterParams) {
        return Object.assign({ from: 0 }, filterParams);
    }
    getRouteParam(route, param) {
        const paramValue = route.paramMap.pipe(pluck('params', param));
        if (!route.parent) {
            return paramValue;
        }
        return combineLatest([paramValue, this.getRouteParam(route.parent, param)]).pipe(map(params => params[0] || params[1]));
    }
}
BaseConversationsListWidgetComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.14", ngImport: i0, type: BaseConversationsListWidgetComponent, deps: [{ token: i1.SharedMethodsService }, { token: i2.ActivatedRoute }, { token: i3.BaseConversationsListPropertiesService }], target: i0.ɵɵFactoryTarget.Component });
BaseConversationsListWidgetComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "12.0.0", version: "12.2.14", type: BaseConversationsListWidgetComponent, selector: "ng-component", outputs: { conversationId: "conversationId", filter: "filter" }, ngImport: i0, template: '', isInline: true });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.14", ngImport: i0, type: BaseConversationsListWidgetComponent, decorators: [{
            type: Component,
            args: [{
                    template: '',
                }]
        }], ctorParameters: function () { return [{ type: i1.SharedMethodsService }, { type: i2.ActivatedRoute }, { type: i3.BaseConversationsListPropertiesService }]; }, propDecorators: { conversationId: [{
                type: Output
            }], filter: [{
                type: Output
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZS1jb252ZXJzYXRpb25zLWxpc3Qtd2lkZ2V0LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL2xpYnMvbWVzc2FnZXMtY29tbW9uL3NyYy9jb21wb25lbnRzL2NvbnZlcnNhdGlvbnMtbGlzdC9iYXNlLWNvbnZlcnNhdGlvbnMtbGlzdC13aWRnZXQuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsWUFBWSxFQUFhLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUczRSxPQUFPLEVBQUUsZUFBZSxFQUFFLGFBQWEsRUFBRSxLQUFLLEVBQWMsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ2xGLE9BQU8sRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDOzs7OztBQVF2RCxNQUFNLE9BQU8sb0NBQW9DO0lBaUQvQyxZQUNXLE1BQTRCLEVBQzVCLGNBQThCLEVBQzlCLFVBQWtEO1FBRmxELFdBQU0sR0FBTixNQUFNLENBQXNCO1FBQzVCLG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtRQUM5QixlQUFVLEdBQVYsVUFBVSxDQUF3QztRQW5EN0Q7O1dBRUc7UUFDTyxtQkFBYyxHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7UUFFOUM7O1dBRUc7UUFDTyxXQUFNLEdBQUcsSUFBSSxZQUFZLEVBQVUsQ0FBQztRQU85Qzs7V0FFRztRQUNNLGlCQUFZLEdBQUcsSUFBSSxPQUFPLEVBQVcsQ0FBQztRQUUvQzs7V0FFRztRQUNNLFVBQUssR0FBRyxJQUFJLGVBQWUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUV4Qzs7V0FFRztRQUNILGlCQUFZLEdBQWlCO1lBQzNCLElBQUksRUFBRSxDQUFDO1NBQ1IsQ0FBQztRQUVGOztXQUVHO1FBQ00sa0JBQWEsR0FBNkIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENB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U0FBUyxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBRTVDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQzNCLENBQUM7SUFFTyxxQkFBcUIsQ0FBQyxXQUFtQjtRQUMvQyxPQUFPO1lBQ0wsSUFBSSxFQUFFLENBQUM7WUFDUCxXQUFXO1NBQ1osQ0FBQztJQUNKLENBQUM7SUFFTyxtQkFBbUIsQ0FBQyxZQUErQjtRQUN6RCx1QkFDRSxJQUFJLEVBQUUsQ0FBQyxJQUNKLFlBQVksRUFDZjtJQUNKLENBQUM7SUFFTyxhQUFhLENBQUMsS0FBcUIsRUFBRSxLQUFhO1FBQ3hELE1BQU0sVUFBVSxHQUFHLEtBQUssQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBMEIsUUFBUSxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUM7UUFFeEYsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUU7WUFDakIsT0FBTyxVQUFVLENBQUM7U0FDbkI7UUFFRCxPQUFPLGFBQWEsQ0FBQyxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FDOUUsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUN0QyxDQUFDO0lBQ0osQ0FBQzs7a0lBcktVLG9DQUFvQztzSEFBcEMsb0NBQW9DLHFIQUZyQyxFQUFFOzRGQUVELG9DQUFvQztrQkFIaEQsU0FBUzttQkFBQztvQkFDVCxRQUFRLEVBQUUsRUFBRTtpQkFDYjs2TEFLVyxjQUFjO3NCQUF2QixNQUFNO2dCQUtHLE1BQU07c0JBQWYsTUFBTSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgRXZlbnRFbWl0dGVyLCBPbkRlc3Ryb3ksIE91dHB1dCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgSHR0cEVycm9yUmVzcG9uc2UgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQgeyBBY3RpdmF0ZWRSb3V0ZSwgUGFyYW1NYXAgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0LCBjb21iaW5lTGF0ZXN0LCBFTVBUWSwgT2JzZXJ2YWJsZSwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgbWFwLCBwbHVjaywgdGFrZVVudGlsIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgQ29udmVyc2F0aW9uVGhyZWFkLCBNZXNzYWdlRHJhZnRzR2V0UmVzcG9uc2VCb2R5IH0gZnJvbSAnQGJhY2tiYXNlL21lc3NhZ2VzLXY1LWh0dHAtYW5nJztcbmltcG9ydCB7IFNoYXJlZE1ldGhvZHNTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vc2VydmljZXMvc2hhcmVkLW1ldGhvZHMvc2hhcmVkLW1ldGhvZHMuc2VydmljZSc7XG5pbXBvcnQgeyBBcHBseUZpbHRlclBhcmFtcywgRmlsdGVyUGFyYW1zLCBNYWlsYm94VHlwZSB9IGZyb20gJy4vbW9kZWwvcGFyYW1zLm1vZGVsJztcbmltcG9ydCB7IEJhc2VDb252ZXJzYXRpb25zTGlzdFByb3BlcnRpZXNTZXJ2aWNlIH0gZnJvbSAnLi9iYXNlLWNvbnZlcnNhdGlvbnMtbGlzdC1wcm9wZXJ0aWVzLnNlcnZpY2UnO1xuQENvbXBvbmVudCh7XG4gIHRlbXBsYXRlOiAnJyxcbn0pXG5leHBvcnQgY2xhc3MgQmFzZUNvbnZlcnNhdGlvbnNMaXN0V2lkZ2V0Q29tcG9uZW50IGltcGxlbWVudHMgT25EZXN0cm95IHtcbiAgLyoqXG4gICAqIEVtaXRzIGlkIG9mIHRoZSBzZWxlY3RlZCBjb252ZXJzYXRpb25cbiAgICovXG4gIEBPdXRwdXQoKSBjb252ZXJzYXRpb25JZCA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcblxuICAvKipcbiAgICogRW1pdHMgZmlsdGVyIG9iamVjdCB0byBrZWVwIHdpZGdldCBmaWx0ZXIgcGFyYW1zXG4gICAqL1xuICBAT3V0cHV0KCkgZmlsdGVyID0gbmV3IEV2ZW50RW1pdHRlcjxzdHJpbmc+KCk7XG5cbiAgLyoqXG4gICAqIFRoZSBlcnJvciByZXNwb25zZSBpbmZvcm1hdGlvbi5cbiAgICovXG4gIGVycm9yUmVzcG9uc2U6IEh0dHBFcnJvclJlc3BvbnNlIHwgdW5kZWZpbmVkO1xuXG4gIC8qKlxuICAgKiBUaGUgYFVuc3Vic2NyaWJlYCBzdWJqZWN0LlxuICAgKi9cbiAgcmVhZG9ubHkgdW5zdWJzY3JpYmUkID0gbmV3IFN1YmplY3Q8Ym9vbGVhbj4oKTtcblxuICAvKipcbiAgICogVGhlIGxvYWRpbmcgcGFyYW1ldGVyIGluZGljYXRpbmcgdGhlIHN0YXJ0aW5nIHBhZ2UgZm9yIHRoZSBkYXRhIHRvIGJlIGxvYWRlZCBmcm9tLlxuICAgKi9cbiAgcmVhZG9ubHkgZnJvbSQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0KDApO1xuXG4gIC8qKlxuICAgKiBUaGUgcGFyYW1ldGVycyBvYmplY3Qgd2l0aCB0aGUgc3RhcnRpbmcgcGFnZSBudW1iZXIuXG4gICAqL1xuICBmaWx0ZXJQYXJhbXM6IEZpbHRlclBhcmFtcyA9IHtcbiAgICBmcm9tOiAwLFxuICB9O1xuXG4gIC8qKlxuICAgKiBUaGUgcGFyYW1ldGVycyBzdWJqZWN0IHdpdGggYXBwbGllZCBmaWx0ZXJzLlxuICAgKi9cbiAgcmVhZG9ubHkgZmlsdGVyUGFyYW1zJDogT2JzZXJ2YWJsZTxGaWx0ZXJQYXJhbXM+ID0gdGhpcy5nZXRSb3V0ZVBhcmFtKHRoaXMuYWN0aXZhdGVkUm91dGUsICdmaWx0ZXInKS5waXBlKFxuICAgIHRha2VVbnRpbCh0aGlzLnVuc3Vic2NyaWJlJCksXG4gICAgbWFwKHBhcmFtcyA9PiB7XG4gICAgICBpZiAocGFyYW1zKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgcmV0dXJuIEpTT04ucGFyc2UocGFyYW1zKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7fVxuICAgICAgfVxuXG4gICAgICByZXR1cm4ge307XG4gICAgfSksXG4gICk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcmVhZG9ubHkgc2hhcmVkOiBTaGFyZWRNZXRob2RzU2VydmljZSxcbiAgICByZWFkb25seSBhY3RpdmF0ZWRSb3V0ZTogQWN0aXZhdGVkUm91dGUsXG4gICAgcmVhZG9ubHkgcHJvcGVydGllczogQmFzZUNvbnZlcnNhdGlvbnNMaXN0UHJvcGVydGllc1NlcnZpY2UsXG4gICkge31cblxuICAvKipcbiAgICogVGhlIG1ldGhvZCB0byBjaGFuZ2UgdGhlIHBhZ2UgYW5kIGxvYWQgY29udmVyc2F0aW9ucyBjb3JyZXNwb25kaW5nIHRvIHRoYXQgcGFnZS5cbiAgICpcbiAgICogQHBhcmFtIHBhZ2UgUGFnZSBudW1iZXJcbiAgICovXG4gIG9uUGFnZUNoYW5nZShwYWdlPzogbnVtYmVyKSB7XG4gICAgaWYgKHBhZ2UgfHwgcGFnZSA9PT0gMCkge1xuICAgICAgdGhpcy5mcm9tJC5uZXh0KHBhZ2UpO1xuICAgICAgdGhpcy5maWx0ZXJQYXJhbXMuZnJvbSA9IHBhZ2U7XG4gICAgICB0aGlzLmVtaXRGaWx0ZXJQYXJhbXModGhpcy5maWx0ZXJQYXJhbXMpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBUaGUgbWV0aG9kIHRvIHN3aXRjaCB0byBhbm90aGVyIG1haWxib3ggdHlwZSBhbmQgbG9hZCBjb3JyZXNwb25kaW5nIGRhdGEuXG4gICAqXG4gICAqIEBwYXJhbSBtYWlsYm94IE1haWxib3ggdHlwZVxuICAgKi9cbiAgb25NYWlsYm94QXBwbHkobWFpbGJveDogTWFpbGJveFR5cGUpIHtcbiAgICB0aGlzLmZyb20kLm5leHQoMCk7XG4gICAgdGhpcy5maWx0ZXJQYXJhbXMgPSB0aGlzLnNldE1haWxib3hUeXBlZFBhcmFtcyhtYWlsYm94KTtcbiAgICB0aGlzLmVtaXRGaWx0ZXJQYXJhbXModGhpcy5maWx0ZXJQYXJhbXMpO1xuICB9XG5cbiAgLyoqXG4gICAqIFRoZSBtZXRob2QgdG8gZmV0Y2ggY29udmVyc2F0aW9uIGxpc3QgYWNjb3JkaW5nIHRvIHRoZSBhcHBsaWVkIGZpbHRlciBwYXJhbWV0ZXJzLlxuICAgKlxuICAgKiBAcGFyYW0gb2JqIEZpbHRlciBwYXJhbXNcbiAgICovXG4gIG9uRmlsdGVyRm9ybUFwcGx5KG9iajogQXBwbHlGaWx0ZXJQYXJhbXMpIHtcbiAgICB0aGlzLmZyb20kLm5leHQoMCk7XG4gICAgdGhpcy5maWx0ZXJQYXJhbXMgPSB0aGlzLnNldEZpbHRlckZvcm1QYXJhbXMob2JqKTtcbiAgICB0aGlzLmVtaXRGaWx0ZXJQYXJhbXModGhpcy5maWx0ZXJQYXJhbXMpO1xuICB9XG5cbiAgLyoqXG4gICAqIFRoZSBtZXRob2QgdG8gb3BlbiB0aGUgZHJhZnQgdGhyZWFkLlxuICAgKlxuICAgKiBAcGFyYW0gZHJhZnQgRHJhZnQgZGF0YVxuICAgKi9cbiAgb3BlbkRyYWZ0KGRyYWZ0OiBDb252ZXJzYXRpb25UaHJlYWQgfCBNZXNzYWdlRHJhZnRzR2V0UmVzcG9uc2VCb2R5KSB7XG4gICAgaWYgKCdjb252ZXJzYXRpb25JZCcgaW4gZHJhZnQpIHtcbiAgICAgIHRoaXMuY29udmVyc2F0aW9uSWQuZW1pdChkcmFmdC5jb252ZXJzYXRpb25JZCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMucHJvcGVydGllcy5jcmVhdGVNZXNzYWdlT3BlbkV2ZW50TmFtZVxuICAgICAgICAucGlwZSh0YWtlVW50aWwodGhpcy51bnN1YnNjcmliZSQpKVxuICAgICAgICAuc3Vic2NyaWJlKGV2ZW50TmFtZSA9PiB0aGlzLnNoYXJlZC5ldmVudEJ1c1B1Ymxpc2goZXZlbnROYW1lLCB7IGRyYWZ0SWQ6IGRyYWZ0LmlkIH0pKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVGhlIG1ldGhvZCB0byBvcGVuIHRoZSBjb252ZXJzYXRpb24gdGhyZWFkLlxuICAgKlxuICAgKiBAcGFyYW0gY29udmVyc2F0aW9uIENvbnZlcnNhdGlvbiBkYXRhXG4gICAqL1xuICBvcGVuQ29udmVyc2F0aW9uKGNvbnZlcnNhdGlvbjogQ29udmVyc2F0aW9uVGhyZWFkIHwgc3RyaW5nKSB7XG4gICAgdGhpcy5jb252ZXJzYXRpb25JZC5lbWl0KHR5cGVvZiBjb252ZXJzYXRpb24gPT09ICdzdHJpbmcnID8gY29udmVyc2F0aW9uIDogY29udmVyc2F0aW9uLmlkKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUaGUgbWV0aG9kIHRvIG9wZW4gdGhlIGVycm9yIG5vdGlmaWNhdGlvbi5cbiAgICpcbiAgICogQHBhcmFtIGVycm9yIEh0dHAgZXJyb3IgcmVzcG9uc2VcbiAgICovXG4gIHNob3dFcnJvck5vdGlmaWNhdGlvbihlcnJvcjogSHR0cEVycm9yUmVzcG9uc2UpIHtcbiAgICB0aGlzLnNoYXJlZC5vcGVuTm90aWZpY2F0aW9uKHRoaXMuc2hhcmVkLmdldEVycm9yTWVzc2FnZShlcnJvciksICdlcnJvcicpO1xuXG4gICAgcmV0dXJuIEVNUFRZO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgdGhpcy51bnN1YnNjcmliZSQubmV4dCgpO1xuICAgIHRoaXMudW5zdWJzY3JpYmUkLmNvbXBsZXRlKCk7XG4gIH1cblxuICAvKipcbiAgICogVGhlIG1ldGhvZCB0byBlbWl0IHRoZSBmaWx0ZXJpbmcgcGFyYW1ldGVycy5cbiAgICpcbiAgICogQHBhcmFtIGZpbHRlclBhcmFtcyBGaWx0ZXIgcGFyYW1zIGRhdGFcbiAgICovXG4gIGVtaXRGaWx0ZXJQYXJhbXMoZmlsdGVyUGFyYW1zOiBGaWx0ZXJQYXJhbXMpIHtcbiAgICBjb25zdCBwYXJhbXMgPSBKU09OLnN0cmluZ2lmeShmaWx0ZXJQYXJhbXMpO1xuXG4gICAgdGhpcy5maWx0ZXIuZW1pdChwYXJhbXMpO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXRNYWlsYm94VHlwZWRQYXJhbXMobWFpbGJveFR5cGU6IHN0cmluZykge1xuICAgIHJldHVybiB7XG4gICAgICBmcm9tOiAwLFxuICAgICAgbWFpbGJveFR5cGUsXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgc2V0RmlsdGVyRm9ybVBhcmFtcyhmaWx0ZXJQYXJhbXM6IEFwcGx5RmlsdGVyUGFyYW1zKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGZyb206IDAsXG4gICAgICAuLi5maWx0ZXJQYXJhbXMsXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0Um91dGVQYXJhbShyb3V0ZTogQWN0aXZhdGVkUm91dGUsIHBhcmFtOiBzdHJpbmcpOiBPYnNlcnZhYmxlPHN0cmluZyB8IG51bGw+IHtcbiAgICBjb25zdCBwYXJhbVZhbHVlID0gcm91dGUucGFyYW1NYXAucGlwZShwbHVjazxQYXJhbU1hcCwgc3RyaW5nIHwgbnVsbD4oJ3BhcmFtcycsIHBhcmFtKSk7XG5cbiAgICBpZiAoIXJvdXRlLnBhcmVudCkge1xuICAgICAgcmV0dXJuIHBhcmFtVmFsdWU7XG4gICAgfVxuXG4gICAgcmV0dXJuIGNvbWJpbmVMYXRlc3QoW3BhcmFtVmFsdWUsIHRoaXMuZ2V0Um91dGVQYXJhbShyb3V0ZS5wYXJlbnQsIHBhcmFtKV0pLnBpcGUoXG4gICAgICBtYXAocGFyYW1zID0+IHBhcmFtc1swXSB8fCBwYXJhbXNbMV0pLFxuICAgICk7XG4gIH1cbn1cbiJdfQ==