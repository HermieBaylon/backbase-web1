import { Component, EventEmitter, Input, Output, ViewChild, } from '@angular/core';
import { Validators } from '@angular/forms';
import { BehaviorSubject, EMPTY, of, Subject } from 'rxjs';
import { filter, finalize, first, map, switchMap, takeUntil } from 'rxjs/operators';
import { ManipulationType, } from '../../messages-manipulation-confirm-modal/manipulation-confirm-modal-types.model';
import { MessagesManipulationConfirmModalService } from '../../messages-manipulation-confirm-modal/messages-manipulation-confirm-modal.service';
import { MessagesUploadAttachmentsService } from '../../upload-attachments/services/messages-upload-attachments.service';
import * as i0 from "@angular/core";
import * as i1 from "../../../services/shared-methods/shared-methods.service";
import * as i2 from "../../messages-manipulation-confirm-modal/messages-manipulation-confirm-modal.service";
import * as i3 from "./base-create-message-form.service";
import * as i4 from "@angular/forms";
import * as i5 from "../../../services/messages-encoding/messages-encoding.service";
import * as i6 from "../../upload-attachments/services/messages-upload-attachments.service";
export class BaseCreateMessageFormComponent {
    constructor(sharedService, confirmModalService, cd, createMessageFormService, fb, encodingService, uploadService) {
        this.sharedService = sharedService;
        this.confirmModalService = confirmModalService;
        this.cd = cd;
        this.createMessageFormService = createMessageFormService;
        this.fb = fb;
        this.encodingService = encodingService;
        this.uploadService = uploadService;
        /**
         * The event that's fired after confirm button is pressed.
         */
        this.confirm = new EventEmitter();
        /**
         * The event that's fired after cancel button is pressed.
         */
        this.cancel = new EventEmitter();
        this.hostRef = this;
        /**
         * Confirmation modal parameters.
         */
        this.confirmationModal = {
            opened: false,
            type: undefined,
        };
        /**
         * The flag indicating if the form is loading.
         */
        this.formLoading = false;
        this.topics$ = new BehaviorSubject(undefined);
        /**
         * The stream with topics.
         */
        this.topics = this.topics$.asObservable();
        /**
         * The manipulationType enum ( `resolve`, `unresolve`, `assign`, `unassign`, `discard`,
         * `discardDraft`, `discardPreview`, `deleteTopic`, `deleteMailout`)
         */
        this.manipulationTypes = ManipulationType;
        this.unsubscribe$ = new Subject();
        this.draftId$ = new BehaviorSubject(undefined);
        this.newMessageFormGroup = this.fb.group({
            topic: ['', Validators.required],
            subject: ['', Validators.required],
            body: ['', Validators.required],
            attachments: [],
        });
    }
    /**
     * Input draft id to get draft and prefill compose form with it
     */
    set draftId(value) {
        this.draftId$.next(value);
    }
    /**
     * The draft ID getter.
     */
    get draftId() {
        return this.draftId$.getValue();
    }
    ngOnInit() {
        if (this.reset) {
            this.reset.pipe(takeUntil(this.unsubscribe$)).subscribe(() => {
                this.confirmModalService.toggleModal(true, this.manipulationTypes.discard, this.newMessageFormGroup, this.draftFormValue);
            });
        }
        this.createMessageFormService.getTopics().subscribe(res => {
            this.restoreTopicSelection(res);
            this.topics$.next(res);
        });
        this.draftId$
            .pipe(filter(id => !!(id && id.length)), switchMap(id => this.getDrafts(id)))
            .subscribe();
        this.confirmModalService.emitToggleModal$.pipe(takeUntil(this.unsubscribe$)).subscribe(({ opened, type }) => {
            this.confirmationModal = { opened, type };
            if (!opened && type === ManipulationType.discard) {
                this.onCancel();
            }
            this.cd.detectChanges();
        });
    }
    /**
     * The method to get a simple value from the form.
     *
     * @param simpleFormModel Message data
     */
    getSimpleFormVal({ body, subject, topic, attachments }) {
        return Object.assign(Object.assign(Object.assign(Object.assign({}, (body && body.length && { body: this.encodingService.b64Encode(body) })), (subject && subject.length && { subject })), (topic && topic.id && { topic: topic.id })), (attachments && attachments.length && { attachments: attachments.map(item => item.id) }));
    }
    resetFormOnElementBlur() {
        if (!this.isModalOpen) {
            setTimeout(() => {
                this.newMessageFormGroup.reset();
            }, 0);
        }
    }
    /**
     * The method to create a message.
     *
     * @param value Message data
     */
    createMessage(value) {
        this.formLoading = true;
        this.newMessageFormGroup.disable();
        this.createMessageFormService
            .createMessage(value)
            .pipe(first(), switchMap(() => {
            if (this.createMessageFormService.deleteDraft && this.draftId) {
                return this.createMessageFormService.deleteDraft(this.draftId);
            }
            return of(undefined);
        }), finalize(() => {
            this.formLoading = false;
        }))
            .subscribe(this.responseHandler(this.messageComposeSuccessTpl, this.messageComposeErrorTpl));
    }
    /**
     * The method to save a message as a draft.
     *
     * @param value Draft data
     */
    onSave(value) {
        this.newMessageFormGroup.disable();
        if (this.sharedService.hasFormValue(this.newMessageFormGroup) &&
            this.sharedService.isFormInvalid(this.newMessageFormGroup, this.draftFormValue)) {
            if (this.draftId) {
                this.updateDraft(this.draftId, value);
            }
            else {
                this.saveDraft(value);
            }
        }
        else {
            this.onCancel();
        }
    }
    /**
     * The method to get the draft and prefill the compose form with it.
     *
     * @param id Draft id
     */
    getDrafts(id) {
        if (this.createMessageFormService.getDraft && id) {
            return this.createMessageFormService.getDraft(id).pipe(map(res => {
                const drafts = res || {};
                const formValue = {};
                const topics = this.topics$.getValue();
                for (const [key, value] of Object.entries(drafts)) {
                    formValue[key] = value;
                    if (this.newMessageFormGroup.controls.hasOwnProperty(key)) {
                        formValue[key] = this.handleFormValues(key, value, topics);
                        if (formValue[key]) {
                            this.newMessageFormGroup.controls[key].setValue(formValue[key]);
                        }
                    }
                }
                this.draftFormValue = formValue;
                this.newMessageFormGroup.markAsPristine();
                return res;
            }));
        }
        return EMPTY;
    }
    ngOnDestroy() {
        this.unsubscribe$.next();
        this.unsubscribe$.complete();
    }
    /**
     * The method to resolve the confirmation modal.
     */
    confirmConfirmationModal() {
        if (this.confirmationModal && this.confirmationModal.type === ManipulationType.discard) {
            this.onCancel();
        }
        this.confirmModalService.toggleModal(false);
    }
    /**
     * The method to cancel the confirmation modal.
     */
    onCancel() {
        this.resetToInit(true);
        this.cancel.emit();
    }
    /**
     * The method to get any errors generated by failing validation, or null if there are no errors.
     *
     * @param field Field name
     * @param type Error type
     */
    hasError(field, type) {
        var _a;
        const control = this.getControl(field);
        return (_a = control === null || control === void 0 ? void 0 : control.errors) === null || _a === void 0 ? void 0 : _a[type];
    }
    /**
     * The method that defines whether the control is valid or not.
     *
     * @param field Field name
     * @returns Is form field valid flag
     */
    isInvalidControl(field) {
        const control = this.getControl(field);
        return !!control && control.touched && control.invalid;
    }
    saveDraft(value) {
        if (this.createMessageFormService.saveDraft) {
            this.createMessageFormService
                .saveDraft(value)
                .pipe(first())
                .subscribe(this.responseHandler(this.messageSaveDraftSuccessTpl, this.messageSaveDraftErrorTpl));
        }
    }
    updateDraft(draftId, value) {
        if (this.createMessageFormService.updateDraft) {
            this.createMessageFormService
                .updateDraft(draftId, value)
                .pipe(first())
                .subscribe(this.responseHandler(this.messageUpdateDraftSuccessTpl, this.messageUpdateDraftErrorTpl));
        }
    }
    handleFormValues(key, value, topics) {
        if (key === 'body') {
            return this.encodingService.b64Decode(value);
        }
        if (key === 'topic' && topics) {
            const existingTopic = topics.find(topic => topic.id === value.id);
            return existingTopic ? existingTopic : '';
        }
        if (key === 'attachments') {
            this.attachments = [...value];
        }
        return value;
    }
    responseHandler(successTpl, errorTpl) {
        return {
            next: res => {
                this.sharedService.openNotification(successTpl ? successTpl : '');
                this.confirm.emit(res && res.id);
            },
            error: error => {
                const errorMessage = this.sharedService.getErrorMessage(error) || errorTpl;
                this.sharedService.openNotification(errorMessage, 'error');
                this.newMessageFormGroup.enable();
            },
            complete: () => this.resetToInit(),
        };
    }
    resetToInit(isFormDiscard = false) {
        this.newMessageFormGroup.enable();
        this.newMessageFormGroup.reset();
        this.draftFormValue = undefined;
        this.uploadService.reset(isFormDiscard);
    }
    getControl(field) {
        return this.newMessageFormGroup && this.newMessageFormGroup.controls[field];
    }
    restoreTopicSelection(topics) {
        topics === null || topics === void 0 ? void 0 : topics.map(topic => {
            var _a, _b;
            if (topic.id === ((_b = (_a = this.newMessageFormGroup.controls['topic']) === null || _a === void 0 ? void 0 : _a.value) === null || _b === void 0 ? void 0 : _b.id)) {
                this.newMessageFormGroup.controls['topic'].setValue(topic);
            }
        });
    }
}
BaseCreateMessageFormComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.14", ngImport: i0, type: BaseCreateMessageFormComponent, deps: [{ token: i1.SharedMethodsService }, { token: i2.MessagesManipulationConfirmModalService }, { token: i0.ChangeDetectorRef }, { token: i3.BaseCreateMessageFormService }, { token: i4.FormBuilder }, { token: i5.MessagesEncodingService }, { token: i6.MessagesUploadAttachmentsService }], target: i0.ɵɵFactoryTarget.Component });
BaseCreateMessageFormComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "12.0.0", version: "12.2.14", type: BaseCreateMessageFormComponent, selector: "ng-component", inputs: { reset: "reset", maxAttachmentSize: "maxAttachmentSize", maxMailoutNameLength: "maxMailoutNameLength", maxSubjectLength: "maxSubjectLength", maxMessageLength: "maxMessageLength", isModalOpen: "isModalOpen", draftId: "draftId" }, outputs: { confirm: "confirm", cancel: "cancel" }, providers: [MessagesManipulationConfirmModalService, MessagesUploadAttachmentsService], viewQueries: [{ propertyName: "messageComposeSuccessTpl", first: true, predicate: ["messageComposeSuccess"], descendants: true }, { propertyName: "messageSaveDraftSuccessTpl", first: true, predicate: ["messageSaveDraftSuccess"], descendants: true }, { propertyName: "messageUpdateDraftSuccessTpl", first: true, predicate: ["messageUpdateDraftSuccess"], descendants: true }, { propertyName: "messageComposeErrorTpl", first: true, predicate: ["messageComposeError"], descendants: true }, { propertyName: "messageSaveDraftErrorTpl", first: true, predicate: ["messageSaveDraftError"], descendants: true }, { propertyName: "messageUpdateDraftErrorTpl", first: true, predicate: ["messageUpdateDraftError"], descendants: true }], ngImport: i0, template: '', isInline: true });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.14", ngImport: i0, type: BaseCreateMessageFormComponent, decorators: [{
            type: Component,
            args: [{
                    template: '',
                    providers: [MessagesManipulationConfirmModalService, MessagesUploadAttachmentsService],
                }]
        }], ctorParameters: function () { return [{ type: i1.SharedMethodsService }, { type: i2.MessagesManipulationConfirmModalService }, { type: i0.ChangeDetectorRef }, { type: i3.BaseCreateMessageFormService }, { type: i4.FormBuilder }, { type: i5.MessagesEncodingService }, { type: i6.MessagesUploadAttachmentsService }]; }, propDecorators: { reset: [{
                type: Input
            }], maxAttachmentSize: [{
                type: Input
            }], maxMailoutNameLength: [{
                type: Input
            }], maxSubjectLength: [{
                type: Input
            }], maxMessageLength: [{
                type: Input
            }], isModalOpen: [{
                type: Input
            }], draftId: [{
                type: Input
            }], confirm: [{
                type: Output
            }], cancel: [{
                type: Output
            }], messageComposeSuccessTpl: [{
                type: ViewChild,
                args: ['messageComposeSuccess']
            }], messageSaveDraftSuccessTpl: [{
                type: ViewChild,
                args: ['messageSaveDraftSuccess']
            }], messageUpdateDraftSuccessTpl: [{
                type: ViewChild,
                args: ['messageUpdateDraftSuccess']
            }], messageComposeErrorTpl: [{
                type: ViewChild,
                args: ['messageComposeError']
            }], messageSaveDraftErrorTpl: [{
                type: ViewChild,
                args: ['messageSaveDraftError']
            }], messageUpdateDraftErrorTpl: [{
                type: ViewChild,
                args: ['messageUpdateDraftError']
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZS1jcmVhdGUtbWVzc2FnZS1mb3JtLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL2xpYnMvbWVzc2FnZXMtY29tbW9uL3NyYy9jb21wb25lbnRzL2NyZWF0ZS1tZXNzYWdlL2Jhc2UtZm9ybS9iYXNlLWNyZWF0ZS1tZXNzYWdlLWZvcm0uY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFFTCxTQUFTLEVBQ1QsWUFBWSxFQUNaLEtBQUssRUFHTCxNQUFNLEVBRU4sU0FBUyxHQUNWLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBMkMsVUFBVSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDckYsT0FBTyxFQUFFLGVBQWUsRUFBRSxLQUFLLEVBQWMsRUFBRSxFQUFtQixPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDeEYsT0FBTyxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFcEYsT0FBTyxFQUNMLGdCQUFnQixHQUVqQixNQUFNLGtGQUFrRixDQUFDO0FBQzFGLE9BQU8sRUFBRSx1Q0FBdUMsRUFBRSxNQUFNLHVGQUF1RixDQUFDO0FBS2hKLE9BQU8sRUFBRSxnQ0FBZ0MsRUFBRSxNQUFNLHVFQUF1RSxDQUFDOzs7Ozs7OztBQU96SCxNQUFNLE9BQU8sOEJBQThCO0lBa0l6QyxZQUNXLGFBQW1DLEVBQ25DLG1CQUE0RCxFQUM1RCxFQUFxQixFQUNyQix3QkFBeUQsRUFDekQsRUFBZSxFQUNmLGVBQXdDLEVBQ3hDLGFBQStDO1FBTi9DLGtCQUFhLEdBQWIsYUFBYSxDQUFzQjtRQUNuQyx3QkFBbUIsR0FBbkIsbUJBQW1CLENBQXlDO1FBQzVELE9BQUUsR0FBRixFQUFFLENBQW1CO1FBQ3JCLDZCQUF3QixHQUF4Qix3QkFBd0IsQ0FBaUM7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QjtnQkFLSSx3QkFBd0I7c0JBQTNELFNBQVM7dUJBQUMsdUJBQXVCO2dCQUtJLDBCQUEwQjtzQkFBL0QsU0FBUzt1QkFBQyx5QkFBeUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDaGFuZ2VEZXRlY3RvclJlZixcbiAgQ29tcG9uZW50LFxuICBFdmVudEVtaXR0ZXIsXG4gIElucHV0LFxuICBPbkRlc3Ryb3ksXG4gIE9uSW5pdCxcbiAgT3V0cHV0LFxuICBUZW1wbGF0ZVJlZixcbiAgVmlld0NoaWxkLFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEFic3RyYWN0Q29udHJvbCwgRm9ybUJ1aWxkZXIsIEZvcm1Hcm91cCwgVmFsaWRhdG9ycyB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCwgRU1QVFksIE9ic2VydmFibGUsIG9mLCBQYXJ0aWFsT2JzZXJ2ZXIsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGZpbHRlciwgZmluYWxpemUsIGZpcnN0LCBtYXAsIHN3aXRjaE1hcCwgdGFrZVVudGlsIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgU2hhcmVkTWV0aG9kc1NlcnZpY2UgfSBmcm9tICcuLi8uLi8uLi9zZXJ2aWNlcy9zaGFyZWQtbWV0aG9kcy9zaGFyZWQtbWV0aG9kcy5zZXJ2aWNlJztcbmltcG9ydCB7XG4gIE1hbmlwdWxhdGlvblR5cGUsXG4gIE1lc3NhZ2VzQ29uZmlybWF0aW9uTW9kYWxNb2RlbCxcbn0gZnJvbSAnLi4vLi4vbWVzc2FnZXMtbWFuaXB1bGF0aW9uLWNvbmZpcm0tbW9kYWwvbWFuaXB1bGF0aW9uLWNvbmZpcm0tbW9kYWwtdHlwZXMubW9kZWwnO1xuaW1wb3J0IHsgTWVzc2FnZXNNYW5pcHVsYXRpb25Db25maXJtTW9kYWxTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vbWVzc2FnZXMtbWFuaXB1bGF0aW9uLWNvbmZpcm0tbW9kYWwvbWVzc2FnZXMtbWFuaXB1bGF0aW9uLWNvbmZpcm0tbW9kYWwuc2VydmljZSc7XG5pbXBvcnQgeyBCYXNlQ3JlYXRlTWVzc2FnZUZvcm1TZXJ2aWNlIH0gZnJvbSAnLi9iYXNlLWNyZWF0ZS1tZXNzYWdlLWZvcm0uc2VydmljZSc7XG5pbXBvcnQgeyBNZXNzYWdlRHJhZnRHZXRSZXNwb25zZUJvZHksIFRvcGljc0dldFJlc3BvbnNlQm9keSB9IGZyb20gJ0BiYWNrYmFzZS9tZXNzYWdlcy12NS1odHRwLWFuZyc7XG5pbXBvcnQgeyBNZXNzYWdlc0VuY29kaW5nU2VydmljZSB9IGZyb20gJy4uLy4uLy4uL3NlcnZpY2VzL21lc3NhZ2VzLWVuY29kaW5nL21lc3NhZ2VzLWVuY29kaW5nLnNlcnZpY2UnO1xuaW1wb3J0IHsgU2ltcGxlRm9ybU1vZGVsIH0gZnJvbSAnLi4vLi4vLi4vbW9kZWxzL3NpbXBsZS1mb3JtLm1vZGVsJztcbmltcG9ydCB7IE1lc3NhZ2VzVXBsb2FkQXR0YWNobWVudHNTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vdXBsb2FkLWF0dGFjaG1lbnRzL3NlcnZpY2VzL21lc3NhZ2VzLXVwbG9hZC1hdHRhY2htZW50cy5zZXJ2aWNlJztcbmltcG9ydCB7IEZpbGVPYmplY3QgfSBmcm9tICcuLi8uLi91cGxvYWQtYXR0YWNobWVudHMvbW9kZWwvbWVzc2FnZXMtdXBsb2FkLWF0dGFjaG1lbnRzLm1vZGVsJztcblxuQENvbXBvbmVudCh7XG4gIHRlbXBsYXRlOiAnJyxcbiAgcHJvdmlkZXJzOiBbTWVzc2FnZXNNYW5pcHVsYXRpb25Db25maXJtTW9kYWxTZXJ2aWNlLCBNZXNzYWdlc1VwbG9hZEF0dGFjaG1lbnRzU2VydmljZV0sXG59KVxuZXhwb3J0IGNsYXNzIEJhc2VDcmVhdGVNZXNzYWdlRm9ybUNvbXBvbmVudDxUPiBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95IHtcbiAgLyoqXG4gICAqIElucHV0IHN0cmVhbSBvZiByZXNldCBzaWduYWxzIHRoYXQgd2lsbCB0cmlnZ2VyIGZvcm0gcmVzZXQuXG4gICAqL1xuICBASW5wdXQoKSByZXNldDogT2JzZXJ2YWJsZTx2b2lkPiB8IHVuZGVmaW5lZDtcblxuICAvKipcbiAgICogSW5wdXQgZm9yIG1heGltdW0gZmlsZSBhdHRhY2htZW50IHNpemUgaW4gbWVnYWJ5dGVzXG4gICAqL1xuICBASW5wdXQoKSBtYXhBdHRhY2htZW50U2l6ZTogc3RyaW5nIHwgdW5kZWZpbmVkO1xuXG4gIC8qKlxuICAgKiBJbnB1dCBmb3IgbWF4aW11bSBjaGFyYWN0ZXJzIGxlbmd0aCBmb3IgbmFtZSBmaWVsZCB2YWx1ZVxuICAgKi9cbiAgQElucHV0KCkgbWF4TWFpbG91dE5hbWVMZW5ndGg6IG51bWJlciB8IHVuZGVmaW5lZDtcblxuICAvKipcbiAgICogSW5wdXQgZm9yIG1heGltdW0gY2hhcmFjdGVycyBsZW5ndGggZm9yIHN1YmplY3QgZmllbGQgdmFsdWVcbiAgICovXG4gIEBJbnB1dCgpIG1heFN1YmplY3RMZW5ndGg6IG51bWJlciB8IHVuZGVmaW5lZDtcblxuICAvKipcbiAgICogSW5wdXQgZm9yIG1heGltdW0gY2hhcmFjdGVycyBsZW5ndGggZm9yIG1lc3NhZ2UgZmllbGQgdmFsdWVcbiAgICovXG4gIEBJbnB1dCgpIG1heE1lc3NhZ2VMZW5ndGg6IG51bWJlciB8IHVuZGVmaW5lZDtcblxuICAvKipcbiAgICogVGhlIHBhcmVudCBtb2RhbCBvcGVuL2Nsb3NlZCBzdGF0ZS5cbiAgICovXG4gIEBJbnB1dCgpIHJlYWRvbmx5IGlzTW9kYWxPcGVuOiBib29sZWFuIHwgdW5kZWZpbmVkO1xuICAvKipcbiAgICogSW5wdXQgZHJhZnQgaWQgdG8gZ2V0IGRyYWZ0IGFuZCBwcmVmaWxsIGNvbXBvc2UgZm9ybSB3aXRoIGl0XG4gICAqL1xuICBASW5wdXQoKVxuICBzZXQgZHJhZnRJZCh2YWx1ZTogc3RyaW5nIHwgdW5kZWZpbmVkKSB7XG4gICAgdGhpcy5kcmFmdElkJC5uZXh0KHZhbHVlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUaGUgZHJhZnQgSUQgZ2V0dGVyLlxuICAgKi9cbiAgZ2V0IGRyYWZ0SWQoKSB7XG4gICAgcmV0dXJuIHRoaXMuZHJhZnRJZCQuZ2V0VmFsdWUoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUaGUgZXZlbnQgdGhhdCdzIGZpcmVkIGFmdGVyIGNvbmZpcm0gYnV0dG9uIGlzIHByZXNzZWQuXG4gICAqL1xuICBAT3V0cHV0KCkgY29uZmlybSA9IG5ldyBFdmVudEVtaXR0ZXI8c3RyaW5nIHwgbnVsbD4oKTtcblxuICAvKipcbiAgICogVGhlIGV2ZW50IHRoYXQncyBmaXJlZCBhZnRlciBjYW5jZWwgYnV0dG9uIGlzIHByZXNzZWQuXG4gICAqL1xuICBAT3V0cHV0KCkgY2FuY2VsID0gbmV3IEV2ZW50RW1pdHRlcjx2b2lkPigpO1xuXG4gIC8qKlxuICAgKiBUaGUgbm90aWZpY2F0aW9uIGZvciB0aGUgc3VjY2Vzc2Z1bCBjb21wb3NlIG1lc3NhZ2Ugb3BlcmF0aW9uLlxuICAgKi9cbiAgQFZpZXdDaGlsZCgnbWVzc2FnZUNvbXBvc2VTdWNjZXNzJykgbWVzc2FnZUNvbXBvc2VTdWNjZXNzVHBsOiBUZW1wbGF0ZVJlZjxhbnk+IHwgdW5kZWZpbmVkO1xuXG4gIC8qKlxuICAgKiBUaGUgbm90aWZpY2F0aW9uIGZvciB0aGUgc3VjY2Vzc2Z1bGx5IHNhdmVkIGRyYWZ0LlxuICAgKi9cbiAgQFZpZXdDaGlsZCgnbWVzc2FnZVNhdmVEcmFmdFN1Y2Nlc3MnKSBtZXNzYWdlU2F2ZURyYWZ0U3VjY2Vzc1RwbDogVGVtcGxhdGVSZWY8YW55PiB8IHVuZGVmaW5lZDtcblxuICAvKipcbiAgICogVGhlIG5vdGlmaWNhdGlvbiBmb3IgdGhlIHN1Y2Nlc3NmdWxseSBzYXZlZCBkcmFmdC5cbiAgICovXG4gIEBWaWV3Q2hpbGQoJ21lc3NhZ2VVcGRhdGVEcmFmdFN1Y2Nlc3MnKSBtZXNzYWdlVXBkYXRlRHJhZnRTdWNjZXNzVHBsOiBUZW1wbGF0ZVJlZjxhbnk+IHwgdW5kZWZpbmVkO1xuXG4gIC8qKlxuICAgKiBUaGUgbm90aWZpY2F0aW9uIGZvciB0aGUgY29tcG9zZSBtZXNzYWdlIGVycm9yLlxuICAgKi9cbiAgQFZpZXdDaGlsZCgnbWVzc2FnZUNvbXBvc2VFcnJvcicpIG1lc3NhZ2VDb21wb3NlRXJyb3JUcGw6IFRlbXBsYXRlUmVmPGFueT4gfCB1bmRlZmluZWQ7XG5cbiAgLyoqXG4gICAqIFRoZSBub3RpZmljYXRpb24gZm9yIHRoZSBzYXZlIGRyYWZ0IGVycm9yLlxuICAgKi9cbiAgQFZpZXdDaGlsZCgnbWVzc2FnZVNhdmVEcmFmdEVycm9yJykgbWVzc2FnZVNhdmVEcmFmdEVycm9yVHBsOiBUZW1wbGF0ZVJlZjxhbnk+IHwgdW5kZWZpbmVkO1xuXG4gIC8qKlxuICAgKiBUaGUgbm90aWZpY2F0aW9uIGZvciB0aGUgdXBkYXRlIGRyYWZ0IGVycm9yLlxuICAgKi9cbiAgQFZpZXdDaGlsZCgnbWVzc2FnZVVwZGF0ZURyYWZ0RXJyb3InKSBtZXNzYWdlVXBkYXRlRHJhZnRFcnJvclRwbDogVGVtcGxhdGVSZWY8YW55PiB8IHVuZGVmaW5lZDtcblxuICByZWFkb25seSBob3N0UmVmID0gdGhpcztcblxuICAvKipcbiAgICogVGhlIGZpbGUgYXR0YWNobWVudHMgYXJyYXkuXG4gICAqL1xuICBhdHRhY2htZW50czogQXJyYXk8RmlsZU9iamVjdD4gfCB1bmRlZmluZWQ7XG5cbiAgLyoqXG4gICAqIFRoZSBibGFuayBuZXcgbWVzc2FnZSBmb3JtIHdpdGggdGhlIGluaXRpYWwgdmFsdWVzLlxuICAgKi9cbiAgbmV3TWVzc2FnZUZvcm1Hcm91cDogRm9ybUdyb3VwO1xuXG4gIC8qKlxuICAgKiBUaGUgZHJhZnQgZm9ybSB2YWx1ZS5cbiAgICovXG4gIGRyYWZ0Rm9ybVZhbHVlOiB7IFtrZXk6IHN0cmluZ106IGFueSB9IHwgdW5kZWZpbmVkO1xuXG4gIC8qKlxuICAgKiBDb25maXJtYXRpb24gbW9kYWwgcGFyYW1ldGVycy5cbiAgICovXG4gIGNvbmZpcm1hdGlvbk1vZGFsOiBNZXNzYWdlc0NvbmZpcm1hdGlvbk1vZGFsTW9kZWwgPSB7XG4gICAgb3BlbmVkOiBmYWxzZSxcbiAgICB0eXBlOiB1bmRlZmluZWQsXG4gIH07XG5cbiAgLyoqXG4gICAqIFRoZSBmbGFnIGluZGljYXRpbmcgaWYgdGhlIGZvcm0gaXMgbG9hZGluZy5cbiAgICovXG4gIGZvcm1Mb2FkaW5nID0gZmFsc2U7XG5cbiAgcHJpdmF0ZSByZWFkb25seSB0b3BpY3MkID0gbmV3IEJlaGF2aW9yU3ViamVjdDxUb3BpY3NHZXRSZXNwb25zZUJvZHlbXSB8IG51bGwgfCB1bmRlZmluZWQ+KHVuZGVmaW5lZCk7XG5cbiAgLyoqXG4gICAqIFRoZSBzdHJlYW0gd2l0aCB0b3BpY3MuXG4gICAqL1xuICByZWFkb25seSB0b3BpY3M6IE9ic2VydmFibGU8VG9waWNzR2V0UmVzcG9uc2VCb2R5W10gfCBudWxsIHwgdW5kZWZpbmVkPiA9IHRoaXMudG9waWNzJC5hc09ic2VydmFibGUoKTtcblxuICAvKipcbiAgICogVGhlIG1hbmlwdWxhdGlvblR5cGUgZW51bSAoIGByZXNvbHZlYCwgYHVucmVzb2x2ZWAsIGBhc3NpZ25gLCBgdW5hc3NpZ25gLCBgZGlzY2FyZGAsXG4gICAqIGBkaXNjYXJkRHJhZnRgLCBgZGlzY2FyZFByZXZpZXdgLCBgZGVsZXRlVG9waWNgLCBgZGVsZXRlTWFpbG91dGApXG4gICAqL1xuICByZWFkb25seSBtYW5pcHVsYXRpb25UeXBlcyA9IE1hbmlwdWxhdGlvblR5cGU7XG4gIHByaXZhdGUgcmVhZG9ubHkgdW5zdWJzY3JpYmUkID0gbmV3IFN1YmplY3Q8dW5kZWZpbmVkPigpO1xuICBwcml2YXRlIHJlYWRvbmx5IGRyYWZ0SWQkID0gbmV3IEJlaGF2aW9yU3ViamVjdDxzdHJpbmcgfCB1bmRlZmluZWQ+KHVuZGVmaW5lZCk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcmVhZG9ubHkgc2hhcmVkU2VydmljZTogU2hhcmVkTWV0aG9kc1NlcnZpY2UsXG4gICAgcmVhZG9ubHkgY29uZmlybU1vZGFsU2VydmljZTogTWVzc2FnZXNNYW5pcHVsYXRpb25Db25maXJtTW9kYWxTZXJ2aWNlLFxuICAgIHJlYWRvbmx5IGNkOiBDaGFuZ2VEZXRlY3RvclJlZixcbiAgICByZWFkb25seSBjcmVhdGVNZXNzYWdlRm9ybVNlcnZpY2U6IEJhc2VDcmVhdGVNZXNzYWdlRm9ybVNlcnZpY2U8VD4sXG4gICAgcmVhZG9ubHkgZmI6IEZvcm1CdWlsZGVyLFxuICAgIHJlYWRvbmx5IGVuY29kaW5nU2VydmljZTogTWVzc2FnZXNFbmNvZGluZ1NlcnZpY2UsXG4gICAgcmVhZG9ubHkgdXBsb2FkU2VydmljZTogTWVzc2FnZXNVcGxvYWRBdHRhY2htZW50c1NlcnZpY2UsXG4gICkge1xuICAgIHRoaXMubmV3TWVzc2FnZUZvcm1Hcm91cCA9IHRoaXMuZmIuZ3JvdXAoe1xuICAgICAgdG9waWM6IFsnJywgVmFsaWRhdG9ycy5yZXF1aXJlZF0sXG4gICAgICBzdWJqZWN0OiBbJycsIFZhbGlkYXRvcnMucmVxdWlyZWRdLFxuICAgICAgYm9keTogWycnLCBWYWxpZGF0b3JzLnJlcXVpcmVkXSxcbiAgICAgIGF0dGFjaG1lbnRzOiBbXSxcbiAgICB9KTtcbiAgfVxuXG4gIG5nT25Jbml0KCkge1xuICAgIGlmICh0aGlzLnJlc2V0KSB7XG4gICAgICB0aGlzLnJlc2V0LnBpcGUodGFrZVVudGlsKHRoaXMudW5zdWJzY3JpYmUkKSkuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgICAgdGhpcy5jb25maXJtTW9kYWxTZXJ2aWNlLnRvZ2dsZU1vZGFsKFxuICAgICAgICAgIHRydWUsXG4gICAgICAgICAgdGhpcy5tYW5pcHVsYXRpb25UeXBlcy5kaXNjYXJkLFxuICAgICAgICAgIHRoaXMubmV3TWVzc2FnZUZvcm1Hcm91cCxcbiAgICAgICAgICB0aGlzLmRyYWZ0Rm9ybVZhbHVlLFxuICAgICAgICApO1xuICAgICAgfSk7XG4gICAgfVxuXG4gICAgdGhpcy5jcmVhdGVNZXNzYWdlRm9ybVNlcnZpY2UuZ2V0VG9waWNzKCkuc3Vic2NyaWJlKHJlcyA9PiB7XG4gICAgICB0aGlzLnJlc3RvcmVUb3BpY1NlbGVjdGlvbihyZXMpO1xuICAgICAgdGhpcy50b3BpY3MkLm5leHQocmVzKTtcbiAgICB9KTtcblxuICAgIHRoaXMuZHJhZnRJZCRcbiAgICAgIC5waXBlKFxuICAgICAgICBmaWx0ZXIoaWQgPT4gISEoaWQgJiYgaWQubGVuZ3RoKSksXG4gICAgICAgIHN3aXRjaE1hcChpZCA9PiB0aGlzLmdldERyYWZ0cyhpZCkpLFxuICAgICAgKVxuICAgICAgLnN1YnNjcmliZSgpO1xuXG4gICAgdGhpcy5jb25maXJtTW9kYWxTZXJ2aWNlLmVtaXRUb2dnbGVNb2RhbCQucGlwZSh0YWtlVW50aWwodGhpcy51bnN1YnNjcmliZSQpKS5zdWJzY3JpYmUoKHsgb3BlbmVkLCB0eXBlIH0pID0+IHtcbiAgICAgIHRoaXMuY29uZmlybWF0aW9uTW9kYWwgPSB7IG9wZW5lZCwgdHlwZSB9O1xuICAgICAgaWYgKCFvcGVuZWQgJiYgdHlwZSA9PT0gTWFuaXB1bGF0aW9uVHlwZS5kaXNjYXJkKSB7XG4gICAgICAgIHRoaXMub25DYW5jZWwoKTtcbiAgICAgIH1cbiAgICAgIHRoaXMuY2QuZGV0ZWN0Q2hhbmdlcygpO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFRoZSBtZXRob2QgdG8gZ2V0IGEgc2ltcGxlIHZhbHVlIGZyb20gdGhlIGZvcm0uXG4gICAqXG4gICAqIEBwYXJhbSBzaW1wbGVGb3JtTW9kZWwgTWVzc2FnZSBkYXRhXG4gICAqL1xuICBnZXRTaW1wbGVGb3JtVmFsKHsgYm9keSwgc3ViamVjdCwgdG9waWMsIGF0dGFjaG1lbnRzIH06IFNpbXBsZUZvcm1Nb2RlbCkge1xuICAgIHJldHVybiB7XG4gICAgICAuLi4oYm9keSAmJiBib2R5Lmxlbmd0aCAmJiB7IGJvZHk6IHRoaXMuZW5jb2RpbmdTZXJ2aWNlLmI2NEVuY29kZShib2R5KSB9KSxcbiAgICAgIC4uLihzdWJqZWN0ICYmIHN1YmplY3QubGVuZ3RoICYmIHsgc3ViamVjdCB9KSxcbiAgICAgIC4uLih0b3BpYyAmJiB0b3BpYy5pZCAmJiB7IHRvcGljOiB0b3BpYy5pZCB9KSxcbiAgICAgIC4uLihhdHRhY2htZW50cyAmJiBhdHRhY2htZW50cy5sZW5ndGggJiYgeyBhdHRhY2htZW50czogYXR0YWNobWVudHMubWFwKGl0ZW0gPT4gaXRlbS5pZCkgfSksXG4gICAgfTtcbiAgfVxuXG4gIHJlc2V0Rm9ybU9uRWxlbWVudEJsdXIoKSB7XG4gICAgaWYgKCF0aGlzLmlzTW9kYWxPcGVuKSB7XG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgdGhpcy5uZXdNZXNzYWdlRm9ybUdyb3VwLnJlc2V0KCk7XG4gICAgICB9LCAwKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVGhlIG1ldGhvZCB0byBjcmVhdGUgYSBtZXNzYWdlLlxuICAgKlxuICAgKiBAcGFyYW0gdmFsdWUgTWVzc2FnZSBkYXRhXG4gICAqL1xuICBjcmVhdGVNZXNzYWdlKHZhbHVlOiBUKSB7XG4gICAgdGhpcy5mb3JtTG9hZGluZyA9IHRydWU7XG4gICAgdGhpcy5uZXdNZXNzYWdlRm9ybUdyb3VwLmRpc2FibGUoKTtcblxuICAgIHRoaXMuY3JlYXRlTWVzc2FnZUZvcm1TZXJ2aWNlXG4gICAgICAuY3JlYXRlTWVzc2FnZSh2YWx1ZSlcbiAgICAgIC5waXBlKFxuICAgICAgICBmaXJzdCgpLFxuICAgICAgICBzd2l0Y2hNYXAoKCkgPT4ge1xuICAgICAgICAgIGlmICh0aGlzLmNyZWF0ZU1lc3NhZ2VGb3JtU2VydmljZS5kZWxldGVEcmFmdCAmJiB0aGlzLmRyYWZ0SWQpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmNyZWF0ZU1lc3NhZ2VGb3JtU2VydmljZS5kZWxldGVEcmFmdCh0aGlzLmRyYWZ0SWQpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHJldHVybiBvZih1bmRlZmluZWQpO1xuICAgICAgICB9KSxcbiAgICAgICAgZmluYWxpemUoKCkgPT4ge1xuICAgICAgICAgIHRoaXMuZm9ybUxvYWRpbmcgPSBmYWxzZTtcbiAgICAgICAgfSksXG4gICAgICApXG4gICAgICAuc3Vic2NyaWJlKHRoaXMucmVzcG9uc2VIYW5kbGVyKHRoaXMubWVzc2FnZUNvbXBvc2VTdWNjZXNzVHBsLCB0aGlzLm1lc3NhZ2VDb21wb3NlRXJyb3JUcGwpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUaGUgbWV0aG9kIHRvIHNhdmUgYSBtZXNzYWdlIGFzIGEgZHJhZnQuXG4gICAqXG4gICAqIEBwYXJhbSB2YWx1ZSBEcmFmdCBkYXRhXG4gICAqL1xuICBvblNhdmUodmFsdWU6IFQpIHtcbiAgICB0aGlzLm5ld01lc3NhZ2VGb3JtR3JvdXAuZGlzYWJsZSgpO1xuXG4gICAgaWYgKFxuICAgICAgdGhpcy5zaGFyZWRTZXJ2aWNlLmhhc0Zvcm1WYWx1ZSh0aGlzLm5ld01lc3NhZ2VGb3JtR3JvdXApICYmXG4gICAgICB0aGlzLnNoYXJlZFNlcnZpY2UuaXNGb3JtSW52YWxpZCh0aGlzLm5ld01lc3NhZ2VGb3JtR3JvdXAsIHRoaXMuZHJhZnRGb3JtVmFsdWUpXG4gICAgKSB7XG4gICAgICBpZiAodGhpcy5kcmFmdElkKSB7XG4gICAgICAgIHRoaXMudXBkYXRlRHJhZnQodGhpcy5kcmFmdElkLCB2YWx1ZSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnNhdmVEcmFmdCh2YWx1ZSk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMub25DYW5jZWwoKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVGhlIG1ldGhvZCB0byBnZXQgdGhlIGRyYWZ0IGFuZCBwcmVmaWxsIHRoZSBjb21wb3NlIGZvcm0gd2l0aCBpdC5cbiAgICpcbiAgICogQHBhcmFtIGlkIERyYWZ0IGlkXG4gICAqL1xuICBnZXREcmFmdHMoaWQ/OiBzdHJpbmcpOiBPYnNlcnZhYmxlPE1lc3NhZ2VEcmFmdEdldFJlc3BvbnNlQm9keSB8IG51bGw+IHtcbiAgICBpZiAodGhpcy5jcmVhdGVNZXNzYWdlRm9ybVNlcnZpY2UuZ2V0RHJhZnQgJiYgaWQpIHtcbiAgICAgIHJldHVybiB0aGlzLmNyZWF0ZU1lc3NhZ2VGb3JtU2VydmljZS5nZXREcmFmdChpZCkucGlwZShcbiAgICAgICAgbWFwKHJlcyA9PiB7XG4gICAgICAgICAgY29uc3QgZHJhZnRzID0gcmVzIHx8IHt9O1xuICAgICAgICAgIGNvbnN0IGZvcm1WYWx1ZTogYW55ID0ge307XG4gICAgICAgICAgY29uc3QgdG9waWNzID0gdGhpcy50b3BpY3MkLmdldFZhbHVlKCk7XG5cbiAgICAgICAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhkcmFmdHMpKSB7XG4gICAgICAgICAgICBmb3JtVmFsdWVba2V5XSA9IHZhbHVlO1xuXG4gICAgICAgICAgICBpZiAodGhpcy5uZXdNZXNzYWdlRm9ybUdyb3VwLmNvbnRyb2xzLmhhc093blByb3BlcnR5KGtleSkpIHtcbiAgICAgICAgICAgICAgZm9ybVZhbHVlW2tleV0gPSB0aGlzLmhhbmRsZUZvcm1WYWx1ZXMoa2V5LCB2YWx1ZSwgdG9waWNzKTtcblxuICAgICAgICAgICAgICBpZiAoZm9ybVZhbHVlW2tleV0pIHtcbiAgICAgICAgICAgICAgICB0aGlzLm5ld01lc3NhZ2VGb3JtR3JvdXAuY29udHJvbHNba2V5XS5zZXRWYWx1ZShmb3JtVmFsdWVba2V5XSk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG5cbiAgICAgICAgICB0aGlzLmRyYWZ0Rm9ybVZhbHVlID0gZm9ybVZhbHVlO1xuICAgICAgICAgIHRoaXMubmV3TWVzc2FnZUZvcm1Hcm91cC5tYXJrQXNQcmlzdGluZSgpO1xuXG4gICAgICAgICAgcmV0dXJuIHJlcztcbiAgICAgICAgfSksXG4gICAgICApO1xuICAgIH1cblxuICAgIHJldHVybiBFTVBUWTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIHRoaXMudW5zdWJzY3JpYmUkLm5leHQoKTtcbiAgICB0aGlzLnVuc3Vic2NyaWJlJC5jb21wbGV0ZSgpO1xuICB9XG5cbiAgLyoqXG4gICAqIFRoZSBtZXRob2QgdG8gcmVzb2x2ZSB0aGUgY29uZmlybWF0aW9uIG1vZGFsLlxuICAgKi9cbiAgY29uZmlybUNvbmZpcm1hdGlvbk1vZGFsKCkge1xuICAgIGlmICh0aGlzLmNvbmZpcm1hdGlvbk1vZGFsICYmIHRoaXMuY29uZmlybWF0aW9uTW9kYWwudHlwZSA9PT0gTWFuaXB1bGF0aW9uVHlwZS5kaXNjYXJkKSB7XG4gICAgICB0aGlzLm9uQ2FuY2VsKCk7XG4gICAgfVxuXG4gICAgdGhpcy5jb25maXJtTW9kYWxTZXJ2aWNlLnRvZ2dsZU1vZGFsKGZhbHNlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUaGUgbWV0aG9kIHRvIGNhbmNlbCB0aGUgY29uZmlybWF0aW9uIG1vZGFsLlxuICAgKi9cbiAgb25DYW5jZWwoKSB7XG4gICAgdGhpcy5yZXNldFRvSW5pdCh0cnVlKTtcbiAgICB0aGlzLmNhbmNlbC5lbWl0KCk7XG4gIH1cblxuICAvKipcbiAgICogVGhlIG1ldGhvZCB0byBnZXQgYW55IGVycm9ycyBnZW5lcmF0ZWQgYnkgZmFpbGluZyB2YWxpZGF0aW9uLCBvciBudWxsIGlmIHRoZXJlIGFyZSBubyBlcnJvcnMuXG4gICAqXG4gICAqIEBwYXJhbSBmaWVsZCBGaWVsZCBuYW1lXG4gICAqIEBwYXJhbSB0eXBlIEVycm9yIHR5cGVcbiAgICovXG4gIGhhc0Vycm9yKGZpZWxkOiBzdHJpbmcsIHR5cGU6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IGNvbnRyb2wgPSB0aGlzLmdldENvbnRyb2woZmllbGQpO1xuXG4gICAgcmV0dXJuIGNvbnRyb2w/LmVycm9ycz8uW3R5cGVdO1xuICB9XG5cbiAgLyoqXG4gICAqIFRoZSBtZXRob2QgdGhhdCBkZWZpbmVzIHdoZXRoZXIgdGhlIGNvbnRyb2wgaXMgdmFsaWQgb3Igbm90LlxuICAgKlxuICAgKiBAcGFyYW0gZmllbGQgRmllbGQgbmFtZVxuICAgKiBAcmV0dXJucyBJcyBmb3JtIGZpZWxkIHZhbGlkIGZsYWdcbiAgICovXG4gIGlzSW52YWxpZENvbnRyb2woZmllbGQ6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IGNvbnRyb2wgPSB0aGlzLmdldENvbnRyb2woZmllbGQpO1xuXG4gICAgcmV0dXJuICEhY29udHJvbCAmJiBjb250cm9sLnRvdWNoZWQgJiYgY29udHJvbC5pbnZhbGlkO1xuICB9XG5cbiAgcHJpdmF0ZSBzYXZlRHJhZnQodmFsdWU6IFQpIHtcbiAgICBpZiAodGhpcy5jcmVhdGVNZXNzYWdlRm9ybVNlcnZpY2Uuc2F2ZURyYWZ0KSB7XG4gICAgICB0aGlzLmNyZWF0ZU1lc3NhZ2VGb3JtU2VydmljZVxuICAgICAgICAuc2F2ZURyYWZ0KHZhbHVlKVxuICAgICAgICAucGlwZShmaXJzdCgpKVxuICAgICAgICAuc3Vic2NyaWJlKHRoaXMucmVzcG9uc2VIYW5kbGVyKHRoaXMubWVzc2FnZVNhdmVEcmFmdFN1Y2Nlc3NUcGwsIHRoaXMubWVzc2FnZVNhdmVEcmFmdEVycm9yVHBsKSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVEcmFmdChkcmFmdElkOiBzdHJpbmcsIHZhbHVlOiBUKSB7XG4gICAgaWYgKHRoaXMuY3JlYXRlTWVzc2FnZUZvcm1TZXJ2aWNlLnVwZGF0ZURyYWZ0KSB7XG4gICAgICB0aGlzLmNyZWF0ZU1lc3NhZ2VGb3JtU2VydmljZVxuICAgICAgICAudXBkYXRlRHJhZnQoZHJhZnRJZCwgdmFsdWUpXG4gICAgICAgIC5waXBlKGZpcnN0KCkpXG4gICAgICAgIC5zdWJzY3JpYmUodGhpcy5yZXNwb25zZUhhbmRsZXIodGhpcy5tZXNzYWdlVXBkYXRlRHJhZnRTdWNjZXNzVHBsLCB0aGlzLm1lc3NhZ2VVcGRhdGVEcmFmdEVycm9yVHBsKSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBoYW5kbGVGb3JtVmFsdWVzKGtleTogc3RyaW5nLCB2YWx1ZTogYW55LCB0b3BpY3M/OiBUb3BpY3NHZXRSZXNwb25zZUJvZHlbXSB8IG51bGwpIHtcbiAgICBpZiAoa2V5ID09PSAnYm9keScpIHtcbiAgICAgIHJldHVybiB0aGlzLmVuY29kaW5nU2VydmljZS5iNjREZWNvZGUodmFsdWUgYXMgc3RyaW5nKTtcbiAgICB9XG5cbiAgICBpZiAoa2V5ID09PSAndG9waWMnICYmIHRvcGljcykge1xuICAgICAgY29uc3QgZXhpc3RpbmdUb3BpYyA9IHRvcGljcy5maW5kKHRvcGljID0+IHRvcGljLmlkID09PSB2YWx1ZS5pZCk7XG5cbiAgICAgIHJldHVybiBleGlzdGluZ1RvcGljID8gZXhpc3RpbmdUb3BpYyA6ICcnO1xuICAgIH1cblxuICAgIGlmIChrZXkgPT09ICdhdHRhY2htZW50cycpIHtcbiAgICAgIHRoaXMuYXR0YWNobWVudHMgPSBbLi4udmFsdWVdO1xuICAgIH1cblxuICAgIHJldHVybiB2YWx1ZTtcbiAgfVxuXG4gIHByaXZhdGUgcmVzcG9uc2VIYW5kbGVyKHN1Y2Nlc3NUcGw6IGFueSwgZXJyb3JUcGw6IGFueSk6IFBhcnRpYWxPYnNlcnZlcjxhbnk+IHtcbiAgICByZXR1cm4ge1xuICAgICAgbmV4dDogcmVzID0+IHtcbiAgICAgICAgdGhpcy5zaGFyZWRTZXJ2aWNlLm9wZW5Ob3RpZmljYXRpb24oc3VjY2Vzc1RwbCA/IHN1Y2Nlc3NUcGwgOiAnJyk7XG5cbiAgICAgICAgdGhpcy5jb25maXJtLmVtaXQocmVzICYmIHJlcy5pZCk7XG4gICAgICB9LFxuICAgICAgZXJyb3I6IGVycm9yID0+IHtcbiAgICAgICAgY29uc3QgZXJyb3JNZXNzYWdlID0gdGhpcy5zaGFyZWRTZXJ2aWNlLmdldEVycm9yTWVzc2FnZShlcnJvcikgfHwgZXJyb3JUcGw7XG4gICAgICAgIHRoaXMuc2hhcmVkU2VydmljZS5vcGVuTm90aWZpY2F0aW9uKGVycm9yTWVzc2FnZSwgJ2Vycm9yJyk7XG4gICAgICAgIHRoaXMubmV3TWVzc2FnZUZvcm1Hcm91cC5lbmFibGUoKTtcbiAgICAgIH0sXG4gICAgICBjb21wbGV0ZTogKCkgPT4gdGhpcy5yZXNldFRvSW5pdCgpLFxuICAgIH07XG4gIH1cblxuICBwcm90ZWN0ZWQgcmVzZXRUb0luaXQoaXNGb3JtRGlzY2FyZCA9IGZhbHNlKSB7XG4gICAgdGhpcy5uZXdNZXNzYWdlRm9ybUdyb3VwLmVuYWJsZSgpO1xuICAgIHRoaXMubmV3TWVzc2FnZUZvcm1Hcm91cC5yZXNldCgpO1xuICAgIHRoaXMuZHJhZnRGb3JtVmFsdWUgPSB1bmRlZmluZWQ7XG4gICAgdGhpcy51cGxvYWRTZXJ2aWNlLnJlc2V0KGlzRm9ybURpc2NhcmQpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRDb250cm9sKGZpZWxkOiBzdHJpbmcpOiBBYnN0cmFjdENvbnRyb2wgfCB1bmRlZmluZWQge1xuICAgIHJldHVybiB0aGlzLm5ld01lc3NhZ2VGb3JtR3JvdXAgJiYgdGhpcy5uZXdNZXNzYWdlRm9ybUdyb3VwLmNvbnRyb2xzW2ZpZWxkXTtcbiAgfVxuXG4gIHByaXZhdGUgcmVzdG9yZVRvcGljU2VsZWN0aW9uKHRvcGljczogVG9waWNzR2V0UmVzcG9uc2VCb2R5W10gfCBudWxsKSB7XG4gICAgdG9waWNzPy5tYXAodG9waWMgPT4ge1xuICAgICAgaWYgKHRvcGljLmlkID09PSB0aGlzLm5ld01lc3NhZ2VGb3JtR3JvdXAuY29udHJvbHNbJ3RvcGljJ10/LnZhbHVlPy5pZCkge1xuICAgICAgICB0aGlzLm5ld01lc3NhZ2VGb3JtR3JvdXAuY29udHJvbHNbJ3RvcGljJ10uc2V0VmFsdWUodG9waWMpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG59XG4iXX0=